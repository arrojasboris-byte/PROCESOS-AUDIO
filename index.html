<!DOCTYPE html>
<html lang="es"><head>
<style>
        /* ========== EXECUTIVE DESIGN SYSTEM ========== */
        /* Global font normalization */
        *{font-family:'Segoe UI',system-ui,-apple-system,sans-serif}
        
        /* Dashboard unified typography */
        #section-dashboard{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;color:#3a3a3a}
        #section-dashboard .panel{
            background:#fff;
            border:1px solid #e8ddb5;
            border-radius:8px;
            box-shadow:0 2px 8px rgba(201,162,39,0.12);
        }
        #section-dashboard .panel-title{
            font-size:10px;font-weight:700;text-transform:uppercase;
            letter-spacing:0.3px;color:#8B7355;margin-bottom:8px;
        }
        
        /* Unified label sizes */
        #section-dashboard .exec-label{font-size:10px;font-weight:600;color:#6B6152;letter-spacing:0.2px}
        #section-dashboard .exec-value{font-size:22px;font-weight:800;color:#C9A227}
        #section-dashboard .exec-sub{font-size:9px;color:#8B7355;font-weight:500}
        #section-dashboard .exec-badge{font-size:9px;padding:2px 8px;border-radius:4px;background:#f8f4e8;color:#8B7355;font-weight:600}
        
*{-webkit-text-decoration-skip:none}*::-webkit-spelling-error,*::-moz-spelling-error{text-decoration:none!important}textarea,input,[contenteditable]{-webkit-text-decoration:none!important;text-decoration:none!important}</style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Audio-Visitas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,sans-serif;background:#EAEAEA;height:100vh;display:flex;overflow:hidden}
        .sidebar{width:200px;background:linear-gradient(180deg,#1A1A1A,#0D0D0D);padding:12px 0;display:flex;flex-direction:column;height:100vh}
        .logo-section{padding:0 12px 16px;border-bottom:1px solid #2A2A2A;margin-bottom:12px;display:flex;align-items:center;gap:8px}
        .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,#C9A227,#D4B896);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px}
        .logo-text{font-size:13px;font-weight:700;color:#FFF}
        .logo-subtext{font-size:8px;color:#C9A227;font-weight:600}
        .nav-menu{flex:1;padding:0 8px}
        .nav-item{width:100%;padding:10px 12px;display:flex;align-items:center;gap:10px;border:none;border-radius:6px;cursor:pointer;margin-bottom:3px;background:transparent;color:#888;font-size:11px;font-weight:500;text-align:left}
        .nav-item:hover{background:#2A2A2A;color:#FFF}
        .nav-item.active{background:linear-gradient(135deg,#C9A227,#B8963D);color:#0D0D0D;font-weight:600}
        .nav-group{margin-bottom:3px}
        .nav-parent{position:relative}
        .nav-arrow{margin-left:auto;font-size:8px;transition:transform 0.2s}
        .nav-parent.open .nav-arrow{transform:rotate(180deg)}
        .nav-submenu{background:#1a1a1a;border-radius:6px;margin-top:2px;overflow:hidden}
        .nav-sub{padding:8px 12px!important;font-size:10px!important;margin-bottom:0!important;border-radius:0!important}
        .nav-sub:hover{background:#333!important}
        .user-section{padding:12px;border-top:1px solid #2A2A2A;display:flex;align-items:center;gap:8px}
        .user-avatar{width:30px;height:30px;background:linear-gradient(135deg,#C9A227,#B8963D);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#0D0D0D;font-weight:700;font-size:10px}
        .user-name{font-size:11px;font-weight:600;color:#FFF}
        .user-role{font-size:9px;color:#666}
        .main-content{flex:1;height:100vh;display:flex;flex-direction:column;overflow:hidden}
        .header{background:#FFF;padding:10px 20px;border-bottom:1px solid #E0E0E0;display:flex;justify-content:space-between;align-items:center}
        .header h1{font-size:16px;font-weight:700;color:#1A1A1A}
        .header-date{font-size:10px;color:#888}
        .header-buttons{display:flex;gap:6px}
        .btn{padding:7px 14px;border:none;border-radius:5px;cursor:pointer;font-size:10px;font-weight:600;display:flex;align-items:center;gap:4px}
        .btn-guardar{background:linear-gradient(135deg,#C9A227,#a88b1e);color:#fff}
        .btn-descargar{background:linear-gradient(135deg,#C9A227,#B08D1E);color:#fff}
        .btn-pdf{background:linear-gradient(135deg,#5c5c5c,#4a4a4a);color:#fff}
        .btn-imprimir{background:linear-gradient(135deg,#C9A227,#B08D1E);color:#fff}
        .page-content{flex:1;padding:12px;overflow:hidden;display:flex;flex-direction:column}
        .section{display:none;flex:1;flex-direction:column;overflow:hidden}
        .section.active{display:flex}
        .panel{background:#FFF;border-radius:10px;padding:14px;border:1px solid #E0E0E0}
        .panel-dark{background:#4A4A4A;color:#fff;border:none}
        .panel-title{font-size:10px;font-weight:700;letter-spacing:0.3px;margin-bottom:8px;color:#8B7355}
        .dash-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:10px}
        .stat-card{background:#FFF;border-radius:8px;padding:10px;border:1px solid #E0E0E0}
        .stat-label{font-size:9px;color:#888}
        .stat-value{font-size:20px;font-weight:700}
        .stat-change{font-size:8px;color:#22C55E}
        .dash-charts{display:grid;grid-template-columns:1fr 1fr;gap:12px;flex:1}
        .chart-box{background:#fff;border-radius:10px;padding:14px;border:1px solid #E0E0E0}
        .chart-title{font-size:10px;font-weight:700;margin-bottom:8px;color:#8B7355;letter-spacing:0.3px}
        .eval-section{display:none;flex:1;flex-direction:column;overflow:hidden}
        .eval-section.active{display:flex}
        .eval-header{background:linear-gradient(135deg,#4A4A4A,#3A3A3A);border-radius:10px;padding:12px 20px;margin-bottom:10px;display:flex;align-items:center;gap:14px;color:#fff}
        .eval-header-icon{width:40px;height:40px;background:#5a5a5a;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
        .eval-header h2{font-size:18px;font-weight:700}
        .eval-header p{color:#C9A227;font-size:11px}
        .eval-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:10px}
        .eval-stat{border-radius:8px;padding:10px;text-align:center;color:#fff}
        .eval-stat.s1{background:linear-gradient(135deg,#C9A227,#B08D1E)}
        .eval-stat.s2{background:linear-gradient(135deg,#C9A227,#a88b1e)}
        .eval-stat.s3{background:linear-gradient(135deg,#8b8b8b,#6b6b6b)}
        .eval-stat.s4{background:linear-gradient(135deg,#C9A227,#B8963D)}
        .eval-stat-value{font-size:20px;font-weight:700}
        .eval-stat-label{font-size:8px;text-transform:uppercase}
        .eval-content{display:grid;grid-template-columns:1fr 260px;gap:10px;flex:1;overflow:hidden}
        .eval-left{display:flex;flex-direction:column;gap:10px}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
        .form-label{display:block;font-size:9px;color:#888;margin-bottom:3px}
        .form-input,.form-select{width:100%;padding:8px;background:#F5F5F5;border:1px solid #E0E0E0;border-radius:6px;font-size:11px}
        .btn-comenzar{width:100%;padding:12px;background:linear-gradient(135deg,#C9A227,#B8963D);border:none;border-radius:6px;color:#fff;font-size:12px;font-weight:700;cursor:pointer}
        .bloques-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
        .bloque-card{border-radius:6px;padding:8px 4px;text-align:center;color:#fff;font-size:8px}
        .bloque-card .icon{font-size:16px}
        .bloque-card .name{font-weight:700}
        .bloque-card .peso{opacity:0.8;font-size:7px}
        .preinforme-item{background:#5a5a5a;border-radius:6px;padding:10px;margin-bottom:8px}
        .preinforme-top{display:flex;align-items:center;gap:8px;margin-bottom:6px}
        .preinforme-dot{width:8px;height:8px;border-radius:50%}
        .preinforme-centro{flex:1;font-weight:600;font-size:11px}
        .preinforme-score{font-size:14px;font-weight:700}
        .preinforme-meta{font-size:9px;color:#bbb;margin-bottom:8px}
        .preinforme-btns{display:flex;gap:4px}
        .preinforme-btn{flex:1;padding:6px;border:none;border-radius:4px;font-size:8px;font-weight:600;cursor:pointer;color:#fff}
        .preinforme-btn.ver{background:#6b7280}
        .preinforme-btn.borrar{background:#5c5c5c}
        .preinforme-btn.pdf{background:#C9A227}
        .eval-dinamica{display:none;flex-direction:column;flex:1;overflow:hidden}
        .eval-dinamica.active{display:flex}
        .progress-section{background:#fff;border-radius:8px;padding:10px 14px;margin-bottom:10px;border:1px solid #E0E0E0}
        .progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
        .bloque-badge{padding:4px 10px;border-radius:4px;font-size:9px;font-weight:700;color:#fff}
        .progress-bar{height:4px;background:#E0E0E0;border-radius:2px;overflow:hidden}
        .progress-fill{height:100%;border-radius:2px;transition:width 0.3s}
        .question-card{background:#fff;border-radius:12px;padding:16px 20px;border:1px solid #E0E0E0;flex:1;display:flex;flex-direction:column;justify-content:center;overflow-y:auto}
        .obligatoria-badge{display:none;background:#dc2626;color:#fff;padding:4px 12px;border-radius:10px;font-size:9px;font-weight:700;margin:0 auto 8px;text-align:center}
        .obligatoria-badge.show{display:inline-block}
        .question-number{width:42px;height:42px;background:#2d2d2d;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:16px;font-weight:700;color:#C9A227}
        .question-text{font-size:16px;font-weight:600;line-height:1.4;margin-bottom:8px;text-align:center}
        .question-valor{text-align:center;margin-bottom:10px}
        .question-valor span{background:#F5F5F5;padding:4px 14px;border-radius:10px;font-size:11px}
        .detalle-box{background:#F0F8FF;border:1px solid #BEE3F8;border-radius:8px;padding:12px 16px;margin-bottom:12px}
        .detalle-title{font-size:10px;font-weight:700;color:#3182CE;margin-bottom:6px}
        .detalle-text{font-size:12px;color:#2D3748;line-height:1.5}
        .agenda-box{background:#F5F5F5;border:2px solid #E0E0E0;border-radius:10px;padding:12px;margin-bottom:12px;display:none}
        .agenda-box.show{display:block}
        .agenda-title{font-size:10px;font-weight:700;margin-bottom:8px;text-align:center}
        .agenda-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .agenda-item{background:#fff;border-radius:6px;padding:8px;text-align:center;border:1px solid #E0E0E0}
        .agenda-label{font-size:8px;color:#888}
        .agenda-value{font-size:18px;font-weight:700}
        .agenda-value.verde{color:#C9A227}
        .agenda-value.rojo{color:#5c5c5c}
        .buttons-row{display:flex;gap:16px;justify-content:center;padding:16px 0}
        .btn-no{padding:12px 48px;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer;background:#fff;border:2px solid #5c5c5c;color:#5c5c5c}
        .btn-no:hover{background:#5c5c5c;color:#fff}
        .btn-si{padding:12px 48px;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer;background:#C9A227;border:none;color:#fff}
        .numerico-row{flex-direction:column;align-items:center;gap:10px}
        .input-num{padding:12px;font-size:20px;font-weight:600;text-align:center;width:130px;border:2px solid #E0E0E0;border-radius:8px}
        .btn-continuar{padding:12px 36px;background:#2d2d2d;border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:600;cursor:pointer}
        .nav-row{display:flex;justify-content:center;gap:12px;padding-bottom:10px}
        .btn-anterior{padding:8px 16px;background:#F5F5F5;border:1px solid #E0E0E0;border-radius:6px;color:#666;font-size:11px;cursor:pointer}
        .btn-cancelar{padding:8px 16px;background:transparent;border:1px solid #5c5c5c;border-radius:6px;color:#5c5c5c;font-size:11px;cursor:pointer}
        .informe-section{display:none;flex-direction:column;flex:1;overflow-y:auto}
        .informe-section.active{display:flex}
        .informe-header{background:linear-gradient(135deg,#4A4A4A,#3A3A3A);border-radius:10px;padding:14px;margin-bottom:10px;color:#fff}
        .informe-badge{background:#C9A227;color:#1A1A1A;padding:2px 8px;border-radius:3px;font-size:8px;font-weight:700;margin-bottom:4px;display:inline-block}
        .informe-titulo{font-size:18px;font-weight:700}
        .informe-meta{font-size:10px;color:#999}
        .resultado-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
        .resultado-card{background:#fff;border-radius:10px;padding:16px;text-align:center;border:1px solid #E0E0E0}
        .resultado-card.destacado{border:3px solid #C9A227}
        .resultado-label{font-size:9px;color:#888;margin-bottom:6px}
        .resultado-valor{font-size:38px;font-weight:700;margin-bottom:6px}
        .resultado-emoji{font-size:60px;margin-bottom:8px}
        .resultado-cat{display:inline-block;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:700}
        .resultado-msg{font-size:10px;margin-top:8px;font-style:italic}
        .tabla-box{background:#fff;border-radius:10px;padding:12px;margin-bottom:10px;border:1px solid #E0E0E0}
        .tabla-box table{width:100%;border-collapse:collapse;font-size:9px;color:#3a3a3a}
        .tabla-box th{background:#2d2d2d;color:#fff;padding:6px 8px;text-align:left}
        .tabla-box td{padding:5px 8px;border-bottom:1px solid #E0E0E0}
        .tabla-box tr:nth-child(even){background:#F8F8F8}
        .datos-extra{background:#fff;border-radius:10px;padding:12px;margin-bottom:10px;border:1px solid #E0E0E0}
        .datos-extra-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
        .dato-item{background:#F8F8F8;border-radius:6px;padding:8px;text-align:center}
        .dato-label{font-size:8px;color:#888}
        .dato-value{font-size:16px;font-weight:700;color:#1A1A1A}
        .checklist-box{background:#fff;border-radius:10px;padding:12px;border:1px solid #E0E0E0;margin-bottom:10px}
        .checklist-bloque{margin-bottom:10px}
        .checklist-header{padding:6px 10px;border-radius:4px;font-size:9px;font-weight:700;margin-bottom:4px;color:#fff;display:flex;justify-content:space-between}
        .checklist-item{display:flex;align-items:flex-start;gap:6px;padding:4px 6px;background:#F8F8F8;border-radius:3px;margin-bottom:2px;font-size:9px}
        .check-badge{width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:#fff;flex-shrink:0}
        .check-badge.si{background:#C9A227}
        .check-badge.no{background:#5c5c5c}
        .check-badge.num{background:#6b7280}
        .check-ob{background:#5c5c5c;color:#fff;padding:1px 4px;border-radius:2px;font-size:7px;font-weight:700;margin-left:auto}
        .btn-nueva{display:block;margin:12px auto;padding:10px 24px;background:#2d2d2d;border:none;border-radius:6px;color:#fff;font-size:11px;font-weight:600;cursor:pointer}
        .informe-btns{display:flex;gap:8px;margin-bottom:10px}
        .informe-btn{flex:1;padding:10px;border:none;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;color:#fff}
        .informe-btn.guardar{background:linear-gradient(135deg,#C9A227,#a88b1e)}
        .informe-btn.pdf{background:linear-gradient(135deg,#5c5c5c,#4a4a4a)}
        .informe-btn.imprimir{background:linear-gradient(135deg,#C9A227,#B08D1E)}
        .hidden{display:none!important}
        
        /* INFORME PROFESIONAL */
        .informe-pro{display:none;flex-direction:column;flex:1;overflow-y:auto}
        .informe-pro.active{display:flex}
        .inf-btns{display:flex;gap:8px;margin-bottom:10px}
        .inf-btn{padding:8px 14px;border:none;border-radius:5px;font-size:10px;font-weight:600;cursor:pointer;color:#fff}
        .inf-btn.volver{background:linear-gradient(135deg,#C9A227,#B08D1E)}
        .inf-btn.guardar{background:linear-gradient(135deg,#C9A227,#a88b1e)}
        .inf-btn.pdf{background:linear-gradient(135deg,#5c5c5c,#4a4a4a)}
        .inf-page{background:#fff;padding:12px 16px;margin-bottom:10px;border-radius:8px;border:1px solid #e0e0e0;width:100%;max-width:100%;box-sizing:border-box}
        .inf-header{display:flex;justify-content:space-between;align-items:center;padding-bottom:8px;border-bottom:3px solid #C9A227;margin-bottom:14px}
        .inf-logo{display:flex;align-items:center;gap:10px}
        .inf-logo-icon{width:36px;height:36px;background:linear-gradient(135deg,#C9A227,#e8c547);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:18px}
        .inf-logo-text{font-size:16px;font-weight:700;color:#4a4a4a}
        .inf-fecha{font-size:9px;color:#888}
        .inf-seccion{margin-bottom:24px;padding-bottom:18px;border-bottom:1px dashed #e0e0e0}
        .inf-seccion:last-child{border-bottom:none}
        .inf-seccion-titulo{display:flex;align-items:center;gap:8px;margin-bottom:10px}
        .inf-seccion-icono{width:22px;height:22px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff}
                .inf-seccion-nombre{font-size:10px;font-weight:700;color:#4a4a4a;text-transform:uppercase}
        .inf-datos-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
        .inf-dato-field{display:flex;flex-direction:column;gap:2px}
        .inf-dato-label{font-size:8px;color:#888;text-transform:uppercase;font-weight:600}
        .inf-dato-input{padding:6px 8px;border:1px solid #ddd;border-radius:4px;font-size:11px;background:#fafafa}
        .inf-dato-select{padding:5px 6px;border:1px solid #ddd;border-radius:4px;font-size:9px;background:#fafafa}
        .inf-resultado-row{display:grid;grid-template-columns:140px 1fr;gap:12px;align-items:stretch}
        .inf-resultado-card{background:linear-gradient(145deg,#f8f8f8,#efefef);border-radius:8px;padding:10px;text-align:center;border:2px solid #C9A227;display:flex;flex-direction:column;justify-content:center}
        .inf-resultado-emoji{font-size:28px;margin-bottom:2px}
        .inf-resultado-valor{font-size:32px;font-weight:800;color:#C9A227}
        .inf-resultado-cat{font-size:10px;font-weight:700;color:#4a4a4a;margin-top:2px}
        .inf-resultado-msg{font-size:8px;color:#888;margin-top:2px}
        .inf-barras-list{display:flex;flex-direction:column;gap:5px}
        .inf-barra{display:grid;grid-template-columns:95px 1fr 40px 45px;align-items:center;gap:8px}
        .inf-barra-name{font-size:9px;font-weight:600;color:#555;display:flex;align-items:center;gap:4px}
        .inf-barra-icon{width:16px;height:16px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;color:#fff}
        .inf-barra-track{height:18px;background:#e8e8e8;border-radius:4px;overflow:hidden}
        .inf-barra-fill{height:100%;border-radius:4px;transition:width 0.5s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:6px}
        .inf-barra-pct{font-size:9px;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
        .inf-barra-peso{font-size:8px;color:#888;text-align:right}
        .inf-barra-apl{font-size:10px;font-weight:700;text-align:right}
        .inf-graficas-row{display:flex;justify-content:space-between;gap:12px;width:100%;margin-top:12px}
        .inf-grafica-box{background:#fafafa;border-radius:8px;padding:12px;border:1px solid #e0e0e0;display:flex;flex-direction:column;align-items:center;flex:1;max-width:32%}
        .inf-grafica-title{font-size:11px;font-weight:700;color:#333;margin-bottom:8px;display:flex;align-items:center;gap:5px}
        .inf-grafica-dot{width:10px;height:10px;border-radius:50%}
        .inf-radar-container{width:100%;height:140px;display:flex;align-items:center;justify-content:center}
        .inf-radar-resumen{background:#f0f0f0;border-radius:6px;padding:8px 10px;margin-top:10px;font-size:12px;color:#333;text-align:center;width:100%;box-sizing:border-box;font-weight:600}
        .inf-resumen-box{background:#f5f5f5;border-radius:6px;padding:12px 14px;margin-top:12px;border:1px solid #e0e0e0}
        .inf-resumen-title{font-size:13px;font-weight:700;color:#4a4a4a;margin-bottom:6px}
        .inf-resumen-content{font-size:12px;color:#333;line-height:1.5}
        .inf-kpis-grid{display:grid;grid-template-columns:repeat(9,1fr);gap:4px}
        .inf-kpi-card{background:#fafafa;border-radius:4px;padding:4px 2px;text-align:center;border:1px solid #eee}
        .inf-kpi-icon{font-size:12px}
        .inf-kpi-name{font-size:8px;color:#8B7355;font-weight:600;margin-top:1px}
        .inf-kpi-value{font-size:11px;font-weight:800;margin-top:1px}
        .inf-kpi-ok{color:#C9A227}
        .inf-kpi-bad{color:#5c5c5c}
        .inf-kpis-semaforo{display:flex;justify-content:space-between;background:#f8f8f8;border-radius:8px;padding:8px 10px;border:1px solid #e0e0e0}
        .inf-kpi-sem{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1}
        .inf-kpi-sem .inf-kpi-led{width:20px;height:20px;border-radius:4px;background:#5c5c5c;box-shadow:0 0 6px rgba(239,68,68,0.5)}
        .inf-kpi-sem.ok .inf-kpi-led{background:#C9A227;box-shadow:0 0 6px rgba(34,197,94,0.5)}
        .inf-kpi-sem.ambar .inf-kpi-led{background:#b8960c;box-shadow:0 0 6px rgba(245,158,11,0.5)}
        .inf-kpi-sem .inf-kpi-txt{font-size:7px;font-weight:700;color:#555;text-align:center}
        .inf-conv-container{display:flex;gap:12px;align-items:stretch}
        .inf-conv-donuts{display:flex;gap:10px;flex:1}
        .inf-donut-card{flex:1;background:#f8f8f8;border-radius:8px;padding:10px;text-align:center;border:1px solid #e0e0e0;display:flex;flex-direction:column;align-items:center}
        .inf-donut-wrap{width:80px;height:80px;position:relative}
        .inf-donut-wrap canvas{width:100%!important;height:100%!important}
        .inf-donut-label{font-size:9px;font-weight:700;color:#666;margin-top:6px}
        .inf-conv-tarjetas{display:flex;gap:8px}
        .inf-conv-tarjeta{background:linear-gradient(145deg,#f0f0f0,#fff);border-radius:8px;padding:10px 12px;text-align:center;border:1px solid #e0e0e0;min-width:60px;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
        .inf-conv-tarjeta-icon{font-size:20px;margin-bottom:3px}
        .inf-conv-tarjeta-value{font-size:22px;font-weight:800;color:#333}
        .inf-conv-tarjeta-label{font-size:8px;font-weight:700;color:#666;margin-top:2px}
        .inf-galeria-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
        .inf-galeria-item{aspect-ratio:4/3;background:#f8f8f8;border-radius:8px;border:2px dashed #ccc;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;position:relative;min-height:100px}
        .inf-galeria-item:hover{border-color:#C9A227}
        .inf-galeria-item img{width:100%;height:100%;object-fit:cover;position:absolute}
        .inf-galeria-placeholder{text-align:center;color:#aaa}
        .inf-galeria-placeholder-icon{font-size:24px}
        .file-preview-box{width:100%;height:100%;background:#f5f5f5;border-radius:6px;display:flex;align-items:center;justify-content:center}
        .inf-galeria-placeholder-text{font-size:9px;margin-top:3px}
        .inf-textos-grid{display:flex;flex-direction:column;gap:10px;flex:1}
        .inf-texto-box{background:#fff;border-radius:8px;border:1px solid #e0e0e0;overflow:hidden;display:flex;flex-direction:column;min-height:120px}
        .inf-texto-header{padding:8px 10px;font-size:9px;font-weight:700;color:#fff;display:flex;justify-content:space-between;align-items:center}
        .inf-texto-header.obs{background:linear-gradient(135deg,#6b7280,#9ca3af)}
        .inf-texto-header.rec{background:linear-gradient(135deg,#C9A227,#d4b84a)}
        .inf-texto-header.comp{background:linear-gradient(135deg,#C9A227,#e8c547)}
        .inf-texto-area{width:100%;flex:1;min-height:80px;padding:12px;border:none;font-size:15px;resize:none;font-family:inherit;line-height:1.6;-webkit-text-decoration-skip:none;text-decoration:none;color:#1a1a1a}
        .inf-texto-area::-webkit-spelling-error,.inf-texto-area::-moz-spelling-error{text-decoration:none!important}
        .inf-texto-area *{text-decoration:none!important}
        .inf-tiempo-select{padding:3px 6px;border:none;border-radius:4px;font-size:8px;background:rgba(255,255,255,0.9);font-weight:600}
        .inf-mejoras-list{display:grid;grid-template-columns:1fr 1fr;gap:6px}
        .inf-mejora-item{background:#fef2f2;border:1px solid #fecaca;border-radius:6px;padding:6px 8px;display:flex;align-items:flex-start;gap:6px}
        .inf-mejora-badge{background:#5c5c5c;color:#fff;font-size:8px;font-weight:700;padding:2px 5px;border-radius:4px}
        .inf-mejora-text{font-size:8px;color:#991b1b;line-height:1.3}
        .inf-mensaje-final{text-align:center;padding:15px;background:#f5f5f5;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-top:auto}
        .inf-mensaje-icon{font-size:28px;margin-bottom:5px}
        .inf-mensaje-text{font-size:12px;font-weight:600;color:#4a4a4a}
        .inf-mensaje-sub{font-size:9px;color:#888;margin-top:3px}
        

        /* Electromedicina: golden shadow on check */
        .electro-check-label:has(input:checked) {
            background: #fff !important;
            border-color: #C9A227 !important;
            box-shadow: 0 0 8px rgba(201,162,39,0.4), inset 0 0 0 1px rgba(201,162,39,0.3) !important;
            color: #333 !important;
            font-weight: 600 !important;
        }
        .electro-check-label:hover {
            border-color: #C9A227 !important;
            box-shadow: 0 0 4px rgba(201,162,39,0.2) !important;
        }

        /* Informe: Paleta blanca con sombras doradas */
        .inf-page {
            background: #fff !important;
        }
        .inf-seccion {
            background: #fff;
        }
        #inf-pagina1 [style*="background:#fafafa"],
        #inf-pagina1 [style*="background: #fafafa"] {
            background: #fff !important;
            box-shadow: 0 1px 4px rgba(201,162,39,0.12) !important;
        }
        #inf-pagina2 .inf-seccion {
            box-shadow: 0 1px 4px rgba(201,162,39,0.10);
            border-radius: 8px;
        }

        /* Pentágono: líneas en rojo */
        #contenedor-pentagono {
            background: #fff !important;
            box-shadow: 0 1px 4px rgba(201,162,39,0.12) !important;
        }

        /* Barras: colores armonizados */
        .inf-barra-fill {
            transition: width 0.4s ease;
        }

        @media print{
            @page{size:A4;margin:0}
            
            *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}
            
            html,body{width:210mm!important;margin:0!important;padding:0!important;background:#fff!important}
            
            /* OCULTAR TODO MENOS INFORME */
            body>*:not(.main-content){display:none!important}
            .sidebar,.header,.nav-row,.inf-btns,#modal-preinformes{display:none!important}
            #section-calendario,#section-guia-eval,#section-informes,#section-visitas,#section-guia,#section-evaluacion,#section-exclusivos,#section-aar,#section-funnel,#section-informes-gestion{display:none!important}
            
            .main-content,.page-content,#section-informe,#informe-pro{
                display:block!important;width:210mm!important;margin:0!important;padding:0!important;overflow:visible!important
            }
            
            /* PÁGINAS A4 exactas: 210mm x 297mm */
            .inf-page{
                display:block!important;
                width:210mm!important;
                height:297mm!important;
                padding:5mm 7mm!important;
                margin:0!important;
                box-shadow:none!important;
                page-break-after:always!important;
                page-break-inside:avoid!important;
                overflow:hidden!important;
                background:#fff!important;
            }
            /* Página 3 puede extenderse a página 4 si hay muchas áreas de mejora */
            #inf-pagina3{
                height:auto!important;
                min-height:297mm!important;
                overflow:visible!important;
                page-break-after:auto!important;
                page-break-inside:auto!important;
            }
            
            /* ========== PÁGINA 1 - COMPRIMIDO 5% + GAPS AUMENTADOS ========== */
            
            /* Header: comprimido 5% */
            .inf-header{margin-bottom:4mm!important;padding-bottom:1.5mm!important;padding-top:2.5mm!important}
            .inf-logo-icon{font-size:17px!important}
            .inf-logo-text{font-size:13px!important}
            .inf-fecha{font-size:8px!important}
            
            /* Separación EVIDENTE entre secciones - GAPS AUMENTADOS */
            .inf-seccion{
                margin-bottom:8mm!important;
                padding-bottom:3mm!important;
                border-bottom:0.4mm solid #ccc!important;
            }
            .inf-seccion:last-child{border-bottom:none!important;margin-bottom:0!important}
            .inf-seccion-titulo{margin-bottom:2.5mm!important}
            .inf-seccion-icono{width:15px!important;height:15px!important;font-size:8px!important}
            .inf-seccion-nombre{font-size:9px!important;font-weight:700!important}
            
            /* 1. DATOS DE VISITA - comprimido 5% */
            .inf-datos-grid{gap:1.8mm!important;margin-bottom:1.8mm!important}
            .inf-dato-label{font-size:6.5px!important}
            .inf-dato-input,.inf-dato-select{padding:1.4mm!important;font-size:8.5px!important;font-weight:600!important;height:5.5mm!important}
            
            /* Sección de datos con más separación */
            #inf-pagina1 .inf-seccion:first-of-type{
                margin-bottom:10mm!important;
                padding-bottom:5mm!important;
            }
            
            /* 2. % APLICACIÓN POR BLOQUE - comprimido 5% */
            .inf-resultado-row{gap:2.8mm!important}
            .inf-resultado-card{padding:2.8mm!important;min-width:26mm!important}
            .inf-resultado-emoji{font-size:17px!important}
            .inf-resultado-valor{font-size:22px!important;font-weight:800!important}
            .inf-resultado-cat{font-size:7.5px!important}
            .inf-resultado-msg{font-size:6.5px!important}
            
            .inf-barras-list{gap:0.9mm!important}
            .inf-barra{gap:1.4mm!important}
            .inf-barra-track{height:3.8mm!important}
            .inf-barra-name{font-size:7.5px!important}
            .inf-barra-icon{width:10px!important;height:10px!important;font-size:6.5px!important}
            .inf-barra-pct{font-size:7.5px!important;font-weight:700!important}
            .inf-barra-peso{font-size:6.5px!important;font-weight:600!important}
            .inf-barra-apl{font-size:8.5px!important;font-weight:700!important}
            
            /* 3. CONVERSIONES - comprimido 5% */
            .inf-conv-container{gap:2.8mm!important}
            .inf-conv-donuts{gap:2.8mm!important}
            .inf-conv-donuts .inf-donut-card{padding:1.8mm!important}
            .inf-donut-wrap{width:15mm!important;height:15mm!important}
            .inf-donut-label{font-size:7.5px!important;font-weight:700!important}
            .inf-conv-tarjetas{gap:1.8mm!important}
            .inf-conv-tarjeta{padding:1.8mm!important;min-width:auto!important}
            .inf-conv-tarjeta-icon{font-size:11px!important}
            .inf-conv-tarjeta-value{font-size:13px!important;font-weight:800!important}
            .inf-conv-tarjeta-label{font-size:5.5px!important;font-weight:600!important}
            
            /* 4. KPIS RELEVANTES - comprimido 5% */
            .inf-kpis-semaforo{padding:2.8mm!important}
            .inf-kpi-sem{gap:1.4mm!important}
            .inf-kpi-sem .inf-kpi-led{width:4.7mm!important;height:4.7mm!important}
            .inf-kpi-sem .inf-kpi-txt{font-size:5.5px!important;font-weight:600!important}
            
            /* SECCIÓN 11 BÁSICOS - comprimido 5% */
            #seccion-basicos{margin-bottom:3mm!important;padding-bottom:2mm!important}
            #seccion-basicos .inf-seccion-nombre{font-size:8.5px!important}
            #seccion-basicos canvas{height:24mm!important}
            #seccion-basicos label{padding:1px 2px!important;font-size:4.7px!important}
            #seccion-basicos input[type="checkbox"]{width:7px!important;height:7px!important}
            
            /* 5. ANÁLISIS DETALLADO - comprimido 5% */
            .inf-graficas-row{display:flex!important;justify-content:space-between!important;gap:2.8mm!important;width:100%!important;margin-top:2.8mm!important}
            .inf-grafica-box{padding:1.8mm!important;width:57mm!important;max-width:57mm!important;flex:none!important;box-sizing:border-box!important}
            .inf-grafica-title{font-size:9px!important;font-weight:700!important;margin-bottom:1mm!important}
            .inf-radar-container{width:100%!important;height:28mm!important}
            .inf-radar-container canvas{transform:scale(0.85)!important;transform-origin:center center!important}
            .inf-radar-resumen{font-size:8px!important;padding:1.5mm!important;margin-top:1mm!important}
            .inf-resumen-box{background:#f0f0f0!important;border-radius:4px!important;padding:3.8mm!important;margin-top:8mm!important;border:0.3mm solid #ddd!important}
            .inf-resumen-title{font-size:9.5px!important;font-weight:700!important;margin-bottom:1.8mm!important}
            .inf-resumen-content{font-size:8.5px!important;line-height:1.4!important;color:#333!important}
            
            /* ========== PÁGINA 2 - A4 OPTIMIZADO ========== */
            /* A4 útil: ~190mm x 277mm (con márgenes de 10mm) */
            /* Distribución: KPIs + Galería 4 imgs + 3 cajas texto + títulos */
            
            /* ========== PÁGINA 2 ========== */
            #inf-pagina2{
                page-break-before:always!important;
                height:297mm!important;
                max-height:297mm!important;
                overflow:hidden!important;
                padding:4mm 5mm!important;
                display:flex!important;
                flex-direction:column!important;
            }
            
            /* Resumen container oculto no ocupa espacio */
            #resumen-general-container{display:none!important;height:0!important;margin:0!important;padding:0!important}
            
            /* --- SECCIÓN KPIs / RADARES (comprimida) --- */
            #inf-pagina2 .inf-seccion:first-child{
                flex:0 0 auto!important;
                margin-bottom:2mm!important;
            }
            #inf-pagina2 .inf-seccion:first-child .inf-seccion-titulo{
                padding:1mm!important;
                margin-bottom:1mm!important;
            }
            #inf-pagina2 .inf-graficas-row{
                display:flex!important;
                gap:2mm!important;
                height:40mm!important;
                max-height:40mm!important;
            }
            #inf-pagina2 .inf-grafica-box{
                flex:1!important;
                max-height:40mm!important;
                overflow:hidden!important;
            }
            .inf-grafica-title{
                font-size:7px!important;
                padding:1mm!important;
                margin-bottom:0!important;
            }
            .inf-grafica-dot{
                width:6px!important;height:6px!important;
            }
            .inf-radar-container{
                height:28mm!important;
                max-height:28mm!important;
                overflow:hidden!important;
            }
            .inf-radar-container canvas{
                max-height:28mm!important;
            }
            .inf-radar-resumen{
                font-size:6px!important;
                padding:1mm!important;
                margin-top:0!important;
            }
            
            /* --- GALERÍA - 4 fotos en fila --- */
            #inf-pagina2 .inf-seccion:nth-child(3){
                flex:0 0 auto!important;
                margin-bottom:2mm!important;
                overflow:hidden!important;
                max-width:100%!important;
            }
            #inf-pagina2 .inf-seccion:nth-child(3) .inf-seccion-titulo{
                padding:1mm!important;
                margin-bottom:1mm!important;
            }
            .inf-galeria-grid,
            #inf-pagina2 .inf-seccion:nth-child(3) > div[style*="grid"]{
                display:grid!important;
                grid-template-columns:repeat(4,1fr)!important;
                gap:1.5mm!important;
                height:42mm!important;
                max-height:42mm!important;
                width:100%!important;
                max-width:100%!important;
                box-sizing:border-box!important;
                overflow:hidden!important;
            }
            .inf-galeria-item{
                height:41mm!important;
                max-height:41mm!important;
                min-height:0!important;
                overflow:hidden!important;
                border-radius:2px!important;
                border-width:1px!important;
                box-sizing:border-box!important;
            }
            .inf-galeria-item img{
                width:100%!important;
                height:100%!important;
                max-width:100%!important;
                max-height:100%!important;
                object-fit:cover!important;
                position:absolute!important;
                top:0!important;left:0!important;
            }
            .inf-galeria-titulo{
                font-size:6px!important;
                padding:0.5mm!important;
            }
            .inf-galeria-placeholder-icon{font-size:10px!important}
            .inf-galeria-placeholder-text{font-size:5px!important}
            
            /* Ocultar slots 5-6 en impresión */
            #inf-pagina2 div[style*="display:none"]{display:none!important}
            
            /* Paquete oculto no ocupa espacio */
            #seccion-paquete-informe{display:none!important;height:0!important;overflow:hidden!important}
            
            /* --- TEXTOS: Obs + Compromisos + Plan de Acción --- */
            #inf-pagina2 .inf-seccion:last-child{
                flex:1!important;
                display:flex!important;
                flex-direction:column!important;
                overflow:hidden!important;
            }
            #inf-pagina2 .inf-seccion:last-child .inf-seccion-titulo{
                padding:1mm!important;
                margin-bottom:1mm!important;
                flex:0 0 auto!important;
            }
            /* Grid 1 columna: Obs → Compromisos → Plan apilados */
            .inf-textos-grid{
                display:flex!important;
                flex-direction:column!important;
                gap:1.5mm!important;
                flex:1!important;
            }
            /* Cada caja ocupa espacio proporcional */
            .inf-textos-grid .inf-texto-box:first-child{
                flex:2!important;
            }
            .inf-textos-grid .inf-texto-box:nth-child(2){
                flex:1!important;
            }
            .inf-textos-grid .inf-texto-box:nth-child(3){
                flex:1!important;
            }
            .inf-texto-box{
                min-height:auto!important;
                overflow:hidden!important;
                display:flex!important;
                flex-direction:column!important;
            }
            .inf-texto-header{
                padding:1.5mm 2mm!important;
                font-size:8px!important;
                font-weight:700!important;
                flex:0 0 auto!important;
            }
            .inf-texto-area{
                font-size:9px!important;
                padding:2mm!important;
                line-height:1.4!important;
                flex:1!important;
                overflow:hidden!important;
                resize:none!important;
            }
            /* Ocultar botones X en impresión */
            #inf-pagina2 button[id^="btn-borrar"]{display:none!important}
            
            /* ========== PÁGINA 3 - Áreas de Mejora ========== */
            #tabla-mejoras{width:100%!important;border-collapse:collapse!important}
            #tabla-mejoras th{padding:2.8mm 1.8mm!important;font-size:9.5px!important;background:#f0f0f0!important;border:0.5mm solid #ccc!important;font-weight:700!important}
            #tabla-mejoras td{padding:1.8mm!important;font-size:8.5px!important;border:0.5mm solid #ddd!important;line-height:1.4!important;vertical-align:top!important}
            #tabla-mejoras select{font-size:8.5px!important;padding:0.9mm!important}
            
            .inf-mensaje-final{margin-top:4mm!important;padding:3.8mm!important}
            .inf-mensaje-icon{font-size:21px!important}
            .inf-mensaje-text{font-size:11px!important;font-weight:700!important}
            .inf-mensaje-sub{font-size:8.5px!important}
        }
        
        /* ========== IMPRESIÓN DASHBOARD GLOBAL - A4 OPTIMIZADO (FIX ZOOM) ========== */
/* A4 = 210mm x 297mm */
@media print {

    /* =========================================================
       IMPORTANTE:
       - Estos estilos SOLO aplican cuando se imprime el Dashboard.
       - imprimirDashboard() añade body.print-dashboard antes de window.print()
       ========================================================= */

    body.print-dashboard{
        margin:0!important;
        padding:0!important;
        background:#fff!important;
    }

    /* Ocultar todo excepto el área principal */
    body.print-dashboard>*:not(.main-content){display:none!important}

    /* Ocultar navegación / cabecera / secciones no-dashboard */
    body.print-dashboard .sidebar,
    body.print-dashboard .header,
    body.print-dashboard .nav-row,
    body.print-dashboard #section-visitas,
    body.print-dashboard #section-guia,
    body.print-dashboard #section-evaluacion,
    body.print-dashboard #section-informe,
    body.print-dashboard #informe-pro,
    body.print-dashboard #section-exclusivos,
    body.print-dashboard #section-aar,
    body.print-dashboard #section-funnel,
    body.print-dashboard #section-calendario,
    body.print-dashboard #section-guia-eval,
    body.print-dashboard #section-informes-gestion,
    body.print-dashboard #modal-preinformes,
    body.print-dashboard .btn-print-dashboard{display:none!important}

    /* Contenedor A4 */
    body.print-dashboard .main-content,
    body.print-dashboard .page-content{
        display:block!important;
        width:210mm!important;
        margin:0!important;
        padding:0!important;
        overflow:visible!important;
    }

    /* =========================================================
       FIX ZOOM:
       - En Chrome, 'zoom' reduce el tamaño REAL del layout (evita "exceso de zoom" y recortes)
       - En navegadores sin soporte, usamos transform como fallback visual
       ========================================================= */
    body.print-dashboard #section-dashboard{
        display:block!important;
        width:210mm!important;
        margin:0!important;
        padding:6mm!important; /* margen interno para que no se vea "zoom" */
        background:#fff!important;
        overflow:visible!important;

        /* Chrome/Edge */
        zoom:0.88!important;

        /* Fallback (Firefox) */
        -webkit-transform:scale(0.88)!important;
        transform:scale(0.88)!important;
        transform-origin:top left!important;
    }
    @supports (zoom: 1) {
        body.print-dashboard #section-dashboard{
            -webkit-transform:none!important;
            transform:none!important;
        }
    }

    /* Mostrar header de impresión y ocultar barra de filtros/acciones */
    body.print-dashboard .dash-print-header{
        display:flex!important;
        justify-content:space-between!important;
        align-items:center!important;
        margin-bottom:2mm!important;
        padding-bottom:1.5mm!important;
        border-bottom:0.3mm solid #C9A227!important;
    }
    body.print-dashboard .dash-print-header .logo{
        display:flex!important;
        align-items:center!important;
        gap:2mm!important;
    }
    body.print-dashboard .dash-print-header .logo-icon{font-size:18px!important}
    body.print-dashboard .dash-print-header .logo-text{font-size:13px!important;font-weight:800!important;color:#C9A227!important}
    body.print-dashboard .dash-print-header .fecha{font-size:8px!important;color:#666!important}
    body.print-dashboard #dashboard-filtros-bar{display:none!important}

    /* Faldón del bloque (delegado) un poco más compacto */
    body.print-dashboard #faldon-general-centros{
        padding:2mm 4mm!important;
        margin-bottom:2mm!important;
        border-radius:2mm!important;
    }
    body.print-dashboard #faldon-general-centros span{
        font-size:11px!important;
    }

    /* ===== TARJETAS STATS - FILA SUPERIOR ===== */
    body.print-dashboard .dash-grid{
        display:grid!important;
        grid-template-columns:repeat(6,1fr)!important;
        gap:1.4mm!important;
        margin-bottom:2mm!important;
    }
    body.print-dashboard .stat-card{padding:2mm 1.5mm!important;border-radius:1.5mm!important}
    body.print-dashboard .stat-label{font-size:7px!important;font-weight:600!important}
    body.print-dashboard .stat-value{font-size:15px!important;font-weight:800!important}
    body.print-dashboard .stat-change{font-size:6px!important}

    /* ===== PANELES GENERALES ===== */
    body.print-dashboard .panel{
        padding:2mm!important;
        margin-bottom:2mm!important;
        border:0.2mm solid #ddd!important;
        border-radius:1.5mm!important;
        page-break-inside:avoid!important;
        background:#fff!important;
    }
    body.print-dashboard .panel-title{font-size:9px!important;font-weight:800!important;margin-bottom:1mm!important}

    /* ===== PRIMERA FILA: PENTÁGONO + BLOQUES ===== */
    body.print-dashboard [style*="grid-template-columns:1fr 1fr"]{
        display:grid!important;
        grid-template-columns:1fr 1fr!important;
        gap:2mm!important;
        margin-bottom:2mm!important;
    }

    /* Pentágono - el contenedor REAL es 200x200 en pantalla (ajuste de selector) */
    body.print-dashboard [style*="height:200px"][style*="width:200px"]{
        height:62mm!important;
        width:62mm!important;
        margin:0 auto!important;
    }
    body.print-dashboard #pentagono-dashboard{
        max-width:62mm!important;
        max-height:62mm!important;
    }
    body.print-dashboard #dash-pent-global{font-size:22px!important;font-weight:900!important}

    /* Barras de bloques - compactas */
    body.print-dashboard #dash-barras-bloques{width:100%!important}
    body.print-dashboard #dash-barras-bloques>div{
        margin-bottom:1.2mm!important;
        display:flex!important;
        align-items:center!important;
    }
    body.print-dashboard #dash-barras-bloques span{font-size:8px!important}
    body.print-dashboard #dash-barras-bloques [style*="width:14px"]{width:12px!important;height:12px!important;font-size:7px!important}
    body.print-dashboard #dash-barras-bloques [style*="width:70px"]{width:55px!important}
    body.print-dashboard #dash-barras-bloques [style*="height:10px"]{height:3mm!important;border-radius:0.5mm!important}
    body.print-dashboard #dash-barras-bloques [style*="width:32px"]{width:28px!important;font-size:8px!important;font-weight:800!important}

    /* ===== SEGUNDA FILA: 4 RADARES 2x2 ===== */
    body.print-dashboard [style*="grid-template-columns:repeat(2,1fr)"]{
        display:grid!important;
        grid-template-columns:1fr 1fr!important;
        gap:2mm!important;
        margin-bottom:2mm!important;
    }

    /* RADARES */
    body.print-dashboard [style*="height:180px"][style*="max-width:220px"]{
        height:52mm!important;
        width:52mm!important;
        margin:0 auto!important;
    }
    body.print-dashboard #radar-dash-pia,
    body.print-dashboard #radar-dash-rt,
    body.print-dashboard #radar-dash-form,
    body.print-dashboard #radar-dash-kpis{
        max-width:52mm!important;
        max-height:52mm!important;
    }

    /* Leyendas de radares - ocultar para ganar espacio */
    body.print-dashboard [id^="leyenda-"]{display:none!important}
    body.print-dashboard [id$="-total"]{font-size:7px!important}

    /* ===== RANKING ===== */
    body.print-dashboard table{
        width:100%!important;
        font-size:8px!important;
        border-collapse:collapse!important;
    }
    body.print-dashboard th{
        padding:1.5mm 1mm!important;
        font-size:8px!important;
        font-weight:800!important;
        background:#f5f5f5!important;
        border-bottom:0.3mm solid #C9A227!important;
    }
    body.print-dashboard td{
        padding:1.2mm 1mm!important;
        font-size:8.5px!important;
        border-bottom:0.2mm solid #eee!important;
    }
    body.print-dashboard [style*="max-height:150px"]{
        max-height:none!important;
        overflow:visible!important;
    }
    body.print-dashboard tbody tr:nth-child(even){background:#fafafa!important}
    body.print-dashboard td:first-child{font-size:10px!important;font-weight:800!important}
}

/* Guía de Visita */
        .guia-card{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
        .guia-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        .guia-card-icon{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
        .guia-card-content{flex:1}
        .guia-card-content h4{color:#fff;font-size:11px;font-weight:700;margin:0}
        .guia-card-content p{color:rgba(255,255,255,0.8);font-size:8px;margin:2px 0 0 0}
        .guia-card-arrow{color:#fff;font-size:16px;opacity:0.8}
        .guia-section{margin-bottom:12px}
        .guia-section-title{font-size:11px;font-weight:700;color:#C9A227;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid #e5e7eb}
        .guia-item{font-size:10px;color:#4a4a4a;padding:4px 0 4px 12px;border-left:2px solid #fde68a;margin-bottom:3px;line-height:1.4}
        
        /* ========== RESPONSIVE MÓVIL ========== */
        @media screen and (max-width: 768px) {
            .sidebar{display:none!important}
            .main-content{margin-left:0!important;width:100%!important}
            .header{padding:8px 12px!important}
            .nav-row{flex-wrap:wrap!important;gap:4px!important;padding:8px!important}
            .nav-item{padding:6px 10px!important;font-size:9px!important}
            
            /* Dashboard móvil - CRÍTICO para gráficos */
            #section-dashboard .panel{padding:8px!important;min-height:auto!important}
            #section-dashboard canvas{max-width:100%!important;width:100%!important;height:120px!important}
            
            /* Contenedor de radares dashboard - forzar tamaño */
            #section-dashboard [style*="height:130px"]{height:100px!important;min-height:100px!important;position:relative!important}
            
            /* Grid de tarjetas en 1 columna en móvil */
            [style*="grid-template-columns:repeat(2,1fr)"]{grid-template-columns:1fr!important}
            [style*="grid-template-columns:repeat(4,1fr)"]{grid-template-columns:repeat(2,1fr)!important}
            [style*="grid-template-columns:1fr 1fr 1fr"]{grid-template-columns:1fr!important}
            [style*="grid-template-columns:1fr 1.5fr"]{grid-template-columns:1fr!important}
            
            /* Radares más pequeños pero visibles */
            .panel canvas{max-height:100px!important;width:100%!important}
            
            /* Leyendas más pequeñas */
            [id^="leyenda-"]{font-size:6px!important;line-height:1.2!important}
            
            /* Stat cards */
            .stat-card{padding:8px!important}
            .stat-value{font-size:18px!important}
            .stat-label{font-size:8px!important}
            
            /* Guía tarjetas */
            .guia-card{padding:10px!important}
            .guia-card-icon{width:32px!important;height:32px!important;font-size:16px!important}
            .guia-card-content h4{font-size:10px!important}
            .guia-card-content p{font-size:7px!important}
            
            /* INFORME - CRÍTICO PARA MÓVIL */
            .inf-page{padding:8px!important;width:100%!important;box-sizing:border-box!important}
            .inf-graficas-row{flex-direction:column!important;gap:10px!important}
            .inf-grafica-box{width:100%!important;max-width:100%!important;margin-bottom:10px!important}
            .inf-radar-container{height:120px!important;width:100%!important;position:relative!important}
            .inf-radar-container canvas{width:100%!important;height:100%!important}
            
            /* Datos de visita en móvil */
            .inf-datos-grid{grid-template-columns:1fr!important;gap:8px!important}
            
            /* Barras de progreso */
            .inf-barra{flex-wrap:wrap!important}
            .inf-barras-list{gap:6px!important}
            
            /* Textos */
            .inf-textos-grid{flex-direction:column!important}
            
            /* Semáforo KPIs */
            .inf-kpis-semaforo{flex-wrap:wrap!important;gap:4px!important}
            .inf-kpi-sem{min-width:45%!important}
            
            /* Donuts conversiones */
            .inf-conv-donuts{flex-wrap:wrap!important;justify-content:center!important}
            .inf-donut-card{min-width:80px!important}
        }
        
        @media screen and (max-width: 480px) {
            .nav-item{padding:5px 8px!important;font-size:8px!important}
            [style*="grid-template-columns:repeat(4,1fr)"]{grid-template-columns:1fr!important}
            
            /* Radares aún más pequeños */
            #section-dashboard [style*="height:130px"]{height:80px!important}
            #section-dashboard canvas{height:80px!important}
            
            /* Radares informe en móvil pequeño */
            .inf-radar-container{height:100px!important}
            
            /* Títulos más pequeños */
            .panel-title{font-size:9px!important}
            [id$="-total"]{font-size:7px!important}
            
            /* Resultado más compacto */
            .inf-resultado-card{padding:8px!important}
            .inf-resultado-valor{font-size:28px!important}
        }
            .stat-card{min-width:auto!important}
            .guia-card{padding:8px!important;gap:6px!important}
        }
        /* === CALENDARIOS V2 — Lun-Vie, 4 franjas === */
        .cal-section{margin-bottom:10px}
        .cal-toggle-btn{width:100%;padding:10px 16px;border:2px solid #9ca3af;border-radius:8px;background:linear-gradient(135deg,#f9fafb,#f3f4f6);color:#4b5563;font-weight:700;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:all .3s}
        .cal-toggle-btn:hover{background:linear-gradient(135deg,#f3f4f6,#e5e7eb)}
        .cal-toggle-btn.sonia-btn{border-color:#8B7355;background:linear-gradient(135deg,#f5f0eb,#e8ddd0);color:#5a4a3a}
        .cal-toggle-btn.sonia-btn:hover{background:linear-gradient(135deg,#e8ddd0,#d4c4b0)}
        .cal-arrow{transition:transform .3s;font-size:13px}
        .cal-arrow.open{transform:rotate(180deg)}
        .cal-container{max-height:0;overflow:hidden;transition:max-height .5s ease}
        .cal-container.open{max-height:1200px;overflow-y:auto}
        .cal-nav{display:flex;align-items:center;justify-content:center;gap:12px;padding:8px;background:linear-gradient(135deg,#C9A227,#B08D1E);border-radius:8px 8px 0 0;margin-top:6px}
        .cal-nav.sonia-nav{background:linear-gradient(135deg,#8B7355,#6d5a43)}
        .cal-nav button{background:rgba(255,255,255,.2);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:14px;font-weight:700}
        .cal-nav button:hover{background:rgba(255,255,255,.4)}
        .cal-nav span{color:#fff;font-weight:700;font-size:13px;min-width:140px;text-align:center}
        .cal-grid{padding:4px;background:#f9fafb;border:1px solid #e5e7eb;border-top:none;border-radius:0 0 8px 8px}
        .cal-wk{width:100%;border-collapse:collapse;table-layout:fixed;margin-bottom:6px;border-radius:6px;overflow:hidden;border:1px solid #d1d5db}
        .cal-wk th{padding:5px 2px;font-size:9px;font-weight:700;text-align:center;border:1px solid #d1d5db}
        .cal-wk th.cal-dh{background:#f9fafb;color:#4b5563}
        .cal-wk th.cal-dh.sonia{background:#f0ebe4;color:#5a4a3a}
        .cal-wk th.cal-dh.today{background:#6b7280;color:#fff}
        .cal-wk th.cal-lbl{background:#f3f4f6;color:#6b7280;width:65px;font-size:8px}
        .cal-wk td{border:1px solid #d1d5db;height:26px;text-align:center;font-size:7.5px;font-weight:600;cursor:pointer;transition:filter .15s;padding:1px 2px;vertical-align:middle;max-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .cal-wk td:hover{filter:brightness(.92)}
        .cal-wk td.empty{background:#f3f4f6;cursor:default}
        .cal-wk td.st-disponible{background:#d1fae5;color:#065f46}
        .cal-wk td.st-ocupado{background:#fee2e2;color:#991b1b}
        .cal-wk td.st-oficina{background:#f3f4f6;color:#4b5563}
        .cal-wk td.st-vacaciones{background:#dbeafe;color:#1e40af}
        .cal-wk td.today{box-shadow:inset 0 0 0 2px #6b7280}
        .cal-legend{display:flex;gap:10px;padding:6px 10px;justify-content:center;flex-wrap:wrap;margin-top:4px}
        .cal-legend-item{display:flex;align-items:center;gap:4px;font-size:8px;font-weight:600;color:#4b5563}
        .cal-legend-dot{width:12px;height:12px;border-radius:3px;border:1px solid rgba(0,0,0,.1)}
        /* Popup editor */
        .cal-edit-popup{position:fixed;z-index:20000;width:270px;background:#fff;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.25);border:2px solid #9ca3af;overflow:hidden}
        .cal-edit-header{background:linear-gradient(135deg,#2d2d2d,#1a1a1a);color:#d1d5db;padding:8px 12px;font-size:10px;font-weight:700}
        .cal-edit-body{padding:10px}
        .cal-edit-states{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:8px}
        .cal-st-btn{padding:6px 4px;border:2px solid #e5e7eb;border-radius:6px;font-size:9px;font-weight:700;cursor:pointer;background:#fff;transition:all .15s}
        .cal-st-btn:hover{transform:scale(1.03)}
        .cal-st-btn.active{border-color:#6b7280;box-shadow:0 0 0 1px #6b7280}
        .cal-st-btn.st-disponible.active{background:#d1fae5;border-color:#059669}
        .cal-st-btn.st-ocupado.active{background:#fee2e2;border-color:#dc2626}
        .cal-st-btn.st-oficina.active{background:#f3f4f6;border-color:#6b7280}
        .cal-st-btn.st-vacaciones.active{background:#dbeafe;border-color:#2563eb}
        .cal-edit-input{width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:6px;font-size:10px;margin-bottom:8px;box-sizing:border-box}
        .cal-edit-input:focus{outline:none;border-color:#6b7280}
        .cal-edit-actions{display:flex;gap:6px}
        .cal-edit-save{flex:1;padding:7px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-weight:700;font-size:10px;cursor:pointer}
        .cal-edit-cancel{padding:7px 12px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-weight:700;font-size:10px;cursor:pointer}
        /* Mini availability in agendar modal */
        .cal-mini-avail{margin-top:10px;border:1px solid #e5e7eb;border-radius:6px;overflow:hidden}
        .cal-mini-avail table{width:100%;border-collapse:collapse;table-layout:fixed}
        .cal-mini-avail th,.cal-mini-avail td{border:1px solid #e5e7eb;padding:4px 2px;font-size:8px;text-align:center}
        .cal-mini-avail th{background:#f9fafb;font-weight:700;color:#6b7280}
        .cal-mini-avail td.mini-libre{background:#d1fae5;color:#065f46;font-weight:600}
        .cal-mini-avail td.mini-ocupado{background:#fee2e2;color:#991b1b;font-weight:600}
        .cal-mini-avail td.mini-otro{background:#f3f4f6;color:#4b5563;font-weight:600}
        .cal-turno-sel{display:grid;gap:6px}
        .cal-turno-btn{padding:6px 4px;border:2px solid #e5e7eb;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;background:#fff;text-align:center;transition:all .15s;user-select:none}
        .cal-turno-btn:hover{background:#f9fafb}
        .cal-turno-btn.active{border-color:#6b7280;background:#f3f4f6;color:#4b5563;box-shadow:0 0 0 1px #6b7280}
    </style>
</head>
<body spellcheck="false">
    <aside class="sidebar">
        <div class="logo-section">
            <div class="logo-icon">🎧</div>
            <div><div class="logo-text">GESTIÓN</div><div class="logo-subtext">Informes Audio</div></div>
        </div>
        <nav class="nav-menu">
            <button class="nav-item active" onclick="showSection('dashboard',this)"><span>📊</span> Dashboard</button>
            <button class="nav-item" onclick="showSection('funnel',this)"><span>📊</span> Funnel</button>
            <!-- ÁREA VISITAS con submenú -->
            <div class="nav-group">
                <button class="nav-item nav-parent" onclick="toggleNavGroup(this)"><span>📋</span> Visitas <span class="nav-arrow">▼</span></button>
                <div class="nav-submenu" style="display:none;padding-left:15px">
                    <button class="nav-item nav-sub" onclick="showSection('calendario',this)"><span>📅</span> Calendario</button>
                    <button class="nav-item nav-sub" onclick="showSection('guia-eval',this)"><span>🗺️</span> Evaluación + Guía</button>
                    <button class="nav-item nav-sub" onclick="showSection('informe',this)"><span>📄</span> Crear Informe</button>
                    <button class="nav-item nav-sub" onclick="showSection('informes-gestion',this)"><span>📋</span> Gestión Informes</button>
                </div>
            </div>
        </nav>
        <div class="user-section">
            <div class="user-avatar">AR</div>
            <div><div class="user-name">AR</div><div class="user-role">Administrador</div></div>
        </div>
    </aside>
    <main class="main-content">
        <header class="header">
            <div><h1 id="page-title">Dashboard</h1><div class="header-date" id="fecha-hoy">miércoles, 21 de enero de 2026</div></div>
            <div class="header-buttons">
                <button id="btn-guardar-global" onclick="guardarTodoGlobal()" style="background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;padding:6px 14px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;box-shadow:0 2px 6px rgba(16,185,129,0.3);transition:all 0.2s" title="Guardar TODO en Firebase">💾 GUARDAR</button>
                <button onclick="descargarBackupHTML()" style="background:linear-gradient(135deg,#6366f1,#4f46e5);color:#fff;border:none;padding:6px 10px;border-radius:6px;font-size:10px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;box-shadow:0 2px 6px rgba(99,102,241,0.3)" title="Descargar copia de seguridad HTML">📦 Backup</button>
                <span id="guardar-estado" style="font-size:9px;color:#10b981;font-weight:600;min-width:60px"></span>
                <button class="btn" onclick="location.reload()" style="background:#6b7280;color:#fff" title="Recargar para ver cambios">🔄 Actualizar</button>
                <span id="sync-status-indicator" style="font-size:10px;padding:3px 8px;border-radius:4px;background:#f3f4f6;color:#6b7280;cursor:pointer" onclick="forzarSincronizacion()" title="Clic para sincronizar datos entre PCs">🔄 Sync...</span>
                <button class="btn" onclick="limpiarDatosDemo()" style="background:#ef4444;color:#fff" title="Eliminar datos de centros demo 4ARY, 4DAV, 4SON">🧪 Limpiar Demo</button>
            </div>
        </header>
        <div class="page-content">
                                                <section id="section-dashboard" class="section active" style="overflow-y:auto">
                <!-- Header para impresión (oculto en pantalla) -->
                <div class="dash-print-header" style="display:none">
                    <div class="logo">
                        <span class="logo-icon">🎧</span>
                        <span class="logo-text">INFORME GLOBAL - SISTEMA DE EVALUACIÓN AUDIO</span>
                    </div>
                    <div class="fecha" id="dash-print-fecha"></div>
                </div>
                <!-- Botones superiores Dashboard -->
                <div id="dashboard-filtros-bar" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px">
                    <div style="display:flex;gap:6px;align-items:center">
                        <button onclick="showSection('exclusivos', document.querySelector('.nav-item[onclick*=exclusivos]'))" style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;padding:5px 12px;border-radius:4px;font-size:9px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:5px;box-shadow:0 2px 4px rgba(0,0,0,0.15)">⭐ Exclusivos y FLOP</button>
                        <button onclick="showSection('aar', document.querySelector('.nav-item[onclick*=aar]'))" style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;padding:5px 12px;border-radius:4px;font-size:9px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:5px;box-shadow:0 2px 4px rgba(0,0,0,0.15)">🎯 AAR</button>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                        <!-- FILTROS COMBINADOS -->
                        <div style="display:flex;align-items:center;gap:6px;background:#f3f4f6;padding:5px 10px;border-radius:5px;border:1px solid #e5e7eb">
                            <span style="font-size:9px;font-weight:600;color:#8B7355">👤 Delegado:</span>
                            <select id="filtro-delegado-dashboard" onchange="aplicarFiltrosDashboard()" style="padding:2px 6px;border:1px solid #d1d5db;border-radius:4px;font-size:9px;font-weight:600;min-width:120px;cursor:pointer">
                                <option value="">TODOS</option>
                                <option value="Blanca Fdez. de la Pradilla">Blanca Fdez. de la Pradilla</option>
                                <option value="Cecilia Pérez">Cecilia Pérez</option>
                                <option value="Daniel Chazo">Daniel Chazo</option>
                                <option value="Eneritz Aranguren">Eneritz Aranguren</option>
                                <option value="Laura Plazas">Laura Plazas</option>
                                <option value="Laura Ramos">Laura Ramos</option>
                                <option value="Manuel Cánovas">Manuel Cánovas</option>
                                <option value="Maribel Amezcua">Maribel Amezcua</option>
                                <option value="Marisa Carmona">Marisa Carmona</option>
                                <option value="Martín Sebastián">Martín Sebastián</option>
                                <option value="Sergio Perán">Sergio Perán</option>
                                <option value="Sonia Godino">Sonia Godino</option>
                                <option value="Verónica Alfonsín">Verónica Alfonsín</option>
                            </select>
                            <span style="color:#d1d5db">|</span>
                            <span style="font-size:9px;color:#8B7355;font-weight:500">PC:</span>
                            <select id="filtroDashPC" onchange="aplicarFiltrosDashboard()" style="font-size:9px;padding:2px 4px;border:1px solid #ddd;border-radius:3px;background:#fff">
                                <option value="">Todos</option>
                                <option value="PC">PC</option>
                                <option value="PNC">PNC</option>
                            </select>
                            <span style="font-size:9px;color:#8B7355;font-weight:500">Prop:</span>
                            <select id="filtroDashPropiedad" onchange="aplicarFiltrosDashboard()" style="font-size:9px;padding:2px 4px;border:1px solid #ddd;border-radius:3px;background:#fff">
                                <option value="">Todos</option>
                                <option value="FRANQUICIA">Franq.</option>
                                <option value="SUCURSAL">Sucur.</option>
                            </select>
                            <button onclick="limpiarFiltrosDashboard()" style="font-size:8px;padding:2px 6px;background:#6b7280;color:#fff;border:none;border-radius:3px;cursor:pointer" title="Limpiar filtros">✕</button>
                            <span id="filtrosDashCount" style="font-size:9px;font-weight:600;color:#C9A227">227</span>
                        </div>
                        <button onclick="generarReporteDelegado()" style="background:linear-gradient(135deg,#8B7355,#6D5A42);color:#fff;border:none;padding:4px 10px;border-radius:3px;font-size:8px;font-weight:600;cursor:pointer" title="Generar reporte del delegado seleccionado">📊 Reporte</button>
                        <button onclick="imprimirDashboard()" style="background:#C9A227;color:#fff;border:none;padding:4px 10px;border-radius:3px;font-size:8px;font-weight:600;cursor:pointer">🖨️ Imprimir</button>
                    </div>
                </div>
                
                <!-- ========== GRUPO 1: GENERAL-CENTROS ========== -->
                <div id="faldon-general-centros" style="background:linear-gradient(90deg,#C9A227,#e0c068);padding:5px 12px;border-radius:4px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
                    <span style="color:#fff;font-size:11px;font-weight:700;letter-spacing:0.5px">📊 General - Centros</span>
                    <span id="faldon-delegado-nombre" style="color:#fff;font-size:11px;font-weight:700"></span>
                </div>
                <div style="display:grid;grid-template-columns:1.3fr 1fr 0.8fr;gap:8px;margin-bottom:10px;align-items:stretch">
                    <!-- CENTROS EXCLUSIVOS - LISTA VISIBLE -->
                    <div class="panel" style="padding:12px;display:flex;flex-direction:column">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                            <div style="display:flex;align-items:center;gap:8px">
                                <span style="font-size:14px">⭐</span>
                                <span style="font-size:10px;font-weight:700;color:#8B7355;letter-spacing:0.3px">Centros Exclusivos</span>
                                <span id="exclusivos-count-badge" style="font-size:9px;padding:2px 6px;border-radius:4px;background:#C9A227;color:#fff;font-weight:600">✓ 9</span>
                            </div>
                        </div>
                        <div style="font-size:10px;color:#8B7355;margin-bottom:4px;display:flex;justify-content:space-between;padding:0 4px">
                            <span>Código + Nombre</span>
                            <span style="display:flex;gap:20px"><span style="width:50px;text-align:center">Procesos</span><span style="width:40px;text-align:center">Prev</span></span>
                        </div>
                        <div style="flex:1;overflow-y:auto;max-height:140px" id="listaCentrosExclusivos">
                            <!-- Se llena dinámicamente -->
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-top:6px;padding-top:6px;border-top:1px solid #e5e7eb;font-size:9px;color:#8B7355">
                            <div style="display:flex;align-items:center;gap:4px"><span style="width:8px;height:8px;background:#C9A227;border-radius:50%"></span> Sobre previsto</div>
                            <div style="display:flex;align-items:center;gap:4px"><span style="width:8px;height:8px;background:#8B7355;border-radius:50%"></span> Bajo previsto</div>
                        </div>
                    </div>
                    
                    <!-- AAR - MULTI-RING DONUT (3 anillos: Formación / Gamas / Conversión) -->
                    <div class="panel" style="padding:12px">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                            <div style="display:flex;align-items:center;gap:6px"><span style="font-size:14px">🎯</span><span style="font-size:10px;font-weight:700;color:#8B7355;letter-spacing:0.3px">AAR</span></div>
                            <span style="font-size:9px;color:#8B7355;font-weight:500" id="aarTotalCentros">— centros AAO</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:12px">
                            <!-- Canvas 3 anillos -->
                            <div style="position:relative;width:150px;height:150px;flex-shrink:0">
                                <canvas id="canvasAARMultiRing" width="150" height="150"></canvas>
                                <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center">
                                    <div style="font-size:20px;font-weight:800;color:#C9A227" id="aarRingVentas">16</div>
                                    <div style="font-size:6px;color:#888;font-weight:600;text-transform:uppercase">ventas</div>
                                    <div style="font-size:9px;color:#065F46;font-weight:700;margin-top:1px" id="aarRingFacturacion">57.969 €</div>
                                </div>
                            </div>
                            <!-- Leyenda lateral -->
                            <div style="font-size:8px;line-height:1.5;flex:1;min-width:0">
                                <!-- FORMACIÓN -->
                                <div style="font-weight:700;color:#555;font-size:7px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px;border-bottom:1px solid #eee;padding-bottom:2px">⬤ Ext · Formación AAO</div>
                                <div style="display:flex;align-items:center;gap:3px"><span style="display:inline-block;width:7px;height:7px;background:#10b981;border-radius:2px;flex-shrink:0"></span><span style="color:#555">Cert</span> <strong style="color:#10b981;margin-left:auto" id="dash-aar-cert">—</strong></div>
                                <div style="display:flex;align-items:center;gap:3px"><span style="display:inline-block;width:7px;height:7px;background:#f59e0b;border-radius:2px;flex-shrink:0"></span><span style="color:#555">Form</span> <strong style="color:#f59e0b;margin-left:auto" id="dash-aar-form">—</strong></div>
                                <div style="display:flex;align-items:center;gap:3px"><span style="display:inline-block;width:7px;height:7px;background:#ef4444;border-radius:2px;flex-shrink:0"></span><span style="color:#555">Pend</span> <strong style="color:#ef4444;margin-left:auto" id="dash-aar-pend">—</strong></div>
                                <!-- GAMAS -->
                                <div style="font-weight:700;color:#555;font-size:7px;text-transform:uppercase;letter-spacing:0.5px;margin:4px 0 2px;border-bottom:1px solid #eee;padding-bottom:2px">⬤ Med · Gamas</div>
                                <div id="aarRingGamasLeyenda" style="display:flex;flex-direction:column;gap:1px">
                                    <div style="display:flex;align-items:center;gap:3px"><span style="display:inline-block;width:7px;height:7px;background:#7c3aed;border-radius:2px;flex-shrink:0"></span><span style="color:#555">D+</span> <strong style="color:#7c3aed;margin-left:auto">0</strong></div>
                                    <div style="display:flex;align-items:center;gap:3px"><span style="display:inline-block;width:7px;height:7px;background:#C9A227;border-radius:2px;flex-shrink:0"></span><span style="color:#555">Plat</span> <strong style="color:#C9A227;margin-left:auto">0</strong></div>
                                    <div style="display:flex;align-items:center;gap:3px"><span style="display:inline-block;width:7px;height:7px;background:#92702a;border-radius:2px;flex-shrink:0"></span><span style="color:#555">Oro</span> <strong style="color:#92702a;margin-left:auto">0</strong></div>
                                </div>
                                <!-- CONVERSIÓN -->
                                <div style="font-weight:700;color:#555;font-size:7px;text-transform:uppercase;letter-spacing:0.5px;margin:4px 0 2px;border-bottom:1px solid #eee;padding-bottom:2px">⬤ Int · Conversión</div>
                                <div style="display:flex;align-items:center;gap:3px"><span style="display:inline-block;width:7px;height:7px;background:#10b981;border-radius:50%;flex-shrink:0"></span><span style="color:#555">Conv.</span> <strong style="color:#10b981;margin-left:auto" id="dash-aar-conv">—%</strong></div>
                            </div>
                        </div>
                        <!-- Barra progreso formación -->
                        <div id="aarSemaforo" style="display:flex;gap:1px;height:6px;margin-top:8px">
                            <div id="aarBarCert" style="flex:1;background:#10b981;border-radius:2px 0 0 2px"></div>
                            <div id="aarBarForm" style="flex:1;background:#f59e0b"></div>
                            <div id="aarBarPend" style="flex:1;background:#ef4444;border-radius:0 2px 2px 0"></div>
                        </div>
                        <div style="text-align:center;margin-top:2px;font-size:7px;color:#888"><span id="aarPctCenter" style="font-weight:700;color:#10b981">—</span> certificados</div>
                    </div>
                    
                    <!-- CENTROS - 2 anillos Canvas estilo AAR -->
                    <div class="panel" style="padding:12px">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                            <div style="display:flex;align-items:center;gap:6px"><span style="font-size:14px">🏪</span><span style="font-size:10px;font-weight:700;color:#8B7355;letter-spacing:0.3px">Centros</span></div>
                            <span style="font-size:9px;color:#8B7355;font-weight:500" id="centrosTotalNum">227 total</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:12px">
                            <!-- Canvas 2 anillos -->
                            <div style="position:relative;width:150px;height:150px;flex-shrink:0">
                                <canvas id="canvasCentrosRing" width="150" height="150"></canvas>
                                <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center">
                                    <div style="font-size:22px;font-weight:800;color:#C9A227" id="centrosPctCenter">0%</div>
                                    <div style="font-size:7px;color:#8B7355;font-weight:600;text-transform:uppercase">Cobertura</div>
                                </div>
                            </div>
                            <!-- Leyenda lateral -->
                            <div style="font-size:8px;line-height:1.5;flex:1;min-width:0">
                                <!-- PROCESO -->
                                <div style="font-weight:700;color:#555;font-size:7px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px;border-bottom:1px solid #eee;padding-bottom:2px">⬤ Ext · Proceso</div>
                                <div style="display:flex;align-items:center;gap:3px"><span style="display:inline-block;width:7px;height:7px;background:#C9A227;border-radius:2px;flex-shrink:0"></span><span style="color:#555">Activos</span> <strong style="color:#C9A227;margin-left:auto" id="dash-centros-visit">0</strong></div>
                                <div style="display:flex;align-items:center;gap:3px"><span style="display:inline-block;width:7px;height:7px;background:#e8e8e8;border-radius:2px;flex-shrink:0"></span><span style="color:#555">Resto</span> <strong style="color:#999;margin-left:auto" id="dash-centros-resto-proc">0</strong></div>
                                <div style="display:flex;align-items:center;gap:3px;margin-top:1px"><span style="color:#888;font-size:7px">%</span> <strong style="color:#C9A227;margin-left:auto" id="dash-centros-pct-proc">0%</strong></div>
                                <!-- PUNTUAL -->
                                <div style="font-weight:700;color:#555;font-size:7px;text-transform:uppercase;letter-spacing:0.5px;margin:4px 0 2px;border-bottom:1px solid #eee;padding-bottom:2px">⬤ Int · Puntual</div>
                                <div style="display:flex;align-items:center;gap:3px"><span style="display:inline-block;width:7px;height:7px;background:#D4AF37;border-radius:2px;flex-shrink:0"></span><span style="color:#555">Activos</span> <strong style="color:#D4AF37;margin-left:auto" id="dash-centros-activos">0</strong></div>
                                <div style="display:flex;align-items:center;gap:3px"><span style="display:inline-block;width:7px;height:7px;background:#e8e8e8;border-radius:2px;flex-shrink:0"></span><span style="color:#555">Resto</span> <strong style="color:#999;margin-left:auto" id="dash-centros-resto-punt">0</strong></div>
                                <div style="display:flex;align-items:center;gap:3px;margin-top:1px"><span style="color:#888;font-size:7px">%</span> <strong style="color:#D4AF37;margin-left:auto" id="dash-centros-pct-punt">0%</strong></div>
                                <!-- PENDIENTES -->
                                <div style="font-weight:700;color:#555;font-size:7px;text-transform:uppercase;letter-spacing:0.5px;margin:4px 0 2px;border-bottom:1px solid #eee;padding-bottom:2px">Pendientes</div>
                                <div style="display:flex;align-items:center;gap:3px"><span style="display:inline-block;width:7px;height:7px;background:#8B7355;border-radius:2px;flex-shrink:0"></span><span style="color:#555">Sin visitar</span> <strong style="color:#8B7355;margin-left:auto" id="dash-centros-pend">0</strong></div>
                            </div>
                        </div>
                        <!-- Barra semáforo -->
                        <div id="centrosSemaforo" style="display:flex;gap:1px;height:6px;margin-top:8px">
                            <div id="centrosSemaforoVisit" style="flex:1;background:#C9A227;border-radius:2px 0 0 2px"></div>
                            <div id="centrosSemaforoActiv" style="flex:0;background:#D4AF37"></div>
                            <div id="centrosSemaforoPend" style="flex:1;background:#8B7355;border-radius:0 2px 2px 0"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ========== GRUPO 2: FUNNEL ========== -->
                <div style="background:linear-gradient(90deg,#8B7355,#6D5A42);padding:5px 12px;border-radius:4px;margin-bottom:8px">
                    <span style="color:#fff;font-size:11px;font-weight:700;letter-spacing:0.5px">📈 Funnel</span>
                </div>
                <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:10px">
                    <!-- GAMAS -->
                    <div class="panel" style="padding:10px">
                        <div style="display:flex;align-items:center;gap:4px;margin-bottom:6px">
                            <span style="font-size:14px">💎</span>
                            <span style="font-size:10px;font-weight:700;color:#8B7355;letter-spacing:0.3px">Gamas</span>
                        </div>
                        <div style="display:flex;gap:6px;align-items:center">
                            <div style="position:relative;width:50px;height:50px;flex-shrink:0">
                                <svg viewBox="0 0 36 36" style="width:100%;height:100%;transform:rotate(-90deg)">
                                    <circle cx="18" cy="18" r="15.9" fill="none" stroke="#e5e7eb" stroke-width="3"/>
                                    <circle id="gama-circle-diamante" cx="18" cy="18" r="15.9" fill="none" stroke="#D4AF37" stroke-width="3" stroke-dasharray="0 100"/>
                                    <circle id="gama-circle-platino-plus" cx="18" cy="18" r="15.9" fill="none" stroke="#B8963D" stroke-width="3" stroke-dasharray="0 100" stroke-dashoffset="0"/>
                                    <circle id="gama-circle-platino" cx="18" cy="18" r="15.9" fill="none" stroke="#A68B1E" stroke-width="3" stroke-dasharray="0 100" stroke-dashoffset="0"/>
                                    <circle id="gama-circle-oro" cx="18" cy="18" r="15.9" fill="none" stroke="#E8C547" stroke-width="3" stroke-dasharray="0 100" stroke-dashoffset="0"/>
                                </svg>
                                <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center">
                                    <div id="gama-total" style="font-size:14px;font-weight:800;color:#C9A227">0</div>
                                </div>
                            </div>
                            <div style="flex:1;font-size:9px;color:#8B7355">
                                <div style="display:flex;justify-content:space-between;margin-bottom:1px" title="Diamante Plus"><span style="color:#B08D1E">💎+</span><strong id="dash-gama-diamante-plus">0</strong></div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:1px" title="Diamante IC"><span style="color:#D4AF37">💎</span><strong id="dash-gama-diamante">0</strong></div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:1px" title="Platino Plus"><span style="color:#9A7D2E">🥈+</span><strong id="dash-gama-platino-plus">0</strong></div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:1px" title="Platino IC"><span style="color:#A68B1E">🥈</span><strong id="dash-gama-platino">0</strong></div>
                                <div style="display:flex;justify-content:space-between" title="Oro Incógnito"><span style="color:#E8C547">🥇</span><strong id="dash-gama-oro">0</strong></div>
                            </div>
                        </div>
                        <div id="gamasSemaforo" style="display:flex;gap:1px;height:4px;margin-top:4px">
                            <div id="gama-sem-diamante-plus" style="flex:20;background:#C9A227;border-radius:2px 0 0 2px" title="Diamante Plus"></div>
                            <div id="gama-sem-diamante" style="flex:20;background:#D4AF37" title="Diamante IC"></div>
                            <div id="gama-sem-platino-plus" style="flex:20;background:#B8963D" title="Platino Plus"></div>
                            <div id="gama-sem-platino" style="flex:20;background:#A68B1E" title="Platino IC"></div>
                            <div id="gama-sem-oro" style="flex:20;background:#E8C547;border-radius:0 2px 2px 0" title="Oro Incógnito"></div>
                        </div>
                    </div>
                    
                    <!-- CONVERSIONES -->
                    <div class="panel" style="padding:12px">
                        <div style="font-size:10px;font-weight:700;color:#8B7355;letter-spacing:0.3px;margin-bottom:6px">📊 Conversiones</div>
                        <div style="display:flex;justify-content:space-around;align-items:center">
                            <div style="text-align:center">
                                <div style="font-size:9px;color:#8B7355;font-weight:600">C.Prueba</div>
                                <div style="width:40px;height:40px;border-radius:50%;border:3px solid #e8ddb5;display:flex;align-items:center;justify-content:center;margin:3px auto">
                                    <span style="font-size:13px;font-weight:800;color:#C9A227" id="dash-conv-prueba">0%</span>
                                </div>
                            </div>
                            <span style="color:#D4AF37;font-size:14px">→</span>
                            <div style="text-align:center">
                                <div style="font-size:9px;color:#8B7355;font-weight:600">C.Venta</div>
                                <div style="width:40px;height:40px;border-radius:50%;border:3px solid #e8ddb5;display:flex;align-items:center;justify-content:center;margin:3px auto">
                                    <span style="font-size:13px;font-weight:800;color:#C9A227" id="dash-conv-venta">0%</span>
                                </div>
                            </div>
                        </div>
                        <div style="font-size:8px;color:#8B7355;text-align:center;margin-top:4px;font-weight:500">Obj ≥80%</div>
                    </div>
                    
                    <!-- RENOVE 3 AÑOS -->
                    <div class="panel" style="padding:12px">
                        <div style="display:flex;align-items:center;gap:4px;margin-bottom:4px"><span style="font-size:14px">🔄</span><span style="font-size:10px;font-weight:700;color:#8B7355;letter-spacing:0.3px">Renove 3A</span></div>
                        <div style="display:flex;justify-content:space-between;align-items:flex-end">
                            <div><div style="font-size:20px;font-weight:800;color:#C9A227" id="dash-renove3">0</div><div style="font-size:9px;color:#8B7355;font-weight:500">3 años</div></div>
                            <svg width="36" height="26"><rect x="1" y="14" width="6" height="12" fill="#e8ddb5" rx="1"/><rect x="9" y="8" width="6" height="18" fill="#e8ddb5" rx="1"/><rect x="17" y="3" width="6" height="23" fill="#e8ddb5" rx="1"/><rect x="25" y="6" width="6" height="20" fill="#C9A227" rx="1"/></svg>
                        </div>
                    </div>
                    
                    <!-- RENOVE +42M -->
                    <div class="panel" style="padding:12px">
                        <div style="display:flex;align-items:center;gap:4px;margin-bottom:4px"><span style="font-size:14px">🔄</span><span style="font-size:10px;font-weight:700;color:#8B7355;letter-spacing:0.3px">Renove +42M</span></div>
                        <div style="display:flex;justify-content:space-between;align-items:flex-end">
                            <div><div style="font-size:20px;font-weight:800;color:#C9A227" id="dash-renove42">0</div><div style="font-size:9px;color:#8B7355;font-weight:500">+42 meses</div></div>
                            <svg width="36" height="26"><rect x="1" y="16" width="6" height="10" fill="#e8ddb5" rx="1"/><rect x="9" y="10" width="6" height="16" fill="#e8ddb5" rx="1"/><rect x="17" y="5" width="6" height="21" fill="#e8ddb5" rx="1"/><rect x="25" y="8" width="6" height="18" fill="#C9A227" rx="1"/></svg>
                        </div>
                    </div>
                    
                    <!-- MGM -->
                    <div class="panel" style="padding:12px">
                        <div style="display:flex;align-items:center;gap:4px;margin-bottom:4px"><span style="font-size:14px">👥</span><span style="font-size:10px;font-weight:700;color:#8B7355;letter-spacing:0.3px">MGM</span></div>
                        <div style="display:flex;justify-content:space-between;align-items:flex-end">
                            <div><div style="font-size:20px;font-weight:800;color:#C9A227" id="dash-mgm">0</div><div style="font-size:9px;color:#8B7355;font-weight:500">Referidos</div></div>
                            <svg width="36" height="26"><rect x="1" y="16" width="6" height="10" fill="#e8ddb5" rx="1"/><rect x="9" y="12" width="6" height="14" fill="#e8ddb5" rx="1"/><rect x="17" y="5" width="6" height="21" fill="#e8ddb5" rx="1"/><rect x="25" y="9" width="6" height="17" fill="#C9A227" rx="1"/></svg>
                        </div>
                    </div>
                    
                    <!-- RENOVE INFINITY -->
                    <div class="panel" style="padding:12px">
                        <div style="display:flex;align-items:center;gap:4px;margin-bottom:4px"><span style="font-size:14px">♻️</span><span style="font-size:10px;font-weight:700;color:#8B7355;letter-spacing:0.3px">Renove Infinity</span></div>
                        <div style="display:flex;justify-content:space-between;align-items:flex-end">
                            <div><div style="font-size:20px;font-weight:800;color:#C9A227" id="dash-infinity">0</div><div style="font-size:9px;color:#8B7355;font-weight:500">Contratos</div></div>
                            <svg width="36" height="26"><rect x="1" y="14" width="6" height="12" fill="#e8ddb5" rx="1"/><rect x="9" y="8" width="6" height="18" fill="#e8ddb5" rx="1"/><rect x="17" y="2" width="6" height="24" fill="#e8ddb5" rx="1"/><rect x="25" y="5" width="6" height="21" fill="#C9A227" rx="1"/></svg>
                        </div>
                    </div>
                    
                    <!-- TAPONES DE CERA -->
                    <div class="panel" style="padding:12px">
                        <div style="display:flex;align-items:center;gap:4px;margin-bottom:4px"><span style="font-size:14px">👂</span><span style="font-size:10px;font-weight:700;color:#8B7355;letter-spacing:0.3px">Tapones Cera</span></div>
                        <div style="display:flex;justify-content:space-between;align-items:flex-end">
                            <div><div style="font-size:20px;font-weight:800;color:#C9A227" id="dash-tapones">0</div><div style="font-size:9px;color:#8B7355;font-weight:500">Seguimiento</div></div>
                            <svg width="36" height="26"><rect x="1" y="18" width="6" height="8" fill="#e8ddb5" rx="1"/><rect x="9" y="14" width="6" height="12" fill="#e8ddb5" rx="1"/><rect x="17" y="10" width="6" height="16" fill="#e8ddb5" rx="1"/><rect x="25" y="16" width="6" height="10" fill="#C9A227" rx="1"/></svg>
                        </div>
                    </div>
                </div>
                
                <!-- ========== PROCEDENCIA + TIPO ATENCIÓN + MOTIVO NO COMPRA ========== -->
                <div style="background:linear-gradient(90deg,#C9A227,#B8963D);padding:5px 12px;border-radius:4px;margin-bottom:8px">
                    <span style="color:#fff;font-size:11px;font-weight:700;letter-spacing:0.5px">📊 Procedencia · Tipo Atención · Motivos</span>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">
                    <!-- PROCEDENCIA - Campos del funnel -->
                    <div class="panel" style="padding:12px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                            <span style="font-size:10px;font-weight:700;color:#8B7355;letter-spacing:0.3px">📍 Procedencia</span>
                            <span id="dash-proc-total" style="font-size:9px;color:#8B7355;background:#f8f4e8;padding:2px 6px;border-radius:4px;font-weight:500">0 reg.</span>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:10px">
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #C9A227"><span>Derivado Óptica</span><strong id="proc-1">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #C9A227"><span>TV</span><strong id="proc-2">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #C9A227"><span>Boca-Boca</span><strong id="proc-3">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #C9A227"><span>Azafata</span><strong id="proc-4">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #C9A227"><span>Buzoneo</span><strong id="proc-5">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #C9A227"><span>Telemarketing</span><strong id="proc-6">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #C9A227"><span>Escaparate</span><strong id="proc-7">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #C9A227"><span>Cashback</span><strong id="proc-8">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #C9A227"><span>MGM</span><strong id="proc-9">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #C9A227"><span>Otros</span><strong id="proc-10">0</strong></div>
                        </div>
                    </div>
                    
                    <!-- TIPO ATENCIÓN - Campos del funnel -->
                    <div class="panel" style="padding:12px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                            <span style="font-size:10px;font-weight:700;color:#8B7355;letter-spacing:0.3px">🏥 Tipo Atención</span>
                            <span id="dash-tipoaten-total" style="font-size:9px;color:#8B7355;background:#f8f4e8;padding:2px 6px;border-radius:4px;font-weight:500">0 reg.</span>
                        </div>
                        <div id="dash-tipoaten-container" style="display:grid;grid-template-columns:1fr;gap:4px;font-size:10px">
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #C9A227"><span>Adulto</span><strong id="tipoaten-1">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #D4AF37"><span>Adulto + Tinnitus</span><strong id="tipoaten-2">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #B8963D"><span>Pediátrico</span><strong id="tipoaten-3">0</strong></div>
                        </div>
                    </div>
                    
                    <!-- MOTIVO DE DEVOLUCIÓN - Campos del funnel -->
                    <div class="panel" style="padding:12px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                            <span style="font-size:10px;font-weight:700;color:#8B7355;letter-spacing:0.3px">📋 Motivo de Devolución</span>
                            <span id="dash-motivo-total" style="font-size:9px;color:#8B7355;background:#f8f4e8;padding:2px 6px;border-radius:4px;font-weight:500">0 casos</span>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:10px">
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #8B7355"><span>Es caro</span><strong id="motivo-1">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #8B7355"><span>Financ. denegada</span><strong id="motivo-2">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #8B7355"><span>Se va de viaje</span><strong id="motivo-3">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #8B7355"><span>No ve mejoría</span><strong id="motivo-4">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #8B7355"><span>Concienciación</span><strong id="motivo-5">0</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 8px;background:#f8f4e8;border-radius:4px;border-left:3px solid #8B7355"><span>Busca otro audífono</span><strong id="motivo-6">0</strong></div>
                        </div>
                    </div>
                </div>
                
                <!-- ========== GRUPO 3: VISITAS-PROCESOS ========== -->
                <div style="background:linear-gradient(90deg,#8B7355,#6D5A42);padding:5px 12px;border-radius:4px;margin-bottom:8px">
                    <span style="color:#fff;font-size:11px;font-weight:700;letter-spacing:0.5px">📋 Visitas - Procesos</span>
                </div>
                
                <!-- 11 BÁSICOS + BLOQUES - TAMAÑO REDUCIDO -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
                    <!-- Panel Pentágono -->
                    <div class="panel" style="padding:8px;display:flex;flex-direction:column">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                            <span style="font-size:10px;font-weight:700;color:#8B7355;letter-spacing:0.3px">⭐ 11 Básicos</span>
                            <div style="display:flex;align-items:center;gap:8px">
                                <span id="dash-pent-total" style="font-size:11px;color:#8B7355">(0 inf.)</span>
                                <div style="padding:4px 10px;background:linear-gradient(135deg,#C9A227,#B8963D);border-radius:6px">
                                    <strong id="dash-pent-global" style="color:#fff;font-size:13px">0%</strong>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;justify-content:center;align-items:center;flex:1">
                            <div style="height:180px;width:100%;max-width:220px;position:relative"><canvas id="pentagono-dashboard"></canvas></div>
                        </div>
                    </div>
                    <!-- Panel Bloques -->
                    <div class="panel" style="padding:8px;display:flex;flex-direction:column">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                            <span style="font-size:10px;font-weight:700;color:#8B7355;letter-spacing:0.3px">📊 % Aplicación Bloque</span>
                            <div style="padding:4px 10px;background:linear-gradient(135deg,#C9A227,#B8963D);border-radius:6px">
                                <strong id="dash-prom-general" style="color:#fff;font-size:11px">0%</strong>
                            </div>
                        </div>
                        <div id="dash-barras-bloques" style="display:flex;flex-direction:column;justify-content:center;flex:1;gap:2px">
                            <div style="display:flex;align-items:center;gap:3px"><span style="width:12px;height:12px;background:#6b7280;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:6px">🎧</span><span style="width:55px;font-size:7px;color:#8B7355">PIA (25%)</span><div style="flex:1;background:#f0f0f0;height:8px;border-radius:2px;overflow:hidden"><div id="dash-bar-pia" style="height:100%;background:#C9A227;width:0%;transition:width 0.5s"></div></div><span style="width:28px;text-align:right;font-size:7px;color:#C9A227;font-weight:600" id="dash-apl-pia">0%</span></div>
                            <div style="display:flex;align-items:center;gap:3px"><span style="width:12px;height:12px;background:#5c5c5c;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:6px">📚</span><span style="width:55px;font-size:7px;color:#8B7355">Form. (15%)</span><div style="flex:1;background:#f0f0f0;height:8px;border-radius:2px;overflow:hidden"><div id="dash-bar-form" style="height:100%;background:#b8860b;width:0%;transition:width 0.5s"></div></div><span style="width:28px;text-align:right;font-size:7px;color:#C9A227;font-weight:600" id="dash-apl-form">0%</span></div>
                            <div style="display:flex;align-items:center;gap:3px"><span style="width:12px;height:12px;background:#C9A227;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:6px">📢</span><span style="width:55px;font-size:7px;color:#8B7355">Com. (15%)</span><div style="flex:1;background:#f0f0f0;height:8px;border-radius:2px;overflow:hidden"><div id="dash-bar-com" style="height:100%;background:#C9A227;width:0%;transition:width 0.5s"></div></div><span style="width:28px;text-align:right;font-size:7px;color:#C9A227;font-weight:600" id="dash-apl-com">0%</span></div>
                            <div style="display:flex;align-items:center;gap:3px"><span style="width:12px;height:12px;background:#8b8b8b;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:6px">💛</span><span style="width:55px;font-size:7px;color:#8B7355">Ayud. (4%)</span><div style="flex:1;background:#f0f0f0;height:8px;border-radius:2px;overflow:hidden"><div id="dash-bar-ayu" style="height:100%;background:#d4883e;width:0%;transition:width 0.5s"></div></div><span style="width:28px;text-align:right;font-size:7px;color:#C9A227;font-weight:600" id="dash-apl-ayu">0%</span></div>
                            <div style="display:flex;align-items:center;gap:3px"><span style="width:12px;height:12px;background:#7a7a7a;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:6px">➕</span><span style="width:55px;font-size:7px;color:#8B7355">Comp. (6%)</span><div style="flex:1;background:#f0f0f0;height:8px;border-radius:2px;overflow:hidden"><div id="dash-bar-comp" style="height:100%;background:#cc7722;width:0%;transition:width 0.5s"></div></div><span style="width:28px;text-align:right;font-size:7px;color:#C9A227;font-weight:600" id="dash-apl-comp">0%</span></div>
                            <div style="display:flex;align-items:center;gap:3px"><span style="width:12px;height:12px;background:#6b7280;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:6px">🏪</span><span style="width:55px;font-size:7px;color:#8B7355">RT (25%)</span><div style="flex:1;background:#f0f0f0;height:8px;border-radius:2px;overflow:hidden"><div id="dash-bar-rt" style="height:100%;background:#C9A227;width:0%;transition:width 0.5s"></div></div><span style="width:28px;text-align:right;font-size:7px;color:#C9A227;font-weight:600" id="dash-apl-rt">0%</span></div>
                            <div style="display:flex;align-items:center;gap:3px"><span style="width:12px;height:12px;background:#B8963D;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:6px">💹</span><span style="width:55px;font-size:7px;color:#8B7355">Conv. (0%)</span><div style="flex:1;background:#f0f0f0;height:8px;border-radius:2px;overflow:hidden"><div id="dash-bar-conv" style="height:100%;background:#B8963D;width:0%;transition:width 0.5s"></div></div><span style="width:28px;text-align:right;font-size:7px;color:#C9A227;font-weight:600" id="dash-apl-conv">0%</span></div>
                            <div style="display:flex;align-items:center;gap:3px"><span style="width:12px;height:12px;background:#A68B1E;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:6px">📅</span><span style="width:55px;font-size:7px;color:#8B7355">Agen. (10%)</span><div style="flex:1;background:#f0f0f0;height:8px;border-radius:2px;overflow:hidden"><div id="dash-bar-age" style="height:100%;background:#A68B1E;width:0%;transition:width 0.5s"></div></div><span style="width:28px;text-align:right;font-size:7px;color:#C9A227;font-weight:600" id="dash-apl-age">0%</span></div>
                        </div>
                    </div>
                </div>
                <!-- RADARES 2x2 -->
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:10px">
                    <div class="panel" style="padding:8px 12px;overflow:visible">
                        <div class="panel-title" style="color:#8B7355;margin-bottom:4px;font-size:10px;letter-spacing:0.3px">🎧 PIA <span id="radar-pia-total" style="font-size:8px;color:#8B7355;font-weight:400">(0 inf.)</span></div>
                        <div style="height:140px;width:100%;position:relative"><canvas id="radar-dash-pia" style="box-sizing: border-box; display: block; height: 0px; width: 0px;" width="0" height="0"></canvas></div>
                        <div id="leyenda-pia" style="font-size:7px;color:#8B7355;text-align:center;margin-top:2px;line-height:1.3;display:none">-</div>
                    </div>
                    <div class="panel" style="padding:8px 12px;overflow:visible">
                        <div class="panel-title" style="color:#8B7355;margin-bottom:4px;font-size:10px;letter-spacing:0.3px">🏪 RT <span id="radar-rt-total" style="font-size:8px;color:#8B7355;font-weight:400">(0 inf.)</span></div>
                        <div style="height:140px;width:100%;position:relative"><canvas id="radar-dash-rt" style="box-sizing: border-box; display: block; height: 0px; width: 0px;" width="0" height="0"></canvas></div>
                        <div id="leyenda-rt" style="font-size:7px;color:#8B7355;text-align:center;margin-top:2px;line-height:1.3;display:none">-</div>
                    </div>
                    <div class="panel" style="padding:8px 12px;overflow:visible">
                        <div class="panel-title" style="color:#8B7355;margin-bottom:4px;font-size:10px;letter-spacing:0.3px">📚 Formación <span id="radar-form-total" style="font-size:8px;color:#8B7355;font-weight:400">(0 inf.)</span></div>
                        <div style="height:140px;width:100%;position:relative"><canvas id="radar-dash-form" style="box-sizing: border-box; display: block; height: 0px; width: 0px;" width="0" height="0"></canvas></div>
                        <div id="leyenda-form" style="font-size:7px;color:#8B7355;text-align:center;margin-top:2px;line-height:1.3;display:none">-</div>
                    </div>
                    <div class="panel" style="padding:8px 12px;overflow:visible">
                        <div class="panel-title" style="color:#8B7355;margin-bottom:4px;font-size:10px;letter-spacing:0.3px">🎯 Otros <span id="radar-kpis-total" style="font-size:8px;color:#8B7355;font-weight:400">(0 inf.)</span></div>
                        <div style="height:140px;width:100%;position:relative"><canvas id="radar-dash-kpis" style="box-sizing: border-box; display: block; height: 0px; width: 0px;" width="0" height="0"></canvas></div>
                        <div id="leyenda-kpis" style="font-size:7px;color:#8B7355;text-align:center;margin-top:2px;line-height:1.3;display:none">-</div>
                    </div>
                </div>
                <!-- TERCERA FILA: SOLO RANKING -->
                <div id="panel-ranking-dashboard" class="panel" style="padding:10px">
                    <div class="panel-title" style="color:#8B7355;margin-bottom:8px;font-size:10px;letter-spacing:0.3px">🏆 Ranking de Centros Visitados (Top 10)</div>
                    <div style="overflow-y:auto;max-height:150px">
                        <table style="width:100%;border-collapse:collapse;font-size:9px;color:#3a3a3a">
                            <thead style="position:sticky;top:0;background:#fff">
                                <tr style="background:#f8f8f8;border-bottom:2px solid #C9A227">
                                    <th style="padding:5px 3px;text-align:left;color:#8B7355;font-weight:600">#</th>
                                    <th style="padding:5px 3px;text-align:left;color:#8B7355;font-weight:600">Centro</th>
                                    <th style="padding:5px 3px;text-align:left;color:#8B7355;font-weight:600">Fecha</th>
                                    <th style="padding:5px 3px;text-align:left;color:#8B7355;font-weight:600">Deleg. Audio</th>
                                    <th style="padding:5px 3px;text-align:left;color:#8B7355;font-weight:600">Deleg. Regional</th>
                                    <th style="padding:5px 3px;text-align:right;color:#8B7355;font-weight:600">Nota</th>
                                </tr>
                            </thead>
                            <tbody id="dash-ranking-tbody"><tr><td colspan="6" style="text-align:center;padding:20px;color:#b0a48a">Sin informes finalizados</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </section></section>
            <section id="section-calendario" class="section" style="overflow-y:auto">
                <div style="padding:10px">
                    <!-- Header faldón negro/gris -->
                    <div style="background:linear-gradient(135deg,#2d2d2d,#1a1a1a);color:#C9A227;padding:12px 16px;border-radius:10px;margin-bottom:8px;border-bottom:3px solid #C9A227;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
                        <div style="display:flex;align-items:center;gap:10px">
                            <span style="font-size:24px">📅</span>
                            <div>
                                <h3 style="margin:0;font-size:14px;font-weight:700">Calendario de Visitas</h3>
                                <p style="margin:2px 0 0 0;font-size:10px;color:#888"><span id="totalCentrosVisitas">224</span> Centros • Agenda y seguimiento</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CONTADORES POR RESPONSABLE -->
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:12px">
                        <!-- Contador Ariannys -->
                        <div style="background:#fff;border-radius:8px;padding:12px;border:2px solid #C9A227;display:flex;align-items:center;gap:12px">
                            <img src="data:image/png;base64,UklGRvwsAABXRUJQVlA4WAoAAAAgAAAAoAEAswEASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZWUDggDisAAHAPAZ0BKqEBtAE+USaPRSOiIRVp9OA4BQSzt3C48GxVr/ZIN13HdeX9yH57AjunnX/YVuQ93S84c7McXWfxF8Bb5JKE8w/jvu+PGBxF43uZVZxvcyqzje5lVm/V5f99+CDaDNIA16OnUkSk5QzbxEm/FLHjA4i8b3Mqs43tklbY/hnSEBS8oXNrJRcGMz9FDvtYi+lhHuaD5I6z0l2gChiGtQigOIvG9zKrON7mDcYYj+ibZtMPgE2x4JXojIufG05YWvpRZSy/UPeUsr5AmiwVmsSzje5lVnG9zJ9i/BVEu1dsSMFNXecSzzTF4/MzgJQhRoW1Mq1vt3GqmEgNEx+G63WnUVWcb3Mqs43uZNfL/1kqhawtoLWpmH/m2TxM0bjYgnPmkQPqazXzmlCvzpa3fS5mXg2uvwRMzDvrNMePXiMNOcvTOIvG9zKrON7Vs7JKbWjsk8xaQralWDgzbJHcYs2xtR/LcIRVWlpw1f75AI/q7MCpXTi082On4t7WUkPvQKEA7I97Eo/ljKrON7mVWcb2vEMOUYb9JFgzv18o/NX4OsB8CPUPyU9ldGuMdQicVLV6JFpOTMH2uo7VYdTASJyQficJzKrON7mVWcb2xngdrYfD0sz5alztcBCPTg5nQ0pB94y82SNkrINkLkXywRkCdvl0OGpNBAxzyLB83rw5Y8YHEXje5lVj1/+m0vdXDQg4sSqnmUZo5cTCv/+5b5Qvcf/Cr3sxJ4M1w4CLZ4uFZjKl7jxgcReN7mVWbfaQd8yCgTzi8JVrm2ssOQMNkOkf5ujK6eHpdpV+p11tMxOlR0WZEXje5lVnG9y0WiBTjROxSDDyl11tDHiW5DDwHckaJY6h1kUxlip3T/JcWc16F3Eadbm96CjJ9Rtb47MrGx6TXX9j0lQvPsRwryTIQLGD/rHrlDUvsuf4BnjgYs2H4T8yPmshQ/c8rvHfpx+AiP4NFDgjL6FwF2l0pXuZTChCwpX/BQr0WDXv5CwlowEkeqPk4lnG9zKrD5+/iXt8hQZtQgIt2m4chCD5ZPaTixp3h268LVYohCxGW//IbQtqZf6r62MI70GZe42YqbYpiBECZmyZWVOv7HpNTqwsMe///YfBLxkQz4T+f0NejejPbl9+MxFtC0ZBnb7X6CcEV02pAhOT8onBEGBwkt/2gHEOnKBG186AMFh4+ycEhIg6+ygXyjF0S3Y9ASWGAv/RjPMGDZndc5XCguFnRzD3KptNcOIL9LNEtGvNHPyEyaTdLwMCfnSkhRV3hpWVJGwwnGGbPll6KiJg7J6tDxKdSxcOfIpRwHjuC8F4XnAz7PKPSaomAZHcVPgHU0wx2mLee4/3YMzZzn9wRNfQA2JFzUGbljy9N+jufR9OIXUrlpU3H0DPR4TnlQl8LJv2nxngN/yEBRuGMyLxET5PO9LQTh0NERF41TQ5oMcfrk2odKy7EF1qa5Nv7jArY8d1ToE+O5CxrFPCH3HoxWSmNbnCBvfd+9albfq+eSeRHAGAXzZfitv08i3a2vG9xLsggN1mclwcO6A4xT3Wsyxyajqg7anhUs1OhymiWrqUejMe99111jYNubM9HuPUE2+CNQMw3rTRAb/hvzrvxZG+7NDMfSPzv4Ii8ZImDu8F6d133BeCHqMM2u1VswsClC4SEtSQ/cTn+p7o+MgX4GEv8l3NkJH/RaBG/u+ZpH9C2ZBtGo972dxHIC2al29RA3doaNCypM8bdBYuZt+v/BORw6JdzKogrAUJrrtSTbLCffRkVzHdy5wcEC6hOSHua/NZ/SEdaZGpKWr2v6ITbatUTnVonpklLY7huLc5E5G1KGjMCNKaoIdyAsLdZYceSJB1pBpyn4HKXSk6ILBd+HTx9FhiZlGAgtLIkIomwpuBBVeR7pohyj5WtpD6bPUDyHL7FcAtjBXwfw/qIF3I+AF8FBK05XgngxEJt3YCOGaTnNd8ww2pqepXkXiWYcC53qmgo2jiKb8BkGFtTFZs+s8D3lGZLYQkUbSAN3WGrkveRhA2NKv+3gEg1/Bbv6RL2alTXZoLogiqmCS1Pwvr/mHA67YvmEtAFUxyP+htWC/6dzFg3olnJlYoVe+cyAfFF0ujj863Jjf9n/HcXU5yAcZyQhkYsFYp/qpwE0WCezosksCczs4U2HF77hU1Sn7vWPXlAOnjOngo+DmKceZ0XZt7aKLwg2O87J6/DmbNLS5StEMigaKn4toUyxOWTXcTlmXJwhGLb0wgywxpi4nGC9rQuFL/lG+UpsOPn6CByx4CcU0NSHIsfTKvDvYglwr1oEOWylIRNHzTfuZM+DocX1O/EEWV9W/EvJ0HI7cwOxposqEjDaz618KnEQIGQvB0xRMB2b0b+QxN3tB9ka8uR4Gw7xzFYCuIOX5N93bnMV/+Xy7+CgItHOM4XnotDk/KhHJRsUkaH6YAEBw0kgTlsxpSKDdisPjGVlTW1dtx5Twy7Y+ff58EKXR/q7YXIGQr7GByX0Nbo4vGKFM2htazU+bTQWgNNKFPZ7rvsnH06B5Kyko6HWyIJydG1Eum6RR5p85LuNZvSyrLb8BE34Mff89TeXluFqGt0leQpY+Vv3sBsRXlWx0ySc56GXFO2WWkgjH8RCLRoqQc1+HQ6EdidPO+5KVwoqe/q0Cac7aHYl05SYcd7uMWCkrcQxmua+SfByR+ZPuSttS+8jdFsVhy9e1demin5rqve7+SNTjr9kX7WcJACdCN2xtnp6yLxYymW9dj9yZCS2RBnR6BNZQzldKVFYPIH6GxXL5ijhAxsqO+FB+CrLq8zakfWFWFmkFWZZzVMGOnD50HbxR4DpZjbJ+VGiGdnp7qFjB92qOnyS0ojK3cfygbV4dHR6Jak/26DtGRz6zRM9BnV3DIA6PDlZYZdjuA34AQAP7/m+gAAAAAI7k0+8ualG7Ur2EzL8zJvdU6D9qqh8rzjZ9Nmmsy0p9yVL28SKJ17/txbmlFjl5xUbf4mL6jEVoqmzXZmED5VcQqvYb5/yVMAOcBlemBG4zQ0NJBBe/n6BNIIqUkZiXKQ+SHTEV7Kd7GoE1YVoEFirGAIFwrGfnd/dkqbgVMs5ODtcWSLG4wcK7c8AACXZo3fmUsrwvC+JjqseJk2Bc3//Zt1abkz4bhjCLWvAT1jUJaF9+PrCfNup6yCbRT6vi96kKXbaoqATSZ88s8XbOBo4s9Nkt24p3C3hhVVf3sCLHQ838ZLaMSF2eVN8EtndnRP+IWcAqt489jsGrNAbCb/uPp/CzzSsmcM8ICCfQ4Lfs+9AG9opqX+OtyqU/5EIYsKtv4Ick/hchQxZzgQJtIRouz8Myh4N1wVhvRfgNCV23oYDlViU6iAACklJercwPzb8kdnlD6WuJPqxDL0LI2sDkXgRkRZSQvswXFgB9cyjtJ0QyBA2rO7X5Hz2DCWENsKBaLMDguw2DLsf7HucYKMgLy8jVDSQ617QEi0m7UCCSdcwKWXdQb2dXBgbL2/lTAevHhSQqFIw3iJi2Sde5jgfb2xkhWB+h64LsP27+8WuqyI1lgjFCLmdT684BKuRAqHdzR6+CK07v07Gx2+viTHzDYkAAAk2rOq21F+1tdxntoSFzTEWnih/SQoqmshVADasq7fQ1V4qM/nzxdGtRv1Ljg7tiqCZMSxuIhREGQngWSUpZgF3VuWfmeynolWyBiu0C4+NWK84Uh0xahbaT5LPJaBQrDYITogKScixx4wEQaeNLhdQgODfXPr47lTL7YGpbS7MDrhBSenxS2XoF290/ZwU1+RVvgnpBraiP4TJ9AbMMupSrGKSs1O00aZja5FuT+eUBkeU7CehxCbw9u/LC2dFXJOBpA4AARONZk/hnzYKCSnuYPJ4cUMJwGOD28xyz2wijtWJhuM1jRmY9NBQrFu1PSWNoR7NvVLSp37cRAKlCqxXUNij1y6602GTQ4CAHciZAKuNJcbHbc9nRKQ2AeJSLmkH9QhoKp83H94wSzDsaXXvO2GqrE3J753kr38tzwfHteJbM3+qrM357kPymB5cQvgWlxSnRGyqDLYlkfwLGZyvjwBqwZ6QtsUfuKsZDYEGDaFaOVRFFra5BjG7GWOomPWNuex/VTYio9k0eov38Vd+sgNpMgwWSQ0LF3GCMk5T+3NSNr1t6iFwZCdKP45WvVtLGEjWXgb7tXHxU8Bg+CCPKHA3ghFNAaW/x0ltl8N0sngdj6z/R4o5M/bCOun2OVNcMRYGLoHRxEXKVamJTQC3sdyO/0yYJx5xYDG2gaOoODr55eJRLuhgqDrhrG9jbJYroJ4tpbR8UO6nIcNCyk6csQMK853z8jjeK6h+nTHvBmBa1j0t2pQWvadVk5EDTf9+Bu9zAEAerGvvl7x2aagidCBUMuoD5aXkGB5076hlW/HLQAALDpinbxDkOs3ov26mF6B7GblKSQEvjzLZWKQbe74L5XScT85+K7pySc/oUvUFCux0oF+c6Y6fJBrdQT2VCpjWfmfy2asicdEUbiEDatwzM/qXdLk5fpN0+roaw72zixXlozh7MxYCz0G+MOosIjTRof72/TR9hqvfnJWodI4gFE/8ILaR4DXjRvCsTmx8HWch98Wh3uxgzwZB0LAK1BBoTv1RfUEY61jKZuv+5OI24P3AdVa63Zxl7llVjDiS70qe1SrN3Y6H9xisx5UyHg9eP1CZ4Cse8q2CglaSdDyZdNImseUBLzMNiLAhPnkzhKauJPRWtQ62GhTjeBwxCKaOguW8/tL2H/tvGiDHnH0ppafRVdnDuoil8L7EPEeXOT/3pJPUibE2aD/AChT2nfByLP0yHBmI7VC+BTQd088AMxz+Da6/SP4La8j4RehdwUwH9PfBZksO0/mpMmhSd7IcAorMhjTGAmvcPbRUqHdabci0vtx2i2M2h8lgGAAW7/EUKHqskzxTr/xXzzfbC/BiUvnXI8oX4/nZGqfBefVInY5a45+UKCzZcfkWAE2PwU1xqU1S6ca/lpd0yIgrp4WZYMeI03TDzNS70R1CaKuFrM85YL1moBrL3bpVNqkQwpy+Mo2NwAIYBhcnIBiVC/SMnYXvRst4iCaHyFGMGB8f80+8joqU5mHmMfkKArOhaidaBHJ4eukILJQ/IHLx+ZLVzRuhssnb9jx0S2kalUj5udc2stN//bPavOBy9oyHKfKiSDFZfiI/depE96tFS62TQEbLNXz9T+xqfSGzwBBEfltaDcgtKE/JUwrLGlpQybi/gJHYfG+/jBrKr6D4u5mJvtZ/RVBP+mL4bvTwxMrgNnbctBlOXp33mr2oPWQ8iTkFQ0Tea8Ufn0W8tkh/t0TNBeb9cshacPuyi/vaFgh1dG38E7UwWF81arr0NDD+BnZi804MCamEgACyG9Qr+DVY6RsDDvM5en3w+tZn0k+6x65U7GOecKmQHGHmyN9KirShF/+yH8VLCGc9BqwtLc8lIjElr25ry4+PKcTuLQ9ter/n6Ly9qc8cJsG+PuLemio/mNXmrE3zM9oyTteiF4aQDXEja5VM4H3ogp9xpQqtZNf+CCz3gJ5yYOM9Y7eBFtBKqftpJsdwVmY/sNQkZHuzYrHiEFShIdWuNWhcZ0yHJUPd6eIDSntMZEx7phSTrdqW3CiUGykGR6wd4HxFY0SoS3Aw4MnfMAk7QxpKz08s0gforLLSuhugv3ttnqnH6QGQTVzsAAUpAJUdMYLgkVRMuYkLOij5nxCf52e2tfpQBH0GCf9+5qMZyrX850ZphjBgP3LNgZsE/G4MjcP1yMlUmcR67yYS6/k8xPi/aUapOTDN13RgxX7GstZA8mk5ib9Jbj1HnqZro2phw6C0IVVghwFyXhb7jvYW4Kk8wV3R9aJWQiYfs7L7WizGx5tLRDU1rvUzNAst+nf4erZkR2E9TIMzeGjjUXNi5gtJ6Gu4jISKq4kli9EekH2sL2SW3TiQ5p+fnIFveeYuppXIYs32CF2VwrQuBclPF/2B5N8ATaU8lAAAj9CNLhYAV6EfbPDkP+NbANR5Va0Rm+JRTtnJQ7EQkjeqG+Ubhfj/OBKiq5LjCcmvWTN0ACbS7U6ruga8HDuAp1lxN9WfAomF7Dgm+b3ZGZryQHWkUIs8NDg7hWNXFwfqFXm5cJ9afSAjUSthX7KvBUK+tm9qwiapJ3xOeR4ewHwhVy3CzWJYXD4V/+8pkzWeM5s/+Y7tjIekbfrt/Bj5F7AtnPqPCQbdsIVY8WTxBQZOw4WoDDoGhfgFkoREC2b6Y7BB8QmPwAAALU827BUMKbKUSRCtWebEtjtt/fK9raZZdv+gbbs2+iqaihQvEUfbEzsXSusWTvP/Wg6CTmEM89vf1/0I6edYdsxnatKGwfDDKsrMXVR5l4TBg/jE+M3vVo2jr4ZBMV/CCqz0wwj85NLQSz15FwTvgJ07EaCF/BP/gDmlVGyuCIO0Q/+RANnUf4YXUxeom9sCiSIDB0juZ5TpmMwWQ9UnSLvtmLIW/48cjXSVClcwQy7LgkCNpX+JeU5nELfOIjkz8d9sU1MT8VlTxmusgHKMKot425uufT2UNGqyroNpAvQg85agQRMUy5E9LMlZjcJ8G3q4eHxmef3qSnjhTDwO+MzE9z+F/6Vd54IeC1FjVfsHlpM0AAXq8wkd8JjQTez7wB34t8OYU7tsIksvLsgAU4rPSZOhLQZaE2+wcqtoxUrkqmDcKMCRUS0dg1EklhlNzEpaCqFfYHfm+Ez8knVjm4tDd+mPQzovGAsWVi7diYXW//+IeMAx956+aC13MHZqnWailhY1KECnw4NPx8b4QESuaqgKNpof7kAn1IzN9hP80RMGjw1LK/M59YRhhNcgp6HyGwD4DKCxBNaZdoZzwRdhJXiMx8g8z3HhUEuRRYUKxqqXjF319DZa2QZ8WlpT6ImshBjJ8T38MWYlFHb1twJQ5+gkNKI7A7mrjYy+AfwU0WN6yxT3vVoMpjzjiT/K3pGsY4wRmpYDyFOW4gpql8zcXI418G6gppa9Gx6Py/g4tFd6mecYbcBwDUIqsSAyrvkxrGoFwz2+TXbp13DI19+tCn1F5ABm5reS67s6V2zzZk7b6z5mktXi37xBBkav4M6htMz4h122qW353PXAZAk16VlpYasCDhJmbXt5jmSTXx0s0SIRD/jMrqcJOa9acHfqAD30TG5uHLYRxqFdLlG9LTmN9cJ9l6FMxybFkEdb6hCB6HZsVjILrPWoVjuyg5cvfePbfEw57IlcG5EewvyiojmY35s+AoAqiSrTjbqb+saSxLN0s02ZmbNrEc79k57cO/Q1QhQBQFl0pSzAgNG8xK70u1UYM4M8M5hR6qM4Ae3Urq7bsTN8OSQV+lk++A/6SxiT9jnXBu6vTLXE9mpMIuImmDs7/ji7spsd9rMvqnY0W5jRPHzNe/Cnl1rnWu5byAhOBcto0T3w6gFPg7AMoYwInilkKgo1ULZuX+bSnscKietri/IcDyCi6G4sYNJ4cZQNRo3GSznLE6GEACpj9Xv3zc2g6kaAdAx20VRsv2Xr+EuHILnw8vIHxt0Ff2DPeFqDfaF0DnYyxi+eVR9WmB6g+Hnmeczi7nU57uoOmcP5Po+UDx+VlYcOvIVi/TpN9RTfXv8hebfSZZPu1bab3Zk3ugraPdXT57bReWqu4Xwuu97k24e4q15PoBXarZVnUnq+8abnKdZ6OK1bKmdYsYR67/huNKgPTxImdPLw9+ZNcqgBv6cVQydxjpEhvUg9AR5AFi/GAscOpxWfInVC5inFxvYAkmJ8/csjFfjXRPAfFbppz7XKRIqOjUgqzXqW+PN+Mh5Ai8lesu0Nx2KgQNC6BQh/Nmts49aReN1VbaqJWlygUx3M48A0sJ3dnvBJVjMqd++TDwbqBbdi31Q3w8PwmwZgUs5KLVt+eo0mYxPu0tNj8V4as/J3DIk0XoxolejctbNgI/LDA2MMbNPvsUR7hAq0F5Y/4PIGP701+0iGum3YEoH1Dg/Lr3VZkBJKcsQ1EPUofx/F0azOfbfko561m9ILSlJYtedEejeRi5YcNx0PIAGnPyw6BcLj+zXrdCFlIecybvSAkQDsXfl1i/eLExIYfjFyW3mrgCXUjGFKEhHaf8/gSFaxzj76C1hZKemNfiCyCFCA8DoSvpsij52Jr9pmdzpIp8RTK52IQnFzojWhwuvMZWKHTyjNupEDjDW8hMZ5qOQEMryoLmotATmCdUZOA+PQRtsCcJ97W4AoxuVouX2yujVyyevFla/r3DaMI82cIqSw0ioQp0RUEpmWSusMWs6naxwC6gI9hhwSSWfQMFSKoOqmuaqV1kM/aT4lTkTqjSIyopWI/Nm8msrUqL1XSWEiqaOtQG0aHM2Bqmv5cPLluu7Ck5cnDc0VQY2W6KRmTzgU91vCbHeoWOZOcrIiCB6Qsf3BzgOxbKGEj8L/rYW9WoNBPAg0D/0eRmU+P4TkOSy/tHEJKmCOyfJVB3879YryA5p/7kcyZBB7/qvSJmdXcFyy+UoTTJextocMyfGsAn9er0wrYjzQ+9525eOVwcnLkKPE1qBkJ0I3E1CLY3oU6ZnYNuwx+9YHLbMlKYT+MdJXH0sR2MdYs3Rw1ycpgiFUfexJiQ68UzILDnnOIhJQJYU6aq0PD2c1s2UByqIuO2oZIFhFN6K8z759dNg7XOcZ/YA8le0TiBZwQ46567hyEGFsTMOB2Nm3u7OQ9zxLfqUJW1iuxa93wuf800k33tKWNxg6Ln8cL5+YNo4s7rGuqHR0QfeO17Y9wXMH+gVg8oR4lKbAYXjaq6M9OhpsR0ANk/ua4UHhZ+uJUAQsyDbQ65qPlavF/dZpHbJXRysiJduewhEA9U2A4Dd5GXCz0eAR4tBuHLCL2x80Ltl6QwZaiX2PXpd99mXFzPOJWFHCfWd35uY2LLo5n08ni+VM8Z+7j4RERMD6PHWHinjsSsm0W97mOLgvDC/iEiEx7G7l+/AQ5tMaPm+EAHyGzDiMjxxLdLxa1s8R9Ji7p369+0qYW2pPc3y3fHL3aO785R5psg10KBPW4GkxDh5F8CUEC401M8g8S3pDpdxbd4ayEsxe9T3WwK6K5zxAiSlVkPBB9FgQqjs27ES28Ydobcq8mjkSm3n6skplbobFy0cD0y7mEhbJGXdujBdM7FEBRXP8x31LiS1FwHZteT/u39genvX+HJrS5ncdEXhQCAY3jxobvAlGMgZ7sylV2K0KZV1ROrHToTBRrimkX+2FXDZ3SN+dnnK0OcePEnutmkNuAYLWIyES9GBtJnyY5nKYpB2YHRSGZQAWcNgSVAmELE/jZdTlkrEVGYu8fNYWwu7UaiQSh01xwGXIdIv0BigKAghk2KwPKqwH3WYCNIwvbVNrkJy6wAKO25f8NOq+2aG8av/iPC+pCdfocgdT646HGTiGndHncof9gER+QYrL2Ap660bQJmkQKcdkdOGYFN/H1aMsAs5TtDI9nIhNlNtXCxnOBOJR7yXOkQWYElB8lVLq8XhPoIDbRCn2AlXfd37Im1iN+kvK+2HDgqn8qO7kJTGUzDC15lsY7bb/EI35oyGNMSesFu8rtuuQv71EC4ETsjjQEJqk8fREXkFL8r3LtCbfji85lwxleMRENaIRIxr3yF5AlKiAsF2yuaeCZoX/9MoP7a78qByddPBLPF+MriOvO8BuygSyIRpUiZfzQy5S5nJV4OvRd6x4KvJmsrD00OShqUdl1tx70Hkby/kt017tnbWJr6cbJ6JmKUxr4WHhkvvurTfjKN9x0YlfIONW7ZgIdtu3g4zeH6tySHEHVTjgBRmwlMGipYTpkHEgfoss7Ojzu0BxdPKj9DGuJdnPzkeoZbOMOzsdHvUB4q+IRPgIoSFlpHTUMJYSoPF3y9iYiz9GCSF+Vk7G+LcHhfFefsmJyTrpeWRBrKV7I67ofwonR3fBGxz0HvIwSf0PMbJ1oipgSsp8O7i7cxIiy6ftsQoVoD7oy4oYIVX/xYv4tbq01I1IuE4mZL+6XkXsaI0xwoahEZ0VWuayaywJuQ4VgNYPFved2CGqFhxx73bBSV4VQHSnG2bwypeGnKr0+2uyE/VqsSbULpWnXYYNQL+4n99IU928D5N+vWnN5nxYnonAsoVqLc/Ya01L32yWiE7366s8JJLJeooHOvsPBl5hqQZ1dQngC0Z9q93wDbCYp7GAOxaFruyDP/Gbizi+bkEJGZBdR5PHq8rDVV+S0zbOlUPbyQ3DgV1uJGwQ1eSG+9LC7GfRcqZ+8N/NoGMALKyfL/CZiE9pSmRS15ykfLVdJriHBwnz94ZwuAOggt9nDm+KNW5wI2Zg2gLwnUu96oK9ua8p4xeK/0lEkV1+p3UkYzBLZsVGDV6i3g6ZyUl4TdffzsAs/LCn2WMlJureqUhRI6bSLe0piOHhG1nxyB6XpUTBAamloxALScJQonYKVSTQU2RbblZr8cz+5UwENR7EyL8crzy2IoTZI8t3kTfvSNF2gYrgt7ZeDZpfofvOxo1yVat1/Mch5Iu9ZaeuUA8MXLGnfL6hLAA7rHYjdt6FVA2AujDgeoGJD/151rtMl6Nn4KxX/y71OotsaK9/lc4AlYlEiNamZnKCbBOlSMwRxPH3ylXO+coPxVy2oHKJzEKlZfqixtCXRtRGk3SAtb0/FnRrPWSzY4uUoCWeus9ZqeAWqRu9M9blPcwU3TE5fXx81yVUVHutYLYDdkJzMBUMK6hZyF82gjq11XkpgzSBteb9sP10bX7Se0K7dB7UI1v+UGcJ/pN0+hBFhOlUTeTdzLR7KyczkVcmSVvPZejVpZD5MSJXhaC350BpqnnBO7Tigd0W6j1hFCcnmi8uzfs7TpKfyWTlaR+Kpcb1fwFA6h8YGDztkANGAWJzlQAU6OMZq2C1qxy6kq7ym2bEMptsME53xDfz96wutUUuGowcnAFqhW4PQtMrhxPPokDE7+QPerf+Zs3CED4g5g7pYzEKiniMO6GIfooHhVpd4gDqL4ItwBaPDHtGLZlT5ZbpGSDCLA5fTxlBLgnRH2WuLk5oLAQoOlC597s8gpNklM5C8mYHJq3PdKY2CSnz3H9yeMopL1GTqvBMt3yGgKNpHoJ7K2gYwuSjNT36flZFmTn6Hbwl36DE1NF6q+OBcS2CrwLg5pNLNdY1jhZPtXcUKlJJn8HEy2XCnLfxhwqgf4QTEChGXzTgtTCEg/+mqhMuDSrjL0iLHPESh80JUf3tMBaa2UKWpsoK61dR3+u58TS7R4IWd10PaVafiAmY66E1MxbMjrZoMR0zigrylav7Sh11njlJoVPIkgC3/wq9Tpyn9NvUJWUexwqtFPaoniFORWXeZNp9UT7YJhIWy8dtpjxYnhgC4k3s7ehk5p03Ztsxon+cUnXvcH+3rdiuF39w2Uw4xD5UQ4AolW4wxc1RKKEBAXGrdScR1q2I430LPJ3GmubhPAl1yDxmETCP2DywLZwjPXC6PSlrJp+Li8Fdtr9jA2IgC38DBLMcEX492BjD0f9TO8yoywlTP7qS61TDPOzcaucsbtARD5jKzNiL1MDTAFCu7b1YgdP5c9OMOWoedL5Cf8aF2e4zqsnug8ZmKPFx31sy40+wv5/OQQ82fp366BcEk/uh8iRHDtljzjdqntNjztB6kFeQulmmFkg+c8+vMccdq1EPiULwmjA4Kgjs2gPPuE1bQQTWs76+ydaYuSZoU/OAOathvcKz8mfdAidPu3Fv2X+X2rfeM0Z20WKOFp4NVBLfSeKuQl/Ne+T7Y727qYxQmIW8iaOewxGAtje9P9bNwx6MiV6M6hcC5gQS8DdaGHuDgqI/dHiUH0a0JgqzA75cPXTp0vw3w9WybxYc75edkMnt1+NqgPpgRvWZWDsiglpkZ8D9kDmGLUbWMi2HSKsG8H9Pn3XG2M9s3H11ofDU/K/hMuypGYd6F3ybs0HeEe3Vb0iinTC5SG9cfPDaM9FynrvAS3H7vF4ESBbsUnwdY5hAR6HMLvIQL0FU6NPRJCa+/1qll9PniK9v8T1u0NgJILwDfSF+MsH/TSXsaRwhOpjp/SAufP/etYFDSLDrtbBQWYuqvNHg+ze+WwaTEPoRorBjitmWgQt2lDyHAlbzpvykV38OqtFDIzSZ3DF6dMeXDnRocSTYdfgYilaUghx2kfTb89yhf9cuOL9ZWktMBNe5IilL5W1Cz1K13V7mTYUgEJc5r2cWn3K+a+jJ7aTO/Qsi43sTDzO0KdUe7faslG2PkbGMmSQ9U3u33Xef8Z0V3ATvh33ZX+H91MxDVgUXYtSZ1xZNbfuiny+EV7sbqBi0mFTgkz+6C7ObBDYtbDR2X0fFMLDJDQi/tC2kaYvV/ANVN2js+liUqTh5tV4e22OgtdIhlZmErOLMskp1fU3WVKoBr2OOt866jEpdOIDaI/7RjW7xW1XERjgnpDPq06sqeCFBb9jQ1DpOKgiZvtlrWDoXJNKDAkhx5UOhzg0OD4iOvVzj0JZt5QaW6lE4+04p72EMJwntbyVXYH2gSQWBujz5PLgbvMDGiYEfh6wg1/PJKZ4jh6/yT7eHFOpyFf9zBHpvdkw7F4Dgd5kA44cv+hHbU+ZF4pd9fePrxXp8f1RKsXupxlpGcgjrebjs+ddjcJWrWstPqxCP5TDRAW4lxB858i8Jlw8No0zokqCQuv4pXKdAGsTx2MXvaJFDL+5+eJl0o73tWk/dbWSmFSSaZ8oBgk9dwXoN4cd/tVkuKtaPODermL0XSovzfelNrBZg9w6UYeXUCKTwUjdwsPv9Y1o0PWPE+Guu50alNk2HDPx1H6gTZLmfe1T2fELLTUP6Ck7MgJZQiLpx1am5PjGhvwe8fX5TUYEBhCG96TdhItSB7F921AKrbTNIS0QKqkQO/vLRC3YW8OX5/57atPmWqpzkBMV1fb2FvU3ZgN7TVNyZ4a6GF5feLWb4M0WAc2dwY/7+bK3HfN/ewVgswUkiDT1tyeou1LOObkNSd4UWhfGMDnwqp676NIJ9gV2dF1LuVFri7DEicOUdmUUU/EgIhG5rYuBZx+pXS6NWU2Mslo6Adp6HJRRS2+kMkl5eYVcpBexp6dFJpJOcCOihoMBPnnshFvnSzLJ5Q15G6bBSQjcZV8Hs7LxWdlGP52yU/wpBwwkiZwO83E+p4s+yY9yKJeReH6f6NwF9jm8iKsZpK9Ov4A2ZBLa7LXnXy43lJTd3KpQOpDvIMpGwYnYbGC8mHnf/D4ubuHrDvMDeonovOJ+JC++lh5c62E9J6tRj4wMb7jssII3hqXy987zWp9jcJCFp6GNMKeuSH07YVxeeYQg1qx7amYOUlnQuOoSPKOfdJNxWMbuLFWYvNX/UuTm4+varISehRFKidGU2JAvFWou35JBO3+GQL/zobwkffsEziqmIkaVlr83+74yTfNj7e2oTtjtxnLPgrmbBmvcdUWprOzBnhK0uXv0reElAjSNxlpDumVsQ5XkM4aR4kDTF/hp3b0J4jH9vndU0fSY/eJr84mbjWEoh/8RGLrpJasXCvXNM/HLh71xIwoUAuTG6pCSuR7UJdckcAK8fKcQCP0y5WiQVA9xGxR+sHYlu2HCfqLj8yOSNwWgCXxEnEBueegkoetDr5zA6mfsdpIGZ8LcfYWgH71/YfeGLvOLD8HY4FSGoP0dGalMvYVwqawQwdYr2OavL1VFTNgqL3QfU7KXSLbwNYPWtNi+pMhacBw5Q/S6VLStxmLiZ3zljXMS23h8u2tvkKMSo4nnlxBteQ2xYFEwMXdRnqVosKXCg4qFPzDof4S4gJ9XCMn8SJkiyWqt3RQnaYkmThrPMhOrWVX+eNDTwYMsQe6A0HR1dP7G2GdNZZvSuEDW/fM+FezK/b0GOUW0rOXNaEwYfLdfrd7zSZM+Bjk9WKZPwtd92FonfCrZre2voZfD5uHKGDV4lhwiXj1TfJQfaQd+uqjFMsC17cGGIswxC6OGQCO4V/wzaIhNGfvl5bu0nqAfOEOzekRMbkf8Qc5ubcTQYSKESthKcaJ5LpMLX/AOvS0k93lcGYHhmzMo5MIgqD1abNwgeJP2dJxekM2O4UUgxU5cqZBChmkeZFhy3+oJpAVeoPZq3ZNOlxOd3Bw3qzDf8TMdNa2ReCDa6GslFjZN4tUGTO6MrNt14f92KF+S4/gLgQ6E79soyYW2hF2LBWPfrfstj1wYwsDE79bqTGbUKwiYlIC9TuE6oFY4PiUtFCY2uWam68xUyxP4SAF/E/+OqYssAwAUKju9N1oZ5Q0fvxIyATMfWCgJSEhKJc+77ZNeTYVius1HE7kNx9vI40EH/rl6f9MXr0XE0DH/MxX8THLv8wKK+JSyzZcIjuWpDS2S1FUokrZ5aKUjcq/MHOdf+qbi8BPbFCKAskijrJMcfB48YwPBB2wtsuvUhXtDpZjuW8Uv1b/4Px0JGEiyEUKKnASMpD0bXfnvtRzZai5CrLOBRoa+sofQf9OYCWgyyi+j/w9CsMNrX2oCUSOIlFmNirUJtRdMgDtA1lzesVREII04k+5POWmRdPS0+i7jVyrQM5ScpvFfQG+A4oKed715ABD0q2BMok5gzAAmFbqJoz0SxiKuthaViRE1VFwEeuTtzzGxXlV6r0ZzZPyB9LM/3+AGgKh+gLlvnMKkjBH+HzQcGHKAQhTrrC6sI+VViBJ+XjHK3DcMFXds4kP1CYW58AHWNRmk6l009M4AAAAAA==" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #C9A227">
                            <div style="flex:1">
                                <div style="font-size:11px;font-weight:700;color:#C9A227">ARIANNYS ROJAS</div>
                                <div style="font-size:9px;color:#666">Total: <span id="totalCentrosARY">106</span> centros</div>
                            </div>
                            <div style="display:flex;gap:6px;flex-wrap:wrap">
                                <div style="text-align:center;padding:5px 8px;background:#f3f4f6;border-radius:6px">
                                    <div style="font-size:13px;font-weight:800;color:#C9A227" id="agendadosARY">8</div>
                                    <div style="font-size:6px;color:#6b7280">AGENDADOS</div>
                                </div>
                                <div style="text-align:center;padding:5px 8px;background:#dcfce7;border-radius:6px">
                                    <div style="font-size:13px;font-weight:800;color:#C9A227" id="procesoARY">0</div>
                                    <div style="font-size:6px;color:#166534">V.PROCESO</div>
                                </div>
                                <div style="text-align:center;padding:5px 8px;background:#fff7ed;border-radius:6px">
                                    <div style="font-size:13px;font-weight:800;color:#D4AF37" id="puntualARY">0</div>
                                    <div style="font-size:6px;color:#6b7280">V.PUNTUAL</div>
                                </div>
                                <div style="text-align:center;padding:5px 8px;background:#f3f4f6;border-radius:6px">
                                    <div style="font-size:13px;font-weight:800;color:#6b7280" id="pendientesARY">98</div>
                                    <div style="font-size:6px;color:#4b5563">PENDIENTES</div>
                                </div>
                            </div>
                        </div>
                        <!-- Contador Sonia -->
                        <div style="background:#fff;border-radius:8px;padding:12px;border:2px solid #8B7355;display:flex;align-items:center;gap:12px">
                            <img src="data:image/webp;base64,UklGRo4oAABXRUJQVlA4WAoAAAAgAAAAqgEAngEASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZWUDggoCYAAJDXAJ0BKqsBnwE+USaQRaOiIZMYnPQ4BQSzt183VwFUE+zcX3uFneLdN+d71J7gtw66yf9D4i+k76vMq978jL5P+W/6XrK7l9Tf+3nygx+vZI5npHyA+UNJT6PH1X6wPrP9pvZ763xJwyvDJZdJi5cXEUg0/kdwO0lUK8tOt4oP1AzueGSy6rwyWXVeDnspcg8at8sY+n11mKTJcY+Ix5diIO69rVeGSy6rwyWWFWaFz1rjHu5vn/S/LXEn3XdMd2Npbx2grIG3E8wyvDJZdV4YhkP08YDMKjOJ2xronik7XzpFHYLhbJ0DILHoWqLCFMJzAKuFkzZtlU7ivL9JiCvYnNHGV4ZLLqvDDVqO07QhWV8ZjxuMRwJIBy3pbTPpMxbNh90yeMJ9lMY1xr4Z4lgsT3TXXfNIlsIipwcEsuq8Mll1TpWT9HFqSC7j+oyH6qFIN0+/KPVeHo4YYRwZt0wUA70i6mrOf3eH2JmXtvWIUxW5IgcXKCATtguqkgkrFsrA91WhLbhZGFt2xu49r0sKSn1KEXkV7ZfXR6JFTks4tas88vi8MnqP+OIUME10l5IK8NqV0P3PWwXVeGSy6P6riGOLJLrmYY1iUnog1QH1l58WCH7+4HWfS0Bb+KrWeQh4/0tBpufcecC5LjfqyKsliPK1hDhAAFtRpB9PgTyMz2wXVdY/rQulMc+72P3jgR6FpsK/dplZPL02hCaGLag0jUvraLINFbqSMgtk+6okkTZLLqvDJZZ6GlHHv+r2i/jUlssIT+SLZCMTpXeLvWsyc8l02XdXMTsS0xlKUR6fz1e7c9QFwNEWQsIvmRdV4ZLLqnHHNHMMG9QxL8UJotdlHchFE6SZbLVsDy0PLWux0VzL0rclcc3qj7JSJhb8eI7+/e+b+Ez64quxH/RcE5cuq8Mll0jcIo7AW3yExCnHOKwbX/c6BO4dcrBoYhCLL62U7CcSxrD10uZIgRhc7eFLbjLVKldJeLtaegJT9GrjgtrwyWXVdbN98ZZU+r/8NCiDeweHiQ5LYY5RrAtGfTKA8VuP+b3mQXoUSIilmH3qhrmygHZ5nYtn8VlKJPNcojrXv+sFCATrCMhdf2XW5CNZcNBRrxkoOHxZVJYT2Vr3lc8ruz1r1bHI11lUZb0mHxU/kbbl9lPHzcOJKjZ/rp5cULpz1kIHBxhGntguqiGeHnP3JvbM9VRNuX5Hl+fCE3C4/ao4GLfvNkhdHMHOksRTZEv4fFq/tZKP8a4NGh6PYmBYPo8RGvN1vRT1EsB/cnDLi9eaSr13DBkQAcbsZKE/89QnxQ1dW6U9a4wNbR2yD0D2rndd3hj/LwI7s+pRqzKDGa+uj0g8GpVv9BjOoiqRgHwOfS9vw4YEbq7B5xtEjmpMMLp+e9PjKlomBa8QKfFMPqsfMhwINR9vh6Dipse0mwQVGdCLoy2TXACdRo7cL77X6gefK9hLaxpl10+4cjPnl9Fl2iK4jsPtVHYZxDBqI7nTJEG8SvcqmwoSlwgsVLcW+09+/2yafwIs9ARl913r8eKLC1f1kLLLqmYggf1C1LCGStIhdTVYSBbHc0pB1y0/PofTTNqe7kSi6vOYcy8kuRDUHMKxjowaZO8y3ytIYHp4EAXSl3gvPXnisv0Z+UrhVb+aIe12x5QKxs/BK3ShQwShhu4f5hRcMMjKqZbqfeQfvF74oXJz0TFc3Ou9E3+40U2i5CI5rCbf9NxKrzljXKTzHEZQ1zHitopd5KsLw1/iwbdAYBbizx7HcfhYZaokNLL7EQgLSMPLjWVZ0Y1RZFzkvy1YNhuuW28pbF3PlX9FFR8lHwOmN33jW5/XFM3X35JNxoHNanroRlvLP+nywPjBrpzr6Fk1oZaOFWMnB93aVZoW6y4iqig4L/DEpBuYf7lodXzmcBbRy+UHuC6U1IPCmuHvYf9lY2pk9PQpgh3xbeRX1dJ847Fn5L3jhMUDWS6ZPR7J/FrSoIhVHujAw36F7WpsYAK8o0bWRJiGtqf5C4nu6VJyd2hp7bXAfW0EO62yF1bP2VpC35qfUhnuN35NF5zjO+1Ceq0uehFJnZtnLMC5eYZryCa9fV99eC2R51+QrwasIEa/QaYcwApzl2bUUHpoj7aECLcYUOvNdVryoP+/I3h+BoWplaKhVOOpfsxPVKmqKi8x6kKnr6qFJNTa8HlrO7DtfiPSlkODFVe+wwscx8/iM9EJfJkg33fzMHnNOZKtxh0+e6kgfwzvHAHKECwA1Z4jXcUg+9iGLkV3WXVyNJa0Ablkn5Bn81+9gIxnSWVlk280h31jIz/NQPFAAP7/XZwAAae5Ke+E/fB/K3HTifuoMgFZXQqrq5WtjF6QTYxe5n5y6LXq7eZP11FUYKiDzOKcIAzrAasOCb3FZ89WUsH9FvUF3J1nfY/Gz4byZXnN922PhNud6ULfEcwFCx9tieu7uu2mTtd6Khhlgrk4vUMWS8z/w6t9XtJ//8t7aeqY3QPeBG/Dx3aaSDuNlOH7Sqg8l8e/OzBZ0r5N3cAAAAAFhl+IyHdSXMmKgj/Buas6TJ4VvhDsLjZtBkM8PoMd1kGJo2GYJ8ZIzHxdQ/AuT0/d3jW7/B/GiDWZdbHSV1aYRv88872rm2GXihpMVTmNNpzNCy7QEXFT8v/ivaZ/IkQLKEe42HXwZeYeHKOs85FRE36E5UzTXv1loWMZtW69ByJh8VW1tU8lwiCMGxwT1kyXWKwk8KyK4lfbtlWBzJVrOhMHKHKEjhXb30+A4lB/gZtPtx+GAuPoLuPIXhAm4xr7HqrEDAPzbEMZncOXZc/8MdV4GQAAAAAzfY/Yko9fvayofPwO6yUxUQw4p8nfAF0IMyl5nbLfxsfpqdxZmifoIQt/1nBk4PLRmWEyljEtlRQaVXMjYJ/9acj50TZcfEFv6h6GlzwWI3t4/qJNGCttmy9ZvwqgqsH/0cR81xb1tQF+ido3K64vAoHLWNlYj23nXvmdHV3eTQZg4CdaTaUoVqQrItKWH0TIHKJv1ZabTYQoVWe45QcdTzSrM2w8Wi8HTXx6DQDKJOLhAYIrU/iPdmAy6owEuwryZka196wWRO8YqUjW/JwLHSlaj4eAUiA1tvwgAAAS7lnMQO0Thar/8rP/sQzos/0/5+Ce9tjEYr85XJHdrBNxJaC9/xmjtdvuAOPdvgsxur6xH9zoEXJ03IteFE1yTpG8XW+OZQzjV8pSgSc6UZa5ovtVr4xqW+TpBkIl46miWOfCYOcRC3EPmE7LVtqXPTbrSTN+sQCo3uqY8BZwLHWwHS83tFbHJuXsfC/2OsQPxIrYCPQu4YLLjYAKtpJKTs2Nk8DEZA4JtPFFXAHyItKjKtWNAxGEx2eK7itRmhEFnrvgoSv94pfInk6ZKSlNgZ6zVU9S6NSfKBGfiaeHWOHg7f+RKV8oJGwrdsdhEcaA+djTpzgeBq26lx2nX2K4EtBgOtKNdxNKv6HebxcV+Vd4Fm3ssKdaAAALW9vwOVFHWHDzAbsOHg6B5gpuMCjSBochFyHPfrdiZrKANYPzZ76ZV5CXmjym3f6MXT3uy0OKXOH6KPIp7kC1c/Wub7vcVhpogsvR2VHgfTIW+pWV/8z+LYNhlzWHROOnq/vlXXj7IcAK8lps5Dj0NgeJwxB3KmBBP1jpPVBW/bV/dNKiuGVF08TJ88qDNHIygKbwxB3wGqSwWeTWX2g+IaWxLbMsPx2MZ8eANApH7vSbevf8Bgus6U8KjsAFqRFhImzAmNJaLdCckzKemcgjUUaslW4eEn7Hp0duTimBTDS4shV5ncdKknXHgsx90uYdo46eDs97QOY+OkjE57zConvNSxO0oSF36K9QAABa4ifa9qWnvubhUtXNWAyWqiWNs4ZBCxH25zgzDPkACjGYjTBHbl0NXW64OAtGA0oVlMJIQ9XFWiNKVDThpK8LRT63gA/3FyYpZrK1958w/A0lWtr0hjtrOpt3GR/oefsE8B1au/JKcLPX6Kn8sk4BXngkxzQItpt1egy+U4r8aA3L8kdusvQoVnShWhn7u46TiUU3SKbvrGQhZiijAgPdNAX9q80LW134irt6477P4xpBjZKk/Fw0VPBQk6dEKE1fsJWjyELM5WKRYJoo7BR89/aEMlzA49PEfs2Sjdbzz2NkdTreq92kYG3rfETasVn0jJQdF8Pru9pwnekm5Sa0/Y5QkZAABvxd7vMVdyYWnYmL5e+cpAScdw3/2Y6iGPnU1bI19bnXkCKjM5wJYxIrHmd3uETewx8izhiC2AQEobjdp227i/Y0E4A8yypkHK9m90Ae0XCtHUIRo5sY/eACVnqRogwmqd+U+ILCKXluwhUH6RGQ3RoFuNe2n8LrT9rDUeDgAVBKt2oNKJdStDRMcXGtke4qq9XL12jWNM9L9o4GWf7UIESnInlANYc0C85nT+z3h2E5wrcB/CEzlRuAk1iQz0Xz9mLubzdweUmZjsrv+1emP6CpOsWh2EGc2inCgZG+gk3k32HSVvWQLzvQAD/HJeYb6Xff2FrpfkMhc6ICRNW5a91ShagbKBmNtICAY0cg/WdR1ebmZ02fk2QTvkk2y4z53H7LRGH3UxC168nzdo4pL4uE9FcqRvup6l0G+zpM2H8PC/VySEI3bsy+7RfxHw/KNbiAeDnFPietSBf3IsBMyNNuVtQmA3SXZkQTkr1u0ZTFCuAE2cXiSQzA/2S7Nwed6FxESAAG8070cmv7Pbqw80E3GcYjjeeeOezlG4an2m3Zc/7hV0Dm14SGHXHNG/XWwUMaOHQVXrC1AHxhmkTNb5/QeVSopRt3DdaTsTf4memobauVuKOwTFssyNMJFBKNFkJhQHOMXLCzIIwj5wYCe5KXnHIDRNwdobPuJLaww37rLGFHj0cy4E9Ut0Mb6JW7ZNToMYRHxhfcZm2NGnndiADLGzsxXTYGx6xz8icU9UcXZ6ggjuoTUVnIHkHcfPQbfBtpElOQDs+eNGykYMTZ/5j5urXNJokp1SMybwuVkeRWQxJtqAiyHzpk/dK7YqxNusNq1/GUtCDInKWBXYog5ic/EDtPa0zo+YXbNZnnpOy0O9K6P+UvkxPBXWnKn8CvO5uVPh2yk98jiRHq9hvawdjyFFPfWyRJIwGh74k2gXi5aMszc8PRHur9NCo4KL6YddgtZ0cmelyw/4MxG0C49YsTmtWDH9I0G4cQf+vpY8ODWcsRRIqMJOL2rcvJn8u1dW3bcJCkCirpnroldLtwmItWgFWdoxcF/oUpr4wM2czZnXQ4XSFJ3zXak4TeDHyBOUhG+3U9kCP6aAyqeJYncHpejE8vBw6cuwC97mMYxCf7o1GNwAALfk9ab6+T1Th/5rG3owrMENP8oMwACRLzydz1pMwJlG/prS3S5gTJMi+slSsE+zOVy5IW7S0rTQBd98okbAafmoMoqn6owKEu0CK9zrCBX9RHRydLgfsRhujjyAfq8LzUgcrXqe1+CMiS3g2rYYSvGRn4PfluEns86COl9skWk//uue0kdc2K0hb4GYCHdMHR/Xn4Ox+TVY5b6u+f5tBEeqw6UMpQfbP3PqsMY1I22OOVREwhLrlta4qVCgs5tCKVHH5EwsAb++mgBE/7BhXoAYCoKxT3sc+GyILUXnw0rUbnts1JZ92zR9wUuRzHukMwzkqMAEAABM8d+iwP90LcPpZVyXGP2dlA77rxPquLCQto83hUVPd386MYsY/dfbZY211lT62ou0kWpLWVTeRNwCxq/Brrguoojgxa3UGId5Mvn7pM6im7ShNNSey5WjMy/QyJYhxiiGcOikRQG1GggyPS5CgKnhsOZ5xXQAEzENrWJduS7DuY5CxaUaDXTK+aWH+5AwQtnK09YBvFwvzXXDCBDXAOAHTn1imrnKa0XfvNcA0+ehC/kAJuDKUcEME8EQPToR7bUZrVJB//lSWJdYDFfnTUcAPnXo/Wd0avLC2Ns+HHp5FElfiAqbecQgYbBB4xLEi6qwAAAe/JMue1T1qHwmaiW/zMOHTK3/cLVT97JKuu9N0Bty+lN9qUbUi7Yhj7bo0PMC+/rlrURsHZgEgJEnDwyeySi6a6Dd0vRw9TQXOv1VxRoBp6upKie6nlXHY4bhdHLkLLte+28yFj8dJ028ArC9952OTnSeCfMdVWdgb1FzPjBhf6GRyjgT0YrReZvl89KO3nq/8ta9oXIMH2d+/YOqx5XN4Qe8LPBhEuxtr/BgJhJQHKYiiVMQFU9JOmz55Qy1f3YkBYv5yecgw2T8Am14wClFCJKtUaGHKEX6ADPqHBQNWYOd6YyI4IA9MURz4leZphZpaWCKPmXvLt/kSibxaWM1gD1QtOh5Ss0vet4yF3+grgDpBr2SKB3CAn+Vgwy5hugudOIl2oMmZXtST5/RzKzyhZSW68lbXAAqaoXng1s9l6bZ6iR9c1Bl/VqVa9OigP/BrVoFNplmYw7b6x0r8bfNLre5i2aiKq22s1otDSqAUbRcKt42QlBATvmVKnMcrB2bxqRJxnpSES9lA49C2rkwfmvz+LEBMs7/wsluqsX+OHmLB+j/Fr8vw3Zc8vcLcURNyI47XU8dPHhK5AGb19D3FJ/k34AM/rDX2eJYyK0Vn3XkR7omzfOe8Lj6GC4cuRlkkt2PBr62wLIO7w4fstGyG81ch0C/2/COluayzOcUqQr0yBzc9JcSJw2g3vE1nEQHCiZJNk8o2bZS6rCC//A7FFphZ36hf62bZHWtKA+W1qpRZB+0Y+wn/CuKODUDSb0xNsAeTZUb8fahpRvMcwDCRUo+6v/3qXEQmgRr1JpHDMNR14MkvDx8sORhNzI6qr+LhAu1drz+jmrlkxezrj6iBlTKKT0DN/LOMYf7loajCgg7aFDikxmSl1Bw0TcCqnVLT59DJ2h3vlyvOEQHEcWSGuQs8FQZQ3DYe2Qa5AMwvAAFFbvuBm9lpxsI/Ib49gzxTzEofO3BufkKu48asEdVb/e1418EtRglackToLOrtQqqa+VhOAqzr0Iouw+IthKbfpVDACi4dkwRjp9aK1fNL+uBzVMGURNfteULQbvhcNp6XX7AqfnrrOtgy/6rpqopsS8mjMYV1vxpVdtulb897k85pfawxTnNmUjx9k0il8XTVFfWrJ0VhUGqGemgwtiWrkOa++1yaOegN2NoVH+J+IBXv6gSySCE1qmpQU8TjRVRCDHoR+cRCOvqvmAZGNU80+BPS9bO5cq1xavpskuvi3A6qgd2tZxtSPbf2ryDAdJ4iPrE9XPDdTii0OCK2Y6GyqKbFk/jVdJx3Xknru5IpNBwKDVqZXegQIt6sEq4h+O8ADfqdmnlI7rCzRsQ+dl3Nbjf6ry3MdhJBW+GkfRA/upWBfuE/fcyEiGaS1U+ga7+NvbeZwFgTIR8Dxw5YJG+F9jPhPz7AdG1BY60P5MqfsbOx198lAMW3DyefQhnGtApdPqnyaV82y7fNz/RLFFwzIoM8lOoP//3z5XoMHVqGfNE3Ovme0pUIv8uaf6H1Nh+7VEE+ldrFLtAM749KRcOfbv1e+Ih/G/tIRoc1QSlf9EUyeQKcPWNLqc1+lR6uSz5AJugaYNFZPDnjYcsmWoLjgIyBUKEqpoSdFYDkI2W6mtGu6yqkLhtHKoOGraKiy7Sjrl/d3F8maR8u3MHZj0Ao8zJBwMGMF8Je7GhhmDlOxQUmBT5K5svNyDo92uEkC/VOA5kvQhMNlseYJa0vBXUDhKSXXSbJTj9tiWpHHSSgeNMG0084kALx8hDVWSSAzRIj6Ux898i7ABTcQ2IfIf0qIm4nQOd42GdflxS5ETc25hRHcZB7t/CKxfCgLWDLztwDifvUb84AWY83qVygRDRzd6sFl1Ec0L+Gi1AkukeIctiKsO/rsmiQ+ikDkYdtxo4cvbqtPyjH23Li4OJKiQ9N2KxEi9rNHNBl+M1MXQr64VihjsgEAaDnx2v62N7FjuDOOEjyqgwsWtjJz9/2BeQ+SED7bNZZZ3Z4yW7wKazm0OKrnCz1BuZrRf0Q6hKRnNQrhEnS3Lvdp2dI1wiZYDpGzlpIQOdDT2lZSgwDYu7rXgm4JBaczpGNrXKA4sElZOlpzoFDpIzJKwua7BMEeUHT7qGnXsGfrgag8Jhf5ak437Lg5mkbM/2sdAlKpt7F83b02fOXaLr/38ijWne94DrlD/Y5QM9ox0ssGxXAt3/uwZAhMrLoLh52eqGJ85ZO/IVhgh/OEosyW9OLVauxLgnLGeAuYSm1AYZU37YA5gF/3OAIy/oP0dihMf4D6oceP8e2nl/aDFCACeMO39dapcjMvRe7JTodNtT5HjmJC2FDOdaBseGHWFb1i6xr1968BHuh+Bd56sAEOhRT1OsgAdiAxBhemOJPQGddxg7dYGixe3Zo2tL7shpci6Sebb+7P6TH4WAP18upAvS5MUdDD9bU45ZEI9bnqz4TfJm8xBbUcLfVKSlVp/L0zoq8GkcWUAIeXQ8YhClWiRlaRBzp22u/CY0JOovo0nsfDlF4fW3U83+NL375M0M/CSLHskwRjWJNHjQPa5C+L0PaxqW28g3nYS35VYmEOzeSIucL0AqTBysbep2ykveH/RA4Zm9BNwGtBy3TcMpg6nVZVAnM5xa34J69Kl4bvffaNOKOo9KZxZx9jPhaM/PuibC9uqAOWmeihm0n76noV+YmXCE8NZ+bwDdR7UunSBvr2IMjQUi8jmULcSqe75lY0Pj+aZZeW275nEQuSlsaakq/ozGkdpgIO+6vTJ/zwf+LD1ilX+0cEE7xo+LiuQBj+SbzZfTwnl4c5HfdsbCPFXsB6cE9ZkeLLD0WAKLCipU+rH8NfqTwqCNlZbJuyqfEAEfP129AgYMtqVKXhOWLTk4Nggp4Ys0cnt3K78JjxQyHfnrQHu7TK6GIttdgcYC+5BWUIz5weMI6MXB/lIXb9mjVIyjJNu4PWbEA6LKoD+/WX9xkirb2hRbK9o2zQUBubIg9dMc4xodSh/PfXma/uYHPzapJD7EJTFN+B9CQjjVfsAfY3lMQlwYnvWutKZCba90BLdCC8ezLz9wO6WCuwNXFE0Ghrz5Xa+YzrJM8KFsKn+8PQuEqhwfekYcsWqbJd4RA0n5ChbIHdSeuVKpw5WZ4pjekUVW4ZYwZ/9hwJILykziLlymJmMuGwfONv2LdaxDchWwUkI/lJndQ9hJyQiztgxmnuq46M3xZhY/46ZLcCBKIA0MubsRRdyYLZV8SJCQaOfGAk7mi0W3QI+wr/BQNSbDHB181uMvOHYKDBpQ7f9Sb3KvkgjpWUtzyXD41olVUYuMtDCmKoOGO/ubM4rjfnMjlGIjhphkiT65U9ESW0qa6VdSeTbrKTh3Q3rtU0RSjuSxylBa/VbrIMx0oRVwfYU2DVTNwXBd7Vqt3sgCPRS2CIb7/ga6JgycgnfBfuX46EoxspjmxuxawGLbIufoKktLm1nlIibSe1UUL0frLE7aP2ao/r8JKuYnSAs60apJyFI9tFaxNg/B91IrSPHUkOjS4rTbTl5PaLYRH15kbH5Fnta63khI/mylRxxW1PHO2HfQ0NiIacrrgGT5umDIFbDS4mEE1/z3cVGuXlzLExC9MtUi1v8PpDiJCIf9kOXmvq4kWuezpdKnkXo6bleiW/ccejWC37AeqFgNaOlfmnMMVYH8cBSETYt5M0I53EtRWBjDqHg50TxhgcTbbWSCLveunEVpDNbVFDwPPI2LkrAhvYNe5ma3THcT+FLMWh71fY5MS4NqlE4hbdg803iHnDZXzE280G3339JtyTMn67qG1PqKwYg0jEFUggki+mspY32jb72e0TFSl0Ud2pOQmZgNBpby1J+RYXVdiavm2f9t5J0OsWPF/m0aOqQIXRZXvDzfDL7rdGRZysE+VU3/KV5ePlLkc5YySKhsLCTZOTVkK7ENLCO8eigDqCNxGTzHXX26WVWQtH47aPw/dZQsLIoSY6Xrz29GW0lm1icOXlSRbjCV8vVrPsPthMWo1ibLUfvL88jbU3JtAzV2VQrY+QipWBkcjRkxNdkl7uNxYDvAQnXlcCFFj3HeJPdub+bPaI8S9oONqe90sFEjxvGooMiNzChVoTesa+GZ2VYfQv2iBCQ4m4LmZIOBE48FcqpYQhQROgEqhLhM9DVgN+lNmlVtdtfpZ9nJdwKooXDikHzZT0rBHhNxXxQ05/TbkBcgBnDoCy3NXynFelKaRsg8jFFWJYfBMDuSy/VuuuCjgkheP/KuiFfeDqTQZuhF+RSwLaQVBYKpn3FLFwZ3DjHHhllb8Iqx+oakr6XF+esI/oDIeLoWaC4QVGqx7sOl1lwFUmfTQ9kZD94sWMyZaEVemQWPWH9jKxz2Bu38WER5G7DrhSkZ4X+Yrzf6Fz3a9aKQYZydYC087N/c4bOs2lMl8JF+uWbAfZU9foTqLZ5X1MTSE6MHkcE2uQrURoe4fp/H2SJTRq4fb5kB7+EmEbis7G9ZIfQ1zPrd78KBkkI1uvJUu9AJRSsmcBFlWPBUwPj5R5GH3Azze3egCcvjnNNPGv99N+I2jd1hMKwOnEMpsZ775XkV0NxiNE9kEiCquCq5aYeoDxbTrCAJMVJfZK9O4Zsmn+Sb/JgzIPr84vTwQZriGwqRqNe08GxFtyr4nM89Yer+w5Rg3FM118OhZCShvW/+xql3VIDRy75U5P/Ir0Lk3US6xwelELs6mCP4k8fe8TK+bEUgloMT2CTZGC9dmRI6n5dk312OK1Iy62IJk2UI5pn9+XJczgNbrwsE9IZv3qbjrbeYzWDBSy8+A68f6NkWJfWDaWoEaQk4bXRpvrnZuvGR9HvjMMjCibmis7xEmwT7edbgJ+5i6UlmQkYJFJOlr4EAcD0aw3JWnpxhD+wjDq8BIZNg204FandISOLiHdl+6KOeU6JI8mA+iOiLozY7G4uhel8mKGXv5eEYVYbY8UfuWWAqiU4uBSugS79fvCurEVFkPlsOq+BFOnVyeuMpBH0elcJXfIxL5M8V+LRXwvFAJ82hA3DrGvmqcObd6/MGvHtZ20sJW8PPzB+visP7yXFaOo8fHQau1RqSZwKC3HbG1whkWXaLIJNR6MQGg2sucu0ROGnRqu3v+4NPgCHhlqSwVyJ+fr5VgfMHXJWKGVuYvxtFTx5IvVYbAkk5oZMykNFdVUoqsz/T4aUf6fBLvoQqqvEMg4KDkAZDG0oaGHRFXOFns93jdCpVCBxBHDt1BZqzMbIWO21GAsRSEUvHYuwI/Ni06EfG6DvoTrNy8FhjmhyOv+FV1dvpj7sDO33MbBbxXMFoyK9OiaLgJ/BsojB0jTM6sAcoby5GVAXSyvbjgdTIY7tfgci4S3qIimky+JYT+OBni5C3tLMG2K/vyloFG6tQUg59tiSFc/ylMj9/S/1VnyXTZmBPxVEC/pGfqXsy/xJC/E1FXMHYb4QK1LxVDTFS+QtdUx2UaoEJtooe9PjbQS38W6dqXucCKtkGLINYb0XEXt64X8IWCBLmGl5CXTn0hvv/gKAeYstphx3udZv1hncPCGaOGxGs9r7QDUfUcd0vAr7TolYwn3GD00IBNeCe3Y05lYfCbGJfvVCfD8QljOybgd36I36kxtuTQzW66VHnj5YVZNOn7J2Wqz5r5v8HZAtB/IUOnNxYN0PR7BL7MuEuDHCWKcw3d0ap8uaiVJgp2WVRDT1vy/gnyb2iF0Fd/Dv95bC+1Tsp1c9yjKtBMXe72IE4EiNbjnxc3r5OQmiLCt7mncCbmfXRJEtyx/N9Ed6JPz6c3JEJPc7cHFfAEYnqgkrZFIVuYJw5WChK3i8Wgdk0mnIJ59uZuE7Mb9wJUu0vVR0PEgHnxP+7D499+gdeC8EqtgDDllZfLx0AULgkknLscVXZ+8G+7JqX/JG9PLjiL5KjOemBSxr4Oy+f6slXU5AF/jsye0FrVazdmP9Ik7gSRK7un1Pf1OsR02e5A5f6whvxOE1MNtmn68iZcfluhzTsu1wNNP1XI4hJ3SNsHP+nZ7bNeuajJ6CrqrTDyrzkHgTWmGbeQjCcESLPLuNYKk5cXhdCsV+msYS09GT/kh3KWbk6FK+LFLQA/DOGEtwxZs0Aq7Kxsh3DA8jFBGpoxXnEkTDVdIYRw7NIXqMG6PtJnYt6wDdAvVJpphV9YIk3sQSmk5px/O+Hx6LVZq4br9lB+TjXgNqdgXqwgrLG3cKU6ef1Ic7KquHfIEZnQxZn11wMhrbbfklNJOPbDinga9MnUDvsq71wlPhPf7NSSwHN+DxCemYoIn+CpcG/DkzbyDAY+qm6TiVyNHRnMRnkyH42OrHuY6SA60gm3AZXeHwNKeG3oFBHkmUEb9BaxEHzyLA6BVlx+E+m7ppssU8XuTYZQlKyc0uNZ5EuSCVXV/5HpyKiJ4/ql3DbG1LLGRrH9/GQm/tNQy2xw/Sz0S0SYeTMDLTJX7uwxyC0fnG4nSe4tdxN8ef8VTM2bb/e9q2qK8F3ln2VBYxF+BisAWux31ssadFDv5LH51ZQxWqZlDZQgNc6NP+jnjtDRDn5GPCuK7q9vkFZS13AADEb3E+uG194biP/IN7G1LiCGfpJ0wLSehVMpBcx/tKL/0ckY7BrNRBtirdB6EeisZOyWuyguQZv9vHmxtoaOqwv8wZ8pMn/l0lCv+tVBKcpy2dNmPedbnlCdpPvIsndP+e/wT3oEv9XTVvOOGuDw6VMnZQWzr5nnbNKq3VbwxvxJUAZvXHWT729OB/Loq5H6zLUZ2V9QaeRo54U3UXJ4UINRRVCWAQ56M1Q/MRFDzbvhOwKQzmAu8B0NTMQ39wxtV918Th6hrtoj3n9MAMvhQALTrZoksK2n6g+Lg3n2Tyg4qnpL4Kt6TJKcACPKDsdN79aHOY5jSJP4XE7ckhsGaYKYQX44lZOgOz/A6ErYu4OH7QjB8j79Isgt7C+NVmEhfJbuIs9RS6WopWCFJ00Yd+KVBc8hxbM9fiRCXSyovqrh6v+aN97ZnBhrPGAUj+6hqZyTsN9ETTcl1iRTnj7Q8BgSGcWYTkHR6AiOIdc72705yx1o7ZXjqZGplqmSFIteyGll+GVo2Yr2Ub1djjPgp5tFy8jPd8deFz4qCLmbdFs6wSxwGn1S+fndI919NKdZkqvFifaUWiVzwidMIWMUcZDktqLj0w73MZDqTBCKoTHcF+Yq94V7MmHIQnugykwgAAA==" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #8B7355">
                            <div style="flex:1">
                                <div style="font-size:11px;font-weight:700;color:#8B7355">SONIA GUASQUE</div>
                                <div style="font-size:9px;color:#666">Total: <span id="totalCentrosSG">115</span> centros</div>
                            </div>
                            <div style="display:flex;gap:6px;flex-wrap:wrap">
                                <div style="text-align:center;padding:5px 8px;background:#f3f4f6;border-radius:6px">
                                    <div style="font-size:13px;font-weight:800;color:#C9A227" id="agendadosSG">2</div>
                                    <div style="font-size:6px;color:#6b7280">AGENDADOS</div>
                                </div>
                                <div style="text-align:center;padding:5px 8px;background:#dcfce7;border-radius:6px">
                                    <div style="font-size:13px;font-weight:800;color:#C9A227" id="procesoSG">0</div>
                                    <div style="font-size:6px;color:#166534">V.PROCESO</div>
                                </div>
                                <div style="text-align:center;padding:5px 8px;background:#fff7ed;border-radius:6px">
                                    <div style="font-size:13px;font-weight:800;color:#D4AF37" id="puntualSG">0</div>
                                    <div style="font-size:6px;color:#6b7280">V.PUNTUAL</div>
                                </div>
                                <div style="text-align:center;padding:5px 8px;background:#f3f4f6;border-radius:6px">
                                    <div style="font-size:13px;font-weight:800;color:#6b7280" id="pendientesSG">113</div>
                                    <div style="font-size:6px;color:#4b5563">PENDIENTES</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CALENDARIOS PLEGABLES V2 (debajo de faldones, ancho completo) -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
                        <!-- Calendario Ariannys -->
                        <div class="cal-section">
                            <button class="cal-toggle-btn" onclick="toggleCalendario('ARY',this)">📅 Calendario Ariannys <span class="cal-arrow">▼</span></button>
                            <div id="calContainer-ARY" class="cal-container">
                                <div class="cal-nav">
                                    <button onclick="cambiarMesCal('ARY',-1)">◀</button>
                                    <span id="calTitle-ARY"></span>
                                    <button onclick="cambiarMesCal('ARY',1)">▶</button>
                                </div>
                                <div id="calGrid-ARY" class="cal-grid"></div>
                                <div class="cal-legend">
                                    <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#d1fae5"></div>Disponible</div>
                                    <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#fee2e2"></div>Ocupado</div>
                                    <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#e5e7eb"></div>Oficina/Sede</div>
                                    <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#dbeafe"></div>Vacaciones</div>
                                </div>
                            </div>
                        </div>
                        <!-- Calendario Sonia -->
                        <div class="cal-section">
                            <button class="cal-toggle-btn sonia-btn" onclick="toggleCalendario('SGUASQUE',this)">📅 Calendario Sonia <span class="cal-arrow">▼</span></button>
                            <div id="calContainer-SGUASQUE" class="cal-container">
                                <div class="cal-nav sonia-nav">
                                    <button onclick="cambiarMesCal('SGUASQUE',-1)">◀</button>
                                    <span id="calTitle-SGUASQUE"></span>
                                    <button onclick="cambiarMesCal('SGUASQUE',1)">▶</button>
                                </div>
                                <div id="calGrid-SGUASQUE" class="cal-grid"></div>
                                <div class="cal-legend">
                                    <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#d1fae5"></div>Disponible</div>
                                    <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#fee2e2"></div>Ocupado</div>
                                    <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#e5e7eb"></div>Oficina/Sede</div>
                                    <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#dbeafe"></div>Vacaciones</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- COLUMNAS DELEGADAS -->
                    
                    <!-- BUSCADOR Y FILTROS -->
                    <!-- BUSCADOR Y FILTROS -->
                    <div style="display:flex;gap:4px;align-items:center;flex-wrap:nowrap;margin-bottom:10px;padding:6px 8px;background:#f9f9f9;border-radius:8px;border:1px solid #e5e7eb;width:100%">
                        <input type="text" id="buscadorCentros" placeholder="🔍 Buscar..." oninput="filtrarCentrosVisitas()" style="padding:4px 8px;border:1px solid #C9A227;border-radius:6px;font-size:9px;background:#fff;flex:1;min-width:0">
                        <select id="filtroAAR" onchange="filtrarCentrosVisitas()" style="padding:4px 4px;border:1px solid #C9A227;border-radius:6px;font-size:9px;background:#fff;cursor:pointer;flex:1;min-width:0">
                            <option value="">Todos AAR</option>
                            <option value="CERTIFICADO">✅ Cert.</option>
                            <option value="FORMACION">📚 Form.</option>
                            <option value="NO">Sin AAR</option>
                        </select>
                        <select id="filtroTipo" onchange="filtrarCentrosVisitas()" style="padding:4px 4px;border:1px solid #C9A227;border-radius:6px;font-size:9px;background:#fff;cursor:pointer;flex:1;min-width:0">
                            <option value="">Todos tipos</option>
                            <option value="EXCLUSIVO">🏆 Exclusivos</option>
                            <option value="CORNER">🏪 Corners</option>
                            <option value="AAR_CERT">🎯 AAR Cert.</option>
                            <option value="AAR_FORM">📚 AAR Form.</option>
                            <option value="AAR_NO">⛔ Sin AAR</option>
                        </select>
                        <select id="filtroDelegRegVisitas" onchange="filtrarCentrosVisitas()" style="padding:4px 4px;border:1px solid #C9A227;border-radius:6px;font-size:9px;background:#fff;cursor:pointer;flex:1;min-width:0">
                            <option value="">👤 Deleg.Reg</option>
                            <option value="Blanca Fernández de la Pradilla">Blanca F.</option>
                            <option value="Cecilia Pérez">Cecilia P.</option>
                            <option value="Daniel Chazo">Daniel Ch.</option>
                            <option value="Eneritz Aranguren">Eneritz A.</option>
                            <option value="Laura Plazas">Laura Pl.</option>
                            <option value="Laura Ramos">Laura Ra.</option>
                            <option value="Manuel Cánovas">Manuel C.</option>
                            <option value="Maribel Amezcua">Maribel A.</option>
                            <option value="Marisa Carmona">Marisa C.</option>
                            <option value="Martín Sebastián">Martín S.</option>
                            <option value="Sergio Perán">Sergio P.</option>
                            <option value="Sonia Godino">Sonia G.</option>
                            <option value="Verónica Alfonsín">Verónica A.</option>
                        </select>
                        <select id="filtroDelegAudioVisitas" onchange="filtrarCentrosVisitas()" style="padding:4px 4px;border:1px solid #C9A227;border-radius:6px;font-size:9px;background:#fff;cursor:pointer;flex:1;min-width:0">
                            <option value="">🎧 Audio</option>
                            <option value="ARY">ARY</option>
                            <option value="SGUASQUE">SGUASQUE</option>
                        </select>
                        <select id="filtroPropiedadVisitas" onchange="filtrarCentrosVisitas()" style="padding:4px 4px;border:1px solid #C9A227;border-radius:6px;font-size:9px;background:#fff;cursor:pointer;flex:1;min-width:0">
                            <option value="">🏢 Propiedad</option>
                            <option value="SUCURSAL">Sucursales</option>
                            <option value="FRANQUICIA">Franquicias</option>
                        </select>
                        <select id="filtroPerimetroVisitas" onchange="filtrarCentrosVisitas()" style="padding:4px 4px;border:1px solid #C9A227;border-radius:6px;font-size:9px;background:#fff;cursor:pointer;flex:1;min-width:0">
                            <option value="">📊 Perímetro</option>
                            <option value="PC">PC</option>
                            <option value="PNC">PNC</option>
                        </select>
                    </div>
                    
                    <!-- 3 Columnas -->
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;height:calc(100vh - 280px)">
                        <!-- Columna ARY -->
                        <div style="background:#fff;border-radius:10px;border:2px solid #C9A227;display:flex;flex-direction:column;overflow:hidden">
                            <div style="background:linear-gradient(135deg,#C9A227,#B8963D);padding:10px 14px;color:#fff;display:flex;align-items:center;gap:10px">
                                <img src="data:image/png;base64,UklGRvwsAABXRUJQVlA4WAoAAAAgAAAAoAEAswEASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZWUDggDisAAHAPAZ0BKqEBtAE+USaPRSOiIRVp9OA4BQSzt3C48GxVr/ZIN13HdeX9yH57AjunnX/YVuQ93S84c7McXWfxF8Bb5JKE8w/jvu+PGBxF43uZVZxvcyqzje5lVm/V5f99+CDaDNIA16OnUkSk5QzbxEm/FLHjA4i8b3Mqs43tklbY/hnSEBS8oXNrJRcGMz9FDvtYi+lhHuaD5I6z0l2gChiGtQigOIvG9zKrON7mDcYYj+ibZtMPgE2x4JXojIufG05YWvpRZSy/UPeUsr5AmiwVmsSzje5lVnG9zJ9i/BVEu1dsSMFNXecSzzTF4/MzgJQhRoW1Mq1vt3GqmEgNEx+G63WnUVWcb3Mqs43uZNfL/1kqhawtoLWpmH/m2TxM0bjYgnPmkQPqazXzmlCvzpa3fS5mXg2uvwRMzDvrNMePXiMNOcvTOIvG9zKrON7Vs7JKbWjsk8xaQralWDgzbJHcYs2xtR/LcIRVWlpw1f75AI/q7MCpXTi082On4t7WUkPvQKEA7I97Eo/ljKrON7mVWcb2vEMOUYb9JFgzv18o/NX4OsB8CPUPyU9ldGuMdQicVLV6JFpOTMH2uo7VYdTASJyQficJzKrON7mVWcb2xngdrYfD0sz5alztcBCPTg5nQ0pB94y82SNkrINkLkXywRkCdvl0OGpNBAxzyLB83rw5Y8YHEXje5lVj1/+m0vdXDQg4sSqnmUZo5cTCv/+5b5Qvcf/Cr3sxJ4M1w4CLZ4uFZjKl7jxgcReN7mVWbfaQd8yCgTzi8JVrm2ssOQMNkOkf5ujK6eHpdpV+p11tMxOlR0WZEXje5lVnG9y0WiBTjROxSDDyl11tDHiW5DDwHckaJY6h1kUxlip3T/JcWc16F3Eadbm96CjJ9Rtb47MrGx6TXX9j0lQvPsRwryTIQLGD/rHrlDUvsuf4BnjgYs2H4T8yPmshQ/c8rvHfpx+AiP4NFDgjL6FwF2l0pXuZTChCwpX/BQr0WDXv5CwlowEkeqPk4lnG9zKrD5+/iXt8hQZtQgIt2m4chCD5ZPaTixp3h268LVYohCxGW//IbQtqZf6r62MI70GZe42YqbYpiBECZmyZWVOv7HpNTqwsMe///YfBLxkQz4T+f0NejejPbl9+MxFtC0ZBnb7X6CcEV02pAhOT8onBEGBwkt/2gHEOnKBG186AMFh4+ycEhIg6+ygXyjF0S3Y9ASWGAv/RjPMGDZndc5XCguFnRzD3KptNcOIL9LNEtGvNHPyEyaTdLwMCfnSkhRV3hpWVJGwwnGGbPll6KiJg7J6tDxKdSxcOfIpRwHjuC8F4XnAz7PKPSaomAZHcVPgHU0wx2mLee4/3YMzZzn9wRNfQA2JFzUGbljy9N+jufR9OIXUrlpU3H0DPR4TnlQl8LJv2nxngN/yEBRuGMyLxET5PO9LQTh0NERF41TQ5oMcfrk2odKy7EF1qa5Nv7jArY8d1ToE+O5CxrFPCH3HoxWSmNbnCBvfd+9albfq+eSeRHAGAXzZfitv08i3a2vG9xLsggN1mclwcO6A4xT3Wsyxyajqg7anhUs1OhymiWrqUejMe99111jYNubM9HuPUE2+CNQMw3rTRAb/hvzrvxZG+7NDMfSPzv4Ii8ZImDu8F6d133BeCHqMM2u1VswsClC4SEtSQ/cTn+p7o+MgX4GEv8l3NkJH/RaBG/u+ZpH9C2ZBtGo972dxHIC2al29RA3doaNCypM8bdBYuZt+v/BORw6JdzKogrAUJrrtSTbLCffRkVzHdy5wcEC6hOSHua/NZ/SEdaZGpKWr2v6ITbatUTnVonpklLY7huLc5E5G1KGjMCNKaoIdyAsLdZYceSJB1pBpyn4HKXSk6ILBd+HTx9FhiZlGAgtLIkIomwpuBBVeR7pohyj5WtpD6bPUDyHL7FcAtjBXwfw/qIF3I+AF8FBK05XgngxEJt3YCOGaTnNd8ww2pqepXkXiWYcC53qmgo2jiKb8BkGFtTFZs+s8D3lGZLYQkUbSAN3WGrkveRhA2NKv+3gEg1/Bbv6RL2alTXZoLogiqmCS1Pwvr/mHA67YvmEtAFUxyP+htWC/6dzFg3olnJlYoVe+cyAfFF0ujj863Jjf9n/HcXU5yAcZyQhkYsFYp/qpwE0WCezosksCczs4U2HF77hU1Sn7vWPXlAOnjOngo+DmKceZ0XZt7aKLwg2O87J6/DmbNLS5StEMigaKn4toUyxOWTXcTlmXJwhGLb0wgywxpi4nGC9rQuFL/lG+UpsOPn6CByx4CcU0NSHIsfTKvDvYglwr1oEOWylIRNHzTfuZM+DocX1O/EEWV9W/EvJ0HI7cwOxposqEjDaz618KnEQIGQvB0xRMB2b0b+QxN3tB9ka8uR4Gw7xzFYCuIOX5N93bnMV/+Xy7+CgItHOM4XnotDk/KhHJRsUkaH6YAEBw0kgTlsxpSKDdisPjGVlTW1dtx5Twy7Y+ff58EKXR/q7YXIGQr7GByX0Nbo4vGKFM2htazU+bTQWgNNKFPZ7rvsnH06B5Kyko6HWyIJydG1Eum6RR5p85LuNZvSyrLb8BE34Mff89TeXluFqGt0leQpY+Vv3sBsRXlWx0ySc56GXFO2WWkgjH8RCLRoqQc1+HQ6EdidPO+5KVwoqe/q0Cac7aHYl05SYcd7uMWCkrcQxmua+SfByR+ZPuSttS+8jdFsVhy9e1demin5rqve7+SNTjr9kX7WcJACdCN2xtnp6yLxYymW9dj9yZCS2RBnR6BNZQzldKVFYPIH6GxXL5ijhAxsqO+FB+CrLq8zakfWFWFmkFWZZzVMGOnD50HbxR4DpZjbJ+VGiGdnp7qFjB92qOnyS0ojK3cfygbV4dHR6Jak/26DtGRz6zRM9BnV3DIA6PDlZYZdjuA34AQAP7/m+gAAAAAI7k0+8ualG7Ur2EzL8zJvdU6D9qqh8rzjZ9Nmmsy0p9yVL28SKJ17/txbmlFjl5xUbf4mL6jEVoqmzXZmED5VcQqvYb5/yVMAOcBlemBG4zQ0NJBBe/n6BNIIqUkZiXKQ+SHTEV7Kd7GoE1YVoEFirGAIFwrGfnd/dkqbgVMs5ODtcWSLG4wcK7c8AACXZo3fmUsrwvC+JjqseJk2Bc3//Zt1abkz4bhjCLWvAT1jUJaF9+PrCfNup6yCbRT6vi96kKXbaoqATSZ88s8XbOBo4s9Nkt24p3C3hhVVf3sCLHQ838ZLaMSF2eVN8EtndnRP+IWcAqt489jsGrNAbCb/uPp/CzzSsmcM8ICCfQ4Lfs+9AG9opqX+OtyqU/5EIYsKtv4Ick/hchQxZzgQJtIRouz8Myh4N1wVhvRfgNCV23oYDlViU6iAACklJercwPzb8kdnlD6WuJPqxDL0LI2sDkXgRkRZSQvswXFgB9cyjtJ0QyBA2rO7X5Hz2DCWENsKBaLMDguw2DLsf7HucYKMgLy8jVDSQ617QEi0m7UCCSdcwKWXdQb2dXBgbL2/lTAevHhSQqFIw3iJi2Sde5jgfb2xkhWB+h64LsP27+8WuqyI1lgjFCLmdT684BKuRAqHdzR6+CK07v07Gx2+viTHzDYkAAAk2rOq21F+1tdxntoSFzTEWnih/SQoqmshVADasq7fQ1V4qM/nzxdGtRv1Ljg7tiqCZMSxuIhREGQngWSUpZgF3VuWfmeynolWyBiu0C4+NWK84Uh0xahbaT5LPJaBQrDYITogKScixx4wEQaeNLhdQgODfXPr47lTL7YGpbS7MDrhBSenxS2XoF290/ZwU1+RVvgnpBraiP4TJ9AbMMupSrGKSs1O00aZja5FuT+eUBkeU7CehxCbw9u/LC2dFXJOBpA4AARONZk/hnzYKCSnuYPJ4cUMJwGOD28xyz2wijtWJhuM1jRmY9NBQrFu1PSWNoR7NvVLSp37cRAKlCqxXUNij1y6602GTQ4CAHciZAKuNJcbHbc9nRKQ2AeJSLmkH9QhoKp83H94wSzDsaXXvO2GqrE3J753kr38tzwfHteJbM3+qrM357kPymB5cQvgWlxSnRGyqDLYlkfwLGZyvjwBqwZ6QtsUfuKsZDYEGDaFaOVRFFra5BjG7GWOomPWNuex/VTYio9k0eov38Vd+sgNpMgwWSQ0LF3GCMk5T+3NSNr1t6iFwZCdKP45WvVtLGEjWXgb7tXHxU8Bg+CCPKHA3ghFNAaW/x0ltl8N0sngdj6z/R4o5M/bCOun2OVNcMRYGLoHRxEXKVamJTQC3sdyO/0yYJx5xYDG2gaOoODr55eJRLuhgqDrhrG9jbJYroJ4tpbR8UO6nIcNCyk6csQMK853z8jjeK6h+nTHvBmBa1j0t2pQWvadVk5EDTf9+Bu9zAEAerGvvl7x2aagidCBUMuoD5aXkGB5076hlW/HLQAALDpinbxDkOs3ov26mF6B7GblKSQEvjzLZWKQbe74L5XScT85+K7pySc/oUvUFCux0oF+c6Y6fJBrdQT2VCpjWfmfy2asicdEUbiEDatwzM/qXdLk5fpN0+roaw72zixXlozh7MxYCz0G+MOosIjTRof72/TR9hqvfnJWodI4gFE/8ILaR4DXjRvCsTmx8HWch98Wh3uxgzwZB0LAK1BBoTv1RfUEY61jKZuv+5OI24P3AdVa63Zxl7llVjDiS70qe1SrN3Y6H9xisx5UyHg9eP1CZ4Cse8q2CglaSdDyZdNImseUBLzMNiLAhPnkzhKauJPRWtQ62GhTjeBwxCKaOguW8/tL2H/tvGiDHnH0ppafRVdnDuoil8L7EPEeXOT/3pJPUibE2aD/AChT2nfByLP0yHBmI7VC+BTQd088AMxz+Da6/SP4La8j4RehdwUwH9PfBZksO0/mpMmhSd7IcAorMhjTGAmvcPbRUqHdabci0vtx2i2M2h8lgGAAW7/EUKHqskzxTr/xXzzfbC/BiUvnXI8oX4/nZGqfBefVInY5a45+UKCzZcfkWAE2PwU1xqU1S6ca/lpd0yIgrp4WZYMeI03TDzNS70R1CaKuFrM85YL1moBrL3bpVNqkQwpy+Mo2NwAIYBhcnIBiVC/SMnYXvRst4iCaHyFGMGB8f80+8joqU5mHmMfkKArOhaidaBHJ4eukILJQ/IHLx+ZLVzRuhssnb9jx0S2kalUj5udc2stN//bPavOBy9oyHKfKiSDFZfiI/depE96tFS62TQEbLNXz9T+xqfSGzwBBEfltaDcgtKE/JUwrLGlpQybi/gJHYfG+/jBrKr6D4u5mJvtZ/RVBP+mL4bvTwxMrgNnbctBlOXp33mr2oPWQ8iTkFQ0Tea8Ufn0W8tkh/t0TNBeb9cshacPuyi/vaFgh1dG38E7UwWF81arr0NDD+BnZi804MCamEgACyG9Qr+DVY6RsDDvM5en3w+tZn0k+6x65U7GOecKmQHGHmyN9KirShF/+yH8VLCGc9BqwtLc8lIjElr25ry4+PKcTuLQ9ter/n6Ly9qc8cJsG+PuLemio/mNXmrE3zM9oyTteiF4aQDXEja5VM4H3ogp9xpQqtZNf+CCz3gJ5yYOM9Y7eBFtBKqftpJsdwVmY/sNQkZHuzYrHiEFShIdWuNWhcZ0yHJUPd6eIDSntMZEx7phSTrdqW3CiUGykGR6wd4HxFY0SoS3Aw4MnfMAk7QxpKz08s0gforLLSuhugv3ttnqnH6QGQTVzsAAUpAJUdMYLgkVRMuYkLOij5nxCf52e2tfpQBH0GCf9+5qMZyrX850ZphjBgP3LNgZsE/G4MjcP1yMlUmcR67yYS6/k8xPi/aUapOTDN13RgxX7GstZA8mk5ib9Jbj1HnqZro2phw6C0IVVghwFyXhb7jvYW4Kk8wV3R9aJWQiYfs7L7WizGx5tLRDU1rvUzNAst+nf4erZkR2E9TIMzeGjjUXNi5gtJ6Gu4jISKq4kli9EekH2sL2SW3TiQ5p+fnIFveeYuppXIYs32CF2VwrQuBclPF/2B5N8ATaU8lAAAj9CNLhYAV6EfbPDkP+NbANR5Va0Rm+JRTtnJQ7EQkjeqG+Ubhfj/OBKiq5LjCcmvWTN0ACbS7U6ruga8HDuAp1lxN9WfAomF7Dgm+b3ZGZryQHWkUIs8NDg7hWNXFwfqFXm5cJ9afSAjUSthX7KvBUK+tm9qwiapJ3xOeR4ewHwhVy3CzWJYXD4V/+8pkzWeM5s/+Y7tjIekbfrt/Bj5F7AtnPqPCQbdsIVY8WTxBQZOw4WoDDoGhfgFkoREC2b6Y7BB8QmPwAAALU827BUMKbKUSRCtWebEtjtt/fK9raZZdv+gbbs2+iqaihQvEUfbEzsXSusWTvP/Wg6CTmEM89vf1/0I6edYdsxnatKGwfDDKsrMXVR5l4TBg/jE+M3vVo2jr4ZBMV/CCqz0wwj85NLQSz15FwTvgJ07EaCF/BP/gDmlVGyuCIO0Q/+RANnUf4YXUxeom9sCiSIDB0juZ5TpmMwWQ9UnSLvtmLIW/48cjXSVClcwQy7LgkCNpX+JeU5nELfOIjkz8d9sU1MT8VlTxmusgHKMKot425uufT2UNGqyroNpAvQg85agQRMUy5E9LMlZjcJ8G3q4eHxmef3qSnjhTDwO+MzE9z+F/6Vd54IeC1FjVfsHlpM0AAXq8wkd8JjQTez7wB34t8OYU7tsIksvLsgAU4rPSZOhLQZaE2+wcqtoxUrkqmDcKMCRUS0dg1EklhlNzEpaCqFfYHfm+Ez8knVjm4tDd+mPQzovGAsWVi7diYXW//+IeMAx956+aC13MHZqnWailhY1KECnw4NPx8b4QESuaqgKNpof7kAn1IzN9hP80RMGjw1LK/M59YRhhNcgp6HyGwD4DKCxBNaZdoZzwRdhJXiMx8g8z3HhUEuRRYUKxqqXjF319DZa2QZ8WlpT6ImshBjJ8T38MWYlFHb1twJQ5+gkNKI7A7mrjYy+AfwU0WN6yxT3vVoMpjzjiT/K3pGsY4wRmpYDyFOW4gpql8zcXI418G6gppa9Gx6Py/g4tFd6mecYbcBwDUIqsSAyrvkxrGoFwz2+TXbp13DI19+tCn1F5ABm5reS67s6V2zzZk7b6z5mktXi37xBBkav4M6htMz4h122qW353PXAZAk16VlpYasCDhJmbXt5jmSTXx0s0SIRD/jMrqcJOa9acHfqAD30TG5uHLYRxqFdLlG9LTmN9cJ9l6FMxybFkEdb6hCB6HZsVjILrPWoVjuyg5cvfePbfEw57IlcG5EewvyiojmY35s+AoAqiSrTjbqb+saSxLN0s02ZmbNrEc79k57cO/Q1QhQBQFl0pSzAgNG8xK70u1UYM4M8M5hR6qM4Ae3Urq7bsTN8OSQV+lk++A/6SxiT9jnXBu6vTLXE9mpMIuImmDs7/ji7spsd9rMvqnY0W5jRPHzNe/Cnl1rnWu5byAhOBcto0T3w6gFPg7AMoYwInilkKgo1ULZuX+bSnscKietri/IcDyCi6G4sYNJ4cZQNRo3GSznLE6GEACpj9Xv3zc2g6kaAdAx20VRsv2Xr+EuHILnw8vIHxt0Ff2DPeFqDfaF0DnYyxi+eVR9WmB6g+Hnmeczi7nU57uoOmcP5Po+UDx+VlYcOvIVi/TpN9RTfXv8hebfSZZPu1bab3Zk3ugraPdXT57bReWqu4Xwuu97k24e4q15PoBXarZVnUnq+8abnKdZ6OK1bKmdYsYR67/huNKgPTxImdPLw9+ZNcqgBv6cVQydxjpEhvUg9AR5AFi/GAscOpxWfInVC5inFxvYAkmJ8/csjFfjXRPAfFbppz7XKRIqOjUgqzXqW+PN+Mh5Ai8lesu0Nx2KgQNC6BQh/Nmts49aReN1VbaqJWlygUx3M48A0sJ3dnvBJVjMqd++TDwbqBbdi31Q3w8PwmwZgUs5KLVt+eo0mYxPu0tNj8V4as/J3DIk0XoxolejctbNgI/LDA2MMbNPvsUR7hAq0F5Y/4PIGP701+0iGum3YEoH1Dg/Lr3VZkBJKcsQ1EPUofx/F0azOfbfko561m9ILSlJYtedEejeRi5YcNx0PIAGnPyw6BcLj+zXrdCFlIecybvSAkQDsXfl1i/eLExIYfjFyW3mrgCXUjGFKEhHaf8/gSFaxzj76C1hZKemNfiCyCFCA8DoSvpsij52Jr9pmdzpIp8RTK52IQnFzojWhwuvMZWKHTyjNupEDjDW8hMZ5qOQEMryoLmotATmCdUZOA+PQRtsCcJ97W4AoxuVouX2yujVyyevFla/r3DaMI82cIqSw0ioQp0RUEpmWSusMWs6naxwC6gI9hhwSSWfQMFSKoOqmuaqV1kM/aT4lTkTqjSIyopWI/Nm8msrUqL1XSWEiqaOtQG0aHM2Bqmv5cPLluu7Ck5cnDc0VQY2W6KRmTzgU91vCbHeoWOZOcrIiCB6Qsf3BzgOxbKGEj8L/rYW9WoNBPAg0D/0eRmU+P4TkOSy/tHEJKmCOyfJVB3879YryA5p/7kcyZBB7/qvSJmdXcFyy+UoTTJextocMyfGsAn9er0wrYjzQ+9525eOVwcnLkKPE1qBkJ0I3E1CLY3oU6ZnYNuwx+9YHLbMlKYT+MdJXH0sR2MdYs3Rw1ycpgiFUfexJiQ68UzILDnnOIhJQJYU6aq0PD2c1s2UByqIuO2oZIFhFN6K8z759dNg7XOcZ/YA8le0TiBZwQ46567hyEGFsTMOB2Nm3u7OQ9zxLfqUJW1iuxa93wuf800k33tKWNxg6Ln8cL5+YNo4s7rGuqHR0QfeO17Y9wXMH+gVg8oR4lKbAYXjaq6M9OhpsR0ANk/ua4UHhZ+uJUAQsyDbQ65qPlavF/dZpHbJXRysiJduewhEA9U2A4Dd5GXCz0eAR4tBuHLCL2x80Ltl6QwZaiX2PXpd99mXFzPOJWFHCfWd35uY2LLo5n08ni+VM8Z+7j4RERMD6PHWHinjsSsm0W97mOLgvDC/iEiEx7G7l+/AQ5tMaPm+EAHyGzDiMjxxLdLxa1s8R9Ji7p369+0qYW2pPc3y3fHL3aO785R5psg10KBPW4GkxDh5F8CUEC401M8g8S3pDpdxbd4ayEsxe9T3WwK6K5zxAiSlVkPBB9FgQqjs27ES28Ydobcq8mjkSm3n6skplbobFy0cD0y7mEhbJGXdujBdM7FEBRXP8x31LiS1FwHZteT/u39genvX+HJrS5ncdEXhQCAY3jxobvAlGMgZ7sylV2K0KZV1ROrHToTBRrimkX+2FXDZ3SN+dnnK0OcePEnutmkNuAYLWIyES9GBtJnyY5nKYpB2YHRSGZQAWcNgSVAmELE/jZdTlkrEVGYu8fNYWwu7UaiQSh01xwGXIdIv0BigKAghk2KwPKqwH3WYCNIwvbVNrkJy6wAKO25f8NOq+2aG8av/iPC+pCdfocgdT646HGTiGndHncof9gER+QYrL2Ap660bQJmkQKcdkdOGYFN/H1aMsAs5TtDI9nIhNlNtXCxnOBOJR7yXOkQWYElB8lVLq8XhPoIDbRCn2AlXfd37Im1iN+kvK+2HDgqn8qO7kJTGUzDC15lsY7bb/EI35oyGNMSesFu8rtuuQv71EC4ETsjjQEJqk8fREXkFL8r3LtCbfji85lwxleMRENaIRIxr3yF5AlKiAsF2yuaeCZoX/9MoP7a78qByddPBLPF+MriOvO8BuygSyIRpUiZfzQy5S5nJV4OvRd6x4KvJmsrD00OShqUdl1tx70Hkby/kt017tnbWJr6cbJ6JmKUxr4WHhkvvurTfjKN9x0YlfIONW7ZgIdtu3g4zeH6tySHEHVTjgBRmwlMGipYTpkHEgfoss7Ojzu0BxdPKj9DGuJdnPzkeoZbOMOzsdHvUB4q+IRPgIoSFlpHTUMJYSoPF3y9iYiz9GCSF+Vk7G+LcHhfFefsmJyTrpeWRBrKV7I67ofwonR3fBGxz0HvIwSf0PMbJ1oipgSsp8O7i7cxIiy6ftsQoVoD7oy4oYIVX/xYv4tbq01I1IuE4mZL+6XkXsaI0xwoahEZ0VWuayaywJuQ4VgNYPFved2CGqFhxx73bBSV4VQHSnG2bwypeGnKr0+2uyE/VqsSbULpWnXYYNQL+4n99IU928D5N+vWnN5nxYnonAsoVqLc/Ya01L32yWiE7366s8JJLJeooHOvsPBl5hqQZ1dQngC0Z9q93wDbCYp7GAOxaFruyDP/Gbizi+bkEJGZBdR5PHq8rDVV+S0zbOlUPbyQ3DgV1uJGwQ1eSG+9LC7GfRcqZ+8N/NoGMALKyfL/CZiE9pSmRS15ykfLVdJriHBwnz94ZwuAOggt9nDm+KNW5wI2Zg2gLwnUu96oK9ua8p4xeK/0lEkV1+p3UkYzBLZsVGDV6i3g6ZyUl4TdffzsAs/LCn2WMlJureqUhRI6bSLe0piOHhG1nxyB6XpUTBAamloxALScJQonYKVSTQU2RbblZr8cz+5UwENR7EyL8crzy2IoTZI8t3kTfvSNF2gYrgt7ZeDZpfofvOxo1yVat1/Mch5Iu9ZaeuUA8MXLGnfL6hLAA7rHYjdt6FVA2AujDgeoGJD/151rtMl6Nn4KxX/y71OotsaK9/lc4AlYlEiNamZnKCbBOlSMwRxPH3ylXO+coPxVy2oHKJzEKlZfqixtCXRtRGk3SAtb0/FnRrPWSzY4uUoCWeus9ZqeAWqRu9M9blPcwU3TE5fXx81yVUVHutYLYDdkJzMBUMK6hZyF82gjq11XkpgzSBteb9sP10bX7Se0K7dB7UI1v+UGcJ/pN0+hBFhOlUTeTdzLR7KyczkVcmSVvPZejVpZD5MSJXhaC350BpqnnBO7Tigd0W6j1hFCcnmi8uzfs7TpKfyWTlaR+Kpcb1fwFA6h8YGDztkANGAWJzlQAU6OMZq2C1qxy6kq7ym2bEMptsME53xDfz96wutUUuGowcnAFqhW4PQtMrhxPPokDE7+QPerf+Zs3CED4g5g7pYzEKiniMO6GIfooHhVpd4gDqL4ItwBaPDHtGLZlT5ZbpGSDCLA5fTxlBLgnRH2WuLk5oLAQoOlC597s8gpNklM5C8mYHJq3PdKY2CSnz3H9yeMopL1GTqvBMt3yGgKNpHoJ7K2gYwuSjNT36flZFmTn6Hbwl36DE1NF6q+OBcS2CrwLg5pNLNdY1jhZPtXcUKlJJn8HEy2XCnLfxhwqgf4QTEChGXzTgtTCEg/+mqhMuDSrjL0iLHPESh80JUf3tMBaa2UKWpsoK61dR3+u58TS7R4IWd10PaVafiAmY66E1MxbMjrZoMR0zigrylav7Sh11njlJoVPIkgC3/wq9Tpyn9NvUJWUexwqtFPaoniFORWXeZNp9UT7YJhIWy8dtpjxYnhgC4k3s7ehk5p03Ztsxon+cUnXvcH+3rdiuF39w2Uw4xD5UQ4AolW4wxc1RKKEBAXGrdScR1q2I430LPJ3GmubhPAl1yDxmETCP2DywLZwjPXC6PSlrJp+Li8Fdtr9jA2IgC38DBLMcEX492BjD0f9TO8yoywlTP7qS61TDPOzcaucsbtARD5jKzNiL1MDTAFCu7b1YgdP5c9OMOWoedL5Cf8aF2e4zqsnug8ZmKPFx31sy40+wv5/OQQ82fp366BcEk/uh8iRHDtljzjdqntNjztB6kFeQulmmFkg+c8+vMccdq1EPiULwmjA4Kgjs2gPPuE1bQQTWs76+ydaYuSZoU/OAOathvcKz8mfdAidPu3Fv2X+X2rfeM0Z20WKOFp4NVBLfSeKuQl/Ne+T7Y727qYxQmIW8iaOewxGAtje9P9bNwx6MiV6M6hcC5gQS8DdaGHuDgqI/dHiUH0a0JgqzA75cPXTp0vw3w9WybxYc75edkMnt1+NqgPpgRvWZWDsiglpkZ8D9kDmGLUbWMi2HSKsG8H9Pn3XG2M9s3H11ofDU/K/hMuypGYd6F3ybs0HeEe3Vb0iinTC5SG9cfPDaM9FynrvAS3H7vF4ESBbsUnwdY5hAR6HMLvIQL0FU6NPRJCa+/1qll9PniK9v8T1u0NgJILwDfSF+MsH/TSXsaRwhOpjp/SAufP/etYFDSLDrtbBQWYuqvNHg+ze+WwaTEPoRorBjitmWgQt2lDyHAlbzpvykV38OqtFDIzSZ3DF6dMeXDnRocSTYdfgYilaUghx2kfTb89yhf9cuOL9ZWktMBNe5IilL5W1Cz1K13V7mTYUgEJc5r2cWn3K+a+jJ7aTO/Qsi43sTDzO0KdUe7faslG2PkbGMmSQ9U3u33Xef8Z0V3ATvh33ZX+H91MxDVgUXYtSZ1xZNbfuiny+EV7sbqBi0mFTgkz+6C7ObBDYtbDR2X0fFMLDJDQi/tC2kaYvV/ANVN2js+liUqTh5tV4e22OgtdIhlZmErOLMskp1fU3WVKoBr2OOt866jEpdOIDaI/7RjW7xW1XERjgnpDPq06sqeCFBb9jQ1DpOKgiZvtlrWDoXJNKDAkhx5UOhzg0OD4iOvVzj0JZt5QaW6lE4+04p72EMJwntbyVXYH2gSQWBujz5PLgbvMDGiYEfh6wg1/PJKZ4jh6/yT7eHFOpyFf9zBHpvdkw7F4Dgd5kA44cv+hHbU+ZF4pd9fePrxXp8f1RKsXupxlpGcgjrebjs+ddjcJWrWstPqxCP5TDRAW4lxB858i8Jlw8No0zokqCQuv4pXKdAGsTx2MXvaJFDL+5+eJl0o73tWk/dbWSmFSSaZ8oBgk9dwXoN4cd/tVkuKtaPODermL0XSovzfelNrBZg9w6UYeXUCKTwUjdwsPv9Y1o0PWPE+Guu50alNk2HDPx1H6gTZLmfe1T2fELLTUP6Ck7MgJZQiLpx1am5PjGhvwe8fX5TUYEBhCG96TdhItSB7F921AKrbTNIS0QKqkQO/vLRC3YW8OX5/57atPmWqpzkBMV1fb2FvU3ZgN7TVNyZ4a6GF5feLWb4M0WAc2dwY/7+bK3HfN/ewVgswUkiDT1tyeou1LOObkNSd4UWhfGMDnwqp676NIJ9gV2dF1LuVFri7DEicOUdmUUU/EgIhG5rYuBZx+pXS6NWU2Mslo6Adp6HJRRS2+kMkl5eYVcpBexp6dFJpJOcCOihoMBPnnshFvnSzLJ5Q15G6bBSQjcZV8Hs7LxWdlGP52yU/wpBwwkiZwO83E+p4s+yY9yKJeReH6f6NwF9jm8iKsZpK9Ov4A2ZBLa7LXnXy43lJTd3KpQOpDvIMpGwYnYbGC8mHnf/D4ubuHrDvMDeonovOJ+JC++lh5c62E9J6tRj4wMb7jssII3hqXy987zWp9jcJCFp6GNMKeuSH07YVxeeYQg1qx7amYOUlnQuOoSPKOfdJNxWMbuLFWYvNX/UuTm4+varISehRFKidGU2JAvFWou35JBO3+GQL/zobwkffsEziqmIkaVlr83+74yTfNj7e2oTtjtxnLPgrmbBmvcdUWprOzBnhK0uXv0reElAjSNxlpDumVsQ5XkM4aR4kDTF/hp3b0J4jH9vndU0fSY/eJr84mbjWEoh/8RGLrpJasXCvXNM/HLh71xIwoUAuTG6pCSuR7UJdckcAK8fKcQCP0y5WiQVA9xGxR+sHYlu2HCfqLj8yOSNwWgCXxEnEBueegkoetDr5zA6mfsdpIGZ8LcfYWgH71/YfeGLvOLD8HY4FSGoP0dGalMvYVwqawQwdYr2OavL1VFTNgqL3QfU7KXSLbwNYPWtNi+pMhacBw5Q/S6VLStxmLiZ3zljXMS23h8u2tvkKMSo4nnlxBteQ2xYFEwMXdRnqVosKXCg4qFPzDof4S4gJ9XCMn8SJkiyWqt3RQnaYkmThrPMhOrWVX+eNDTwYMsQe6A0HR1dP7G2GdNZZvSuEDW/fM+FezK/b0GOUW0rOXNaEwYfLdfrd7zSZM+Bjk9WKZPwtd92FonfCrZre2voZfD5uHKGDV4lhwiXj1TfJQfaQd+uqjFMsC17cGGIswxC6OGQCO4V/wzaIhNGfvl5bu0nqAfOEOzekRMbkf8Qc5ubcTQYSKESthKcaJ5LpMLX/AOvS0k93lcGYHhmzMo5MIgqD1abNwgeJP2dJxekM2O4UUgxU5cqZBChmkeZFhy3+oJpAVeoPZq3ZNOlxOd3Bw3qzDf8TMdNa2ReCDa6GslFjZN4tUGTO6MrNt14f92KF+S4/gLgQ6E79soyYW2hF2LBWPfrfstj1wYwsDE79bqTGbUKwiYlIC9TuE6oFY4PiUtFCY2uWam68xUyxP4SAF/E/+OqYssAwAUKju9N1oZ5Q0fvxIyATMfWCgJSEhKJc+77ZNeTYVius1HE7kNx9vI40EH/rl6f9MXr0XE0DH/MxX8THLv8wKK+JSyzZcIjuWpDS2S1FUokrZ5aKUjcq/MHOdf+qbi8BPbFCKAskijrJMcfB48YwPBB2wtsuvUhXtDpZjuW8Uv1b/4Px0JGEiyEUKKnASMpD0bXfnvtRzZai5CrLOBRoa+sofQf9OYCWgyyi+j/w9CsMNrX2oCUSOIlFmNirUJtRdMgDtA1lzesVREII04k+5POWmRdPS0+i7jVyrQM5ScpvFfQG+A4oKed715ABD0q2BMok5gzAAmFbqJoz0SxiKuthaViRE1VFwEeuTtzzGxXlV6r0ZzZPyB9LM/3+AGgKh+gLlvnMKkjBH+HzQcGHKAQhTrrC6sI+VViBJ+XjHK3DcMFXds4kP1CYW58AHWNRmk6l009M4AAAAAA==" style="width:45px;height:45px;border-radius:50%;object-fit:cover;border:2px solid #fff">
                                <div style="flex:1">
                                    <div style="font-size:12px;font-weight:700">ARIANNYS ROJAS</div>
                                    <div style="font-size:10px;opacity:0.9" id="countARY">106 centros <span style="font-size:8px;opacity:0.8">(9 AAR · 8 Excl)</span></div>
                                </div>
                                <button onclick="abrirModalNuevoCentro('ARY')" style="background:#fff;color:#C9A227;border:none;padding:4px 8px;border-radius:4px;font-size:10px;font-weight:700;cursor:pointer">+ Añadir</button>
                            </div>
                            <div id="listaARY" style="flex:1;overflow-y:auto;padding:8px"><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AZE</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AZE')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AZE')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ZARAGOZA Tenor Fleta<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">GRIMA Raul</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYN</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYN')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYN')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ZARAGOZA SOBRARBE<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">LAGUNA Teresa</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">Aznalfarache</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('Aznalfarache')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('Aznalfarache')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ZARAGOZA CARREFOUR CC ACTUR<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #8b5cf6;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ZDE</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ZDE')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ZDE')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ZARAGOZA CALLE DELICIAS<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#8b5cf6;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">Exclusivo</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ZST</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ZST')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ZST')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ZARAGOZA C/Santa Teresa<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ZAI</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ZAI')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ZAI')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ZARAGOZA ALFONSO I<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ZAU</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ZAU')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ZAU')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ZARAGOZA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ARM</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ARM')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ARM')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ZAMORA Santa Clara<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">LOPEZ Mª Angeles</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXO</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXO')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXO')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VIVEIRO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">XISELA LEAL</div>
            <div style="color:#888;font-size:8px">Daniel Chazo</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AZG</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AZG')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AZG')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VITORIA C/FUEROS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">François BERGUGNANT</div>
            <div style="color:#888;font-size:8px">Sonia Godino</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYP</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYP')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYP')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VILLAVERDE<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">DIAZ Angel</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AHR</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AHR')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AHR')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VILAGARCIA DE AUROSA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">FRAGUELA Jacobo</div>
            <div style="color:#888;font-size:8px">Verónica Alfonsín</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXU</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXU')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXU')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VALLECAS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BALAGUER Jaime</div>
            <div style="color:#888;font-size:8px">Laura RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AUV</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AUV')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AUV')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VALLADOLID Paseo Zorrilla<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">URRUTIA Esteban</div>
            <div style="color:#888;font-size:8px">Daniel Chazo</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ADU</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ADU')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ADU')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VALDEMORO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">VILLASEÑOR Juan Angel</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ADC</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ADC')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ADC')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">URBIETA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">ALBA Javier</div>
            <div style="color:#888;font-size:8px">SONIA GODINO</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AZB</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AZB')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AZB')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TRES CANTOS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">LOPEZ LORENA</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #8b5cf6;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4TOL</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4TOL')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4TOL')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TORRELAVEGA CARREFOUR<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#8b5cf6;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">Exclusivo</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Sergio Perán</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ADQ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ADQ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ADQ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TORREJÓN DE ARDOZ<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MUÑOZ Pedro</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AWL</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AWL')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AWL')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TORREJON CC PARQUE CORREDOR<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">JIMENEZ Juan Luis</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AZI</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AZI')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AZI')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TOLOSA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">VARGAS Javier David</div>
            <div style="color:#888;font-size:8px">Sonia Godino</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AZA</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AZA')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AZA')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TERUEL<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MALDONADO Elena</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4TAF</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4TAF')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4TAF')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TALAVERA CC LOS ALFARES<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4SGO</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4SGO')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4SGO')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SORIA CC LAS CAMARETAS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYB</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYB')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYB')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SESTAO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MARCOS Irene</div>
            <div style="color:#888;font-size:8px">SONIA GODINO</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #8b5cf6;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXF</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXF')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXF')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SANTIAGO DE COMPOSTELA<span style="background:#8b5cf6;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">Exclusivo</span></div>
            <div style="color:#666;font-size:9px">URRUTIA Esteban</div>
            <div style="color:#888;font-size:8px">Daniel Chazo</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #8b5cf6;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4PEC</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4PEC')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4PEC')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">Santander CC Peñacastillo<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#8b5cf6;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">Exclusivo</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Sergio Perán</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AQV</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AQV')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AQV')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SAN SEBASTIAN DE LOS REYES CC<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">RUIZ Alberto</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYK</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYK')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYK')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SAN SEBASTIAN DE LOS REYES<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">RUIZ Alberto</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AFY</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AFY')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AFY')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SAN FERNANDO DE HENARES<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MUÑOZ Pedro</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4SAG</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4SAG')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4SAG')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SALAMANCA CARREFOUR<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Sergio Perán</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4STO</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4STO')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4STO')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SALAMANCA C/TORO<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Sergio Perán</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #8b5cf6;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4MRM</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4MRM')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4MRM')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">REINA DE MERCEDES<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#8b5cf6;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">Exclusivo</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Sergio Perán</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4TRS</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4TRS')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4TRS')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">RECONQUISTA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ATV</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ATV')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ATV')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">PLASENCIA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">GONZALEZ Cristina</div>
            <div style="color:#888;font-size:8px">Laura Ramos</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AGF</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AGF')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AGF')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">PARLA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MUÑOZ Pedro</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AWQ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AWQ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AWQ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">PAMPLONA CARLOS III<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MAZA Oriol</div>
            <div style="color:#888;font-size:8px">Sonia Godino</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AFH</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AFH')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AFH')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">PAMPLONA SANCHO EL MAYOR<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MAZA Oriol</div>
            <div style="color:#888;font-size:8px">Sonia Godino</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #8b5cf6;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ABB</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ABB')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ABB')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">PAMPLONA C. EXCLUSIVO<span style="background:#8b5cf6;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">Exclusivo</span></div>
            <div style="color:#666;font-size:9px">MAZA Oriol</div>
            <div style="color:#888;font-size:8px">Sonia Godino</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AUE</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AUE')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AUE')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">OVIEDO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MARTINEZ Alfredo</div>
            <div style="color:#888;font-size:8px">Verónica Alfonsín</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ARN</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ARN')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ARN')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">NAVALMORAL<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">OLIVER Javier</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXL</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXL')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXL')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MOSTOLES DOS MAYO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">Victor ORTIZ</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYU</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYU')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYU')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MORATALAZ<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">ERUSTES Maria</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ALJ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ALJ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ALJ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MONTIJO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">CUERPO Valentín</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AWA</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AWA')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AWA')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MELIDE<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MOSQUERA Marta</div>
            <div style="color:#888;font-size:8px">Verónica Alfonsín</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AOC</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AOC')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AOC')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MEDINA DEL CAMPO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">DE LA VEGA Laura</div>
            <div style="color:#888;font-size:8px">Daniel Chazo</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AFI</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AFI')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AFI')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MARIN<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">TOURIÑO Miguel</div>
            <div style="color:#888;font-size:8px">Verónica Alfonsín</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4OGS</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4OGS')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4OGS')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MADRID ORTEGA Y GASSET<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Sergio Perán</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4MNA</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4MNA')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4MNA')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MADRID NARVÁEZ<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Sergio Perán</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AQI</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AQI')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AQI')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MADRID LOPEZ DE HOYOS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BERRIO Israel</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AZL</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AZL')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AZL')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MADRID GUINDALERA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">JIMENEZ Maria Angeles</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYF</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYF')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYF')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MADRID FRANCOS RODRIGUEZ<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">ANTONA Ángela</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4MLV</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4MLV')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4MLV')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MADRID CC LA VAGUADA<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Sergio Perán</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYV</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYV')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYV')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MADRID PRINCIPE DE VERGARA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">WALID BOUHADOU</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXH</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXH')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXH')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MADRID DELICIAS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BERRIO Israel</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ALY</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ALY')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ALY')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MADRID AYACUCHO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MARTÍN Laura</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AQJ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AQJ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AQJ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MADRID ACACIAS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BERRIO Israel</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AWF</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AWF')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AWF')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">LUGO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">URRUTIA Esteban</div>
            <div style="color:#888;font-size:8px">Daniel Chazo</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AWG</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AWG')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AWG')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">LUGO SANTO DOMINGO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">URRUTIA Esteban</div>
            <div style="color:#888;font-size:8px">Daniel Chazo</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AVU</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AVU')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AVU')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">LOGROÑO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">GOMEZ ORTIZ Lorena</div>
            <div style="color:#888;font-size:8px">SONIA GODINO</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ANE</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ANE')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ANE')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">LEGANES<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MARTINEZ LÓPEZ Raúl</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXY</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXY')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXY')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">LAIN CALVO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">LUNA Ester</div>
            <div style="color:#888;font-size:8px">Sonia Godino</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ARZ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ARZ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ARZ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">LA CORUÑA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">LEMA Pablo</div>
            <div style="color:#888;font-size:8px">Daniel Chazo</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AUX</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AUX')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AUX')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">HUESCA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">LOPEZ Silvia</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AKU</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AKU')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AKU')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">GUADALAJARA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">SANTOS Beatriz</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AKB</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AKB')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AKB')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">GIJÓN<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MARTINEZ Alfredo</div>
            <div style="color:#888;font-size:8px">Verónica Alfonsín</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4APH</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4APH')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4APH')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">GETXO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MARCOS Irene</div>
            <div style="color:#888;font-size:8px">SONIA GODINO</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AZD</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AZD')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AZD')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">GETAFE<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BLANCO Ángela</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYD</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYD')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYD')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">GENERAL RICARDOS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BLANCO Ángela</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AZS</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AZS')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AZS')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">FUENLABRADA<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">DIAZ Angel</div>
            <div style="color:#888;font-size:8px">Laura Ramos</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4MCF</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4MCF')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4MCF')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">FUENCARRAL<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Sergio Perán</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AMD</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AMD')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AMD')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">FERROL<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">FRAGUELA Jacobo</div>
            <div style="color:#888;font-size:8px">Daniel Chazo</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AZQ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AZQ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AZQ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ELGOIBAR<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">Iñigo</div>
            <div style="color:#888;font-size:8px">SONIA GODINO</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AVC</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AVC')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AVC')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">DONOSTI GROS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">ALVAREZ JOSUNE</div>
            <div style="color:#888;font-size:8px">Sonia Godino</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #8b5cf6;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AZT</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AZT')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AZT')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CC Plaza de la Estación<span style="background:#8b5cf6;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">Exclusivo</span></div>
            <div style="color:#666;font-size:9px">DIAZ Angel</div>
            <div style="color:#888;font-size:8px">laura Ramos</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #8b5cf6;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AKI</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AKI')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AKI')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CC LOS VALLES<span style="background:#8b5cf6;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">Exclusivo</span></div>
            <div style="color:#666;font-size:9px">PIEDRAFITA Rocio</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4MCI</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4MCI')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4MCI')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CC CIUDAD DE LA IMAGEN<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4EAL</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4EAL')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4EAL')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CC ALISAL<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Sergio Perán</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AQZ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AQZ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AQZ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CC ALCALÁ DE HENARES<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">VENTURA Vanesa</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXC</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXC')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXC')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CASTRO URDIALES<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">RAMÍREZ Ruben</div>
            <div style="color:#888;font-size:8px">Sonia Godino</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AVN</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AVN')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AVN')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CASTELAO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">FRAGUELA Jacobo</div>
            <div style="color:#888;font-size:8px">Verónica Alfonsín</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4CCC</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4CCC')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4CCC')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CACERES<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Maribel Amezcua</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4SCB</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4SCB')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4SCB')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">C/BURGOS SANTANDER<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Sergio Perán</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AIR</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AIR')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AIR')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">C.C. PONTEVELLA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">SELAS Manel</div>
            <div style="color:#888;font-size:8px">Daniel Chazo</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AMY</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AMY')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AMY')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">C.C. MADRID XANADÚ<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">EL FALAKI Nadia</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4MSU</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4MSU')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4MSU')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">C.C. MADRID SUR<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Sergio Perán</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4MRI</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4MRI')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4MRI')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">C.C. MADRID RIO 2<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4VGA</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4VGA')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4VGA')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">C.C. LA GAVIA<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4IAZ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4IAZ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4IAZ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">C.C. ISLAZUL<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AWV</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AWV')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AWV')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">C.C. GRAN PLAZA 2<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">PIEDRAFITA Rocio</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AJQ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AJQ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AJQ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">C.C. CARREFOUR PONTEVEDRA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">FRAGUELA Jacobo</div>
            <div style="color:#888;font-size:8px">Verónica Alfonsín</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AWS</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AWS')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AWS')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">C.C. CARREFOUR LAS ROSAS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">GOMEZ JOSE RAMÓN</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ACH</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ACH')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ACH')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">C.C. CARREFOUR AZABACHE<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MARTINEZ Alfredo</div>
            <div style="color:#888;font-size:8px">Verónica Alfonsín</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ASS</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ASS')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ASS')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">C.C. CARREFOUR ALCOBENDAS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">RUIZ Alberto</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ATC</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ATC')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ATC')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">C. COMERCIAL GETAFE 3<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">CARRILLO Antonio</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ARQ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ARQ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ARQ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">BOUZAS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">TOURIÑO Miguel</div>
            <div style="color:#888;font-size:8px">Verónica Alfonsín</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4BIL</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4BIL')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4BIL')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">BOADILLA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AMU</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AMU')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AMU')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">BILBONDO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">ALDAMA Idurre</div>
            <div style="color:#888;font-size:8px">Sonia Godino</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXV</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXV')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXV')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">BILBAO CORREO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">RAMÍREZ Ruben</div>
            <div style="color:#888;font-size:8px">Sonia Godino</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4APQ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4APQ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4APQ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">BARAKALDO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">RAMÍREZ Ruben</div>
            <div style="color:#888;font-size:8px">SONIA GODINO</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXN</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXN')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXN')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">BADAJOZ CARREFOUR LA GRANADILLA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">CASIMIRO ELENA</div>
            <div style="color:#888;font-size:8px">Maribel Amezcua</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXM</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXM')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXM')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">BADAJOZ CARREFOUR<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">CASIMIRO ELENA</div>
            <div style="color:#888;font-size:8px">Maribel Amezcua</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ANU</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ANU')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ANU')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ARAVACA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">SANCHEZ Jesica</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ARA</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ARA')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ARA')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ARANJUEZ<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AQU</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AQU')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AQU')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ALCOBENDAS CONSTITUCION<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">RUIZ Alberto</div>
            <div style="color:#888;font-size:8px">LAURA RAMOS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AES</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AES')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AES')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">AAA NARÓN<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">FRAGUELA Jacobo</div>
            <div style="color:#888;font-size:8px">Daniel Chazo</div>
        </div></div>
                        </div>
                        
                        <!-- Columna SGUASQUE -->
                        <div style="background:#fff;border-radius:10px;border:2px solid #6b7280;display:flex;flex-direction:column;overflow:hidden">
                            <div style="background:linear-gradient(135deg,#C9A227,#B08D1E);padding:10px 14px;color:#fff;display:flex;align-items:center;gap:10px">
                                <img src="data:image/png;base64,UklGRlIqAABXRUJQVlA4WAoAAAAgAAAA0AEAtgEASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZWUDggZCgAABDtAJ0BKtEBtwE+USaRRaOiIZOprLA4BQSzt3C33ye5AdQwtMF+rnxlWcf4fM9S/9e6c3qOcOvyp7lP9P9ufqf6RxZ/Tv83zR/lf46/neszuz2P/zF+UGL57w2V7lv088nGgp+qfSH1KvWno6dbgkXe8mn2oJGgpGAccMavN3vJp9qCRoJ1YfhDLQbMPCnLTXiU1HiL1byCuinrNPtQSNBSMA44YYQiIeWFzdIVCf59TrzCkJLXrx7HfKMA44Y1ebveTT6+m1tTW39l+tlNLwR77vFf5ghDVBepxtQeRLUGFq1Jejal6JiRgHHDGrzd7xsjWyAWRwTCRJRlq36JMRioGjWlw/OfQUYZHadEEcw2xGjdz19alj7LRFohY7G7bT83ONB19JQCz9kmNBSMA44Y1eao0D4MtzvRsq/jArD4uO1U/kCnC0mQ/CI0WSCE9XIxp+t0A5B4B0CjEIrytiiM0b6m1X1ROwbV5u95NPtM8g//NMl93AD2YsJZhH9b68ZErtbNO5E737653JCuL8BcMx/tZOCJzON9SuLg0KbYBjW46Slv/O7eAU4f28iU0+1BI0FIwC3xu5KSjbqUGIkf3JuwbCEGy1WHd15/ZKFJsEhZUPEUXh6vwRjZ+niA0S5OOS+AMom73t20dAtxQ1MKwU1NfMuZfeYY1ebveTT7S7sy6gJotJ+vmt8wDwsElX5Y6zWShSyDSIzWcJGcg7tzrIi244TZibbepSx8JPsxIArlPDR6ypxXs2vbmmN3vJp9qCRJQtay7kVU72N3otLh/Kmr2piaAUwXFJlQ3SM9AnVxE459e+5yC5f4G3NWlX+bveTT7UEZQZ7VlL2h05MvSOUv0kBZpJgOdV7i6oNo6zFLRnw4s5MgO/bg14SSQkvpJR9eoEDX2V9bcKqUcOOGNXm73kw4G4h/KF8sxn9BtA64iqqdef5nRPI+WHQufkzeNiforqskOXlR5dBFdtkCgJy38pmQEHKfPDXzEVle4jNsaCkYBxwwlnr2jo/PwcYqCQYyxv7k0RTkXRQ5DkpVIlMVtZE1cMvX+07mPXno6IPs7ZTcz1ZcEVKop9VfVI9b+2ZtXm73k09neVF18NZm76PtRLSQoka+jjAbaKvNEA3vcdfnWzFjr8gydxIwCo4XEXC6CTld2VhfkOxxM+NRoKRgHDSlNHeWt9cbhBY26qwchQg3GHOii5JufBaNvIazJsvnDRFlO1cPHlwe1k//HQblNpa6eqMnLOfbddEmeJc3koMY4Qog6s5TruhPNqy8NoKMo/Tmnf5Wb+XfujeybZvpOwyLmVct2f53+wyPm0xezbxsJbl5M7lr5SlWaJs4yUr5oq4Jn4lCCGpN5gtp7PQHVewTT8+yXZ2DxgHD3yelXsfn/vpW5bomgqxR6d8fzm7MiaaAuuPfGeKbfX28m9mzo/Jm6lKSgWb/aN4/v52/a1p8bZpS+KGNhtL9V78/VKWrRBy7KwdQ1ebnuYqhNrkBbcLcPvQNfDUN/YVrtGNWFjdL23GxHqy0PmD3zqjJflm7RHXlco2SXuW34tnaiERAJfzyUIFpv/lEqr95tKdCYXyCFmLtQdPqjPa22oKmns0YDV+AL9n7AB6ORiSVYjWVJrz2HO3fVNG9cW0fuvQeFbSBuYMXCyi99XHePz0U/vIj4eYx/Dv6S9rFptr/6jeOQUHZTt37aOhNZJdQbQ7ztcId5W5NiAXt1c/AOvGQSIBlpQPjkHi3YGdzpgc4ZiUthWECxI1jVU8jzVK3fiJqDInr5QRQOTk9v4U0WrNA5Gk6/PCo1N0ycPeovNu7djVWMA2IVZlvjPO7le6rNlHyr5c8xhSFa1baI+u3UylmgR2qWxNE8S2vuds9I3tI7bUdUl+5/fDYZf8t1qc4fRvXFSSD47VYGB5l2lQ95Mr+pjaJ8p6s0NB/fvA9lly9CgClCu+4t/lIVP+R3BHkHtffUhqg+93A1iqd2PPHMV5DtaHAO4iKi34Sizc/8PkBf4B2gZB7nseowKtvS1dXCgpsRVNpYx4jviljUmzl/aL/ETNevSY6CbMMpG4c9e/iEn4IJrRLh3mFOPaBk93KGAaROXpRiwI9j1aNaDJz2ExYgI6mOC1LbpkkqBSZzBGZm3qHsFNbvuAFcxLDh+ovdskuu9NIDV2ThN/1qte1crXJV8hCN/GT7GyyQt9T+F79vfrVgc7m6lvxZcbBt7xpDZqFcCVHvh7NNwW5IWZ3RJ3FYetSpjkBfluPq2j1v8tWrKHUYD9vdJ8lo323UH2NhuOPlbCMbW1DyukyFn6maGaBuaoca18yQX8lZJ9igge6N9MCNfc+eojNbRz96mViF4s+aKSU1EnR0YNnwC3Jog04O6fbpRkauCmLgBWpmG+kjKFfGJg+bv527o+46Mlty7fowQa0pl/Gl7I6FcuNaEwTutwvuVwtaraGzYFN3v9p73LCrlj0jBzXvFZJ1tLFQZu78Ah8H4OX8TNWmxd0MmQqh5Ryf9rdYQkRy4UZZDoEYsKiNlFMy/ma5raWjW5FAAD++ipAAAAAAAAEkduzEQpdrYSwi2TCeB0m0jxr52ColbrjIWX85eEN6S/4GZz5LSx1YDrKSG7jP1h4gDwuB/zQo0YD/ffe/jxZWE18xtM+e0IySzLnSP0UyfINV2bRz16QueIZtHGQN3yEdiHb3Ki12L/+M8ON5HZ1qe+DJbynMjGsM6qx32eVFyyam8/dQ9unVOhv4M7Pwwfknjxg13mGLnghnW8l9v5lU5pi6gMwbCYfie2TUvlPzghUAP7qBS8neICPZeYNyhkXQ2B5wD9RcUeaNNCKmfQEfBZ1E2r2gewoAAAABm7H7yDJv/hqSMH8G3zl/j9NosPxHsuepzEzzm20O1//DcazJ7cNSA9j5JcOLHpEzweHiyCR9ttXyFKX8FuuVmIt2CpvB/ZM1uH7fIS73EfhV6yAUL7wHqmqQgpyS84d88TGdccODa/iIOUfe4J+bW1PY771N1JP9iAMCYEAYVyTsvPDeP2FTJM2nU2qNvpz8An3Wn7gSUg0rY6UiX73dS2HlJRwUnf3MpkAUaWP8z7zZAq0IxKQyVKqaM9T4zdKa7J/F+TzYAAAGiAg4+XEPimdBKXeOryouPJD4DfJJX7jUfPYjXs+Cb3qxu5VE8ZQUHABfCTZyfOSbKfWhrMw+GMluM7+LSPKMw2wTa0Kii9uXiSgikwbG9nTjE3WzMwbMHSx77l6Px+8ngCjgRWw3zaR21czxOWf3VvrUBe+Y2SvTA6WSQnkUwPlNF03ho4BK5JVkfz4nbxr9SxvQtWL3HtVc88hKBW91Nm4Jzrv0hRHh27vnEl0IG6qAOz936piHOuQoVNXQCvD8tFqAtFbmgyGMIVGELAtfgZxQ8hvHxkGaEYOn+Jd8Oo7RmIoqt508rsjCAAAIHmZUXUvulMOH4hO/qsLYvd7VY9KcjSEU9xLlqptvRee1Ui+CZ/tMssrh7GgAMTEjDZcb/H9M8RFzcASXKZSfKRccP1ZotGALYw5GThWxMTPFcG6kDoMLiaJfbeoJscwSrqphQOePMa0qAS8a86Qb2vmjNToPEYpvXSjZUK54KozyUXpjXayTppfwhQ8uE5QzWjg6EF+MBKQFjA3X5cnbiqIPJstw4e3gOt/PSCa39vFu67h+APl+Ez+IPX09q1IXsEtcheXE8TRs35achvq5Xr99uhyZyenMhSOC/JBUAN6Mr3zAbUSpmF/fR/UjQba/8eL1gJPVKGjP3PAPp0TIHw4gkKsjgjRlFsUmEngAAABRSTCZ90suL07JzYJ7IjvFpliAymv3cMcma06hXnvsJyF7WLH2qRfAbgWg2TUR6OsazeGvPv4Eci3Oyioiyw0EhMhmUEorUX5tTzfP5Q7FrTvwzcmH2zESCZtsrqZDxN4KIQ2AAmBEhYlQn1aV4n8rskIq0pPj8DbwCOwAdNdKPpTP1682HzWpcREoQzsBJk+mlqilUlMFyaKzUqbmAE4kTgFFrQCF1q4WTyZ5AqsGAs0tLJ6QKs2WT+EGNoBZzp3YrbCEU0+q4ckkgkbMi/0vIur7/2FW0gw6g0h53NvkhlB/49qhSim90E1sb8mGJA5dUmOy5cLTW+762wwAAB0P70GlfhlVaecQEHvFWfv+d2sM8/pbby+pKK/jvSwbvKEKBsLfcT0v1kZTnR1V3aG4zZhUnduV/VTKHSiStLUtkfBR/+jkaOeWSChcabMcyKxePZ/lFdtX65v2a7gH5stcy5bydjOXFE94Q91eKS/r2+Jf3AQNFzV8oMMGaeziLWZPruzYPpHb/zD6Kj+yeeSUA/CKfBu1I4MJUoaTMrxCZ/S9vnemBwN3OVkVrkh9g9Lu3CfZBxMRRvIexb801mv6J17XeOMz4t7H7gb3eZqeSMCyS+qLV8T67UdiZtjvzAsujjAJ4ltTqJiHKyr7AP2PTB6+ipILit58BTE3KmLDtByJnU7kPEw+mixUAw208usobxarxHeQL/9wuyAtq39qAxtCY6/B1lydQ/wcQ1sGJrIFxoABVTrRS9jKKIl8YF87WKDnF24/PT4kiJSg2h4+TJV8FmTKIit48cEOyx9+IEnKRdKYxszTeqHpuH7ftJJrodVjUYmewczKtgMFHOM3rJP9LYFBX8G/UGNAqU3yjYd+ema/hheX1bY2kxAFKeDpL5zmS1FzDiRx5cCxmbTdXEYjiUn7ZiVfIrOr6ZZa9ypr7w45a+Cw8nTHMuxLbeU9XRSOHtH3Z9DPCGyL4ba/O864MlJsQdE9nzURKsKBj9IuKzrl/YTElRcMd7NOsNkWlfqg4OOLQg/sZ/sKC7F4iJ7k2l96Pciz2M/w53QuNb2YcvcllsaldVljgMNcybvdeOzrmPASYVZEeGqznDRG4zkqMJJp7oKCc4kBG9g1kAEH9YstwylOLzJ0h90YVZeb6P+uzXoDSXBrQvH8eghlaY+TQUY5jZxrDZQtyIz9FLOx4Si1PKLPABCmC4PqHvgAFdxjSg+nx3z51nXILUJNObVSaCFBup2JjXDfezdKI1+2A13cIo85MF6T/s4EzVqUdlRxe5YPdkDstEhyFMo4AAjPtFJm/baI+bgZL5kG/orsmnkFBDQPjxlzcv/8jiAb4NVnFXjJ+gZLiVig+ZMWqpniaNNakghkAsXo8J8Z4JJzZCXYnxnN0uE/D/6gHpFIijgnT5RcaEwm7N7HUxdCZ/2MkKuludjFrs3EOVVrZpWyuyVhEPCXCRro2449cZsLUKtsTjsDBlXucfCOev84A3ax4NzIw1b5DJiwKC4D5o04od2ie7uKcE+xOt5uPnu19D3pCco6i0F3KTuKt5RIcyDaK5qDkJw+Kf93y0Skmq7Yd1k25VYW5M81jO0ZG9hMEc2xcyN8fAoAEyRDLilbF2Fg2Xsuvwi2d7MPT097h0sPiBHqOaZ6MiPWazcS5i2qfFpJpdqqn2xn8XQtes1Up3zcMcMYXCfBucAUoK3f+pB20Mm+x3WWvFiTr0u6d2xXb6UywP9LKQz58t+tDsVCccvOcjAcUBqb4rGETBrnCK3oGoY0R80Ujq56f7jmDE9xJRyqx6UcMWB5OdbaIwW+2yUDi73txWAAAWjeblOaylzA8goxbIRqVf++3/wOrj8uu/k3PYmM6P2qdUGoi9A3gxQjRqnGKb/Vrb1CYVh8djuTt/ntFilq47DJgGl/yW/kGfvIqI6MgWchFSOfWeDfIWa/bH4QojJ55WG8+MBMxwFNdjXv1I9AgmHR5DsPwd3wsSMuDunS7oSxj4ilGklDMJ+QJOcTOnjgAEE/hGLQ5xMAYs+G/MjS3ob3jQL91Q7+2dLSUB2kXcZC2q2+rSpBHT8XZdx2+gYnxzv5yCKRMtHFbgl1Ia6qzjCbwKWk1oVawAACCPU/DRx0Tv0d59Q2YUGiEuX9CU7mEq2lBNIPftyzXO7Npd0RqlyB0JeWdGbsjyIrPILxUXRvt+pS7hQIlNl+dcHM2P5IMThvd0SFzk8fA56mm5DreRVCxpzrPkBXVJboYXbJpbHpQ/6SSBIb2+1fkURG1AL6en5wQY83JQ/YQUht4P1rQqHzqGmYfPTqHO33SyMMQwKVPDUeDZ3A6rnWPMdb6DaKkN1VDbvFQ99/QlZDXXBUKCq82ayUVVpS7x/DtXaI9/gi/X5zlsXAbEoAciQ2h2SrSLzn5/y3klcp4lUdaoLU50bD2JoPuvnk0EY6vW9txFnsCkHY4SNnVtV0V4NzeRGLBbHZ0GodD+KZX8GMeMqWMAACtSFA/OHQXXJIJzpfFIrS6aCb/KnNaYGguqr45cbZn2fExJlqgvOzhsF+pDUDjXw9hRC5sPZn7/KnVc8Ba957zrRQ1qOrFL47ySaL5A76yUeC7a4m/2JtGH88/PtgT6zk4OtB6xB6eQmWquztekyoh45+MWGyVwUTMz+U8sdT10y/r3+4p7QXMYW7wfnY2hG4k8e9kv97XeSkUGvsbNN+wC38MvodXOG4r0kqXNh32MlqVxuKfXgk5FRhZLlSOauJCXaVwXfuxxEhjb5AhX2xyczn6H9Pa9i4WFJLynKo1AbymjC24zsbdXfzyvq5UcOQm5q3fgUH3LYvemtMt5k3hRdGcySvId5nlKurgu6s2M2xoRDoKyG32joIjhbs2xMMnntULqioGVJ08SXAWc0vwqvA80tnunVW8tpYnacpuqAAAETl6BnzHIM0jg9pfE5fYIxvn5wf6009yr8CkdXiFh6TdX2yWU3r5MwpBpof1wExoHRf2yOBAoxdjzB9nuSk3UqgarwE+EyHMxb1CQn9ccq+LQaor8a+p9lbZD+N3fUlYxJwBdrEaVQ0mk3yS2BYGM6M0IIGsDaZ9ugNGw6Rb8b1vhL0tHyqjXjpXEzTHLjFQ0Bb3jlfdZy/WidlKcuid7bQikT5dAeA8MDi4ezkwTn/eRFOSrsUxW0etsw5sTTbw6eA3QsREeGjX5s1b+lT+CEbjr9n5XpSUlx+OkWk3uqpJNCOmR6cNy3Flw3RAtQguKIVWfxa4BHJ8oEm8GmGfs7pfMqdyC2Yaq+4Dr79PEOpKy/t3mTqFTdYVGbXLXm05HwoA3yrWzJ/1AXT2SLB8iVqhuQr2O+hU3ozZZQgpxzYJ36SkIgkoJYmY4Hn3gYUrNfwDBzUTcMw25GrtKo5xPqOm0N7imb81IZltJZ4VH4rAAKgV2uz2Iae52VPzSMmFXU9cf+7LbhzcLtYLuo0WTXGefDWX/6f3Ig0TT0lAHxCOrPjEMWqoEF7oxAq50BRDE13M9XZdTxw3DY9igaxXTmtFswLw9OnCmwJoM8Z4bQrXkH1elJvboTgqejSeCiVQosGR0oTN4TaiMCnAFlUVaCzmuOeaGt5lRdtNBzwwNNYWAicdMlXi5WW405PiHtO8bTGoJtC5dldA6+70nZ736lYJGqTYp1vK3ZY0Xd5QvYuyYhNaAaGtNVINT7bnG32DdpTbBxblIUFhhM8BtbR1iEvGInhMBQEc6r6lyMUJ92jotEAf5+leL/H0iztCyB3kF5KcFCvwACOc1mBENQ6TxWUklLkWquS+58btz13QhKgDxzG18bVeOJxDDCAmsW+v1R3UHKVOeK6rwGu2EINfOuS5WEIr+Yv3uB0gVbvlV8/ArO9doqtnUO6jVbXevcw1cwaxtbT2Pr8mbL0zzx1Qp7huUH+HYktnhkxcybYFlqxfN9+uUmmjskHm14U7N8souEyldL8INlLNZwuMYBxt9MOOOJhDNOthayMoONh7qbDAHrWtEQYjctS/8kJi8XyOLiwKc4ga5OHCuqrMh0NvluXqigS5vDjJ34KdtK+GhBMX1MWicv32WBaT1quN7Wsd4DVY7MZnHRB1VhIWTgs7urPP2Rf85CkrxVxzMjj+XQoj8lF2h2Ej6NmyfmQe89FqRT2Xc7arzfKbYZP4Zw+vAXWlWB1oscxBnazFOxUjibHhYUHVeQP1IdBjHvqKu3XEm22g4zb13PYSX+uUxZUO1P4/1AV2H/y0IG1wpTmwgApKf0favCnXV3AtBtrg3R5po1J38XhPYP8758u46f/fy+YxmkOVArc7dHYgu4NfGaF7mI21sV8M2ye79sx9GLYqizDOiA7bXX89JDWzUFZ7XO2Zp/ysiZ1DH/WQz/5VFTe1vf+0jP6c9RN0EV5Eeyy6oE/LGRFWwtKKlkRIvdLhjLZwXcxM4xGSWvWKBmdzJ8y7TfmvJfylXjZZLjAHANdODGLGei1vNOJg2dBi9BsxSKdZ2xs2IoDoiHRtRbaDangvSLgxHa/ie0Cq2/un6+/3utGCKwiIKyqddRuVXkVOQvU9DtsBskPFgDr5cEleTL3AB4W3LEmC0vOpI69Ozu9E9gOG+oJSyzAGA0dPRnUxzIdUKoJ4HRqP5ndGFPo6KTA5d3G8R2PfyyvqhOzcEQnJZcGylilaxQtJ3yx8f5VOWE92pJBnmhOyijqH6K7gC8JAe7YStJ6ISGz1mD14J7QvWl9aUvbQlPYHltDfU21GCgt5w5d9DsGQAWHwqVlsjjiu3zoB6KuGt7tGbGMBzfusnynMyTvxtS2/PqlwFFLdLwXCXDkKqpTirSm2f21fgNOaXd0itTkTs0EXoab5lzX76jvuhYWs7MG2mWdMYoGzlhSpoLsyjK0Iws6K4SXMOSNk8CdYUcFeByB401LBU2AHJUwS9g43+tNQoGKADeITeviLM9wTc05vUPwIF8m4slPFgrZUNORR+2Vug7j9XljPs0qQUz/Xp75yWcZCbydvXTBSBKXhmqCqFZMksYDgjvVBLYCbPYavPR+w91OZY9kqIGZ3tU2yd5etc0vu4+WNy3eR7IIzaMH6yo/i0QM/g88R1qZGNJjnsdUGHoC1mgxgO7Q2eOvS6E2Vz7bnhvAY4zdTd4weL0Q17jjXvv5JAJOKnQPCcaGZp3feG6fyLI9p88YVscSsFo0AmJoYcz4jIHytq9VScE14BMeaQbw8kPE++l4OP3A4+SFTo5aZi1M3yR+vYxtx5e5Y79Q5yrWmadiaLust5FbdUXDj9aHwGZckuuZiBM+oEFVU2VLKYKzc2uqv2D8eu4qFWb30gg/55mbAp3oS3xR3SfUd5Pqqoq31112S4Oz03R3UBDaALCgr1x69xkFBcVJwWTo6/qeCtr7z13EV1veah+yd9q6uVtafLOAfroXudPrXHXytgoiX6cY+qEqx1UQZU8r+YNFzavIq2ucJtiJn7AUdx7JyjGHuwIb4VMNnjzH9inClD6ywQ6LhBUXYNNhUnAtfy+fVmRkg45Zev0AoD5cEOEAOR4B5LuBS0NNd162gXxNLEWpgU1tR0q4ZjA1ffSvPkf8coUSZcy8O4rHbsKLYgj1I7DkhoHL2S36JdbhQy/j9bP4Dr+JUARAPEu/eDyUa7rt95D4nvOHW0kAn/PnaStbiCAVcupmzpDjxVRqzf+mbQa0JBCr+3KacDo4OiHmnNC3ELaN327Bgo2u6+T1+zaSetLL7wQhTb5U8xnNgCvMmrNFSyfANXzR/0i+thb2vLrLAX4ptHlvDSSMpc2rhKpwOYpPtp5dQdkxhs5/Z3+vsklNSFkc5qs1LYcWsITsaewwQR4RDAEADIF/ja325w00JwaMV2WqfX/otJ/vmE5bGh2LY+x5QDu32o9R9sIMHRAiOtWCS+ZZm7lim1OXt/jMbM4rUWFruqpaGr+m5l8LEU34nJKLmK2vDEgCRiINp0Y6wnejI71F25ecuT2lDqX8AuH+291hwVYl52GRl7LRKZRro/dxnNAacQ8PoosBlosT8SqJgmMOwYJus9F+elBqGxhtrV5gaM/orsadLGS/fwKTadbmuirSy50tfexUHSp94HJSyohdPitGar4iPwyp2MEVgiwcBNcBrY3IYI7Uu4/VB5DKQgZuqk7+dGHB02SMWqhpx2Ag0TkFRqf3jNlGlWMnYWvZrhtVw6CMju3XO22OtVFtIqOP1WQKm3oJrSmF69Xg/v++pwWVpzLVlaQ57GGfoP6MyRgUyEQ/T6xh/MaIkf3kD09DLOj2ce055/6r3GHQKOP4VnZnY2RJJzHerCh/DjSftRxeylv3Vh+PdoS/5D4uXKO/0i0jr3IZ6g3+q8GqR4z5a3zhBIt5fUvf89Wxr8oYYmhONGTRWjqINTTR1VOujK2u0sBxf9WfpYJ95lokOi9+1x7FF51yWvVquiDkblhD21TugPPfaU+VydAl2RoDne8jP1kCMmWPqTy6SBrYPjYdk+JN/lgbwf5JcLMi5i1/rLSXFgK4I+idocTbd3C7+GmPg5HczQjYc6AyzyorQIhHY+TgwjO3TmCDmG4OfzKeH6RJWKq9dPHzSLDnSvnjYI6v8x3S0oFICUVG578A9T1WZUwdQV910jh1Iq1GB249KwMYotz4NDe10A3eyTi7Q5rqsfYgWh561rDG7+KfZXvvfxHEnDlZYcxIR22M5xmCZvQUCFzW8/YiLC3urG+zxz2v/VieVJKOAS7KdE7efBpWwsa5y+7nP6vYV6HiF4Veg0UzCMFSDFlOa4t62enhjEHaJ3Jsl0tayVM0Ftxu/xfzoXhMxTqx6m3ocUfEIdJSMYkpQDaafuHujUsVNdPRMPe/BGgljdvVWQ08TQ2C5ylPmHULNcY0SHL0UU+SWbMHsdJdCf1/LK6DYPYVG5uRUXZKsKCJ4LejraabpyGdZTZxnJzdEccxd+K0TtqpvsrK+ta+96Wps8KtOs+YddJ4erkzmOYc2DPl9FJ3HMerYYlJp++R2H67mivobDbBu+8VAo6bNq1UPyGjjW1xaJ7mxMhyY5l3JbiEMujdmrrSLPyvxKki/0pORgZovgBWHMse5jRMIpMK3M8Y4XLURyKPVmlVtzuSgN1fxzrbJR2j6OYJPJ6k3Mwd5aWakZEuMr5V4Eel4LWcuY1PepGUppoZ1w1H4tpWPSOVmnDu/AX1/Q2Gb/6tOZa0sdfR/d130G0xzB32Abl7pgC+CiOgPT8l5dVoEgp++WJHD1wNsdO/SxSR1oh6DqcKLdCBhFkteNcP0Mj6m4tRTZIwfcV8rVUDcBQ38W3Q24rSSHyup+9v/AVrHoJkomUeN4CoK/kQ3gaXREJj175NrSaSqEpCoRDkUsogoZicqAzSGUTKwZ3Yjxc/wcsKjFFb/D4d35A2f1yqMyBZdmehPaHkABENzqhapelAM9C8qz9Zv89UkzlK1NP45UJ7TocSXictpzVfvfscz8Rwrs+iNCzeQC680lYCFmqF3e/+dltlA1wsD61TpHD20UOeGyxvVJaM85KqfWdi1t051/msNSBnXWZkBrx8VJykaaJ4dQgIK8/0WkIckORgOylbILTjWvZ9djilylJ3Vwb3KSaw+2j8M1L7DVg6K84PO2uikDzCDZZZBTifcYaMJOQQu+FkvmsBkoAy+8jawAK+Ht0h3suVwvX1FYjRKA57NpalFuvvbdZeNFJRYaIebH9qO18H23zmyoix8h9Ma4nvHxiSbodLDHtczTPiGRp4dJqUZgCGhEHbyBxc5cYaHTH2aHZGv0G0iWFYZ3cZwc2GcnP5bM+KZoNXr7buZTbEMgNxkydeUGKqJvk/+L4/UfdjFNSjWUDNN7FReTbPsRZsOzAcFoIz/8+6ECIrAmXwswL2f5THSlvgVBPlj7J6Ql9exFmVfpiMVTj/pWF+nfrNAwzJyz4eRSw6wzWtzp6lR84EcW79CJ1NyL6/8c0o1T0M8HieSobA/0m5ahcRNzZpmsvIV/iBfOpCyxAH9GvgoBCVD5atfn6xtGsd4PfJ/GRGwZgIT/3YfCcAQvmCfT7b1eA69aQCSRszGo3RwmgKk5Go4ZcVPNsSRyyScxzWsoAy3EI7j+BRY3tbVHJFmafQ4m7ImpFQbZaaWiBVEaq4xhd8upKlBmbOWnRpI9uSmNmULSpyYcE6D2fyJYvdPIPTVh3bOg29y9Z31MpUpL+vkT/2Y9wZiCpN0OcO04sIMKkiBiTjoYuWcOb1ohBQBSPJ0XuZelikb8/JhUJ5azT6aGKk3MOwK6yulw1WTW6XGrPTK6Lw0Sbi5dfoQeCL1R/l2B4rkJcpwxiWZyRL4KQsLj1JEzn4xNIVpPdDtWFKbN8rYxLY3MrTbq2L0RbXudi3DUGoQMEsNmHSpDPPZX4FPwGbU35wADoOH+K2IDb0CrgemgpsBBYmu4vaEXPpxwnw9I1h3VzGqNhSo5HSqHtiRuk4o1qSLmCFVc9X3nhIvLosqO/c9aBwk0b0Arazj+28mmym6EYSktPecQZsXqG6Ug89y2XfUj/ScvgqVQV1gANBJFOVYWBm/4dMhBLS0XSoqERZgpyCtrxZJ55lcek3jKHVznWvneR0NnoAG0hymg20Y93pMDKse9474KAgZxQrZuL52RbYZnCIBZkXjE7SvXp6ItUMkWlDSy0dcYNK0eeCtyBEOvWF9Z0YKzR2eWqqLHSsD6O4EW5TtYo+LdDvyGat87Ju0IPWlIJ542YBijQbxk8j9S55Ml3wuWMYdHiqYAIZee1n3JDVDGpuBeEoBsEv/mN1B/HI33rb+yxgXv+5CgDCGs4FtehXZkZJThkiZKKhc3QL6glT0k2+4tJYt/JWMZX+ox+noUQ3c32bLisfUgoKOZZWS1h1vgX9I/zH4vfxkr6JqfNUSEGRgL7QWdYxxhda5z+oQBVHykmNqBjAGYSvcxWtYcCYOpwfhiSCe+kQmGoZjjM50UPXVnayJojoeAy3lgYzoIiGysiGA2VEMaTZrksgEc2RHakU+ti8Ku/JeswsZWOhXMiC7qGPMXdS9/4t/LA18UDBYXTF0isS2HykDaBxyWFGS92cN0Da2sfqxNwajdzxeBjc3M88qnNCs5lDhqeq68yxtk22w+N09OOrlVQn9DipEFeE63YQwHP8BH8qrr0WM2lnEMj36hg53GcpUs8HODMDlMQmC/wQ5oDCH5yj00tvG75sT3tyKCUcUbXoE0ZHuU+WcfhL56dNIJNXGbzNPitRuALABKQRwuBZt5BgnhnwFWyhcPXGwJpaDFy8CrzwMV8HNb2OednQINYhdLqjBrG5DsGw3/OwJ041HAZ0SRrN6D8aeYUf8Xc4lfOHcbm0NMEu1ZmUA3zD7stOoFm2Zl1qwSoVM8fvuOVVXXxnRlFMGbScBGz74/ZggPEcs/2OBq4nVBaxXrxjUfao5C9WGan/yc6NJnuzwa76X/REb4tyc/oyFBKqCK5ae9SYBfZ/S1xlkTEWuipEp8KpRMVX6+S8rsxF/fKaf0aag7QBTwkZ1Y1bZThRrwNVCznHNcuSeVto0UvoD8vHGJaCRNuDgdByz8Iqut3Zb4DBeMR1JGSPkNpnmwIPGI0sL6K+Mt5iJDt07M48Vog8ihLrQloqDQkFf/uye4MxUyZ3V+jlmv3YTknFMKJpibK8tup0dXUl/Z35xn+cD1C6cr0jbfDWC4+dA8/ECRMFOyFKf2l9IA+CC9r72Ka49R3osT3p3PXR8KTHo+FDo9jzRDfhCx8uB1lgiL11ICSWpuGw7Io86vauMcLmt8LTvPl6cL0HP0Py6AuHXQZj4wxFTsjolG2LzDCtG0paf8NMnysbp2aPKpMa0+LeFcrr4p8R+ZFRWpE318My06ymLu53rD1Ov2HRIzIFOe91h1j4qYPHOfy61EsDagVIXZ4Hmr406i0l6Moek+tSgyZUkVyAwMvOQAvpIw/zznsiwKaBnlCl4YuF2qeeaNuj1zylGKeoYb6J6I4xxVmxO/6S27/S39flUuWtYFqpLpgpwhRUAAA" style="width:45px;height:45px;border-radius:50%;object-fit:cover;border:2px solid #fff">
                                <div style="flex:1">
                                    <div style="font-size:12px;font-weight:700">SONIA GUASQUE</div>
                                    <div style="font-size:10px;opacity:0.9" id="countSGUASQUE">115 centros <span style="font-size:8px;opacity:0.8">(7 AAR · 1 Excl)</span></div>
                                </div>
                                <button onclick="abrirModalNuevoCentro('SGUASQUE')" style="background:#fff;color:#6b7280;border:none;padding:4px 8px;border-radius:4px;font-size:10px;font-weight:700;cursor:pointer">+ Añadir</button>
                            </div>
                            <div id="listaSGUASQUE" style="flex:1;overflow-y:auto;padding:8px"><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ATQ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ATQ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ATQ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">XIRIVELLA CC GRAN TURIA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">GOMEZ KATHERINE</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AHE</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AHE')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AHE')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VINAROS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BERNAL Fernando</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4FIG</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4FIG')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4FIG')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VILATENIM CARREFOUR<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4VIL</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4VIL')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4VIL')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VILANOVA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4BVI</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4BVI')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4BVI')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VILADECANS CC VILAMARINA<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ATP</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ATP')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ATP')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VIDA NOVA PARC SAGUNTO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">ESTEVE Mireia</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AUO</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AUO')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AUO')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VIC<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">JIMENEZ Mª Angeles</div>
            <div style="color:#888;font-size:8px">LAURA PLAZAS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYX</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYX')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYX')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VALENCIA MARQUES DE SOTELO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">GOMEZ KATHERINE</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYG</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYG')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYG')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VALENCIA CC NUEVO CENTRO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">DUCE IRIS</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4BON</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4BON')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4BON')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">VALENCIA BONAIRE<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AQQ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AQQ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AQQ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">UBEDA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">LÓPEZ José Vicente</div>
            <div style="color:#888;font-size:8px">Martin SEBASTIÁN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AJR</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AJR')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AJR')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TORTOSA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BERNAL Fernando</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AWU</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AWU')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AWU')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TORREVIEJA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">ARENAS Vanessa</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4HAB</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4HAB')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4HAB')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TORREVIEJA HABANERAS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AHY</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AHY')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AHY')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TORREPACHECO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">CASTEJON Olimpia</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AUJ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AUJ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AUJ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TORRENT<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">GUTIERREZ Elena</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4TSP</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4TSP')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4TSP')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TERRASSA<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ABI</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ABI')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ABI')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TENERIFE AÑAZA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">DARIAS Beatriz</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXP</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXP')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXP')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TÁRREGA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">GRIMAU Gemma</div>
            <div style="color:#888;font-size:8px">LAURA PLAZAS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4TCR</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4TCR')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4TCR')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">TARRAGONA<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4SMO</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4SMO')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4SMO')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SEVILLA SAN PABLO<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Maribel Amezcua</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4MTQ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4MTQ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4MTQ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SEVILLA MONTEQUINTO<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Maribel Amezcua</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4MAC</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4MAC')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4MAC')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SEVILLA CARREFOUR MACARENA<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Maribel Amezcua</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AZN</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AZN')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AZN')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SEVILLA CARREFOUR ALZNALFARACHE<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Maribel Amezcua</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AVZ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AVZ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AVZ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SEVILLA ASUNCION<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">SOLA JUAN JOSE</div>
            <div style="color:#888;font-size:8px">Maribel Amezcua</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #8b5cf6;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AZP</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AZP')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AZP')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SEGORBE<span style="background:#8b5cf6;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">Exclusivo</span></div>
            <div style="color:#666;font-size:9px">MANZANA Rosa</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AVE</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AVE')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AVE')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SANTA POLA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">DE LA CALLE MILAGROS</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AVV</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AVV')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AVV')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SANT BOI DE LLOBREGAT<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">PEREZ Mireia</div>
            <div style="color:#888;font-size:8px">LAURA PLAZAS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4SAB</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4SAB')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4SAB')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SANT ADRIÀ DE BESÒS<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AHU</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AHU')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AHU')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SAN VICENTE DEL RASPEIG<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BOX Ana Cristina</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ASQ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ASQ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ASQ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">SAN JUAN CARREFOUR<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">PÉREZ Felipe</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4RFM</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4RFM')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4RFM')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">RUBÍ<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AQL</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AQL')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AQL')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ROTA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">JIMENEZ Leonor</div>
            <div style="color:#888;font-size:8px">Martin SEBASTIÁN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4BAN</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4BAN')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4BAN')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">RONDA SANT ANTONI<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYH</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYH')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYH')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">PZA. ESPAÑA VALENCIA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">DUCE IRIS</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4APE</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4APE')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4APE')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">PULIANAS CARREFOUR<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">VALENTIN Adriana</div>
            <div style="color:#888;font-size:8px">Martin SEBASTIÁN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4EPA</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4EPA')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4EPA')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">PUERTO DE SANTA MARIA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Maribel Amezcua</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AQT</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AQT')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AQT')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">PUERTO DE SAGUNTO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MELGOSO Rafael</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AWI</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AWI')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AWI')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">PRAT DE LLOBREGAT<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">GOMEZ Guadalupe</div>
            <div style="color:#888;font-size:8px">LAURA PLAZAS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AGK</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AGK')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AGK')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">PETRER<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">CASTELLO Rafael</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AQN</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AQN')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AQN')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">PATERNA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">SANCHO Silvia</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AUB</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AUB')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AUB')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">PALMA DE MALLORCA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">DOS SANTOS Johanes</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AUC</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AUC')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AUC')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">PALMA COLOM<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">DOS SANTOS Johanes</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYQ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYQ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYQ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ORIHUELA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MARTINEZ Paqui</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AGW</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AGW')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AGW')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ONDARA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">COLOMAR Julia</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ANI</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ANI')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ANI')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ONDA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MONSERRAT VILAR</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ANJ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ANJ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ANJ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">OLOT<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">VALLS Eva</div>
            <div style="color:#888;font-size:8px">Laura Plazas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AMJ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AMJ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AMJ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">OLIVA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">COLOMAR Julia</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4MUG</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4MUG')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4MUG')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MURCIA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AZM</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AZM')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AZM')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MOLLERUSA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">RATES Oriol</div>
            <div style="color:#888;font-size:8px">LAURA PLAZAS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AWO</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AWO')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AWO')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MISLATA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">GOMEZ KATHERINE</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4BMA</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4BMA')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4BMA')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MANRESA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4MPC</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4MPC')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4MPC')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MALLORCA CAN PICAFORT<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYT</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYT')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYT')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MALILLA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BONORA Anabel</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4MPF</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4MPF')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4MPF')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MALAGA FELIX SAENZ<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Maribel Amezcua</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXX</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXX')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXX')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MALAGA HILERA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">DE LA TORRE Santiago</div>
            <div style="color:#888;font-size:8px">Martin SEBASTIÁN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4MSB</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4MSB')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4MSB')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MALAGA LA ROSALEDA<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Maribel Amezcua</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AZC</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AZC')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AZC')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MALAGA VICTORIA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">LOZANO Consuelo</div>
            <div style="color:#888;font-size:8px">Martin SEBASTIÁN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AWB</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AWB')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AWB')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MALAGA BEETHOVEN<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">DE LA TORRE SANTIAGO</div>
            <div style="color:#888;font-size:8px">Martin SEBASTIÁN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYA</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYA')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYA')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">MALAGA VELEZ<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MEDINA Delfina</div>
            <div style="color:#888;font-size:8px">Martin SEBASTIÁN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4LBR</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4LBR')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4LBR')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">LOS BARRIOS<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Maribel Amezcua</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYI</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYI')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYI')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">LLIRIA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">OVEJERO Gema</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4CLL</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4CLL')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4CLL')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">LLEIDA CC CARREFOUR<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4LER</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4LER')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4LER')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">LLEIDA<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4APL</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4APL')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4APL')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">LAS PALMAS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MELIAN Itziar</div>
            <div style="color:#888;font-size:8px">Blanca Fdez.</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AIE</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AIE')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AIE')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">INCA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MONTES Manuela</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AOU</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AOU')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AOU')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">IGUALADA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">CUNYADO Carles</div>
            <div style="color:#888;font-size:8px">LAURA PLAZAS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AVF</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AVF')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AVF')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">HOSPITALET<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BANAL Pere</div>
            <div style="color:#888;font-size:8px">LAURA PLAZAS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AQD</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AQD')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AQD')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">GRANOLLERS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">SANCHEZ Rubén</div>
            <div style="color:#888;font-size:8px">LAURA PLAZAS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4GRC</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4GRC')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4GRC')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">GRANADA REYES CATOLICOS<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Maribel Amezcua</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ANV</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ANV')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ANV')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">GRAN DE SANT ANDREU<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">CUBELLS Josep</div>
            <div style="color:#888;font-size:8px">LAURA PLAZAS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4GIR</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4GIR')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4GIR')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">GIRONA<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ANB</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ANB')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ANB')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">GAVÁ<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MARTINEZ MONTSE</div>
            <div style="color:#888;font-size:8px">LAURA PLAZAS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4GMA</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4GMA')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4GMA')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">GANDIA<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXB</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXB')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXB')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">FINESTRAT<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">ARGUDO Alba</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4APP</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4APP')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4APP')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ESTEPONA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">LOZANO Consuelo</div>
            <div style="color:#888;font-size:8px">Martin SEBASTIÁN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYZ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYZ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYZ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ESPACIO MEDITERRANEO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">ESPEJO Miriam</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ATU</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ATU')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ATU')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">EL VENDRELL<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">CASTILLO Ignasi</div>
            <div style="color:#888;font-size:8px">LAURA PLAZAS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXR</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXR')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXR')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">EL PALMAR<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">GÓMEZ Ana Belén</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4CUC</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4CUC')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4CUC')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CUENCA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4BCJ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4BCJ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4BCJ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CORNELLÁ<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYO</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYO')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYO')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CORDOBA JESUS RESCATADO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MOLINA Ramón</div>
            <div style="color:#888;font-size:8px">Martin SEBASTIÁN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ASA</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ASA')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ASA')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CORDOBA CARREFOUR<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MOLINA Ramón</div>
            <div style="color:#888;font-size:8px">Martin SEBASTIÁN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4GPN</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4GPN')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4GPN')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CC NEVADA SHOPPING<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Maribel Amezcua</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXD</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXD')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXD')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CC L'ALJUB ELCHE<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BOX NATALIA</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4MAN</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4MAN')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4MAN')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CC EL MANAR<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXZ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXZ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXZ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CC ATALAYAS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">MARTÍNEZ Rosa</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4CPL</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4CPL')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4CPL')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CASTELLON<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4CCA</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4CCA')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4CCA')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CASTELLON CARREFOUR<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4CAM</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4CAM')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4CAM')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CARREFOUR CAMAS<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Maribel Amezcua</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AVA</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AVA')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AVA')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CARDEDEU<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">JIMENEZ Mª Angeles</div>
            <div style="color:#888;font-size:8px">LAURA PLAZAS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ATL</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ATL')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ATL')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CAMBRILS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">GELIS KRISTEL</div>
            <div style="color:#888;font-size:8px">LAURA PLAZAS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AVP</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AVP')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AVP')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CALPE<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">ARGUDO ALBA</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AMZ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AMZ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AMZ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">C.C. NUEVA CONDOMINA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">REYES Luis</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXS</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXS')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXS')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">C.C. CARREFOUR TARRAGONA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">Azahara QUER</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ARC</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ARC')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ARC')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">BURJASSOT<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">ESPERT VICENTA</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AWM</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AWM')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AWM')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">BARCELONA VIA AUGUSTA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">CUBELLS Josep</div>
            <div style="color:#888;font-size:8px">LAURA PLAZAS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AVH</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AVH')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AVH')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">BARCELONA SANTS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BANAL Pere</div>
            <div style="color:#888;font-size:8px">Laura Plazas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4BMT</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4BMT')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4BMT')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">BARCELONA MUNTANER<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4BDM</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4BDM')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4BDM')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">BARCELONA CC DIAGONAL MAR<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AWJ</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AWJ')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AWJ')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ANDUJAR<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">LORITE Joaquín</div>
            <div style="color:#888;font-size:8px">Martin SEBASTIÁN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AZH</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AZH')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AZH')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">AMPOSTA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BERNAL Fernando</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AKW</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AKW')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AKW')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ALZIRA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BELLOT Sonia</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ABW</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ABW')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ABW')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ALMERIA CARREFOUR<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">VALENTIN Adriana</div>
            <div style="color:#888;font-size:8px">Martin SEBASTIÁN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ATE</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ATE')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ATE')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ALMERIA NAVARRO RODRIGO<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">VALENTIN Adriana</div>
            <div style="color:#888;font-size:8px">Martin SEBASTIÁN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AVS</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AVS')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AVS')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ALICANTE GENERAL LACY<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">LÓPEZ Almudena</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AYL</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AYL')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AYL')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ALHAMA-MURCIA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">GÓMEZ Ana Belén</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AOD</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AOD')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AOD')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ALGECIRAS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">VELASCO Mº Valvanera</div>
            <div style="color:#888;font-size:8px">Martin SEBASTIÁN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4LLA</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4LLA')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4LLA')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ALBACETE CC LOS LLANOS<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ABC</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ABC')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ABC')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ALBACETE CC ALBACENTER<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span><span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">Marisa Carmona</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ATF</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ATF')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ATF')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ALAMEDA MALAGA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AZNAR Daniel</div>
            <div style="color:#888;font-size:8px">Martin SEBASTIÁN</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ARK</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ARK')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ARK')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">ALAIN AFFLELOU OPTICO CARLET<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">BELLOT Sonia</div>
            <div style="color:#888;font-size:8px">Cecilia Pérez</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4ADX</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4ADX')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4ADX')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">AGUILAS<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">LOPEZ Jose</div>
            <div style="color:#888;font-size:8px">Manuel Cánovas</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4AXA</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4AXA')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4AXA')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">CERDANYOLA<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">VADILLO Pedro</div>
            <div style="color:#888;font-size:8px">LAURA PLAZAS</div>
        </div><div style="background:#f9f9f9;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #C9A227;font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">4DIA</span>
                <div style="display:flex;gap:3px">
                    <button onclick="abrirModalEditarCentro('4DIA')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('4DIA')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">AVENIDA DIAGONAL<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span></div>
            <div style="color:#666;font-size:9px">AAO</div>
            <div style="color:#888;font-size:8px">ENERITZ ARANGUREN</div>
        </div></div>
                        </div>
                        
                        <!-- Columna AGENDADOS/FINALIZADOS -->
                        <div style="background:#fff;border-radius:10px;border:2px solid #C9A227;display:flex;flex-direction:column;overflow:hidden">
                            <div style="background:linear-gradient(135deg,#C9A227,#B8963D);padding:10px 14px;color:#fff;display:flex;align-items:center;gap:10px">
                                <div style="width:45px;height:45px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;border:2px solid #fff">📅</div>
                                <div style="flex:1">
                                    <div style="font-size:12px;font-weight:700">Visitas Agendadas</div>
                                    <div style="font-size:10px;opacity:0.9" id="countAgendados">10 visitas</div>
                                </div>
                            </div>
                            <div id="listaAgendados" style="flex:1;overflow-y:auto;padding:8px"><div style="font-size:9px;font-weight:700;color:#6b7280;margin-bottom:6px;padding:6px;background:#f3f4f6;border-radius:4px;display:flex;align-items:center;gap:6px">⏳ PENDIENTES <span style="background:#6b7280;color:#fff;padding:2px 6px;border-radius:10px;font-size:8px">10</span></div><div style="background:#f3f4f6;border-radius:6px;padding:10px;margin-bottom:6px;border-left:4px solid #9ca3af;font-size:10px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <span style="font-weight:700;color:#b8960c">4AZE</span>
                        <div style="display:flex;gap:4px;align-items:center">
                            <span style="font-size:7px;color:#fff;background:#C9A227;padding:2px 6px;border-radius:10px;font-weight:600">Ariannys</span>
                            <span style="font-size:8px;color:#6b7280;background:#fff;padding:2px 6px;border-radius:4px">2025-12-18</span>
                        </div>
                    </div>
                    <div style="font-weight:600;color:#333;margin-bottom:6px">ZARAGOZA Tenor Fleta</div>
                    <div style="display:flex;gap:4px;flex-wrap:wrap">
                        <button onclick="comenzarEvaluacion('4AZE')" style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:8px;cursor:pointer;font-weight:700;flex:1">🚀 COMENZAR EVALUACIÓN</button>
                    </div>
                    <div style="display:flex;gap:4px;margin-top:4px">
                        <button onclick="verCentro('4AZE')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Ver">👁️ Ver</button>
                        <button onclick="editarVisita('4AZE')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Editar">✏️ Editar</button>
                        <button onclick="cancelarVisita('4AZE')" style="background:#5c5c5c;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Borrar">🗑️ Borrar</button>
                    </div>
                </div><div style="background:#f3f4f6;border-radius:6px;padding:10px;margin-bottom:6px;border-left:4px solid #9ca3af;font-size:10px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <span style="font-weight:700;color:#b8960c">4AYN</span>
                        <div style="display:flex;gap:4px;align-items:center">
                            <span style="font-size:7px;color:#fff;background:#C9A227;padding:2px 6px;border-radius:10px;font-weight:600">Ariannys</span>
                            <span style="font-size:8px;color:#6b7280;background:#fff;padding:2px 6px;border-radius:4px">2025-12-18</span>
                        </div>
                    </div>
                    <div style="font-weight:600;color:#333;margin-bottom:6px">ZARAGOZA SOBRARBE</div>
                    <div style="display:flex;gap:4px;flex-wrap:wrap">
                        <button onclick="comenzarEvaluacion('4AYN')" style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:8px;cursor:pointer;font-weight:700;flex:1">🚀 COMENZAR EVALUACIÓN</button>
                    </div>
                    <div style="display:flex;gap:4px;margin-top:4px">
                        <button onclick="verCentro('4AYN')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Ver">👁️ Ver</button>
                        <button onclick="editarVisita('4AYN')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Editar">✏️ Editar</button>
                        <button onclick="cancelarVisita('4AYN')" style="background:#5c5c5c;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Borrar">🗑️ Borrar</button>
                    </div>
                </div><div style="background:#f3f4f6;border-radius:6px;padding:10px;margin-bottom:6px;border-left:4px solid #9ca3af;font-size:10px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <span style="font-weight:700;color:#b8960c">4ZST</span>
                        <div style="display:flex;gap:4px;align-items:center">
                            <span style="font-size:7px;color:#fff;background:#C9A227;padding:2px 6px;border-radius:10px;font-weight:600">Ariannys</span>
                            <span style="font-size:8px;color:#6b7280;background:#fff;padding:2px 6px;border-radius:4px">2025-12-18</span>
                        </div>
                    </div>
                    <div style="font-weight:600;color:#333;margin-bottom:6px">ZARAGOZA C/Santa Teresa</div>
                    <div style="display:flex;gap:4px;flex-wrap:wrap">
                        <button onclick="comenzarEvaluacion('4ZST')" style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:8px;cursor:pointer;font-weight:700;flex:1">🚀 COMENZAR EVALUACIÓN</button>
                    </div>
                    <div style="display:flex;gap:4px;margin-top:4px">
                        <button onclick="verCentro('4ZST')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Ver">👁️ Ver</button>
                        <button onclick="editarVisita('4ZST')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Editar">✏️ Editar</button>
                        <button onclick="cancelarVisita('4ZST')" style="background:#5c5c5c;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Borrar">🗑️ Borrar</button>
                    </div>
                </div><div style="background:#f3f4f6;border-radius:6px;padding:10px;margin-bottom:6px;border-left:4px solid #9ca3af;font-size:10px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <span style="font-weight:700;color:#b8960c">4CLL</span>
                        <div style="display:flex;gap:4px;align-items:center">
                            <span style="font-size:7px;color:#fff;background:#8B7355;padding:2px 6px;border-radius:10px;font-weight:600">Sonia</span>
                            <span style="font-size:8px;color:#6b7280;background:#fff;padding:2px 6px;border-radius:4px">2026-01-09</span>
                        </div>
                    </div>
                    <div style="font-weight:600;color:#333;margin-bottom:6px">LLEIDA CC CARREFOUR</div>
                    <div style="display:flex;gap:4px;flex-wrap:wrap">
                        <button onclick="comenzarEvaluacion('4CLL')" style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:8px;cursor:pointer;font-weight:700;flex:1">🚀 COMENZAR EVALUACIÓN</button>
                    </div>
                    <div style="display:flex;gap:4px;margin-top:4px">
                        <button onclick="verCentro('4CLL')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Ver">👁️ Ver</button>
                        <button onclick="editarVisita('4CLL')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Editar">✏️ Editar</button>
                        <button onclick="cancelarVisita('4CLL')" style="background:#5c5c5c;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Borrar">🗑️ Borrar</button>
                    </div>
                </div><div style="background:#f3f4f6;border-radius:6px;padding:10px;margin-bottom:6px;border-left:4px solid #9ca3af;font-size:10px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <span style="font-weight:700;color:#b8960c">4LER</span>
                        <div style="display:flex;gap:4px;align-items:center">
                            <span style="font-size:7px;color:#fff;background:#8B7355;padding:2px 6px;border-radius:10px;font-weight:600">Sonia</span>
                            <span style="font-size:8px;color:#6b7280;background:#fff;padding:2px 6px;border-radius:4px">2026-01-09</span>
                        </div>
                    </div>
                    <div style="font-weight:600;color:#333;margin-bottom:6px">LLEIDA</div>
                    <div style="display:flex;gap:4px;flex-wrap:wrap">
                        <button onclick="comenzarEvaluacion('4LER')" style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:8px;cursor:pointer;font-weight:700;flex:1">🚀 COMENZAR EVALUACIÓN</button>
                    </div>
                    <div style="display:flex;gap:4px;margin-top:4px">
                        <button onclick="verCentro('4LER')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Ver">👁️ Ver</button>
                        <button onclick="editarVisita('4LER')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Editar">✏️ Editar</button>
                        <button onclick="cancelarVisita('4LER')" style="background:#5c5c5c;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Borrar">🗑️ Borrar</button>
                    </div>
                </div><div style="background:#f3f4f6;border-radius:6px;padding:10px;margin-bottom:6px;border-left:4px solid #9ca3af;font-size:10px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <span style="font-weight:700;color:#b8960c">4AHR</span>
                        <div style="display:flex;gap:4px;align-items:center">
                            <span style="font-size:7px;color:#fff;background:#C9A227;padding:2px 6px;border-radius:10px;font-weight:600">Ariannys</span>
                            <span style="font-size:8px;color:#6b7280;background:#fff;padding:2px 6px;border-radius:4px">2026-01-12</span>
                        </div>
                    </div>
                    <div style="font-weight:600;color:#333;margin-bottom:6px">VILAGARCIA DE AUROSA</div>
                    <div style="display:flex;gap:4px;flex-wrap:wrap">
                        <button onclick="comenzarEvaluacion('4AHR')" style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:8px;cursor:pointer;font-weight:700;flex:1">🚀 COMENZAR EVALUACIÓN</button>
                    </div>
                    <div style="display:flex;gap:4px;margin-top:4px">
                        <button onclick="verCentro('4AHR')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Ver">👁️ Ver</button>
                        <button onclick="editarVisita('4AHR')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Editar">✏️ Editar</button>
                        <button onclick="cancelarVisita('4AHR')" style="background:#5c5c5c;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Borrar">🗑️ Borrar</button>
                    </div>
                </div><div style="background:#f3f4f6;border-radius:6px;padding:10px;margin-bottom:6px;border-left:4px solid #9ca3af;font-size:10px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <span style="font-weight:700;color:#b8960c">4AVN</span>
                        <div style="display:flex;gap:4px;align-items:center">
                            <span style="font-size:7px;color:#fff;background:#C9A227;padding:2px 6px;border-radius:10px;font-weight:600">Ariannys</span>
                            <span style="font-size:8px;color:#6b7280;background:#fff;padding:2px 6px;border-radius:4px">2026-01-12</span>
                        </div>
                    </div>
                    <div style="font-weight:600;color:#333;margin-bottom:6px">CASTELAO</div>
                    <div style="display:flex;gap:4px;flex-wrap:wrap">
                        <button onclick="comenzarEvaluacion('4AVN')" style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:8px;cursor:pointer;font-weight:700;flex:1">🚀 COMENZAR EVALUACIÓN</button>
                    </div>
                    <div style="display:flex;gap:4px;margin-top:4px">
                        <button onclick="verCentro('4AVN')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Ver">👁️ Ver</button>
                        <button onclick="editarVisita('4AVN')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Editar">✏️ Editar</button>
                        <button onclick="cancelarVisita('4AVN')" style="background:#5c5c5c;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Borrar">🗑️ Borrar</button>
                    </div>
                </div><div style="background:#f3f4f6;border-radius:6px;padding:10px;margin-bottom:6px;border-left:4px solid #9ca3af;font-size:10px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <span style="font-weight:700;color:#b8960c">4AWG</span>
                        <div style="display:flex;gap:4px;align-items:center">
                            <span style="font-size:7px;color:#fff;background:#C9A227;padding:2px 6px;border-radius:10px;font-weight:600">Ariannys</span>
                            <span style="font-size:8px;color:#6b7280;background:#fff;padding:2px 6px;border-radius:4px">2026-01-13</span>
                        </div>
                    </div>
                    <div style="font-weight:600;color:#333;margin-bottom:6px">LUGO SANTO DOMINGO</div>
                    <div style="display:flex;gap:4px;flex-wrap:wrap">
                        <button onclick="comenzarEvaluacion('4AWG')" style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:8px;cursor:pointer;font-weight:700;flex:1">🚀 COMENZAR EVALUACIÓN</button>
                    </div>
                    <div style="display:flex;gap:4px;margin-top:4px">
                        <button onclick="verCentro('4AWG')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Ver">👁️ Ver</button>
                        <button onclick="editarVisita('4AWG')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Editar">✏️ Editar</button>
                        <button onclick="cancelarVisita('4AWG')" style="background:#5c5c5c;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Borrar">🗑️ Borrar</button>
                    </div>
                </div><div style="background:#f3f4f6;border-radius:6px;padding:10px;margin-bottom:6px;border-left:4px solid #9ca3af;font-size:10px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <span style="font-weight:700;color:#b8960c">4AWF</span>
                        <div style="display:flex;gap:4px;align-items:center">
                            <span style="font-size:7px;color:#fff;background:#C9A227;padding:2px 6px;border-radius:10px;font-weight:600">Ariannys</span>
                            <span style="font-size:8px;color:#6b7280;background:#fff;padding:2px 6px;border-radius:4px">2026-01-13</span>
                        </div>
                    </div>
                    <div style="font-weight:600;color:#333;margin-bottom:6px">LUGO</div>
                    <div style="display:flex;gap:4px;flex-wrap:wrap">
                        <button onclick="comenzarEvaluacion('4AWF')" style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:8px;cursor:pointer;font-weight:700;flex:1">🚀 COMENZAR EVALUACIÓN</button>
                    </div>
                    <div style="display:flex;gap:4px;margin-top:4px">
                        <button onclick="verCentro('4AWF')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Ver">👁️ Ver</button>
                        <button onclick="editarVisita('4AWF')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Editar">✏️ Editar</button>
                        <button onclick="cancelarVisita('4AWF')" style="background:#5c5c5c;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Borrar">🗑️ Borrar</button>
                    </div>
                </div><div style="background:#f3f4f6;border-radius:6px;padding:10px;margin-bottom:6px;border-left:4px solid #9ca3af;font-size:10px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <span style="font-weight:700;color:#b8960c">4AIR</span>
                        <div style="display:flex;gap:4px;align-items:center">
                            <span style="font-size:7px;color:#fff;background:#C9A227;padding:2px 6px;border-radius:10px;font-weight:600">Ariannys</span>
                            <span style="font-size:8px;color:#6b7280;background:#fff;padding:2px 6px;border-radius:4px">2026-01-14</span>
                        </div>
                    </div>
                    <div style="font-weight:600;color:#333;margin-bottom:6px">C.C. PONTEVELLA</div>
                    <div style="display:flex;gap:4px;flex-wrap:wrap">
                        <button onclick="comenzarEvaluacion('4AIR')" style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:8px;cursor:pointer;font-weight:700;flex:1">🚀 COMENZAR EVALUACIÓN</button>
                    </div>
                    <div style="display:flex;gap:4px;margin-top:4px">
                        <button onclick="verCentro('4AIR')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Ver">👁️ Ver</button>
                        <button onclick="editarVisita('4AIR')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Editar">✏️ Editar</button>
                        <button onclick="cancelarVisita('4AIR')" style="background:#5c5c5c;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Borrar">🗑️ Borrar</button>
                    </div>
                </div></div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- DESPLEGABLE: LISTADO COMPLETO DE CENTROS -->
                <div style="padding:0 10px 10px 10px">
                    <div onclick="toggleListadoCentrosCalendario()" style="background:linear-gradient(135deg,#C9A227,#B08D1E);padding:10px 15px;border-radius:6px;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
                        <div style="display:flex;align-items:center;gap:10px">
                            <span style="font-size:16px">📋</span>
                            <span style="color:#fff;font-weight:700;font-size:13px">Listado Completo de Centros</span>
                            <span id="calListadoCount" style="background:rgba(255,255,255,0.2);color:#fff;padding:2px 8px;border-radius:10px;font-size:11px">0 centros</span>
                        </div>
                        <span id="calListadoToggle" style="color:#fff;font-size:12px">▶ Expandir</span>
                    </div>
                    <div id="calListadoContainer" style="display:none;background:#fff;border:2px solid #9ca3af;border-top:none;border-radius:0 0 6px 6px">
                        <!-- Filtros -->
                        <div style="padding:10px;background:#f8f8f8;border-bottom:1px solid #e0e0e0;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                            <input type="text" id="calListadoBuscar" placeholder="🔍 Buscar centro..." oninput="filtrarListadoCentrosCalendario()" style="flex:1;min-width:150px;padding:6px 10px;border:1px solid #d1d5db;border-radius:4px;font-size:11px">
                            <select id="calListadoFiltroDelegReg" onchange="filtrarListadoCentrosCalendario()" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:10px;min-width:140px">
                                <option value="">Todos Deleg. Regionales</option>
                                <option value="Blanca Fernández de la Pradilla">Blanca Fernández de la Pradilla</option>
                                <option value="Cecilia Pérez">Cecilia Pérez</option>
                                <option value="Daniel Chazo">Daniel Chazo</option>
                                <option value="Eneritz Aranguren">Eneritz Aranguren</option>
                                <option value="Laura Plazas">Laura Plazas</option>
                                <option value="Laura Ramos">Laura Ramos</option>
                                <option value="Manuel Cánovas">Manuel Cánovas</option>
                                <option value="Maribel Amezcua">Maribel Amezcua</option>
                                <option value="Marisa Carmona">Marisa Carmona</option>
                                <option value="Martín Sebastián">Martín Sebastián</option>
                                <option value="Sergio Perán">Sergio Perán</option>
                                <option value="Sonia Godino">Sonia Godino</option>
                                <option value="Verónica Alfonsín">Verónica Alfonsín</option>
                            </select>
                            <select id="calListadoFiltroDelegAudio" onchange="filtrarListadoCentrosCalendario()" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:10px;min-width:120px">
                                <option value="">Todos Deleg. Audio</option>
                                <option value="ARY">Ariannys Rojas</option>
                                <option value="SGUASQUE">Sonia Guasque</option>
                            </select>
                            <select id="calListadoFiltroEstado" onchange="filtrarListadoCentrosCalendario()" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:10px;min-width:120px">
                                <option value="">Todos estados</option>
                                <option value="visitado">✅ V.Proceso</option>
                                <option value="pendiente_informe">👁 V.Puntual</option>
                                <option value="agendado">📅 Agendados</option>
                                <option value="pendiente">⏳ Pendientes</option>
                            </select>
                            <select id="calListadoFiltroPropiedad" onchange="filtrarListadoCentrosCalendario()" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:10px;min-width:100px">
                                <option value="">🏢 Propiedad</option>
                                <option value="SUCURSAL">Sucursales</option>
                                <option value="FRANQUICIA">Franquicias</option>
                            </select>
                            <select id="calListadoFiltroPerimetro" onchange="filtrarListadoCentrosCalendario()" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:10px;min-width:100px">
                                <option value="">📊 Perímetro</option>
                                <option value="PC">PC</option>
                                <option value="PNC">PNC</option>
                            </select>
                        </div>
                        <!-- Leyenda -->
                        <div style="padding:6px 10px;background:#fefce8;border-bottom:1px solid #e0e0e0;display:flex;gap:15px;flex-wrap:wrap;font-size:10px">
                            <div style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#f59e0b;border-radius:2px;display:inline-block"></span> Agendado (con fecha futura)</div>
                            <div style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#10b981;border-radius:2px;display:inline-block"></span> Visitado (fecha pasada)</div>
                            <div style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#ef4444;border-radius:2px;display:inline-block"></span> Pendiente (sin agendar)</div>
                        </div>
                        <!-- Tabla -->
                        <div style="max-height:400px;overflow:auto">
                            <table id="calListadoTabla" style="width:100%;border-collapse:collapse;font-size:11px">
                                <thead style="position:sticky;top:0;background:#1a1a1a;color:#fff;z-index:1">
                                    <tr>
                                        <th style="padding:8px 6px;text-align:left;font-weight:600;width:70px">CÓDIGO</th>
                                        <th style="padding:8px 6px;text-align:left;font-weight:600">CENTRO</th>
                                        <th style="padding:8px 6px;text-align:center;font-weight:600;width:130px">DELEG. REGIONAL</th>
                                        <th style="padding:8px 6px;text-align:center;font-weight:600;width:110px">DELEG. AUDIO</th>
                                        <th style="padding:8px 6px;text-align:center;font-weight:600;width:100px">AGENDADO</th>
                                        <th style="padding:8px 6px;text-align:center;font-weight:600;width:90px">VISITADO</th>
                                        <th style="padding:8px 6px;text-align:center;font-weight:600;width:90px">ESTADO</th>
                                    </tr>
                                </thead>
                                <tbody id="calListadoTbody">
                                    <tr><td colspan="7" style="padding:20px;text-align:center;color:#888">Cargando centros...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Resumen inferior -->
                        <div id="calListadoResumen" style="padding:8px 12px;background:#f3f4f6;border-top:1px solid #e0e0e0;font-size:10px;color:#666;display:flex;gap:15px;flex-wrap:wrap"></div>
                    </div>
                </div>
                
                <!-- Modal Agendar Visita -->
                <div id="modalAgendar" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;align-items:center;justify-content:center;padding:20px">
                    <div style="background:#fff;border-radius:10px;max-width:520px;width:100%;border:3px solid #C9A227">
                        <div style="padding:12px 16px;border-bottom:3px solid #C9A227;background:linear-gradient(135deg,#2d2d2d,#1a1a1a)">
                            <h3 style="margin:0;font-size:14px;font-weight:700;color:#C9A227">📅 Agendar Visita</h3>
                        </div>
                        <div style="padding:16px">
                            <div id="agendarCentroInfo" style="background:#f5f5f5;padding:10px;border-radius:6px;margin-bottom:12px;font-size:11px"></div>
                            <div style="margin-bottom:12px">
                                <label style="font-size:10px;font-weight:600;color:#666;display:block;margin-bottom:4px">Fecha de la visita</label>
                                <input type="date" id="agendarFecha" onchange="mostrarDisponibilidadAgendar()" style="width:100%;padding:8px;border:1px solid #C9A227;border-radius:6px;font-size:12px">
                            </div>
                            <div style="margin-bottom:12px">
                                <label style="font-size:10px;font-weight:600;color:#666;display:block;margin-bottom:6px">Cuadrantes a ocupar <span style="font-size:8px;color:#999">(selecciona uno o varios)</span></label>
                                <div class="cal-turno-sel" style="grid-template-columns:1fr 1fr 1fr 1fr;display:grid;gap:6px">
                                    <div class="cal-turno-btn active" id="turnoQ1" onclick="toggleCuadrante(1)"><div style="font-size:14px">☀️</div><div style="font-size:8px">1 · Mañana</div></div>
                                    <div class="cal-turno-btn" id="turnoQ2" onclick="toggleCuadrante(2)"><div style="font-size:14px">📋</div><div style="font-size:8px">2 · ½ Mañana</div></div>
                                    <div class="cal-turno-btn" id="turnoQ3" onclick="toggleCuadrante(3)"><div style="font-size:14px">🌙</div><div style="font-size:8px">3 · Tarde</div></div>
                                    <div class="cal-turno-btn" id="turnoQ4" onclick="toggleCuadrante(4)"><div style="font-size:14px">📌</div><div style="font-size:8px">4 · + Tarde</div></div>
                                </div>
                                <div style="display:flex;gap:6px;margin-top:6px">
                                    <button onclick="selPreset('manana')" style="flex:1;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:8px;cursor:pointer;background:#fff">☀ 1+2</button>
                                    <button onclick="selPreset('tarde')" style="flex:1;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:8px;cursor:pointer;background:#fff">🌙 3+4</button>
                                    <button onclick="selPreset('todo')" style="flex:1;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:8px;cursor:pointer;background:#fff">📅 Todo</button>
                                    <button onclick="selPreset('ninguno')" style="flex:1;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:8px;cursor:pointer;background:#fff">✕ Limpiar</button>
                                </div>
                            </div>
                            <div id="agendarDisponibilidad" style="margin-bottom:12px"></div>
                            <div style="display:flex;gap:8px;flex-wrap:wrap">
                                <button onclick="confirmarAgendar()" style="flex:1;min-width:80px;background:#C9A227;color:#fff;border:none;padding:10px;border-radius:6px;font-weight:600;cursor:pointer">✓ Agendar</button>
                                <button onclick="cerrarModalAgendar()" style="flex:1;min-width:80px;background:#6b7280;color:#fff;border:none;padding:10px;border-radius:6px;font-weight:600;cursor:pointer">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Editar Centro -->
                <div id="modalEditarCentro" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;align-items:center;justify-content:center;padding:20px">
                    <div style="background:#fff;border-radius:10px;max-width:450px;width:100%;border:3px solid #C9A227">
                        <div style="padding:12px 16px;border-bottom:3px solid #C9A227;background:linear-gradient(135deg,#2d2d2d,#1a1a1a)">
                            <h3 style="margin:0;font-size:14px;font-weight:700;color:#C9A227">✏️ Editar Centro</h3>
                        </div>
                        <div style="padding:16px">
                            <div style="margin-bottom:10px">
                                <label style="font-size:10px;font-weight:600;color:#666;display:block;margin-bottom:4px">Código</label>
                                <input type="text" id="editCentroCodigo" readonly="" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px;background:#f5f5f5">
                            </div>
                            <div style="margin-bottom:10px">
                                <label style="font-size:10px;font-weight:600;color:#666;display:block;margin-bottom:4px">Nombre</label>
                                <input type="text" id="editCentroNombre" style="width:100%;padding:8px;border:1px solid #C9A227;border-radius:6px;font-size:11px">
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
                                <div>
                                    <label style="font-size:10px;font-weight:600;color:#666;display:block;margin-bottom:4px">Estado AAR</label>
                                    <select id="editCentroAAR" style="width:100%;padding:8px;border:1px solid #C9A227;border-radius:6px;font-size:11px">
                                        <option value="NO">Sin AAR</option>
                                        <option value="FORMACION">📚 En Formación</option>
                                        <option value="CERTIFICADO">✅ Certificado</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:10px;font-weight:600;color:#666;display:block;margin-bottom:4px">Tipo Centro</label>
                                    <select id="editCentroTipo" style="width:100%;padding:8px;border:1px solid #C9A227;border-radius:6px;font-size:11px">
                                        <option value="CORNER">🏪 Córner</option>
                                        <option value="EXCLUSIVO">🏆 Exclusivo</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display:flex;gap:8px">
                                <button onclick="guardarEditarCentro()" style="flex:1;background:#C9A227;color:#fff;border:none;padding:10px;border-radius:6px;font-weight:600;cursor:pointer">💾 Guardar</button>
                                <button onclick="cerrarModalEditarCentro()" style="flex:1;background:#6b7280;color:#fff;border:none;padding:10px;border-radius:6px;font-weight:600;cursor:pointer">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Nuevo Centro -->
                <div id="modalNuevoCentro" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;align-items:center;justify-content:center;padding:20px">
                    <div style="background:#fff;border-radius:10px;max-width:450px;width:100%;border:3px solid #C9A227">
                        <div style="padding:12px 16px;border-bottom:3px solid #C9A227;background:linear-gradient(135deg,#2d2d2d,#1a1a1a)">
                            <h3 style="margin:0;font-size:14px;font-weight:700;color:#C9A227">➕ Nuevo Centro</h3>
                        </div>
                        <div style="padding:16px">
                            <input type="hidden" id="nuevoCentroResponsable">
                            <div style="display:grid;grid-template-columns:80px 1fr;gap:10px;margin-bottom:10px">
                                <div>
                                    <label style="font-size:10px;font-weight:600;color:#666;display:block;margin-bottom:4px">Código</label>
                                    <input type="text" id="nuevoCentroCodigo" maxlength="4" placeholder="4XXX" style="width:100%;padding:8px;border:1px solid #C9A227;border-radius:6px;font-size:11px;text-transform:uppercase">
                                </div>
                                <div>
                                    <label style="font-size:10px;font-weight:600;color:#666;display:block;margin-bottom:4px">Nombre del Centro</label>
                                    <input type="text" id="nuevoCentroNombre" placeholder="Nombre completo" style="width:100%;padding:8px;border:1px solid #C9A227;border-radius:6px;font-size:11px">
                                </div>
                            </div>
                            <div style="margin-bottom:10px">
                                <label style="font-size:10px;font-weight:600;color:#666;display:block;margin-bottom:4px">Propietario</label>
                                <input type="text" id="nuevoCentroPropietario" placeholder="Nombre propietario" style="width:100%;padding:8px;border:1px solid #C9A227;border-radius:6px;font-size:11px">
                            </div>
                            <div style="margin-bottom:10px">
                                <label style="font-size:10px;font-weight:600;color:#666;display:block;margin-bottom:4px">Delegado Regional</label>
                                <input type="text" id="nuevoCentroDelegado" placeholder="Nombre delegado" style="width:100%;padding:8px;border:1px solid #C9A227;border-radius:6px;font-size:11px">
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
                                <div>
                                    <label style="font-size:10px;font-weight:600;color:#666;display:block;margin-bottom:4px">Estado AAR</label>
                                    <select id="nuevoCentroAAR" style="width:100%;padding:8px;border:1px solid #C9A227;border-radius:6px;font-size:11px">
                                        <option value="NO">Sin AAR</option>
                                        <option value="FORMACION">📚 En Formación</option>
                                        <option value="CERTIFICADO">✅ Certificado</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:10px;font-weight:600;color:#666;display:block;margin-bottom:4px">Tipo Centro</label>
                                    <select id="nuevoCentroTipo" style="width:100%;padding:8px;border:1px solid #C9A227;border-radius:6px;font-size:11px">
                                        <option value="CORNER">🏪 Córner</option>
                                        <option value="EXCLUSIVO">🏆 Exclusivo</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display:flex;gap:8px">
                                <button onclick="guardarNuevoCentro()" style="flex:1;background:#C9A227;color:#fff;border:none;padding:10px;border-radius:6px;font-weight:600;cursor:pointer">➕ Crear Centro</button>
                                <button onclick="cerrarModalNuevoCentro()" style="flex:1;background:#6b7280;color:#fff;border:none;padding:10px;border-radius:6px;font-weight:600;cursor:pointer">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="section-guia-eval" class="section" style="overflow-y:auto">
                <div style="padding:10px">
                    <!-- Header faldón negro/gris -->
                    <div style="background:linear-gradient(135deg,#2d2d2d,#1a1a1a);color:#C9A227;padding:14px 20px;border-radius:10px;margin-bottom:14px;border-bottom:3px solid #C9A227;display:flex;align-items:center;gap:12px">
                        <span style="font-size:28px">🗺️</span>
                        <div>
                            <h3 style="margin:0;font-size:15px;font-weight:700">Evaluación + Guía</h3>
                            <p style="margin:3px 0 0 0;font-size:10px;color:#888">Guía de supervisión • Evaluación 100 criterios • 8 bloques</p>
                        </div>
                    </div>
                    
                    <!-- Pestañas internas -->
                    <div style="display:flex;gap:8px;margin-bottom:15px">
                        <button id="tab-eval" onclick="cambiarTabGuiaEval('eval')" style="flex:1;padding:10px 15px;background:#C9A227;color:#fff;border:none;border-radius:6px;font-weight:700;font-size:11px;cursor:pointer">✅ EVALUACIÓN</button>
                        <button id="tab-guia" onclick="cambiarTabGuiaEval('guia')" style="flex:1;padding:10px 15px;background:#4a4a4a;color:#888;border:none;border-radius:6px;font-weight:700;font-size:11px;cursor:pointer">🗺️ Guía DE VISITA</button>
                    </div>
                    
                    <!-- CONTENIDO GUÍA -->
                    <div id="contenido-guia" style="display:none">
                    
                    <!-- Mensaje motivacional gris claro -->
                    <div style="background:#f5f5f5;border-left:4px solid #C9A227;border-radius:8px;padding:12px 16px;margin-bottom:24px">
                        <p style="font-size:11px;color:#333;margin:0"><strong style="color:#C9A227">📋 Guía de supervisión:</strong> Verificar estándares, detectar oportunidades, comprobar procedimientos y definir plan de mejora.</p>
                        <p style="font-size:10px;color:#666;margin:4px 0 0 0;font-style:italic">Esta guía asegura criterios objetivos y justos para todas las visitas.</p>
                    </div>
                    
                    <!-- Sección Archivos Adjuntos -->
                    
                    <!-- Grid de 12 tarjetas TODAS DORADAS - centradas -->
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;max-width:1000px;margin:0 auto">
                        <!-- 1. 11 BÁSICOS -->
                        <div class="guia-card" onclick="openGuiaModal('basicos')" style="background:linear-gradient(135deg,#C9A227,#B8963D)">
                            <div class="guia-card-icon" style="background:#fff">🎧</div>
                            <div class="guia-card-content"><h4>11 BÁSICOS DE AUDIO</h4><p>Imagen · Presencia · Conocimiento</p></div>
                            <div class="guia-card-arrow">👁️</div>
                        </div>
                        <!-- 2. IMAGEN AUDIO -->
                        <div class="guia-card" onclick="openGuiaModal('imagen')" style="background:linear-gradient(135deg,#C9A227,#B8963D)">
                            <div class="guia-card-icon" style="background:#fff">🖼️</div>
                            <div class="guia-card-content"><h4>Imagen Audio</h4><p>Escaparate · Campañas · PLV</p></div>
                            <div class="guia-card-arrow">👁️</div>
                        </div>
                        <!-- 3. AGENDA -->
                        <div class="guia-card" onclick="openGuiaModal('agenda')" style="background:linear-gradient(135deg,#C9A227,#B8963D)">
                            <div class="guia-card-icon" style="background:#fff">📅</div>
                            <div class="guia-card-content"><h4>AGENDA</h4><p>Citas · Ocupación · Seguimiento</p></div>
                            <div class="guia-card-arrow">👁️</div>
                        </div>
                        <!-- 4. EQUIPO ÓPTICA -->
                        <div class="guia-card" onclick="openGuiaModal('equipo')" style="background:linear-gradient(135deg,#C9A227,#B8963D)">
                            <div class="guia-card-icon" style="background:#fff">👥</div>
                            <div class="guia-card-content"><h4>Equipo Óptica</h4><p>Integración · Screening · Derivación</p></div>
                            <div class="guia-card-arrow">👁️</div>
                        </div>
                        <!-- 5. FUNNEL -->
                        <div class="guia-card" onclick="openGuiaModal('funnel')" style="background:linear-gradient(135deg,#C9A227,#B8963D)">
                            <div class="guia-card-icon" style="background:#fff">📊</div>
                            <div class="guia-card-content"><h4>FUNNEL</h4><p>Tráfico · Conversión · Seguimiento</p></div>
                            <div class="guia-card-arrow">👁️</div>
                        </div>
                        <!-- 6. REVISIÓN TÉCNICA -->
                        <div class="guia-card" onclick="openGuiaModal('revision')" style="background:linear-gradient(135deg,#C9A227,#B8963D)">
                            <div class="guia-card-icon" style="background:#fff">🔧</div>
                            <div class="guia-card-content"><h4>Revisión Técnica</h4><p>Protocolo · Pruebas · HIT</p></div>
                            <div class="guia-card-arrow">👁️</div>
                        </div>
                        <!-- 7. INFINITY -->
                        <div class="guia-card" onclick="openGuiaModal('infinity')" style="background:linear-gradient(135deg,#C9A227,#B8963D)">
                            <div class="guia-card-icon" style="background:#fff">💳</div>
                            <div class="guia-card-content"><h4>INFINITY</h4><p>Financiación · Cuotas · Captación</p></div>
                            <div class="guia-card-arrow">👁️</div>
                        </div>
                        <!-- 8. SEGURO CASER -->
                        <div class="guia-card" onclick="openGuiaModal('seguro')" style="background:linear-gradient(135deg,#C9A227,#B8963D)">
                            <div class="guia-card-icon" style="background:#fff">🛡️</div>
                            <div class="guia-card-content"><h4>Seguro Caser</h4><p>Protección · Cobertura · Venta</p></div>
                            <div class="guia-card-arrow">👁️</div>
                        </div>
                        <!-- 9. SEGUIMIENTO -->
                        <div class="guia-card" onclick="openGuiaModal('seguimiento')" style="background:linear-gradient(135deg,#C9A227,#B8963D)">
                            <div class="guia-card-icon" style="background:#fff">📞</div>
                            <div class="guia-card-content"><h4>Seguimiento</h4><p>Llamadas · Control · Reagendas</p></div>
                            <div class="guia-card-arrow">👁️</div>
                        </div>
                        <!-- 10. GALERÍA -->
                        <div class="guia-card" onclick="openGuiaModal('galeria')" style="background:linear-gradient(135deg,#C9A227,#B8963D)">
                            <div class="guia-card-icon" style="background:#fff">📷</div>
                            <div class="guia-card-content"><h4>GALERÍA</h4><p>Elementos · Campañas · Otros</p></div>
                            <div class="guia-card-arrow">👁️</div>
                        </div>
                        <!-- 11. REPOSITORIO -->
                        <div class="guia-card" onclick="openGuiaModal('repositorio')" style="background:linear-gradient(135deg,#C9A227,#B8963D)">
                            <div class="guia-card-icon" style="background:#fff">📁</div>
                            <div class="guia-card-content"><h4>REPOSITORIO</h4><p>Contratos · Documentos</p></div>
                            <div class="guia-card-arrow">👁️</div>
                        </div>
                        <!-- 12. AFFLELOU CONTIGO -->
                        <div class="guia-card" onclick="openGuiaModal('affleloucontigo')" style="background:linear-gradient(135deg,#C9A227,#B8963D)">
                            <div class="guia-card-icon" style="background:#fff">💚</div>
                            <div class="guia-card-content"><h4>AFFLELOU CONTIGO</h4><p>Paquete bienestar · Teleasistencia</p></div>
                            <div class="guia-card-arrow">👁️</div>
                        </div>
                        <!-- 13. AYUDAS -->
                        <div class="guia-card" onclick="openGuiaModal('ayudas')" style="background:linear-gradient(135deg,#C9A227,#B8963D)">
                            <div class="guia-card-icon" style="background:#fff">🏛️</div>
                            <div class="guia-card-content"><h4>AYUDAS</h4><p>Subvenciones · CCAA · Procedimientos</p></div>
                            <div class="guia-card-arrow">👁️</div>
                        </div>
                        <!-- 14. ENLACES DE INTERÉS -->
                        <div class="guia-card" onclick="openGuiaModal('enlaces')" style="background:linear-gradient(135deg,#C9A227,#B8963D)">
                            <div class="guia-card-icon" style="background:#fff">🔗</div>
                            <div class="guia-card-content"><h4>Enlaces de Interés</h4><p>Academy · Recursos · Herramientas</p></div>
                            <div class="guia-card-arrow">👁️</div>
                        </div>
                        <!-- 15. BOTÓN COMPROBAMOS -->
                        <div class="guia-card" onclick="cambiarTabGuiaEval('eval')" style="background:linear-gradient(135deg,#8B7355,#6B5344);box-shadow:0 6px 20px rgba(0,0,0,0.35);cursor:pointer">
                            <div class="guia-card-icon" style="background:#fff">🚀</div>
                            <div class="guia-card-content"><h4>¡COMPROBAMOS!</h4><p>Ir a Evaluación...</p></div>
                            <div class="guia-card-arrow">▶️</div>
                        </div>
                    </div>
                    </div><!-- FIN contenido-guia -->
                
                <!-- CONTENIDO EVALUACIÓN -->
                <div id="contenido-eval" style="display:block">
                    <div id="eval-portada-interno" class="eval-section active">
                        <div class="eval-stats">
                            <div class="eval-stat s1"><div class="eval-stat-value">224</div><div class="eval-stat-label">Centros</div></div>
                            <div class="eval-stat s2"><div class="eval-stat-value" id="stat-evals-2">6</div><div class="eval-stat-label">Evaluaciones</div></div>
                            <div class="eval-stat s3"><div class="eval-stat-value" id="stat-prom-2">60%</div><div class="eval-stat-label">Promedio</div></div>
                            <div class="eval-stat s4"><div class="eval-stat-value" id="stat-mes-2">6</div><div class="eval-stat-label">Este Mes</div></div>
                        </div>
                        <div class="eval-content">
                            <div class="eval-left">
                                <div class="panel">
                                    <div class="panel-title">📋 Datos de la Visita</div>
                                    <div class="form-row"><div style="position:relative"><label class="form-label">Centro</label><input type="text" id="eval-centro-2" class="form-input" placeholder="Escribe para buscar centro..." autocomplete="off" oninput="mostrarSugerenciasCentro(this.value);buscarCentroEval2(this.value)" onfocus="mostrarSugerenciasCentro(this.value)"><div id="sugerencias-centro" style="display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #C9A227;border-radius:6px;max-height:200px;overflow-y:auto;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.15)"></div></div><div><label class="form-label">Fecha</label><input type="date" id="eval-fecha-2" class="form-input"></div></div>
                                    <div class="form-row"><div><label class="form-label">PC/PNC</label><input type="text" id="eval-pcpnc-2" class="form-input" readonly style="background:#f3f4f6;font-weight:700"></div><div><label class="form-label">Responsable</label><select id="eval-responsable-2" class="form-select"><option>Ariannys Rojas</option><option>Sonia Guasque</option></select></div></div>
                                    <button class="btn-comenzar" onclick="iniciarEvaluacion2()">🚀 COMENZAR EVALUACIÓN</button>
                                </div>
                                <div class="panel">
                                    <div class="panel-title">📊 8 Bloques</div>
                                    <div class="bloques-grid">
                                        <div class="bloque-card" style="background:linear-gradient(135deg,#C9A227,#B08D1E)"><div class="icon">🎧</div><div class="name">PIA</div><div class="peso">25%</div></div>
                                        <div class="bloque-card" style="background:linear-gradient(135deg,#5c5c5c,#4a4a4a)"><div class="icon">📚</div><div class="name">FORMACIÓN</div><div class="peso">15%</div></div>
                                        <div class="bloque-card" style="background:linear-gradient(135deg,#C9A227,#B8963D)"><div class="icon">📢</div><div class="name">Comunicación</div><div class="peso">15%</div></div>
                                        <div class="bloque-card" style="background:linear-gradient(135deg,#8b8b8b,#6b6b6b)"><div class="icon">💛</div><div class="name">AYUDAS</div><div class="peso">4%</div></div>
                                        <div class="bloque-card" style="background:linear-gradient(135deg,#7a7a7a,#4f46e5)"><div class="icon">➕</div><div class="name">Complementarias</div><div class="peso">6%</div></div>
                                        <div class="bloque-card" style="background:linear-gradient(135deg,#C9A227,#B08D1E)"><div class="icon">🏪</div><div class="name">RT</div><div class="peso">25%</div></div>
                                        <div class="bloque-card" style="background:linear-gradient(135deg,#d4af37,#0891b2)"><div class="icon">📅</div><div class="name">AGENDA</div><div class="peso">10%</div></div>
                                        <div class="bloque-card" style="background:linear-gradient(135deg,#C9A227,#a88b1e)"><div class="icon">💹</div><div class="name">CONVERSIONES</div><div class="peso">0%</div></div>
                                    </div>
                                </div>
                            </div>
                            <div class="panel panel-dark" style="overflow-y:auto;max-height:350px"><div class="panel-title" style="color:#fff;position:sticky;top:0;background:#3a3a3a;z-index:1;padding-bottom:8px">📄 Preinformes</div><div id="preinformes-lista-2"></div><div id="preinformes-empty-2" style="text-align: center; color: rgb(136, 136, 136); font-size: 10px; padding: 20px; display: none;">No hay preinformes</div></div>
                        </div>
                    </div>
                </div><!-- FIN contenido-eval -->
                
                <!-- Modal Guía -->
                <div id="modalGuia" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;align-items:center;justify-content:center;padding:20px">
                    <div style="background:#fff;border-radius:10px;max-width:600px;width:100%;max-height:85vh;overflow:hidden;border:3px solid #C9A227">
                        <div id="modalGuiaHeader" style="padding:12px 16px;border-bottom:3px solid #C9A227;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,#2d2d2d,#1a1a1a)">
                            <h3 id="modalGuiaTitle" style="margin:0;font-size:14px;font-weight:700;color:#C9A227">Título</h3>
                            <button onclick="closeGuiaModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#888">×</button>
                        </div>
                        <div id="modalGuiaBody" style="padding:16px;max-height:60vh;overflow-y:auto"></div>
                        <div style="padding:12px 16px;border-top:1px solid #e2e8f0;display:flex;justify-content:flex-end;background:#f5f5f5">
                            <button onclick="closeGuiaModal()" style="background:#C9A227;color:#fff;border:none;padding:8px 20px;border-radius:6px;font-weight:600;cursor:pointer">✓ Cerrar</button>
                        </div>
                    </div>
                </div>
                </div><!-- FIN div padding:10px -->
            </section>

            <section id="section-evaluacion" class="section">
                <div id="eval-portada" class="eval-section active">
                    <div class="eval-header"><div class="eval-header-icon">🎧</div><div><h2>Evaluación Audio</h2><p>100 criterios • 8 bloques • 13 obligatorias</p></div></div>
                    <div class="eval-stats">
                        <div class="eval-stat s1"><div class="eval-stat-value">224</div><div class="eval-stat-label">Centros</div></div>
                        <div class="eval-stat s2"><div class="eval-stat-value" id="stat-evals">6</div><div class="eval-stat-label">Evaluaciones</div></div>
                        <div class="eval-stat s3"><div class="eval-stat-value" id="stat-prom">60%</div><div class="eval-stat-label">Promedio</div></div>
                        <div class="eval-stat s4"><div class="eval-stat-value" id="stat-mes">6</div><div class="eval-stat-label">Este Mes</div></div>
                    </div>
                    <div class="eval-content">
                        <div class="eval-left">
                            <div class="panel">
                                <div class="panel-title">📋 Datos de la Visita</div>
                                <div class="form-row"><div><label class="form-label">Centro</label><input type="text" id="eval-centro" class="form-input" placeholder="Nombre del centro..." oninput="buscarCentroEval(this.value)" onblur="setTimeout(()=>cerrarResultadosCentroEval(),200)"><div id="eval-centro-resultados" style="display:none;position:absolute;background:#fff;border:1px solid #ddd;border-radius:4px;max-height:150px;overflow-y:auto;z-index:100;width:100%;box-shadow:0 2px 8px rgba(0,0,0,0.15)"></div></div><div><label class="form-label">Fecha</label><input type="date" id="eval-fecha" class="form-input"></div></div>
                                <div class="form-row"><div><label class="form-label">PC/PNC</label><input type="text" id="eval-pcpnc" class="form-input" readonly style="background:#f3f4f6;font-weight:700"></div><div><label class="form-label">Responsable</label><select id="eval-responsable" class="form-select"><option>Ariannys Rojas</option><option>Sonia Guasque</option></select></div></div>
                                <button class="btn-comenzar" onclick="iniciarEvaluacion()">🚀 COMENZAR EVALUACIÓN</button>
                            </div>
                            <div class="panel">
                                <div class="panel-title">📊 8 Bloques</div>
                                <div class="bloques-grid">
                                    <div class="bloque-card" style="background:linear-gradient(135deg,#C9A227,#B08D1E)"><div class="icon">🎧</div><div class="name">PIA</div><div class="peso">25%</div></div>
                                    <div class="bloque-card" style="background:linear-gradient(135deg,#5c5c5c,#4a4a4a)"><div class="icon">📚</div><div class="name">FORMACIÓN</div><div class="peso">15%</div></div>
                                    <div class="bloque-card" style="background:linear-gradient(135deg,#C9A227,#B8963D)"><div class="icon">📢</div><div class="name">Comunicación</div><div class="peso">15%</div></div>
                                    <div class="bloque-card" style="background:linear-gradient(135deg,#8b8b8b,#6b6b6b)"><div class="icon">💛</div><div class="name">AYUDAS</div><div class="peso">4%</div></div>
                                    <div class="bloque-card" style="background:linear-gradient(135deg,#7a7a7a,#4f46e5)"><div class="icon">➕</div><div class="name">Complementarias</div><div class="peso">6%</div></div>
                                    <div class="bloque-card" style="background:linear-gradient(135deg,#C9A227,#B08D1E)"><div class="icon">🏪</div><div class="name">RT</div><div class="peso">25%</div></div>
                                    <div class="bloque-card" style="background:linear-gradient(135deg,#d4af37,#0891b2)"><div class="icon">📅</div><div class="name">AGENDA</div><div class="peso">10%</div></div>
                                    <div class="bloque-card" style="background:linear-gradient(135deg,#C9A227,#a88b1e)"><div class="icon">💹</div><div class="name">CONVERSIONES</div><div class="peso">0%</div></div>
                                </div>
                            </div>
                        </div>
                        <div class="panel panel-dark" style="overflow-y:auto;max-height:350px"><div class="panel-title" style="color:#fff;position:sticky;top:0;background:#3a3a3a;z-index:1;padding-bottom:8px">📄 Preinformes</div><div id="preinformes-lista"><div class="preinforme-item"><div class="preinforme-top"><div class="preinforme-dot" style="background:#8b8b8b"></div><div class="preinforme-centro">prueba 2</div><div class="preinforme-score" style="color:#8b8b8b">91%</div></div><div class="preinforme-meta">2026-01-05 • aaa</div><div class="preinforme-btns"><button class="preinforme-btn ver" onclick="verPre(0)">👁️ Ver</button><button class="preinforme-btn" style="background:#C9A227;color:#fff" onclick="guardarPreinforme(0)">💾 Guardar</button><button class="preinforme-btn" style="background:#6b7280;color:#fff" onclick="irAInforme(0)">📄 Informe</button><button class="preinforme-btn borrar" onclick="borrarPre(0)">🗑️</button><button class="preinforme-btn pdf" onclick="pdfPre(0)">📄 PDF</button></div></div><div class="preinforme-item"><div class="preinforme-top"><div class="preinforme-dot" style="background:#dc2626"></div><div class="preinforme-centro">C.C. PONTEVELLA</div><div class="preinforme-score" style="color:#dc2626">66%</div></div><div class="preinforme-meta">2026-01-14 • Cristina s</div><div class="preinforme-btns"><button class="preinforme-btn ver" onclick="verPre(1)">👁️ Ver</button><button class="preinforme-btn" style="background:#C9A227;color:#fff" onclick="guardarPreinforme(1)">💾 Guardar</button><button class="preinforme-btn" style="background:#6b7280;color:#fff" onclick="irAInforme(1)">📄 Informe</button><button class="preinforme-btn borrar" onclick="borrarPre(1)">🗑️</button><button class="preinforme-btn pdf" onclick="pdfPre(1)">📄 PDF</button></div></div><div class="preinforme-item"><div class="preinforme-top"><div class="preinforme-dot" style="background:#dc2626"></div><div class="preinforme-centro">LUGO</div><div class="preinforme-score" style="color:#dc2626">68%</div></div><div class="preinforme-meta">2026-01-13 • alberto</div><div class="preinforme-btns"><button class="preinforme-btn ver" onclick="verPre(2)">👁️ Ver</button><button class="preinforme-btn" style="background:#C9A227;color:#fff" onclick="guardarPreinforme(2)">💾 Guardar</button><button class="preinforme-btn" style="background:#6b7280;color:#fff" onclick="irAInforme(2)">📄 Informe</button><button class="preinforme-btn borrar" onclick="borrarPre(2)">🗑️</button><button class="preinforme-btn pdf" onclick="pdfPre(2)">📄 PDF</button></div></div><div class="preinforme-item"><div class="preinforme-top"><div class="preinforme-dot" style="background:#dc2626"></div><div class="preinforme-centro">LUGO SANTO DOMINGO</div><div class="preinforme-score" style="color:#dc2626">0%</div></div><div class="preinforme-meta">2026-01-13 • Maria</div><div class="preinforme-btns"><button class="preinforme-btn ver" onclick="verPre(3)">👁️ Ver</button><button class="preinforme-btn" style="background:#C9A227;color:#fff" onclick="guardarPreinforme(3)">💾 Guardar</button><button class="preinforme-btn" style="background:#6b7280;color:#fff" onclick="irAInforme(3)">📄 Informe</button><button class="preinforme-btn borrar" onclick="borrarPre(3)">🗑️</button><button class="preinforme-btn pdf" onclick="pdfPre(3)">📄 PDF</button></div></div><div class="preinforme-item"><div class="preinforme-top"><div class="preinforme-dot" style="background:#dc2626"></div><div class="preinforme-centro">CASTELAO</div><div class="preinforme-score" style="color:#dc2626">61%</div></div><div class="preinforme-meta">2026-01-12 • Maria i</div><div class="preinforme-btns"><button class="preinforme-btn ver" onclick="verPre(4)">👁️ Ver</button><button class="preinforme-btn" style="background:#C9A227;color:#fff" onclick="guardarPreinforme(4)">💾 Guardar</button><button class="preinforme-btn" style="background:#6b7280;color:#fff" onclick="irAInforme(4)">📄 Informe</button><button class="preinforme-btn borrar" onclick="borrarPre(4)">🗑️</button><button class="preinforme-btn pdf" onclick="pdfPre(4)">📄 PDF</button></div></div><div class="preinforme-item"><div class="preinforme-top"><div class="preinforme-dot" style="background:#dc2626"></div><div class="preinforme-centro">VILAGARCIA DE AUROSA</div><div class="preinforme-score" style="color:#dc2626">71%</div></div><div class="preinforme-meta">2026-01-12 • Doris</div><div class="preinforme-btns"><button class="preinforme-btn ver" onclick="verPre(5)">👁️ Ver</button><button class="preinforme-btn" style="background:#C9A227;color:#fff" onclick="guardarPreinforme(5)">💾 Guardar</button><button class="preinforme-btn" style="background:#6b7280;color:#fff" onclick="irAInforme(5)">📄 Informe</button><button class="preinforme-btn borrar" onclick="borrarPre(5)">🗑️</button><button class="preinforme-btn pdf" onclick="pdfPre(5)">📄 PDF</button></div></div></div><div id="preinformes-empty" style="text-align: center; color: rgb(136, 136, 136); font-size: 10px; padding: 20px; display: none;">No hay preinformes</div></div>
                    </div>
                </div>
                <div id="eval-instrucciones" class="eval-section">
                    <div style="display:flex;align-items:center;justify-content:center;min-height:calc(100vh - 120px);padding:20px">
                        <div style="max-width:500px;width:100%;text-align:center">
                            <div style="font-size:50px;margin-bottom:8px">🎧</div>
                            <h2 style="font-size:22px;color:#333;margin-bottom:16px">Antes de comenzar...</h2>
                            <div style="background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.1);text-align:left">
                                <p style="font-size:12px;color:#666;margin-bottom:16px;line-height:1.5">Por favor, introduce los siguientes datos del audiólogo evaluado:</p>
                                <div style="margin-bottom:12px">
                                    <label style="display:block;font-size:11px;font-weight:600;color:#333;margin-bottom:4px">👤 Nombre del Audiólogo</label>
                                    <input type="text" id="eval-nombre-audiologo" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px" placeholder="Ej: María García" onkeydown="if(event.key==='Enter'){document.getElementById('eval-horas-servicio').focus();}">
                                </div>
                                <div style="margin-bottom:16px">
                                    <label style="display:block;font-size:11px;font-weight:600;color:#333;margin-bottom:4px">⏱️ Horas de Servicio en Centro</label>
                                    <input type="number" id="eval-horas-servicio" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px" placeholder="Ej: 25" min="0" onkeydown="if(event.key==='Enter'){comenzarPreguntasEvaluacion();}">
                                    <p style="font-size:9px;color:#888;margin-top:4px">Mínimo recomendado: 20 horas</p>
                                </div>
                                <button onclick="comenzarPreguntasEvaluacion()" style="width:100%;padding:12px;background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer">▶️ COMENZAR PREGUNTAS</button>
                            </div>
                            <button onclick="volverPortadaEval()" style="margin-top:12px;padding:8px 16px;background:none;border:1px solid #ccc;border-radius:6px;color:#666;font-size:11px;cursor:pointer">← Volver</button>
                        </div>
                    </div>
                </div>
                <div id="eval-dinamica" class="eval-dinamica">
                    <div class="progress-section">
                        <div class="progress-header"><div style="display:flex;align-items:center;gap:10px"><div id="bloque-badge" class="bloque-badge" style="background: linear-gradient(135deg, rgb(34, 197, 94), rgb(22, 163, 74));">CONVERSIONES</div><span style="color:#888;font-size:10px">Peso: <strong id="bloque-peso">0%</strong></span></div><div style="font-size:11px;color:#888"><strong id="q-current">100</strong> / <span id="q-total">100</span></div></div>
                        <div class="progress-bar"><div id="progress-fill" class="progress-fill" style="width: 100%; background: linear-gradient(135deg, rgb(34, 197, 94), rgb(22, 163, 74));"></div></div>
                    </div>
                    <div class="question-card">
                        <div id="obligatoria-badge" class="obligatoria-badge">⚠️ OBLIGATORIA - Si NO = 0%</div>
                        <div id="q-number" class="question-number">100</div>
                        <p id="q-text" class="question-text">% Conversión a Venta (ideal 80%)</p>
                        <div class="question-valor"><span>Valor: <strong id="q-valor">0</strong> puntos</span></div>
                        <div class="detalle-box"><div class="detalle-title">📖 Detalle del criterio</div><div id="q-detalle" class="detalle-text">El criterio de una conversión a Venta óptimo sería a partir del 80%. En caso de valores inferiores debemos repasar en detalle la Anamnesis, expectativas del paciente y familiares, formato, comodidad, colocación, prestaciones, realizar campo libre para demostrar la ganancia de entendimiento y en caso de ser usuario realizar HIT de sus audífonos. Todo ello ayudará a identificar la objeción verdadera a la que hay que focalizar. Recomendado hacer cursos en Academy y Píldoras-Mentoring.</div></div>
                        <div id="agenda-box" class="agenda-box">
                            <div class="agenda-title">📊 Cálculo Automático de Agenda</div>
                            <div class="agenda-grid">
                                <div class="agenda-item"><div class="agenda-label">1ª Visitas</div><div id="ag-1v" class="agenda-value">8</div></div>
                                <div class="agenda-item"><div class="agenda-label">Revisiones</div><div id="ag-rev" class="agenda-value">2</div></div>
                                <div class="agenda-item"><div class="agenda-label">% 1ª Visitas (≥75%)</div><div id="ag-pct1" class="agenda-value verde">80%</div></div>
                                <div class="agenda-item"><div class="agenda-label">% Revisiones</div><div id="ag-pct2" class="agenda-value">20%</div></div>
                            </div>
                        </div>
                        <div id="btns-binario" class="buttons-row hidden"><button class="btn-no" onclick="responder('no')">✗ NO</button><button class="btn-si" onclick="responder('si')">✓ SÍ</button></div>
                        <div id="btns-numerico" class="buttons-row numerico-row"><input type="number" id="input-num" class="input-num" placeholder="0" inputmode="numeric" step="any"><button type="button" class="btn-continuar" onclick="responderNum()">Continuar →</button></div>
                    </div>
                    <div class="nav-row"><button class="btn-anterior" onclick="anterior()">← Anterior</button><button class="btn-cancelar" onclick="cancelar()">✕ Cancelar</button></div>
                </div>
                <div id="eval-informe" class="informe-section">
                    <div class="informe-btns">
                        <button class="informe-btn guardar" onclick="guardarPreinformeActual()">💾 Guardar</button>
                        <button class="informe-btn" style="background:#6b7280" onclick="irAInformeDesdePreinforme()">📄 Ir a Informe</button>
                        <button class="informe-btn" style="background:#3b82f6" onclick="window.print()">🖨️ Imprimir</button>
                        <button class="informe-btn" style="background:#6b7280" onclick="limpiarPreinforme()">🗑️ Limpiar</button>
                    </div>
                    <div id="informe-contenido">
                        <div class="informe-header"><div style="display:flex;justify-content:space-between;align-items:flex-start;width:100%"><div><div class="informe-badge">Informe de Evaluación</div><div id="inf-titulo" class="informe-titulo">Prueba</div><div id="inf-meta" class="informe-meta">2025-12-27 • - • Ariannys Rojas</div></div><div style="display:flex;gap:8px;align-items:center"><div id="inf-tipo-badge" style="padding:6px 12px;border-radius:6px;font-size:11px;font-weight:700;background:#C9A227;color:#1a1a1a">FRANQUICIA</div><div id="inf-pc-badge" style="padding:6px 12px;border-radius:6px;font-size:11px;font-weight:700;background:#10b981;color:#fff">PC</div></div></div></div>
                        <div id="resultado-integrado" style="background:linear-gradient(145deg,#f8f8f8,#f0f0f0);border-radius:12px;padding:20px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08)">
                            <div style="display:flex;gap:20px;align-items:stretch;flex-wrap:wrap">
                                <div style="flex:1;min-width:200px;display:flex;gap:15px;align-items:center">
                                    <div style="text-align:center;padding:15px 25px;background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.06)">
                                        <div style="font-size:10px;color:#888;font-weight:600;margin-bottom:4px">Resultado Final</div>
                                        <div id="res-valor" style="font-size:42px;font-weight:800;color:#22c55e;line-height:1">82%</div>
                                    </div>
                                    <div style="text-align:center;padding:15px 20px;background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.06)">
                                        <div id="res-emoji" style="font-size:36px">⭐</div>
                                        <div id="res-cat" style="display:inline-block;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;background:rgba(34,197,94,0.15);color:#22c55e">PRO</div>
                                    </div>
                                </div>
                                <div id="mensaje-personalizado" style="flex:2;min-width:280px;background:#fff;border-radius:10px;padding:15px;box-shadow:0 2px 6px rgba(0,0,0,0.06)">
                                    <div style="font-size:13px;font-weight:700;color:#333;margin-bottom:8px">👋 <span id="msg-nombre">Audiólogo</span>, aquí tienes tu resumen:</div>
                                    <div id="msg-fortalezas" style="margin-bottom:6px"><span style="font-size:10px;font-weight:600;color:#16a34a">✅ FORTALEZAS (≥80%):</span> <span style="font-size:11px;color:#333">-</span></div>
                                    <div id="msg-mejoras" style="margin-bottom:6px"><span style="font-size:10px;font-weight:600;color:#dc2626">⚠️ ÁREAS DE MEJORA:</span> <span style="font-size:11px;color:#333">-</span></div>
                                    <div id="msg-horas" style="padding-top:6px;border-top:1px dashed #e0e0e0;font-size:10px;color:#666">⏱️ Horas: <strong>-</strong></div>
                                </div>
                            </div>
                            <div id="res-msg" style="text-align:center;font-size:11px;color:#666;margin-top:12px;font-style:italic">Estás en el buen camino</div>
                        </div>
                        <div class="datos-extra">
                            <div class="panel-title">📅 Datos de Agenda</div>
                            <div class="datos-extra-grid">
                                <div class="dato-item"><div class="dato-label">1ª Visitas (4 sem)</div><div class="dato-value" id="inf-1visitas">8</div></div>
                                <div class="dato-item"><div class="dato-label">Revisiones (4 sem)</div><div class="dato-value" id="inf-revisiones">2</div></div>
                                <div class="dato-item"><div class="dato-label">% 1ª Visitas</div><div class="dato-value" id="inf-pct1v" style="color: rgb(34, 197, 94);">80%</div></div>
                                <div class="dato-item"><div class="dato-label">No Asistidas</div><div class="dato-value" id="inf-noasist">6</div></div>
                            </div>
                        </div>
                        <div class="datos-extra">
                            <div class="panel-title">💹 Datos de Conversiones (3 meses)</div>
                            <div class="datos-extra-grid">
                                <div class="dato-item"><div class="dato-label">Ventas Ayuda</div><div class="dato-value" id="inf-vayuda">0</div></div>
                                <div class="dato-item"><div class="dato-label">Ventas MGM</div><div class="dato-value" id="inf-vmgm">2</div></div>
                                <div class="dato-item"><div class="dato-label">Ventas Renove</div><div class="dato-value" id="inf-vrenove">1</div></div>
                                <div class="dato-item"><div class="dato-label">Ventas Seguros</div><div class="dato-value" id="inf-vseguros">3</div></div>
                            </div>
                            <div class="datos-extra-grid" style="margin-top:8px">
                                <div class="dato-item"><div class="dato-label">% Screenings</div><div class="dato-value" id="inf-screen">67%</div></div>
                                <div class="dato-item"><div class="dato-label">% Conv. Prueba</div><div class="dato-value" id="inf-cprueba">98%</div></div>
                                <div class="dato-item"><div class="dato-label">% Conv. Venta</div><div class="dato-value" id="inf-cventa">78%</div></div>
                                <div class="dato-item"><div class="dato-label">Reagendadas</div><div class="dato-value" id="inf-reagend">3</div></div>
                            </div>
                        </div>
                        <div class="tabla-box"><div class="panel-title">📊 Tabla de Procesos</div><table><thead><tr><th>Bloque</th><th>Peso</th><th>Pts</th><th>Máx</th><th>%</th><th>Aplic.</th></tr></thead><tbody id="tabla-body"><tr><td><strong>PIA</strong></td><td>25%</td><td>142</td><td>159</td><td style="color:#C9A227"><strong>89%</strong></td><td>22.3%</td></tr><tr><td><strong>FORMACIÓN</strong></td><td>15%</td><td>14</td><td>14</td><td style="color:#C9A227"><strong>100%</strong></td><td>15.0%</td></tr><tr><td><strong>Comunicación</strong></td><td>15%</td><td>6</td><td>9</td><td style="color:#5c5c5c"><strong>67%</strong></td><td>10.0%</td></tr><tr><td><strong>AYUDAS</strong></td><td>4%</td><td>0</td><td>6</td><td style="color:#5c5c5c"><strong>0%</strong></td><td>0.0%</td></tr><tr><td><strong>Complementarias</strong></td><td>6%</td><td>0</td><td>15</td><td style="color:#5c5c5c"><strong>0%</strong></td><td>0.0%</td></tr><tr><td><strong>RT</strong></td><td>25%</td><td>25</td><td>25</td><td style="color:#C9A227"><strong>100%</strong></td><td>25.0%</td></tr><tr><td><strong>AGENDA</strong></td><td>10%</td><td>6</td><td>6</td><td style="color:#C9A227"><strong>100%</strong></td><td>10.0%</td></tr><tr><td><strong>CONVERSIONES</strong></td><td>0%</td><td>0</td><td>0</td><td style="color:#5c5c5c"><strong>0%</strong></td><td>0.0%</td></tr><tr style="background:#2d2d2d;color:#fff"><td colspan="4"><strong>TOTAL</strong></td><td colspan="2"><strong>82%</strong></td></tr></tbody></table></div>
                        <div class="checklist-box"><div class="panel-title">✅ Checklist Completo</div><div id="checklist-content"><div class="checklist-bloque"><div class="checklist-header" style="background:linear-gradient(135deg,#C9A227,#B08D1E);">Protocolo Integral de Atención (25%)<span>89%</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">1. Gabinete de audio limpio y ordenado.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">2. Uniforme adecuado y chapa identificativa.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">3. Espéculos, olivas y cascos desinfectados, tener un lugar adecuado para almacenar los usados.</span><span class="check-ob">OBLIGATORIA</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">4. Acoger al cliente con una sonrisa, amable y cercano.</span><span class="check-ob">OBLIGATORIA</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">5. Llamar al paciente por su nombre.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">6. Acompañar al paciente al gabinete para la revisión auditiva.</span><span class="check-ob">OBLIGATORIA</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">7. Ofrecer pasar a gabinete al acompañante.</span><span class="check-ob">OBLIGATORIA</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">8. Confirmar el motivo de la visita.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">9. Preguntar cómo nos ha conocido y anotar en funnel</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">10. Presentarnos por nombre y especialidad y hacer referencia a la Compañía</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">11. Abrir ficha y rellenar RGPD completa (incluidos checks de condiciones comerciales).</span><span class="check-ob">OBLIGATORIA</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">12. Realizar anamnesis HACE, respetando cada parte: Hábitos, Antecedentes, Clínica y Expectativas.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">13. Explicar que realizamos un examen auditivo completo.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">14. Realizar una breve explicación en cada prueba y asegurarnos de que lo ha entendido.</span><span class="check-ob">OBLIGATORIA</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">15. La TV debe estar encendida siempre para comunicar audio y mostrar resultados de las pruebas.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">16. Evaluamos ambos oídos con la videotoscopia, dejamos registro con fotos y explicamos el procedimiento.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">17. Realizar timpanometría y explicar el procedimiento.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">18. Realizar VA y explicar el procedimiento.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">19. Realizar VO y explicar el procedimiento.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">20. Realizar UCL, explicar el procedimiento y estar atento a las reacciones. Si no es posible hacerlo, debe marcarlo como "estimado".</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">21. Explicar para qué se utiliza la prueba HIT, tener conocimiento de cómo se realiza y usarla para argumentación de valoración del rendimiento del audífono.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">22. Realizar logoaudiometría y explicar el procedimiento.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">23. Resumir los resultados y dar explicación.</span><span class="check-ob">OBLIGATORIA</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">24. Utilizar las gráficas para apoyarse y que sea más visible cada explicación (severidad, área audible, fonemas...).</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">25. Vincular los resultados obtenidos en la audiometría con síntomas o quejas mencionadas en la anamnesis.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">26. Crear necesidad: hacer visible la pérdida auditiva con sus consecuencias relevantes a nivel cognitivo, social, seguridad, laboral, dependencia y autoestima.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">27. Simular sonidos para visualizar la diferencia de percepción del sonido (tanto para el paciente, como para el acompañante).</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">28. Explicar al cliente que vamos a realizar una prueba de capacitación en ambientes reales para valorar su respuesta y saber cómo el cerebro discrimina entre ruido-palabra (si no le apetece, al menos unos días).</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">29. Disponer de un stock suficiente de audífonos en tienda según necesidades.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">30. Llevar un control de stock adecuado y conocer las condiciones de devolución, abonos... según cada proveedor.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">31. Escoger audífono en base al perfil en gama Diamante, explicando que dicha prueba es para valorar su mejor respuesta a los sonidos con el mejor audífono.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">32. Realizar la programación común y otros procedimientos según el perfil.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">33. Realizar las pruebas de colocación del audífono.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">34. Explicar al cliente el funcionamiento y mantenimiento de los audífonos para que se los pueda llevar a casa.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">35. Entregar la documentación en la entrega del audífono (contrato, presupuesto y pasaporte).</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">36. Cumplimentar el contrato correctamente.</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">37. Registrar la prueba en GIO en cuanto el audífono sale de la tienda.</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">38. Llamar al día siguiente para saber cómo se encuentra con los audífonos.</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">39. Citar en 4 días en el momento que se lleva los audífonos.</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">40. Hacer campo libre para demostrar lo que ha mejorado con la intención de cierre de venta y acortar tiempos de prueba.</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">41. En cada visita, resaltar logros de expectativas y ajustes. Aplicar neuroventas.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">42. Aplicar Tchin Tchin.</span><span class="check-ob">OBLIGATORIA</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">43. Capacidad de resolución de objeciones.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">44. Explicar facilidades de pago: Infinity / NextYear.</span><span class="check-ob">OBLIGATORIA</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">45. Explicar y entregar la gafa graduada y el servicio Afflelou Contigo como regalo al realizar la compra de audífonos.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">46. Ofrecer el seguro Caser de forma proactiva.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">47. Detallar los compromisos Audio.</span><span class="check-ob">OBLIGATORIA</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">48. Recomendar igualar la gama de 2ª pareja indicándolo en cuotas.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">49. Recomendar accesorios de conectividad como para la TV.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">50. Entregar el kit de higiene y enseñar al cliente a utilizar los productos de limpieza.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">51. Indicar que realizaremos llamada y ajuste en remoto cómodamente a los 3 y 6 meses. Si no es aceptado, se agenda cita presencial.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">52. Conocer y aplicar que según PIA 3.0 se realiza una revisión de audífonos en mes 34, dejando los audífonos y prestando unos nuevos de última tecnología.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">53. Realizar llamadas recordatorio un día antes de cada visita y a las citas no asistidas.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">54. Adecuar el discurso de las llamadas en función del motivo por el que vayamos a realizarla.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">55. Realizar las llamadas de control a pacientes: presupuestos / pérdida-no prueba / pilas-HIT / tapones / screenings. Registrar en funnel, agendar (si es reciente apertura, debe controlar el procedimiento).</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">56. Formar a los compañeros de óptica en "Primeros auxilios". (cambios de tulipas, filtros, auriculares…)</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">57. Fomentar MGM (cliente satisfecho genera nuevo cliente).</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">58. Fomentar RENOVE (3 y 4 años última compra o usuario de la competencia)</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">59. Estar al día en el conocimiento de los objetivos e incentivos vigentes del momento.</span></div></div><div class="checklist-bloque"><div class="checklist-header" style="background:linear-gradient(135deg,#5c5c5c,#4a4a4a);">Formación (15%)<span>100%</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">60. Onboarding realizado en Afflelou Academy.</span><span class="check-ob">OBLIGATORIA</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">61. Portfolio WSA y Starkey.</span><span class="check-ob">OBLIGATORIA</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">62. Realizar curso PIA última versión.</span><span class="check-ob">OBLIGATORIA</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">63. Realizar y estar al día en las formaciones de las campañas vigentes.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">64. Formación de "primeros auxilios de audio" para el equipo óptica. Academy</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">65. Formación de neuroventas y objeciones / habilidades comerciales.</span></div></div><div class="checklist-bloque"><div class="checklist-header" style="background:linear-gradient(135deg,#C9A227,#B8963D);">Comunicación (15%)<span>67%</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">66. Imagen adecuada en el punto de venta y escaparate. Generar visibilidad del servicio de audio y nuevo producto.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">67. Disponer de los elementos de audio como: manteletas, test de lectura, flyers de salud auditiva, seguros, Infinity, MGM…</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">68. Comunicar el servicio de audiología a "vecinos" y alrededores, colegios, entidades, asociaciones etc.</span></div></div><div class="checklist-bloque"><div class="checklist-header" style="background:linear-gradient(135deg,#8b8b8b,#6b6b6b);">Ayudas (4%)<span>0%</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">69. Conocer el procedimiento y cuáles son las ayudas que existen tanto a nivel estatal como a nivel de comunidad.</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">70. Centro adscrito para el reconocimiento de ayudas-pago.</span></div></div><div class="checklist-bloque"><div class="checklist-header" style="background:linear-gradient(135deg,#7a7a7a,#4f46e5);">Actuaciones Complementarias (6%)<span>0%</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">71. Servicio pediátrico.</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">72. Formación en Telecare y Telehere para ofrecer Ajuste remoto. Deben estar activados todos los audífonos.</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">73. Centro AAR Certificado/ Formación avanzada</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">74. Presencia en mentoring de refuerzo.</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">75. Conocimiento y aplicación de TRT.</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">76. Conocimiento y aplicación de REM.</span></div><div class="checklist-item"><span class="check-badge no">✗</span><span style="flex:1;line-height:1.3">77. Conocer los convenios FIAPAS y ONCE.</span></div></div><div class="checklist-bloque"><div class="checklist-header" style="background:linear-gradient(135deg,#C9A227,#B08D1E);">Responsable Tienda (25%)<span>100%</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">78. Conocer el portfolio Incógnito.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">79. Conocer las políticas comerciales de los proveedores homologados</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">80. Conocer y hacer seguimiento del Funnel.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">81. Conocer y hacer seguimiento de las llamadas que se realizan en audio.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">82. Control de stock adecuado.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">83. Formación básica de audio del RT-Equipo óptica</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">84. Control de servicios mínimos en audio por todo el equipo.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">85. Control de la agenda de audio.</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">86. Control de screening y proporcionar listado para seguimiento de posibles hipoacusias.</span></div><div class="checklist-item"><span class="check-badge num">5</span><span style="flex:1;line-height:1.3">87. Velar por que se produzcan derivaciones óptica-audio bidireccionalmente. Indique el nº de derivaciones óptica-audio las últimas 8 semanas</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">88. Verificación entrega tarjeta revisión auditiva / otros elementos en encargo óptica.</span></div></div><div class="checklist-bloque"><div class="checklist-header" style="background:linear-gradient(135deg,#d4af37,#0891b2);">Gestión de Agenda (10%)<span>100%</span></div><div class="checklist-item"><span class="check-badge num">8</span><span style="flex:1;line-height:1.3">89. Indique el número de Primeras visitas las últimas 4 semanas</span></div><div class="checklist-item"><span class="check-badge num">2</span><span style="flex:1;line-height:1.3">90. Indique el nº de Revisiones postventa de las últimas 4 semanas</span></div><div class="checklist-item"><span class="check-badge si">✓</span><span style="flex:1;line-height:1.3">91. ¿Cumple tu agenda la proporción 75% primeras visitas &amp; 25% revisiones postventa ? (primeras visitas x100 /total de citas últimas 4 semanas)</span></div><div class="checklist-item"><span class="check-badge num">6</span><span style="flex:1;line-height:1.3">92. Indique el número de visitas no asistidas</span></div><div class="checklist-item"><span class="check-badge num">3</span><span style="flex:1;line-height:1.3">93. Indique el Número de citas reagendadas o pasadas al funnel de seguimiento.</span></div></div><div class="checklist-bloque"><div class="checklist-header" style="background:linear-gradient(135deg,#C9A227,#a88b1e);">Conversiones (0%)<span>0%</span></div><div class="checklist-item"><span class="check-badge num">0</span><span style="flex:1;line-height:1.3">94. Nº de ventas con Ayudas los últimos 3 meses</span></div><div class="checklist-item"><span class="check-badge num">2</span><span style="flex:1;line-height:1.3">95. Nº de ventas Member get Member los últimos 3 meses</span></div><div class="checklist-item"><span class="check-badge num">1</span><span style="flex:1;line-height:1.3">96. Nº de ventas Renove los últimos 3 meses</span></div><div class="checklist-item"><span class="check-badge num">3</span><span style="flex:1;line-height:1.3">97. Nº de ventas de seguros.</span></div><div class="checklist-item"><span class="check-badge num">67</span><span style="flex:1;line-height:1.3">98. % Screenings vs. Optometrías según GIO (ideal 80%)</span></div><div class="checklist-item"><span class="check-badge num">98</span><span style="flex:1;line-height:1.3">99. % Conversión a Prueba (ideal 80%.)</span></div><div class="checklist-item"><span class="check-badge num">78</span><span style="flex:1;line-height:1.3">100. % Conversión a Venta (ideal 80%)</span></div></div></div></div>
                    </div>
                    <button class="btn-nueva" onclick="nuevaEval()">← Nueva Evaluación</button>
                </div>
            </section>

            <section id="section-informe" class="section">
                <div id="informe-pro" class="informe-pro" style="display:flex">
                    <div class="inf-btns">
                        <button class="inf-btn" style="background:#C9A227" onclick="mostrarListaPreinformes()">📋 Desde Preinforme</button>
                        <button class="inf-btn" id="btn-guardar-borrador" style="background:#6b7280" onclick="guardarBorradorInforme()">📝 Guardar Borrador</button>
                        <button class="inf-btn guardar" id="btn-finalizar" onclick="finalizarInforme()">✅ Finalizar</button>
                        <button class="inf-btn" style="background:#5c5c5c" onclick="limpiarInforme()">🗑️ Limpiar</button>
                    </div>
                    <div id="modal-preinformes" style="display: none; position: fixed; inset: 0px; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
                        <div style="background:#fff;border-radius:12px;padding:20px;max-width:500px;width:90%;max-height:70vh;overflow-y:auto">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                                <h3 style="margin:0;font-size:14px;color:#333">📋 Seleccionar Preinforme</h3>
                                <button onclick="cerrarModalPreinformes()" style="background:none;border:none;font-size:20px;cursor:pointer">✕</button>
                            </div>
                            <div id="modal-preinformes-lista"><div class="preinforme-item" style="background:#f8f8f8;border:1px solid #e0e0e0;cursor:pointer;margin-bottom:8px" onclick="seleccionarPreinforme(0)"><div class="preinforme-top"><div class="preinforme-dot" style="background:#8b8b8b"></div><div class="preinforme-centro" style="color:#333">Prueba</div><div class="preinforme-score" style="color:#8b8b8b">91% 🥇</div></div><div class="preinforme-meta" style="color:#888">2025-12-30 • -</div></div></div>
                            <div id="modal-empty" style="text-align: center; color: rgb(136, 136, 136); font-size: 11px; padding: 30px; display: none;">No hay preinformes disponibles</div>
                        </div>
                    </div>
                    <div class="inf-page" id="inf-pagina1">
                        <div class="inf-header"><div class="inf-logo"><div class="inf-logo-icon">🎧</div><div class="inf-logo-text">Informe Audio</div></div><div class="inf-firma" id="inf-header-firma"><span style="font-size:8px;color:#888;display:block">Responsable Audio</span><span style="font-size:11px;font-weight:600;color:#C9A227">Ariannys Rojas</span></div></div>
                        <div class="inf-seccion"><div class="inf-seccion-titulo"><div class="inf-seccion-icono" style="background:#6b7280">📝</div><div class="inf-seccion-nombre">Datos de la Visita</div></div><div class="inf-datos-grid"><div class="inf-dato-field"><label class="inf-dato-label">Centro</label><input type="text" class="inf-dato-input" id="inf-centro" oninput="clearTimeout(window.cifrasTimeout);window.cifrasTimeout=setTimeout(()=>{cargarCifrasVentaInforme(this.value);cargarPCPNCInforme(this.value)},500)" onblur="cargarGamasAutomatico(this.value);cargarPCPNCInforme(this.value);cargarCifrasVentaInforme(this.value)" onchange="cargarGamasAutomatico(this.value);cargarPCPNCInforme(this.value);cargarCifrasVentaInforme(this.value)"></div><div class="inf-dato-field"><label class="inf-dato-label">Propietario</label><input type="text" class="inf-dato-input" id="inf-propietario"></div><div class="inf-dato-field"><label class="inf-dato-label">Delegado Regional</label><input type="text" class="inf-dato-input" id="inf-delegado-regional"></div><div class="inf-dato-field"><label class="inf-dato-label">Delegado Audio</label><select class="inf-dato-select" id="inf-delegado-audio"><option>Ariannys Rojas</option><option>Sonia Guasque</option></select></div><div class="inf-dato-field"><label class="inf-dato-label">Tipo Visita</label><select class="inf-dato-select" id="inf-tipo-visita"><option>Seguimiento</option><option>Apertura</option><option>Formación</option></select></div><div class="inf-dato-field"><label class="inf-dato-label">Fecha</label><input type="date" class="inf-dato-input" id="inf-fecha"></div><div class="inf-dato-field"><label class="inf-dato-label">PC/PNC</label><input type="text" class="inf-dato-input" id="inf-pcpnc" readonly style="background:#f3f4f6;font-weight:700"></div><div class="inf-dato-field"><label class="inf-dato-label">Horas Servicio</label><input type="text" class="inf-dato-input" id="inf-horas" onchange="actualizarBasico2Horas()" onkeyup="actualizarBasico2Horas()" placeholder=""></div><div class="inf-dato-field" style="grid-column:span 2"><label class="inf-dato-label">Nombre Audiólogo</label><input type="text" class="inf-dato-input" id="inf-nombre-audiologo" data-always-editable="true" placeholder="Nombre del audiólogo" onkeydown="if(event.key==='Enter'){event.preventDefault();grabarNombreAudiologo()}"></div></div></div>
                        <div class="inf-seccion"><div class="inf-seccion-titulo"><div class="inf-seccion-icono" style="background:#C9A227">⚙️</div><div class="inf-seccion-nombre">Evaluación del Centro</div></div>
                            <!-- Fila 1: 2 columnas -->
                            <!-- Fila 1: Evaluación + Cifras -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:8px">
                                <div style="background:#fff;border:1px solid #e8ddb5;border-radius:12px;padding:16px 12px;box-shadow:0 2px 8px rgba(201,162,39,0.15);text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center">
                                    <!-- Podium Categoría -->
                                    <div id="inf-res-emoji" style="font-size:44px;margin-bottom:4px;filter:drop-shadow(0 2px 4px rgba(201,162,39,0.3))">⚙️</div>
                                    <div id="inf-res-valor" style="font-size:48px;font-weight:900;color:#C9A227;line-height:1;text-shadow:0 1px 2px rgba(0,0,0,0.1)">0%</div>
                                    <div id="inf-res-cat" style="font-size:13px;font-weight:800;color:#333;margin-top:6px;padding:4px 16px;background:linear-gradient(135deg,#fef9e7,#fdf2d0);border-radius:20px;border:1px solid #e8ddb5;letter-spacing:0.5px">Sin Evaluar</div>
                                    <div id="inf-res-msg" style="font-size:10px;color:#8B7355;margin-top:6px;min-height:14px;max-width:200px;line-height:1.3"></div>
                                </div>
                                <div style="background:#fff;border:1px solid #e8ddb5;border-radius:8px;padding:10px;box-shadow:0 1px 4px rgba(201,162,39,0.12)">
                                    <!-- CIFRAS DE VENTA AGO 25 - JUL 26 -->
                                    <div style="margin-top:10px;padding-top:10px;border-top:1px solid #e0e0e0">
                                        <div style="font-size:11px;font-weight:700;color:#8B7355;margin-bottom:6px">💰 Cifras Venta Audio</div>
                                        <div id="informe-cifras-container">
                                            <div style="display:flex;gap:8px;margin-bottom:8px">
                                                <div style="flex:1;text-align:center;padding:10px 8px;background:linear-gradient(135deg,#C9A227,#A68B1E);border-radius:6px">
                                                    <div style="font-size:10px;color:#fff;opacity:0.9;margin-bottom:2px">Acumulado</div>
                                                    <input type="number" id="inf-cifra-acum" value="0" style="width:80px;font-size:14px;font-weight:800;color:#fff;background:transparent;border:none;border-bottom:1px dashed rgba(255,255,255,0.5);text-align:center;outline:none" onchange="recalcularCifrasInforme()">
                                                    <div style="font-size:8px;color:rgba(255,255,255,0.7)">€</div>
                                                </div>
                                                <div style="flex:1;text-align:center;padding:10px 8px;background:linear-gradient(135deg,#8B7518,#6D5B10);border-radius:6px">
                                                    <div style="font-size:10px;color:#fff;opacity:0.9;margin-bottom:2px">Previsto</div>
                                                    <input type="number" id="inf-cifra-prev" value="0" style="width:80px;font-size:14px;font-weight:800;color:#fff;background:transparent;border:none;border-bottom:1px dashed rgba(255,255,255,0.5);text-align:center;outline:none" onchange="recalcularCifrasInforme()">
                                                    <div style="font-size:8px;color:rgba(255,255,255,0.7)">€</div>
                                                </div>
                                            </div>
                                            <div style="display:flex;gap:8px">
                                                <div style="flex:1;text-align:center;padding:8px;background:#fff;border-radius:4px;border:1px solid #e0e0e0">
                                                    <div style="font-size:9px;color:#8B7355;font-weight:600">Diferencia</div>
                                                    <div style="font-size:14px;font-weight:800" id="inf-cifra-dif">-</div>
                                                </div>
                                                <div style="flex:1;text-align:center;padding:8px;background:#fff;border-radius:4px;border:1px solid #e0e0e0">
                                                    <div style="font-size:9px;color:#8B7355;font-weight:600">vs Previsto</div>
                                                    <div style="font-size:14px;font-weight:800" id="inf-cifra-pct">-</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="font-size:7px;color:#b0a48a;margin-top:4px;font-style:italic;text-align:right">*Dato PBI hasta mes vencido</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Fila 2: Funnel + Conversiones -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:8px">
                                    <div style="background:#fff;border:1px solid #e8ddb5;border-radius:8px;padding:10px;box-shadow:0 1px 4px rgba(201,162,39,0.12)">
                                        <div style="font-size:11px;font-weight:700;color:#8B7355;margin-bottom:6px">📈 Datos Funnel del Centro</div>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
                                        <!-- Ventas Mes -->
                                        <div style="background:linear-gradient(135deg,#C9A227,#A68B1E);border-radius:6px;padding:8px;text-align:center">
                                            <div style="font-size:9px;color:rgba(255,255,255,0.9);text-transform:uppercase;font-weight:600">Ventas Mes</div>
                                            <input type="number" id="inf-funnel-ventas" value="0" min="0" style="width:50px;font-size:16px;font-weight:800;color:#fff;background:transparent;border:none;border-bottom:1px dashed rgba(255,255,255,0.5);text-align:center;outline:none">
                                        </div>
                                        <!-- En Capacitación -->
                                        <div style="background:linear-gradient(135deg,#B8963D,#9A7D2E);border-radius:6px;padding:8px;text-align:center">
                                            <div style="font-size:9px;color:rgba(255,255,255,0.9);text-transform:uppercase;font-weight:600">En Capacitación</div>
                                            <input type="number" id="inf-funnel-capacitacion" value="0" min="0" style="width:50px;font-size:16px;font-weight:800;color:#fff;background:transparent;border:none;border-bottom:1px dashed rgba(255,255,255,0.5);text-align:center;outline:none">
                                        </div>
                                        <!-- Devoluciones -->
                                        <div style="background:linear-gradient(135deg,#D4AF37,#B8963D);border-radius:6px;padding:8px;text-align:center;grid-column:span 2">
                                            <div style="font-size:9px;color:rgba(255,255,255,0.9);text-transform:uppercase;font-weight:600">Devoluciones/Fugas</div>
                                            <input type="number" id="inf-funnel-devoluciones" value="0" min="0" style="width:50px;font-size:16px;font-weight:800;color:#fff;background:transparent;border:none;border-bottom:1px dashed rgba(255,255,255,0.5);text-align:center;outline:none">
                                        </div>
                                    </div>
                                    </div>
                                <div style="background:#fff;border:1px solid #e8ddb5;border-radius:8px;padding:10px;box-shadow:0 1px 4px rgba(201,162,39,0.12)">
                                    <div style="font-size:11px;font-weight:700;color:#8B7355;margin-bottom:6px">💹 Conversiones</div>
                                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:8px">
                                        <div style="text-align:center;padding:6px;background:linear-gradient(135deg,#C9A227,#A68B1E);border-radius:6px">
                                            <input type="number" id="conv-pct-prueba" value="0" min="0" max="100" style="width:100%;font-size:16px;font-weight:800;color:#fff;background:transparent;border:none;text-align:center;outline:none" onclick="this.select()">
                                            <div style="font-size:10px;color:#fff;opacity:0.9">% Prueba</div>
                                        </div>
                                        <div style="text-align:center;padding:6px;background:linear-gradient(135deg,#B8963D,#9A7D2E);border-radius:6px">
                                            <input type="number" id="conv-pct-venta" value="0" min="0" max="100" style="width:100%;font-size:16px;font-weight:800;color:#fff;background:transparent;border:none;text-align:center;outline:none" onclick="this.select()">
                                            <div style="font-size:10px;color:#fff;opacity:0.9">% Venta</div>
                                        </div>
                                        <div style="text-align:center;padding:6px;background:linear-gradient(135deg,#B8963D,#9A7D2E);border-radius:6px">
                                            <input type="number" id="conv-pct-screen" value="0" min="0" max="100" style="width:100%;font-size:16px;font-weight:800;color:#fff;background:transparent;border:none;text-align:center;outline:none" onclick="this.select()">
                                            <div style="font-size:10px;color:#fff;opacity:0.9">% Screen</div>
                                        </div>
                                    </div>
                                    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:4px">
                                        <div style="text-align:center;padding:4px;background:#fff;border-radius:4px;border:1px solid #e0e0e0">
                                            <div style="font-size:10px">👥</div>
                                            <input type="number" id="conv-mgm-val" value="0" min="0" style="width:100%;font-size:11px;font-weight:700;text-align:center;border:none;background:transparent;outline:none" onclick="this.select()">
                                            <div style="font-size:9px;color:#8B7355;font-weight:500">MGM</div>
                                        </div>
                                        <div style="text-align:center;padding:4px;background:#fff;border-radius:4px;border:1px solid #e0e0e0">
                                            <div style="font-size:10px">🔄</div>
                                            <input type="number" id="conv-renove-val" value="0" min="0" style="width:100%;font-size:11px;font-weight:700;text-align:center;border:none;background:transparent;outline:none" onclick="this.select()">
                                            <div style="font-size:9px;color:#8B7355;font-weight:500">Renove</div>
                                        </div>
                                        <div style="text-align:center;padding:4px;background:#fff;border-radius:4px;border:1px solid #e0e0e0">
                                            <div style="font-size:10px">🛡️</div>
                                            <input type="number" id="conv-seguro-val" value="0" min="0" style="width:100%;font-size:11px;font-weight:700;text-align:center;border:none;background:transparent;outline:none" onclick="this.select()">
                                            <div style="font-size:9px;color:#8B7355;font-weight:500">Seguro</div>
                                        </div>
                                        <div style="text-align:center;padding:4px;background:#fff;border-radius:4px;border:1px solid #e0e0e0">
                                            <div style="font-size:10px">💛</div>
                                            <input type="number" id="conv-ayudas-val" value="0" min="0" style="width:100%;font-size:11px;font-weight:700;text-align:center;border:none;background:transparent;outline:none" onclick="this.select()">
                                            <div style="font-size:9px;color:#8B7355;font-weight:500">Ayudas</div>
                                        </div>
                                        <div style="text-align:center;padding:4px;background:#fff;border-radius:4px;border:1px solid #e0e0e0">
                                            <div style="font-size:10px">🖼️</div>
                                            <input type="number" id="conv-imagen-val" value="0" min="0" style="width:100%;font-size:11px;font-weight:700;text-align:center;border:none;background:transparent;outline:none" onclick="this.select()">
                                            <div style="font-size:9px;color:#8B7355;font-weight:500">Imagen</div>
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            <!-- Fila 3: Gamas + Tipo Atención + Electro -->
                            <!-- Fila 3: Gamas + Tipo Atención -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:8px">
                                <div style="background:#fff;border:1px solid #e8ddb5;border-radius:8px;padding:10px;box-shadow:0 1px 4px rgba(201,162,39,0.12)">
                                        <div style="font-size:11px;font-weight:700;color:#8B7355;text-align:center;margin-bottom:6px">💎 Gamas Vendidas</div>
                                        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px">
                                            <!-- Diamante Plus -->
                                            <div style="text-align:center">
                                                <div style="background:linear-gradient(135deg,#C9A227,#B08D1E);border-radius:6px;padding:6px 2px">
                                                    <div style="font-size:12px">💎+</div>
                                                    <input type="number" id="gama-diamante-plus" value="0" min="0" style="width:100%;font-size:14px;font-weight:800;text-align:center;border:none;background:transparent;color:#fff;outline:none" oninput="calcularGamas()" onclick="this.select()">
                                                </div>
                                                <div style="font-size:8px;color:#B08D1E;font-weight:600;margin-top:3px">Diamante Plus</div>
                                                <div id="gama-diamante-plus-pct" style="font-size:10px;font-weight:800;color:#B08D1E">0%</div>
                                            </div>
                                            <!-- Diamante IC -->
                                            <div style="text-align:center">
                                                <div style="background:linear-gradient(135deg,#D4AF37,#B8963D);border-radius:6px;padding:6px 2px">
                                                    <div style="font-size:12px">💎</div>
                                                    <input type="number" id="gama-diamante" value="0" min="0" style="width:100%;font-size:14px;font-weight:800;text-align:center;border:none;background:transparent;color:#fff;outline:none" oninput="calcularGamas()" onclick="this.select()">
                                                </div>
                                                <div style="font-size:8px;color:#B8963D;font-weight:600;margin-top:3px">Diamante IC</div>
                                                <div id="gama-diamante-pct" style="font-size:10px;font-weight:800;color:#B8963D">0%</div>
                                            </div>
                                            <!-- Platino Plus -->
                                            <div style="text-align:center">
                                                <div style="background:linear-gradient(135deg,#B8963D,#9A7D2E);border-radius:6px;padding:6px 2px">
                                                    <div style="font-size:12px">🥈+</div>
                                                    <input type="number" id="gama-platino-plus" value="0" min="0" style="width:100%;font-size:14px;font-weight:800;text-align:center;border:none;background:transparent;color:#fff;outline:none" oninput="calcularGamas()" onclick="this.select()">
                                                </div>
                                                <div style="font-size:8px;color:#9A7D2E;font-weight:600;margin-top:3px">Platino Plus</div>
                                                <div id="gama-platino-plus-pct" style="font-size:10px;font-weight:800;color:#9A7D2E">0%</div>
                                            </div>
                                            <!-- Platino IC -->
                                            <div style="text-align:center">
                                                <div style="background:linear-gradient(135deg,#A68B1E,#8B7518);border-radius:6px;padding:6px 2px">
                                                    <div style="font-size:12px">🥈</div>
                                                    <input type="number" id="gama-platino" value="0" min="0" style="width:100%;font-size:14px;font-weight:800;text-align:center;border:none;background:transparent;color:#fff;outline:none" oninput="calcularGamas()" onclick="this.select()">
                                                </div>
                                                <div style="font-size:8px;color:#8B7518;font-weight:600;margin-top:3px">Platino IC</div>
                                                <div id="gama-platino-pct" style="font-size:10px;font-weight:800;color:#8B7518">0%</div>
                                            </div>
                                            <!-- Oro Incognito -->
                                            <div style="text-align:center">
                                                <div style="background:linear-gradient(135deg,#E8C547,#C9A227);border-radius:6px;padding:6px 2px">
                                                    <div style="font-size:12px">🥇</div>
                                                    <input type="number" id="gama-oro" value="0" min="0" style="width:100%;font-size:14px;font-weight:800;text-align:center;border:none;background:transparent;color:#fff;outline:none" oninput="calcularGamas()" onclick="this.select()">
                                                </div>
                                                <div style="font-size:8px;color:#A68B1E;font-weight:600;margin-top:3px">Oro Incógnito</div>
                                                <div id="gama-oro-pct" style="font-size:10px;font-weight:800;color:#A68B1E">0%</div>
                                            </div>
                                        </div>
                                        <div style="text-align:center;margin-top:8px;font-size:9px;color:#666;padding-top:6px;border-top:1px dashed #ddd">Total: <span id="gamas-total" style="font-weight:700;color:#333">0</span> audífonos</div>
                                        
                                </div>
                                <div style="background:#fff;border:1px solid #e8ddb5;border-radius:8px;padding:10px;box-shadow:0 1px 4px rgba(201,162,39,0.12)">
                                    <div style="background:#fff;border:1px solid #e8ddb5;border-radius:8px;padding:10px;box-shadow:0 1px 4px rgba(201,162,39,0.12)">
                                        <!-- TIPO ATENCIÓN - Compacto -->
                                        <div style="font-size:11px;font-weight:700;color:#8B7355;text-align:center;margin:6px 0 4px">🏥 Tipo Atención</div>
                                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px">
                                            <div style="text-align:center">
                                                <div style="background:linear-gradient(135deg,#C9A227,#B08D1E);border-radius:4px;padding:4px 2px">
                                                    <input type="number" id="tipoaten-adulto" value="0" min="0" style="width:100%;font-size:12px;font-weight:800;text-align:center;border:none;background:transparent;color:#fff;outline:none" oninput="calcularTipoAtencion()" onclick="this.select()">
                                                </div>
                                                <div style="font-size:8px;color:#B08D1E;font-weight:600;margin-top:2px">Adulto</div>
                                            </div>
                                            <div style="text-align:center">
                                                <div style="background:linear-gradient(135deg,#B8963D,#9A7D2E);border-radius:4px;padding:4px 2px">
                                                    <input type="number" id="tipoaten-tinnitus" value="0" min="0" style="width:100%;font-size:12px;font-weight:800;text-align:center;border:none;background:transparent;color:#fff;outline:none" oninput="calcularTipoAtencion()" onclick="this.select()">
                                                </div>
                                                <div style="font-size:8px;color:#B8963D;font-weight:600;margin-top:2px">Ad+Tinnitus</div>
                                            </div>
                                            <div style="text-align:center">
                                                <div style="background:linear-gradient(135deg,#D4AF37,#B8963D);border-radius:4px;padding:4px 2px">
                                                    <input type="number" id="tipoaten-pediatrico" value="0" min="0" style="width:100%;font-size:12px;font-weight:800;text-align:center;border:none;background:transparent;color:#fff;outline:none" oninput="calcularTipoAtencion()" onclick="this.select()">
                                                </div>
                                                <div style="font-size:8px;color:#A68B1E;font-weight:600;margin-top:2px">Pediátrico</div>
                                            </div>
                                        </div>
                                        <div style="text-align:center;margin-top:4px;font-size:7px;color:#888">Total: <span id="tipoaten-total" style="font-weight:700;color:#333">0</span></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Electromedicina: fila completa horizontal -->
                            <div style="background:#fff;border:1px solid #e8ddb5;border-radius:8px;padding:10px;box-shadow:0 1px 4px rgba(201,162,39,0.12);margin-bottom:8px;box-shadow:0 1px 3px rgba(201,162,39,0.1)">
                                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                                    <div style="font-size:11px;font-weight:700;color:#8B7355;white-space:nowrap">🔬 Electromedicina</div>
                                    <span style="font-size:9px;color:#555;font-weight:600">Marca:</span>
                                    <select id="electro-marca" style="font-size:11px;padding:4px 8px;border:1px solid #ddd;border-radius:6px;background:#fff;min-width:120px">
                                    <option value="">Seleccionar...</option>
                                    <option value="INVENTIS">Inventis</option>
                                    <option value="NATUS">Natus</option>
                                    <option value="CALLISTO">Callisto</option>
                                    <option value="OTRO">Otro</option>
                                    </select>
                                    <div style="display:flex;gap:6px;flex:1;justify-content:center">
                                    <label class="electro-check-label" style="display:flex;align-items:center;gap:4px;font-size:11px;color:#444;cursor:pointer;background:#fafafa;padding:5px 10px;border-radius:6px;border:1px solid #e0e0e0;transition:all 0.2s">
                                    <input type="checkbox" id="electro-audiometro" onchange="actualizarEstiloElectromedicina()" style="width:16px;height:16px;accent-color:#C9A227;cursor:pointer">
                                    Audiom.</label>
                                    <label class="electro-check-label" style="display:flex;align-items:center;gap:4px;font-size:11px;color:#444;cursor:pointer;background:#fafafa;padding:5px 10px;border-radius:6px;border:1px solid #e0e0e0;transition:all 0.2s">
                                    <input type="checkbox" id="electro-rem" onchange="actualizarEstiloElectromedicina()" style="width:16px;height:16px;accent-color:#C9A227;cursor:pointer">
                                    REM</label>
                                    <label class="electro-check-label" style="display:flex;align-items:center;gap:4px;font-size:11px;color:#444;cursor:pointer;background:#fafafa;padding:5px 10px;border-radius:6px;border:1px solid #e0e0e0;transition:all 0.2s">
                                    <input type="checkbox" id="electro-campolibre" onchange="actualizarEstiloElectromedicina()" style="width:16px;height:16px;accent-color:#C9A227;cursor:pointer">
                                    C.Libre</label>
                                    <label class="electro-check-label" style="display:flex;align-items:center;gap:4px;font-size:11px;color:#444;cursor:pointer;background:#fafafa;padding:5px 10px;border-radius:6px;border:1px solid #e0e0e0;transition:all 0.2s">
                                    <input type="checkbox" id="electro-timpano" onchange="actualizarEstiloElectromedicina()" style="width:16px;height:16px;accent-color:#C9A227;cursor:pointer">
                                    Timpano.</label>
                                    <label class="electro-check-label" style="display:flex;align-items:center;gap:4px;font-size:11px;color:#444;cursor:pointer;background:#fafafa;padding:5px 10px;border-radius:6px;border:1px solid #e0e0e0;transition:all 0.2s">
                                    <input type="checkbox" id="electro-video" onchange="actualizarEstiloElectromedicina()" style="width:16px;height:16px;accent-color:#C9A227;cursor:pointer">
                                    Videosc.</label>
                                    <label class="electro-check-label" style="display:flex;align-items:center;gap:4px;font-size:11px;color:#444;cursor:pointer;background:#fafafa;padding:5px 10px;border-radius:6px;border:1px solid #e0e0e0;transition:all 0.2s">
                                    <input type="checkbox" id="electro-hit" onchange="actualizarEstiloElectromedicina()" style="width:16px;height:16px;accent-color:#C9A227;cursor:pointer">
                                    HIT</label>
                                    </div>
                                </div>
                            </div>
                            <!-- Fila: Barras + Pentágono -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
                                <div style="flex:1;min-width:0;background:#fff;border:1px solid #e8ddb5;border-radius:8px;padding:10px;box-shadow:0 1px 4px rgba(201,162,39,0.12)">
                                    <div style="font-size:8px;font-weight:700;color:#666;margin-bottom:4px;text-transform:uppercase">📊 % Aplicación por Bloque</div>
                                    <div class="inf-barras-list" style="font-size:7px"><div class="inf-barra" style="margin-bottom:2px"><span class="inf-barra-name" style="width:55px"><span class="inf-barra-icon" style="background:#C9A227;width:10px;height:10px;font-size:6px">🎧</span>PIA</span><div class="inf-barra-track" style="height:8px"><div class="inf-barra-fill" id="bar-pia" style="width:0%;background:rgb(37,99,235)"><span class="inf-barra-pct" id="pct-pia" style="font-size:6px">0%</span></div></div><span class="inf-barra-peso" style="width:22px;font-size:6px">25%</span><span class="inf-barra-apl" id="apl-pia" style="width:28px;font-size:6px">0.0%</span></div><div class="inf-barra" style="margin-bottom:2px"><span class="inf-barra-name" style="width:55px"><span class="inf-barra-icon" style="background:#b8860b;width:10px;height:10px;font-size:6px">📚</span>FORM</span><div class="inf-barra-track" style="height:8px"><div class="inf-barra-fill" id="bar-form" style="width:0%;background:rgb(124,58,237)"><span class="inf-barra-pct" id="pct-form" style="font-size:6px">0%</span></div></div><span class="inf-barra-peso" style="width:22px;font-size:6px">15%</span><span class="inf-barra-apl" id="apl-form" style="width:28px;font-size:6px">0.0%</span></div><div class="inf-barra" style="margin-bottom:2px"><span class="inf-barra-name" style="width:55px"><span class="inf-barra-icon" style="background:#C9A227;width:10px;height:10px;font-size:6px">📢</span>COM</span><div class="inf-barra-track" style="height:8px"><div class="inf-barra-fill" id="bar-com" style="width:0%;background:rgb(201,162,39)"><span class="inf-barra-pct" id="pct-com" style="font-size:6px">0%</span></div></div><span class="inf-barra-peso" style="width:22px;font-size:6px">15%</span><span class="inf-barra-apl" id="apl-com" style="width:28px;font-size:6px">0.0%</span></div><div class="inf-barra" style="margin-bottom:2px"><span class="inf-barra-name" style="width:55px"><span class="inf-barra-icon" style="background:#d4883e;width:10px;height:10px;font-size:6px">💛</span>AYUD</span><div class="inf-barra-track" style="height:8px"><div class="inf-barra-fill" id="bar-ayu" style="width:0%;background:rgb(234,88,12)"><span class="inf-barra-pct" id="pct-ayu" style="font-size:6px">0%</span></div></div><span class="inf-barra-peso" style="width:22px;font-size:6px">4%</span><span class="inf-barra-apl" id="apl-ayu" style="width:28px;font-size:6px">0.0%</span></div><div class="inf-barra" style="margin-bottom:2px"><span class="inf-barra-name" style="width:55px"><span class="inf-barra-icon" style="background:#cc7722;width:10px;height:10px;font-size:6px">➕</span>COMP</span><div class="inf-barra-track" style="height:8px"><div class="inf-barra-fill" id="bar-comp" style="width:0%;background:rgb(220,38,38)"><span class="inf-barra-pct" id="pct-comp" style="font-size:6px">0%</span></div></div><span class="inf-barra-peso" style="width:22px;font-size:6px">6%</span><span class="inf-barra-apl" id="apl-comp" style="width:28px;font-size:6px">0.0%</span></div><div class="inf-barra" style="margin-bottom:2px"><span class="inf-barra-name" style="width:55px"><span class="inf-barra-icon" style="background:#9b7b3a;width:10px;height:10px;font-size:6px">🏪</span>RT</span><div class="inf-barra-track" style="height:8px"><div class="inf-barra-fill" id="bar-rt" style="width:0%;background:rgb(8,145,178)"><span class="inf-barra-pct" id="pct-rt" style="font-size:6px">0%</span></div></div><span class="inf-barra-peso" style="width:22px;font-size:6px">25%</span><span class="inf-barra-apl" id="apl-rt" style="width:28px;font-size:6px">0.0%</span></div><div class="inf-barra" style="margin-bottom:2px"><span class="inf-barra-name" style="width:55px"><span class="inf-barra-icon" style="background:#a67c52;width:10px;height:10px;font-size:6px">💹</span>CONV</span><div class="inf-barra-track" style="height:8px"><div class="inf-barra-fill" id="bar-conv" style="width:0%;background:rgb(22,163,74)"><span class="inf-barra-pct" id="pct-conv" style="font-size:6px">0%</span></div></div><span class="inf-barra-peso" style="width:22px;font-size:6px">0%</span><span class="inf-barra-apl" id="apl-conv" style="width:28px;font-size:6px">0.0%</span></div><div class="inf-barra"><span class="inf-barra-name" style="width:55px"><span class="inf-barra-icon" style="background:#8b6914;width:10px;height:10px;font-size:6px">📅</span>AGEN</span><div class="inf-barra-track" style="height:8px"><div class="inf-barra-fill" id="bar-age" style="width:0%;background:rgb(219,39,119)"><span class="inf-barra-pct" id="pct-age" style="font-size:6px">0%</span></div></div><span class="inf-barra-peso" style="width:22px;font-size:6px">10%</span><span class="inf-barra-apl" id="apl-age" style="width:28px;font-size:6px">0.0%</span></div></div>
                                </div>
                                <div id="contenedor-pentagono" style="background:#fff;border:1px solid #e8ddb5;border-radius:8px;padding:8px;box-shadow:0 1px 4px rgba(201,162,39,0.12);display:flex;flex-direction:column">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                                        <span style="font-size:11px;font-weight:700;color:#8B7355">⭐ 11 Básicos</span>
                                        <span id="pent-global" style="font-size:12px;font-weight:800;color:#dc2626">0%</span>
                                    </div>
                                    <div style="flex:1;display:flex;align-items:center;justify-content:center;min-height:160px">
                                        <canvas id="pentagono-informe" style="max-width:100%;max-height:160px"></canvas>
                                    </div>
                                    <details style="margin-top:4px">
                                        <summary style="cursor:pointer;font-size:7px;color:#C9A227;font-weight:600;padding:3px;background:#fff;border-radius:4px;text-align:center">▼ Marcar básicos</summary>
                                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px;margin-top:4px;font-size:6px">
                                            <label id="lbl-basico-1" style="display: flex; align-items: center; gap: 2px; padding: 2px; background: rgb(254, 226, 226); border-radius: 2px; cursor: pointer; border-left: 3px solid rgb(220, 38, 38); color: rgb(220, 38, 38); font-weight: 600;"><input type="checkbox" id="basico-1" onchange="actualizarPentagono()">1.Visibilidad</label>
                                            <label id="lbl-basico-2" style="display: flex; align-items: center; gap: 2px; padding: 2px; background: rgb(254, 226, 226); border-radius: 2px; cursor: pointer; border-left: 3px solid rgb(220, 38, 38); color: rgb(220, 38, 38); font-weight: 600;"><input type="checkbox" id="basico-2" onchange="actualizarPentagono()">2.20h</label>
                                            <label id="lbl-basico-3" style="display: flex; align-items: center; gap: 2px; padding: 2px; background: rgb(254, 226, 226); border-radius: 2px; cursor: pointer; border-left: 3px solid rgb(220, 38, 38); color: rgb(220, 38, 38); font-weight: 600;"><input type="checkbox" id="basico-3" onchange="actualizarPentagono()">3.Formación</label>
                                            <label id="lbl-basico-4" style="display: flex; align-items: center; gap: 2px; padding: 2px; background: rgb(254, 226, 226); border-radius: 2px; cursor: pointer; border-left: 3px solid rgb(220, 38, 38); color: rgb(220, 38, 38); font-weight: 600;"><input type="checkbox" id="basico-4" onchange="actualizarPentagono()">4.PIA</label>
                                            <label id="lbl-basico-5" style="display: flex; align-items: center; gap: 2px; padding: 2px; background: rgb(254, 226, 226); border-radius: 2px; cursor: pointer; border-left: 3px solid rgb(220, 38, 38); color: rgb(220, 38, 38); font-weight: 600;"><input type="checkbox" id="basico-5" onchange="actualizarPentagono()">5.Integración</label>
                                            <label id="lbl-basico-6" style="display: flex; align-items: center; gap: 2px; padding: 2px; background: rgb(254, 226, 226); border-radius: 2px; cursor: pointer; border-left: 3px solid rgb(220, 38, 38); color: rgb(220, 38, 38); font-weight: 600;"><input type="checkbox" id="basico-6" onchange="actualizarPentagono()">6.Screening</label>
                                            <label id="lbl-basico-7" style="display: flex; align-items: center; gap: 2px; padding: 2px; background: rgb(254, 226, 226); border-radius: 2px; cursor: pointer; border-left: 3px solid rgb(220, 38, 38); color: rgb(220, 38, 38); font-weight: 600;"><input type="checkbox" id="basico-7" onchange="actualizarPentagono()">7.80-80</label>
                                            <label id="lbl-basico-8" style="display: flex; align-items: center; gap: 2px; padding: 2px; background: rgb(254, 226, 226); border-radius: 2px; cursor: pointer; border-left: 3px solid rgb(220, 38, 38); color: rgb(220, 38, 38); font-weight: 600;"><input type="checkbox" id="basico-8" onchange="actualizarPentagono()">8.Plan local</label>
                                            <label id="lbl-basico-9" style="display: flex; align-items: center; gap: 2px; padding: 2px; background: rgb(254, 226, 226); border-radius: 2px; cursor: pointer; border-left: 3px solid rgb(220, 38, 38); color: rgb(220, 38, 38); font-weight: 600;"><input type="checkbox" id="basico-9" onchange="actualizarPentagono()">9.Stock</label>
                                            <label id="lbl-basico-10" style="display: flex; align-items: center; gap: 2px; padding: 2px; background: rgb(254, 226, 226); border-radius: 2px; cursor: pointer; border-left: 3px solid rgb(220, 38, 38); color: rgb(220, 38, 38); font-weight: 600;"><input type="checkbox" id="basico-10" onchange="actualizarPentagono()">10.Tchin</label>
                                            <label id="lbl-basico-11" style="display: flex; align-items: center; gap: 2px; padding: 2px; background: rgb(254, 226, 226); border-radius: 2px; cursor: pointer; grid-column: span 2; border-left: 3px solid rgb(220, 38, 38); color: rgb(220, 38, 38); font-weight: 600;"><input type="checkbox" id="basico-11" onchange="actualizarPentagono()">11.Infinity</label>
                                        </div>
                                    </details>
                                    <!-- Plan Local: 2 checks sutiles que desaparecen al clicar -->
                                    <div id="plan-local-selector" style="margin-top:4px;display:flex;justify-content:center;gap:12px;font-size:8px">
                                        <label style="display:flex;align-items:center;gap:3px;cursor:pointer;padding:3px 8px;background:#dcfce7;border-radius:4px;color:#16a34a;font-weight:600" onclick="planLocalSeleccionado=true;this.parentElement.style.display='none';document.getElementById('basico-8').checked=true;actualizarPentagono()">
                                            <input type="checkbox" style="display:none">✓ Sí Plan Local
                                        </label>
                                        <label style="display:flex;align-items:center;gap:3px;cursor:pointer;padding:3px 8px;background:#fee2e2;border-radius:4px;color:#dc2626;font-weight:600" onclick="planLocalSeleccionado=true;this.parentElement.style.display='none';document.getElementById('basico-8').checked=false;actualizarPentagono()">
                                            <input type="checkbox" style="display:none">✗ No Plan Local
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Canvas ocultos para donuts (compatibilidad) -->
                        <div style="display:none"><canvas id="donut-prueba" style="box-sizing: border-box; display: block; height: 0px; width: 0px;" width="0" height="0"></canvas><canvas id="donut-venta" style="box-sizing: border-box; display: block; height: 0px; width: 0px;" width="0" height="0"></canvas><canvas id="donut-screen" style="box-sizing: border-box; display: block; height: 0px; width: 0px;" width="0" height="0"></canvas></div>

                        </div>
                        <div class="inf-page" id="inf-pagina2">
                        <div class="inf-seccion"><div class="inf-seccion-titulo"><div class="inf-seccion-icono" style="background:#C9A227">📈</div><div class="inf-seccion-nombre">Aplicación KPIs relevantes</div></div><div class="inf-graficas-row"><div class="inf-grafica-box"><div class="inf-grafica-title"><div class="inf-grafica-dot" style="background:#C9A227"></div>PIA</div><div class="inf-radar-container"><canvas id="radar-pia" style="box-sizing: border-box; display: block; height: 140px; width: 296.667px;" width="445" height="210"></canvas></div><div class="inf-radar-resumen" id="resumen-pia"><strong>Promedio PIA:</strong> 0%</div></div><div class="inf-grafica-box"><div class="inf-grafica-title"><div class="inf-grafica-dot" style="background:#8B7355"></div>RT</div><div class="inf-radar-container"><canvas id="radar-rt" style="box-sizing: border-box; display: block; height: 140px; width: 296.667px;" width="445" height="210"></canvas></div><div class="inf-radar-resumen" id="resumen-rt"><strong>Promedio RT:</strong> 0%</div></div><div class="inf-grafica-box"><div class="inf-grafica-title"><div class="inf-grafica-dot" style="background:#D4AF37"></div>FORMACIÓN</div><div class="inf-radar-container"><canvas id="radar-form" style="box-sizing: border-box; display: block; height: 140px; width: 296.667px;" width="445" height="210"></canvas></div><div class="inf-radar-resumen" id="resumen-form"><strong>Promedio Formación:</strong> 0%</div></div></div></div>
                        <!-- Contenedor oculto para compatibilidad JS -->
                        <div id="resumen-general-container" style="display:none"></div>
                            <div class="inf-seccion"><div class="inf-seccion-titulo"><div class="inf-seccion-icono" style="background:#8b5cf6">📷</div><div class="inf-seccion-nombre">Galería de Imágenes</div></div>
                                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
                                    <div class="inf-galeria-item" onclick="document.getElementById('img-input-1').click()" style="position:relative;border:1px dashed #d4c68a;border-radius:8px;box-shadow:0 1px 3px rgba(201,162,39,0.08);overflow:hidden;min-height:100px;cursor:pointer;display:flex;flex-direction:column">
                                    <div class="inf-galeria-titulo" style="font-size:8px;font-weight:700;color:#666;padding:3px 6px;text-align:center;background:#f0f0f0">📍 Exterior</div>
                                    <div class="inf-galeria-placeholder" id="placeholder-1" style="display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:8px"><div class="inf-galeria-placeholder-icon">📎</div><div class="inf-galeria-placeholder-text" style="font-size:8px;color:#999">Añadir</div></div>
                                    <img id="img-preview-1" style="display:none;width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0" src="">
                                    <button id="btn-borrar-1" onclick="event.stopPropagation();eliminarArchivo(1)" style="display:none;position:absolute;top:4px;right:4px;width:22px;height:22px;background:#dc2626;color:#fff;border:none;border-radius:50%;cursor:pointer;font-size:12px;z-index:10">✕</button>
                                    <div id="file-preview-1" style="display:none" class="file-preview-box"></div>
                                    <input type="file" id="img-input-1" style="display:none" accept="image/*,.pdf,.xlsx,.xls,.doc,.docx" onchange="previewFile(1)">
                                    </div>
                                    <div class="inf-galeria-item" onclick="document.getElementById('img-input-2').click()" style="position:relative;border:1px dashed #d4c68a;border-radius:8px;box-shadow:0 1px 3px rgba(201,162,39,0.08);overflow:hidden;min-height:100px;cursor:pointer;display:flex;flex-direction:column">
                                    <div class="inf-galeria-titulo" style="font-size:8px;font-weight:700;color:#666;padding:3px 6px;text-align:center;background:#f0f0f0">🏪 Interior</div>
                                    <div class="inf-galeria-placeholder" id="placeholder-2" style="display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:8px"><div class="inf-galeria-placeholder-icon">📎</div><div class="inf-galeria-placeholder-text" style="font-size:8px;color:#999">Añadir</div></div>
                                    <img id="img-preview-2" style="display:none;width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0" src="">
                                    <button id="btn-borrar-2" onclick="event.stopPropagation();eliminarArchivo(2)" style="display:none;position:absolute;top:4px;right:4px;width:22px;height:22px;background:#dc2626;color:#fff;border:none;border-radius:50%;cursor:pointer;font-size:12px;z-index:10">✕</button>
                                    <div id="file-preview-2" style="display:none" class="file-preview-box"></div>
                                    <input type="file" id="img-input-2" style="display:none" accept="image/*,.pdf,.xlsx,.xls,.doc,.docx" onchange="previewFile(2)">
                                    </div>
                                    <div class="inf-galeria-item" onclick="document.getElementById('img-input-3').click()" style="position:relative;border:1px dashed #d4c68a;border-radius:8px;box-shadow:0 1px 3px rgba(201,162,39,0.08);overflow:hidden;min-height:100px;cursor:pointer;display:flex;flex-direction:column">
                                    <div class="inf-galeria-titulo" style="font-size:8px;font-weight:700;color:#666;padding:3px 6px;text-align:center;background:#f0f0f0">🎧 Gabinete</div>
                                    <div class="inf-galeria-placeholder" id="placeholder-3" style="display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:8px"><div class="inf-galeria-placeholder-icon">📎</div><div class="inf-galeria-placeholder-text" style="font-size:8px;color:#999">Añadir</div></div>
                                    <img id="img-preview-3" style="display:none;width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0" src="">
                                    <button id="btn-borrar-3" onclick="event.stopPropagation();eliminarArchivo(3)" style="display:none;position:absolute;top:4px;right:4px;width:22px;height:22px;background:#dc2626;color:#fff;border:none;border-radius:50%;cursor:pointer;font-size:12px;z-index:10">✕</button>
                                    <div id="file-preview-3" style="display:none" class="file-preview-box"></div>
                                    <input type="file" id="img-input-3" style="display:none" accept="image/*,.pdf,.xlsx,.xls,.doc,.docx" onchange="previewFile(3)">
                                    </div>
                                    <div class="inf-galeria-item" onclick="document.getElementById('img-input-4').click()" style="position:relative;border:1px dashed #d4c68a;border-radius:8px;box-shadow:0 1px 3px rgba(201,162,39,0.08);overflow:hidden;min-height:100px;cursor:pointer;display:flex;flex-direction:column">
                                    <div class="inf-galeria-titulo" style="font-size:8px;font-weight:700;color:#666;padding:3px 6px;text-align:center;background:#f0f0f0">🔬 Electro</div>
                                    <div class="inf-galeria-placeholder" id="placeholder-4" style="display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:8px"><div class="inf-galeria-placeholder-icon">📎</div><div class="inf-galeria-placeholder-text" style="font-size:8px;color:#999">Añadir</div></div>
                                    <img id="img-preview-4" style="display:none;width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0" src="">
                                    <button id="btn-borrar-4" onclick="event.stopPropagation();eliminarArchivo(4)" style="display:none;position:absolute;top:4px;right:4px;width:22px;height:22px;background:#dc2626;color:#fff;border:none;border-radius:50%;cursor:pointer;font-size:12px;z-index:10">✕</button>
                                    <div id="file-preview-4" style="display:none" class="file-preview-box"></div>
                                    <input type="file" id="img-input-4" style="display:none" accept="image/*,.pdf,.xlsx,.xls,.doc,.docx" onchange="previewFile(4)">
                                    </div>
                                </div>
                                <div style="display:none">
                                    <div class="inf-galeria-placeholder" id="placeholder-5"></div><img id="img-preview-5" style="display:none" src=""><button id="btn-borrar-5" style="display:none">✕</button><input type="file" id="img-input-5" style="display:none" accept="image/*,.pdf,.xlsx,.xls,.doc,.docx" onchange="previewFile(5)"><div id="file-preview-5" style="display:none"></div>
                                    <div class="inf-galeria-placeholder" id="placeholder-6"></div><img id="img-preview-6" style="display:none" src=""><button id="btn-borrar-6" style="display:none">✕</button><input type="file" id="img-input-6" style="display:none" accept="image/*,.pdf,.xlsx,.xls,.doc,.docx" onchange="previewFile(6)"><div id="file-preview-6" style="display:none"></div>
                                </div>
                            </div>
                        <!-- Sección Plan de Acción (Paquete) -->
                        <div class="inf-seccion" id="seccion-paquete-informe" style="display:none">
                            <div class="inf-seccion-titulo"><div class="inf-seccion-icono" style="background:#16a34a">📦</div><div class="inf-seccion-nombre" id="titulo-paquete-informe">Plan de Acción</div></div>
                            <div id="contenido-paquete-informe" style="background:#f8f8f8;border-radius:8px;padding:12px;border:1px solid #e0e0e0">
                                <!-- Se rellena dinámicamente -->
                            </div>
                        </div>
                            <div class="inf-seccion"><div class="inf-seccion-titulo"><div class="inf-seccion-icono" style="background:#b8960c">📝</div><div class="inf-seccion-nombre">Observaciones, Compromisos y Plan de Acción</div></div>
                                <div class="inf-textos-grid" style="display:flex;flex-direction:column;gap:8px">
                                    <div class="inf-texto-box" style="min-height:80px;border:1px solid #e8ddb5;border-radius:8px;box-shadow:0 1px 3px rgba(201,162,39,0.1)">
                                    <div class="inf-texto-header obs">🔍 OBSERVACIONES Y RECOMENDACIONES</div>
                                    <textarea class="inf-texto-area inf-numerado" id="txt-observaciones" placeholder="1. " onkeydown="manejarNumeracion(event, this)" spellcheck="false" autocorrect="off" autocomplete="off" style="flex:1;border-bottom:1px dashed #e5e7eb"></textarea>
                                    <textarea class="inf-texto-area inf-numerado" id="txt-recomendaciones" placeholder="💡 Recomendaciones..." onkeydown="manejarNumeracion(event, this)" spellcheck="false" autocorrect="off" autocomplete="off" style="min-height:60px;background:#fffbeb;border-top:none"></textarea>
                                    </div>
                                    <div class="inf-texto-box" style="min-height:80px;border:1px solid #e8ddb5;border-radius:8px;box-shadow:0 1px 3px rgba(201,162,39,0.1)">
                                    <div class="inf-texto-header comp"><span>🤝 COMPROMISOS</span><select class="inf-tiempo-select" id="tiempo-compromisos"><option value="1mes">⏱️ 1 mes</option><option value="3meses">⏱️ 3 meses</option></select></div>
                                    <textarea class="inf-texto-area inf-numerado" id="txt-compromisos" placeholder="1. " onkeydown="manejarNumeracion(event, this)" spellcheck="false" autocorrect="off" autocomplete="off" style="flex:1"></textarea>
                                    </div>
                                    <div class="inf-texto-box" style="min-height:80px;border:1px solid #e8ddb5;border-radius:8px;box-shadow:0 1px 3px rgba(201,162,39,0.1)">
                                    <div class="inf-texto-header" style="background:linear-gradient(135deg,#C9A227,#A68B1E);color:#fff"><span>🎯 PLAN DE ACCIÓN</span><span id="plan-accion-estado" style="margin-left:auto;font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(255,255,255,0.2)">—</span></div>
                                    <textarea class="inf-texto-area" id="txt-plan-accion" placeholder="Plan de acción del centro" style="background:#f0fdf4;flex:1" spellcheck="false" autocorrect="off" autocomplete="off"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <div class="inf-page" id="inf-pagina3">
                        <div class="inf-seccion" style="flex:1">
                            <div class="inf-seccion-titulo"><div class="inf-seccion-icono" style="background:#5c5c5c">⚠️</div><div class="inf-seccion-nombre">Áreas de Mejora</div></div>
                            <div style="overflow-x:auto;flex:1">
                                <table id="tabla-mejoras" style="width:100%;border-collapse:collapse;font-size:11px">
                                    <thead>
                                        <tr style="background:#f0f0f0">
                                            <th style="padding:6px 4px;text-align:left;color:#333;font-weight:700;width:18%;border:1px solid #ccc;font-size:9px">Área de Mejora</th>
                                            <th style="padding:6px 4px;text-align:left;color:#333;font-weight:700;width:67%;border:1px solid #ccc;font-size:9px">Qué debes hacer</th>
                                            <th style="padding:6px 4px;text-align:center;color:#333;font-weight:700;width:15%;border:1px solid #ccc;font-size:9px">Tiempo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="mejoras-tbody"><tr><td colspan="3" style="text-align:center;padding:10px;color:#aaa;border:1px solid #ddd">Sin datos</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="inf-mensaje-final"><div class="inf-mensaje-icon">🙏</div><div class="inf-mensaje-text">Gracias por facilitar la visita</div><div class="inf-mensaje-sub">Informe generado • Gestión Audio-Visitas</div></div>
                    </div>
                </div>
            </section>
            <!-- SECCIÓN INFORMES FINALIZADOS -->
            <section id="section-finalizados" class="section" style="overflow-y:auto">
                <div style="padding:10px">
                    <!-- Header -->
                    <div style="background:linear-gradient(135deg,#2d2d2d,#1a1a1a);color:#C9A227;padding:12px 16px;border-radius:10px;margin-bottom:12px;border-bottom:3px solid #C9A227;display:flex;align-items:center;justify-content:space-between">
                        <div style="display:flex;align-items:center;gap:10px">
                            <span style="font-size:24px">📋</span>
                            <div>
                                <h3 style="margin:0;font-size:14px;font-weight:700">Informes Finalizados</h3>
                                <p style="margin:2px 0 0 0;font-size:10px;color:#888">Informes completados que alimentan el Dashboard • Histórico de visitas</p>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center">
                            <span id="totalInformesFinalizadosCount" style="background:#C9A227;color:#fff;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700">0 informes</span>
                            <button onclick="exportarInformesFinalizados()" style="background:#16a34a;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:10px;cursor:pointer;font-weight:600">📥 Exportar</button>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div style="display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap">
                        <input type="text" id="filtroInformeFinalizado" placeholder="🔍 Buscar centro..." oninput="filtrarInformesFinalizados()" style="flex:1;min-width:200px;padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                        <select id="filtroResponsableFinalizado" onchange="filtrarInformesFinalizados()" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                            <option value="">Todos los responsables</option>
                            <option value="Ariannys Rojas">Ariannys Rojas</option>
                            <option value="Sonia Guasque">Sonia Guasque</option>
                        </select>
                        <select id="filtroMesFinalizado" onchange="filtrarInformesFinalizados()" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                            <option value="">Todos los meses</option>
                            <option value="01">Enero</option>
                            <option value="02">Febrero</option>
                            <option value="03">Marzo</option>
                            <option value="04">Abril</option>
                            <option value="05">Mayo</option>
                            <option value="06">Junio</option>
                            <option value="07">Julio</option>
                            <option value="08">Agosto</option>
                            <option value="09">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                        <select id="filtroDelegRegFinalizado" onchange="filtrarInformesFinalizados()" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                            <option value="">👤 Todos Deleg.Reg</option>
                            <option value="Blanca Fernández de la Pradilla">Blanca Fernández de la Pradilla</option>
                            <option value="Cecilia Pérez">Cecilia Pérez</option>
                            <option value="Daniel Chazo">Daniel Chazo</option>
                            <option value="Eneritz Aranguren">Eneritz Aranguren</option>
                            <option value="Laura Plazas">Laura Plazas</option>
                            <option value="Laura Ramos">Laura Ramos</option>
                            <option value="Manuel Cánovas">Manuel Cánovas</option>
                            <option value="Maribel Amezcua">Maribel Amezcua</option>
                            <option value="Marisa Carmona">Marisa Carmona</option>
                            <option value="Martín Sebastián">Martín Sebastián</option>
                            <option value="Sergio Perán">Sergio Perán</option>
                            <option value="Sonia Godino">Sonia Godino</option>
                            <option value="Verónica Alfonsín">Verónica Alfonsín</option>
                        </select>
                        <select id="filtroPropiedadFinalizado" onchange="filtrarInformesFinalizados()" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                            <option value="">🏢 Propiedad</option>
                            <option value="SUCURSAL">Sucursales</option>
                            <option value="FRANQUICIA">Franquicias</option>
                        </select>
                        <select id="filtroPerimetroFinalizado" onchange="filtrarInformesFinalizados()" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                            <option value="">📊 Perímetro</option>
                            <option value="PC">PC</option>
                            <option value="PNC">PNC</option>
                        </select>
                    </div>
                    
                    <!-- Estadísticas resumen -->
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px">
                        <div style="background:#fff;border-radius:8px;padding:12px;text-align:center;border:1px solid #e0e0e0">
                            <div style="font-size:22px;font-weight:800;color:#C9A227" id="stat-fin-total">0</div>
                            <div style="font-size:9px;color:#666">Total Finalizados</div>
                        </div>
                        <div style="background:#fff;border-radius:8px;padding:12px;text-align:center;border:1px solid #e0e0e0">
                            <div style="font-size:22px;font-weight:800;color:#16a34a" id="stat-fin-promedio">0%</div>
                            <div style="font-size:9px;color:#666">Promedio General</div>
                        </div>
                        <div style="background:#fff;border-radius:8px;padding:12px;text-align:center;border:1px solid #e0e0e0">
                            <div style="font-size:22px;font-weight:800;color:#2563eb" id="stat-fin-mes">0</div>
                            <div style="font-size:9px;color:#666">Este Mes</div>
                        </div>
                        <div style="background:#fff;border-radius:8px;padding:12px;text-align:center;border:1px solid #e0e0e0">
                            <div style="font-size:22px;font-weight:800;color:#8b5cf6" id="stat-fin-elite">0</div>
                            <div style="font-size:9px;color:#666">Centros Elite (≥85%)</div>
                        </div>
                    </div>
                    
                    <!-- Lista de informes finalizados -->
                    <div style="background:#fff;border-radius:10px;border:1px solid #e0e0e0;overflow:hidden">
                        <table style="width:100%;border-collapse:collapse;font-size:11px">
                            <thead>
                                <tr style="background:linear-gradient(135deg,#1a1a1a,#2d2d2d);color:#C9A227">
                                    <th style="padding:10px;text-align:left">Centro</th>
                                    <th style="padding:10px;text-align:center">Fecha</th>
                                    <th style="padding:10px;text-align:center">Responsable</th>
                                    <th style="padding:10px;text-align:center">Audiólogo</th>
                                    <th style="padding:10px;text-align:center">Resultado</th>
                                    <th style="padding:10px;text-align:center">Categoría</th>
                                    <th style="padding:10px;text-align:center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-informes-finalizados">
                                <tr><td colspan="7" style="text-align:center;padding:40px;color:#888">
                                    <div style="font-size:40px;margin-bottom:10px">📋</div>
                                    <div style="font-size:12px;font-weight:600">No hay informes finalizados</div>
                                    <div style="font-size:10px;color:#aaa;margin-top:4px">Los informes aparecerán aquí cuando se finalicen desde el módulo de Informe</div>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            <section id="section-exclusivos" class="section" style="overflow-y:auto">
                <div style="padding:10px">
                    <!-- Header faldón negro/gris -->
                    <div style="background:linear-gradient(135deg,#2d2d2d,#1a1a1a);color:#C9A227;padding:12px 16px;border-radius:10px;margin-bottom:12px;border-bottom:3px solid #C9A227;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
                        <div style="display:flex;align-items:center;gap:10px">
                            <button onclick="showSection('dashboard', document.querySelector('.nav-item[onclick*=dashboard]'))" style="background:#dc2626;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px">← Volver a Dashboard</button>
                            <span style="font-size:24px">⭐</span>
                            <div>
                                <h3 style="margin:0;font-size:14px;font-weight:700">Centros Exclusivos &amp; Flop</h3>
                                <p style="margin:2px 0 0 0;font-size:10px;color:#888">Seguimiento de acciones comerciales • Análisis de rendimiento</p>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <select id="filtroTipoExclusivos" onchange="filtrarExclusivosFlop()" style="padding:6px 10px;border:1px solid #C9A227;border-radius:6px;font-size:11px;background:#fff">
                                <option value="">Todos los Tipos</option>
                                <option value="FR">🟡 Franquicias</option>
                                <option value="SUC">🔵 Sucursales</option>
                            </select>
                            <select id="filtroPCPNCExclusivos" onchange="filtrarExclusivosFlop()" style="padding:6px 10px;border:1px solid #C9A227;border-radius:6px;font-size:11px;background:#fff">
                                <option value="">PC + PNC</option>
                                <option value="PC">✅ PC</option>
                                <option value="PNC">❌ PNC</option>
                            </select>
                            <select id="filtroResultadoExclusivos" onchange="filtrarExclusivosFlop()" style="padding:6px 10px;border:1px solid #C9A227;border-radius:6px;font-size:11px;background:#fff">
                                <option value="">Todos Resultados</option>
                                <option value="positivo">📈 Sobre Previsto</option>
                                <option value="negativo">📉 Bajo Previsto</option>
                            </select>
                            <input type="text" id="buscadorExclusivos" placeholder="🔍 Buscar centro..." oninput="filtrarExclusivosFlop()" style="padding:6px 12px;border:1px solid #C9A227;border-radius:6px;font-size:11px;width:180px;background:#fff">
                            <span id="contadorCifrasExclusivos" style="color:#fff;font-size:11px;font-weight:600;background:#C9A227;padding:4px 10px;border-radius:4px">214 centros</span>
                        </div>
                    </div>
                    
                    
                    <!-- CENTROS EXCLUSIVOS - Una sola columna -->
                    <div style="margin-bottom:12px">
                        <div style="background:#fff;border-radius:10px;border:2px solid #C9A227;display:flex;flex-direction:column;overflow:hidden">
                            <!-- HEADER - CLICKEABLE PARA EXPANDIR/CONTRAER -->
                            <div onclick="toggleDashboardExclusivos()" style="background:linear-gradient(135deg,#C9A227,#B8963D);padding:12px 16px;color:#fff;display:flex;align-items:center;justify-content:space-between;cursor:pointer">
                                <div style="display:flex;align-items:center;gap:10px">
                                    <span style="font-size:20px">📊</span>
                                    <div>
                                        <div style="font-size:13px;font-weight:700">Dashboard y Cifras <span id="toggleIconExclusivos" style="font-size:10px">▶ Clic para expandir</span></div>
                                        <div style="font-size:10px;opacity:0.9">214 centros con cifras</div>
                                    </div>
                                </div>
                                <div style="display:flex;gap:6px">
                                    <button onclick="event.stopPropagation();guardarCifrasExclusivos()" style="background:#10b981;color:#fff;border:none;padding:6px 12px;border-radius:4px;font-size:10px;font-weight:700;cursor:pointer">💾 GUARDAR</button>
                                    <button onclick="event.stopPropagation();abrirReporteGeneral()" style="background:#fff;color:#C9A227;border:none;padding:6px 12px;border-radius:4px;font-size:10px;font-weight:700;cursor:pointer">📊 Reporte</button>
                                </div>
                            </div>
                            
                            <!-- DASHBOARD KPIs CON GRÁFICAS - OCULTO POR DEFECTO -->
                            <div id="dashboardExclusivosContent" style="padding:12px;background:#F8F8F8;display:none">
                                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
                                    
                                    <!-- KPI ACCIONES - BARRAS HORIZONTALES -->
                                    <div style="background:#fff;border-radius:8px;padding:14px;border:1px solid #E0E0E0">
                                        <div style="display:flex;align-items:center;gap:6px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #F0F0F0">
                                            <span style="font-size:14px">📋</span>
                                            <span style="font-size:10px;font-weight:700;color:#666;text-transform:uppercase">ACCIONES</span>
                                        </div>
                                        <div style="font-size:28px;font-weight:800;color:#1A1A1A" id="kpiAcciones">0</div>
                                        <div style="font-size:9px;color:#888;margin-bottom:10px">Total acciones</div>
                                        <!-- BARRAS HORIZONTALES -->
                                        <div style="margin-bottom:8px">
                                            <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
                                                <span style="font-size:8px;color:#666;width:40px">Deriv.</span>
                                                <div style="flex:1;height:8px;background:#F0F0F0;border-radius:4px;overflow:hidden">
                                                    <div id="barDeriv" style="height:100%;background:#F59E0B;border-radius:4px;width:0%"></div>
                                                </div>
                                                <span style="font-size:10px;font-weight:700;color:#F59E0B;width:30px;text-align:right" id="kpiDerivaciones">0</span>
                                            </div>
                                            <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
                                                <span style="font-size:8px;color:#666;width:40px">Citas</span>
                                                <div style="flex:1;height:8px;background:#F0F0F0;border-radius:4px;overflow:hidden">
                                                    <div id="barCitas" style="height:100%;background:#3B82F6;border-radius:4px;width:0%"></div>
                                                </div>
                                                <span style="font-size:10px;font-weight:700;color:#B8963D;width:30px;text-align:right" id="kpiCitas">0</span>
                                            </div>
                                            <div style="display:flex;align-items:center;gap:6px">
                                                <span style="font-size:8px;color:#666;width:40px">Ventas</span>
                                                <div style="flex:1;height:8px;background:#F0F0F0;border-radius:4px;overflow:hidden">
                                                    <div id="barVentas" style="height:100%;background:#10B981;border-radius:4px;width:0%"></div>
                                                </div>
                                                <span style="font-size:10px;font-weight:700;color:#10B981;width:30px;text-align:right" id="kpiVentas">0</span>
                                            </div>
                                        </div>
                                        <div style="font-size:8px;color:#888;padding-top:6px;border-top:1px solid #F0F0F0">
                                            Conversión: <span style="font-weight:700;color:#333" id="kpiConversion">0.0</span> deriv/acción
                                        </div>
                                    </div>
                                    
                                    <!-- KPI FORMACIÓN - DONUT DORADO + NEUROVENTAS -->
                                    <div style="background:#fff;border-radius:8px;padding:14px;border:1px solid #E0E0E0">
                                        <div style="display:flex;align-items:center;gap:6px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #F0F0F0">
                                            <span style="font-size:14px">🎓</span>
                                            <span style="font-size:10px;font-weight:700;color:#666;text-transform:uppercase">FORMACIÓN</span>
                                        </div>
                                        <div style="display:flex;gap:12px;align-items:center">
                                            <!-- MINI DONUT DORADO -->
                                            <div style="position:relative;width:55px;height:55px">
                                                <svg viewBox="0 0 36 36" style="width:55px;height:55px;transform:rotate(-90deg)">
                                                    <circle cx="18" cy="18" r="14" fill="none" stroke="#E0E0E0" stroke-width="4"></circle>
                                                    <circle id="donutFormacion" cx="18" cy="18" r="14" fill="none" stroke="#C9A227" stroke-width="4" stroke-dasharray="0 88" stroke-linecap="round"></circle>
                                                </svg>
                                                <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:#C9A227" id="kpiFormacionPct">0%</div>
                                            </div>
                                            <!-- LISTA CON NEUROVENTAS -->
                                            <div style="flex:1;font-size:9px">
                                                <div style="display:flex;justify-content:space-between;margin-bottom:3px">
                                                    <span style="color:#666">Aplica 1</span>
                                                    <span style="font-weight:600;color:#C9A227" id="kpiAplica1">25%</span>
                                                </div>
                                                <div style="display:flex;justify-content:space-between;margin-bottom:3px">
                                                    <span style="color:#666">Aplica 2</span>
                                                    <span style="font-weight:600;color:#C9A227" id="kpiAplica2">25%</span>
                                                </div>
                                                <div style="display:flex;justify-content:space-between;margin-bottom:3px">
                                                    <span style="color:#666">Aplica 3</span>
                                                    <span style="font-weight:600;color:#C9A227" id="kpiAplica3">25%</span>
                                                </div>
                                                <div style="display:flex;justify-content:space-between">
                                                    <span style="color:#666">Aplica 4</span>
                                                    <span style="font-weight:600;color:#C9A227" id="kpiAplica4">25%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- KPI VISITAS - BARRAS TRIMESTRALES DORADAS -->
                                    <div style="background:#fff;border-radius:8px;padding:14px;border:1px solid #E0E0E0">
                                        <div style="display:flex;align-items:center;gap:6px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #F0F0F0">
                                            <span style="font-size:14px">🔍</span>
                                            <span style="font-size:10px;font-weight:700;color:#666;text-transform:uppercase">VISITAS</span>
                                        </div>
                                        <div style="font-size:28px;font-weight:800;color:#1A1A1A" id="kpiVisitas">0</div>
                                        <div style="font-size:9px;color:#888;margin-bottom:10px">Total visitas</div>
                                        <!-- BARRAS TRIMESTRALES DORADAS -->
                                        <div style="display:flex;align-items:flex-end;gap:8px;height:40px;margin-bottom:8px">
                                            <div style="flex:1;text-align:center">
                                                <div id="barT1" style="width:100%;background:#C9A227;border-radius:3px 3px 0 0;height:0%;min-height:4px;margin-bottom:2px"></div>
                                                <span style="font-size:7px;color:#666">T1</span>
                                            </div>
                                            <div style="flex:1;text-align:center">
                                                <div id="barT2" style="width:100%;background:#C9A227;border-radius:3px 3px 0 0;height:0%;min-height:4px;margin-bottom:2px"></div>
                                                <span style="font-size:7px;color:#666">T2</span>
                                            </div>
                                            <div style="flex:1;text-align:center">
                                                <div id="barT3" style="width:100%;background:#C9A227;border-radius:3px 3px 0 0;height:0%;min-height:4px;margin-bottom:2px"></div>
                                                <span style="font-size:7px;color:#666">T3</span>
                                            </div>
                                            <div style="flex:1;text-align:center">
                                                <div id="barT4" style="width:100%;background:#C9A227;border-radius:3px 3px 0 0;height:0%;min-height:4px;margin-bottom:2px"></div>
                                                <span style="font-size:7px;color:#666">T4</span>
                                            </div>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;font-size:8px;color:#666;padding-top:6px;border-top:1px solid #F0F0F0">
                                            <span id="kpiT1">T1: 0</span>
                                            <span id="kpiT2">T2: 0</span>
                                            <span id="kpiT3">T3: 0</span>
                                            <span id="kpiT4">T4: 0</span>
                                        </div>
                                    </div>
                                    
                                    <!-- KPI VENTAS - BARRA DE PROGRESO -->
                                    <div style="background:#fff;border-radius:8px;padding:14px;border:1px solid #E0E0E0">
                                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #F0F0F0">
                                            <div style="display:flex;align-items:center;gap:6px">
                                                <span style="font-size:14px">💰</span>
                                                <span style="font-size:10px;font-weight:700;color:#666;text-transform:uppercase">VENTAS</span>
                                            </div>
                                            <span style="font-size:8px;color:#888;background:#fff3cd;padding:2px 6px;border-radius:3px">Ago25-Ene26</span>
                                        </div>
                                        <div style="display:flex;align-items:baseline;gap:8px;margin-bottom:2px">
                                            <div style="font-size:22px;font-weight:800;color:#1A1A1A" id="kpiAcumuladoTotal">0 €</div>
                                            <span style="font-size:11px;font-weight:700" id="kpiDiferenciaTotal">0 €</span>
                                        </div>
                                        <div style="font-size:9px;color:#888;margin-bottom:10px">vs <span id="kpiPrevistoTotal">0 €</span> previsto</div>
                                        <!-- BARRA DE PROGRESO -->
                                        <div style="margin-bottom:6px">
                                            <div style="display:flex;justify-content:space-between;font-size:8px;color:#888;margin-bottom:4px">
                                                <span>0%</span>
                                                <span style="font-weight:700;color:#10B981" id="kpiObjetivoTotal">0%</span>
                                            </div>
                                            <div style="height:10px;background:#E8E8E8;border-radius:6px;overflow:hidden">
                                                <div id="barraProgresoTotal" style="height:100%;background:linear-gradient(90deg,#10B981,#34D399);border-radius:6px;width:0%"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                </div>
                            
                            <!-- TABLA DE CIFRAS - INCLUIDA EN DASHBOARD COLAPSABLE -->
                            <div style="flex:1;overflow-y:auto;padding:10px;background:#f8f9fa">
                                <div style="background:#fff;border-radius:8px;border:1px solid #e0e0e0;overflow:hidden">
                                    <div style="padding:8px 12px;background:#f8f9fa;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center">
                                        <span style="font-size:11px;font-weight:600;color:#666">📊 CIFRAS CENTROS EXCLUSIVOS</span>
                                        <span style="font-size:10px;color:#888;background:#fff3cd;padding:3px 8px;border-radius:4px;font-weight:600">📅 Agosto 25 - Enero 26</span>
                                    </div>
                                    <div style="overflow-x:auto">
                                    <table style="width:100%;border-collapse:collapse;font-size:8px;min-width:700px" id="tablaCifrasExclusivos">
                                        <thead>
                                            <tr style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff">
                                                <th style="padding:6px 4px;text-align:left;font-weight:600;width:35px">TIPO</th>
                                                <th style="padding:6px 4px;text-align:left;font-weight:600;width:45px">COD</th>
                                                <th style="padding:6px 4px;text-align:left;font-weight:600">TIENDA</th>
                                                <th style="padding:6px 4px;text-align:right;font-weight:600;width:80px">VNC AUDIO</th>
                                                <th style="padding:6px 4px;text-align:right;font-weight:600;width:80px">VNC N-1</th>
                                                <th style="padding:6px 4px;text-align:right;font-weight:600;width:60px">VS N-1</th>
                                                <th style="padding:6px 4px;text-align:right;font-weight:600;width:80px">PREVISTO</th>
                                                <th style="padding:6px 4px;text-align:right;font-weight:600;width:85px">DIF. PREV.</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbodyCifrasExclusivos">
                                            <!-- Se llena dinámicamente con cargarTablaCifrasExclusivos() -->
                                        </tbody>
                                        <tfoot>
                                            <tr style="background:#2d2d2d;color:#C9A227;font-weight:700;font-size:9px">
                                                <td colspan="3" style="padding:8px 4px">TOTALES (9 centros)</td>
                                                <td style="padding:8px 4px;text-align:right" id="totalVNC">0 €</td>
                                                <td style="padding:8px 4px;text-align:right" id="totalVNCN1">0 €</td>
                                                <td style="padding:8px 4px;text-align:right"></td>
                                                <td style="padding:8px 4px;text-align:right" id="totalPrevisto">0 €</td>
                                                <td style="padding:8px 4px;text-align:right" id="totalDiferencia">0 €</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    
                    <!-- MÓDULO ACCIONES CENTROS EXCLUSIVOS -->
                    <div style="margin-bottom:12px">
                        <div style="background:#fff;border-radius:10px;border:2px solid #C9A227;display:flex;flex-direction:column;overflow:hidden">
                            <!-- HEADER ACCIONES EXCLUSIVOS -->
                            <div style="background:linear-gradient(135deg,#C9A227,#B8963D);padding:12px 16px;color:#fff;display:flex;align-items:center;justify-content:space-between">
                                <div style="display:flex;align-items:center;gap:10px">
                                    <span style="font-size:20px">🏆</span>
                                    <div>
                                        <div style="font-size:13px;font-weight:700">Acciones Centros Exclusivos</div>
                                        <div style="font-size:10px;opacity:0.9">Registro de acciones comerciales</div>
                                    </div>
                                </div>
                                <div style="display:flex;gap:6px">
                                    <button onclick="agregarFilaAccionExclusivos()" style="background:#2d2d2d;color:#C9A227;border:none;padding:6px 12px;border-radius:4px;font-size:10px;font-weight:700;cursor:pointer">+ Nueva Acción</button>
                                    <button onclick="guardarAccionesExclusivos();alert('✅ Acciones guardadas')" style="background:#10b981;color:#fff;border:none;padding:6px 12px;border-radius:4px;font-size:10px;font-weight:700;cursor:pointer">💾 GUARDAR</button>
                                </div>
                            </div>
                            
                            <!-- PAQUETES PROPUESTOS - TARJETAS DORADAS -->
                            <div style="padding:12px;background:#fffbeb;border-bottom:1px solid #C9A227">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                                    <span style="font-size:14px">📦</span>
                                    <span style="font-size:11px;font-weight:700;color:#8B7355">Paquetes Propuestos</span>
                                    <span style="font-size:9px;color:#888">(clic para ver/ocultar detalles)</span>
                                </div>
                                
                                <!-- 3 TARJETAS DE PAQUETES DORADAS -->
                                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
                                    <!-- PAQUETE 1: TRÁFICO -->
                                    <div style="background:#fff;border-radius:8px;border:2px solid #C9A227;overflow:hidden;cursor:pointer" onclick="togglePaqueteDetalle(1)">
                                        <div style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;padding:10px 12px;display:flex;justify-content:space-between;align-items:center">
                                            <span style="font-size:11px;font-weight:700">🚦 Paquete 1: Tráfico</span>
                                            <span id="arrowPaq1" style="font-size:10px;transition:transform 0.3s">▼</span>
                                        </div>
                                        <div id="contenidoPaq1" style="display:none;padding:10px;font-size:8px;line-height:1.6;max-height:200px;overflow-y:auto;background:#fffbeb">
                                            <div style="margin-bottom:3px">☐ Dominar área social local</div>
                                            <div style="margin-bottom:3px">☐ TMK interno BBDD/Noah con seguimiento activo</div>
                                            <div style="margin-bottom:3px">☐ Screening 80%</div>
                                            <div style="margin-bottom:3px">☐ Cada miembro debe realizar al menos 2 derivaciones Audio</div>
                                            <div style="margin-bottom:3px">☐ Posibilidad de acuerdo farmacia</div>
                                            <div style="margin-bottom:3px">☐ Adherirse al SEG. SOCIAL - Contactar trabajadores sociales</div>
                                            <div style="margin-bottom:3px">☐ Elementos de comunicación: flyers, test lectura, botón</div>
                                            <div style="margin-bottom:3px">☐ Contactar al menos 4 asociaciones de interés</div>
                                            <div style="margin-bottom:3px">☐ Análisis cada 3 meses - sustituir acciones si necesario</div>
                                            <div style="margin-bottom:3px;color:#dc2626">☐ Captación calle/Centro comercial - Valorar viabilidad</div>
                                            <div style="margin-bottom:3px">☐ Mailing personalizado</div>
                                            <div style="margin-bottom:3px;color:#2563eb">☐ TMK Call Center</div>
                                            <div style="margin-bottom:3px;color:#dc2626">☐ Acciones locales activadas (radio, digital...)</div>
                                            <div style="color:#dc2626">☐ Incentivos por derivación/derivación-éxito</div>
                                        </div>
                                    </div>
                                    
                                    <!-- PAQUETE 2: COMERCIAL -->
                                    <div style="background:#fff;border-radius:8px;border:2px solid #C9A227;overflow:hidden;cursor:pointer" onclick="togglePaqueteDetalle(2)">
                                        <div style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;padding:10px 12px;display:flex;justify-content:space-between;align-items:center">
                                            <span style="font-size:11px;font-weight:700">📚 Paquete 2: Comercial</span>
                                            <span id="arrowPaq2" style="font-size:10px;transition:transform 0.3s">▼</span>
                                        </div>
                                        <div id="contenidoPaq2" style="display:none;padding:10px;font-size:8px;line-height:1.6;max-height:200px;overflow-y:auto;background:#fffbeb">
                                            <div style="margin-bottom:3px">☐ Mentoring cíclicos de Incorporaciones (temas básicos)</div>
                                            <div style="margin-bottom:3px">☐ Mentoring de categoría avanzada</div>
                                            <div style="margin-bottom:3px">☐ Mentoring con seguimiento-delegado. Revisión de funnel</div>
                                            <div style="margin-bottom:3px">☐ Visita técnica para comprobar procedimientos</div>
                                            <div style="margin-bottom:3px">☐ Formar equipo o al menos 1 miembro en AAR</div>
                                            <div style="margin-bottom:3px">☐ Fomentar HIT para clientes de pilas +3 años</div>
                                            <div style="margin-bottom:3px">☐ Análisis del funnel mensual</div>
                                            <div style="margin-bottom:3px">☐ Stock adecuado a la agenda</div>
                                            <div style="margin-bottom:3px">☐ Revisión del horario del AP y su perfil</div>
                                            <div style="margin-bottom:3px">☐ Evitar derivaciones por tapones de cera</div>
                                            <div style="margin-bottom:3px">☐ Fomentar Campo Libre para cierre de venta</div>
                                            <div style="margin-bottom:3px">☐ Conocer Infinity y ofrecer</div>
                                            <div style="margin-bottom:3px">☐ Seguimiento llamadas de rescate cada 3-6 meses</div>
                                            <div style="margin-bottom:3px">☐ Llamadas Control calidad clientes +3 años</div>
                                            <div>☐ Reforzar compromisos: Tchin Tchin, gafa regalo, garantía 4 años</div>
                                        </div>
                                    </div>
                                    
                                    <!-- PAQUETE 3: EQUIPO -->
                                    <div style="background:#fff;border-radius:8px;border:2px solid #C9A227;overflow:hidden;cursor:pointer" onclick="togglePaqueteDetalle(3)">
                                        <div style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;padding:10px 12px;display:flex;justify-content:space-between;align-items:center">
                                            <span style="font-size:11px;font-weight:700">👥 Paquete 3: Equipo</span>
                                            <span id="arrowPaq3" style="font-size:10px;transition:transform 0.3s">▼</span>
                                        </div>
                                        <div id="contenidoPaq3" style="display:none;padding:10px;font-size:8px;line-height:1.6;max-height:200px;overflow-y:auto;background:#fffbeb">
                                            <div style="margin-bottom:3px">☐ Formación del equipo de óptica de sinergias al día</div>
                                            <div style="margin-bottom:3px">☐ Screening del 80%</div>
                                            <div style="margin-bottom:3px">☐ Hacer uso de elementos de audio en el centro</div>
                                            <div style="margin-bottom:3px">☐ Revisión de incentivos por derivación</div>
                                            <div style="margin-bottom:3px">☐ Los AP deben ser activos en TMK DE NOAH-BBDD</div>
                                            <div style="margin-bottom:3px">☐ Cada miembro debe conseguir 1 derivación Audio semanal</div>
                                            <div style="margin-bottom:3px">☐ AP debe estar fuera del gabinete si no tiene citas</div>
                                            <div style="margin-bottom:3px">☐ AP debe dar primeras instrucciones al equipo óptica</div>
                                            <div style="margin-bottom:3px">☐ Agenda audio no debe tener más del 25% ocupación en revisiones</div>
                                            <div style="margin-bottom:3px">☐ Pacientes "de pilas" deben ser registrados</div>
                                            <div style="margin-bottom:3px">☐ Clientes competencia: pack PREMIUM GRATIS</div>
                                            <div style="margin-bottom:3px">☐ Formación de Audio a miembros del equipo (AAR)</div>
                                            <div style="margin-bottom:3px">☐ Formación de Audio del RT</div>
                                            <div>☐ El equipo debe saber condiciones comerciales AUDIO</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- TABLA DE ACCIONES EXCLUSIVOS -->
                            <div style="padding:12px;background:#fefce8">
                                <div style="background:#fff;border-radius:8px;border:1px solid #C9A227;overflow:hidden">
                                    <div style="overflow-x:auto">
                                    <table style="width:100%;border-collapse:collapse;font-size:11px" id="tablaAccionesExclusivos">
                                        <thead>
                                            <tr style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff">
                                                <th style="padding:10px 6px;text-align:left;font-weight:600;width:90px">CENTRO</th>
                                                <th style="padding:10px 6px;text-align:left;font-weight:600;width:95px">FECHA</th>
                                                <th style="padding:10px 6px;text-align:left;font-weight:600;width:90px">PAQUETE</th>
                                                <th style="padding:10px 6px;text-align:left;font-weight:600;width:100px">TIPO ACCIÓN</th>
                                                <th style="padding:10px 6px;text-align:center;font-weight:600;width:55px">DERIV.</th>
                                                <th style="padding:10px 6px;text-align:center;font-weight:600;width:50px">CITAS</th>
                                                <th style="padding:10px 6px;text-align:center;font-weight:600;width:50px">VENTAS</th>
                                                <th style="padding:10px 6px;text-align:center;font-weight:600;width:95px">FORMACIÓN</th>
                                                <th style="padding:10px 6px;text-align:center;font-weight:600;width:110px">ÁREA SOCIAL</th>
                                                <th style="padding:10px 6px;text-align:left;font-weight:600;width:100px">OBSERVAC.</th>
                                                <th style="padding:10px 6px;text-align:center;font-weight:600;width:85px">VISITA</th>
                                                <th style="padding:10px 6px;text-align:center;font-weight:600;width:35px"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbodyAccionesExclusivos"><tr><td colspan="12" style="padding:30px;text-align:center;color:#888;font-size:13px">No hay acciones registradas. Haz clic en "+ Nueva Acción"</td></tr></tbody>
                                        <tfoot>
                                            <tr style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;font-weight:700;font-size:11px">
                                                <td colspan="4" style="padding:10px 6px">TOTALES</td>
                                                <td style="padding:10px 6px;text-align:center;font-size:13px" id="totalDerivAcciones">0</td>
                                                <td style="padding:10px 6px;text-align:center;font-size:13px" id="totalCitasAcciones">0</td>
                                                <td style="padding:10px 6px;text-align:center;font-size:13px" id="totalVentasAcciones">0</td>
                                                <td style="padding:10px 6px;text-align:center;font-size:10px" id="totalFormacionAcciones">0%</td>
                                                <td style="padding:10px 6px;text-align:center;font-size:10px" id="totalAreaSocial">0</td>
                                                <td></td>
                                                <td style="padding:10px 6px;text-align:center;font-size:10px" id="totalVisitasAcciones">0</td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MÓDULO ACCIONES FLOP - PLEGABLE -->
                    <div id="moduloAccionesFlop" style="margin-bottom:12px">
                        <div style="background:#fff;border-radius:10px;border:2px solid #6b7280;display:flex;flex-direction:column;overflow:hidden">
                            <!-- HEADER ACCIONES FLOP - CLICKEABLE PARA PLEGAR -->
                            <div onclick="toggleSeccionFlop()" style="background:linear-gradient(135deg,#C9A227,#B08D1E);padding:12px 16px;color:#fff;display:flex;align-items:center;justify-content:space-between;cursor:pointer">
                                <div style="display:flex;align-items:center;gap:10px">
                                    <span style="font-size:20px">📉</span>
                                    <div>
                                        <div style="font-size:13px;font-weight:700">Acciones Flop</div>
                                        <div style="font-size:10px;opacity:0.9">Registro de acciones para otros centros</div>
                                    </div>
                                </div>
                                <div style="display:flex;align-items:center;gap:12px">
                                    <span id="flopArrow" style="font-size:14px;transition:transform 0.3s">▼</span>
                                </div>
                            </div>
                            
                            <!-- CONTENIDO PLEGABLE -->
                            <div id="contenidoFlop" style="display:none">
                                <!-- BUSCADOR DE CENTROS -->
                                <div style="padding:12px;background:#f3f4f6;border-bottom:1px solid #e5e7eb">
                                    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                                        <span style="font-size:14px">🔍</span>
                                        <span style="font-size:11px;font-weight:700;color:#374151">Buscar centro:</span>
                                        <input type="text" id="buscadorCentroFlop" placeholder="Escribe código o nombre del centro..." oninput="buscarCentroFlopGeneral(this.value)" style="flex:1;min-width:200px;padding:8px 12px;border:2px solid #6b7280;border-radius:6px;font-size:11px">
                                        <button onclick="agregarFilaAccionFlop()" style="background:#6b7280;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">+ Nueva Acción</button>
                                        <button onclick="guardarAccionesFlop();alert('✅ Acciones FLOP guardadas')" style="background:#10b981;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">💾 GUARDAR</button>
                                    </div>
                                    <div id="resultadosBuscadorFlop" style="display:none;margin-top:8px;background:#fff;border:1px solid #e5e7eb;border-radius:6px;max-height:150px;overflow-y:auto"></div>
                                </div>
                                
                                <!-- TABLA DE ACCIONES FLOP -->
                                <div style="padding:12px;background:#f9fafb">
                                    <div style="background:#fff;border-radius:8px;border:1px solid #e5e7eb;overflow:hidden">
                                        <div style="overflow-x:auto">
                                        <table style="width:100%;border-collapse:collapse;font-size:11px" id="tablaAccionesFlop">
                                            <thead>
                                                <tr style="background:linear-gradient(135deg,#C9A227,#B08D1E);color:#fff">
                                                    <th style="padding:10px 6px;text-align:left;font-weight:600;width:90px">CENTRO</th>
                                                    <th style="padding:10px 6px;text-align:left;font-weight:600;width:95px">FECHA</th>
                                                    <th style="padding:10px 6px;text-align:left;font-weight:600;width:90px">PAQUETE</th>
                                                    <th style="padding:10px 6px;text-align:left;font-weight:600;width:100px">TIPO ACCIÓN</th>
                                                    <th style="padding:10px 6px;text-align:center;font-weight:600;width:55px">DERIV.</th>
                                                    <th style="padding:10px 6px;text-align:center;font-weight:600;width:50px">CITAS</th>
                                                    <th style="padding:10px 6px;text-align:center;font-weight:600;width:50px">VENTAS</th>
                                                    <th style="padding:10px 6px;text-align:center;font-weight:600;width:95px">FORMACIÓN</th>
                                                    <th style="padding:10px 6px;text-align:center;font-weight:600;width:110px">ÁREA SOCIAL</th>
                                                    <th style="padding:10px 6px;text-align:left;font-weight:600;width:100px">OBSERVAC.</th>
                                                    <th style="padding:10px 6px;text-align:center;font-weight:600;width:85px">VISITA</th>
                                                    <th style="padding:10px 6px;text-align:center;font-weight:600;width:35px"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="tbodyAccionesFlop"><tr><td colspan="12" style="padding:30px;text-align:center;color:#888;font-size:13px">No hay acciones FLOP registradas. Haz clic en "+ Nueva Acción"</td></tr></tbody>
                                            <tfoot>
                                                <tr style="background:linear-gradient(135deg,#C9A227,#B08D1E);color:#fff;font-weight:700;font-size:11px">
                                                    <td colspan="4" style="padding:10px 6px">TOTALES</td>
                                                    <td style="padding:10px 6px;text-align:center;font-size:13px" id="totalDerivAccionesFlop">0</td>
                                                    <td style="padding:10px 6px;text-align:center;font-size:13px" id="totalCitasAccionesFlop">0</td>
                                                    <td style="padding:10px 6px;text-align:center;font-size:13px" id="totalVentasAccionesFlop">0</td>
                                                    <td style="padding:10px 6px;text-align:center;font-size:10px" id="totalFormacionFlop">0%</td>
                                                    <td style="padding:10px 6px;text-align:center;font-size:10px" id="totalAreaSocialFlop">0</td>
                                                    <td></td>
                                                    <td style="padding:10px 6px;text-align:center;font-size:10px" id="totalVisitasFlop">0</td>
                                                    <td></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Ficha de Acciones -->
                <div id="modalAcciones" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:10000;align-items:center;justify-content:center;padding:20px;overflow-y:auto">
                    <div style="background:#fff;border-radius:12px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;border:3px solid #C9A227">
                        <!-- Header del modal -->
                        <div style="padding:16px 20px;border-bottom:3px solid #C9A227;background:linear-gradient(135deg,#2d2d2d,#1a1a1a);position:sticky;top:0;z-index:1">
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <h3 style="margin:0;font-size:16px;font-weight:700;color:#C9A227">📋 Ficha de Acciones</h3>
                                <button onclick="cerrarModalAcciones()" style="background:#5c5c5c;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:600">✕ Cerrar</button>
                            </div>
                        </div>
                        
                        <!-- Info del centro -->
                        <div style="padding:16px 20px;background:#f8f8f8;border-bottom:1px solid #e0e0e0">
                            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
                                <div>
                                    <label style="font-size:9px;color:#888;font-weight:600;display:block;margin-bottom:2px">CÓDIGO</label>
                                    <div style="font-size:14px;font-weight:700;color:#C9A227" id="accionCentroCodigo">-</div>
                                </div>
                                <div>
                                    <label style="font-size:9px;color:#888;font-weight:600;display:block;margin-bottom:2px">CENTRO</label>
                                    <div style="font-size:12px;font-weight:600;color:#333" id="accionCentroNombre">-</div>
                                </div>
                                <div>
                                    <label style="font-size:9px;color:#888;font-weight:600;display:block;margin-bottom:2px">DELEGADO</label>
                                    <div style="font-size:11px;color:#666" id="accionCentroDelegado">-</div>
                                </div>
                                <div>
                                    <label style="font-size:9px;color:#888;font-weight:600;display:block;margin-bottom:2px">PROPIETARIO</label>
                                    <div style="font-size:11px;color:#666" id="accionCentroPropietario">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SELECTOR DE PAQUETE -->
                        <div style="padding:16px 20px;border-bottom:1px solid #e0e0e0">
                            <div style="font-size:12px;font-weight:700;color:#333;margin-bottom:10px">📦 Seleccionar Paquete de Acción</div>
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px" id="selectorPaquetesModal">
                                <button onclick="seleccionarPaqueteModal(1)" id="btn-paq-1" style="padding:12px;border:2px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;transition:all 0.3s">
                                    <div style="font-size:11px;font-weight:700;color:#16a34a">PAQUETE 1</div>
                                    <div style="font-size:14px;font-weight:800;color:#16a34a">🚦 TRÁFICO</div>
                                </button>
                                <button onclick="seleccionarPaqueteModal(2)" id="btn-paq-2" style="padding:12px;border:2px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;transition:all 0.3s">
                                    <div style="font-size:11px;font-weight:700;color:#2563eb">PAQUETE 2</div>
                                    <div style="font-size:14px;font-weight:800;color:#2563eb">📚 COMERCIAL-FORMACIÓN</div>
                                </button>
                                <button onclick="seleccionarPaqueteModal(3)" id="btn-paq-3" style="padding:12px;border:2px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;transition:all 0.3s">
                                    <div style="font-size:11px;font-weight:700;color:#9333ea">PAQUETE 3</div>
                                    <div style="font-size:14px;font-weight:800;color:#9333ea">👥 EQUIPO</div>
                                </button>
                            </div>
                            <div id="paqueteSeleccionadoInfo" style="margin-top:8px;text-align:center;font-size:10px;color:#666"></div>
                        </div>
                        
                        <!-- Estadísticas -->
                        <div style="padding:12px 20px;background:#f8f8f8;border-bottom:1px solid #e0e0e0">
                            <div style="display:flex;gap:20px">
                                <div style="display:flex;align-items:center;gap:6px">
                                    <span style="font-size:16px">📊</span>
                                    <div>
                                        <div style="font-size:9px;color:#888">VISITAS REALIZADAS</div>
                                        <div style="font-size:16px;font-weight:800;color:#C9A227" id="accionVisitasCount">0</div>
                                    </div>
                                </div>
                                <div style="display:flex;align-items:center;gap:6px">
                                    <span style="font-size:16px">📋</span>
                                    <div>
                                        <div style="font-size:9px;color:#888">Acciones Registradas</div>
                                        <div style="font-size:16px;font-weight:800;color:#6b7280" id="accionTotalAcciones">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabla de acciones -->
                        <div style="padding:16px 20px">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                <h4 style="margin:0;font-size:12px;color:#333;font-weight:700">📝 Registro de Acciones</h4>
                                <button onclick="agregarFilaAccion()" style="background:linear-gradient(135deg,#C9A227,#a88b1e);color:#fff;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600">+ Nueva Acción</button>
                            </div>
                            
                            <!-- Tabla tipo Excel -->
                            <div style="overflow-x:auto;border:1px solid #e0e0e0;border-radius:8px">
                                <table style="width:100%;border-collapse:collapse;font-size:10px;min-width:800px" id="tablaAcciones">
                                    <thead>
                                        <tr style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff">
                                            <th style="padding:10px 8px;text-align:left;font-weight:600;width:100px">FECHA</th>
                                            <th style="padding:10px 8px;text-align:left;font-weight:600;width:180px">TIPO ACCIÓN</th>
                                            <th style="padding:10px 8px;text-align:center;font-weight:600;width:80px">DERIVAC.</th>
                                            <th style="padding:10px 8px;text-align:center;font-weight:600;width:70px">CITAS</th>
                                            <th style="padding:10px 8px;text-align:center;font-weight:600;width:70px">VENTAS</th>
                                            <th style="padding:10px 8px;text-align:left;font-weight:600">OBSERVACIONES</th>
                                            <th style="padding:10px 8px;text-align:center;font-weight:600;width:50px">🗑️</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyAcciones">
                                        <tr>
                                            <td colspan="7" style="padding:30px;text-align:center;color:#888;font-style:italic">No hay acciones registradas. Haz clic en "+ Nueva Acción" para comenzar.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Resumen -->
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px">
                                <div style="background:#dcfce7;padding:10px;border-radius:6px;text-align:center">
                                    <div style="font-size:9px;color:#166534;font-weight:600">Total Derivaciones</div>
                                    <div style="font-size:20px;font-weight:800;color:#C9A227" id="totalDerivaciones">0</div>
                                </div>
                                <div style="background:#dbeafe;padding:10px;border-radius:6px;text-align:center">
                                    <div style="font-size:9px;color:#1e40af;font-weight:600">Total Citas</div>
                                    <div style="font-size:20px;font-weight:800;color:#6b7280" id="totalCitas">0</div>
                                </div>
                                <div style="background:#fef3c7;padding:10px;border-radius:6px;text-align:center">
                                    <div style="font-size:9px;color:#8B7355;font-weight:600">Total Ventas</div>
                                    <div style="font-size:20px;font-weight:800;color:#b8960c" id="totalVentas">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer con botón guardar -->
                        <div style="padding:16px 20px;border-top:1px solid #e0e0e0;background:#f8f8f8;display:flex;justify-content:flex-end;gap:10px;position:sticky;bottom:0">
                            <button onclick="cerrarModalAcciones()" style="background:#6b7280;color:#fff;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;font-weight:600">Cancelar</button>
                            <button onclick="guardarAcciones()" style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;padding:10px 30px;border-radius:6px;cursor:pointer;font-weight:700;font-size:12px">💾 Guardar Acciones</button>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Seleccionar FLOP -->
                <div id="modalSeleccionarFlop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;align-items:center;justify-content:center;padding:20px">
                    <div style="background:#fff;border-radius:10px;max-width:500px;width:100%;max-height:80vh;overflow:hidden;border:3px solid #5c5c5c">
                        <div style="padding:12px 16px;border-bottom:3px solid #5c5c5c;background:linear-gradient(135deg,#5c5c5c,#4a4a4a)">
                            <h3 style="margin:0;font-size:14px;font-weight:700;color:#fff">📉 Seleccionar Centro FLOP</h3>
                        </div>
                        <div style="padding:12px">
                            <input type="text" id="buscadorFlopModal" placeholder="🔍 Buscar centro..." oninput="filtrarCentrosFlopModal()" style="width:100%;padding:8px 12px;border:1px solid #5c5c5c;border-radius:6px;font-size:11px;margin-bottom:10px">
                            <div id="listaCentrosFlopModal" style="max-height:300px;overflow-y:auto"></div>
                        </div>
                        <div style="padding:12px;border-top:1px solid #e0e0e0;display:flex;justify-content:flex-end">
                            <button onclick="cerrarModalSeleccionarFlop()" style="background:#6b7280;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600">Cancelar</button>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Reporte Consolidado -->
                <div id="modalReporte" style="display: none; position: fixed; inset: 0px; background: rgba(0, 0, 0, 0.7); z-index: 10000; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;">
                    <div style="background:#fff;border-radius:12px;max-width:1000px;width:100%;max-height:90vh;overflow-y:auto;border:3px solid #C9A227">
                        <!-- Header -->
                        <div style="padding:16px 20px;border-bottom:3px solid #C9A227;background:linear-gradient(135deg,#2d2d2d,#1a1a1a);position:sticky;top:0;z-index:1;display:flex;justify-content:space-between;align-items:center">
                            <h3 style="margin:0;font-size:16px;font-weight:700;color:#C9A227" id="reporteTitulo">📊 REPORTE CENTROS EXCLUSIVOS</h3>
                            <div style="display:flex;gap:8px">
                                <button onclick="imprimirReporte()" style="background:#C9A227;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600;font-size:11px">🖨️ Imprimir</button>
                                <button onclick="cerrarModalReporte()" style="background:#5c5c5c;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600">✕ Cerrar</button>
                            </div>
                        </div>
                        
                        <!-- Resumen General -->
                        <div style="padding:16px 20px;background:#f8f8f8;border-bottom:1px solid #e0e0e0">
                            <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px">
                                <div style="background:linear-gradient(135deg,#C9A227,#B8963D);padding:12px;border-radius:8px;text-align:center">
                                    <div style="font-size:9px;color:rgba(255,255,255,0.8);font-weight:600">CENTROS</div>
                                    <div style="font-size:24px;font-weight:800;color:#fff" id="reporteTotalCentros">9</div>
                                </div>
                                <div style="background:linear-gradient(135deg,#8b5cf6,#6b6b6b);padding:12px;border-radius:8px;text-align:center">
                                    <div style="font-size:9px;color:rgba(255,255,255,0.8);font-weight:600">ACCIONES</div>
                                    <div style="font-size:24px;font-weight:800;color:#fff" id="reporteTotalAcciones">0</div>
                                </div>
                                <div style="background:linear-gradient(135deg,#C9A227,#a88b1e);padding:12px;border-radius:8px;text-align:center">
                                    <div style="font-size:9px;color:rgba(255,255,255,0.8);font-weight:600">DERIVACIONES</div>
                                    <div style="font-size:24px;font-weight:800;color:#fff" id="reporteTotalDerivaciones">0</div>
                                </div>
                                <div style="background:linear-gradient(135deg,#C9A227,#B08D1E);padding:12px;border-radius:8px;text-align:center">
                                    <div style="font-size:9px;color:rgba(255,255,255,0.8);font-weight:600">CITAS</div>
                                    <div style="font-size:24px;font-weight:800;color:#fff" id="reporteTotalCitas">0</div>
                                </div>
                                <div style="background:linear-gradient(135deg,#b8960c,#9a7d0a);padding:12px;border-radius:8px;text-align:center">
                                    <div style="font-size:9px;color:rgba(255,255,255,0.8);font-weight:600">Ventas</div>
                                    <div style="font-size:24px;font-weight:800;color:#fff" id="reporteTotalVentas">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabla detallada -->
                        <div style="padding:16px 20px" id="reporteContenido"><p style="text-align:center;color:#888;padding:40px">No hay acciones registradas en estos centros</p></div>
                    </div>
                </div>
            </section>
            
            <!-- ==================== SECCIÓN AAR ==================== -->
            <section id="section-aar" class="section" style="overflow-y:auto">
                <div style="padding:0">
                    <!-- HEADER AAR -->
                    <div style="background:linear-gradient(135deg,#555,#444);padding:16px 20px;color:#fff;display:flex;justify-content:space-between;align-items:center;border-radius:10px;margin-bottom:12px;border:2px solid #C9A227">
                        <div style="display:flex;align-items:center;gap:12px">
                            <button onclick="showSection('dashboard', document.querySelector('.nav-item[onclick*=dashboard]'))" style="background:#dc2626;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px">← Volver a Dashboard</button>
                            <span style="font-size:28px">🎯</span>
                            <div>
                                <div style="font-size:18px;font-weight:700;color:#C9A227">Gestión de informes Audio</div>
                                <div style="font-size:11px;opacity:0.9">Seguimiento de citas y actividades</div>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px">
                            <button onclick="imprimirInformeAAR()" style="background:#C9A227;color:#1a1a1a;border:none;padding:8px 16px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">🖨️ Informe</button>
                            <button onclick="resetearAAR()" style="background:#777;color:#fff;border:none;padding:8px 12px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">🔄</button>
                            <button onclick="mostrarFormularioAAR()" style="background:#fff;color:#333;border:none;padding:8px 16px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">+ Añadir Servicio</button>
                            <button onclick="guardarAAR();alert('✅ Guardado')" style="background:#065F46;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">💾</button>
                        </div>
                    </div>
                    
                    <!-- 1. HEADER DASHBOARD AAR - FALDÓN DORADO -->
                    <div onclick="toggleDashboardAAR()" style="background:linear-gradient(135deg,#C9A227,#B8963D);padding:10px 16px;color:#fff;border-radius:8px;margin-bottom:8px;cursor:pointer;display:flex;align-items:center;justify-content:space-between">
                        <div style="display:flex;align-items:center;gap:8px">
                            <span style="font-size:16px">📊</span>
                            <span style="font-size:12px;font-weight:700">Dashboard AAR <span id="toggleIconAAR" style="font-size:10px">▶</span></span>
                        </div>
                    </div>
                    
                    <!-- DASHBOARD AAR - OCULTO POR DEFECTO -->
                    <div id="dashboardAARContent" style="display:none">
                    <div style="display:grid;grid-template-columns:1.2fr 1fr 0.8fr 1fr;gap:12px;margin-bottom:12px">
                        
                        <!-- BARRAS REVISIONES -->
                        <div id="cardRevisiones" style="background:#f5f5f5;border-radius:10px;padding:15px;border:2px solid #e0e0e0">
                            <div style="font-size:11px;color:#666;margin-bottom:8px;font-weight:700;display:flex;align-items:center;justify-content:space-between">
                                <span><span>📊</span> REVISIONES</span>
                                <span style="background:#C9A227;color:#1a1a1a;padding:2px 8px;border-radius:10px;font-size:10px" id="aarTotalRevisiones">52</span>
                            </div>
                            <div style="margin-bottom:8px">
                                <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:4px">
                                    <span style="color:#333">Primeras visitas-con pérdida</span>
                                    <span style="color:#dc2626;font-weight:700" id="aarBarConPerdida">21</span>
                                </div>
                                <div style="height:8px;background:#ddd;border-radius:4px;overflow:hidden">
                                    <div id="aarBarConPerdidaFill" style="height: 100%; background: linear-gradient(90deg, #dc2626, #ef4444); border-radius: 4px; width: 40.3846%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div style="margin-bottom:8px">
                                <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:4px">
                                    <span style="color:#333">Revisiones post venta</span>
                                    <span style="color:#C9A227;font-weight:700" id="aarBarPostVenta">15</span>
                                </div>
                                <div style="height:8px;background:#ddd;border-radius:4px;overflow:hidden">
                                    <div id="aarBarPostVentaFill" style="height: 100%; background: linear-gradient(90deg, #C9A227, #E5B82A); border-radius: 4px; width: 28.8462%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:4px">
                                    <span style="color:#333">Primeras visitas-sin pérdida</span>
                                    <span style="color:#888;font-weight:700" id="aarBarSinPerdida">16</span>
                                </div>
                                <div style="height:8px;background:#ddd;border-radius:4px;overflow:hidden">
                                    <div id="aarBarSinPerdidaFill" style="height: 100%; background: linear-gradient(90deg, #888, #aaa); border-radius: 4px; width: 30.7692%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- EMBUDO CONVERSIÓN -->
                        <div id="cardEmbudo" style="background:#fff;border-radius:10px;padding:8px;border:2px solid #C9A227;display:flex;flex-direction:column;height:100%">
                            <div style="font-size:11px;color:#666;margin-bottom:10px;font-weight:700;text-align:center">
                                🔄 CONVERSIONES
                            </div>
                            <div style="flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center">
                                <div style="background:#C9A227;color:#1a1a1a;padding:6px 4px;font-weight:700;font-size:7px;border-radius:2px 2px 0 0;width:70%;text-align:center;line-height:1.3">
                                    <div>1ª Visita c/pérd.</div>
                                    <div><span id="aarFunnelPerdida">21</span> <span style="font-size:6px">(100%)</span></div>
                                </div>
                                <div style="background:#F59E0B;color:#1a1a1a;padding:6px 4px;font-weight:700;font-size:7px;width:55%;text-align:center;line-height:1.3">
                                    <div>Prueban</div>
                                    <div><span id="aarFunnelPrueban">17</span> <span style="font-size:6px" id="aarPctPrueban">(81%)</span></div>
                                </div>
                                <div style="background:#22c55e;color:#fff;padding:6px 4px;font-weight:700;font-size:7px;width:42%;text-align:center;line-height:1.3">
                                    <div>Compran</div>
                                    <div><span id="aarFunnelCompran">16</span> <span style="font-size:6px" id="aarPctCompran">(94%)</span></div>
                                </div>
                                <div style="background:#dc2626;color:#fff;padding:6px 4px;font-weight:700;font-size:7px;border-radius:0 0 2px 2px;width:30%;text-align:center;line-height:1.3">
                                    <div>Devuelven</div>
                                    <div><span id="aarFunnelDevuelven">1</span> <span style="font-size:6px" id="aarPctDevuelven">(6%)</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- NPS GAUGE -->
                        <div id="cardNPS" style="background:#fff;border-radius:10px;padding:15px;border:2px solid #C9A227;text-align:center">
                            <div style="font-size:11px;color:#666;margin-bottom:5px;font-weight:700">⭐ NPS</div>
                            <div style="font-size:36px;font-weight:800;color:#C9A227" id="aarNPSGauge">9.7</div>
                            <div style="height:8px;background:linear-gradient(90deg,#ef4444,#f59e0b,#10b981);border-radius:4px;margin:8px 0;position:relative">
                                <div id="aarNPSMarker" style="position: absolute; top: -4px; width: 14px; height: 14px; background: rgb(85, 85, 85); border: 2px solid rgb(201, 162, 39); border-radius: 50%; left: calc(97% - 7px);"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;font-size:8px;color:#888">
                                <span>0</span><span>5</span><span>10</span>
                            </div>
                        </div>
                        
                        <!-- VENTAS Y CIFRAS -->
                        <div id="cardVentas" style="background:#fff;border-radius:10px;padding:15px;border:2px solid #C9A227">
                            <div style="font-size:11px;color:#666;margin-bottom:10px;font-weight:700;display:flex;align-items:center;gap:6px">
                                <span>💰</span> VENTAS
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
                                <div style="background:#f5f5f5;border-radius:6px;padding:8px;text-align:center">
                                    <div style="font-size:22px;font-weight:800;color:#C9A227" id="aarVentasUnidades">16</div>
                                    <div style="font-size:8px;color:#666">Unidades</div>
                                </div>
                                <div style="background:#f5f5f5;border-radius:6px;padding:8px;text-align:center">
                                    <div style="font-size:16px;font-weight:800;color:#555" id="aarTicketMedio">3623€</div>
                                    <div style="font-size:8px;color:#666">Ticket Medio</div>
                                </div>
                            </div>
                            <div style="background:#C9A227;border-radius:6px;padding:10px;text-align:center">
                                <div style="font-size:20px;font-weight:800;color:#1a1a1a" id="aarFacturacionTotal">57.969€</div>
                                <div style="font-size:9px;color:#1a1a1a;opacity:0.8">Facturación Total</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RANKING: TÉCNICOS Y AUDIÓLOGOS -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
                        <!-- RANKING TÉCNICOS -->
                        <div style="background:#fff;border-radius:10px;border:2px solid #555;overflow:hidden">
                            <div style="background:#555;padding:10px 14px;color:#C9A227;display:flex;align-items:center;gap:8px">
                                <span style="font-size:14px">🏆</span>
                                <span style="font-size:11px;font-weight:700">Ranking Técnicos</span>
                                <span style="font-size:8px;color:#aaa;margin-left:auto">(Tienda Origen)</span>
                            </div>
                            <div id="panelTecnicos" style="max-height:150px;overflow-y:auto"><table style="width:100%;border-collapse:collapse;font-size:10px"><tbody><tr style="background:#f5f5f5"><th style="padding:6px;text-align:center;width:28px">#</th><th style="padding:6px;text-align:left">Técnico</th><th style="padding:6px;text-align:center;width:45px;color:#C9A227">Vtas</th><th style="padding:6px;text-align:center;width:45px">Rev.</th></tr><tr style="background:#fff;border-bottom:1px solid #eee"><td style="padding:5px;text-align:center;font-size:11px">🥇</td><td style="padding:5px;font-weight:500;font-size:9px">Madrid Aranjuez</td><td style="padding:5px;text-align:center;font-weight:700;color:#C9A227">11</td><td style="padding:5px;text-align:center;font-weight:700">20</td></tr><tr style="background:#fafafa;border-bottom:1px solid #eee"><td style="padding:5px;text-align:center;font-size:11px">🥈</td><td style="padding:5px;font-weight:500;font-size:9px">Gerona Miguel Santaló</td><td style="padding:5px;text-align:center;font-weight:700;color:#C9A227">3</td><td style="padding:5px;text-align:center;font-weight:700">26</td></tr><tr style="background:#fff;border-bottom:1px solid #eee"><td style="padding:5px;text-align:center;font-size:11px">🥉</td><td style="padding:5px;font-weight:500;font-size:9px">Gerona-4FIG</td><td style="padding:5px;text-align:center;font-weight:700;color:#C9A227">1</td><td style="padding:5px;text-align:center;font-weight:700">5</td></tr><tr style="background:#fafafa;border-bottom:1px solid #eee"><td style="padding:5px;text-align:center;font-size:11px">4</td><td style="padding:5px;font-weight:500;font-size:9px">Madrid Lagavia</td><td style="padding:5px;text-align:center;font-weight:700;color:#C9A227">1</td><td style="padding:5px;text-align:center;font-weight:700">1</td></tr></tbody></table></div>
                        </div>
                        
                        <!-- RANKING AUDIÓLOGOS -->
                        <div style="background:#fff;border-radius:10px;border:2px solid #C9A227;overflow:hidden">
                            <div style="background:linear-gradient(135deg,#C9A227,#B8963D);padding:10px 14px;color:#1a1a1a;display:flex;align-items:center;gap:8px">
                                <span style="font-size:14px">🏆</span>
                                <span style="font-size:11px;font-weight:700">Ranking Audiólogos</span>
                                <span style="font-size:8px;color:#1a1a1a;opacity:0.7;margin-left:auto">(Tienda Destino)</span>
                            </div>
                            <div id="panelAudiologos" style="max-height:150px;overflow-y:auto"><table style="width:100%;border-collapse:collapse;font-size:10px"><tbody><tr style="background:#fffbeb"><th style="padding:6px;text-align:center;width:28px">#</th><th style="padding:6px;text-align:left">Audiólogo</th><th style="padding:6px;text-align:center;width:45px;color:#C9A227">Vtas</th><th style="padding:6px;text-align:center;width:45px">Rev.</th></tr><tr style="background:#fff;border-bottom:1px solid #eee"><td style="padding:5px;text-align:center;font-size:11px">🥇</td><td style="padding:5px;font-weight:500;font-size:9px">CC Plaza de la Estación</td><td style="padding:5px;text-align:center;font-weight:700;color:#C9A227">11</td><td style="padding:5px;text-align:center;font-weight:700">45</td></tr><tr style="background:#fffbf5;border-bottom:1px solid #eee"><td style="padding:5px;text-align:center;font-size:11px">🥈</td><td style="padding:5px;font-weight:500;font-size:9px">Aznalfarache</td><td style="padding:5px;text-align:center;font-weight:700;color:#C9A227">3</td><td style="padding:5px;text-align:center;font-weight:700">4</td></tr><tr style="background:#fff;border-bottom:1px solid #eee"><td style="padding:5px;text-align:center;font-size:11px">🥉</td><td style="padding:5px;font-weight:500;font-size:9px">Santander CC Peñacastillo</td><td style="padding:5px;text-align:center;font-weight:700;color:#C9A227">2</td><td style="padding:5px;text-align:center;font-weight:700">2</td></tr><tr style="background:#fffbf5;border-bottom:1px solid #eee"><td style="padding:5px;text-align:center;font-size:11px">4</td><td style="padding:5px;font-weight:500;font-size:9px">Torrelavega Carrefour CC</td><td style="padding:5px;text-align:center;font-weight:700;color:#C9A227">0</td><td style="padding:5px;text-align:center;font-weight:700">1</td></tr></tbody></table></div>
                        </div>
                    </div>
                    </div>
                    
                    <!-- 2. ACTIVIDAD - FALDÓN DORADO -->
                    <div onclick="toggleEditorExcelAAR()" style="background:linear-gradient(135deg,#C9A227,#B8963D);padding:10px 16px;color:#fff;border-radius:8px;margin-bottom:8px;cursor:pointer;display:flex;align-items:center;justify-content:space-between">
                        <div style="display:flex;align-items:center;gap:8px">
                            <span style="font-size:16px">📋</span>
                            <span style="font-size:12px;font-weight:700">ACTIVIDAD <span id="toggleIconEditorExcel" style="font-size:10px">▶</span></span>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center" onclick="event.stopPropagation()">
                            <button onclick="mostrarFormularioAAR()" style="background:#fff;color:#C9A227;border:none;padding:5px 12px;border-radius:5px;font-size:10px;font-weight:700;cursor:pointer">+ Actividad</button>
                            <span style="font-size:10px;opacity:0.9" id="editorExcelCount">0 registros</span>
                        </div>
                    </div>
                    
                    <!-- ACTIVIDAD - OCULTO POR DEFECTO -->
                    <div id="editorExcelContent" style="display:none;margin-bottom:12px">
                        <!-- FILTROS ACTIVIDAD -->
                        <div style="background:#fff;border-radius:10px;padding:12px;margin-bottom:12px;border:2px solid #C9A227;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
                            <div style="font-size:11px;color:#666;font-weight:700">🔍 Filtros:</div>
                            <div>
                                <label style="font-size:9px;color:#888">Desde</label>
                                <input type="date" id="aarFiltroDesde" onchange="filtrarTablaAAR()" style="padding:5px 8px;border:1px solid #ddd;border-radius:4px;font-size:10px">
                            </div>
                            <div>
                                <label style="font-size:9px;color:#888">Hasta</label>
                                <input type="date" id="aarFiltroHasta" onchange="filtrarTablaAAR()" style="padding:5px 8px;border:1px solid #ddd;border-radius:4px;font-size:10px">
                            </div>
                            <div>
                                <label style="font-size:9px;color:#888">Servicio</label>
                                <select id="aarFiltroServicio" onchange="filtrarTablaAAR()" style="padding:5px 8px;border:1px solid #ddd;border-radius:4px;font-size:10px">
                                    <option value="">Todos</option>
                                    <option value="Primera Visita">Primera Visita</option>
                                    <option value="Ajustes">Ajustes</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:9px;color:#888">Estado</label>
                                <select id="aarFiltroEstado" onchange="filtrarTablaAAR()" style="padding:5px 8px;border:1px solid #ddd;border-radius:4px;font-size:10px">
                                    <option value="">Todos</option>
                                    <option value="Abierto">Abierto</option>
                                    <option value="En curso">En curso</option>
                                    <option value="Cerrado">Cerrado</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:9px;color:#888">Origen</label>
                                <select id="aarFiltroOrigen" onchange="filtrarTablaAAR()" style="padding:5px 8px;border:1px solid #ddd;border-radius:4px;font-size:10px;max-width:150px">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:9px;color:#888">Destino</label>
                                <select id="aarFiltroDestino" onchange="filtrarTablaAAR()" style="padding:5px 8px;border:1px solid #ddd;border-radius:4px;font-size:10px;max-width:150px">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:9px;color:#888">Revisión</label>
                                <select id="aarFiltroRevision" onchange="filtrarTablaAAR()" style="padding:5px 8px;border:1px solid #ddd;border-radius:4px;font-size:10px">
                                    <option value="">Todas</option>
                                    <option value="Si">Con pérdida</option>
                                    <option value="No">Sin pérdida</option>
                                    <option value="Ajuste post venta">Ajuste post venta</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:9px;color:#888">Cierre</label>
                                <select id="aarFiltroCierre" onchange="filtrarTablaAAR()" style="padding:5px 8px;border:1px solid #ddd;border-radius:4px;font-size:10px">
                                    <option value="">Todos</option>
                                    <option value="Venta">Venta</option>
                                    <option value="Devuelto">Devuelto</option>
                                    <option value="Perdido">Perdido</option>
                                </select>
                            </div>
                            <button onclick="limpiarFiltrosAAR()" style="background:#C9A227;color:#000;border:none;padding:6px 12px;border-radius:5px;font-size:10px;font-weight:600;cursor:pointer">✕ Limpiar</button>
                            <span style="margin-left:auto;font-size:10px;color:#666" id="contadorFiltroAAR">Mostrando: 0 de 0</span>
                        </div>
                        
                        <!-- TABLA ACTIVIDAD -->
                        <div style="background:#fff;border-radius:10px;border:2px solid #C9A227;overflow:hidden">
                            <div style="overflow-x:auto;max-height:400px;overflow-y:auto">
                                <table style="width:100%;border-collapse:collapse;font-size:10px" id="tablaAAR">
                                    <thead style="position:sticky;top:0;z-index:1">
                                        <tr style="background:#666;color:#fff">
                                            <th style="padding:10px 6px;text-align:left;font-weight:600;width:90px">FECHA</th>
                                            <th style="padding:10px 6px;text-align:left;font-weight:600;width:90px">SERVICIO</th>
                                            <th style="padding:10px 6px;text-align:center;font-weight:600;width:75px">ESTADO</th>
                                            <th style="padding:10px 6px;text-align:left;font-weight:600">ORIGEN</th>
                                            <th style="padding:10px 6px;text-align:left;font-weight:600">DESTINO</th>
                                            <th style="padding:10px 6px;text-align:center;font-weight:600;width:80px">REVISIÓN</th>
                                            <th style="padding:10px 6px;text-align:center;font-weight:600;width:65px">PRUEBA</th>
                                            <th style="padding:10px 6px;text-align:center;font-weight:600;width:75px">CIERRE</th>
                                            <th style="padding:10px 6px;text-align:right;font-weight:600;width:60px">PVP</th>
                                            <th style="padding:10px 6px;text-align:center;font-weight:600;width:50px">NPS</th>
                                            <th style="padding:10px 6px;text-align:center;font-weight:600;width:35px"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyEditorExcelAAR">
                                        <!-- Se genera dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 3. RETROPLANNING AAR - FALDÓN GRIS -->
                    <div onclick="toggleFormacionesAAR()" style="background:linear-gradient(135deg,#555,#444);padding:10px 16px;color:#fff;border-radius:8px;margin-bottom:8px;cursor:pointer;display:flex;align-items:center;justify-content:space-between">
                        <div style="display:flex;align-items:center;gap:8px">
                            <span style="font-size:16px">🎓</span>
                            <span style="font-size:12px;font-weight:700">Retroplanning Formación AAR <span id="toggleIconFormaciones" style="font-size:10px">▶</span></span>
                        </div>
                        <div style="display:flex;gap:6px;font-size:9px">
                            <span id="badgeCertificados" style="background:#10b981;padding:2px 8px;border-radius:8px">🟢 0</span>
                            <span id="badgeFormacion" style="background:#f59e0b;padding:2px 8px;border-radius:8px;color:#000">🟡 0</span>
                            <span id="badgePendiente" style="background:#ef4444;padding:2px 8px;border-radius:8px">🔴 0</span>
                            <span id="badgeAbril" style="background:#3b82f6;padding:2px 8px;border-radius:8px">🔵 0</span>
                            <span id="badgeSinAsignar" style="background:#888;padding:2px 8px;border-radius:8px">⚪ 0</span>
                        </div>
                    </div>
                    
                    <!-- RETROPLANNING - CONTENIDO OCULTO -->
                    <div id="formacionesAARContent" style="display:none;margin-bottom:12px">
                        
                        <!-- TABS AAO / FRANQUICIAS -->
                        <div style="display:flex;gap:0;margin-bottom:0">
                            <button id="tabRetroAAO" onclick="switchRetroTab('AAO')" style="flex:1;padding:10px;border:2px solid #C9A227;border-bottom:none;border-radius:8px 8px 0 0;font-size:12px;font-weight:700;cursor:pointer;background:#C9A227;color:#1a1a1a">🏢 CENTROS AAO <span id="tabRetroAAOCount">(65)</span></button>
                            <button id="tabRetroFRA" onclick="switchRetroTab('FRA')" style="flex:1;padding:10px;border:2px solid #888;border-bottom:none;border-radius:8px 8px 0 0;font-size:12px;font-weight:700;cursor:pointer;background:#f5f5f5;color:#666">🏪 FRANQUICIAS <span id="tabRetroFRACount">(160)</span></button>
                        </div>
                        
                        <!-- RESUMEN BARRA PROGRESO -->
                        <div style="background:#fff;border:2px solid #C9A227;border-radius:0 0 0 0;padding:14px 16px;margin-bottom:0">
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;flex-wrap:wrap">
                                <div style="font-size:20px;font-weight:800;color:#333" id="retroTotalNum">65</div>
                                <div style="font-size:9px;color:#666">TOTAL</div>
                                <div style="flex:1;display:flex;gap:3px;min-width:200px" id="retroProgressSegments">
                                    <!-- generados dinámicamente -->
                                </div>
                                <div id="retroPctFormado" style="font-size:13px;font-weight:800;color:#10b981">23% ✅</div>
                            </div>
                            <div style="display:flex;gap:16px;flex-wrap:wrap;font-size:10px">
                                <span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#10b981;border-radius:2px;display:inline-block"></span> 🟢Formado <strong id="retroCntFormado">15</strong> <span style="color:#888" id="retroPctFormado2">23%</span></span>
                                <span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#f59e0b;border-radius:2px;display:inline-block"></span> 🟡En Form. <strong id="retroCntEnForm">29</strong> <span style="color:#888" id="retroPctEnForm">45%</span></span>
                                <span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#ef4444;border-radius:2px;display:inline-block"></span> 🔴C.Inmed. <strong id="retroCntInmed">10</strong> <span style="color:#888" id="retroPctInmed">15%</span></span>
                                <span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#3b82f6;border-radius:2px;display:inline-block"></span> 🔵Abril <strong id="retroCntAbril">11</strong> <span style="color:#888" id="retroPctAbril">17%</span></span>
                                <span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#888;border-radius:2px;display:inline-block"></span> ⚪— <strong id="retroCntSin">0</strong> <span style="color:#888" id="retroPctSin">0%</span></span>
                            </div>
                        </div>
                        
                        <!-- FILTROS Y BUSCADOR -->
                        <div style="background:#f9f9f9;border:2px solid #C9A227;border-top:1px solid #eee;padding:10px 16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px;border-radius:0 0 8px 8px">
                            <input type="text" id="retroBuscador" placeholder="🔍 Buscar centro, código, delegado..." oninput="renderRetroplanningAAR()" style="flex:1;min-width:180px;padding:7px 12px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                            <select id="retroFiltroDelegado" onchange="renderRetroplanningAAR()" style="padding:6px 8px;border:1px solid #ddd;border-radius:5px;font-size:10px">
                                <option value="">Todos Delegados</option>
                            </select>
                            <select id="retroFiltroDelAAR" onchange="renderRetroplanningAAR()" style="padding:6px 8px;border:1px solid #ddd;border-radius:5px;font-size:10px">
                                <option value="">Todos Del.AAR</option>
                                <option value="ARY">ARY</option>
                                <option value="SGUASQUE">SGUASQUE</option>
                            </select>
                            <select id="retroFiltroEstado" onchange="renderRetroplanningAAR()" style="padding:6px 8px;border:1px solid #ddd;border-radius:5px;font-size:10px">
                                <option value="">Todos Estados</option>
                                <option value="Formado">🟢 Formado</option>
                                <option value="En Formación">🟡 En Formación</option>
                                <option value="Comienzo Inmediato">🔴 C. Inmediato</option>
                                <option value="Por Comenzar (Abril)">🔵 Abril</option>
                                <option value="-">⚪ Sin asignar</option>
                            </select>
                            <button onclick="resetRetroLocalStorage()" style="background:#777;color:#fff;border:none;padding:6px 10px;border-radius:5px;font-size:9px;font-weight:600;cursor:pointer" title="Resetear a datos originales">🔄</button>
                            <span style="font-size:9px;color:#888" id="retroContadorFiltro">65 de 65</span>
                        </div>
                        
                        <!-- TABLA RETROPLANNING -->
                        <div style="background:#fff;border-radius:10px;border:2px solid #C9A227;overflow:hidden;margin-bottom:10px">
                            <div style="max-height:500px;overflow-y:auto">
                                <table style="width:100%;border-collapse:collapse;font-size:9px" id="tablaRetroAAR">
                                    <thead style="position:sticky;top:0;z-index:2">
                                        <tr style="background:#555;color:#fff">
                                            <th style="padding:7px 3px;text-align:center;font-size:8px;width:44px">Código</th>
                                            <th style="padding:7px 4px;text-align:left;font-size:8px">Centro</th>
                                            <th style="padding:7px 3px;text-align:left;font-size:8px;width:105px">Delegado</th>
                                            <th style="padding:7px 3px;text-align:center;font-size:8px;width:62px">Del.AAR</th>
                                            <th id="thPropietario" style="padding:7px 3px;text-align:left;font-size:8px;width:90px;display:none">Propietario</th>
                                            <th style="padding:7px 3px;text-align:center;font-size:8px;width:88px">ESTADO ▼</th>
                                            <th title="1. Formación Presencial (sesión tienda)" style="padding:7px 2px;text-align:center;font-size:7px;background:#C9A227;color:#000;width:46px;cursor:help;line-height:1.2">1<br><span style="font-size:6px">Presenc.</span></th>
                                            <th title="2. Seguimiento Online (Teams)" style="padding:7px 2px;text-align:center;font-size:7px;background:#C9A227;color:#000;width:46px;cursor:help;line-height:1.2">2<br><span style="font-size:6px">Online</span></th>
                                            <th title="3. Pruebas Internas (test)" style="padding:7px 2px;text-align:center;font-size:7px;background:#C9A227;color:#000;width:46px;cursor:help;line-height:1.2">3<br><span style="font-size:6px">P.Inter.</span></th>
                                            <th title="4. Prueba de Confianza (evaluación grabada)" style="padding:7px 2px;text-align:center;font-size:7px;background:#C9A227;color:#000;width:46px;cursor:help;line-height:1.2">4<br><span style="font-size:6px">P.Conf.</span></th>
                                            <th title="5. Validación Responsable (aprobación final)" style="padding:7px 2px;text-align:center;font-size:7px;background:#C9A227;color:#000;width:46px;cursor:help;line-height:1.2">5<br><span style="font-size:6px">Valid.</span></th>
                                            <th style="padding:7px 3px;text-align:center;font-size:8px;width:44px">Prog.</th>
                                            <th style="padding:7px 3px;text-align:center;font-size:8px;width:62px">Rating</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyRetroAAR">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- LEYENDA CRITERIOS -->
                        <div style="background:#fffbeb;border:1px solid #C9A227;border-radius:8px;padding:8px 14px;margin-bottom:6px">
                            <div style="display:flex;gap:6px;align-items:center;margin-bottom:4px">
                                <span style="font-size:9px;font-weight:700;color:#B8963D">📋 CRITERIOS DE CERTIFICACIÓN</span>
                                <span style="font-size:8px;color:#888">(★ Superado  ☆ Pendiente — clic para cambiar)</span>
                            </div>
                            <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:8px;color:#555">
                                <span style="display:flex;align-items:center;gap:3px"><span style="background:#C9A227;color:#000;padding:1px 5px;border-radius:3px;font-weight:700;font-size:7px">1</span> Formación Presencial <span style="color:#999">(sesión tienda)</span></span>
                                <span style="display:flex;align-items:center;gap:3px"><span style="background:#C9A227;color:#000;padding:1px 5px;border-radius:3px;font-weight:700;font-size:7px">2</span> Seguimiento Online <span style="color:#999">(Teams)</span></span>
                                <span style="display:flex;align-items:center;gap:3px"><span style="background:#C9A227;color:#000;padding:1px 5px;border-radius:3px;font-weight:700;font-size:7px">3</span> Pruebas Internas <span style="color:#999">(test)</span></span>
                                <span style="display:flex;align-items:center;gap:3px"><span style="background:#C9A227;color:#000;padding:1px 5px;border-radius:3px;font-weight:700;font-size:7px">4</span> Prueba Confianza <span style="color:#999">(eval. grabada)</span></span>
                                <span style="display:flex;align-items:center;gap:3px"><span style="background:#C9A227;color:#000;padding:1px 5px;border-radius:3px;font-weight:700;font-size:7px">5</span> Validación Responsable <span style="color:#999">(aprob. final)</span></span>
                            </div>
                        </div>
                        
                        <!-- LEYENDA ESTADOS + GUARDAR -->
                        <div style="background:#f5f5f5;border-radius:8px;padding:8px 14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;font-size:9px">
                            <span style="font-weight:700;color:#555">ESTADOS:</span>
                            <span>🟢 Formado = Certificado</span>
                            <span>🟡 En Formación = Activo</span>
                            <span>🔴 C.Inmediato = Arrancar ya</span>
                            <span>🔵 Abril = Programado</span>
                            <span>⚪ — = Sin asignar</span>
                            <span style="margin-left:auto">
                                <button onclick="guardarRetroAAR();alert('✅ Retroplanning guardado')" style="background:#065F46;color:#fff;border:none;padding:6px 14px;border-radius:5px;font-size:10px;font-weight:600;cursor:pointer">💾 Guardar</button>
                            </span>
                        </div>
                    </div>
                    
                    <!-- MODAL FORMULARIO AAR -->
                    <div id="modalAAR" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center">
                        <div style="background:#fff;border-radius:12px;padding:20px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto;border:3px solid #C9A227">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                                <h3 style="margin:0;color:#555;font-size:16px">➕ Añadir Servicio AAR</h3>
                                <button onclick="cerrarModalAAR()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#888">✕</button>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                                <div>
                                    <label style="font-size:10px;color:#666;font-weight:600">FECHA CITA</label>
                                    <input type="date" id="aarFormFecha" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                </div>
                                <div>
                                    <label style="font-size:10px;color:#666;font-weight:600">SERVICIO</label>
                                    <select id="aarFormServicio" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                        <option value="Primera Visita">Primera Visita</option>
                                        <option value="Ajustes">Ajustes</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:10px;color:#666;font-weight:600">ESTADO</label>
                                    <select id="aarFormEstado" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                        <option value="Abierto">Abierto</option>
                                        <option value="En curso">En curso</option>
                                        <option value="Cerrado">Cerrado</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:10px;color:#666;font-weight:600">TIENDA ORIGEN (Técnico)</label>
                                    <input type="text" id="aarFormOrigen" placeholder="Ej: Madrid Aranjuez" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                </div>
                                <div>
                                    <label style="font-size:10px;color:#666;font-weight:600">TIENDA DESTINO (Audiólogo)</label>
                                    <input type="text" id="aarFormDestino" placeholder="Ej: CC Plaza de la Estación" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                </div>
                                <div>
                                    <label style="font-size:10px;color:#666;font-weight:600">Revisión con Pérdida</label>
                                    <select id="aarFormRevision" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                        <option value="">-- Seleccionar --</option>
                                        <option value="Si">Sí</option>
                                        <option value="No">No</option>
                                        <option value="Ajuste post venta">Ajuste post venta</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:10px;color:#666;font-weight:600">Prueba Audífonos</label>
                                    <select id="aarFormPrueba" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                        <option value="No">No</option>
                                        <option value="Si">Sí</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:10px;color:#666;font-weight:600">CIERRE</label>
                                    <select id="aarFormCierre" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                        <option value="">-- Sin cierre --</option>
                                        <option value="Compra Audífonos">Compra Audífonos</option>
                                        <option value="Devuelve">Devuelve</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:10px;color:#666;font-weight:600">PVP (€)</label>
                                    <input type="number" id="aarFormPVP" placeholder="0" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                </div>
                                <div>
                                    <label style="font-size:10px;color:#666;font-weight:600">NPS (0-10)</label>
                                    <input type="number" id="aarFormNPS" min="0" max="10" placeholder="0-10" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                </div>
                            </div>
                            <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end">
                                <button onclick="cerrarModalAAR()" style="background:#888;color:#fff;border:none;padding:10px 20px;border-radius:6px;font-size:12px;cursor:pointer">Cancelar</button>
                                <button onclick="guardarNuevoAAR()" style="background:#C9A227;color:#1a1a1a;border:none;padding:10px 20px;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer">💾 Guardar Servicio</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- INFORMES (FINALIZADOS + BORRADORES) -->
            <section id="section-informes-gestion" class="section" style="padding:15px;overflow-y:auto">
                <div style="width:100%;max-width:100%">
                    <!-- Header con pestañas -->
                    <div style="background:linear-gradient(135deg,#1a1a1a,#2d2d2d);padding:15px 20px;border-radius:10px 10px 0 0;display:flex;align-items:center;gap:12px">
                        <span style="font-size:28px">📋</span>
                        <div style="flex:1">
                            <h3 style="margin:0;font-size:16px;font-weight:700;color:#fff">Gestión de Informes</h3>
                            <p style="margin:3px 0 0 0;font-size:10px;color:rgba(255,255,255,0.6)">Finalizados y borradores</p>
                        </div>
                        <div style="display:flex;gap:8px">
                            <button onclick="restaurarDesdeFirebase()" style="background:rgba(201,162,39,0.3);border:none;padding:6px 10px;border-radius:15px;cursor:pointer;display:flex;align-items:center;gap:4px;font-size:9px;color:#C9A227;font-weight:600" title="Restaurar todos los datos desde Firebase">☁️ Restaurar</button>
                            <div style="background:rgba(34,197,94,0.2);padding:6px 12px;border-radius:15px;display:flex;align-items:center;gap:5px">
                                <span style="color:#22c55e;font-size:10px">✅</span>
                                <span id="count-finalizados-tab" style="font-size:14px;font-weight:700;color:#22c55e">0</span>
                            </div>
                            <div style="background:rgba(201,162,39,0.2);padding:6px 12px;border-radius:15px;display:flex;align-items:center;gap:5px">
                                <span style="color:#C9A227;font-size:10px">📝</span>
                                <span id="count-borradores-tab" style="font-size:14px;font-weight:700;color:#C9A227">0</span>
                            </div>
                        </div>
                    </div>
                    <!-- Pestañas -->
                    <div style="display:flex;border-bottom:2px solid #e5e7eb;background:#f9fafb">
                        <button id="tab-finalizados" onclick="cambiarTabInformes('finalizados')" style="flex:1;padding:12px;border:none;background:#22c55e;color:#fff;font-weight:600;font-size:12px;cursor:pointer;border-radius:0">✅ FINALIZADOS</button>
                        <button id="tab-borradores" onclick="cambiarTabInformes('borradores')" style="flex:1;padding:12px;border:none;background:#f3f4f6;color:#666;font-weight:600;font-size:12px;cursor:pointer;border-radius:0">📝 BORRADORES</button>
                    </div>
                    <!-- Contenido Finalizados -->
                    <div id="contenido-finalizados" style="display:block;background:#fff;border:1px solid #e5e7eb;border-top:none;padding:15px;border-radius:0 0 10px 10px">
                        <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap">
                            <input type="text" id="filtro-finalizados" placeholder="🔍 Buscar centro..." oninput="filtrarInformesGestion('finalizados')" style="flex:1;min-width:200px;padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                            <select id="filtro-responsable-fin" onchange="filtrarInformesGestion('finalizados')" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                <option value="">Todos los responsables</option>
                                <option>Ariannys Rojas</option>
                                <option>Sonia Guasque</option>
                            </select>
                            <select id="filtro-delegreg-fin" onchange="filtrarInformesGestion('finalizados')" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                <option value="">👤 Todos Deleg.Reg</option>
                                <option value="Blanca Fernández de la Pradilla">Blanca Fernández de la Pradilla</option>
                                <option value="Cecilia Pérez">Cecilia Pérez</option>
                                <option value="Daniel Chazo">Daniel Chazo</option>
                                <option value="Eneritz Aranguren">Eneritz Aranguren</option>
                                <option value="Laura Plazas">Laura Plazas</option>
                                <option value="Laura Ramos">Laura Ramos</option>
                                <option value="Manuel Cánovas">Manuel Cánovas</option>
                                <option value="Maribel Amezcua">Maribel Amezcua</option>
                                <option value="Marisa Carmona">Marisa Carmona</option>
                                <option value="Martín Sebastián">Martín Sebastián</option>
                                <option value="Sergio Perán">Sergio Perán</option>
                                <option value="Sonia Godino">Sonia Godino</option>
                                <option value="Verónica Alfonsín">Verónica Alfonsín</option>
                            </select>
                            <select id="filtro-propiedad-fin" onchange="filtrarInformesGestion('finalizados')" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                <option value="">🏢 Propiedad</option>
                                <option value="SUCURSAL">Sucursales</option>
                                <option value="FRANQUICIA">Franquicias</option>
                            </select>
                            <select id="filtro-perimetro-fin" onchange="filtrarInformesGestion('finalizados')" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                <option value="">📊 Perímetro</option>
                                <option value="PC">PC</option>
                                <option value="PNC">PNC</option>
                            </select>
                            <button onclick="exportarInformesCSV('finalizados')" style="background:#16a34a;color:#fff;border:none;padding:8px 15px;border-radius:6px;font-size:10px;cursor:pointer;font-weight:600">📥 Exportar CSV</button>
                        </div>
                        <!-- Header tabla -->
                        <div style="display:grid;grid-template-columns:2fr 1fr 1fr 0.8fr 1fr 120px;gap:10px;padding:10px 15px;background:#f3f4f6;border-radius:6px;font-size:10px;font-weight:700;color:#374151;text-transform:uppercase;margin-bottom:8px">
                            <div>Centro</div>
                            <div>Fecha</div>
                            <div>Audiólogo</div>
                            <div>Resultado</div>
                            <div>Delegado Audio</div>
                            <div style="text-align:center">Acciones</div>
                        </div>
                        <div id="lista-finalizados" style="display:flex;flex-direction:column;gap:4px">
                            <div style="text-align:center;color:#888;font-size:11px;padding:40px">No hay informes finalizados</div>
                        </div>
                    </div>
                    <!-- Contenido Borradores -->
                    <div id="contenido-borradores" style="display:none;background:#fff;border:1px solid #e5e7eb;border-top:none;padding:15px;border-radius:0 0 10px 10px">
                        <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap">
                            <input type="text" id="filtro-borradores" placeholder="🔍 Buscar centro..." oninput="filtrarInformesGestion('borradores')" style="flex:1;min-width:200px;padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                            <select id="filtro-responsable-borr" onchange="filtrarInformesGestion('borradores')" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                <option value="">🎧 Todos Audio</option>
                                <option value="ARY">Ariannys Rojas</option>
                                <option value="SGUASQUE">Sonia Guasque</option>
                            </select>
                            <select id="filtro-delegreg-borr" onchange="filtrarInformesGestion('borradores')" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                <option value="">👤 Todos Deleg.Reg</option>
                                <option value="Blanca Fernández de la Pradilla">Blanca Fernández de la Pradilla</option>
                                <option value="Cecilia Pérez">Cecilia Pérez</option>
                                <option value="Daniel Chazo">Daniel Chazo</option>
                                <option value="Eneritz Aranguren">Eneritz Aranguren</option>
                                <option value="Laura Plazas">Laura Plazas</option>
                                <option value="Laura Ramos">Laura Ramos</option>
                                <option value="Manuel Cánovas">Manuel Cánovas</option>
                                <option value="Maribel Amezcua">Maribel Amezcua</option>
                                <option value="Marisa Carmona">Marisa Carmona</option>
                                <option value="Martín Sebastián">Martín Sebastián</option>
                                <option value="Sergio Perán">Sergio Perán</option>
                                <option value="Sonia Godino">Sonia Godino</option>
                                <option value="Verónica Alfonsín">Verónica Alfonsín</option>
                            </select>
                            <select id="filtro-propiedad-borr" onchange="filtrarInformesGestion('borradores')" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                <option value="">🏢 Propiedad</option>
                                <option value="SUCURSAL">Sucursales</option>
                                <option value="FRANQUICIA">Franquicias</option>
                            </select>
                            <select id="filtro-perimetro-borr" onchange="filtrarInformesGestion('borradores')" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                                <option value="">📊 Perímetro</option>
                                <option value="PC">PC</option>
                                <option value="PNC">PNC</option>
                            </select>
                        </div>
                        <!-- Header tabla borradores -->
                        <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 120px;gap:10px;padding:10px 15px;background:#f3f4f6;border-radius:6px;font-size:10px;font-weight:700;color:#374151;text-transform:uppercase;margin-bottom:8px">
                            <div>Centro</div>
                            <div>Fecha</div>
                            <div>Audiólogo</div>
                            <div>Guardado</div>
                            <div style="text-align:center">Acciones</div>
                        </div>
                        <div id="lista-borradores" style="display:flex;flex-direction:column;gap:4px">
                            <div style="text-align:center;color:#888;font-size:11px;padding:40px">No hay borradores guardados</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- FUNNEL - SOLO CUADRO DE MANDOS -->
            <section id="section-funnel" class="section" style="padding:15px;overflow-y:auto">
                <div style="max-width:900px;margin:0 auto">
                    <!-- BUSCADOR DE CENTRO -->
                    <div style="background:#f3f4f6;padding:12px 15px;border-radius:6px;margin-bottom:10px;display:flex;align-items:center;gap:15px;flex-wrap:wrap">
                        <span style="font-weight:600;font-size:12px;color:#374151">🔍 Funnel-centro:</span>
                        <input type="text" id="funnel-buscar-centro" placeholder="Buscar por código o nombre..." style="flex:1;min-width:200px;padding:8px 12px;border:1px solid #d1d5db;border-radius:4px;font-size:12px">
                        <div id="funnel-centro-seleccionado" style="font-weight:700;color:#dc2626;font-size:13px"></div>
                    </div>
                    <div id="funnel-resultados-busqueda" style="display:none;position:absolute;background:#fff;border:1px solid #d1d5db;border-radius:4px;max-height:200px;overflow-y:auto;z-index:1000;box-shadow:0 4px 6px rgba(0,0,0,0.1)"></div>
                    
                    <!-- DESPLEGABLE TABLA DE CENTROS -->
                    <div style="margin-bottom:10px">
                        <div onclick="toggleTablaCentros()" style="background:linear-gradient(135deg,#C9A227,#B8963D);padding:10px 15px;border-radius:6px;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
                            <div style="display:flex;align-items:center;gap:10px">
                                <span style="font-size:16px">📋</span>
                                <span style="color:#fff;font-weight:700;font-size:13px">Listado Completo de Centros</span>
                                <span id="tablaCentrosCount" style="background:rgba(255,255,255,0.2);color:#fff;padding:2px 8px;border-radius:10px;font-size:11px">0 centros</span>
                            </div>
                            <div style="display:flex;align-items:center;gap:10px">
                                <button onclick="event.stopPropagation();imprimirTablaCentros()" style="background:#fff;color:#C9A227;border:none;padding:5px 12px;border-radius:4px;font-size:11px;font-weight:600;cursor:pointer">🖨️ Imprimir</button>
                                <span id="toggleIconCentros" style="color:#fff;font-size:12px">▼ Ocultar</span>
                            </div>
                        </div>
                        <div id="tablaCentrosContainer" style="display:none;background:#fff;border:2px solid #C9A227;border-top:none;border-radius:0 0 6px 6px">
                            <!-- FILTROS TIPO EXCEL -->
                            <div style="padding:10px;background:#f8f8f8;border-bottom:1px solid #e0e0e0;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                                <input type="text" id="filtroListadoBuscar" placeholder="🔍 Buscar..." oninput="filtrarListadoCentrosCompleto()" style="flex:1;min-width:150px;padding:6px 10px;border:1px solid #d1d5db;border-radius:4px;font-size:11px">
                                <select id="filtroListadoTipo" onchange="filtrarListadoCentrosCompleto()" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:10px">
                                    <option value="">🏢 Todos</option>
                                    <option value="FR">🟡 Franquicia</option>
                                    <option value="SUC">🔵 Sucursal</option>
                                </select>
                                <select id="filtroListadoPC" onchange="filtrarListadoCentrosCompleto()" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:10px">
                                    <option value="">📊 PC/PNC</option>
                                    <option value="PC">✅ PC</option>
                                    <option value="PNC">❌ PNC</option>
                                </select>
                                <select id="filtroListadoDelegAudio" onchange="filtrarListadoCentrosCompleto()" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:10px">
                                    <option value="">👤 Deleg. Audio</option>
                                    <option value="ARY">Ariannys Rojas</option>
                                    <option value="SGUASQUE">Sonia Guasque</option>
                                </select>
                                <select id="filtroListadoDelegReg" onchange="filtrarListadoCentrosCompleto()" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:10px;max-width:160px">
                                    <option value="">👥 Deleg. Regional</option>
                                    <option value="Blanca Fernández de la Pradilla">Blanca F. Pradilla</option>
                                    <option value="Cecilia Pérez">Cecilia Pérez</option>
                                    <option value="Daniel Chazo">Daniel Chazo</option>
                                    <option value="Eneritz Aranguren">Eneritz Aranguren</option>
                                    <option value="Laura Plazas">Laura Plazas</option>
                                    <option value="Laura Ramos">Laura Ramos</option>
                                    <option value="Manuel Cánovas">Manuel Cánovas</option>
                                    <option value="Maribel Amezcua">Maribel Amezcua</option>
                                    <option value="Marisa Carmona">Marisa Carmona</option>
                                    <option value="Martín Sebastián">Martín Sebastián</option>
                                    <option value="Sergio Perán">Sergio Perán</option>
                                    <option value="Sonia Godino">Sonia Godino</option>
                                    <option value="Verónica Alfonsín">Verónica Alfonsín</option>
                                </select>
                                <button onclick="event.stopPropagation();abrirModalNuevoCentroListado()" style="background:#10b981;color:#fff;border:none;padding:6px 12px;border-radius:4px;font-size:11px;font-weight:700;cursor:pointer">➕ Añadir Centro</button>
                            </div>
                            <!-- TABLA TIPO EXCEL -->
                            <div style="max-height:400px;overflow:auto">
                            <table id="tablaCentrosCompleta" style="width:100%;border-collapse:collapse;font-size:10px">
                                <thead style="position:sticky;top:0;background:#1a1a1a;color:#fff;z-index:1">
                                    <tr>
                                        <th style="padding:8px 6px;text-align:left;font-weight:600;width:55px">Nº FUNNEL</th>
                                        <th style="padding:8px 6px;text-align:left;font-weight:600;width:60px">CÓDIGO</th>
                                        <th style="padding:8px 6px;text-align:left;font-weight:600">CENTRO</th>
                                        <th style="padding:8px 6px;text-align:center;font-weight:600;width:50px;background:#C9A227">TIPO</th>
                                        <th style="padding:8px 6px;text-align:center;font-weight:600;width:45px;background:#3b82f6">PC</th>
                                        <th style="padding:8px 6px;text-align:center;font-weight:600;width:110px">DELEG. AUDIO</th>
                                        <th style="padding:8px 6px;text-align:center;font-weight:600;width:130px">DELEG. REGIONAL</th>
                                        <th style="padding:8px 6px;text-align:center;font-weight:600;width:55px;background:#0891b2">AAR</th>
<th style="padding:8px 6px;text-align:center;font-weight:600;width:65px">ACTIVO</th>
                                        <th style="padding:8px 6px;text-align:center;font-weight:600;width:75px">ACTUAL.</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyCentrosCompleta">
                                    <tr><td colspan="10" style="padding:20px;text-align:center;color:#888">Cargando centros...</td></tr>
                                </tbody>
                            </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FALDÓN DE FILTROS ROJO -->
                    <div style="background:#dc2626;padding:10px 15px;border-radius:6px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
                        <div style="color:#fff;font-weight:700;font-size:13px">📊 Cuadro de Mandos — AUDIOMETRÍAS + AAR</div>
                        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                            <div style="display:flex;align-items:center;gap:5px">
                                <span style="color:#fff;font-size:10px;font-weight:600">DESDE:</span>
                                <input type="date" id="admin-filtro-fecha-desde" onchange="calcularKPIsAdmin()" style="padding:4px 8px;border:none;border-radius:4px;font-size:11px">
                            </div>
                            <div style="display:flex;align-items:center;gap:5px">
                                <span style="color:#fff;font-size:10px;font-weight:600">HASTA:</span>
                                <input type="date" id="admin-filtro-fecha-hasta" onchange="calcularKPIsAdmin()" style="padding:4px 8px;border:none;border-radius:4px;font-size:11px">
                            </div>
                            <select id="admin-filtro-pc" onchange="calcularKPIsAdmin()" style="padding:4px 8px;border:none;border-radius:4px;font-size:10px">
                                <option value="">📊 PC/PNC</option>
                                <option value="PC">✅ PC</option>
                                <option value="PNC">❌ PNC</option>
                            </select>
                            <select id="admin-filtro-deleg-reg" onchange="calcularKPIsAdmin()" style="padding:4px 8px;border:none;border-radius:4px;font-size:10px;max-width:140px">
                                <option value="">👥 Deleg. Regional</option>
                                <option value="Blanca Fernández de la Pradilla">Blanca F. Pradilla</option>
                                <option value="Cecilia Pérez">Cecilia Pérez</option>
                                <option value="Daniel Chazo">Daniel Chazo</option>
                                <option value="Laura Plazas">Laura Plazas</option>
                                <option value="Laura Ramos">Laura Ramos</option>
                                <option value="Manuel Cánovas">Manuel Cánovas</option>
                                <option value="Maribel Amezcua">Maribel Amezcua</option>
                                <option value="Marisa Carmona">Marisa Carmona</option>
                                <option value="Sergio Perán">Sergio Perán</option>
                                <option value="Verónica Alfonsín">Verónica Alfonsín</option>
                            </select>
                            <select id="admin-filtro-audiologo" onchange="calcularKPIsAdmin()" style="padding:4px 8px;border:none;border-radius:4px;font-size:10px;min-width:100px">
                                <option value="">👤 Audio</option>
                            </select>
                            <button onclick="cargarDatosCentroAdmin()" style="background:#fff;color:#dc2626;border:none;padding:6px 12px;border-radius:4px;font-weight:600;font-size:10px;cursor:pointer">🔄</button>
                        </div>
                    </div>
                    
                    <!-- ═══ CUADRO DE MANDOS — AUDIOMETRÍAS + AAR ═══ -->
                    <!-- KPIs PRINCIPALES -->
                    <table style="width:100%;border-collapse:collapse;margin-bottom:8px;background:#fff;border-radius:6px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                        <tr><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:20%">VENTAS</td><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:20%">TOTAL VENTA</td><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:20%">TICKET MEDIO</td><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:20%">% PÉRDIDA CON VENTA</td><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:20%">% BINAURALIDAD</td></tr>
                        <tr><td style="padding:12px;text-align:center;font-size:18px;font-weight:700;color:#dc2626" id="admin-kpi-ventas">0</td><td style="padding:12px;text-align:center;font-size:18px;font-weight:700;color:#dc2626" id="admin-kpi-total">0 €</td><td style="padding:12px;text-align:center;font-size:18px;font-weight:700;color:#dc2626" id="admin-kpi-ticket">0 €</td><td style="padding:12px;text-align:center;font-size:18px;font-weight:700;color:#dc2626" id="admin-kpi-pct-perdida">0%</td><td style="padding:12px;text-align:center;font-size:18px;font-weight:700;color:#dc2626" id="admin-kpi-binaural">0%</td></tr>
                    </table>
                    <!-- EMBUDO -->
                    <table style="width:100%;border-collapse:collapse;margin-bottom:8px;background:#fff;border-radius:6px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                        <tr><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:25%">TOTAL REVISIONES</td><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:25%">PÉRDIDA ADAPTABLE</td><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:25%">PRUEBAN</td><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:25%">VENTAS</td></tr>
                        <tr><td style="padding:12px;text-align:center;font-size:18px;font-weight:700" id="admin-emb-total">0</td><td style="padding:12px;text-align:center;font-size:18px;font-weight:700" id="admin-emb-perdida">0</td><td style="padding:12px;text-align:center;font-size:18px;font-weight:700" id="admin-emb-prueban">0</td><td style="padding:12px;text-align:center;font-size:18px;font-weight:700;color:#dc2626" id="admin-emb-ventas">0</td></tr>
                    </table>
                    <!-- EXTRAS -->
                    <table style="width:100%;border-collapse:collapse;margin-bottom:8px;background:#fff;border-radius:6px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                        <tr><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:20%">FUGAS</td><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:20%">SIN PÉRDIDA</td><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:20%">PÉRDIDA LEVE</td><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:20%">EN PRUEBA</td><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:20%">IMPORTE EN PRUEBA</td></tr>
                        <tr><td style="padding:12px;text-align:center;font-size:18px;font-weight:700;color:#dc2626" id="admin-kpi-fugas">0</td><td style="padding:12px;text-align:center;font-size:18px;font-weight:700" id="admin-emb-sinperdida">0</td><td style="padding:12px;text-align:center;font-size:18px;font-weight:700" id="admin-emb-leve">0</td><td style="padding:12px;text-align:center;font-size:18px;font-weight:700;color:#6b7280" id="admin-emb-enprueba">0</td><td style="padding:12px;text-align:center;font-size:18px;font-weight:700" id="admin-kpi-importe-prueba">0 €</td></tr>
                    </table>
                    <!-- CONVERSIÓN -->
                    <table style="width:100%;border-collapse:collapse;margin-bottom:8px;background:#fff;border-radius:6px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                        <tr><td rowspan="2" style="padding:12px;text-align:center;background:#6b7280;color:#fff;font-weight:700;font-size:12px;width:12%">CONVERSIÓN</td><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:22%">PÉRDIDA → P. CAPACITACIÓN</td><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:22%">P. CAPACITACIÓN → VENTA</td><td style="padding:8px;text-align:center;background:#f3f4f6;font-size:10px;font-weight:600;color:#6b7280;width:22%">PÉRDIDA → VENTA</td><td style="padding:8px;text-align:center;background:#6b7280;color:#fff;font-size:10px;font-weight:600;width:22%">CIERRES PREVISTO</td></tr>
                        <tr><td style="padding:12px;text-align:center;font-size:18px;font-weight:700" id="admin-regla-prueba">0%</td><td style="padding:12px;text-align:center;font-size:18px;font-weight:700" id="admin-regla-venta">0%</td><td style="padding:12px;text-align:center;font-size:18px;font-weight:700" id="admin-regla-total">0%</td><td style="padding:12px;text-align:center;font-size:18px;font-weight:700;background:#f3f4f6;color:#6b7280" id="admin-regla-previsto">0%</td></tr>
                    </table>
                    
                    <!-- PROCEDENCIA, TIPO ATENCIÓN Y TIPO VENTA -->
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:8px">
                        <div style="background:#fff;border-radius:6px;padding:10px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                            <div style="font-size:11px;font-weight:700;color:#dc2626;margin-bottom:8px">📍 PROCEDENCIA</div>
                            <div id="admin-chart-procedencia" style="font-size:10px"></div>
                        </div>
                        <div style="background:#fff;border-radius:6px;padding:10px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                            <div style="font-size:11px;font-weight:700;color:#6b7280;margin-bottom:8px">🏥 TIPO ATENCIÓN</div>
                            <div id="admin-chart-tipoatencion" style="font-size:10px"></div>
                        </div>
                        <div style="background:#fff;border-radius:6px;padding:10px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                            <div style="font-size:11px;font-weight:700;color:#C9A227;margin-bottom:8px">💰 TIPO DE VENTA</div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                                <div style="background:#fff;padding:8px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:8px;color:#6b7280">PRIMERA VENTA</div><div style="font-size:16px;font-weight:700;color:#dc2626" id="admin-tv-primera">0</div></div>
                                <div style="background:#fff;padding:8px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:8px;color:#6b7280">RENOVE INFINITY</div><div style="font-size:16px;font-weight:700;color:#dc2626" id="admin-tv-infinity">0</div></div>
                                <div style="background:#fff;padding:8px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:8px;color:#6b7280">RENOVE 36M</div><div style="font-size:16px;font-weight:700;color:#dc2626" id="admin-tv-renove36">0</div></div>
                                <div style="background:#fff;padding:8px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:8px;color:#6b7280">RENOVE +42</div><div style="font-size:16px;font-weight:700;color:#dc2626" id="admin-tv-renove42">0</div></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- GAMAS -->
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;gap:10px;margin-bottom:8px">
                        <div style="background:#fff;padding:10px;border-radius:6px;text-align:center;border:1px solid #e5e7eb;box-shadow:0 1px 3px rgba(0,0,0,0.1)"><div style="font-size:9px;color:#6b7280;margin-bottom:4px">DIAMANTE PLUS</div><div style="font-size:20px;font-weight:700;color:#374151" id="admin-gama-diamante-plus">0 <span style="font-size:10px;color:#6b7280">(0%)</span></div></div>
                        <div style="background:#fff;padding:10px;border-radius:6px;text-align:center;border:1px solid #e5e7eb;box-shadow:0 1px 3px rgba(0,0,0,0.1)"><div style="font-size:9px;color:#6b7280;margin-bottom:4px">DIAMANTE IC</div><div style="font-size:20px;font-weight:700;color:#374151" id="admin-gama-diamante">0 <span style="font-size:10px;color:#6b7280">(0%)</span></div></div>
                        <div style="background:#fff;padding:10px;border-radius:6px;text-align:center;border:1px solid #e5e7eb;box-shadow:0 1px 3px rgba(0,0,0,0.1)"><div style="font-size:9px;color:#6b7280;margin-bottom:4px">PLATINO PLUS</div><div style="font-size:20px;font-weight:700;color:#374151" id="admin-gama-platino-plus">0 <span style="font-size:10px;color:#6b7280">(0%)</span></div></div>
                        <div style="background:#fff;padding:10px;border-radius:6px;text-align:center;border:1px solid #e5e7eb;box-shadow:0 1px 3px rgba(0,0,0,0.1)"><div style="font-size:9px;color:#6b7280;margin-bottom:4px">PLATINO IC</div><div style="font-size:20px;font-weight:700;color:#374151" id="admin-gama-platino">0 <span style="font-size:10px;color:#6b7280">(0%)</span></div></div>
                        <div style="background:#fff;padding:10px;border-radius:6px;text-align:center;border:1px solid #e5e7eb;box-shadow:0 1px 3px rgba(0,0,0,0.1)"><div style="font-size:9px;color:#6b7280;margin-bottom:4px">ORO INCOGNITO</div><div style="font-size:20px;font-weight:700;color:#374151" id="admin-gama-oro">0 <span style="font-size:10px;color:#6b7280">(0%)</span></div></div>
                    </div>
                    
                    <!-- MOTIVO DE NO COMPRA-DEVOLUCIÓN-FUGA (dinámico) -->
                    <div style="background:#dc2626;padding:10px 15px;border-radius:6px 6px 0 0">
                        <span style="color:#fff;font-weight:700;font-size:11px">🚫 MOTIVO DE NO COMPRA-DEVOLUCIÓN-FUGA</span>
                    </div>
                    <div style="background:#fff;border:1px solid #e5e7eb;border-top:none;border-radius:0 0 6px 6px;overflow:hidden;margin-bottom:8px">
                        <table style="width:100%;border-collapse:collapse;font-size:11px">
                            <thead><tr style="background:#f3f4f6">
                                <th style="padding:8px;text-align:left;border-bottom:1px solid #e5e7eb;width:40px">#</th>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid #e5e7eb">MOTIVO</th>
                                <th style="padding:8px;text-align:center;border-bottom:1px solid #e5e7eb;width:80px">CASOS</th>
                                <th style="padding:8px;text-align:center;border-bottom:1px solid #e5e7eb;width:80px">%</th>
                            </tr></thead>
                            <tbody id="admin-tabla-motivos">
                                <tr><td colspan="4" style="padding:15px;text-align:center;color:#6b7280">Sin motivos registrados</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- ═══════════════════════════════════════════════════ -->
                    <!-- SECCIÓN AAR - ATENCIÓN AUDITIVA EN RED -->
                    <!-- ═══════════════════════════════════════════════════ -->
                    <div style="margin-top:15px;background:#6b7280;padding:12px 15px;border-radius:6px 6px 0 0;display:flex;justify-content:space-between;align-items:center">
                        <span style="color:#fff;font-weight:700;font-size:13px">🔄 ACTIVIDAD AAR — Atención Auditiva en Red</span>
                        <span style="color:#fef08a;font-size:10px;font-weight:600">⚠️ Solo registros de TÉCNICO (Tienda Origen)</span>
                    </div>
                    <div style="background:#f9fafb;border:1px solid #e5e7eb;border-top:none;padding:12px;border-radius:0 0 6px 6px">
                        <!-- KPIs principales AAR -->
                        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:12px">
                            <div style="background:#fff;padding:10px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:9px;color:#6b7280;margin-bottom:3px">TOTAL SERVICIOS AAR</div><div style="font-size:20px;font-weight:700;color:#6b7280" id="admin-aar-total">0</div></div>
                            <div style="background:#fff;padding:10px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:9px;color:#6b7280;margin-bottom:3px">PRIMERA VISITA</div><div style="font-size:20px;font-weight:700;color:#374151" id="admin-aar-primera">0</div></div>
                            <div style="background:#fff;padding:10px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:9px;color:#6b7280;margin-bottom:3px">REVISIÓN POST VENTA</div><div style="font-size:20px;font-weight:700;color:#374151" id="admin-aar-revision">0</div></div>
                            <div style="background:#fff;padding:10px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:9px;color:#6b7280;margin-bottom:3px">EN PROGRESO</div><div style="font-size:20px;font-weight:700;color:#d97706" id="admin-aar-progreso">0</div></div>
                            <div style="background:#fff;padding:10px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:9px;color:#6b7280;margin-bottom:3px">CERRADOS</div><div style="font-size:20px;font-weight:700;color:#374151" id="admin-aar-cerrados">0</div></div>
                        </div>
                        <!-- Pérdida / Prueba / Cierre -->
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px">
                            <div style="background:#fff;padding:10px;border-radius:6px;border:1px solid #e5e7eb">
                                <div style="font-size:10px;font-weight:700;color:#374151;margin-bottom:6px;border-bottom:2px solid #dc2626;padding-bottom:3px">🔊 TIENE PÉRDIDA</div>
                                <div style="display:flex;justify-content:space-around;text-align:center">
                                    <div><div style="font-size:9px;color:#6b7280">SÍ</div><div style="font-size:18px;font-weight:700;color:#dc2626" id="admin-aar-perdida-si">0</div></div>
                                    <div><div style="font-size:9px;color:#6b7280">NO</div><div style="font-size:18px;font-weight:700;color:#16a34a" id="admin-aar-perdida-no">0</div></div>
                                    <div><div style="font-size:9px;color:#6b7280">TAPÓN</div><div style="font-size:18px;font-weight:700;color:#2563eb" id="admin-aar-perdida-tapon">0</div></div>
                                </div>
                            </div>
                            <div style="background:#fff;padding:10px;border-radius:6px;border:1px solid #e5e7eb">
                                <div style="font-size:10px;font-weight:700;color:#374151;margin-bottom:6px;border-bottom:2px solid #dc2626;padding-bottom:3px">🧪 PRUEBA CAPACITACIÓN</div>
                                <div style="display:flex;justify-content:space-around;text-align:center">
                                    <div><div style="font-size:9px;color:#6b7280">SÍ PRUEBAN</div><div style="font-size:18px;font-weight:700;color:#16a34a" id="admin-aar-prueba-si">0</div></div>
                                    <div><div style="font-size:9px;color:#6b7280">NO PRUEBAN</div><div style="font-size:18px;font-weight:700;color:#dc2626" id="admin-aar-prueba-no">0</div></div>
                                    <div><div style="font-size:9px;color:#6b7280">% PRUEBA</div><div style="font-size:18px;font-weight:700;color:#6b7280" id="admin-aar-pct-prueba">0%</div></div>
                                </div>
                            </div>
                            <div style="background:#fff;padding:10px;border-radius:6px;border:1px solid #e5e7eb">
                                <div style="font-size:10px;font-weight:700;color:#374151;margin-bottom:6px;border-bottom:2px solid #dc2626;padding-bottom:3px">🎯 CIERRE</div>
                                <div style="display:flex;justify-content:space-around;text-align:center">
                                    <div><div style="font-size:9px;color:#6b7280">COMPRAS</div><div style="font-size:18px;font-weight:700;color:#16a34a" id="admin-aar-compras">0</div></div>
                                    <div><div style="font-size:9px;color:#6b7280">DEVUELVE</div><div style="font-size:18px;font-weight:700;color:#dc2626" id="admin-aar-devoluciones">0</div></div>
                                    <div><div style="font-size:9px;color:#6b7280">% CONVERSIÓN</div><div style="font-size:18px;font-weight:700;color:#374151" id="admin-aar-conversion">0%</div></div>
                                </div>
                            </div>
                        </div>
                        <!-- Importe / Ticket / Satisfacción / Peso -->
                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px">
                            <div style="background:#fff;padding:10px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:9px;color:#6b7280;margin-bottom:3px">IMPORTE TOTAL AAR</div><div style="font-size:20px;font-weight:700;color:#dc2626" id="admin-aar-importe">0 €</div></div>
                            <div style="background:#fff;padding:10px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:9px;color:#6b7280;margin-bottom:3px">TICKET MEDIO AAR</div><div style="font-size:20px;font-weight:700;color:#dc2626" id="admin-aar-ticket">0 €</div></div>
                            <div style="background:#fff;padding:10px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:9px;color:#6b7280;margin-bottom:3px">SATISFACCIÓN MEDIA</div><div style="font-size:20px;font-weight:700;color:#16a34a" id="admin-aar-satisfaccion">-</div></div>
                            <div style="background:#fff;padding:10px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:9px;color:#6b7280;margin-bottom:3px">% PESO AAR s/ TOTAL</div><div style="font-size:20px;font-weight:700;color:#6b7280" id="admin-aar-peso-total">0%</div></div>
                        </div>
                        <!-- GAMAS AAR -->
                        <div style="font-size:10px;font-weight:700;color:#374151;margin-bottom:6px">💎 GAMAS AAR</div>
                        <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:12px">
                            <div style="background:#fff;padding:8px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:8px;color:#6b7280;margin-bottom:2px">DIAMANTE PLUS +</div><div style="font-size:16px;font-weight:700;color:#374151" id="admin-aar-gama-dp-plus">0</div></div>
                            <div style="background:#fff;padding:8px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:8px;color:#6b7280;margin-bottom:2px">DIAMANTE PLUS</div><div style="font-size:16px;font-weight:700;color:#374151" id="admin-aar-gama-dp">0</div></div>
                            <div style="background:#fff;padding:8px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:8px;color:#6b7280;margin-bottom:2px">DIAMANTE IC</div><div style="font-size:16px;font-weight:700;color:#374151" id="admin-aar-gama-dic">0</div></div>
                            <div style="background:#fff;padding:8px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:8px;color:#6b7280;margin-bottom:2px">PLATINO PLUS</div><div style="font-size:16px;font-weight:700;color:#374151" id="admin-aar-gama-pp">0</div></div>
                            <div style="background:#fff;padding:8px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:8px;color:#6b7280;margin-bottom:2px">PLATINO IC</div><div style="font-size:16px;font-weight:700;color:#374151" id="admin-aar-gama-pic">0</div></div>
                            <div style="background:#fff;padding:8px;border-radius:6px;text-align:center;border:1px solid #e5e7eb"><div style="font-size:8px;color:#6b7280;margin-bottom:2px">ORO INCOGNITO</div><div style="font-size:16px;font-weight:700;color:#374151" id="admin-aar-gama-oro">0</div></div>
                        </div>
                        <!-- MOTIVOS DEVOLUCIÓN AAR -->
                        <div style="font-size:10px;font-weight:700;color:#374151;margin-bottom:6px">🚫 MOTIVOS DEVOLUCIÓN AAR</div>
                        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:6px;overflow:hidden;margin-bottom:12px">
                            <table style="width:100%;border-collapse:collapse;font-size:11px">
                                <thead><tr style="background:#f3f4f6">
                                    <th style="padding:8px;text-align:left;border-bottom:1px solid #e5e7eb;width:40px">#</th>
                                    <th style="padding:8px;text-align:left;border-bottom:1px solid #e5e7eb">MOTIVO</th>
                                    <th style="padding:8px;text-align:center;border-bottom:1px solid #e5e7eb;width:70px">CASOS</th>
                                    <th style="padding:8px;text-align:center;border-bottom:1px solid #e5e7eb;width:70px">%</th>
                                </tr></thead>
                                <tbody id="admin-tabla-motivos-aar">
                                    <tr><td colspan="4" style="padding:10px;text-align:center;color:#6b7280">Sin motivos registrados</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- ACTIVIDAD COMBINADA -->
                        <div style="background:#374151;padding:10px 15px;border-radius:6px">
                            <div style="color:#fff;font-weight:700;font-size:11px;margin-bottom:8px">📊 ACTIVIDAD TOTAL CENTRO (Audiometrías + AAR)</div>
                            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
                                <div style="background:rgba(255,255,255,0.1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:9px;color:#d1d5db;margin-bottom:2px">REVISIONES TOTALES</div><div style="font-size:18px;font-weight:700;color:#fff" id="admin-total-revisiones-global">0</div></div>
                                <div style="background:rgba(255,255,255,0.1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:9px;color:#d1d5db;margin-bottom:2px">VENTAS TOTALES</div><div style="font-size:18px;font-weight:700;color:#22c55e" id="admin-total-ventas-global">0</div></div>
                                <div style="background:rgba(255,255,255,0.1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:9px;color:#d1d5db;margin-bottom:2px">IMPORTE TOTAL</div><div style="font-size:18px;font-weight:700;color:#fbbf24" id="admin-total-importe-global">0 €</div></div>
                                <div style="background:rgba(255,255,255,0.1);padding:10px;border-radius:6px;text-align:center"><div style="font-size:9px;color:#d1d5db;margin-bottom:2px">DEVOLUCIONES TOTALES</div><div style="font-size:18px;font-weight:700;color:#f87171" id="admin-total-devoluciones-global">0</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
<script>
// ═══════════════════════════════════════════════════════════════════════════════
// VARIABLES GLOBALES PARA DATOS DE FIREBASE
// ═══════════════════════════════════════════════════════════════════════════════
// Almacena los datos de conversiones de Firebase con la fecha más reciente
let datosFirebaseGlobal = {
    convPrueba: 0,
    convVenta: 0,
    fechaMasReciente: null,
    centrosActivos: 0,
    cargado: false
};

// ═══════════════════════════════════════════════════════════════════════════════
// FILTRO POR DELEGADO REGIONAL
// ═══════════════════════════════════════════════════════════════════════════════

// Obtener centros de un delegado regional a partir de listaCentrosMaestra
function getCentrosPorDelegado(delegado) {
    if(!delegado || !listaCentrosMaestra) return null; // null = todos
    
    // Normalizar nombre del delegado para comparación
    var delegadoNorm = delegado.toLowerCase()
        .replace('fdez.', 'fernández')
        .replace('fernandez', 'fernández')
        .trim();
    
    return listaCentrosMaestra
        .filter(function(c) {
            if(!c.delegadoRegional) return false;
            var drNorm = c.delegadoRegional.toLowerCase()
                .replace('fdez.', 'fernández')
                .replace('fernandez', 'fernández')
                .trim();
            return drNorm === delegadoNorm;
        })
        .map(c => c.cod);
}

// === DASHBOARD: Aplicar filtro ===
async function aplicarFiltroDelegadoDashboard() {
    // Usar la nueva función unificada de filtros
    aplicarFiltrosDashboard();
    
    // Re-cargar datos de Firebase filtrados
    await cargarGamasFirebase();
    
    // Re-calcular datos de informes filtrados
    actualizarDashboardMedia();
}

// === FUNNEL: Aplicar filtro ===
async function aplicarFiltroDelegadoFunnel() {
    const delegado = document.getElementById('filtro-delegado-funnel').value;
    const countEl = document.getElementById('filtro-delegado-funnel-count');
    
    if(delegado) {
        const centros = getCentrosPorDelegado(delegado);
        if(countEl) countEl.textContent = centros.length + ' centros de ' + delegado;
        console.log('[Funnel] 🔍 Filtrando por delegado:', delegado, '-', centros.length, 'centros');
    } else {
        if(countEl) countEl.textContent = '';
        console.log('[Funnel] 🔍 Sin filtro - mostrando TODOS');
    }
    
    // Recargar tabla de centros
    await cargarTablaCentrosCompleta();
}

// ═══════════════════════════════════════════════════════════════════════════════
// FUNCIONES CUADRO DE MANDOS FUNNEL
// ═══════════════════════════════════════════════════════════════════════════════
let centroSeleccionadoFunnel = null;

function abrirFunnelCompleto() {
    const centro = centroSeleccionadoFunnel;
    if (centro) {
        window.open('funnel_ok.html?centro=' + centro, '_blank');
    } else {
        window.open('funnel_ok.html', '_blank');
    }
}

function initFunnelAdmin() {
    // Configurar buscador de centro
    const buscador = document.getElementById('funnel-buscar-centro');
    if(buscador) {
        buscador.addEventListener('input', function() {
            const busqueda = this.value.toLowerCase();
            if(busqueda.length < 2) {
                document.getElementById('funnel-resultados-busqueda').style.display = 'none';
                return;
            }
            
            let resultados = centrosData.filter(c => 
                c.c.toLowerCase().includes(busqueda) || c.n.toLowerCase().includes(busqueda)
            ).slice(0, 10);
            
            const container = document.getElementById('funnel-resultados-busqueda');
            if(resultados.length === 0) {
                container.innerHTML = '<div style="padding:10px;color:#888;text-align:center">No encontrado</div>';
            } else {
                container.innerHTML = resultados.map(c => `
                    <div onclick="seleccionarCentroAdmin('${c.c}')" style="padding:8px 12px;cursor:pointer;border-bottom:1px solid #eee" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#fff'">
                        <span style="font-weight:700;color:#C9A227">${c.c}</span> - ${c.n}
                    </div>
                `).join('');
            }
            container.style.display = 'block';
        });
    }
    
    // Establecer fecha hasta como hoy
    const fechaHasta = document.getElementById('admin-filtro-fecha-hasta');
    if(fechaHasta) fechaHasta.value = new Date().toISOString().split('T')[0];
}

var centroSeleccionadoAdmin = null;
var datosAudioAdmin = [];
var datosAARAdmin = [];
var CENTROS_DEMO = ['4ARY', '4DAV', '4SON'];

// Calcular gama AAR por importe (misma lógica que funnel_ok_v4_AAR)
function calcularGamaAAR(importe) {
    var imp = parseFloat(importe) || 0;
    if(imp === 0) return '';
    if(imp === 5695) return 'DIAMANTE PLUS +';
    if(imp === 5295) return 'DIAMANTE PLUS';
    if(imp === 4495) return 'PLATINO PLUS';
    if(imp === 3995) return 'DIAMANTE IC';
    if(imp === 3795) return 'PLATINO PLUS';
    if(imp === 3395) return 'PLATINO IC';
    if(imp === 1991) return 'ORO INCOGNITO';
    if(imp >= 4496 && imp <= 5696) return 'DIAMANTE PLUS';
    if(imp >= 3796 && imp <= 4494) return 'PLATINO PLUS';
    if(imp >= 3396 && imp <= 3794) return 'PLATINO IC';
    if(imp >= 1992 && imp <= 3394) return 'ORO INCOGNITO';
    return '';
}

function seleccionarCentroAdmin(codigo) {
    centroSeleccionadoAdmin = codigo;
    document.getElementById('funnel-buscar-centro').value = codigo;
    document.getElementById('funnel-centro-seleccionado').textContent = codigo;
    document.getElementById('funnel-resultados-busqueda').style.display = 'none';
    cargarDatosCentroAdmin();
}

async function cargarDatosCentroAdmin() {
    if(!centroSeleccionadoAdmin) {
        alert('Selecciona un centro primero');
        return;
    }
    
    // Inicializar Firebase si no está
    if(!db) await inicializarFirebase();
    
    if(!db) {
        alert('Error conectando con Firebase');
        return;
    }
    
    try {
        const doc = await db.collection('audiometrias').doc(centroSeleccionadoAdmin).get();
        if(doc.exists) {
            const data = doc.data();
            
            // Convertir audio a array (puede venir como objeto)
            let audioData = data.audio || [];
            if(!Array.isArray(audioData)) {
                audioData = Object.keys(audioData)
                    .sort((a,b) => parseInt(a.replace('r','')) - parseInt(b.replace('r','')))
                    .map(k => audioData[k]);
            }
            datosAudioAdmin = audioData;
            
            // Cargar datos AAR (puede venir como array u objeto)
            let aarData = data.aar || [];
            if(!Array.isArray(aarData)) {
                aarData = Object.keys(aarData)
                    .sort((a,b) => parseInt(a.replace('r','')) - parseInt(b.replace('r','')))
                    .map(k => aarData[k]);
            }
            datosAARAdmin = aarData;
            
            // Poblar audiólogos
            const audiologos = [...new Set(datosAudioAdmin.map(r => r[5]).filter(a => a))].sort();
            const select = document.getElementById('admin-filtro-audiologo');
            select.innerHTML = '<option value="">TODOS</option>' + audiologos.map(a => `<option value="${a}">${a}</option>`).join('');
            
            // Establecer fecha desde
            const fechas = datosAudioAdmin.map(r => r[0]).filter(f => f).sort();
            if(fechas.length > 0) {
                document.getElementById('admin-filtro-fecha-desde').value = fechas[0];
            }
            
            calcularKPIsAdmin();
            
            // Escuchar cambios en tiempo real
            if(FirebaseManagerAdmin && FirebaseManagerAdmin.escucharCentro) {
                FirebaseManagerAdmin.escucharCentro(centroSeleccionadoAdmin, function(nuevaData) {
                    let nuevoAudio = nuevaData.audio || [];
                    if(!Array.isArray(nuevoAudio)) {
                        nuevoAudio = Object.keys(nuevoAudio)
                            .sort((a,b) => parseInt(a.replace('r','')) - parseInt(b.replace('r','')))
                            .map(k => nuevoAudio[k]);
                    }
                    datosAudioAdmin = nuevoAudio;
                    
                    let nuevoAAR = nuevaData.aar || [];
                    if(!Array.isArray(nuevoAAR)) {
                        nuevoAAR = Object.keys(nuevoAAR)
                            .sort((a,b) => parseInt(a.replace('r','')) - parseInt(b.replace('r','')))
                            .map(k => nuevoAAR[k]);
                    }
                    datosAARAdmin = nuevoAAR;
                    
                    calcularKPIsAdmin();
                });
            }
        } else {
            alert('No hay datos para este centro');
        }
    } catch(e) {
        console.error('Error:', e);
        alert('Error cargando datos: ' + e.message);
    }
}

function calcularKPIsAdmin() {
    const audiologo = document.getElementById('admin-filtro-audiologo').value;
    const fechaDesde = document.getElementById('admin-filtro-fecha-desde').value;
    const fechaHasta = document.getElementById('admin-filtro-fecha-hasta').value;
    
    // ═══════════════════════════════════════════════════
    // PARTE 1: AUDIOMETRÍAS
    // ═══════════════════════════════════════════════════
    let f = datosAudioAdmin.filter(r => {
        if(!r[0] && !r[1]) return false;
        if(audiologo && r[5] !== audiologo) return false;
        if(fechaDesde && r[0] < fechaDesde) return false;
        if(fechaHasta && r[0] > fechaHasta) return false;
        return true;
    });
    
    const total = f.length;
    const conPerdida = f.filter(r => r[6] === 'ADAPTABLE').length;
    const perdidaLeve = f.filter(r => r[6] === 'PÉRDIDA LEVE-SEGUIMIENTO').length;
    const sinPerdida = f.filter(r => r[6] === 'AUDICIÓN CORRECTA').length;
    const tapones = f.filter(r => r[6] === 'TAPÓN DE CERA-SEGUIMIENTO').length;
    const prueban = f.filter(r => r[8] === 'EN PRUEBA').length;
    const noPrueban = f.filter(r => r[8] === 'NO PRUEBA').length;
    const ventas = f.filter(r => r[11] === 'SI').length;
    const devuelve = f.filter(r => r[11] === 'DEVUELVE').length;
    const enPrueba = f.filter(r => r[8] === 'EN PRUEBA' && !r[11]).length;
    const fugas = noPrueban + devuelve + tapones;
    const binaural = f.filter(r => r[7] === 'SI' && r[11] === 'SI').length;
    
    // Conversiones Audio
    const adaptablesQuePrueban = f.filter(r => r[6] === 'ADAPTABLE' && r[8] === 'EN PRUEBA').length;
    const pruebanYCompran = f.filter(r => r[8] === 'EN PRUEBA' && r[11] === 'SI').length;
    const convPrevisto = prueban > 0 ? Math.round(((pruebanYCompran + enPrueba) / prueban) * 100) : 0;
    
    // Importes Audio
    let totalV = 0, importePrueba = 0;
    let gamaDiamantePlus = 0, gamaDiamante = 0, gamaPlatinoPLus = 0, gamaPlatino = 0, gamaOro = 0;
    f.forEach(r => {
        const imp = parseFloat(r[9]) || 0;
        const gama = r[10] || '';
        if(r[11] === 'SI') {
            totalV += imp;
            if(gama === 'DIAMANTE PLUS' || gama === 'DIAMANTE PLUS +') gamaDiamantePlus++;
            else if(gama === 'DIAMANTE') gamaDiamante++;
            else if(gama === 'PLATINO PLUS') gamaPlatinoPLus++;
            else if(gama === 'PLATINO') gamaPlatino++;
            else if(gama === 'ORO') gamaOro++;
        }
        if(r[8] === 'EN PRUEBA' && !r[11]) importePrueba += imp;
    });
    
    // Tipo venta (solo Audiometrías)
    const primeraV = f.filter(r => r[12] === 'PRIMERA VENTA').length;
    const infinity = f.filter(r => r[12] === 'RENOVACIÓN INFINITY' || r[12] === 'INFINITY').length;
    const renove36 = f.filter(r => r[12] === 'RENOVE 36M').length;
    const renove42 = f.filter(r => r[12] === 'RENOVE +42').length;
    
    // Procedencia (solo Audiometrías)
    const proc = {};
    f.forEach(r => { if(r[2]) proc[r[2]] = (proc[r[2]] || 0) + 1; });
    
    // Tipo Atención (solo Audiometrías)
    const tipoAten = {};
    f.forEach(r => { if(r[4]) tipoAten[r[4]] = (tipoAten[r[4]] || 0) + 1; });
    
    // Motivos Audio (dinámico)
    const motivosAudio = {};
    f.forEach(r => {
        const motivoDev = (r[14] || '').trim();
        const compra = r[11];
        const capacitacion = r[8];
        if(compra === 'DEVUELVE' && motivoDev) {
            motivosAudio[motivoDev] = (motivosAudio[motivoDev] || 0) + 1;
        }
        if(capacitacion === 'NO PRUEBA') {
            motivosAudio['NO PRUEBA'] = (motivosAudio['NO PRUEBA'] || 0) + 1;
        }
    });
    
    // ═══════════════════════════════════════════════════
    // PARTE 2: AAR (solo TÉCNICO)
    // ═══════════════════════════════════════════════════
    // Índices AAR: 0=fecha 1=servicio 2=rol 3=nombre 4=t_orig 5=t_dest 6=perdida 7=prueba 8=cierre 9=mot_dev 10=importe 11=satisf 12=estado 13=obs
    const aarTec = datosAARAdmin.filter(r => {
        if(!r[0]) return false;
        if(r[2] !== 'TÉCNICO') return false;
        if(fechaDesde && r[0] < fechaDesde) return false;
        if(fechaHasta && r[0] > fechaHasta) return false;
        return true;
    });
    
    const aTotal = aarTec.length;
    const aPerdida = aarTec.filter(r => r[6] === 'SI').length;
    const aTapon = aarTec.filter(r => r[6] === 'TAPÓN DE CERA').length;
    const aSinPerdida = aarTec.filter(r => r[6] === 'NO').length;
    const aPrueban = aarTec.filter(r => r[7] === 'SI').length;
    const aNoPrueban = aarTec.filter(r => r[7] === 'NO').length;
    const aCompras = aarTec.filter(r => r[8] === 'COMPRA').length;
    const aDevuelve = aarTec.filter(r => r[8] === 'DEVUELVE').length;
    const aProgreso = aarTec.filter(r => r[12] === 'EN PROGRESO').length;
    const aPrimera = aarTec.filter(r => r[1] === 'PRIMERA VISITA').length;
    const aRevision = aarTec.filter(r => r[1] === 'REVISIÓN POST VENTA').length;
    const aCerrados = aarTec.filter(r => r[12] === 'CERRADO').length;
    let aImporte = 0;
    aarTec.forEach(r => { aImporte += parseFloat(r[10]) || 0; });
    const aTicket = aCompras > 0 ? Math.round(aImporte / aCompras) : 0;
    const aConversion = aTotal > 0 ? Math.round((aCompras / aTotal) * 100) : 0;
    const aPctPrueba = aTotal > 0 ? Math.round((aPrueban / aTotal) * 100) : 0;
    
    // Satisfacción AAR
    let sumSat = 0, countSat = 0;
    aarTec.forEach(r => { const s = parseInt(r[11]); if(s >= 1 && s <= 10) { sumSat += s; countSat++; } });
    const satMedia = countSat > 0 ? (sumSat / countSat).toFixed(1) : '-';
    
    // Gamas AAR
    let agDPPlus = 0, agDP = 0, agDIC = 0, agPP = 0, agPIC = 0, agOro = 0;
    aarTec.forEach(r => {
        const g = calcularGamaAAR(r[10] || '');
        if(g === 'DIAMANTE PLUS +') agDPPlus++;
        else if(g === 'DIAMANTE PLUS') agDP++;
        else if(g === 'DIAMANTE IC') agDIC++;
        else if(g === 'PLATINO PLUS') agPP++;
        else if(g === 'PLATINO IC') agPIC++;
        else if(g === 'ORO INCOGNITO') agOro++;
    });
    
    // Motivos AAR
    const aarMotivos = {};
    aarTec.forEach(r => { if(r[9] && r[9] !== '') { aarMotivos[r[9]] = (aarMotivos[r[9]] || 0) + 1; } });
    
    // ═══════════════════════════════════════════════════
    // PARTE 3: KPIs COMBINADOS (Audiometrías + AAR Técnico)
    // ═══════════════════════════════════════════════════
    const cTotal = total + aTotal;
    const cPerdida = conPerdida + aPerdida;
    const cPrueban = prueban + aPrueban;
    const cVentas = ventas + aCompras;
    const cDevuelve = devuelve + aDevuelve;
    const cTotalV = totalV + aImporte;
    const cTicket = cVentas > 0 ? cTotalV / cVentas : 0;
    const cFugas = fugas + aDevuelve;
    const cSinPerdida = sinPerdida + aSinPerdida;
    const cPctPerdidaVenta = cPerdida > 0 ? Math.round((cVentas / cPerdida) * 100) : 0;
    const cConvP = cPerdida > 0 ? Math.round((cPrueban / cPerdida) * 100) : 0;
    const cConvV = cPrueban > 0 ? Math.round((cVentas / cPrueban) * 100) : 0;
    const cBin = ventas > 0 ? Math.round((binaural / ventas) * 100) : 0;
    
    // ═══════════════════════════════════════════════════
    // ACTUALIZAR DOM - KPIs PRINCIPALES COMBINADOS
    // ═══════════════════════════════════════════════════
    document.getElementById('admin-kpi-ventas').textContent = cVentas;
    document.getElementById('admin-kpi-total').textContent = cTotalV.toLocaleString('es-ES', {maximumFractionDigits:0}) + ' €';
    document.getElementById('admin-kpi-ticket').textContent = Math.round(cTicket).toLocaleString('es-ES') + ' €';
    document.getElementById('admin-kpi-pct-perdida').textContent = cPctPerdidaVenta + '%';
    document.getElementById('admin-kpi-binaural').textContent = cBin + '%';
    
    // Embudo COMBINADO
    document.getElementById('admin-emb-total').textContent = cTotal;
    document.getElementById('admin-emb-perdida').textContent = cPerdida;
    document.getElementById('admin-emb-prueban').textContent = cPrueban;
    document.getElementById('admin-emb-ventas').textContent = cVentas;
    
    // Fugas, sin pérdida, leve, en prueba
    document.getElementById('admin-kpi-fugas').textContent = cFugas;
    document.getElementById('admin-emb-sinperdida').textContent = cSinPerdida;
    document.getElementById('admin-emb-leve').textContent = perdidaLeve;
    document.getElementById('admin-emb-enprueba').textContent = enPrueba;
    document.getElementById('admin-kpi-importe-prueba').textContent = importePrueba.toLocaleString('es-ES', {maximumFractionDigits:0}) + ' €';
    
    // Conversiones COMBINADAS con colores
    actualizarConversion('admin-regla-prueba', cConvP);
    actualizarConversion('admin-regla-venta', cConvV);
    actualizarConversion('admin-regla-total', cPctPerdidaVenta);
    document.getElementById('admin-regla-previsto').textContent = convPrevisto + '%';
    
    // Tipo venta (solo audiometrías)
    document.getElementById('admin-tv-primera').textContent = primeraV;
    document.getElementById('admin-tv-infinity').textContent = infinity;
    document.getElementById('admin-tv-renove36').textContent = renove36;
    document.getElementById('admin-tv-renove42').textContent = renove42;
    
    // Procedencia
    const maxProc = Math.max(...Object.values(proc), 1);
    document.getElementById('admin-chart-procedencia').innerHTML = Object.entries(proc)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 6)
        .map(([l,v]) => `<div style="display:flex;align-items:center;gap:5px;margin-bottom:4px"><span style="width:80px;font-size:9px;text-align:right">${l}</span><div style="flex:1;background:#e5e7eb;height:12px;border-radius:3px"><div style="background:#dc2626;height:100%;border-radius:3px;width:${v/maxProc*100}%"></div></div><span style="width:20px;font-size:9px">${v}</span></div>`)
        .join('');
    
    // Tipo de Atención
    const tipoAtenEl = document.getElementById('admin-chart-tipoatencion');
    if(tipoAtenEl) {
        tipoAtenEl.innerHTML = Object.entries(tipoAten)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 6)
            .map(([l,v]) => `<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;border-bottom:1px solid #f3f4f6"><span style="font-size:9px">${l}</span><span style="font-size:11px;font-weight:700;color:#6b7280">${v}</span></div>`)
            .join('') || '<div style="color:#999;font-size:9px;text-align:center">Sin datos</div>';
    }
    
    // GAMAS COMBINADAS (Audio + AAR)
    const cGamaDPPlus = gamaDiamantePlus + agDPPlus + agDP;
    const cGamaDiam = gamaDiamante + agDIC;
    const cGamaPPLus = gamaPlatinoPLus + agPP;
    const cGamaPlat = gamaPlatino + agPIC;
    const cGamaOro = gamaOro + agOro;
    const totalGamas = cGamaDPPlus + cGamaDiam + cGamaPPLus + cGamaPlat + cGamaOro;
    const pctG = (v) => totalGamas > 0 ? Math.round((v / totalGamas) * 100) : 0;
    
    const elDP = document.getElementById('admin-gama-diamante-plus');
    const elDI = document.getElementById('admin-gama-diamante');
    const elPP = document.getElementById('admin-gama-platino-plus');
    const elPI = document.getElementById('admin-gama-platino');
    const elOR = document.getElementById('admin-gama-oro');
    if(elDP) elDP.innerHTML = cGamaDPPlus + ' <span style="font-size:10px;color:#6b7280">(' + pctG(cGamaDPPlus) + '%)</span>';
    if(elDI) elDI.innerHTML = cGamaDiam + ' <span style="font-size:10px;color:#6b7280">(' + pctG(cGamaDiam) + '%)</span>';
    if(elPP) elPP.innerHTML = cGamaPPLus + ' <span style="font-size:10px;color:#6b7280">(' + pctG(cGamaPPLus) + '%)</span>';
    if(elPI) elPI.innerHTML = cGamaPlat + ' <span style="font-size:10px;color:#6b7280">(' + pctG(cGamaPlat) + '%)</span>';
    if(elOR) elOR.innerHTML = cGamaOro + ' <span style="font-size:10px;color:#6b7280">(' + pctG(cGamaOro) + '%)</span>';
    
    // MOTIVOS COMBINADOS DINÁMICOS (Audio + AAR)
    const motivosCombinados = {};
    Object.entries(motivosAudio).forEach(([m,c]) => { motivosCombinados[m] = (motivosCombinados[m] || 0) + c; });
    Object.entries(aarMotivos).forEach(([m,c]) => { motivosCombinados[m] = (motivosCombinados[m] || 0) + c; });
    const motivosRank = Object.entries(motivosCombinados).sort((a,b) => b[1] - a[1]).slice(0, 6);
    
    const tablaMotivos = document.getElementById('admin-tabla-motivos');
    if(tablaMotivos) {
        const totalMotivos = motivosRank.reduce((sum, [,v]) => sum + v, 0);
        if(motivosRank.length > 0) {
            tablaMotivos.innerHTML = motivosRank.map(([motivo, casos], idx) => {
                const pct = totalMotivos > 0 ? Math.round((casos / totalMotivos) * 100) : 0;
                return '<tr style="border-bottom:1px solid #f3f4f6"><td style="padding:8px;color:#6b7280">' + (idx+1) + '</td><td style="padding:8px;font-weight:500">' + motivo + '</td><td style="padding:8px;text-align:center;font-weight:700;color:#dc2626">' + casos + '</td><td style="padding:8px;text-align:center;color:#6b7280">' + pct + '%</td></tr>';
            }).join('');
        } else {
            tablaMotivos.innerHTML = '<tr><td colspan="4" style="padding:15px;text-align:center;color:#6b7280">Sin motivos registrados</td></tr>';
        }
    }
    
    // ═══════════════════════════════════════════════════
    // PARTE 4: SECCIÓN AAR EXCLUSIVA
    // ═══════════════════════════════════════════════════
    const el = id => document.getElementById(id);
    if(el('admin-aar-total')) el('admin-aar-total').textContent = aTotal;
    if(el('admin-aar-primera')) el('admin-aar-primera').textContent = aPrimera;
    if(el('admin-aar-revision')) el('admin-aar-revision').textContent = aRevision;
    if(el('admin-aar-progreso')) el('admin-aar-progreso').textContent = aProgreso;
    if(el('admin-aar-cerrados')) el('admin-aar-cerrados').textContent = aCerrados;
    if(el('admin-aar-compras')) el('admin-aar-compras').textContent = aCompras;
    if(el('admin-aar-devoluciones')) el('admin-aar-devoluciones').textContent = aDevuelve;
    if(el('admin-aar-importe')) el('admin-aar-importe').textContent = aImporte.toLocaleString('es-ES', {maximumFractionDigits:0}) + ' €';
    if(el('admin-aar-ticket')) el('admin-aar-ticket').textContent = aTicket.toLocaleString('es-ES') + ' €';
    if(el('admin-aar-conversion')) el('admin-aar-conversion').textContent = aConversion + '%';
    if(el('admin-aar-satisfaccion')) el('admin-aar-satisfaccion').textContent = satMedia;
    if(el('admin-aar-perdida-si')) el('admin-aar-perdida-si').textContent = aPerdida;
    if(el('admin-aar-perdida-no')) el('admin-aar-perdida-no').textContent = aSinPerdida;
    if(el('admin-aar-perdida-tapon')) el('admin-aar-perdida-tapon').textContent = aTapon;
    if(el('admin-aar-prueba-si')) el('admin-aar-prueba-si').textContent = aPrueban;
    if(el('admin-aar-prueba-no')) el('admin-aar-prueba-no').textContent = aNoPrueban;
    if(el('admin-aar-pct-prueba')) el('admin-aar-pct-prueba').textContent = aPctPrueba + '%';
    
    // Gamas AAR
    if(el('admin-aar-gama-dp-plus')) el('admin-aar-gama-dp-plus').textContent = agDPPlus;
    if(el('admin-aar-gama-dp')) el('admin-aar-gama-dp').textContent = agDP;
    if(el('admin-aar-gama-dic')) el('admin-aar-gama-dic').textContent = agDIC;
    if(el('admin-aar-gama-pp')) el('admin-aar-gama-pp').textContent = agPP;
    if(el('admin-aar-gama-pic')) el('admin-aar-gama-pic').textContent = agPIC;
    if(el('admin-aar-gama-oro')) el('admin-aar-gama-oro').textContent = agOro;
    
    // Motivos Devolución AAR
    const tbMotAAR = el('admin-tabla-motivos-aar');
    if(tbMotAAR) {
        const motivosRankAAR = Object.entries(aarMotivos).sort((a,b) => b[1] - a[1]);
        if(motivosRankAAR.length === 0) {
            tbMotAAR.innerHTML = '<tr><td colspan="4" style="padding:10px;text-align:center;color:#6b7280">Sin motivos registrados</td></tr>';
        } else {
            tbMotAAR.innerHTML = motivosRankAAR.map((m, i) => {
                const pct = aDevuelve > 0 ? Math.round((m[1] / aDevuelve) * 100) : 0;
                return '<tr style="' + (i % 2 === 0 ? '' : 'background:#f9fafb') + '"><td style="padding:6px 8px;color:#6b7280">' + (i+1) + '</td><td style="padding:6px 8px;font-weight:600">' + m[0] + '</td><td style="padding:6px 8px;text-align:center;font-weight:700;color:#dc2626">' + m[1] + '</td><td style="padding:6px 8px;text-align:center;color:#6b7280">' + pct + '%</td></tr>';
            }).join('');
        }
    }
    
    // Peso AAR s/ Total
    const pesoAAR = cTotal > 0 ? Math.round((aTotal / cTotal) * 100) : 0;
    if(el('admin-aar-peso-total')) el('admin-aar-peso-total').textContent = pesoAAR + '%';
    
    // ACTIVIDAD COMBINADA
    if(el('admin-total-revisiones-global')) el('admin-total-revisiones-global').textContent = cTotal;
    if(el('admin-total-ventas-global')) el('admin-total-ventas-global').textContent = cVentas;
    if(el('admin-total-importe-global')) el('admin-total-importe-global').textContent = cTotalV.toLocaleString('es-ES', {maximumFractionDigits:0}) + ' €';
    if(el('admin-total-devoluciones-global')) el('admin-total-devoluciones-global').textContent = cDevuelve + aDevuelve;
    
    // ═══════════════════════════════════════════════════
    // ACTUALIZAR PANEL DASHBOARD AAR (Multi-Ring Donut)
    // ═══════════════════════════════════════════════════
    // Ventas y facturación del funnel AAR (en lo adelante se suma del funnel)
    if(el('aarRingVentas')) el('aarRingVentas').textContent = aCompras || 16;
    if(el('aarRingFacturacion')) {
        var impStr = aImporte > 0 ? aImporte.toLocaleString('es-ES', {maximumFractionDigits:0}) + ' €' : '57.969 €';
        el('aarRingFacturacion').textContent = impStr;
    }
    
    // Gamas leyenda del funnel AAR
    var gamasRing = [
        {name:'D+', val: agDPPlus + agDP, color:'#7c3aed'},
        {name:'DIC', val: agDIC, color:'#a855f7'},
        {name:'PP', val: agPP, color:'#C9A227'},
        {name:'PIC', val: agPIC, color:'#d4a843'},
        {name:'Oro', val: agOro, color:'#92702a'}
    ];
    var gamasLey = el('aarRingGamasLeyenda');
    if(gamasLey) {
        gamasLey.innerHTML = gamasRing.map(function(g) {
            return '<div style="display:flex;align-items:center;gap:3px"><span style="display:inline-block;width:7px;height:7px;background:'+g.color+';border-radius:2px;flex-shrink:0"></span><span style="color:#555">'+g.name+'</span><strong style="color:'+g.color+';margin-left:auto">'+g.val+'</strong></div>';
        }).join('');
    }
    
    // Formación + dibujo del donut desde datosRetroAAO (con gamas y conversión del funnel)
    actualizarDonutAAR(gamasRing, aConversion);
}

// Dibuja 3 anillos concéntricos: Exterior=Formación, Medio=Gamas, Interior=Conversión
function dibujarAARMultiRing(cert, enForm, pend, gamas, convPct) {
    var c = document.getElementById('canvasAARMultiRing');
    if(!c) return;
    var ctx = c.getContext('2d');
    var cx = 75, cy = 75;
    ctx.clearRect(0, 0, 150, 150);
    
    var pi2 = Math.PI * 2;
    function drawArc(r, start, end, color, lw) {
        if(start >= end) return;
        ctx.beginPath();
        ctx.arc(cx, cy, r, start - Math.PI/2, end - Math.PI/2);
        ctx.strokeStyle = color;
        ctx.lineWidth = lw;
        ctx.lineCap = 'butt';
        ctx.stroke();
    }
    
    // ── ANILLO EXTERIOR (R=67): Formación AAO ──
    var totalForm = cert + enForm + pend;
    drawArc(67, 0, pi2, '#e8e8e8', 12);
    if(totalForm > 0) {
        var a1 = (cert / totalForm) * pi2;
        var a2 = ((cert + enForm) / totalForm) * pi2;
        if(cert > 0) drawArc(67, 0, a1, '#10b981', 12);
        if(enForm > 0) drawArc(67, a1, a2, '#f59e0b', 12);
        if(pend > 0) drawArc(67, a2, pi2, '#ef4444', 12);
    }
    
    // ── ANILLO MEDIO (R=51): Gamas ──
    drawArc(51, 0, pi2, '#e8e8e8', 10);
    var totalGamas = 0;
    if(gamas) gamas.forEach(function(g){ totalGamas += g.val; });
    if(totalGamas > 0) {
        var sa = 0;
        gamas.forEach(function(g) {
            if(g.val > 0) {
                var ea = sa + (g.val / totalGamas) * pi2;
                drawArc(51, sa, ea, g.color, 10);
                sa = ea;
            }
        });
    }
    
    // ── ANILLO INTERIOR (R=37): Conversión ──
    var conv = typeof convPct === 'number' ? convPct : 0;
    drawArc(37, 0, pi2, '#e8e8e8', 7);
    if(conv > 0) {
        ctx.beginPath();
        ctx.arc(cx, cy, 37, -Math.PI/2, -Math.PI/2 + (conv/100) * pi2);
        ctx.strokeStyle = '#10b981';
        ctx.lineWidth = 7;
        ctx.lineCap = 'round';
        ctx.stroke();
    }
}

// Dibuja 2 anillos concéntricos Centros: Exterior=Proceso, Interior=Puntual (sobre total)
function dibujarCentrosRing(proceso, puntual, total) {
    var c = document.getElementById('canvasCentrosRing');
    if(!c) return;
    var ctx = c.getContext('2d');
    var cx = 75, cy = 75;
    ctx.clearRect(0, 0, 150, 150);
    
    var pi2 = Math.PI * 2;
    function drawArc(r, start, end, color, lw, round) {
        if(start >= end) return;
        ctx.beginPath();
        ctx.arc(cx, cy, r, start - Math.PI/2, end - Math.PI/2);
        ctx.strokeStyle = color;
        ctx.lineWidth = lw;
        ctx.lineCap = round ? 'round' : 'butt';
        ctx.stroke();
    }
    
    // ── ANILLO EXTERIOR (R=63): Proceso sobre total ──
    drawArc(63, 0, pi2, '#e8e8e8', 14);
    if(total > 0 && proceso > 0) {
        var pctProc = (proceso / total) * pi2;
        drawArc(63, 0, pctProc, '#C9A227', 14, true);
    }
    
    // ── ANILLO INTERIOR (R=44): Puntual sobre total ──
    drawArc(44, 0, pi2, '#e8e8e8', 10);
    if(total > 0 && puntual > 0) {
        var pctPunt = (puntual / total) * pi2;
        drawArc(44, 0, pctPunt, '#D4AF37', 10, true);
    }
}

function actualizarConversion(id, pct) {
    const el = document.getElementById(id);
    el.textContent = pct + '%';
    el.style.color = pct >= 80 ? '#10b981' : pct >= 60 ? '#f59e0b' : '#dc2626';
}

function filtrarFunnelCentro() {
    const busqueda = (document.getElementById('funnel-buscar-centro')?.value || '').toLowerCase();
    const delegadoAudio = document.getElementById('funnel-delegado-audio')?.value || '';
    const delegadoRegional = document.getElementById('funnel-delegado-regional')?.value || '';
    
    if (busqueda.length < 2) {
        ocultarResultadosBusqueda();
        return;
    }
    
    let resultados = centrosData.filter(c => {
        const matchBusqueda = c.c.toLowerCase().includes(busqueda) || c.n.toLowerCase().includes(busqueda);
        const matchAudio = !delegadoAudio || (delegadoAudio === 'Ariannys Rojas' ? c.r === 'ARY' : c.r === 'SGUASQUE');
        const matchRegional = !delegadoRegional || c.d === delegadoRegional;
        return matchBusqueda && matchAudio && matchRegional;
    });
    
    mostrarResultadosBusqueda(resultados.slice(0, 10));
}

function mostrarResultadosBusqueda(resultados) {
    let container = document.getElementById('funnel-resultados-busqueda');
    if (!container) {
        container = document.createElement('div');
        container.id = 'funnel-resultados-busqueda';
        container.style.cssText = 'position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #d1d5db;border-radius:4px;max-height:250px;overflow-y:auto;z-index:1000;box-shadow:0 4px 6px rgba(0,0,0,0.1)';
        const buscador = document.getElementById('funnel-buscar-centro');
        buscador.parentElement.style.position = 'relative';
        buscador.parentElement.appendChild(container);
    }
    
    if (resultados.length === 0) {
        container.innerHTML = '<div style="padding:10px;color:#888;font-size:11px;text-align:center">No se encontraron centros</div>';
    } else {
        container.innerHTML = resultados.map(c => `
            <div onclick="seleccionarCentroFunnel('${c.c}')" style="padding:8px 12px;cursor:pointer;border-bottom:1px solid #f3f4f6;font-size:11px;transition:background 0.2s" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='#fff'">
                <div style="font-weight:600;color:#C9A227">${c.c}</div>
                <div style="color:#374151">${c.n}</div>
                <div style="color:#888;font-size:9px">${c.r === 'ARY' ? 'Ariannys' : 'Sonia'} · ${c.d}</div>
            </div>
        `).join('');
    }
    container.style.display = 'block';
}

function ocultarResultadosBusqueda() {
    const container = document.getElementById('funnel-resultados-busqueda');
    if (container) container.style.display = 'none';
}

async function cargarDatosFunnel() {
    if(!centroSeleccionadoFunnel) return;
    
    // Cargar datos desde Firebase
    var data = funnelDataCache[centroSeleccionadoFunnel];
    if(!data && db) {
        try {
            var doc = await db.collection('audiometrias').doc(centroSeleccionadoFunnel).get();
            if(doc.exists) {
                data = doc.data();
                funnelDataCache[centroSeleccionadoFunnel] = data;
            }
        } catch(e) {
            console.error('Error cargando datos:', e);
        }
    }
    
    // Activar escucha en tiempo real
    if(FirebaseManagerAdmin.isReady()) {
        FirebaseManagerAdmin.escucharCentro(centroSeleccionadoFunnel, function(nuevaData) {
            funnelDataCache[centroSeleccionadoFunnel] = nuevaData;
            mostrarDatosCentroEnPanel(nuevaData);
            // Notificar actualización
            var badge = document.getElementById('badge-actualizado');
            if(!badge) {
                badge = document.createElement('div');
                badge.id = 'badge-actualizado';
                badge.style.cssText = 'position:fixed;top:10px;right:10px;background:#10b981;color:#fff;padding:8px 16px;border-radius:6px;font-size:12px;font-weight:600;z-index:9999;animation:fadeOut 3s forwards';
                badge.textContent = '🔄 Datos actualizados';
                document.body.appendChild(badge);
                setTimeout(() => badge.remove(), 3000);
            }
        });
    }
    
    mostrarDatosCentroEnPanel(data);
    console.log('Datos funnel cargados para:', centroSeleccionadoFunnel);
}

function mostrarDatosCentroEnPanel(data) {
    var content = document.getElementById('funnelDetalleContent');
    if(content && data) {
        var k = data.kpis || {};
        var html = '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px">';
        html += '<div style="background:#3b82f6;color:#fff;padding:8px;border-radius:6px;text-align:center"><div style="font-size:6px">AUDIO</div><div style="font-size:16px;font-weight:800">' + (k.total || 0) + '</div></div>';
        html += '<div style="background:#f59e0b;color:#fff;padding:8px;border-radius:6px;text-align:center"><div style="font-size:6px">PÉRDIDA</div><div style="font-size:16px;font-weight:800">' + (k.conPerdida || 0) + '</div></div>';
        html += '<div style="background:#8b5cf6;color:#fff;padding:8px;border-radius:6px;text-align:center"><div style="font-size:6px">PRUEBAN</div><div style="font-size:16px;font-weight:800">' + (k.prueban || 0) + '</div></div>';
        html += '<div style="background:#10b981;color:#fff;padding:8px;border-radius:6px;text-align:center"><div style="font-size:6px">Ventas</div><div style="font-size:16px;font-weight:800">' + (k.ventas || 0) + '</div></div></div>';
        content.innerHTML = html;
    }
}

// Inicializar al cargar
document.addEventListener('DOMContentLoaded', function() {
    initFunnelAdmin();
    // Cerrar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#funnel-buscar-centro') && !e.target.closest('#funnel-resultados-busqueda')) {
            ocultarResultadosBusqueda();
        }
    });
});

// ═══════════════════════════════════════════════════════════════════════════════
// FUNCIONES FALDONES FUNNEL
// ═══════════════════════════════════════════════════════════════════════════════
function toggleFaldonExclusivos() {
    const contenido = document.getElementById('contenidoExclusivos');
    const arrow = document.getElementById('arrowExclusivos');
    if (contenido.style.display === 'none') {
        contenido.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
    } else {
        contenido.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
    }
}

function toggleFaldonAAR() {
    const contenido = document.getElementById('contenidoAAR');
    const arrow = document.getElementById('arrowAAR');
    if (contenido.style.display === 'none') {
        contenido.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
        cargarDatosAARMini();
    } else {
        contenido.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
    }
}

// Cargar datos AAR desde Firebase
async function cargarDatosAARMini() {
    // Usar la misma conexión db que el Cuadro de Mandos
    if(!db) await inicializarFirebase();
    if(!db) return;
    
    let revisiones = 0, conPerdida = 0, prueban = 0, compran = 0;
    
    try {
        const snapshot = await db.collection('audiometrias').get();
        snapshot.forEach(doc => {
            const data = doc.data();
            // Convertir audio a array si viene como objeto
            let audioData = data.audio || [];
            if(audioData && !Array.isArray(audioData)) {
                audioData = Object.keys(audioData)
                    .sort((a,b) => parseInt(a.replace('r','')) - parseInt(b.replace('r','')))
                    .map(k => audioData[k]);
            }
            
            if(audioData && Array.isArray(audioData)) {
                audioData.forEach(fila => {
                    if(fila[0]) revisiones++;
                    if(fila[6] === 'ADAPTABLE') conPerdida++;
                    if(fila[8] === 'EN PRUEBA') prueban++;
                    if(fila[11] === 'SI') compran++;
                });
            }
        });
    } catch(e) {
        console.error('[cargarDatosAARMini] Error:', e);
    }
    
    const el1 = document.getElementById('aarMiniRevisiones');
    const el2 = document.getElementById('aarMiniPerdida');
    const el3 = document.getElementById('aarMiniPrueban');
    const el4 = document.getElementById('aarMiniCompran');
    if(el1) el1.textContent = revisiones;
    if(el2) el2.textContent = conPerdida;
    if(el3) el3.textContent = prueban;
    if(el4) el4.textContent = compran;
}

// Acciones Exclusivos Funnel
let accionesExclusivosFunnel = JSON.parse(localStorage.getItem('accionesExclusivosFunnel') || '[]');
let accionesFlopFunnel = JSON.parse(localStorage.getItem('accionesFlopFunnel') || '[]');

function agregarFilaAccionExclusivosFunnel() {
    const tbody = document.getElementById('tbodyAccionesExclusivosFunnel');
    if(tbody.querySelector('td[colspan]')) tbody.innerHTML = '';
    const tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid #e5e7eb';
    tr.innerHTML = `
        <td style="padding:4px"><select style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px">
            <option value="">Centro...</option>
            <option value="4ABB">4ABB</option><option value="4AKI">4AKI</option><option value="4AXF">4AXF</option>
            <option value="4MRM">4MRM</option><option value="4AQT">4AQT</option><option value="4AWO">4AWO</option>
            <option value="4AXA">4AXA</option><option value="4AZI">4AZI</option><option value="4BMA">4BMA</option>
        </select></td>
        <td style="padding:4px"><input type="date" style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px"></td>
        <td style="padding:4px"><select style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px">
            <option value="">Paquete...</option><option value="1">Tráfico</option><option value="2">Comercial</option><option value="3">Equipo</option>
        </select></td>
        <td style="padding:4px"><input type="text" placeholder="Tipo..." style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px"></td>
        <td style="padding:4px"><input type="number" value="0" min="0" style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px;text-align:center"></td>
        <td style="padding:4px"><input type="number" value="0" min="0" style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px;text-align:center"></td>
        <td style="padding:4px"><input type="number" value="0" min="0" style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px;text-align:center"></td>
        <td style="padding:4px"><input type="text" placeholder="Obs..." style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px"></td>
        <td style="padding:4px;text-align:center"><button onclick="this.closest('tr').remove()" style="background:#dc2626;color:#fff;border:none;padding:3px 6px;border-radius:3px;font-size:8px;cursor:pointer">✕</button></td>
    `;
    tbody.appendChild(tr);
}

function guardarAccionesExclusivosFunnel() {
    const tbody = document.getElementById('tbodyAccionesExclusivosFunnel');
    const filas = tbody.querySelectorAll('tr');
    const datos = [];
    filas.forEach(tr => {
        const celdas = tr.querySelectorAll('td');
        if(celdas.length >= 8) {
            datos.push({
                centro: celdas[0].querySelector('select')?.value || '',
                fecha: celdas[1].querySelector('input')?.value || '',
                paquete: celdas[2].querySelector('select')?.value || '',
                tipo: celdas[3].querySelector('input')?.value || '',
                deriv: celdas[4].querySelector('input')?.value || '0',
                citas: celdas[5].querySelector('input')?.value || '0',
                ventas: celdas[6].querySelector('input')?.value || '0',
                obs: celdas[7].querySelector('input')?.value || ''
            });
        }
    });
    localStorage.setItem('accionesExclusivosFunnel', JSON.stringify(datos));
}

function agregarFilaAccionFlopFunnel() {
    const tbody = document.getElementById('tbodyAccionesFlopFunnel');
    if(tbody.querySelector('td[colspan]')) tbody.innerHTML = '';
    const tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid #e5e7eb';
    tr.innerHTML = `
        <td style="padding:4px"><input type="text" placeholder="4XXX" maxlength="4" style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px;text-transform:uppercase"></td>
        <td style="padding:4px"><input type="date" style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px"></td>
        <td style="padding:4px"><select style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px">
            <option value="">Paquete...</option><option value="1">Tráfico</option><option value="2">Comercial</option><option value="3">Equipo</option>
        </select></td>
        <td style="padding:4px"><input type="text" placeholder="Tipo..." style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px"></td>
        <td style="padding:4px"><input type="number" value="0" min="0" style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px;text-align:center"></td>
        <td style="padding:4px"><input type="number" value="0" min="0" style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px;text-align:center"></td>
        <td style="padding:4px"><input type="number" value="0" min="0" style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px;text-align:center"></td>
        <td style="padding:4px"><input type="text" placeholder="Obs..." style="width:100%;padding:4px;font-size:9px;border:1px solid #ccc;border-radius:3px"></td>
        <td style="padding:4px;text-align:center"><button onclick="this.closest('tr').remove()" style="background:#dc2626;color:#fff;border:none;padding:3px 6px;border-radius:3px;font-size:8px;cursor:pointer">✕</button></td>
    `;
    tbody.appendChild(tr);
}

function guardarAccionesFlopFunnel() {
    const tbody = document.getElementById('tbodyAccionesFlopFunnel');
    const filas = tbody.querySelectorAll('tr');
    const datos = [];
    filas.forEach(tr => {
        const celdas = tr.querySelectorAll('td');
        if(celdas.length >= 8) {
            datos.push({
                centro: celdas[0].querySelector('input')?.value || '',
                fecha: celdas[1].querySelector('input')?.value || '',
                paquete: celdas[2].querySelector('select')?.value || '',
                tipo: celdas[3].querySelector('input')?.value || '',
                deriv: celdas[4].querySelector('input')?.value || '0',
                citas: celdas[5].querySelector('input')?.value || '0',
                ventas: celdas[6].querySelector('input')?.value || '0',
                obs: celdas[7].querySelector('input')?.value || ''
            });
        }
    });
    localStorage.setItem('accionesFlopFunnel', JSON.stringify(datos));
}

// ═══════════════════════════════════════════════════════════════════════════════
// FIREBASE MANAGER - Conexión con Funnel Audio
// ═══════════════════════════════════════════════════════════════════════════════
const FirebaseManagerAdmin = (function(){
    const CONFIG = {
        apiKey: "AIzaSyB9E6GZf-RJbX6Gn0eThg7fpayu4lcwyYs",
        authDomain: "funnel-d0a2e.firebaseapp.com",
        projectId: "funnel-d0a2e",
        storageBucket: "funnel-d0a2e.appspot.com",
        messagingSenderId: "720417248895",
        appId: "1:720417248895:web:89c039a277bbe675fcd14a"
    };
    
    let _db = null, _ready = false, _online = false;
    let _listeners = {}; // Para escuchar cambios en tiempo real
    
    // Esperar a que Firebase SDK esté disponible
    async function esperarSDK(maxIntentos = 30) {
        for(let i = 0; i < maxIntentos; i++) {
            if(typeof firebase !== 'undefined') return true;
            await new Promise(r => setTimeout(r, 100));
        }
        return false;
    }
    
    async function init(){
        if(_ready) return _online;
        
        // Esperar SDK
        const sdkDisponible = await esperarSDK();
        if(!sdkDisponible) {
            console.error('[Firebase Admin] SDK no cargó después de 3 segundos');
            actualizarIndicadorFirebase(false);
            return false;
        }
        
        try {
            if(!firebase.apps.length) firebase.initializeApp(CONFIG);
            _db = firebase.firestore();
            _ready = true;
            await _db.collection('audiometrias').limit(1).get();
            _online = true;
            console.log('[Firebase Admin] ✅ Conectado');
            actualizarIndicadorFirebase(true);
            return true;
        } catch(e){
            console.warn('[Firebase Admin] ⚠️ Offline:', e.message);
            _online = false;
            actualizarIndicadorFirebase(false);
            return false;
        }
    }
    
    return {
        init: init,
        db: function(){ return _db; },
        getDB: function(){ return _db; },
        isOnline: function(){ return _ready && _online; },
        isReady: function(){ return _ready; },
        
        // Cargar todos los centros (una vez)
        async loadAllCentros(){
            if(!_db) return [];
            try {
                const snapshot = await _db.collection('audiometrias').get();
                const datos = [];
                snapshot.forEach(doc => {
                    datos.push({ centro: doc.id, ...doc.data() });
                });
                _online = true;
                return datos;
            } catch(e) {
                console.error('[Firebase Admin] Error cargando:', e);
                return [];
            }
        },
        
        // Cargar un centro específico
        async loadCentro(centroId){
            if(!_db) return null;
            try {
                const doc = await _db.collection('audiometrias').doc(centroId).get();
                return doc.exists ? doc.data() : null;
            } catch(e) {
                console.error('[Firebase Admin] Error cargando centro:', e);
                return null;
            }
        },
        
        // ESCUCHAR CAMBIOS EN TIEMPO REAL (solo lectura)
        escucharCentro(centroId, callback){
            if(!_db) return null;
            // Cancelar listener anterior si existe
            if(_listeners[centroId]) {
                _listeners[centroId]();
            }
            // Crear nuevo listener
            _listeners[centroId] = _db.collection('audiometrias').doc(centroId)
                .onSnapshot(function(doc) {
                    if(doc.exists) {
                        console.log('[Firebase Admin] 🔄 Cambio detectado en', centroId);
                        callback(doc.data());
                    }
                }, function(error) {
                    console.error('[Firebase Admin] Error en listener:', error);
                });
            return _listeners[centroId];
        },
        
        // Dejar de escuchar
        dejarDeEscuchar(centroId){
            if(_listeners[centroId]) {
                _listeners[centroId]();
                delete _listeners[centroId];
            }
        }
    };
})();

// Actualizar indicador visual de Firebase
function actualizarIndicadorFirebase(conectado) {
    const el = document.getElementById('firebase-status-dash');
    if(el) {
        if(conectado) {
            el.textContent = '☁️ Firebase';
            el.style.background = '#dcfce7';
            el.style.color = '#166534';
        } else {
            el.textContent = '⚠️ Offline';
            el.style.background = '#fee2e2';
            el.style.color = '#dc2626';
        }
    }
}

// Cargar datos de gamas desde Firebase - TODOS los centros
// USA LA MISMA CONEXIÓN db QUE EL CUADRO DE MANDOS
async function cargarGamasFirebase() {
    console.log('[cargarGamasFirebase] ▶️ Cargando datos de TODOS los centros...');
    
    // Usar la misma conexión db que el Cuadro de Mandos
    if(!db) {
        await inicializarFirebase();
    }
    
    if(!db) {
        console.error('[cargarGamasFirebase] ❌ No hay conexión a Firebase');
        actualizarIndicadorFirebase(false);
        return;
    }
    
    try {
        // Cargar TODOS los documentos de la colección audiometrias
        const snapshot = await db.collection('audiometrias').get();
        console.log('[cargarGamasFirebase] 📊 Documentos en Firebase:', snapshot.size);
        
        if(snapshot.empty) {
            console.warn('[cargarGamasFirebase] ⚠️ No hay documentos en Firebase');
            actualizarIndicadorFirebase(true);
            return;
        }
        
        let diamante = 0, platino = 0, oro = 0;
        let totalVentas = 0, totalPruebas = 0, totalAudiencias = 0;
        let totalMgm = 0, totalRenove = 0, totalRenove36 = 0, totalRenove42 = 0, totalInfinity = 0, totalSeguros = 0;
        let totalPrimeraVenta = 0;
        let centrosActivos = 0;
        
        // KPIs adicionales del funnel
        let totalConPerdida = 0, totalSinPerdida = 0, totalPerdidaLeve = 0, totalTapones = 0;
        let totalNoPrueba = 0, totalDevuelve = 0;
        let totalBinaural = 0;
        let totalImporte = 0;
        
        // Contadores para procedencia
        const procedencia = {
            'DERIVADO ÓPTICA': 0, 'TV': 0, 'BOCA-BOCA': 0, 'AZAFATA': 0,
            'BUZONEO': 0, 'TELEMARKETING': 0, 'ESCAPARATE': 0, 'CASHBACK': 0,
            'MGM': 0, 'OTROS': 0
        };
        
        // Contadores para tipo de atención
        const tipoAtencion = {
            'ADULTO': 0, 'ADULTO + TINNITUS': 0, 'PEDIÁTRICO': 0
        };
        
        // Contadores para motivo de devolución
        const motivos = {
            'ES CARO': 0, 'FINANCIACIÓN DENEGADA': 0, 'SE VA DE VIAJE': 0,
            'NO VE MEJORÍA': 0, 'CONCIENCIACIÓN': 0, 'BUSCA OTRO AUDÍFONO': 0
        };
        
        let fechaMasRecienteFirebase = null;
        
        // Obtener filtro de delegado regional activo
        const filtroDelegado = document.getElementById('filtro-delegado-dashboard');
        const delegadoSeleccionado = filtroDelegado ? filtroDelegado.value : '';
        const centrosFiltrados = delegadoSeleccionado ? getCentrosPorDelegado(delegadoSeleccionado) : null;
        
        if(centrosFiltrados) {
            console.log('[cargarGamasFirebase] 🔍 Filtro delegado:', delegadoSeleccionado, '- Centros:', centrosFiltrados.join(', '));
        }
        
        // Procesar cada centro
        snapshot.forEach(doc => {
            const data = doc.data();
            const centroId = doc.id;
            
            // Si hay filtro de delegado, saltar centros que no pertenezcan
            if(centrosFiltrados && !centrosFiltrados.includes(centroId)) return;
            
            // Convertir audio a array (puede venir como objeto)
            let audioData = data.audio || [];
            if(audioData && !Array.isArray(audioData)) {
                audioData = Object.keys(audioData)
                    .sort((a,b) => parseInt(a.replace('r','')) - parseInt(b.replace('r','')))
                    .map(k => audioData[k]);
            }
            
            if(audioData && audioData.length > 0) {
                centrosActivos++;
                console.log('[cargarGamasFirebase] ✓ Centro', centroId, ':', audioData.length, 'registros');
                
                audioData.forEach(fila => {
                // Contar audiencias totales (si tiene fecha)
                if(fila[0]) {
                    totalAudiencias++;
                    
                    // Tracking de fecha más reciente
                    const fechaAudio = new Date(fila[0]);
                    if(!isNaN(fechaAudio) && (!fechaMasRecienteFirebase || fechaAudio > fechaMasRecienteFirebase)) {
                        fechaMasRecienteFirebase = fechaAudio;
                    }
                    
                    // PROCEDENCIA (índice 2)
                    const proc = (fila[2] || '').toUpperCase();
                    if(proc.includes('DERIVADO') || proc.includes('ÓPTICA')) procedencia['DERIVADO ÓPTICA']++;
                    else if(proc.includes('TV')) procedencia['TV']++;
                    else if(proc.includes('BOCA')) procedencia['BOCA-BOCA']++;
                    else if(proc.includes('AZAFATA')) procedencia['AZAFATA']++;
                    else if(proc.includes('BUZONEO')) procedencia['BUZONEO']++;
                    else if(proc.includes('TELEMARKETING') || proc.includes('TELE')) procedencia['TELEMARKETING']++;
                    else if(proc.includes('ESCAPARATE')) procedencia['ESCAPARATE']++;
                    else if(proc.includes('CASHBACK')) procedencia['CASHBACK']++;
                    else if(proc.includes('MGM')) procedencia['MGM']++;
                    else if(proc) procedencia['OTROS']++;
                    
                    // TIPO ATENCIÓN (índice 4)
                    const tipoAt = (fila[4] || '').toUpperCase();
                    if(tipoAt.includes('TINNITUS')) tipoAtencion['ADULTO + TINNITUS']++;
                    else if(tipoAt.includes('PEDIÁTRICO') || tipoAt.includes('PEDIATRICO')) tipoAtencion['PEDIÁTRICO']++;
                    else if(tipoAt.includes('ADULTO') || tipoAt) tipoAtencion['ADULTO']++;
                    
                    // PÉRDIDA (índice 6)
                    const perdida = (fila[6] || '').toUpperCase();
                    if(perdida === 'ADAPTABLE') totalConPerdida++;
                    else if(perdida.includes('LEVE') || perdida.includes('SEGUIMIENTO')) totalPerdidaLeve++;
                    else if(perdida.includes('CORRECTA')) totalSinPerdida++;
                    else if(perdida.includes('TAPÓN') || perdida.includes('CERA')) totalTapones++;
                    
                    // BINAURAL (índice 7) - solo si compra
                    if(fila[7] === 'SI' && fila[11] === 'SI') totalBinaural++;
                }
                
                // índice 8 = CAPACITACIÓN
                if(fila[8] === 'EN PRUEBA') totalPruebas++;
                if(fila[8] === 'NO PRUEBA') totalNoPrueba++;
                
                // índice 11 = COMPRA, índice 10 = GAMA
                if(fila[11] === 'SI') {
                    totalVentas++;
                    const gama = (fila[10] || '').toUpperCase();
                    if(gama.includes('DIAMANTE')) diamante++;
                    else if(gama.includes('PLATINO')) platino++;
                    else if(gama.includes('ORO')) oro++;
                    
                    // Importe (índice 9)
                    const importe = parseFloat(fila[9]) || 0;
                    totalImporte += importe;
                }
                if(fila[11] === 'DEVUELVE') totalDevuelve++;
                
                // índice 12 = TIPO VENTA (MGM, RENOVE, INFINITY, PRIMERA VENTA)
                const tipoVenta = (fila[12] || '').toUpperCase();
                if(tipoVenta.includes('MGM')) totalMgm++;
                if(tipoVenta.includes('RENOVE 36') || tipoVenta === 'RENOVE 36M') totalRenove36++;
                if(tipoVenta.includes('RENOVE +42') || tipoVenta.includes('RENOVE42') || tipoVenta === 'RENOVE +42') totalRenove42++;
                if(tipoVenta.includes('RENOVE')) totalRenove++;
                if(tipoVenta.includes('INFINITY')) totalInfinity++;
                if(tipoVenta.includes('PRIMERA')) totalPrimeraVenta++;
                
                // índice 13 = SEGURO
                if(fila[13] === 'SI') totalSeguros++;
                
                // MOTIVO DE DEVOLUCIÓN (índice 14) - solo si DEVUELVE
                if(fila[11] === 'DEVUELVE') {
                    const mot = (fila[14] || '').toUpperCase();
                    if(mot.includes('CARO')) motivos['ES CARO']++;
                    else if(mot.includes('FINANC') || mot.includes('DENEGADA')) motivos['FINANCIACIÓN DENEGADA']++;
                    else if(mot.includes('VIAJE')) motivos['SE VA DE VIAJE']++;
                    else if(mot.includes('MEJORÍA') || mot.includes('MEJORIA')) motivos['NO VE MEJORÍA']++;
                    else if(mot.includes('CONCIENCIA')) motivos['CONCIENCIACIÓN']++;
                    else if(mot.includes('OTRO') || mot.includes('BUSCA')) motivos['BUSCA OTRO AUDÍFONO']++;
                }
            });
        }
    });
    
    // Calcular FUGAS = NO PRUEBA + DEVUELVE + TAPONES
    const totalFugas = totalNoPrueba + totalDevuelve + totalTapones;
    
    // Calcular conversiones
    const convPrueba = totalConPerdida > 0 ? Math.round((totalPruebas / totalConPerdida) * 100) : 0;
    const convVenta = totalPruebas > 0 ? Math.round((totalVentas / totalPruebas) * 100) : 0;
    const convTotal = totalConPerdida > 0 ? Math.round((totalVentas / totalConPerdida) * 100) : 0;
    
    // Ticket medio
    const ticketMedio = totalVentas > 0 ? Math.round(totalImporte / totalVentas) : 0;
    
    // % Binaural
    const pctBinaural = totalVentas > 0 ? Math.round((totalBinaural / totalVentas) * 100) : 0;
    
    // ═══════════════════════════════════════════════════════════════
    // GUARDAR DATOS DE FIREBASE EN VARIABLE GLOBAL
    // ═══════════════════════════════════════════════════════════════
    datosFirebaseGlobal = {
        convPrueba: convPrueba,
        convVenta: convVenta,
        fechaMasReciente: fechaMasRecienteFirebase,
        centrosActivos: centrosActivos,
        totalAudiencias: totalAudiencias,
        cargado: true
    };
    console.log('[cargarGamasFirebase] 💾 Datos guardados en global:', {
        convPrueba: convPrueba + '%',
        convVenta: convVenta + '%',
        fechaMasReciente: fechaMasRecienteFirebase ? fechaMasRecienteFirebase.toISOString().split('T')[0] : 'ninguna'
    });
    
    // LOG: Mostrar qué centros tienen datos
    console.log('[cargarGamasFirebase] ✅ Resumen:');
    console.log('   - Centros con datos:', centrosActivos);
    console.log('   - Total audiometrías:', totalAudiencias);
    console.log('   - Ventas:', totalVentas);
    console.log('   - Conv. Prueba:', convPrueba + '%');
    console.log('   - Conv. Venta:', convVenta + '%');
    
    // Actualizar indicador visual de Firebase
    const statusEl = document.getElementById('firebase-status-dash');
    if(statusEl) {
        statusEl.textContent = '✅ ' + centrosActivos + ' centros';
        statusEl.style.background = '#dcfce7';
        statusEl.style.color = '#166534';
    }
    
    actualizarGraficaGamas(diamante, platino, oro);
    
    // Actualizar KPIs globales del dashboard desde funnels
    actualizarKPIsDashboardFunnel({
        ventas: totalVentas,
        pruebas: totalPruebas,
        audiencias: totalAudiencias,
        conPerdida: totalConPerdida,
        sinPerdida: totalSinPerdida,
        perdidaLeve: totalPerdidaLeve,
        tapones: totalTapones,
        noPrueba: totalNoPrueba,
        devuelve: totalDevuelve,
        fugas: totalFugas,
        binaural: totalBinaural,
        pctBinaural: pctBinaural,
        importe: totalImporte,
        ticketMedio: ticketMedio,
        convPrueba: convPrueba,
        convVenta: convVenta,
        convTotal: convTotal,
        mgm: totalMgm,
        renove: totalRenove,
        renove36: totalRenove36,
        renove42: totalRenove42,
        infinity: totalInfinity,
        primeraVenta: totalPrimeraVenta,
        seguros: totalSeguros,
        centros: centrosActivos,
        diamante: diamante,
        platino: platino,
        oro: oro
    });
    
    // Actualizar PROCEDENCIA en dashboard
    const procMap = {
        'DERIVADO ÓPTICA': 'proc-1', 'TV': 'proc-2', 'BOCA-BOCA': 'proc-3',
        'AZAFATA': 'proc-4', 'BUZONEO': 'proc-5', 'TELEMARKETING': 'proc-6',
        'ESCAPARATE': 'proc-7', 'CASHBACK': 'proc-8', 'MGM': 'proc-9', 'OTROS': 'proc-10'
    };
    let totalProc = 0;
    Object.entries(procedencia).forEach(([k, v]) => {
        totalProc += v;
        const el = document.getElementById(procMap[k]);
        if(el) el.textContent = v;
    });
    const dashProcTotal = document.getElementById('dash-proc-total');
    if(dashProcTotal) dashProcTotal.textContent = totalProc + ' reg.';
    
    // Actualizar TIPO DE ATENCIÓN en dashboard
    const tipoAtenMap = {
        'ADULTO': 'tipoaten-1', 'ADULTO + TINNITUS': 'tipoaten-2', 'PEDIÁTRICO': 'tipoaten-3'
    };
    let totalTipoAten = 0;
    Object.entries(tipoAtencion).forEach(([k, v]) => {
        totalTipoAten += v;
        const el = document.getElementById(tipoAtenMap[k]);
        if(el) el.textContent = v;
    });
    const dashTipoAtenTotal = document.getElementById('dash-tipoaten-total');
    if(dashTipoAtenTotal) dashTipoAtenTotal.textContent = totalTipoAten + ' reg.';
    
    // Actualizar MOTIVOS DE DEVOLUCIÓN en dashboard
    const motivoMap = {
        'ES CARO': 'motivo-1', 'FINANCIACIÓN DENEGADA': 'motivo-2', 'SE VA DE VIAJE': 'motivo-3',
        'NO VE MEJORÍA': 'motivo-4', 'CONCIENCIACIÓN': 'motivo-5', 'BUSCA OTRO AUDÍFONO': 'motivo-6'
    };
    let totalMotivos = 0;
    Object.entries(motivos).forEach(([k, v]) => {
        totalMotivos += v;
        const el = document.getElementById(motivoMap[k]);
        if(el) el.textContent = v;
    });
    const dashMotivoTotal = document.getElementById('dash-motivo-total');
    if(dashMotivoTotal) dashMotivoTotal.textContent = totalMotivos + ' casos';
    
    console.log('[Dashboard] Funnel KPIs cargados - Ventas:', totalVentas, 'Conv.Prueba:', convPrueba+'%', 'Conv.Venta:', convVenta+'%', 'Fugas:', totalFugas);
    
    } catch(e) {
        console.error('[cargarGamasFirebase] ❌ Error:', e);
        actualizarIndicadorFirebase(false);
    }
}

// Actualizar KPIs del dashboard desde datos de funnel Firebase
function actualizarKPIsDashboardFunnel(kpis) {
    // GUARDAR DATOS LOCALMENTE para persistencia offline
    localStorage.setItem('funnelDashboardData', JSON.stringify(kpis));
    
    // Usar conversiones ya calculadas o calcular
    const convPrueba = kpis.convPrueba || (kpis.conPerdida > 0 ? Math.round((kpis.pruebas / kpis.conPerdida) * 100) : 0);
    const convVenta = kpis.convVenta || (kpis.pruebas > 0 ? Math.round((kpis.ventas / kpis.pruebas) * 100) : 0);
    
    // ═══════════════════════════════════════════════════════════════
    // SECCIÓN FUNNEL - CONVERSIONES
    // ═══════════════════════════════════════════════════════════════
    const dashConvPrueba = document.getElementById('dash-conv-prueba');
    const dashConvVenta = document.getElementById('dash-conv-venta');
    if(dashConvPrueba) {
        dashConvPrueba.textContent = convPrueba + '%';
        dashConvPrueba.style.color = convPrueba >= 80 ? '#10b981' : convPrueba >= 60 ? '#f59e0b' : '#dc2626';
    }
    if(dashConvVenta) {
        dashConvVenta.textContent = convVenta + '%';
        dashConvVenta.style.color = convVenta >= 80 ? '#10b981' : convVenta >= 60 ? '#f59e0b' : '#dc2626';
    }
    
    // ═══════════════════════════════════════════════════════════════
    // SECCIÓN FUNNEL - TIPO DE VENTA (Renove, MGM, Infinity)
    // ═══════════════════════════════════════════════════════════════
    const dashRenove3 = document.getElementById('dash-renove3');
    const dashRenove42 = document.getElementById('dash-renove42');
    const dashMgm = document.getElementById('dash-mgm');
    const dashInfinity = document.getElementById('dash-infinity');
    const dashFuga = document.getElementById('dash-fuga');
    
    if(dashRenove3) dashRenove3.textContent = kpis.renove36 || 0;
    if(dashRenove42) dashRenove42.textContent = kpis.renove42 || 0;
    if(dashMgm) dashMgm.textContent = kpis.mgm || 0;
    if(dashInfinity) dashInfinity.textContent = kpis.infinity || 0;
    if(dashFuga) dashFuga.textContent = kpis.fugas || 0;
    
    // TAPONES DE CERA
    const dashTapones = document.getElementById('dash-tapones');
    if(dashTapones) dashTapones.textContent = kpis.tapones || 0;
    
    // ═══════════════════════════════════════════════════════════════
    // OTROS KPIs SI EXISTEN ELEMENTOS
    // ═══════════════════════════════════════════════════════════════
    const dashRenove = document.getElementById('dash-renove');
    const dashSeguros = document.getElementById('dash-seguros');
    const dashVentas = document.getElementById('dash-funnel-ventas');
    const dashPruebas = document.getElementById('dash-funnel-pruebas');
    const dashAudiencias = document.getElementById('dash-funnel-audiencias');
    const dashFugas = document.getElementById('dash-funnel-fugas');
    const dashBinaural = document.getElementById('dash-funnel-binaural');
    const dashTicket = document.getElementById('dash-funnel-ticket');
    const dashImporte = document.getElementById('dash-funnel-importe');
    
    if(dashRenove) dashRenove.textContent = kpis.renove || 0;
    if(dashSeguros) dashSeguros.textContent = kpis.seguros || 0;
    if(dashVentas) dashVentas.textContent = kpis.ventas || 0;
    if(dashPruebas) dashPruebas.textContent = kpis.pruebas || 0;
    if(dashAudiencias) dashAudiencias.textContent = kpis.audiencias || 0;
    if(dashFugas) dashFugas.textContent = kpis.fugas || 0;
    if(dashBinaural) dashBinaural.textContent = (kpis.pctBinaural || 0) + '%';
    if(dashTicket) dashTicket.textContent = (kpis.ticketMedio || 0).toLocaleString('es-ES') + '€';
    if(dashImporte) dashImporte.textContent = (kpis.importe || 0).toLocaleString('es-ES') + '€';
    
    // ═══════════════════════════════════════════════════════════════
    // ESTADO DE CONEXIÓN
    // ═══════════════════════════════════════════════════════════════
    const statusEl = document.getElementById('firebase-status-dash');
    if(statusEl && kpis.centros > 0) {
        statusEl.textContent = '✓ ' + kpis.centros + ' centros activos';
        statusEl.style.background = '#dcfce7';
        statusEl.style.color = '#166534';
    }
    
    console.log('[Dashboard] ✅ KPIs actualizados desde Funnel -', 
        'Centros:', kpis.centros || 0,
        'Ventas:', kpis.ventas || 0, 
        'Conv.Prueba:', convPrueba + '%',
        'Conv.Venta:', convVenta + '%',
        'Fugas:', kpis.fugas || 0);
}

// Cargar datos del funnel desde localStorage (para modo offline)
function cargarDatosFunnelLocal() {
    try {
        const datos = JSON.parse(localStorage.getItem('funnelDashboardData'));
        if(datos) {
            actualizarKPIsDashboardFunnel(datos);
            // Cargar gamas también
            const gamasData = JSON.parse(localStorage.getItem('gamasDashboardData'));
            if(gamasData) {
                actualizarGraficaGamas(gamasData.diamantePlus || 0, gamasData.diamante || 0, gamasData.platinoPlus || 0, gamasData.platino || 0, gamasData.oro || 0);
            }
        }
    } catch(e) {
        console.warn('Error cargando datos locales:', e);
    }
}

// Actualizar gráfica de gamas
function actualizarGraficaGamas(diamantePlus, diamante, platinoPlus, platino, oro) {
    // Compatibilidad con llamadas antiguas (3 parámetros)
    if(arguments.length === 3) {
        oro = arguments[2];
        platino = arguments[1];
        diamante = arguments[0];
        diamantePlus = 0;
        platinoPlus = 0;
    }
    
    // GUARDAR DATOS LOCALMENTE
    localStorage.setItem('gamasDashboardData', JSON.stringify({diamantePlus, diamante, platinoPlus, platino, oro}));
    
    const total = diamantePlus + diamante + platinoPlus + platino + oro;
    document.getElementById('gama-total').textContent = total;
    
    const elDashDiamantePlus = document.getElementById('dash-gama-diamante-plus');
    const elDashDiamante = document.getElementById('dash-gama-diamante');
    const elDashPlatinoPlus = document.getElementById('dash-gama-platino-plus');
    const elDashPlatino = document.getElementById('dash-gama-platino');
    const elDashOro = document.getElementById('dash-gama-oro');
    
    if(elDashDiamantePlus) elDashDiamantePlus.textContent = diamantePlus;
    if(elDashDiamante) elDashDiamante.textContent = diamante;
    if(elDashPlatinoPlus) elDashPlatinoPlus.textContent = platinoPlus;
    if(elDashPlatino) elDashPlatino.textContent = platino;
    if(elDashOro) elDashOro.textContent = oro;
    
    if(total > 0) {
        const pctDiamantePlus = (diamantePlus / total) * 100;
        const pctDiamante = (diamante / total) * 100;
        const pctPlatinoPlus = (platinoPlus / total) * 100;
        const pctPlatino = (platino / total) * 100;
        const pctOro = (oro / total) * 100;
        
        // Actualizar círculos SVG
        const circleDiamante = document.getElementById('gama-circle-diamante');
        const circlePlatinoPlus = document.getElementById('gama-circle-platino-plus');
        const circlePlatino = document.getElementById('gama-circle-platino');
        const circleOro = document.getElementById('gama-circle-oro');
        
        if(circleDiamante) {
            circleDiamante.setAttribute('stroke-dasharray', (pctDiamantePlus + pctDiamante) + ' ' + (100 - pctDiamantePlus - pctDiamante));
        }
        if(circlePlatinoPlus) {
            circlePlatinoPlus.setAttribute('stroke-dasharray', pctPlatinoPlus + ' ' + (100 - pctPlatinoPlus));
            circlePlatinoPlus.setAttribute('stroke-dashoffset', -(pctDiamantePlus + pctDiamante));
        }
        if(circlePlatino) {
            circlePlatino.setAttribute('stroke-dasharray', pctPlatino + ' ' + (100 - pctPlatino));
            circlePlatino.setAttribute('stroke-dashoffset', -(pctDiamantePlus + pctDiamante + pctPlatinoPlus));
        }
        if(circleOro) {
            circleOro.setAttribute('stroke-dasharray', pctOro + ' ' + (100 - pctOro));
            circleOro.setAttribute('stroke-dashoffset', -(pctDiamantePlus + pctDiamante + pctPlatinoPlus + pctPlatino));
        }
        
        // Actualizar semáforo de gamas
        const semDiamantePlus = document.getElementById('gama-sem-diamante-plus');
        const semDiamante = document.getElementById('gama-sem-diamante');
        const semPlatinoPlus = document.getElementById('gama-sem-platino-plus');
        const semPlatino = document.getElementById('gama-sem-platino');
        const semOro = document.getElementById('gama-sem-oro');
        if(semDiamantePlus) semDiamantePlus.style.flex = pctDiamantePlus || 1;
        if(semDiamante) semDiamante.style.flex = pctDiamante || 1;
        if(semPlatinoPlus) semPlatinoPlus.style.flex = pctPlatinoPlus || 1;
        if(semPlatino) semPlatino.style.flex = pctPlatino || 1;
        if(semOro) semOro.style.flex = pctOro || 1;
    }
}

// Inicializar Firebase al cargar
document.addEventListener('DOMContentLoaded', async function() {
    // Desactivar corrector ortográfico global
    document.querySelectorAll('textarea,input,[contenteditable]').forEach(function(el){el.spellcheck=false;el.setAttribute('spellcheck','false');});
    
    // Limpiar datos corruptos (anidación recursiva de preinformeData)
    try {
        var needsCleanup = false;
        ['informesBorrador','borradoresInforme','informesFinalizados'].forEach(function(key) {
            var arr = JSON.parse(localStorage.getItem(key) || '[]');
            var cleaned = false;
            for(var ci = 0; ci < arr.length; ci++) {
                if(arr[ci].preinformeData && arr[ci].preinformeData.preinformeData) {
                    delete arr[ci].preinformeData.preinformeData;
                    delete arr[ci].preinformeData.checklistHTML;
                    delete arr[ci].preinformeData.imagenes;
                    cleaned = true;
                }
            }
            if(cleaned) {
                var json = JSON.stringify(arr);
                try { localStorage.setItem(key, json); needsCleanup = true; } catch(e){}
                console.log('[Startup] 🧹 Limpiado ' + key + ' (' + Math.round(json.length/1024) + 'KB)');
            }
        });
        if(needsCleanup) console.log('[Startup] ✅ Datos limpiados de anidación recursiva');
    } catch(e) { console.warn('[Startup] Error limpiando:', e); }
    
    // Optimizar almacenamiento al arrancar (libera espacio para 100+ informes)
    try { optimizarStorage(); } catch(e) { console.warn('[Startup] Error optimizando:', e); }
    
    // PRIMERO: Cargar datos locales inmediatamente (como respaldo)
    cargarDatosFunnelLocal();
    
    // Cargar lista de centros exclusivos en dashboard
    cargarTablaCentrosExclusivosDash();
    
    // Actualizar contador de filtros con total de centros (sin DEMO/PRUEBAS)
    var totalCentros = centrosData.filter(function(c) { return c.t !== 'DEMO' && c.t !== 'PRUEBAS'; }).length;
    var countEl = document.getElementById('filtrosDashCount');
    if(countEl) countEl.textContent = totalCentros + ' centros';
    
    // LUEGO: Conectar con Firebase y cargar TODOS los datos
    setTimeout(async () => {
        try {
            // 1. Inicializar Firebase (la misma conexión que usa el Cuadro de Mandos)
            await inicializarFirebase();
            
            if(db) {
                console.log('[Dashboard] ✅ Firebase conectado, cargando datos de TODOS los centros...');
                // 2. Cargar datos de TODOS los centros de Firebase para el dashboard
                await cargarGamasFirebase();
                console.log('[Dashboard] ✅ Datos de Firebase cargados');
            } else {
                console.warn('[Dashboard] ⚠️ Firebase no conectado');
            }
        } catch(e) {
            console.warn('[Dashboard] Error conectando Firebase:', e);
        }
        
        // 3. DESPUÉS de Firebase, actualizar con datos de informes (comparará fechas)
        actualizarDashboardMedia();
        console.log('[Dashboard] ✅ Comparación Firebase/Informes completada');
    }, 500);
});

const bloques = [
    {id:'PIA',nombre:'PIA',largo:'Protocolo Integral de Atención',peso:25,gradient:'linear-gradient(135deg,#C9A227,#B08D1E)'},
    {id:'FORMACION',nombre:'FORMACIÓN',largo:'Formación',peso:15,gradient:'linear-gradient(135deg,#5c5c5c,#4a4a4a)'},
    {id:'COMUNICACION',nombre:'COMUNICACIÓN',largo:'Comunicación del Centro',peso:15,gradient:'linear-gradient(135deg,#C9A227,#B8963D)'},
    {id:'AYUDAS',nombre:'AYUDAS',largo:'Ayudas',peso:4,gradient:'linear-gradient(135deg,#8b8b8b,#6b6b6b)'},
    {id:'COMPLEMENTARIAS',nombre:'COMPLEMENTARIAS',largo:'Actuaciones Complementarias',peso:6,gradient:'linear-gradient(135deg,#7a7a7a,#5a5a5a)'},
    {id:'RT',nombre:'RT',largo:'Responsable Tienda',peso:25,gradient:'linear-gradient(135deg,#C9A227,#B08D1E)'},
    {id:'AGENDA',nombre:'AGENDA',largo:'Gestión de Agenda',peso:10,gradient:'linear-gradient(135deg,#d4af37,#b8963d)'},
    {id:'CONVERSIONES',nombre:'CONVERSIONES',largo:'Conversiones',peso:0,gradient:'linear-gradient(135deg,#C9A227,#a88b1e)'}
];
const obligatorias = [3,4,6,7,11,14,23,41,43,47,58,59,60];
const preguntas = [
    {id:1,bloque:'PIA',criterio:'Gabinete de audio limpio y ordenado.',valor:3,tipo:'binario',detalle:'Mesa limpia, solo con equipos y mínimo material (tipo lápices/bolígrafos en un recipiente) y bandeja de audio con algún elemento de trabajo inmediato, como pilas, estetoclip o cargador. En el suelo, sillas o cualquier espacio del gabinete no debe haber prendas personales ni cajas o albaranes a la vista. La papelera debe estar sin papeles que sobresalgan de su límite superior, ya que su contenido no debe sobresalir.'},
    {id:2,bloque:'PIA',criterio:'Uniforme adecuado y chapa identificativa.',valor:3,tipo:'binario',detalle:'El profesional debe llevar uniforme limpio, planchado y en buen estado. La chapa identificativa debe estar visible en todo momento, mostrando nombre y cargo. La imagen personal debe ser pulcra y profesional.'},
    {id:3,bloque:'PIA',criterio:'Espéculos, olivas y cascos desinfectados, tener un lugar adecuado para almacenar los usados.',valor:3,tipo:'binario',detalle:'Debe haber un ultrasonido en el centro o, en su defecto, producto específico de desinfección con un contenedor donde colocar los accesorios utilizados. La desinfección debe realizarse después de cada uso.',obligatoria:true},
    {id:4,bloque:'PIA',criterio:'Acoger al cliente con una sonrisa, amable y cercano.',valor:3,tipo:'binario',detalle:'Siempre que se reciba al cliente y a sus familiares, deben ser recibidos con una sonrisa, preguntando cómo se encuentran, llamándolos por su nombre y dándoles la mano a la vez que se indica el paso al gabinete. Si fuera necesario ayudarles con elementos pesados o silla de ruedas, nos ofreceremos a hacerlo. Ejemplo: «Hola, María, la estábamos esperando, ¿cómo está? Bienvenida, adelante».',obligatoria:true},
    {id:5,bloque:'PIA',criterio:'Llamar al paciente por su nombre.',valor:3,tipo:'binario',detalle:'Siempre, tanto con el cliente como con los familiares, debemos llamarles por su nombre para crear cercanía y confianza. El uso del nombre personaliza la atención y genera un vínculo más estrecho.'},
    {id:6,bloque:'PIA',criterio:'Acompañar al paciente al gabinete para la revisión auditiva.',valor:3,tipo:'binario',detalle:'Siempre, tanto con el cliente como con los familiares, debemos acompañarlos al gabinete para la revisión auditiva de manera amable y atenta, guiándolos hasta su asiento.',obligatoria:true},
    {id:7,bloque:'PIA',criterio:'Ofrecer pasar a gabinete al acompañante.',valor:3,tipo:'binario',detalle:'Si el gabinete es muy pequeño, el acompañante debe esperar fuera, pero ofreceremos que pase si hay espacio. Una vez dentro del gabinete, invitamos al paciente a sentarse, y a sus familiares si fuera posible por espacio.',obligatoria:true},
    {id:8,bloque:'PIA',criterio:'Confirmar el motivo de la visita.',valor:3,tipo:'binario',detalle:'Se debe rellenar el motivo de visita compartido en GIO y preguntar al paciente el motivo de su visita. Esto permite personalizar la atención y enfocar la consulta adecuadamente.'},
    {id:9,bloque:'PIA',criterio:'Preguntar cómo nos ha conocido y anotarlo en el funnel',valor:3,tipo:'binario',detalle:'Preguntar cómo nos ha conocido y anotarlo en el funnel'},
    {id:10,bloque:'PIA',criterio:'Presentarnos por nombre y especialidad y hacer referencia a la compañía',valor:2,tipo:'binario',detalle:'Antes de comenzar la anamnesis y detallar el motivo de visita, en esta primera toma de contacto vamos a presentarnos siempre por nuestro nombre y nuestra especialidad. Ejemplo: «Fenomenal, yo soy XX, audioprotesista y especialista en acúfenos, encantada. Seguramente sabe que estamos en todo el territorio español, por lo que si necesita de nosotros puede tener servicio siempre...».'},
    {id:11,bloque:'PIA',criterio:'Abrir ficha y rellenar RGPD completa (incluidos checks de condiciones comerciales).',valor:3,tipo:'binario',detalle:'Antes de comenzar con el motivo de visita y anamnesis, si no es cliente, debemos recoger los datos personales y la firma del RGPD (incluidas las condiciones comerciales). Copiaremos los datos en Noah para no hacérselos repetir al paciente y explicamos que a continuación vamos a conocer un poco qué ha estado notando y algunos detalles más para tener una visión global.',obligatoria:true},
    {id:12,bloque:'PIA',criterio:'Realizar anamnesis HACE, respetando cada parte: Hábitos, Antecedentes, Clínica y Expectativas.',valor:3,tipo:'binario',detalle:'En este momento es muy importante tener cercanía física con el paciente, mirarlo a los ojos y prestar la máxima atención a cada detalle. NO se debe estar escribiendo en el ordenador mientras el paciente o los familiares están explicando sus experiencias o necesidades. Se deben abarcar todos los aspectos y la estructura de H-A-C-E (Hábitos, Antecedentes, Clínica y Expectativas).'},
    {id:13,bloque:'PIA',criterio:'Explicar que realizamos un examen auditivo completo.',valor:3,tipo:'binario',detalle:'El audiólogo debe explicar que se va a proceder a realizar la audiometría, donde realizaremos pruebas destinadas a saber cómo oye y otras destinadas a saber cómo entiende. Debe tranquilizar al paciente para que no se angustie si cree que va a fallar. Ejemplo: «María, vamos a realizar varias pruebas; no tengas prisa, que no es un examen. Oirás sonidos más altos y más bajos y me lo indicarás con la mano o con el pulsador según los vayas escuchando, lo que te resulte más cómodo».'},
    {id:14,bloque:'PIA',criterio:'Realizar una breve explicación en cada prueba y asegurarnos de que lo ha entendido.',valor:2,tipo:'binario',detalle:'En cada prueba que se realice, el audiólogo debe explicar brevemente en qué consiste y asegurarse de que el paciente lo ha entendido antes de comenzar. Utilizar lenguaje sencillo y verificar comprensión.',obligatoria:true},
    {id:15,bloque:'PIA',criterio:'La TV debe estar encendida siempre para comunicar contenido de audio y mostrar los resultados de las pruebas.',valor:2,tipo:'binario',detalle:'La TV debe tener siempre comunicación de Audio (campañas, producto, Infinity) y se enseñarán todos los resultados en el momento de explicarlos. También se podrá utilizar si se hacen simulaciones. Nunca debe estar apagada durante la atención.'},
    {id:16,bloque:'PIA',criterio:'Evaluamos ambos oídos con la videotoscopia, dejamos registro con fotos y explicamos el procedimiento.',valor:3,tipo:'binario',detalle:'Se explica la prueba que se va a realizar, dejando claro que no es dolorosa y que simplemente vamos a visualizar el conducto y tímpano para comprobar que podemos continuar. Se harán siempre fotos de cada oído del paciente, visualizando cada parte del conducto, enfocando al tímpano, parte superior del ático, partes laterales, haz de luz y parte del martillo, así como el aspecto del tímpano y paredes del CAE.'},
    {id:17,bloque:'PIA',criterio:'Realizar timpanometría y explicar el procedimiento.',valor:3,tipo:'binario',detalle:'Explicación del procedimiento: indicamos que «ejerce un poco de presión, pero no duele». Se debe hacer un oído y luego el otro. Se deben interpretar los resultados de las curvas, siendo la curva B motivo de derivación al médico.'},
    {id:18,bloque:'PIA',criterio:'Realizar VA y explicar el procedimiento.',valor:3,tipo:'binario',detalle:'Se explica que comenzamos las pruebas por vía aérea (VA), que se realizan con el casco emitiendo sonido por los oídos. Esta prueba se realiza para conocer a qué intensidad oye y compararlo con los umbrales de audición correcta. Se debe indicar al paciente que no duele y que simplemente nos avise con la mano o pulsador si oye algo, aunque sea muy bajito.'},
    {id:19,bloque:'PIA',criterio:'Realizar VO y explicar el procedimiento.',valor:3,tipo:'binario',detalle:'Se explica que comenzamos las pruebas por vía ósea (VO), que se realizan con la diadema de vibrador emitiendo el sonido en forma de vibración por la mastoides del oído a evaluar. Se debe indicar al paciente que puede molestar un poco, pero que es más corta que la anterior.'},
    {id:20,bloque:'PIA',criterio:'Realizar UCL, explicar el procedimiento y estar atento a las reacciones. Si no es posible hacerlo, debe marcarse como "estimado".',valor:3,tipo:'binario',detalle:'Se explica la prueba haciendo hincapié en que debe avisar con el pulsador o la mano cuando le moleste el sonido, no cuando esté alto. Es importante que entienda que es una prueba de molestia. En caso de pacientes con tinnitus, hiperacusia o que se nieguen a hacer la prueba, deberemos marcar un estimado en 100 dB, anotándolo en observaciones.'},
    {id:21,bloque:'PIA',criterio:'Explicar para qué se utiliza la prueba HIT, tener conocimiento de cómo se realiza y usarla para la argumentación de la valoración del rendimiento del audífono.',valor:3,tipo:'binario',detalle:'Cada cliente debe conocer las pruebas que se realizan a sus audífonos para garantizar un funcionamiento óptimo. Para ello, el audiólogo debe controlar la prueba, saber realizarla, interpretarla y comunicarla.'},
    {id:22,bloque:'PIA',criterio:'Realizar logoaudiometría y explicar el procedimiento.',valor:3,tipo:'binario',detalle:'Explicar que es una prueba donde se valora el entendimiento en entorno ideal. Se explica que «primeramente pasaremos una lista de palabras más bien en un tono bajo y deberá repetir siempre la palabra que escuche, pero si no la entiende no pasa nada, lo volvemos a repetir luego más alto».'},
    {id:23,bloque:'PIA',criterio:'Resumir los resultados y dar explicación.',valor:3,tipo:'binario',detalle:'En el momento de explicar los resultados obtenidos, el audiólogo debe hacerlo con ejemplos y sin tecnicismos. No debe emplear los términos «graves» o «agudos» sin poner un ejemplo cotidiano de sonidos que el paciente sepa identificar. Se explica lo que oye mejor y luego dónde tiene la mayor dificultad según la gráfica.',obligatoria:true},
    {id:24,bloque:'PIA',criterio:'Utilizar las gráficas como apoyo para que sea más visible cada explicación (severidad, área audible, fonemas...).',valor:3,tipo:'binario',detalle:'Utilizar las gráficas como apoyo para que sea más visible cada explicación (severidad, área audible, fonemas...).'},
    {id:25,bloque:'PIA',criterio:'Vincular los resultados obtenidos en la audiometría con síntomas o quejas mencionadas en la anamnesis.',valor:3,tipo:'binario',detalle:'Los resultados seguramente son coherentes con la queja principal o el relato del paciente. Por eso, una vez que obtenemos los resultados, debemos realizar una vinculación entre resultado y motivo de visita para que el paciente entienda cómo comienza a afectar la pérdida auditiva.'},
    {id:26,bloque:'PIA',criterio:'Crear necesidad: hacer visible la pérdida auditiva con sus consecuencias relevantes a nivel cognitivo, social, seguridad, laboral, dependencia y autoestima.',valor:3,tipo:'binario',detalle:'Es necesario hacer hincapié en las consecuencias de tener una pérdida auditiva. «No es solo NO entender en ruido, subir la TV; es más profundo». Debemos concienciar y no dejar de nombrar las consecuencias a nivel COGNITIVO: el cerebro procesa más lentamente, aparecerán problemas de autoestima, aislamiento, inseguridades, problemas laborales, de equilibrio, de seguridad para el paciente y personas a su cargo, dependencia para labores cotidianas como ir al banco o al médico, caídas frecuentes y sus consecuencias... «No es subir la TV». Es más importante.'},
    {id:27,bloque:'PIA',criterio:'Simular sonidos para visualizar la diferencia de percepción del sonido (tanto para el paciente, como para el acompañante).',valor:3,tipo:'binario',detalle:'Es importante simular sonidos cotidianos para que el paciente y acompañante vean la diferencia de percepción del sonido con y sin la pérdida auditiva. Utilizar el software de simulación disponible para hacer tangible la diferencia.'},
    {id:28,bloque:'PIA',criterio:'Explicar al cliente que vamos a realizar una prueba de capacitación en ambientes reales para valorar su respuesta y saber cómo el cerebro discrimina entre ruido y palabra (si no le apetece, al menos durante unos días).',valor:3,tipo:'binario',detalle:'Explicar al cliente que vamos a realizar una prueba de capacitación en ambientes reales para valorar su respuesta y saber cómo el cerebro discrimina entre ruido y palabra en su ambiente real. Si no le apetece, intentar al menos durante unos días. En caso de continuar la negativa, intentar que sea in situ en el gabinete un rato y anotar todo en Noah.'},
    {id:29,bloque:'PIA',criterio:'Disponer de un stock suficiente de audífonos en tienda según necesidades.',valor:3,tipo:'binario',detalle:'Disponer de stock de audífonos según la agenda y el tráfico. El stock debe ser controlado según las condiciones comerciales de devolución. Se debe revisar la agenda y el stock y asegurarse de que, en el momento de la prueba de capacitación, los audífonos estén disponibles y cargados.'},
    {id:30,bloque:'PIA',criterio:'Llevar un control de stock adecuado y conocer las condiciones de devolución, abonos, etc., según cada proveedor.',valor:3,tipo:'binario',detalle:'Debe conocer las condiciones de los proveedores y mantener un stock adecuado coherente con su agenda y tráfico. Conocer plazos y condiciones de devolución de cada proveedor.'},
    {id:31,bloque:'PIA',criterio:'Escoger el audífono con base en el perfil, en gama Diamante, explicando que dicha prueba es para valorar su mejor respuesta a los sonidos con el mejor audífono.',valor:3,tipo:'binario',detalle:'Escoger el audífono con base en el perfil, en gama Diamante, explicando que dicha prueba es para valorar su mejor respuesta a los sonidos con el mejor audífono.'},
    {id:32,bloque:'PIA',criterio:'Realizar las pruebas de colocación del audífono.',valor:3,tipo:'binario',detalle:'Debemos ponerle los audífonos al paciente y enseñarle con el espejo cómo quedan puestos. Luego debemos enseñarle a identificar derecho e izquierdo y a ponérselos hasta que veamos que domina el procedimiento. En caso de ser un paciente dependiente, debemos hacer lo mismo con su cuidador.'},
    {id:33,bloque:'PIA',criterio:'Explicar al cliente el funcionamiento y mantenimiento de los audífonos para que se los pueda llevar a casa.',valor:3,tipo:'binario',detalle:'Explicar al paciente cómo funcionan: si es de pila, cómo se pone y quita la pila, enseñar la posición correcta e indicar que detrás, en el pasaporte, puede verlo también en casa. Si son recargables, se debe enseñar cómo se ponen a cargar, explicar que se encienden al sacarlos del cargador y se apagan automáticamente al meterlos en el cargador.'},
    {id:34,bloque:'PIA',criterio:'Entregar la documentación en la entrega del audífono (contrato, presupuesto y pasaporte).',valor:3,tipo:'binario',detalle:'Se deben entregar estos tres elementos para garantizar el control del préstamo de los audífonos, asegurarnos de que el paciente dispone de información para poder consultar y, además, puede hacer uso de su pasaporte, con un manual incorporado y con espacios para anotar molestias y mejoras.'},
    {id:35,bloque:'PIA',criterio:'Cumplimentar el contrato correctamente.',valor:3,tipo:'binario',detalle:'El contrato debe estar debidamente cumplimentado, sin hacer fotocopias del DNI; solo debemos contrastarlo. Cada dato debe estar perfectamente documentado tal y como indica el contrato, de manera que la información sea válida ante cualquier incidencia.'},
    {id:36,bloque:'PIA',criterio:'Registrar la prueba en GIO en cuanto el audífono sale de la tienda.',valor:3,tipo:'binario',detalle:'Se debe registrar la prueba en GIO correctamente como encargo Tchin Tchin Audio. En el registro del encargo se bonifica un audífono; en caso de CROS, sería el CROS el que se bonifica. Se añaden al encargo los dos auriculares y el cargador si fuera recargable, todo bonificado.'},
    {id:37,bloque:'PIA',criterio:'Llamar al día siguiente para saber cómo se encuentra con los audífonos.',valor:3,tipo:'binario',detalle:'Explicar al cliente que le llamaremos al día siguiente para saber cómo se encuentra con los audífonos. Propondremos una franja horaria de la llamada para no ser inoportunos: «¿Sobre las 12 h le viene bien que le llame?». Esta llamada es obligatoria y, en caso de cualquier incidencia o necesidad, se dará cita inmediatamente.'},
    {id:38,bloque:'PIA',criterio:'Citar en 4 días en el momento que se lleva los audífonos.',valor:3,tipo:'binario',detalle:'El mismo día de la primera cita, antes de la despedida, citaremos en 4 días y dejaremos agendada la nueva cita de ajuste, argumentando que, al ser una programación progresiva y de valoración, debemos ver su comportamiento y rendimiento en períodos cortos de tiempo. De no ser posible la cita en 4 días, buscaremos el día más próximo posible.'},
    {id:39,bloque:'PIA',criterio:'Hacer campo libre para demostrar lo que ha mejorado con la intención de cierre de venta y acortar tiempos de prueba.',valor:3,tipo:'binario',detalle:'El campo libre debe ser una prueba que domine el audiólogo para conocer y demostrar cómo mejora el paciente. Demostrará los resultados sin audífonos y con audífonos (repitiendo la misma acción, bien tonal o con logoaudiometría a 40 dB). Se usa como intención de cierre para mostrar la mejora objetiva, tanto en cierres como en renovaciones, para comprobar el rendimiento del nuevo frente al antiguo.'},
    {id:40,bloque:'PIA',criterio:'En cada visita, resaltar los logros respecto a las expectativas y los ajustes. Aplicar neuroventas.',valor:2,tipo:'binario',detalle:'En cada visita, resaltar los logros respecto a las expectativas y los ajustes. Aplicar neuroventas.'},
    {id:41,bloque:'PIA',criterio:'Aplicar la promoción Tchin Tchin.',valor:3,tipo:'binario',detalle:'Aplicar la promoción Tchin Tchin.',obligatoria:true},
    {id:42,bloque:'PIA',criterio:'Capacidad de resolución de objeciones.',valor:2,tipo:'binario',detalle:'Se deben resolver todas las objeciones del paciente con demostraciones que den credibilidad al argumento del audiólogo. Ejemplo: «No veo que mejoro»: se hace campo libre y se demuestra que sí hay mejoría. Otro ejemplo: «Son muy caros»: debemos explicar las facilidades de pago o plantear otra gama más económica.'},
    {id:43,bloque:'PIA',criterio:'Explicar facilidades de pago:  NextYear.',valor:3,tipo:'binario',detalle:'El paciente en todo momento debe saber que, si todo va estupendamente, tiene facilidades de pago a su disposición. Por ejemplo, una vez que el paciente ha venido a revisiones y ajustes y demuestra estar contento o animado, podremos reforzar todas las ventajas de Afflelou nuevamente, con foco en la facilidad de pago, en este caso hasta 48 meses con Next Year. Se recomienda comenzar siempre hablando de cuotas, ya que el impacto se reduce. Siempre se imprimirá el presupuesto.',obligatoria:true},
    {id:44,bloque:'PIA',criterio:'Explicar facilidades de pago: Infinity',valor:3,tipo:'binario',detalle:'El paciente en todo momento debe saber que, si todo va estupendamente, tiene facilidades de pago a su disposición. Por ejemplo, una vez que el paciente ha venido a revisiones y ajustes y demuestra estar contento o animado, podremos reforzar todas las ventajas de Afflelou nuevamente, con foco en la facilidad de pago flexible, en este caso con Infinity, donde siempre gana, por un lado paga cómodamente sin intereses y puede decidir en el mes 36 si continúan con esos audífonos o prefiere disfrutar de otros nuevos y actualizados con nuevos beneficios que además asumimos las cuotas restantes.. Se recomienda comenzar siempre hablando de cuotas, ya que el impacto se reduce. Siempre se imprimirá el presupuesto.'},
    {id:45,bloque:'PIA',criterio:'Explicar y entregar la gafa graduada y el servicio Afflelou Contigo como regalo al realizar la compra de audífonos.',valor:3,tipo:'binario',detalle:'Explicar al paciente que, con la compra de audífonos, obtiene de regalo una gafa graduada. Detallar las condiciones y opciones disponibles. Coordinar con el equipo de óptica para la elección de la gafa. Además, tendrá de regalo un servicio Premium «Afflelou Contigo» (puede ser para el cliente o un familiar).'},
    {id:46,bloque:'PIA',criterio:'Ofrecer el seguro Caser de forma proactiva.',valor:2,tipo:'binario',detalle:'Ofrecer y explicar el seguro Caser para los audífonos: cobertura de robo, pérdida, rotura accidental y avería. Detallar las condiciones, prima y proceso de reclamación.'},
    {id:47,bloque:'PIA',criterio:'Detallar los compromisos Audio.',valor:3,tipo:'binario',detalle:'Explicar y detallar todos los Compromisos Afflelou: Tchin Tchin, garantía de 4 años, le atendemos en todo el territorio nacional, seguimiento pautado para siempre, avisos de citas, revisiones periódicas del estado de sus audífonos, ajustes de programación, mantenimiento y limpieza, asesoramiento de novedades, audífono de sustitución si ocurre alguna avería, servicio de ajuste a distancia, gafa graduada de regalo, financiación flexible, posibilidad de asegurar sus audífonos. Asegurarse de que el paciente comprende todos los beneficios incluidos.',obligatoria:true},
    {id:48,bloque:'PIA',criterio:'Recomendar igualar la gama del 2.º par indicándolo en cuotas y accesorios de conectividad.',valor:2,tipo:'binario',detalle:'Recomendar igualar la gama del 2.º par indicándolo en cuotas y accesorios de conectividad.'},
    {id:49,bloque:'PIA',criterio:'Entregar el kit de higiene y enseñar al cliente a utilizar los productos de limpieza.',valor:2,tipo:'binario',detalle:'En el cierre se entrega un kit de limpieza de regalo y se explica la importancia de limpiar y mantener bien los audífonos. Una vez terminados los productos del neceser que regalamos, debe comprarlos para mantener la vida útil de los audífonos adecuadamente. El kit se introduce en la ficha del cliente bonificado a 0.'},
    {id:50,bloque:'PIA',criterio:'Indicar que realizaremos llamada y ajuste en remoto cómodamente a los 3 y 6 meses. Si no es aceptado, se agendará cita presencial.',valor:2,tipo:'binario',detalle:'Durante los días previos al cierre, y cuando detallamos los compromisos y servicios, mencionaremos el ajuste en remoto. Explicaremos las ventajas, lo fácil que es, y le activaremos el móvil y los audífonos para que estén preparados. Se activa el servicio siempre por precaución. Si acepta, dejamos la cita agendada con la modalidad de remoto.'},
    {id:51,bloque:'PIA',criterio:'Conocer y aplicar que, según PIA 3.0, se realiza una revisión de audífonos en el mes 34, dejando los audífonos y prestando unos nuevos de última tecnología.',valor:3,tipo:'binario',detalle:'Conocer y aplicar que, según PIA 3.0, se realiza una revisión de audífonos en el mes 34, dejando los audífonos y prestando unos nuevos de última tecnología.'},
    {id:52,bloque:'PIA',criterio:'Realizar llamadas recordatorio un día antes de cada visita y a las citas no asistidas.',valor:2,tipo:'binario',detalle:'Realizar llamada de recordatorio el día antes de cada visita programada para confirmar asistencia y reducir la tasa de no asistencia. Registrar la confirmación en el sistema.'},
    {id:53,bloque:'PIA',criterio:'Adecuar el discurso de las llamadas en función del motivo por el que vayamos a realizarla.',valor:2,tipo:'binario',detalle:'Según el tipo de llamada (recordatorio, seguimiento, control, etc.), adaptar el discurso y los argumentos. Preparar previamente el guion adecuado para cada tipo de contacto.'},
    {id:54,bloque:'PIA',criterio:'Realizar las llamadas de control a pacientes: presupuestos, pérdida-no prueba, pilas-HIT, tapones y screenings. Registrar en el funnel y agendar (si es reciente apertura, debe controlar el procedimiento).',valor:3,tipo:'binario',detalle:'Realizar llamadas de control segmentadas: pacientes con presupuesto de 6 meses, pacientes con pérdida que no hicieron prueba, pacientes de pilas-HIT y pacientes de tapones. Registrar cada contacto en el funnel y agendar citas cuando corresponda. Si es apertura reciente, debe controlar el procedimiento.'},
    {id:55,bloque:'PIA',criterio:'Formar a los compañeros de óptica en "Primeros auxilios" (cambios de tulipas, filtros, auriculares, novedades, formatos etc.).',valor:3,tipo:'binario',detalle:'El audiólogo debe sacar tiempo para formar a sus compañeros en funciones básicas, como cambio de filtros, tulipas, auriculares, y hablarles de novedades relevantes de Incógnito para favorecer sinergias.'},
    {id:56,bloque:'PIA',criterio:'Fomentar MGM (cliente satisfecho genera nuevo cliente).',valor:2,tipo:'binario',detalle:'Fomentar el programa MGM (Member Get Member): programa de recomendación de clientes. Explicar los beneficios tanto para el cliente que recomienda como para el nuevo cliente. Entregar material promocional y hacer seguimiento de las recomendaciones.'},
    {id:57,bloque:'PIA',criterio:'Fomentar RENOVE (3 y 4 años desde la última compra o usuario de la competencia).',valor:2,tipo:'binario',detalle:'Fomentar RENOVE (3 y 4 años desde la última compra o usuario de la competencia).'},
    {id:58,bloque:'FORMACION',criterio:'Onboarding realizado en Afflelou Academy.',valor:3,tipo:'binario',detalle:'Realizar y superar el programa de onboarding en Academy. Este programa incluye todos los conocimientos básicos necesarios para comenzar a trabajar en el centro de audio.',obligatoria:true},
    {id:59,bloque:'FORMACION',criterio:'Portafolio de WSA y Starkey.',valor:3,tipo:'binario',detalle:'Portafolio de WSA y Starkey.',obligatoria:true},
    {id:60,bloque:'FORMACION',criterio:'Realizar curso PIA última versión.',valor:3,tipo:'binario',detalle:'Realizar y superar la formación de PIA (Protocolo Integral de Atención) en su última versión. Mantenerse actualizado con cada nueva versión del protocolo.',obligatoria:true},
    {id:61,bloque:'FORMACION',criterio:'Realizar y estar al día en las formaciones de las campañas vigentes.',valor:3,tipo:'binario',detalle:'Completar las formaciones relacionadas con las campañas comerciales vigentes. Conocer los detalles, condiciones y argumentarios de cada campaña activa.'},
    {id:62,bloque:'FORMACION',criterio:'Formación de "Primeros auxilios de audio" para el equipo de óptica.',valor:3,tipo:'binario',detalle:'Formación de "Primeros auxilios de audio" para el equipo de óptica.'},
    {id:63,bloque:'FORMACION',criterio:'Formación HIT',valor:3,tipo:'binario',detalle:'Formación HIT'},
    {id:64,bloque:'FORMACION',criterio:'Formación en Telecare y Telehere para ofrecer Ajuste remoto. Deben estar activados todos los audífonos.',valor:3,tipo:'binario',detalle:'Las formaciones en ajustes en remoto con WSA y Starkey proporcionarán una mejor experiencia para el cliente y sus familiares. Es diferenciador y un servicio que ofrece total tranquilidad, donde el paciente podría ser atendido siempre aunque no se encuentre en el gabinete (imprescindible internet). Todos los audífonos deben tener el servicio activado.'},
    {id:65,bloque:'FORMACION',criterio:'Formación de neuroventas y objeciones / habilidades comerciales.',valor:3,tipo:'binario',detalle:'Realizar y superar la formación de neuroventas, manejo de objeciones y habilidades comerciales. Aplicar las técnicas aprendidas en cada interacción con el paciente.'},
    {id:66,bloque:'COMUNICACION',criterio:'Imagen adecuada en el punto de venta y escaparate. Generar visibilidad del servicio de audio y del nuevo producto.',valor:3,tipo:'binario',detalle:'El centro debe tener imágenes y elementos de Audio que comuniquen el servicio, promociones y política comercial. Los elementos no son para el gabinete solamente, sino que deben ser visibles en todo el centro.'},
    {id:67,bloque:'COMUNICACION',criterio:'Disponer de los elementos de audio, como: manteletas, test de lectura, folletos de salud auditiva, seguros, Infinity, MGM, etc.',valor:3,tipo:'binario',detalle:'Disponer de los elementos de audio, como: manteletas, test de lectura, folletos de salud auditiva, seguros, Infinity, MGM, etc.'},
    {id:68,bloque:'COMUNICACION',criterio:'Comunicar el servicio de audiología a vecinos, alrededores, colegios, entidades, asociaciones, etc.',valor:2,tipo:'binario',detalle:'Comunicar el servicio de audiología a vecinos, alrededores, colegios, entidades, asociaciones, etc.'},
    {id:69,bloque:'AYUDAS',criterio:'Conocer el procedimiento y cuáles son las ayudas que existen tanto a nivel nacional como de tu comunidad autónoma.',valor:3,tipo:'binario',detalle:'El audiólogo debe conocer las ayudas de su comunidad autónoma y nacionales referentes a la adquisición de audífonos. Debe tener a mano la información sobre dónde y cómo realizar el procedimiento para poder dar información básica a los pacientes.'},
    {id:70,bloque:'AYUDAS',criterio:'Centro adscrito para el reconocimiento de ayudas-pago.',valor:2,tipo:'binario',detalle:'El centro debe estar adscrito para el reconocimiento de ayudas y gestión de pagos por subvenciones. Mantener la documentación actualizada y conocer el proceso administrativo.'},
    {id:71,bloque:'COMPLEMENTARIAS',criterio:'Servicio pediátrico.',valor:1,tipo:'binario',detalle:'Recomendado formarse y aplicar conocimientos de audiología pediátrica. Conocer las particularidades de la atención a niños, técnicas de evaluación adaptadas y productos específicos.'},
    {id:72,bloque:'COMPLEMENTARIAS',criterio:'Centro AAR Certificado / Formación avanzada',valor:1,tipo:'binario',detalle:'Centro AAR Certificado / Formación avanzada'},
    {id:73,bloque:'COMPLEMENTARIAS',criterio:'Presencia en mentoring de refuerzo.',valor:1,tipo:'binario',detalle:'Recomendado asistir a las sesiones de mentoring de refuerzo y actualización para mantenerse al día con las mejores prácticas y resolver dudas.'},
    {id:74,bloque:'COMPLEMENTARIAS',criterio:'Conocimiento y aplicación de TRT.',valor:1,tipo:'binario',detalle:'Recomendado formarse y aplicar TRT (Terapia de Reentrenamiento del Tinnitus). Conocer el protocolo, técnicas de consejo y seguimiento de pacientes con acúfenos.'},
    {id:75,bloque:'COMPLEMENTARIAS',criterio:'Conocimiento y aplicación de REM.',valor:1,tipo:'binario',detalle:'Recomendado formarse y aplicar REM (Real Ear Measurement). Conocer el equipo, técnica de medición, interpretación de resultados y ajustes basados en REM.'},
    {id:76,bloque:'COMPLEMENTARIAS',criterio:'Estar al día en el conocimiento de los objetivos e incentivos vigentes del momento.',valor:2,tipo:'binario',detalle:'Conocer los objetivos y los incentivos en cada momento suponen un motor motivador para la consecución de objetivos. Es imprescindible que el equipo tenga conocimiento de los mismos en cada momento para saber la situación de su gabinete y pasos a seguir en consecuencia.'},
    {id:77,bloque:'COMPLEMENTARIAS',criterio:'Conocer los convenios FIAPAS y ONCE.',valor:1,tipo:'binario',detalle:'Conocer los convenios FIAPAS-ONCE y cómo aplicarlos para los pacientes. Conocer requisitos, documentación y proceso de gestión de estos convenios especiales.'},
    {id:78,bloque:'RT',criterio:'Conocer el portfolio Incógnito.',valor:1,tipo:'binario',detalle:'El responsable debe conocer el portafolio completo de proveedores de audífonos y accesorios: gamas, modelos, características técnicas, precios y condiciones comerciales de cada uno.'},
    {id:79,bloque:'RT',criterio:'Conocer las políticas comerciales de los proveedores homologados.',valor:1,tipo:'binario',detalle:'Conocer las políticas comerciales de cada proveedor: plazos de entrega, condiciones de devolución, garantías, rappels, promociones vigentes y condiciones especiales.'},
    {id:80,bloque:'RT',criterio:'Conocer y hacer seguimiento del Funnel.',valor:1,tipo:'binario',detalle:'Conocer y hacer seguimiento del funnel de ventas: etapas, métricas clave, tasas de conversión entre etapas. Analizar regularmente para identificar oportunidades de mejora.'},
    {id:81,bloque:'RT',criterio:'Conocer y hacer seguimiento de las llamadas que se realizan en audio.',valor:2,tipo:'binario',detalle:'Conocer y hacer seguimiento de las llamadas realizadas: volumen, tipos, resultados, citas conseguidas. Analizar la efectividad y optimizar los guiones de llamada.'},
    {id:82,bloque:'RT',criterio:'Control de stock adecuado.',valor:2,tipo:'binario',detalle:'Realizar control periódico del stock de audífonos y accesorios. Verificar disponibilidad, fechas de caducidad de pilas, estado de los productos y necesidades de reposición.'},
    {id:83,bloque:'RT',criterio:'Formación básica de audio del RT - Equipo de óptica',valor:3,tipo:'binario',detalle:'Formación básica de audio del RT - Equipo de óptica'},
    {id:84,bloque:'RT',criterio:'Controlar y fomentar que el equipo de óptica ofrezca servicios mínimos de audio que favorezcan las sinergias óptica-audio.',valor:3,tipo:'binario',detalle:'Controlar y fomentar que el equipo de óptica ofrezca servicios mínimos de audio que favorezcan las sinergias óptica-audio.'},
    {id:85,bloque:'RT',criterio:'Control de la agenda de audio.',valor:3,tipo:'binario',detalle:'Realizar control periódico de la agenda de audio: ocupación, distribución de citas (primeras visitas vs. revisiones), huecos disponibles y optimización del tiempo.'},
    {id:86,bloque:'RT',criterio:'Cumplir con los básicos de screening establecidos y proporcionar listado para seguimiento de posibles hipoacusias. El registro de screening en Gio valida esta acción.',valor:3,tipo:'binario',detalle:'El RT, como responsable, debe controlar la realización de screenings y mantener seguimiento sobre ellos. Deben quedar registrados en GIO para comprobación y validación. Las tablets deben estar preparadas y el equipo debe saber el funcionamiento de la app.'},
    {id:87,bloque:'RT',criterio:'Verificación entrega tarjeta revisión auditiva / otros elementos en encargo óptica.',valor:3,tipo:'binario',detalle:'Verificar que se entrega la tarjeta de revisión auditiva gratuita con cada encargo de óptica. Coordinar con el equipo de óptica para asegurar esta entrega sistemática y hacer seguimiento de las tarjetas utilizadas.'},
    {id:88,bloque:'RT',criterio:'Velar por que se produzcan derivaciones óptica-audio bidireccionalmente. Indique el nº de derivaciones óptica-audio las últimas 8 semanas',valor:3,tipo:'numerico',detalle:'Las derivaciones de Óptica-Audio son fundamentales para la actividad. Será labor del RT fomentar y controlar que se produzcan derivaciones bidireccionales, manteniendo control de ellas mensualmente y motivando al equipo para mantenerlas.'},
    {id:89,bloque:'RT',criterio:'Controla que los encargos tchin tchin están correctamente introducidos en Gio',valor:3,tipo:'binario',detalle:'Verificar que todos los encargos de la promoción Tchin Tchin estén correctamente registrados en el sistema GIO.'},
    {id:90,bloque:'AGENDA',criterio:'Indique el nº de Primeras Visitas y el nº de Revisiones postventa de las últimas 4 semanas',valor:0,tipo:'agenda_dual',detalle:'Introduzca en las dos casillas: el número de primeras visitas y el número de revisiones postventa de las últimas 4 semanas. Estos datos se usarán para calcular la proporción de agenda.'},
    {id:91,bloque:'AGENDA',criterio:'Agenda inteligente. Con los datos anteriores, este es el % de Primeras citas & Revisiones. Si es correcto, confírmalo.',valor:3,tipo:'agenda_confirm',detalle:'Se calcula automáticamente con los datos de la pregunta anterior. Las primeras visitas deben ocupar el 75% frente al 25% de revisiones. Si este criterio de proporción se cumple, la gestión de la agenda es muy buena.'},
    {id:92,bloque:'AGENDA',criterio:'Indique el número de citas no asistidas las últimas 4 semanas',valor:0,tipo:'numerico',detalle:'Se debe tener control de las citas no asistidas. Todas deben ser reagendadas o entrar en circuito de funnel de seguimiento si no pueden asistir. Es obligatorio adelantarse y llamar el día antes de la cita.'},
    {id:93,bloque:'AGENDA',criterio:'Indique el número de citas no asistidas las últimas 4 semanas que han sido reagendadas o pasadas al funnel de seguimiento',valor:3,tipo:'numerico',detalle:'Se debe tener control de las citas no asistidas. Todas deben ser reagendadas o entrar en circuito de funnel de seguimiento si no pueden asistir. Es obligatorio adelantarse y llamar el día antes de la cita.'},
    {id:94,bloque:'CONVERSIONES',criterio:'N.º de ventas con ayudas en los últimos 3 meses',valor:0,tipo:'numerico',detalle:'N.º de ventas con ayudas en los últimos 3 meses'},
    {id:95,bloque:'CONVERSIONES',criterio:'N.º de ventas Member Get Member en los últimos 3 meses',valor:0,tipo:'numerico',detalle:'N.º de ventas Member Get Member en los últimos 3 meses'},
    {id:96,bloque:'CONVERSIONES',criterio:'N.º de ventas Renove en los últimos 3 meses',valor:0,tipo:'numerico',detalle:'N.º de ventas Renove en los últimos 3 meses'},
    {id:97,bloque:'CONVERSIONES',criterio:'N.º de ventas de seguros',valor:0,tipo:'numerico',detalle:'N.º de ventas de seguros'},
    {id:98,bloque:'CONVERSIONES',criterio:'% de screenings vs. optometrías según GIO (ideal 80 %)',valor:0,tipo:'numerico',detalle:'% de screenings vs. optometrías según GIO (ideal 80 %)'},
    {id:99,bloque:'CONVERSIONES',criterio:'% de conversión a prueba (ideal 80 %)',valor:0,tipo:'numerico',detalle:'% de conversión a prueba (ideal 80 %)'},
    {id:100,bloque:'CONVERSIONES',criterio:'% de conversión a venta (ideal 80 %)',valor:0,tipo:'numerico',detalle:'% de conversión a venta (ideal 80 %)'}
];

// Cifras de Venta Audio - Ago 25 / Jul 26 (217 centros)
var cifrasVentaAudio = {"4ABB":{"acumulado":57808.91,"previsto":35244,"diferencia":22564.91,"pctCumplimiento":164},"4ABC":{"acumulado":18448.57,"previsto":19178,"diferencia":-729.43,"pctCumplimiento":96.2},"4ABI":{"acumulado":29764.55,"previsto":30111,"diferencia":-346.45,"pctCumplimiento":98.8},"4ABW":{"acumulado":27292.42,"previsto":35126,"diferencia":-7833.58,"pctCumplimiento":77.7},"4ADC":{"acumulado":44425.19,"previsto":30111,"diferencia":14314.19,"pctCumplimiento":147.5},"4ADX":{"acumulado":19296.79,"previsto":18277,"diferencia":1019.79,"pctCumplimiento":105.6},"4AEQ":{"acumulado":4362.72,"previsto":5000,"diferencia":-637.28,"pctCumplimiento":87.3},"4AES":{"acumulado":34446.63,"previsto":30194,"diferencia":4252.63,"pctCumplimiento":114.1},"4AFH":{"acumulado":20539.16,"previsto":43758,"diferencia":-23218.84,"pctCumplimiento":46.9},"4AFI":{"acumulado":24995.63,"previsto":13635,"diferencia":11360.63,"pctCumplimiento":183.3},"4AGK":{"acumulado":30608.97,"previsto":34350,"diferencia":-3741.03,"pctCumplimiento":89.1},"4AHE":{"acumulado":39940.29,"previsto":30111,"diferencia":9829.29,"pctCumplimiento":132.6},"4AHR":{"acumulado":23409.45,"previsto":24145,"diferencia":-735.55,"pctCumplimiento":97},"4AHU":{"acumulado":39206.09,"previsto":41024,"diferencia":-1817.91,"pctCumplimiento":95.6},"4AHY":{"acumulado":0,"previsto":15004,"diferencia":-15004,"pctCumplimiento":0},"4AIE":{"acumulado":49884.24,"previsto":31253,"diferencia":18631.24,"pctCumplimiento":159.6},"4AIR":{"acumulado":44833.92,"previsto":34172,"diferencia":10661.92,"pctCumplimiento":131.2},"4AJQ":{"acumulado":26516.64,"previsto":38295,"diferencia":-11778.36,"pctCumplimiento":69.2},"4AJR":{"acumulado":43306.02,"previsto":46385,"diferencia":-3078.98,"pctCumplimiento":93.4},"4AKI":{"acumulado":131245.74,"previsto":146348,"diferencia":-15102.26,"pctCumplimiento":89.7},"4AKU":{"acumulado":10744.52,"previsto":10003,"diferencia":741.52,"pctCumplimiento":107.4},"4ALY":{"acumulado":44119.96,"previsto":45235,"diferencia":-1115.04,"pctCumplimiento":97.5},"4AMD":{"acumulado":30713.51,"previsto":47099,"diferencia":-16385.49,"pctCumplimiento":65.2},"4AMU":{"acumulado":26122.91,"previsto":27280,"diferencia":-1157.09,"pctCumplimiento":95.8},"4AMY":{"acumulado":68122.35,"previsto":67707,"diferencia":415.35,"pctCumplimiento":100.6},"4AMZ":{"acumulado":42763.25,"previsto":83331,"diferencia":-40567.75,"pctCumplimiento":51.3},"4ANB":{"acumulado":42164.08,"previsto":17471,"diferencia":24693.08,"pctCumplimiento":241.3},"4ANI":{"acumulado":12102.96,"previsto":15183,"diferencia":-3080.04,"pctCumplimiento":79.7},"4ANJ":{"acumulado":34294.25,"previsto":14358,"diferencia":19936.25,"pctCumplimiento":238.9},"4ANU":{"acumulado":23415.83,"previsto":15851,"diferencia":7564.83,"pctCumplimiento":147.7},"4ANV":{"acumulado":51191.63,"previsto":82923,"diferencia":-31731.37,"pctCumplimiento":61.7},"4AOC":{"acumulado":23796.03,"previsto":30111,"diferencia":-6314.97,"pctCumplimiento":79},"4AOD":{"acumulado":48716.56,"previsto":45322,"diferencia":3394.56,"pctCumplimiento":107.5},"4AOU":{"acumulado":29072.82,"previsto":30111,"diferencia":-1038.18,"pctCumplimiento":96.6},"4APE":{"acumulado":7234.58,"previsto":8702,"diferencia":-1467.42,"pctCumplimiento":83.1},"4APH":{"acumulado":44664.6,"previsto":42118,"diferencia":2546.6,"pctCumplimiento":106},"4APL":{"acumulado":23098.55,"previsto":30111,"diferencia":-7012.45,"pctCumplimiento":76.7},"4APP":{"acumulado":33303.17,"previsto":42452,"diferencia":-9148.83,"pctCumplimiento":78.4},"4APQ":{"acumulado":41979.22,"previsto":55264,"diferencia":-13284.78,"pctCumplimiento":76},"4AQD":{"acumulado":34118.3,"previsto":25085,"diferencia":9033.3,"pctCumplimiento":136},"4AQI":{"acumulado":13510.01,"previsto":28283,"diferencia":-14772.99,"pctCumplimiento":47.8},"4AQJ":{"acumulado":28887.33,"previsto":28592,"diferencia":295.33,"pctCumplimiento":101},"4AQL":{"acumulado":16994.01,"previsto":29619,"diferencia":-12624.99,"pctCumplimiento":57.4},"4AQN":{"acumulado":29603.92,"previsto":30111,"diferencia":-507.08,"pctCumplimiento":98.3},"4AQQ":{"acumulado":6594.64,"previsto":12011,"diferencia":-5416.36,"pctCumplimiento":54.9},"4AQT":{"acumulado":87211.6,"previsto":57764,"diferencia":29447.6,"pctCumplimiento":151},"4AQU":{"acumulado":56235.1,"previsto":45528,"diferencia":10707.1,"pctCumplimiento":123.5},"4AQV":{"acumulado":38675.82,"previsto":37605,"diferencia":1070.82,"pctCumplimiento":102.8},"4AQZ":{"acumulado":46195.9,"previsto":33548,"diferencia":12647.9,"pctCumplimiento":137.7},"4ARA":{"acumulado":38298.74,"previsto":33068,"diferencia":5230.74,"pctCumplimiento":115.8},"4ARC":{"acumulado":41262.75,"previsto":46998,"diferencia":-5735.25,"pctCumplimiento":87.8},"4ARM":{"acumulado":47135.3,"previsto":64330,"diferencia":-17194.7,"pctCumplimiento":73.3},"4ARN":{"acumulado":57966.93,"previsto":51876,"diferencia":6090.93,"pctCumplimiento":111.7},"4ARQ":{"acumulado":39132.98,"previsto":12538,"diferencia":26594.98,"pctCumplimiento":312.1},"4ARZ":{"acumulado":40290.04,"previsto":52137,"diferencia":-11846.96,"pctCumplimiento":77.3},"4ASA":{"acumulado":37952.99,"previsto":23006,"diferencia":14946.99,"pctCumplimiento":165},"4ASQ":{"acumulado":42683.69,"previsto":42714,"diferencia":-30.31,"pctCumplimiento":99.9},"4ASS":{"acumulado":34091.4,"previsto":26953,"diferencia":7138.4,"pctCumplimiento":126.5},"4ATC":{"acumulado":57299.3,"previsto":38512,"diferencia":18787.3,"pctCumplimiento":148.8},"4ATE":{"acumulado":26993.43,"previsto":56524,"diferencia":-29530.57,"pctCumplimiento":47.8},"4ATF":{"acumulado":22020.71,"previsto":31828,"diferencia":-9807.29,"pctCumplimiento":69.2},"4ATL":{"acumulado":15415.74,"previsto":23751,"diferencia":-8335.26,"pctCumplimiento":64.9},"4ATP":{"acumulado":4714.54,"previsto":11671,"diferencia":-6956.46,"pctCumplimiento":40.4},"4ATQ":{"acumulado":25134.03,"previsto":23057,"diferencia":2077.03,"pctCumplimiento":109},"4ATU":{"acumulado":20079.65,"previsto":25085,"diferencia":-5005.35,"pctCumplimiento":80},"4ATV":{"acumulado":33481.22,"previsto":30111,"diferencia":3370.22,"pctCumplimiento":111.2},"4AUB":{"acumulado":23631.83,"previsto":58802,"diferencia":-35170.17,"pctCumplimiento":40.2},"4AUC":{"acumulado":74450.19,"previsto":83586,"diferencia":-9135.81,"pctCumplimiento":89.1},"4AUJ":{"acumulado":24309.85,"previsto":28363,"diferencia":-4053.15,"pctCumplimiento":85.7},"4AUO":{"acumulado":16368.25,"previsto":20847,"diferencia":-4478.75,"pctCumplimiento":78.5},"4AUV":{"acumulado":98029.08,"previsto":85605,"diferencia":12424.08,"pctCumplimiento":114.5},"4AUX":{"acumulado":20825.77,"previsto":25085,"diferencia":-4259.23,"pctCumplimiento":83},"4AVA":{"acumulado":46042.4,"previsto":56633,"diferencia":-10590.6,"pctCumplimiento":81.3},"4AVC":{"acumulado":38439.28,"previsto":52591,"diferencia":-14151.72,"pctCumplimiento":73.1},"4AVE":{"acumulado":23231.66,"previsto":37506,"diferencia":-14274.34,"pctCumplimiento":61.9},"4AVF":{"acumulado":55436.12,"previsto":58956,"diferencia":-3519.88,"pctCumplimiento":94},"4AVH":{"acumulado":28224.63,"previsto":15186,"diferencia":13038.63,"pctCumplimiento":185.9},"4AVN":{"acumulado":12546.03,"previsto":15544,"diferencia":-2997.97,"pctCumplimiento":80.7},"4AVP":{"acumulado":32246.94,"previsto":25439,"diferencia":6807.94,"pctCumplimiento":126.8},"4AVS":{"acumulado":27202.21,"previsto":35757,"diferencia":-8554.79,"pctCumplimiento":76.1},"4AVU":{"acumulado":40437.12,"previsto":24239,"diferencia":16198.12,"pctCumplimiento":166.8},"4AVV":{"acumulado":29074.42,"previsto":34430,"diferencia":-5355.58,"pctCumplimiento":84.4},"4AVZ":{"acumulado":18212.73,"previsto":34404,"diferencia":-16191.27,"pctCumplimiento":52.9},"4AWB":{"acumulado":24833.54,"previsto":11700,"diferencia":13133.54,"pctCumplimiento":212.3},"4AWF":{"acumulado":33013.84,"previsto":30111,"diferencia":2902.84,"pctCumplimiento":109.6},"4AWG":{"acumulado":16115.16,"previsto":22506,"diferencia":-6390.84,"pctCumplimiento":71.6},"4AWI":{"acumulado":17673.31,"previsto":23306,"diferencia":-5632.69,"pctCumplimiento":75.8},"4AWJ":{"acumulado":27010.47,"previsto":30111,"diferencia":-3100.53,"pctCumplimiento":89.7},"4AWL":{"acumulado":25484.64,"previsto":21074,"diferencia":4410.64,"pctCumplimiento":120.9},"4AWM":{"acumulado":19539.08,"previsto":28067,"diferencia":-8527.92,"pctCumplimiento":69.6},"4AWO":{"acumulado":10095.41,"previsto":12177,"diferencia":-2081.59,"pctCumplimiento":82.9},"4AWQ":{"acumulado":22983.8,"previsto":29643,"diferencia":-6659.2,"pctCumplimiento":77.5},"4AWS":{"acumulado":105787.32,"previsto":97210,"diferencia":8577.32,"pctCumplimiento":108.8},"4AWU":{"acumulado":21166.33,"previsto":30111,"diferencia":-8944.67,"pctCumplimiento":70.3},"4AWV":{"acumulado":19370.84,"previsto":35513,"diferencia":-16142.16,"pctCumplimiento":54.5},"4AXB":{"acumulado":30903.25,"previsto":20171,"diferencia":10732.25,"pctCumplimiento":153.2},"4AXC":{"acumulado":23864.25,"previsto":30111,"diferencia":-6246.75,"pctCumplimiento":79.3},"4AXD":{"acumulado":29336.44,"previsto":40951,"diferencia":-11614.56,"pctCumplimiento":71.6},"4AXF":{"acumulado":67208.36,"previsto":104114,"diferencia":-36905.64,"pctCumplimiento":64.6},"4AXH":{"acumulado":10301.18,"previsto":25551,"diferencia":-15249.82,"pctCumplimiento":40.3},"4AXL":{"acumulado":94024.34,"previsto":85724,"diferencia":8300.34,"pctCumplimiento":109.7},"4AXM":{"acumulado":21120.94,"previsto":18508,"diferencia":2612.94,"pctCumplimiento":114.1},"4AXN":{"acumulado":20959.37,"previsto":24616,"diferencia":-3656.63,"pctCumplimiento":85.1},"4AXO":{"acumulado":23365.81,"previsto":36624,"diferencia":-13258.19,"pctCumplimiento":63.8},"4AXP":{"acumulado":10557.62,"previsto":14966,"diferencia":-4408.38,"pctCumplimiento":70.5},"4AXR":{"acumulado":23149.3,"previsto":25640,"diferencia":-2490.7,"pctCumplimiento":90.3},"4AXS":{"acumulado":121770.78,"previsto":106863,"diferencia":14907.78,"pctCumplimiento":114},"4AXU":{"acumulado":18859.18,"previsto":37698,"diferencia":-18838.82,"pctCumplimiento":50},"4AXV":{"acumulado":62044.97,"previsto":67232,"diferencia":-5187.03,"pctCumplimiento":92.3},"4AXX":{"acumulado":1635.33,"previsto":9195,"diferencia":-7559.67,"pctCumplimiento":17.8},"4AXY":{"acumulado":40470.41,"previsto":26160,"diferencia":14310.41,"pctCumplimiento":154.7},"4AXZ":{"acumulado":7056.37,"previsto":28437,"diferencia":-21380.63,"pctCumplimiento":24.8},"4AYA":{"acumulado":8341.38,"previsto":16799,"diferencia":-8457.62,"pctCumplimiento":49.7},"4AYB":{"acumulado":70851.98,"previsto":30316,"diferencia":40535.98,"pctCumplimiento":233.7},"4AYD":{"acumulado":29181.96,"previsto":30868,"diferencia":-1686.04,"pctCumplimiento":94.5},"4AYF":{"acumulado":18597.74,"previsto":18777,"diferencia":-179.26,"pctCumplimiento":99},"4AYG":{"acumulado":31368.34,"previsto":32188,"diferencia":-819.66,"pctCumplimiento":97.5},"4AYH":{"acumulado":35086.65,"previsto":37303,"diferencia":-2216.35,"pctCumplimiento":94.1},"4AYI":{"acumulado":27740.46,"previsto":41290,"diferencia":-13549.54,"pctCumplimiento":67.2},"4AYK":{"acumulado":22133.73,"previsto":23600,"diferencia":-1466.27,"pctCumplimiento":93.8},"4AYL":{"acumulado":41282.59,"previsto":30111,"diferencia":11171.59,"pctCumplimiento":137.1},"4AYN":{"acumulado":17829.09,"previsto":30111,"diferencia":-12281.91,"pctCumplimiento":59.2},"4AYO":{"acumulado":10437.71,"previsto":25085,"diferencia":-14647.29,"pctCumplimiento":41.6},"4AYP":{"acumulado":23370.99,"previsto":37632,"diferencia":-14261.01,"pctCumplimiento":62.1},"4AYQ":{"acumulado":13210,"previsto":35126,"diferencia":-21916,"pctCumplimiento":37.6},"4AYT":{"acumulado":35960.26,"previsto":30111,"diferencia":5849.26,"pctCumplimiento":119.4},"4AYU":{"acumulado":42606.13,"previsto":30111,"diferencia":12495.13,"pctCumplimiento":141.5},"4AYV":{"acumulado":27322.5,"previsto":18965,"diferencia":8357.5,"pctCumplimiento":144.1},"4AYX":{"acumulado":30665.86,"previsto":25071,"diferencia":5594.86,"pctCumplimiento":122.3},"4AYZ":{"acumulado":54882.03,"previsto":34099,"diferencia":20783.03,"pctCumplimiento":160.9},"4AZA":{"acumulado":35934.32,"previsto":30313,"diferencia":5621.32,"pctCumplimiento":118.5},"4AZB":{"acumulado":53728.77,"previsto":30111,"diferencia":23617.77,"pctCumplimiento":178.4},"4AZC":{"acumulado":11928.84,"previsto":35125,"diferencia":-23196.16,"pctCumplimiento":34},"4AZD":{"acumulado":21878.57,"previsto":35125,"diferencia":-13246.43,"pctCumplimiento":62.3},"4AZE":{"acumulado":26498.02,"previsto":29166,"diferencia":-2667.98,"pctCumplimiento":90.9},"4AZG":{"acumulado":24810.25,"previsto":15004,"diferencia":9806.25,"pctCumplimiento":165.4},"4AZH":{"acumulado":28344.7,"previsto":35126,"diferencia":-6781.3,"pctCumplimiento":80.7},"4AZI":{"acumulado":39222.36,"previsto":31828,"diferencia":7394.36,"pctCumplimiento":123.2},"4AZL":{"acumulado":1830.23,"previsto":5834,"diferencia":-4003.77,"pctCumplimiento":31.4},"4AZM":{"acumulado":3251.43,"previsto":31828,"diferencia":-28576.57,"pctCumplimiento":10.2},"4AZN":{"acumulado":36697.27,"previsto":33311,"diferencia":3386.27,"pctCumplimiento":110.2},"4AZP":{"acumulado":28636.52,"previsto":30919,"diferencia":-2282.48,"pctCumplimiento":92.6},"4AZQ":{"acumulado":13811.73,"previsto":37647,"diferencia":-23835.27,"pctCumplimiento":36.7},"4AZS":{"acumulado":9118.34,"previsto":22755,"diferencia":-13636.66,"pctCumplimiento":40.1},"4AZT":{"acumulado":56564.43,"previsto":75003,"diferencia":-18438.57,"pctCumplimiento":75.4},"4BAN":{"acumulado":28904.86,"previsto":12243,"diferencia":16661.86,"pctCumplimiento":236.1},"4BCJ":{"acumulado":26865.21,"previsto":35322,"diferencia":-8456.79,"pctCumplimiento":76.1},"4BDM":{"acumulado":39574.99,"previsto":27752,"diferencia":11822.99,"pctCumplimiento":142.6},"4BIL":{"acumulado":18282.7,"previsto":18541,"diferencia":-258.3,"pctCumplimiento":98.6},"4BMA":{"acumulado":73643.46,"previsto":57850,"diferencia":15793.46,"pctCumplimiento":127.3},"4BMT":{"acumulado":2961.28,"previsto":20303,"diferencia":-17341.72,"pctCumplimiento":14.6},"4BON":{"acumulado":48708.19,"previsto":29528,"diferencia":19180.19,"pctCumplimiento":165},"4BVI":{"acumulado":33220.29,"previsto":27466,"diferencia":5754.29,"pctCumplimiento":121},"4CAM":{"acumulado":59316.02,"previsto":29314,"diferencia":30002.02,"pctCumplimiento":202.3},"4CCA":{"acumulado":33348.94,"previsto":24743,"diferencia":8605.94,"pctCumplimiento":134.8},"4CCC":{"acumulado":36681.35,"previsto":29693,"diferencia":6988.35,"pctCumplimiento":123.5},"4CLL":{"acumulado":17349.73,"previsto":5274,"diferencia":12075.73,"pctCumplimiento":329},"4CPL":{"acumulado":12471.86,"previsto":20296,"diferencia":-7824.14,"pctCumplimiento":61.4},"4CUC":{"acumulado":12862.85,"previsto":34656,"diferencia":-21793.15,"pctCumplimiento":37.1},"4DIA":{"acumulado":35370.69,"previsto":35496,"diferencia":-125.31,"pctCumplimiento":99.6},"4EAL":{"acumulado":40440.09,"previsto":38435,"diferencia":2005.09,"pctCumplimiento":105.2},"4EPA":{"acumulado":36635.15,"previsto":46482,"diferencia":-9846.85,"pctCumplimiento":78.8},"4FIG":{"acumulado":39414.21,"previsto":32817,"diferencia":6597.21,"pctCumplimiento":120.1},"4GIR":{"acumulado":26226.03,"previsto":37389,"diferencia":-11162.97,"pctCumplimiento":70.1},"4GMA":{"acumulado":24104.51,"previsto":36053,"diferencia":-11948.49,"pctCumplimiento":66.9},"4GPN":{"acumulado":27310.19,"previsto":24985,"diferencia":2325.19,"pctCumplimiento":109.3},"4GRC":{"acumulado":26075.51,"previsto":20424,"diferencia":5651.51,"pctCumplimiento":127.7},"4HAB":{"acumulado":41369.45,"previsto":60740,"diferencia":-19370.55,"pctCumplimiento":68.1},"4IAZ":{"acumulado":57854.42,"previsto":39322,"diferencia":18532.42,"pctCumplimiento":147.1},"4LBR":{"acumulado":37107.99,"previsto":33200,"diferencia":3907.99,"pctCumplimiento":111.8},"4LER":{"acumulado":21592.82,"previsto":48046,"diferencia":-26453.18,"pctCumplimiento":44.9},"4LLA":{"acumulado":57885.12,"previsto":49566,"diferencia":8319.12,"pctCumplimiento":116.8},"4MAC":{"acumulado":35651.46,"previsto":30226,"diferencia":5425.46,"pctCumplimiento":117.9},"4MAN":{"acumulado":40609.41,"previsto":47904,"diferencia":-7294.59,"pctCumplimiento":84.8},"4MCF":{"acumulado":49548.28,"previsto":29691,"diferencia":19857.28,"pctCumplimiento":166.9},"4MCI":{"acumulado":23009.35,"previsto":39280,"diferencia":-16270.65,"pctCumplimiento":58.6},"4MLV":{"acumulado":36362.15,"previsto":62537,"diferencia":-26174.85,"pctCumplimiento":58.1},"4MNA":{"acumulado":10528.22,"previsto":20530,"diferencia":-10001.78,"pctCumplimiento":51.3},"4MPC":{"acumulado":295.45,"previsto":34681,"diferencia":-34385.55,"pctCumplimiento":0.9},"4MPF":{"acumulado":31763.85,"previsto":31736,"diferencia":27.85,"pctCumplimiento":100.1},"4MRI":{"acumulado":20869.5,"previsto":21791,"diferencia":-921.5,"pctCumplimiento":95.8},"4MRM":{"acumulado":93654.62,"previsto":97828,"diferencia":-4173.38,"pctCumplimiento":95.7},"4MSB":{"acumulado":17115.89,"previsto":41138,"diferencia":-24022.11,"pctCumplimiento":41.6},"4MSU":{"acumulado":66765.52,"previsto":71979,"diferencia":-5213.48,"pctCumplimiento":92.8},"4MTQ":{"acumulado":33142.95,"previsto":24376,"diferencia":8766.95,"pctCumplimiento":136},"4MUG":{"acumulado":14754.59,"previsto":20803,"diferencia":-6048.41,"pctCumplimiento":70.9},"4OGS":{"acumulado":11593.04,"previsto":12413,"diferencia":-819.96,"pctCumplimiento":93.4},"4PEC":{"acumulado":102666.12,"previsto":75948,"diferencia":26718.12,"pctCumplimiento":135.2},"4RFM":{"acumulado":12335.85,"previsto":20303,"diferencia":-7967.15,"pctCumplimiento":60.8},"4SAB":{"acumulado":20675.01,"previsto":19340,"diferencia":1335.01,"pctCumplimiento":106.9},"4SAG":{"acumulado":84152.66,"previsto":77941,"diferencia":6211.66,"pctCumplimiento":108},"4SCB":{"acumulado":70693.01,"previsto":62314,"diferencia":8379.01,"pctCumplimiento":113.4},"4SGO":{"acumulado":14235.81,"previsto":39194,"diferencia":-24958.19,"pctCumplimiento":36.3},"4SMO":{"acumulado":35166.19,"previsto":24712,"diferencia":10454.19,"pctCumplimiento":142.3},"4STO":{"acumulado":22472.21,"previsto":29690,"diferencia":-7217.79,"pctCumplimiento":75.7},"4TAF":{"acumulado":20577.5,"previsto":27776,"diferencia":-7198.5,"pctCumplimiento":74.1},"4TCR":{"acumulado":21563.67,"previsto":27728,"diferencia":-6164.33,"pctCumplimiento":77.8},"4TOL":{"acumulado":86289.6,"previsto":107786,"diferencia":-21496.4,"pctCumplimiento":80.1},"4TRS":{"acumulado":29712.98,"previsto":37445,"diferencia":-7732.02,"pctCumplimiento":79.4},"4TSP":{"acumulado":34208.32,"previsto":28024,"diferencia":6184.32,"pctCumplimiento":122.1},"4VGA":{"acumulado":87542.26,"previsto":60711,"diferencia":26831.26,"pctCumplimiento":144.2},"4VIL":{"acumulado":21322.01,"previsto":30815,"diferencia":-9492.99,"pctCumplimiento":69.2},"4ZAI":{"acumulado":18788.65,"previsto":34634,"diferencia":-15845.35,"pctCumplimiento":54.2},"4ZAU":{"acumulado":18717.13,"previsto":31855,"diferencia":-13137.87,"pctCumplimiento":58.8},"4ZDE":{"acumulado":49823.81,"previsto":86533,"diferencia":-36709.19,"pctCumplimiento":57.6},"4ZMZ":{"acumulado":52568.33,"previsto":38528,"diferencia":14040.33,"pctCumplimiento":136.4},"4ZST":{"acumulado":17084.52,"previsto":20070,"diferencia":-2985.48,"pctCumplimiento":85.1}};

// Datos de centros (224 centros)
const centrosData = [
{"c":"5DEM","n":"CENTRO DEMO","p":"DEMO","d":"DEMO","r":"ARY","a":"NO","t":"DEMO","pc":"PC","pr":"SUCURSAL"},
{"c":"4ARY","n":"DEMO ARAGÓN","p":"DEMO","d":"DEMO","r":"ARY","a":"CERTIFICADO","t":"DEMO","pc":"PC","pr":"SUCURSAL"},
{"c":"4DAV","n":"DEMO DAVID","p":"DEMO","d":"DEMO","r":"ARY","a":"NO","t":"DEMO","pc":"PC","pr":"SUCURSAL"},
{"c":"4SON","n":"DEMO SONIA","p":"DEMO","d":"DEMO","r":"SGUASQUE","a":"NO","t":"DEMO","pc":"PC","pr":"SUCURSAL"},
{"c":"3ARY","n":"CENTRO PRUEBAS MADRID","p":"PRUEBAS","d":"PRUEBAS","r":"ARY","a":"CERTIFICADO","t":"PRUEBAS","pc":"PC","pr":"SUCURSAL"},
{"c":"2ARY","n":"CENTRO PRUEBAS BARCELONA","p":"PRUEBAS","d":"PRUEBAS","r":"ARY","a":"CERTIFICADO","t":"PRUEBAS","pc":"PC","pr":"SUCURSAL"},
{"c":"4VGA","n":"C.C. LA GAVIA","p":"AAO","d":"Marisa Carmona","r":"ARY","a":"CERTIFICADO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4ADU","n":"VALDEMORO","p":"VILLASEÑOR Juan Angel","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4SCB","n":"C/BURGOS","p":"AAO","d":"Sergio Perán","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4ANV","n":"GRAN DE SANT ANDREU 135","p":"CUBELLS Josep","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ADX","n":"ÁGUILAS","p":"LOPEZ Jose","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ANB","n":"GAVÁ","p":"MARTINEZ MONTSE","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4APQ","n":"BARACALDO","p":"RAMÍREZ  Ruben","d":"Sonia Godino","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AJQ","n":"C.C. CARREFOUR PONTEVEDRA","p":"FRAGUELA Jacobo","d":"Verónica Alfonsín","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AQI","n":"MADRID LÓPEZ DE HOYOS","p":"BERRIO Israel","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AQJ","n":"MADRID ACACIAS","p":"BERRIO Israel","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4MAN","n":"CC EL MANAR","p":"AAO","d":"Marisa Carmona","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AQU","n":"ALCOBENDAS CONSTITUCIÓN","p":"RUIZ Alberto","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AIR","n":"C.C. PONTEVELLA","p":"SELAS Manel","d":"Daniel Chazo","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4VIL","n":"VILANOVA","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4HAB","n":"TORREVIEJA","p":"AAO","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AUC","n":"PALMA COLOM","p":"DOS SANTOS Johanes","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AMZ","n":"C.C. NUEVA CONDOMINA","p":"REYES Luis","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4MRI","n":"C.C. MADRID RIO 2","p":"AAO","d":"Marisa Carmona","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4ACH","n":"C.C. CARREFOUR AZABACHE","p":"MARTINEZ Alfredo","d":"Verónica Alfonsín","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ASS","n":"C.C. CARREFOUR ALCOBENDAS","p":"RUIZ Alberto","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AOD","n":"ALGECIRAS","p":"VELASCO Mº Valvanera","d":"Martín Sebastián","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4DIA","n":"AVENIDA DIAGONAL","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4ARN","n":"NAVALMORAL","p":"OLIVER Javier","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AUE","n":"OVIEDO AV. GALICIA","p":"MARTINEZ Alfredo","d":"Verónica Alfonsín","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AES","n":"NARÓN","p":"FRAGUELA Jacobo","d":"Daniel Chazo","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AMY","n":"C.C. MADRID XANADÚ","p":"EL FALAKI Nadia","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AUO","n":"VIC","p":"JIMENEZ Mª Angeles","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AVA","n":"CARDEDEU","p":"JIMENEZ Mª Angeles","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ARK","n":"CARLET","p":"BELLOT Sonia","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4MSU","n":"C.C. MADRID SUR","p":"AAO","d":"Sergio Perán","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4MRM","n":"REINA DE MERCEDES","p":"AAO","d":"Sergio Perán","r":"ARY","a":"CERTIFICADO","t":"EXCLUSIVO","pc":"PC","pr":"SUCURSAL"},
{"c":"4IAZ","n":"C.C. ISLAZUL","p":"AAO","d":"Marisa Carmona","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4TRS","n":"RECONQUISTA","p":"AAO","d":"Marisa Carmona","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4OGS","n":"MADRID ORTEGA Y GASSET","p":"AAO","d":"Sergio Perán","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AVN","n":"CASTELAO","p":"FRAGUELA Jacobo","d":"Verónica Alfonsín","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4MAC","n":"SEVILLA CARREFOUR MACARENA","p":"AAO","d":"Maribel Amezcua","r":"SGUASQUE","a":"CERTIFICADO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AZN","n":"SEVILLA CARREFOUR AZNALFARACHE","p":"AAO","d":"Maribel Amezcua","r":"SGUASQUE","a":"CERTIFICADO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4LER","n":"LLEIDA","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4GPN","n":"CC NEVADA SHOPPING","p":"AAO","d":"Maribel Amezcua","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4MCI","n":"CC CIUDAD DE LA IMAGEN","p":"AAO","d":"Marisa Carmona","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4EAL","n":"CC ALISAL","p":"AAO","d":"Sergio Perán","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4CAM","n":"CARREFOUR CAMAS","p":"AAO","d":"Maribel Amezcua","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AHR","n":"VILLAGARCÍA DE AROSA","p":"FRAGUELA Jacobo","d":"Verónica Alfonsín","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AVC","n":"SAN SEBASTIÁN GROS","p":"ALVAREZ JOSUNE","d":"Sonia Godino","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4APP","n":"ESTEPONA","p":"LOZANO Consuelo","d":"Martín Sebastián","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AVP","n":"CALPE","p":"ARGUDO ALBA","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4SMO","n":"SEVILLA SAN PABLO","p":"AAO","d":"Maribel Amezcua","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AKI","n":"CC LOS VALLES","p":"PIEDRAFITA Rocio","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"EXCLUSIVO","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ZAI","n":"ZARAGOZA ALFONSO I","p":"AAO","d":"Eneritz Aranguren","r":"ARY","a":"FORMACION","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4ZAU","n":"ZARAGOZA","p":"AAO","d":"Eneritz Aranguren","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4TSP","n":"TERRASSA","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AVZ","n":"SEVILLA CALLE ASUNCIÓN","p":"SOLA JUAN JOSE","d":"Maribel Amezcua","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4APE","n":"PULIANAS CARREFOUR CC","p":"VALENTIN Adriana","d":"Martín Sebastián","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AWB","n":"MÁLAGA CALLE BEETHOVEN","p":"DE LA TORRE SANTIAGO","d":"Martín Sebastián","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ARC","n":"BURJASSOT CARRETERA DE LLÍRIA","p":"ESPERT VICENTA","d":"Cecilia Pérez","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ATE","n":"ALMERÍA CALLE NAVARRO RODRIGO","p":"VALENTIN Adriana","d":"Martín Sebastián","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4GRC","n":"GRANADA REYES CATÓLICOS","p":"AAO","d":"Maribel Amezcua","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AMD","n":"FERROL ALCAMPO CC","p":"FRAGUELA Jacobo","d":"Daniel Chazo","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AWI","n":"PRAT DE LLOBREGAT","p":"GOMEZ Guadalupe","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4MPF","n":"MÁLAGA PLAZA FÉLIX SÁENZ","p":"AAO","d":"Maribel Amezcua","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4ATL","n":"CAMBRILS CARRER DE LES BARQUES","p":"GELIS KRISTEL","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ZMZ","n":"ZARAGOZA CARREFOUR CC ACTUR","p":"AAO","d":"Eneritz Aranguren","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4MSB","n":"MÁLAGA CC LA ROSALEDA","p":"AAO","d":"Maribel Amezcua","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AZS","n":"FUENLABRADA CALLE LEGANÉS","p":"DIAZ Angel","d":"Laura Ramos","r":"ARY","a":"CERTIFICADO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4LLA","n":"ALBACETE CC LOS LLANOS","p":"AAO","d":"Marisa Carmona","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4ABC","n":"ALBACETE CC ALBACENTER","p":"AAO","d":"Marisa Carmona","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AUV","n":"VALLADOLID PASEO ZORRILLA","p":"URRUTIA Esteban","d":"Daniel Chazo","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4MUG","n":"MURCIA","p":"AAO","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AIE","n":"INCA GRAN VÍA COLÓN","p":"MONTES Manuela","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AWS","n":"C.C. CARREFOUR LAS ROSAS","p":"GOMEZ JOSE RAMÓN","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ATQ","n":"XIRIVELLA CC GRAN TURIA","p":"GOMEZ KATHERINE","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4BVI","n":"VILADECANS CC VILAMARINA","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4PEC","n":"SANTANDER CC PEÑACASTILLO","p":"AAO","d":"Sergio Perán","r":"ARY","a":"CERTIFICADO","t":"EXCLUSIVO","pc":"PC","pr":"SUCURSAL"},
{"c":"4SAG","n":"SALAMANCA CARREFOUR CC","p":"AAO","d":"Sergio Perán","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AWA","n":"MELIDE CALLE RONDA DA CORUÑA","p":"MOSQUERA Marta","d":"Verónica Alfonsín","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AVF","n":"HOSPITALET CARREFOUR CC","p":"BANAL Pere","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ATC","n":"C.C. GETAFE 3","p":"CARRILLO Antonio","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AGK","n":"PETRER CARREFOUR CC","p":"CASTELLO Rafael","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ANI","n":"ONDA AVENIDA PAÍS VALENCIÀ","p":"MONSERRAT VILAR MARIA AMPARO","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AWV","n":"C.C. GRAN PLAZA 2","p":"PIEDRAFITA Rocio","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AHU","n":"SAN VICENTE DEL RASPEIG AV. ALICANTE","p":"BOX Ana Cristina","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AQL","n":"ROTA AV. DE LA LIBERTAD","p":"JIMENEZ Leonor","d":"Martín Sebastián","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4MNA","n":"MADRID NARVÁEZ","p":"AAO","d":"Sergio Perán","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AKW","n":"ALZIRA PLAZA DEL REINO","p":"BELLOT Sonia","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AQV","n":"SAN SEBASTIAN DE LOS REYES CARREFOUR CC","p":"RUIZ Alberto","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AFH","n":"PAMPLONA CALLE SANCHO EL MAYOR","p":"MAZA Oriol","d":"Sonia Godino","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ARM","n":"ZAMORA CALLE SANTA CLARA","p":"LOPEZ Mª Angeles","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AQQ","n":"ÚBEDA CALLE CORREDERA DE SAN FERNANDO","p":"LÓPEZ José Vicente","d":"Martín Sebastián","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ASA","n":"CÓRDOBA CARREFOUR CC","p":"MOLINA Ramón","d":"Martín Sebastián","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXB","n":"FINESTRAT CC LA MARINA","p":"ARGUDO Alba","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ANE","n":"LEGANÉS CARREFOUR CC","p":"MARTINEZ LÓPEZ Raúl","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ARZ","n":"A CORUÑA CALLE JUAN FLÓREZ","p":"LEMA Pablo","d":"Daniel Chazo","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AJR","n":"TORTOSA PLAZA AGUSTÍ QUEROL","p":"BERNAL Fernando","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ALJ","n":"MONTIJO AV. COLÓN","p":"CUERPO Valentín","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXA","n":"CERDANYOLA","p":"VADILLO Pedro","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4TAF","n":"TALAVERA CC LOS ALFARES","p":"AAO","d":"Marisa Carmona","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AVE","n":"SANTA POLA CALLE D\'ELX","p":"DE LA CALLE MILAGROS","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AQT","n":"PUERTO DE SAGUNTO PLAZA RAMÓN SOTA","p":"MELGOSO Rafael","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AGW","n":"ONDARA CC PORTAL DE LA MARINA","p":"COLOMAR Julia","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AMJ","n":"OLIVA CALLE 9 DE OCTUBRE","p":"COLOMAR Julia","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXD","n":"ELCHE CC L\'ALJUB","p":"BOX NATALIA","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXF","n":"SANTIAGO DE COMPOSTELA RÚA DA ROSA","p":"URRUTIA Esteban","d":"Daniel Chazo","r":"ARY","a":"NO","t":"EXCLUSIVO","pc":"PC","pr":"FRANQUICIA"},
{"c":"4TOL","n":"TORRELAVEGA CARREFOUR CC","p":"AAO","d":"Sergio Perán","r":"ARY","a":"CERTIFICADO","t":"EXCLUSIVO","pc":"PC","pr":"SUCURSAL"},
{"c":"4ALY","n":"MADRID CALLE AYACUCHO","p":"MARTÍN Laura","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ANJ","n":"OLOT PLAÇA CLARÀ","p":"VALLS Eva","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXH","n":"MADRID PASEO DELICIAS","p":"BERRIO Israel","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4BCJ","n":"CORNELLÀ RAMBLA JOSEP ANSELM CLAVÉ","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4FIG","n":"FIGUERES CARREFOUR CC","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"CERTIFICADO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AUB","n":"PALMA DE MALLORCA CC PORTO PI","p":"DOS SANTOS Johanes","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4GIR","n":"GIRONA PLAÇA MIQUEL SANTALÓ I PARVORELL","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"CERTIFICADO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AWM","n":"BARCELONA VIA AUGUSTA","p":"CUBELLS Josep","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXL","n":"MÓSTOLES DOS DE MAYO","p":"Victor ORTIZ","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXN","n":"BADAJOZ CARREFOUR CC LA GRANADILLA","p":"CASIMIRO, ELENA","d":"Maribel Amezcua","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXM","n":"BADAJOZ CARREFOUR CC","p":"CASIMIRO, ELENA","d":"Maribel Amezcua","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AVS","n":"ALICANTE CALLE GENERAL LACY","p":"LÓPEZ Almudena","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AWL","n":"TORREJÓN CC PARQUE CORREDOR","p":"JIMENEZ Juan Luis","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4RFM","n":"RUBÍ PASSEIG DE FRANCESC MACIÀ","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AWG","n":"LUGO","p":"URRUTIA Esteban","d":"Daniel Chazo","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXP","n":"TÀRREGA","p":"GRIMAU Gemma","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4SAB","n":"SANT ADRIÀ DE BESÒS ALCAMPO CC","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4CLL","n":"LLEIDA CC CARREFOUR","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PNC","pr":"SUCURSAL"},
{"c":"4BIL","n":"BOADILLA AV. INFANTE DON LUIS","p":"AAO","d":"Marisa Carmona","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4BMT","n":"BARCELONA MUNTANER","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4BON","n":"VALENCIA","p":"AAO","d":"Marisa Carmona","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"SUCURSAL"},
{"c":"4AUJ","n":"TORRENT","p":"GUTIERREZ Elena","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXY","n":"LAIN CALVO","p":"LUNA Ester","d":"Sonia Godino","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXS","n":"C.C. CARREFOUR TARRAGONA","p":"Azahara QUER","d":"Eneritz Aranguren","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXO","n":"VIVEIRO AV. CANTARRANA","p":"XISELA LEAL PRIERTO","d":"Daniel Chazo","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXU","n":"VALLECAS","p":"BALAGUER Jaime","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AZT","n":"CC PLAZA DE LA ESTACIÓN","p":"DIAZ Angel","d":"Laura Ramos","r":"ARY","a":"NO","t":"EXCLUSIVO","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AQZ","n":"CC ALCALÁ DE HENARES","p":"VENTURA Vanesa","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXV","n":"BILBAO CORREO","p":"RAMÍREZ  Ruben","d":"Sonia Godino","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ZDE","n":"ZARAGOZA CALLE DELICIAS","p":"AAO","d":"Eneritz Aranguren","r":"ARY","a":"CERTIFICADO","t":"EXCLUSIVO","pc":"PC","pr":"SUCURSAL"},
{"c":"4MTQ","n":"SEVILLA MONTEQUINTO CARREFOUR CC","p":"AAO","d":"Maribel Amezcua","r":"SGUASQUE","a":"CERTIFICADO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AVV","n":"SANT BOI DE LLOBREGAT","p":"PEREZ Mireia","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AKB","n":"GIJÓN","p":"MARTINEZ Alfredo","d":"Verónica Alfonsín","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXR","n":"EL PALMAR","p":"GÓMEZ Ana Belén","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4CPL","n":"CASTELLÓN DE LA PLANA CALLE ENMEDIO","p":"AAO","d":"Marisa Carmona","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AYB","n":"SESTAO","p":"MARCOS Irene","d":"Sonia Godino","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXZ","n":"CC ATALAYAS","p":"MARTÍNEZ Rosa","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AVH","n":"BARCELONA SANTS","p":"BANAL Pere","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ZST","n":"ZARAGOZA CALLE SANTA TERESA","p":"AAO","d":"Eneritz Aranguren","r":"ARY","a":"CERTIFICADO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4SGO","n":"SORIA CC LAS CAMARETAS","p":"AAO","d":"Eneritz Aranguren","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AFY","n":"SAN FERNANDO DE HENARES","p":"MUÑOZ Pedro","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AXX","n":"MÁLAGA CALLE HILERA","p":"DE LA TORRE Santiago","d":"Martín Sebastián","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AYA","n":"MÁLAGA","p":"MEDINA Delfina","d":"Martín Sebastián","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4APH","n":"GETXO","p":"MARCOS Irene","d":"Sonia Godino","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AYD","n":"GENERAL RICARDOS","p":"BLANCO Ángela","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ANU","n":"ARAVACA","p":"SANCHEZ Jesica","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ARA","n":"ARANJUEZ CALLE SAN ANTONIO","p":"AAO","d":"Marisa Carmona","r":"ARY","a":"CERTIFICADO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4ADQ","n":"TORREJÓN DE ARDOZ","p":"MUÑOZ Pedro","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4EPA","n":"PUERTO DE SANTA MARIA CARREFOUR CC","p":"AAO","d":"Maribel Amezcua","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AYF","n":"MADRID FRANCOS RODRÍGUEZ","p":"ANTONA Ángela","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4GMA","n":"GANDÍA","p":"AAO","d":"Marisa Carmona","r":"SGUASQUE","a":"CERTIFICADO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4ASQ","n":"SAN JUAN CARREFOUR CC","p":"PÉREZ Felipe","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AWO","n":"MISLATA","p":"GOMEZ KATHERINE","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4MLV","n":"MADRID CC La Vaguada","p":"AAO","d":"Sergio Perán","r":"ARY","a":"FORMACION","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AYI","n":"LLÍRIA","p":"OVEJERO Gema","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AYG","n":"VALENCIA CC NUEVO CENTRO","p":"DUCE, IRIS","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4TCR","n":"TARRAGONA CALLE COMTE DE RIUS","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PNC","pr":"SUCURSAL"},
{"c":"4AYH","n":"PLAZA ESPAÑA","p":"DUCE, IRIS","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4LBR","n":"LOS BARRIOS CARREFOUR CC","p":"AAO","d":"Maribel Amezcua","r":"SGUASQUE","a":"FORMACION","t":"CORNER","pc":"PNC","pr":"SUCURSAL"},
{"c":"4ARQ","n":"BOUZAS","p":"TOURIÑO Miguel","d":"Verónica Alfonsín","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AWQ","n":"PAMPLONA Carlos III","p":"MAZA Oriol","d":"Sonia Godino","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AYL","n":"ALHAMA-MURCIA","p":"GÓMEZ Ana Belén","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AYK","n":"SAN SEBASTIAN DE LOS REYES","p":"RUIZ Alberto","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4ABB","n":"PAMPLONA CENTRO EXCLUSIVO","p":"MAZA Oriol","d":"Sonia Godino","r":"ARY","a":"NO","t":"EXCLUSIVO","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AVU","n":"LOGROÑO","p":"GOMEZ ORTIZ Lorena","d":"Sonia Godino","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AGF","n":"PARLA","p":"MUÑOZ Pedro","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AOC","n":"MEDINA DEL CAMPO","p":"DE LA VEGA Laura","d":"Daniel Chazo","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AZQ","n":"ELGOIBAR","p":"Iñigo","d":"Sonia Godino","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4CCA","n":"CASTELLÓN CARREFOUR CC","p":"AAO","d":"Marisa Carmona","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"SUCURSAL"},
{"c":"4ABI","n":"TENERIFE AÑAZA","p":"DARIAS Beatriz","d":"Blanca Fernández de la Pradilla","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4ATV","n":"PLASENCIA CARREFOUR CC","p":"GONZALEZ Cristina","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AXC","n":"CASTRO URDIALES","p":"RAMÍREZ  Ruben","d":"Sonia Godino","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4BDM","n":"BARCELONA CC DIAGONAL MAR","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AYX","n":"VALENCIA MARQUÉS DE SOTELO","p":"GOMEZ KATHERINE","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4ADC","n":"URBIETA","p":"ALBA Javier","d":"Sonia Godino","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AWU","n":"TORREVIEJA","p":"ARENAS Vanessa","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4BAN","n":"RONDA SANT ANTONI","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"CERTIFICADO","t":"CORNER","pc":"PC","pr":"SUCURSAL"},
{"c":"4AQN","n":"PATERNA","p":"SANCHO Silvia","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AYV","n":"MADRID CALLE PRÍNCIPE DE VERGARA","p":"WALID BOUHADOU","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4MCF","n":"FUENCARRAL","p":"AAO","d":"Sergio Perán","r":"ARY","a":"FORMACION","t":"CORNER","pc":"PNC","pr":"SUCURSAL"},
{"c":"4AYO","n":"CÓRDOBA JESÚS RESCATADO","p":"MOLINA Ramón","d":"Martín Sebastián","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AYN","n":"ZARAGOZA SOBRARBE","p":"LAGUNA Teresa","d":"Eneritz Aranguren","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AYQ","n":"ORIHUELA","p":"MARTINEZ Paqui","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AYU","n":"MORATALAZ","p":"ERUSTES Maria","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AYT","n":"VALENCIA MALILLA CALLE OLTÀ","p":"BONORA Anabel","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AOU","n":"IGUALADA","p":"CUNYADO Carles","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AUX","n":"HUESCA","p":"LOPEZ Silvia","d":"Eneritz Aranguren","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4ATU","n":"EL VENDRELL","p":"CASTILLO Ignasi","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4CCC","n":"CÁCERES","p":"AAO","d":"Maribel Amezcua","r":"ARY","a":"FORMACION","t":"CORNER","pc":"PNC","pr":"SUCURSAL"},
{"c":"4AWJ","n":"ANDÚJAR","p":"LORITE Joaquín","d":"Martín Sebastián","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AYP","n":"VILLAVERDE","p":"DIAZ Angel","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AZA","n":"TERUEL AV. SANZ GADEA","p":"MALDONADO,Elena","d":"Eneritz Aranguren","r":"ARY","a":"NO","t":"CORNER","pc":"PC","pr":"FRANQUICIA"},
{"c":"4AHE","n":"VINARÒS","p":"BERNAL Fernando","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AWF","n":"LUGO","p":"URRUTIA Esteban","d":"Daniel Chazo","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4APL","n":"LAS PALMAS VIERA Y CLAVIJO","p":"MELIAN Itziar","d":"Blanca Fernández de la Pradilla","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AQD","n":"GRANOLLERS","p":"SANCHEZ Rubén","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4ABW","n":"ALMERÍA CARREFOUR CC","p":"VALENTIN Adriana","d":"Martín Sebastián","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AZE","n":"ZARAGOZA AV. TENOR FLETA","p":"GRIMA Raul","d":"Eneritz Aranguren","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AZB","n":"TRES CANTOS","p":"LOPEZ LORENA","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AZI","n":"TOLOSA","p":"VARGAS, Javier David","d":"Sonia Godino","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4STO","n":"SALAMANCA CALLE TORO","p":"AAO","d":"Sergio Perán","r":"ARY","a":"FORMACION","t":"CORNER","pc":"PNC","pr":"SUCURSAL"},
{"c":"4AZM","n":"MOLLERUSA","p":"RATES Oriol","d":"Laura Plazas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AFI","n":"MARÍN","p":"TOURIÑO Miguel","d":"Verónica Alfonsín","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4BMA","n":"MANRESA CARREFOUR CC","p":"AAO","d":"Eneritz Aranguren","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"SUCURSAL"},
{"c":"4MPC","n":"MALLORCA CAN PICAFORT","p":"AAO","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"SUCURSAL"},
{"c":"4AZC","n":"MÁLAGA CALLE VICTORIA","p":"LOZANO Consuelo","d":"Martín Sebastián","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AZD","n":"GETAFE CALLE MADRID","p":"BLANCO Ángela","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AYZ","n":"CARTAGENA ESPACIO MEDITERRÁNEO","p":"ESPEJO Miriam","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4CUC","n":"CUENCA","p":"AAO","d":"Marisa Carmona","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"SUCURSAL"},
{"c":"4AMU","n":"BILBONDO","p":"ALDAMA, Idurre","d":"Sonia Godino","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AZH","n":"AMPOSTA","p":"BERNAL Fernando","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4ATF","n":"MÁLAGA CC ALAMEDA","p":"AZNAR, Daniel","d":"Martín Sebastián","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AZG","n":"VITORIA CALLE FUEROS","p":"François  BERGUGNANT","d":"Sonia Godino","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AHY","n":"TORREPACHECO","p":"CASTEJON Olimpia","d":"Manuel Cánovas","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4ATP","n":"SAGUNTO VIDANOVA PARC","p":"ESTEVE Mireia","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AZP","n":"SEGORBE","p":"MANZANA Rosa","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"EXCLUSIVO","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AKU","n":"GUADALAJARA","p":"SANTOS, Beatriz","d":"Laura Ramos","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AEQ","n":"JUMILLA","p":"MARTINEZ, Jose Luis","d":"Manuel Cánovas","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AZO","n":"MONCADA","p":"ESPERT VICENTA","d":"Cecilia Pérez","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AZL","n":"MADRID GUINDALERA","p":"JIMENEZ Maria Angeles","d":"Blanca Fernández de la Pradilla","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AZY","n":"RIBADAVIA (OURENSE)","p":"LOPEZ MARIA","d":"Verónica Alfonsín","r":"ARY","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"},
{"c":"4AWP","n":"LA LAGUNA","p":"LOPEZ PATRICIA","d":"Blanca Fernández de la Pradilla","r":"SGUASQUE","a":"NO","t":"CORNER","pc":"PNC","pr":"FRANQUICIA"}
];

// Códigos numéricos y de seguridad por centro (desde Excel oficial)
var codigosNumericosCentros = {"4VGA": 1001, "4ADU": 1002, "4SCB": 1003, "4ANV": 1004, "4ADX": 1005, "4ANB": 1006, "4APQ": 1007, "4AJQ": 1008, "4AQI": 1009, "4AQJ": 1010, "4MAN": 1011, "4AQU": 1012, "4AIR": 1013, "4VIL": 1014, "4HAB": 1015, "4AUC": 1016, "4AMZ": 1017, "4MRI": 1018, "4ACH": 1019, "4ASS": 1020, "4AOD": 1021, "4DIA": 1022, "4ARN": 1023, "4AUE": 1024, "4AES": 1025, "4AMY": 1026, "4AUO": 1027, "4AVA": 1028, "4ARK": 1029, "4MSU": 1030, "4MRM": 1031, "4IAZ": 1032, "4TRS": 1033, "4OGS": 1034, "4AVN": 1035, "4MAC": 1036, "4AZN": 1037, "4LER": 1038, "4GPN": 1039, "4MCI": 1040, "4EAL": 1041, "4CAM": 1042, "4AHR": 1043, "4AVC": 1044, "4APP": 1045, "4AVP": 1046, "4SMO": 1047, "4AKI": 1048, "4ZAI": 1049, "4ZAU": 1050, "4TSP": 1051, "4AVZ": 1052, "4APE": 1053, "4AWB": 1054, "4ARC": 1055, "4ATE": 1056, "4GRC": 1057, "4AMD": 1058, "4AWI": 1059, "4MPF": 1060, "4ATL": 1061, "4ZMZ": 1062, "4MSB": 1063, "4AZS": 1064, "4LLA": 1065, "4ABC": 1066, "4AUV": 1067, "4MUG": 1068, "4AIE": 1069, "4AWS": 1070, "4ATQ": 1071, "4BVI": 1072, "4PEC": 1073, "4SAG": 1074, "4AWA": 1075, "4AVF": 1076, "4ATC": 1077, "4AGK": 1078, "4ANI": 1079, "4AWV": 1080, "4AHU": 1081, "4AQL": 1082, "4MNA": 1083, "4AKW": 1084, "4AQV": 1085, "4AFH": 1086, "4ARM": 1087, "4AQQ": 1088, "4ASA": 1089, "4AXB": 1090, "4ANE": 1091, "4ARZ": 1092, "4AJR": 1093, "4ALJ": 1094, "4AXA": 1095, "4TAF": 1096, "4AVE": 1097, "4AQT": 1098, "4AGW": 1099, "4AMJ": 1100, "4AXD": 1101, "4AXF": 1102, "4TOL": 1103, "4ALY": 1104, "4ANJ": 1105, "4AXH": 1106, "4BCJ": 1107, "4FIG": 1108, "4AUB": 1109, "4GIR": 1110, "4AWM": 1111, "4AXL": 1112, "4AXN": 1113, "4AXM": 1114, "4AVS": 1115, "4AWL": 1116, "4RFM": 1117, "4AWG": 1118, "4AXP": 1119, "4SAB": 1120, "4CLL": 1121, "4BIL": 1122, "4BMT": 1123, "4BON": 1124, "4AUJ": 1125, "4AXY": 1126, "4AXS": 1127, "4AXO": 1128, "4AXU": 1129, "4AZT": 1130, "4AQZ": 1131, "4AXV": 1132, "4ZDE": 1133, "4MTQ": 1134, "4AVV": 1135, "4AKB": 1136, "4AXR": 1137, "4CPL": 1138, "4AYB": 1139, "4AXZ": 1140, "4AVH": 1141, "4ZST": 1142, "4SGO": 1143, "4AFY": 1144, "4AXX": 1145, "4AYA": 1146, "4APH": 1147, "4AYD": 1148, "4ANU": 1149, "4ARA": 1150, "4ADQ": 1151, "4EPA": 1152, "4AYF": 1153, "4GMA": 1154, "4ASQ": 1155, "4AWO": 1156, "4MLV": 1157, "4AYI": 1158, "4AYG": 1159, "4TCR": 1160, "4AYH": 1161, "4LBR": 1162, "4ARQ": 1163, "4AWQ": 1164, "4AYL": 1165, "4AYK": 1166, "4ABB": 1167, "4AVU": 1168, "4AGF": 1169, "4AOC": 1170, "4AZQ": 1171, "4CCA": 1172, "4ABI": 1173, "4ATV": 1174, "4AXC": 1175, "4BDM": 1176, "4AYX": 1177, "4ADC": 1178, "4AWU": 1179, "4BAN": 1180, "4AQN": 1181, "4AYV": 1182, "4MCF": 1183, "4AYO": 1184, "4AYN": 1185, "4AYQ": 1186, "4AYU": 1187, "4AYT": 1188, "4AOU": 1189, "4AUX": 1190, "4ATU": 1191, "4CCC": 1192, "4AWJ": 1193, "4AYP": 1194, "4AZA": 1195, "4AHE": 1196, "4AWF": 1197, "4APL": 1198, "4AQD": 1199, "4ABW": 1200, "4AZE": 1201, "4AZB": 1202, "4AZI": 1203, "4STO": 1204, "4AZM": 1205, "4AFI": 1206, "4BMA": 1207, "4MPC": 1208, "4AZC": 1209, "4AZD": 1210, "4AYZ": 1211, "4CUC": 1212, "4AMU": 1213, "4AZH": 1214, "4ATF": 1215, "4AZG": 1216, "4AHY": 1217, "4ATP": 1218, "4AZP": 1219, "4AKU": 1220, "4AEQ": 1221, "4AZO": 1222, "4AZL": 1223, "4AZY": 1224, "4AWP": 1225};
var codigosSeguridadCentros = {"4VGA": "8834", "4ADU": "0091", "4SCB": "0257", "4ANV": "7876", "4ADX": "8641", "4ANB": "4014", "4APQ": "1593", "4AJQ": "8990", "4AQI": "7322", "4AQJ": "8233", "4MAN": "5408", "4AQU": "1818", "4AIR": "9641", "4VIL": "2981", "4HAB": "5797", "4AUC": "1620", "4AMZ": "4159", "4MRI": "2012", "4ACH": "0927", "4ASS": "0667", "4AOD": "1589", "4DIA": "5920", "4ARN": "7450", "4AUE": "2531", "4AES": "2304", "4AMY": "6594", "4AUO": "1844", "4AVA": "6755", "4ARK": "6412", "4MSU": "2054", "4MRM": "2291", "4IAZ": "1065", "4TRS": "2217", "4OGS": "1611", "4AVN": "4519", "4MAC": "9741", "4AZN": "0883", "4LER": "5568", "4GPN": "4463", "4MCI": "4861", "4EAL": "0026", "4CAM": "4625", "4AHR": "5361", "4AVC": "6303", "4APP": "0653", "4AVP": "5885", "4SMO": "4221", "4AKI": "0157", "4ZAI": "7737", "4ZAU": "6841", "4TSP": "0612", "4AVZ": "4743", "4APE": "0431", "4AWB": "4797", "4ARC": "6696", "4ATE": "2338", "4GRC": "8047", "4AMD": "9179", "4AWI": "2240", "4MPF": "3124", "4ATL": "8346", "4ZMZ": "6822", "4MSB": "6348", "4AZS": "3747", "4LLA": "0087", "4ABC": "3766", "4AUV": "2744", "4MUG": "3161", "4AIE": "9342", "4AWS": "8119", "4ATQ": "5511", "4BVI": "9185", "4PEC": "2052", "4SAG": "5865", "4AWA": "7688", "4AVF": "0130", "4ATC": "1001", "4AGK": "5000", "4ANI": "0463", "4AWV": "4111", "4AHU": "6525", "4AQL": "5457", "4MNA": "7938", "4AKW": "4172", "4AQV": "2568", "4AFH": "3298", "4ARM": "5292", "4AQQ": "9657", "4ASA": "9287", "4AXB": "9521", "4ANE": "9253", "4ARZ": "0756", "4AJR": "7137", "4ALJ": "1263", "4AXA": "6638", "4TAF": "5056", "4AVE": "5466", "4AQT": "6976", "4AGW": "4802", "4AMJ": "6778", "4AXD": "1186", "4AXF": "8780", "4TOL": "6457", "4ALY": "4807", "4ANJ": "4900", "4AXH": "6043", "4BCJ": "2862", "4FIG": "8070", "4AUB": "6888", "4GIR": "0941", "4AWM": "8744", "4AXL": "8562", "4AXN": "8425", "4AXM": "4950", "4AVS": "0163", "4AWL": "7866", "4RFM": "2373", "4AWG": "9613", "4AXP": "6200", "4SAB": "7533", "4CLL": "1385", "4BIL": "8766", "4BMT": "7808", "4BON": "2356", "4AUJ": "6903", "4AXY": "0442", "4AXS": "6850", "4AXO": "3749", "4AXU": "1428", "4AZT": "3209", "4AQZ": "1039", "4AXV": "0079", "4ZDE": "3337", "4MTQ": "6640", "4AVV": "6286", "4AKB": "9811", "4AXR": "0939", "4CPL": "2250", "4AYB": "1269", "4AXZ": "5480", "4AVH": "9563", "4ZST": "6526", "4SGO": "1639", "4AFY": "2486", "4AXX": "2694", "4AYA": "7745", "4APH": "2823", "4AYD": "6563", "4ANU": "1827", "4ARA": "0613", "4ADQ": "1862", "4EPA": "2356", "4AYF": "0363", "4GMA": "1345", "4ASQ": "3120", "4AWO": "3151", "4MLV": "7401", "4AYI": "0523", "4AYG": "7457", "4TCR": "5609", "4AYH": "7255", "4LBR": "8154", "4ARQ": "4305", "4AWQ": "7722", "4AYL": "4825", "4AYK": "3829", "4ABB": "9767", "4AVU": "4057", "4AGF": "0496", "4AOC": "7304", "4AZQ": "1457", "4CCA": "9976", "4ABI": "4173", "4ATV": "6887", "4AXC": "1247", "4BDM": "2580", "4AYX": "1645", "4ADC": "3332", "4AWU": "3294", "4BAN": "0654", "4AQN": "5815", "4AYV": "3206", "4MCF": "4679", "4AYO": "0157", "4AYN": "0292", "4AYQ": "9957", "4AYU": "0355", "4AYT": "8422", "4AOU": "9067", "4AUX": "3411", "4ATU": "7983", "4CCC": "1746", "4AWJ": "4001", "4AYP": "7322", "4AZA": "3340", "4AHE": "9613", "4AWF": "9148", "4APL": "3240", "4AQD": "6466", "4ABW": "7217", "4AZE": "2319", "4AZB": "8934", "4AZI": "0132", "4STO": "1954", "4AZM": "2279", "4AFI": "1216", "4BMA": "4184", "4MPC": "4253", "4AZC": "7958", "4AZD": "4972", "4AYZ": "9217", "4CUC": "9039", "4AMU": "5704", "4AZH": "3818", "4ATF": "5672", "4AZG": "7824", "4AHY": "7127", "4ATP": "1106", "4AZP": "6037", "4AKU": "6636", "4AEQ": "0507", "4AZO": "0077", "4AZL": "3968", "4AZY": "4249", "4AWP": "5195"};

// ==================== EXCLUSIVOS Y FLOP ====================
let centrosFlop = JSON.parse(localStorage.getItem('centrosFlop') || '[]');
let accionesCentros = JSON.parse(localStorage.getItem('accionesCentros') || '{}');
let centroAccionActual = null;
let paquetesCentros = JSON.parse(localStorage.getItem('paquetesCentros') || '{}');
let paqueteActual = 0;

// Funciones para Paquetes Plan de Acción
function togglePaquetes() {
    const content = document.getElementById('paquetes-content');
    const arrow = document.getElementById('paquetes-arrow');
    if(content.style.display === 'none') {
        content.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
    } else {
        content.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
    }
}

function seleccionarPaquete(num) {
    paqueteActual = num;
    for(let i = 1; i <= 3; i++) {
        const paq = document.getElementById('paq-' + i);
        if(paq) {
            if(i === num) {
                paq.style.border = '3px solid #C9A227';
                paq.style.background = '#fffbeb';
                paq.style.boxShadow = '0 4px 12px rgba(201,162,39,0.3)';
            } else {
                paq.style.border = '2px solid #ddd';
                paq.style.background = '#fff';
                paq.style.boxShadow = 'none';
            }
        }
    }
    const nombres = ['', 'TRÁFICO', 'COMERCIAL-FORMACIÓN', 'EQUIPO'];
    document.getElementById('paquete-seleccionado').textContent = 'Paquete ' + num + ': ' + nombres[num];
}

function asignarPaqueteCentro(codigoCentro, numPaquete) {
    paquetesCentros[codigoCentro] = numPaquete;
    localStorage.setItem('paquetesCentros', JSON.stringify(paquetesCentros));
    renderExclusivosFlop();
}

function getPaqueteCentro(codigoCentro) {
    return paquetesCentros[codigoCentro] || 0;
}

// Datos de los criterios de cada paquete
const datosPaquetes = {
    1: {
        nombre: 'TRÁFICO',
        color: '#16a34a',
        criterios: [
            'Dominar área social local',
            'TMK interno BBDD/Noah con seguimiento activo y registrado',
            'Screening 80%',
            'Cada miembro del equipo debe realizar al menos 2 derivaciones Audio',
            'Posibilidad de acuerdo farmacia',
            'Posibilidad de adherirse al SEG. SOCIAL. Contactar con trabajadores sociales locales',
            'Los centros deben disponer de elementos de comunicación de audio como flyers, test de lectura y botón',
            'Los centros escoltas-óptica deben disponer de elementos de comunicación interna de audio',
            'Cada AP debe contactar al menos con 4 asociaciones de interés',
            'Análisis de cada acción cada 3 meses para confirmar evolución',
            'Captación calle o Centro comercial (azafata-ruleta...). Valorar viabilidad por delegado',
            'Mailing personalizado',
            'TMK Call Center',
            'Acciones locales activadas (radio, digital...)',
            'Incentivos por derivación/derivación-éxito'
        ]
    },
    2: {
        nombre: 'COMERCIAL-FORMACIÓN',
        color: '#2563eb',
        criterios: [
            'Mentoring cíclicos de Incorporaciones (temas básicos)',
            'Mentoring de categoría avanzada',
            'Mentoring con seguimiento-delegado. Revisión de funnel',
            'Visita técnica para comprobar procedimientos y establecer plan de acción formativo',
            'Formar a equipo o al menos 1 miembro en AAR y aplicar-reestructurar horario de atención',
            'Fomentar HIT para clientes de pilas usuarios de terceros y +3 años de compra+seguimiento',
            'Análisis del funnel mensual',
            'Stock adecuado a la agenda',
            'Revisión del horario del AP y su perfil (si es óptico también)',
            'Evitar derivaciones por tapones de cera, si es imprescindible hacer seguimiento activo',
            'Fomentar el Campo Libre para cierre de venta y renovaciones',
            'Conocer Infinity y ofrecer',
            'Seguimiento de llamadas de rescate cada 3-6 meses con argumento personalizado',
            'Realizar llamadas para Control de calidad y rendimiento de audífonos a clientes +3 años de compra',
            'Reforzar siempre desde 1º momento compromisos potentes de Audio: Tchin Tchin, gafa regalo, garantía 4 años'
        ]
    },
    3: {
        nombre: 'EQUIPO',
        color: '#9333ea',
        criterios: [
            'Formación del equipo de óptica de sinergias al día',
            'Screening del 80%',
            'Hacer uso de los elementos de audio en el centro para comenzar conversaciones AUDIO',
            'Revisión de incentivos por derivación',
            'Los AP deben ser activos en el TMK DE NOAH-BBDD',
            'Cada miembro del equipo debe conseguir al menos 1 derivación para Audio semanal',
            'El AP debe estar fuera del gabinete dinamizando en caso de no tener citas',
            'El AP debe dar primeras instrucciones a su equipo de óptica de manera que puedan dar un mínimo de servicio',
            'La agenda de audio no debe tener mas del 25% de ocupación en revisiones',
            'Todos los pacientes "de pilas" deben ser registrados para posterior impacto',
            'Todos los clientes usuarios de audífonos de la competencia deben ser informados de un pack PREMIUM que disfrutarán GRATIS',
            'Formación de Audio a miembros del equipo como en caso de AAR',
            'Formación de Audio del RT',
            'El equipo debe saber condiciones comerciales de AUDIO y compromisiones'
        ]
    }
};

let criteriosPaqueteActual = {};

function cargarPaqueteInforme(centroNombre) {
    const codigo = centroNombre ? centroNombre.split(' ')[0].split('-')[0].trim() : '';
    const numPaquete = getPaqueteCentro(codigo);
    
    const seccion = document.getElementById('seccion-paquete-informe');
    const titulo = document.getElementById('titulo-paquete-informe');
    const contenido = document.getElementById('contenido-paquete-informe');
    
    if(!numPaquete || numPaquete === 0) {
        seccion.style.display = 'none';
        return;
    }
    
    const paquete = datosPaquetes[numPaquete];
    if(!paquete) {
        seccion.style.display = 'none';
        return;
    }
    
    seccion.style.display = 'block';
    titulo.innerHTML = '📦 PAQUETE ' + numPaquete + ': ' + paquete.nombre;
    document.querySelector('#seccion-paquete-informe .inf-seccion-icono').style.background = paquete.color;
    
    const keyStorage = 'criteriosPaq_' + codigo;
    criteriosPaqueteActual = JSON.parse(localStorage.getItem(keyStorage) || '{}');
    
    let html = '<div style="display:grid;grid-template-columns:1fr;gap:6px">';
    
    paquete.criterios.forEach(function(criterio, idx) {
        const aplicado = criteriosPaqueteActual[idx] || false;
        html += '<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:#fff;border-radius:6px;border:1px solid ' + (aplicado ? paquete.color : '#e0e0e0') + '">' +
                '<div style="flex:1;font-size:9px;color:#333;line-height:1.4">' + criterio + '</div>' +
                '<div style="display:flex;gap:4px">' +
                '<button onclick="marcarCriterioPaquete(\'' + codigo + '\',' + idx + ',true)" style="padding:4px 10px;font-size:8px;font-weight:700;border:none;border-radius:4px;cursor:pointer;' + (aplicado ? 'background:'+paquete.color+';color:#fff' : 'background:#e0e0e0;color:#666') + '">SÍ</button>' +
                '<button onclick="marcarCriterioPaquete(\'' + codigo + '\',' + idx + ',false)" style="padding:4px 10px;font-size:8px;font-weight:700;border:none;border-radius:4px;cursor:pointer;' + (!aplicado && criteriosPaqueteActual.hasOwnProperty(idx) ? 'background:#dc2626;color:#fff' : 'background:#e0e0e0;color:#666') + '">NO</button>' +
                '</div></div>';
    });
    
    html += '</div>';
    
    const totalCriterios = paquete.criterios.length;
    const aplicados = Object.values(criteriosPaqueteActual).filter(function(v) { return v === true; }).length;
    const pctAplicado = Math.round((aplicados / totalCriterios) * 100);
    
    html += '<div style="margin-top:10px;padding:10px;background:linear-gradient(135deg,' + paquete.color + '15,' + paquete.color + '05);border-radius:6px;border:1px solid ' + paquete.color + ';display:flex;justify-content:space-between;align-items:center">' +
            '<span style="font-size:10px;font-weight:600;color:' + paquete.color + '">📊 PROGRESO DEL PAQUETE</span>' +
            '<span style="font-size:14px;font-weight:800;color:' + paquete.color + '">' + aplicados + '/' + totalCriterios + ' (' + pctAplicado + '%)</span></div>';
    
    contenido.innerHTML = html;
}

function marcarCriterioPaquete(codigo, idx, valor) {
    const keyStorage = 'criteriosPaq_' + codigo;
    criteriosPaqueteActual[idx] = valor;
    localStorage.setItem(keyStorage, JSON.stringify(criteriosPaqueteActual));
    cargarPaqueteInforme(document.getElementById('inf-centro').value);
}

// Funciones para paquete en Modal de Acciones
function cargarPaqueteEnModal(codigo) {
    const numPaquete = getPaqueteCentro(codigo);
    
    // Resetear botones
    for(let i = 1; i <= 3; i++) {
        const btn = document.getElementById('btn-paq-' + i);
        if(btn) {
            btn.style.border = '2px solid #ddd';
            btn.style.background = '#fff';
        }
    }
    
    const infoEl = document.getElementById('paqueteSeleccionadoInfo');
    
    // Si ya tiene paquete, seleccionarlo
    if(numPaquete && numPaquete > 0) {
        const btn = document.getElementById('btn-paq-' + numPaquete);
        const colores = ['', '#16a34a', '#2563eb', '#9333ea'];
        const nombres = ['', 'TRÁFICO', 'COMERCIAL-FORMACIÓN', 'EQUIPO'];
        if(btn) {
            btn.style.border = '3px solid ' + colores[numPaquete];
            btn.style.background = '#fffbeb';
        }
        if(infoEl) infoEl.innerHTML = '✓ Paquete asignado: <strong style="color:' + colores[numPaquete] + '">' + nombres[numPaquete] + '</strong>';
    } else {
        if(infoEl) infoEl.innerHTML = '<span style="color:#888">Selecciona un paquete para ver el checklist en cada acción</span>';
    }
}

function seleccionarPaqueteModal(num) {
    if(!centroAccionActual) return;
    const codigo = centroAccionActual.c;
    
    // Guardar paquete
    paquetesCentros[codigo] = num;
    localStorage.setItem('paquetesCentros', JSON.stringify(paquetesCentros));
    
    // Actualizar botones
    const colores = ['', '#16a34a', '#2563eb', '#9333ea'];
    const nombres = ['', 'TRÁFICO', 'COMERCIAL-FORMACIÓN', 'EQUIPO'];
    for(let i = 1; i <= 3; i++) {
        const btn = document.getElementById('btn-paq-' + i);
        if(btn) {
            if(i === num) {
                btn.style.border = '3px solid ' + colores[i];
                btn.style.background = '#fffbeb';
            } else {
                btn.style.border = '2px solid #ddd';
                btn.style.background = '#fff';
            }
        }
    }
    
    const infoEl = document.getElementById('paqueteSeleccionadoInfo');
    if(infoEl) infoEl.innerHTML = '✓ Paquete asignado: <strong style="color:' + colores[num] + '">' + nombres[num] + '</strong>';
    
    // Re-renderizar tabla para mostrar checklist
    renderTablaAcciones(accionesCentros[codigo] || []);
    
    // Actualizar vista de exclusivos
    renderExclusivosFlop();
}

const tiposAccion = [
    'AZAFATA',
    'BUZONEO',
    'STAND',
    'CALL CENTER',
    'MAILING',
    'SORTEO',
    'RULETA',
    'ACCIÓN ESPECIAL MGM',
    'ACCIÓN ESPECIAL RENOVE',
    'ACCIÓN COMERCIO AMIGO',
    'OTRAS ACCIONES'
];

function renderExclusivosFlop() {
    console.log('renderExclusivosFlop llamada');
    
    // Cargar tabla de cifras
    cargarTablaCifrasExclusivos();
    
    // Cargar tabla de acciones exclusivos
    cargarAccionesExclusivos();
    
    // Cargar AAR
    cargarAAR();
    
    // Cargar tabla de acciones FLOP
    cargarAccionesFlop();
}

// Función para formatear euros
function formatearEuro(valor) {
    if(valor === null || valor === undefined) return '-';
    return new Intl.NumberFormat('es-ES', { 
        style: 'currency', 
        currency: 'EUR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(valor).replace('€', '').trim() + ' €';
}

// Datos actualizados desde Excel - Agosto 2025 a Enero 2026
// 214 centros
const cifrasExclusivos = [
    // 9 CENTROS EXCLUSIVOS - Datos agosto 25 a enero 26 (Nombres oficiales)
    { tipo: 'SUC', cod: '4MRM', tienda: 'REINA DE MERCEDES', vnc: 93655, vncN1: 86079, vsN1: '+8.8%', previsto: 97828, diferencia: -4173, pctProceso: 0 },
    { tipo: 'FR', cod: '4AKI', tienda: 'CC LOS VALLES', vnc: 131246, vncN1: 134520, vsN1: '-2.4%', previsto: 146348, diferencia: -15102, pctProceso: 0 },
    { tipo: 'SUC', cod: '4TOL', tienda: 'TORRELAVEGA CARREFOUR CC', vnc: 86290, vncN1: 103183, vsN1: '-16.4%', previsto: 107786, diferencia: -21496, pctProceso: 0 },
    { tipo: 'SUC', cod: '4PEC', tienda: 'SANTANDER CC PEÑACASTILLO', vnc: 102666, vncN1: 60147, vsN1: '+70.7%', previsto: 75948, diferencia: 26718, pctProceso: 0 },
    { tipo: 'SUC', cod: '4ZDE', tienda: 'ZARAGOZA CALLE DELICIAS', vnc: 49824, vncN1: 60044, vsN1: '-17.0%', previsto: 86533, diferencia: -36709, pctProceso: 0 },
    { tipo: 'FR', cod: '4ABB', tienda: 'PAMPLONA C. EXCLUSIVO', vnc: 57809, vncN1: 13329, vsN1: '+333.7%', previsto: 35244, diferencia: 22565, pctProceso: 0 },
    { tipo: 'FR', cod: '4AXF', tienda: 'SANTIAGO COMPOSTELA RÚA DA ROSA', vnc: 67208, vncN1: 99013, vsN1: '-32.1%', previsto: 104114, diferencia: -36906, pctProceso: 0 },
    { tipo: 'FR', cod: '4AZT', tienda: 'CC PLAZA DE LA ESTACIÓN', vnc: 56564, vncN1: 59510, vsN1: '-4.9%', previsto: 75003, diferencia: -18439, pctProceso: 0 },
    { tipo: 'FR', cod: '4AZP', tienda: 'SEGORBE', vnc: 28637, vncN1: null, vsN1: '', previsto: 30919, diferencia: -2282, pctProceso: 0 }
];

function cargarTablaCifrasExclusivos() {
    const tbody = document.getElementById('tbodyCifrasExclusivos');
    if(!tbody) return;
    
    // Obtener valores de filtros
    const filtroTipo = document.getElementById('filtroTipoExclusivos')?.value || '';
    const filtroPCPNC = document.getElementById('filtroPCPNCExclusivos')?.value || '';
    const filtroResultado = document.getElementById('filtroResultadoExclusivos')?.value || '';
    const buscador = (document.getElementById('buscadorExclusivos')?.value || '').toLowerCase();
    
    // Filtrar datos
    const datosFiltrados = cifrasExclusivos.filter(c => {
        // Filtro tipo (FR/SUC)
        if (filtroTipo && c.tipo !== filtroTipo) return false;
        
        // Filtro PC/PNC - buscar en centrosData
        if (filtroPCPNC) {
            const centro = centrosData.find(cd => cd.c === c.cod);
            const pcStatus = centro?.pc || '';
            if (filtroPCPNC === 'PC' && pcStatus !== 'PC') return false;
            if (filtroPCPNC === 'PNC' && pcStatus !== 'PNC') return false;
        }
        
        // Filtro resultado
        if (filtroResultado === 'positivo' && c.diferencia < 0) return false;
        if (filtroResultado === 'negativo' && c.diferencia >= 0) return false;
        
        // Filtro buscador
        if (buscador && !c.cod.toLowerCase().includes(buscador) && !c.tienda.toLowerCase().includes(buscador)) return false;
        
        return true;
    });
    
    let totalVNC = 0, totalVNCN1 = 0, totalPrevisto = 0, totalDiferencia = 0;
    
    tbody.innerHTML = datosFiltrados.map((c, i) => {
        const colorDif = c.diferencia >= 0 ? '#10b981' : '#ef4444';
        const colorVsN1 = c.vsN1 && c.vsN1.startsWith('-') ? '#ef4444' : '#10b981';
        const colorTipo = c.tipo === 'FR' ? '#C9A227' : '#3b82f6';
        
        totalVNC += c.vnc;
        totalVNCN1 += c.vncN1 || 0;
        totalPrevisto += c.previsto;
        totalDiferencia += c.diferencia;
        
        return `<tr style="border-bottom:1px solid #e0e0e0;${i % 2 === 0 ? 'background:#fafafa' : ''}">
            <td style="padding:5px 4px;font-weight:700;color:${colorTipo}">${c.tipo}</td>
            <td style="padding:5px 4px;font-weight:600">${c.cod}</td>
            <td style="padding:5px 4px;font-size:7px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${c.tienda}">${c.tienda}</td>
            <td style="padding:5px 4px;text-align:right;font-weight:600">${formatearEuro(c.vnc)}</td>
            <td style="padding:5px 4px;text-align:right;color:#666">${c.vncN1 ? formatearEuro(c.vncN1) : '-'}</td>
            <td style="padding:5px 4px;text-align:right;font-weight:600;color:${colorVsN1}">${c.vsN1 || '-'}</td>
            <td style="padding:5px 4px;text-align:right;color:#666">${formatearEuro(c.previsto)}</td>
            <td style="padding:5px 4px;text-align:right;font-weight:600;color:${colorDif}">${c.diferencia >= 0 ? '+' : ''}${formatearEuro(c.diferencia)}</td>
        </tr>`;
    }).join('');
    
    // Totales
    const elTotalVNC = document.getElementById('totalVNC');
    const elTotalVNCN1 = document.getElementById('totalVNCN1');
    const elTotalPrevisto = document.getElementById('totalPrevisto');
    const elTotalDiferencia = document.getElementById('totalDiferencia');
    
    if(elTotalVNC) elTotalVNC.textContent = formatearEuro(totalVNC);
    if(elTotalVNCN1) elTotalVNCN1.textContent = formatearEuro(totalVNCN1);
    if(elTotalPrevisto) elTotalPrevisto.textContent = formatearEuro(totalPrevisto);
    if(elTotalDiferencia) {
        elTotalDiferencia.textContent = (totalDiferencia >= 0 ? '+' : '') + formatearEuro(totalDiferencia);
        elTotalDiferencia.style.color = totalDiferencia >= 0 ? '#10b981' : '#ef4444';
    }
    
    // Actualizar contador
    const contador = document.getElementById('contadorCifrasExclusivos');
    if (contador) contador.textContent = datosFiltrados.length + ' de ' + cifrasExclusivos.length + ' centros';
    
    // Actualizar KPIs del dashboard
    actualizarKPIsVentas(totalVNC, totalPrevisto);
    
    // Actualizar lista del dashboard
    cargarTablaCentrosExclusivosDash();
}

// Cargar lista centros exclusivos en dashboard (9 centros)
function cargarTablaCentrosExclusivosDash() {
    const container = document.getElementById('listaCentrosExclusivos');
    if (!container || typeof cifrasExclusivos === 'undefined') return;
    
    // Mostrar todos los 9 centros exclusivos
    container.innerHTML = cifrasExclusivos.map((c, i) => {
        const pctProceso = c.pctProceso || '-'; // Se rellena con informes de procesos
        const sobrePrevisto = c.diferencia >= 0;
        // Calcular porcentaje: (diferencia / previsto) * 100
        const pctDif = c.previsto > 0 ? Math.abs((c.diferencia / c.previsto) * 100).toFixed(1) : '0.0';
        const signo = sobrePrevisto ? '+' : '-';
        // Solo flecha con tooltip del porcentaje
        const flecha = sobrePrevisto ? 
            `<span style="color:#C9A227;font-size:14px;font-weight:bold;cursor:pointer" title="${signo}${pctDif}%">▲</span>` : 
            `<span style="color:#8B7355;font-size:14px;font-weight:bold;cursor:pointer" title="${signo}${pctDif}%">▼</span>`;
        
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 4px;border-bottom:1px solid #f0f0f0;${i % 2 === 0 ? 'background:#fafafa' : ''}">
            <div style="display:flex;align-items:center;gap:6px;flex:1;min-width:0">
                <span style="font-size:10px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${c.cod} ${c.tienda}</span>
            </div>
            <div style="display:flex;gap:20px;align-items:center">
                <span style="font-size:11px;font-weight:600;color:#666;width:50px;text-align:center">${pctProceso}</span>
                <span style="width:40px;text-align:center">${flecha}</span>
            </div>
        </div>`;
    }).join('');
}

function actualizarKPIsVentas(acumulado, previsto) {
    const diferencia = acumulado - previsto;
    const pct = previsto > 0 ? Math.round((acumulado / previsto) * 100) : 0;
    
    const elAcum = document.getElementById('kpiAcumuladoTotal');
    const elDif = document.getElementById('kpiDiferenciaTotal');
    const elPrev = document.getElementById('kpiPrevistoTotal');
    const elBarra = document.getElementById('barraProgresoTotal');
    const elObj = document.getElementById('kpiObjetivoTotal');
    
    if(elAcum) elAcum.textContent = formatearEuro(acumulado);
    if(elPrev) elPrev.textContent = formatearEuro(previsto);
    if(elDif) {
        elDif.textContent = (diferencia >= 0 ? '+' : '') + formatearEuro(diferencia);
        elDif.style.color = diferencia >= 0 ? '#10b981' : '#ef4444';
    }
    if(elBarra) {
        elBarra.style.width = Math.min(pct, 100) + '%';
        if(pct >= 100) {
            elBarra.style.background = 'linear-gradient(90deg,#10B981,#34D399)';
        } else if(pct >= 80) {
            elBarra.style.background = 'linear-gradient(90deg,#F59E0B,#FBBF24)';
        } else {
            elBarra.style.background = 'linear-gradient(90deg,#EF4444,#F87171)';
        }
    }
    if(elObj) {
        elObj.textContent = pct + '%';
        elObj.style.color = pct >= 100 ? '#10b981' : pct >= 80 ? '#f59e0b' : '#ef4444';
    }
}

// Función para actualizar el donut de formación
function actualizarDonutFormacion(porcentaje) {
    const donut = document.getElementById('donutFormacion');
    const kpiPct = document.getElementById('kpiFormacionPct');
    
    if(donut) {
        // El perímetro del círculo r=14 es 2*PI*14 = 87.96 ≈ 88
        const dashValue = (porcentaje / 100) * 88;
        donut.setAttribute('stroke-dasharray', dashValue + ' 88');
    }
    if(kpiPct) {
        kpiPct.textContent = porcentaje + '%';
    }
}

function guardarCifrasExclusivos() {
    alert('✅ Cifras guardadas correctamente');
}

function filtrarExclusivosFlop() {
    renderExclusivosFlop();
}

// ==================== MÓDULO ACCIONES EXCLUSIVOS ====================
let accionesExclusivosData = [];

function togglePaqueteDetalle(num) {
    const contenido = document.getElementById('contenidoPaq' + num);
    const arrow = document.getElementById('arrowPaq' + num);
    
    if(contenido.style.display === 'none') {
        contenido.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
    } else {
        contenido.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
    }
}

function cargarAccionesExclusivos() {
    accionesExclusivosData = [];
    const exclusivos = cifrasExclusivos.map(c => c.cod);
    
    exclusivos.forEach(cod => {
        const acciones = accionesCentros[cod] || [];
        acciones.forEach(a => {
            accionesExclusivosData.push({
                id: a.id || Date.now(),
                centro: cod,
                fecha: a.fecha || '',
                paquete: a.paquete || '',
                tipo: a.tipo || 'AZAFATA',
                derivaciones: a.derivaciones || 0,
                citas: a.citas || 0,
                ventas: a.ventas || 0,
                observaciones: a.observaciones || a.descripcion || ''
            });
        });
    });
    
    renderTablaAccionesExclusivos();
}

function getSelectCentrosAcciones() {
    return '<option value="">Centro...</option>' + cifrasExclusivos.map(c => '<option value="' + c.cod + '">' + c.cod + '</option>').join('');
}

function getSelectPaquetes(selected) {
    return '<option value="">-</option>' +
        '<option value="1"' + (selected=='1'?' selected':'') + '>🚦 TRÁFICO</option>' +
        '<option value="2"' + (selected=='2'?' selected':'') + '>📚 COMERCIAL</option>' +
        '<option value="3"' + (selected=='3'?' selected':'') + '>👥 EQUIPO</option>';
}

function agregarFilaAccionExclusivos() {
    const hoy = new Date().toISOString().split('T')[0];
    accionesExclusivosData.push({
        id: Date.now(),
        centro: '',
        fecha: hoy,
        paquete: '',
        tipo: 'AZAFATA',
        derivaciones: 0,
        citas: 0,
        ventas: 0,
        formacion: '',
        areaSocial: '',
        observaciones: '',
        visita: ''
    });
    renderTablaAccionesExclusivos();
}

function renderTablaAccionesExclusivos() {
    const tbody = document.getElementById('tbodyAccionesExclusivos');
    if(!tbody) return;
    
    if(accionesExclusivosData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" style="padding:30px;text-align:center;color:#888;font-size:13px">No hay acciones registradas. Haz clic en "+ Nueva Acción"</td></tr>';
        actualizarTotalesAccionesExcl();
        return;
    }
    
    let html = '';
    accionesExclusivosData.forEach(function(a, i) {
        const paqColor = a.paquete === '1' ? '#16a34a' : a.paquete === '2' ? '#2563eb' : a.paquete === '3' ? '#9333ea' : '#ddd';
        const bgColor = i % 2 === 0 ? '#fafafa' : '#fff';
        
        html += '<tr style="border-bottom:1px solid #e0e0e0;background:' + bgColor + '">';
        html += '<td style="padding:5px"><select onchange="updateAccionExcl(' + i + ',\'centro\',this.value)" style="width:100%;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:10px">' + getSelectCentrosAcciones() + '</select></td>';
        html += '<td style="padding:5px"><input type="date" value="' + a.fecha + '" onchange="updateAccionExcl(' + i + ',\'fecha\',this.value)" style="width:100%;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:9px"></td>';
        html += '<td style="padding:5px"><select onchange="updateAccionExcl(' + i + ',\'paquete\',this.value)" style="width:100%;padding:4px;border:2px solid ' + paqColor + ';border-radius:4px;font-size:9px;font-weight:600">' + getSelectPaquetes(a.paquete) + '</select></td>';
        html += '<td style="padding:5px"><select onchange="updateAccionExcl(' + i + ',\'tipo\',this.value)" style="width:100%;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:9px">';
        html += '<option value="AZAFATA"' + (a.tipo==='AZAFATA'?' selected':'') + '>Azafata</option>';
        html += '<option value="BUZONEO"' + (a.tipo==='BUZONEO'?' selected':'') + '>Buzoneo</option>';
        html += '<option value="STAND"' + (a.tipo==='STAND'?' selected':'') + '>Stand</option>';
        html += '<option value="CALL CENTER"' + (a.tipo==='CALL CENTER'?' selected':'') + '>Call Center</option>';
        html += '<option value="MAILING"' + (a.tipo==='MAILING'?' selected':'') + '>Mailing</option>';
        html += '<option value="EVENTO"' + (a.tipo==='EVENTO'?' selected':'') + '>EVENTO</option>';
        html += '<option value="COLABORACIÓN"' + (a.tipo==='COLABORACIÓN'?' selected':'') + '>COLABORACIÓN</option>';
        html += '<option value="FORMACIÓN"' + (a.tipo==='FORMACIÓN'?' selected':'') + '>FORMACIÓN</option>';
        html += '<option value="VISITA"' + (a.tipo==='VISITA'?' selected':'') + '>VISITA</option>';
        html += '<option value="OTRO"' + (a.tipo==='OTRO'?' selected':'') + '>OTRO</option>';
        html += '</select></td>';
        html += '<td style="padding:5px"><input type="number" value="' + a.derivaciones + '" onchange="updateAccionExcl(' + i + ',\'derivaciones\',this.value)" min="0" style="width:100%;padding:4px;border:2px solid #f59e0b;border-radius:4px;font-size:10px;text-align:center;font-weight:700;background:#fffbeb"></td>';
        html += '<td style="padding:5px"><input type="number" value="' + a.citas + '" onchange="updateAccionExcl(' + i + ',\'citas\',this.value)" min="0" style="width:100%;padding:4px;border:2px solid #3b82f6;border-radius:4px;font-size:10px;text-align:center;font-weight:700;background:#eff6ff"></td>';
        html += '<td style="padding:5px"><input type="number" value="' + a.ventas + '" onchange="updateAccionExcl(' + i + ',\'ventas\',this.value)" min="0" style="width:100%;padding:4px;border:2px solid #10b981;border-radius:4px;font-size:10px;text-align:center;font-weight:700;background:#ecfdf5"></td>';
        // FORMACIÓN - Color dorado (cada Aplica = 25%)
        html += '<td style="padding:5px"><select onchange="updateAccionExcl(' + i + ',\'formacion\',this.value)" style="width:100%;padding:4px;border:2px solid #C9A227;border-radius:4px;font-size:9px;font-weight:600;background:#fffbeb">';
        html += '<option value=""' + (!a.formacion?' selected':'') + '>-</option>';
        html += '<option value="APLICA1"' + (a.formacion==='APLICA1'?' selected':'') + '>Aplica 1</option>';
        html += '<option value="APLICA2"' + (a.formacion==='APLICA2'?' selected':'') + '>Aplica 2</option>';
        html += '<option value="APLICA3"' + (a.formacion==='APLICA3'?' selected':'') + '>Aplica 3</option>';
        html += '<option value="APLICA4"' + (a.formacion==='APLICA4'?' selected':'') + '>Aplica 4</option>';
        html += '</select></td>';
        // ÁREA SOCIAL - Color dorado
        html += '<td style="padding:5px"><select onchange="updateAccionExcl(' + i + ',\'areaSocial\',this.value)" style="width:100%;padding:4px;border:2px solid #C9A227;border-radius:4px;font-size:9px;font-weight:600;background:#fffbeb">';
        html += '<option value=""' + (!a.areaSocial?' selected':'') + '>-</option>';
        html += '<option value="COLABORACIONES"' + (a.areaSocial==='COLABORACIONES'?' selected':'') + '>Colaboraciones</option>';
        html += '<option value="AYUDAS"' + (a.areaSocial==='AYUDAS'?' selected':'') + '>Ayudas</option>';
        html += '<option value="AYUDAS-COLABORACIONES"' + (a.areaSocial==='AYUDAS-COLABORACIONES'?' selected':'') + '>Ayudas-Colabor.</option>';
        html += '</select></td>';
        html += '<td style="padding:5px"><input type="text" value="' + (a.observaciones || '') + '" onchange="updateAccionExcl(' + i + ',\'observaciones\',this.value)" placeholder="Obs..." style="width:100%;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:9px"></td>';
        // VISITA - Color dorado
        html += '<td style="padding:5px"><select onchange="updateAccionExcl(' + i + ',\'visita\',this.value)" style="width:100%;padding:4px;border:2px solid #C9A227;border-radius:4px;font-size:9px;font-weight:600;background:#fffbeb">';
        html += '<option value=""' + (!a.visita?' selected':'') + '>-</option>';
        html += '<option value="T1"' + (a.visita==='T1'?' selected':'') + '>1º Trim.</option>';
        html += '<option value="T2"' + (a.visita==='T2'?' selected':'') + '>2º Trim.</option>';
        html += '<option value="T3"' + (a.visita==='T3'?' selected':'') + '>3º Trim.</option>';
        html += '<option value="T4"' + (a.visita==='T4'?' selected':'') + '>4º Trim.</option>';
        html += '</select></td>';
        html += '<td style="padding:5px;text-align:center"><button onclick="eliminarAccionExcl(' + i + ')" style="padding:4px 6px;background:#fee2e2;border:1px solid #fca5a5;border-radius:4px;cursor:pointer;font-size:10px">🗑️</button></td>';
        html += '</tr>';
    });
    
    tbody.innerHTML = html;
    
    // Establecer valores de centro en los selects
    setTimeout(function() {
        accionesExclusivosData.forEach(function(a, i) {
            if(a.centro) {
                var rows = tbody.querySelectorAll('tr');
                if(rows[i]) {
                    var sel = rows[i].querySelector('select');
                    if(sel) sel.value = a.centro;
                }
            }
        });
    }, 10);
    
    actualizarTotalesAccionesExcl();
}

function updateAccionExcl(i, campo, valor) {
    if(accionesExclusivosData[i]) {
        if(['derivaciones','citas','ventas'].includes(campo)) {
            accionesExclusivosData[i][campo] = parseInt(valor) || 0;
        } else {
            accionesExclusivosData[i][campo] = valor;
        }
        actualizarTotalesAccionesExcl();
        guardarAccionesExclusivos();
    }
}

function eliminarAccionExcl(i) {
    if(confirm('¿Eliminar esta acción?')) {
        accionesExclusivosData.splice(i, 1);
        renderTablaAccionesExclusivos();
        guardarAccionesExclusivos();
    }
}

function actualizarTotalesAccionesExcl() {
    let d = 0, c = 0, v = 0;
    let formacionCount = 0; // Cuenta cuántos Aplica se han seleccionado
    let areaSocialCount = 0;
    let visitasT1 = 0, visitasT2 = 0, visitasT3 = 0, visitasT4 = 0;
    
    accionesExclusivosData.forEach(a => {
        d += parseInt(a.derivaciones) || 0;
        c += parseInt(a.citas) || 0;
        v += parseInt(a.ventas) || 0;
        
        // Calcular formación (cada Aplica = 25%, se suman)
        if(a.formacion === 'APLICA1') formacionCount++;
        else if(a.formacion === 'APLICA2') formacionCount++;
        else if(a.formacion === 'APLICA3') formacionCount++;
        else if(a.formacion === 'APLICA4') formacionCount++;
        
        // Contar área social
        if(a.areaSocial) areaSocialCount++;
        
        // Contar visitas por trimestre
        if(a.visita === 'T1') visitasT1++;
        else if(a.visita === 'T2') visitasT2++;
        else if(a.visita === 'T3') visitasT3++;
        else if(a.visita === 'T4') visitasT4++;
    });
    
    const totalVisitas = visitasT1 + visitasT2 + visitasT3 + visitasT4;
    // Cada Aplica es 25%, máximo 100% (4 aplicas)
    const porcentajeFormacion = Math.min(formacionCount * 25, 100);
    
    const elD = document.getElementById('totalDerivAcciones');
    const elC = document.getElementById('totalCitasAcciones');
    const elV = document.getElementById('totalVentasAcciones');
    const elForm = document.getElementById('totalFormacionAcciones');
    const elAreaSocial = document.getElementById('totalAreaSocial');
    const elVis = document.getElementById('totalVisitasAcciones');
    
    if(elD) elD.textContent = d;
    if(elC) elC.textContent = c;
    if(elV) elV.textContent = v;
    if(elForm) elForm.textContent = porcentajeFormacion + '%';
    if(elAreaSocial) elAreaSocial.textContent = areaSocialCount;
    if(elVis) elVis.textContent = totalVisitas;
    
    // Actualizar KPIs del dashboard
    const numAcciones = accionesExclusivosData.length;
    const elKpiAcciones = document.getElementById('kpiAcciones');
    const elKpiDeriv = document.getElementById('kpiDerivaciones');
    const elKpiCitas = document.getElementById('kpiCitas');
    const elKpiVentas = document.getElementById('kpiVentas');
    const elKpiConversion = document.getElementById('kpiConversion');
    
    if(elKpiAcciones) elKpiAcciones.textContent = numAcciones;
    if(elKpiDeriv) elKpiDeriv.textContent = d;
    if(elKpiCitas) elKpiCitas.textContent = c;
    if(elKpiVentas) elKpiVentas.textContent = v;
    
    // Calcular conversión
    if(elKpiConversion) {
        var conversion = numAcciones > 0 ? (d / numAcciones).toFixed(1) : '0.0';
        elKpiConversion.textContent = conversion;
    }
    
    // Actualizar barras horizontales de acciones
    var maxVal = Math.max(d, c, v, 1);
    var barDeriv = document.getElementById('barDeriv');
    var barCitas = document.getElementById('barCitas');
    var barVentas = document.getElementById('barVentas');
    
    if(barDeriv) barDeriv.style.width = (d / maxVal * 100) + '%';
    if(barCitas) barCitas.style.width = (c / maxVal * 100) + '%';
    if(barVentas) barVentas.style.width = (v / maxVal * 100) + '%';
    
    // Actualizar donut de formación
    actualizarDonutFormacion(porcentajeFormacion);
    
    // Actualizar KPI de visitas trimestral
    var elKpiVisitas = document.getElementById('kpiVisitas');
    if(elKpiVisitas) elKpiVisitas.textContent = totalVisitas;
    
    // Actualizar barras trimestrales
    var maxTrim = Math.max(visitasT1, visitasT2, visitasT3, visitasT4, 1);
    var barT1 = document.getElementById('barT1');
    var barT2 = document.getElementById('barT2');
    var barT3 = document.getElementById('barT3');
    var barT4 = document.getElementById('barT4');
    
    if(barT1) barT1.style.height = (visitasT1 / maxTrim * 100) + '%';
    if(barT2) barT2.style.height = (visitasT2 / maxTrim * 100) + '%';
    if(barT3) barT3.style.height = (visitasT3 / maxTrim * 100) + '%';
    if(barT4) barT4.style.height = (visitasT4 / maxTrim * 100) + '%';
    
    // Actualizar contadores trimestrales
    var elT1 = document.getElementById('kpiT1');
    var elT2 = document.getElementById('kpiT2');
    var elT3 = document.getElementById('kpiT3');
    var elT4 = document.getElementById('kpiT4');
    
    if(elT1) elT1.textContent = 'T1: ' + visitasT1;
    if(elT2) elT2.textContent = 'T2: ' + visitasT2;
    if(elT3) elT3.textContent = 'T3: ' + visitasT3;
    if(elT4) elT4.textContent = 'T4: ' + visitasT4;
}

function guardarAccionesExclusivos() {
    var porCentro = {};
    accionesExclusivosData.forEach(function(a) {
        if(a.centro) {
            if(!porCentro[a.centro]) porCentro[a.centro] = [];
            porCentro[a.centro].push({
                id: a.id,
                fecha: a.fecha,
                paquete: a.paquete,
                tipo: a.tipo,
                derivaciones: a.derivaciones,
                citas: a.citas,
                ventas: a.ventas,
                observaciones: a.observaciones,
                descripcion: a.observaciones
            });
        }
    });
    
    Object.keys(porCentro).forEach(function(cod) {
        accionesCentros[cod] = porCentro[cod];
    });
    
    localStorage.setItem('accionesCentros', JSON.stringify(accionesCentros));
}

// ==================== MÓDULO AAR ====================
var aarData = [];

// Datos iniciales del Excel (58 registros actualizados)
var aarDataInicial = [
    {id:1,fechaCita:'2025-07-08',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'Si',pruebaAudifonos:'No',cierrePrueba:'',pvp:'',nps:9},
    {id:2,fechaCita:'2025-06-03',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'-',revisionPerdida:'Ajuste post venta',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:9},
    {id:3,fechaCita:'2025-06-04',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'Ajuste post venta',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:9},
    {id:4,fechaCita:'2025-06-16',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'Ajuste post venta',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:9},
    {id:5,fechaCita:'2025-07-04',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'Si',pruebaAudifonos:'No',cierrePrueba:'',pvp:'',nps:''},
    {id:6,fechaCita:'2025-07-01',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'No',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:9},
    {id:7,fechaCita:'2025-07-01',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'No',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:''},
    {id:8,fechaCita:'2025-06-30',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'Si',pruebaAudifonos:'No',cierrePrueba:'',pvp:'',nps:10},
    {id:9,fechaCita:'2025-06-30',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:10,fechaCita:'2025-06-27',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:11,fechaCita:'2025-06-26',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:''},
    {id:12,fechaCita:'2025-06-21',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Compra Audífonos',pvp:'3295',nps:10},
    {id:13,fechaCita:'2025-06-19',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'Si',pruebaAudifonos:'No',cierrePrueba:'',pvp:'',nps:9},
    {id:14,fechaCita:'2025-06-17',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:15,fechaCita:'2025-06-17',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:16,fechaCita:'2025-06-11',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:9},
    {id:17,fechaCita:'2025-07-11',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'Si',pruebaAudifonos:'No',cierrePrueba:'',pvp:'',nps:10},
    {id:18,fechaCita:'2025-06-06',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'PLAZA ESTACION 4FPE',tiendaDestino:'GIRONA Plaza Miguel Santaló I Parvorell',revisionPerdida:'',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:19,fechaCita:'2025-06-12',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA-4FIG',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'No',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:20,fechaCita:'2025-06-13',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'Si',pruebaAudifonos:'No',cierrePrueba:'',pvp:'',nps:10},
    {id:21,fechaCita:'2025-06-17',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'No',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:22,fechaCita:'2025-06-17',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'No',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:23,fechaCita:'2025-06-18',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA-4FIG',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'No',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:24,fechaCita:'2025-06-20',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'No',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:25,fechaCita:'2025-06-26',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'Si',pruebaAudifonos:'No',cierrePrueba:'',pvp:'',nps:10},
    {id:26,fechaCita:'2025-06-30',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Compra Audífonos',pvp:'3385',nps:10},
    {id:27,fechaCita:'2025-06-30',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Compra Audífonos',pvp:'3895',nps:10},
    {id:28,fechaCita:'2025-07-01',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA-4FIG',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'No',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:29,fechaCita:'2025-07-04',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'GERONA-4FIG',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Compra Audífonos',pvp:'3295',nps:9},
    {id:30,fechaCita:'2025-07-04',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'GERONA MIGUEL SANTALO',tiendaDestino:'TORRELAVEGA CARREFOUR CC',revisionPerdida:'No',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:9},
    {id:31,fechaCita:'2025-07-16',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'No',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:32,fechaCita:'2025-09-23',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'Ajuste post venta',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:33,fechaCita:'2025-09-23',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'Si',pruebaAudifonos:'No',cierrePrueba:'',pvp:'',nps:10},
    {id:34,fechaCita:'2025-09-25',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'Si',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:35,fechaCita:'2025-09-25',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'Si',pruebaAudifonos:'No',cierrePrueba:'',pvp:'',nps:10},
    {id:36,fechaCita:'2025-09-30',servicio:'Primera Visita',estado:'Abierto',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'4ZMZ',revisionPerdida:'',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:''},
    {id:37,fechaCita:'2025-09-30',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'Madrid Lagavia',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Compra Audífonos',pvp:'3895',nps:10},
    {id:38,fechaCita:'2025-10-02',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'Si',pruebaAudifonos:'No',cierrePrueba:'',pvp:'',nps:10},
    {id:39,fechaCita:'2025-10-02',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'Si',pruebaAudifonos:'No',cierrePrueba:'',pvp:'',nps:10},
    {id:40,fechaCita:'2025-10-07',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Compra Audífonos',pvp:'3201',nps:10},
    {id:41,fechaCita:'2025-10-09',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Compra Audífonos',pvp:'3896',nps:10},
    {id:42,fechaCita:'2025-10-10',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'FUENLABRADA ESTACION',revisionPerdida:'Si',pruebaAudifonos:'No',cierrePrueba:'',pvp:'',nps:10},
    {id:43,fechaCita:'2025-10-21',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Compra Audífonos',pvp:'1991',nps:10},
    {id:44,fechaCita:'2025-10-31',servicio:'Primera Visita',estado:'En curso',tiendaOrigen:'4PEC',tiendaDestino:'SANTANDER CC PEÑACASTILLO',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Compra Audífonos',pvp:'3696',nps:''},
    {id:45,fechaCita:'2025-06-10',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'GERONA-4FIG',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'No',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:46,fechaCita:'2025-10-14',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Compra Audífonos',pvp:'3896',nps:9},
    {id:47,fechaCita:'2025-10-14',servicio:'Primera Visita',estado:'En curso',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Compra Audífonos',pvp:'3646',nps:''},
    {id:48,fechaCita:'2025-10-20',servicio:'Primera Visita',estado:'En curso',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'CC PLAZA DE LA ESTACIÓN',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Compra Audífonos',pvp:'3896',nps:''},
    {id:49,fechaCita:'2025-11-10',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'lanzadera',tiendaDestino:'4ZMZ',revisionPerdida:'No',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:50,fechaCita:'2025-11-14',servicio:'Primera Visita',estado:'Cerrado',tiendaOrigen:'lanzadera',tiendaDestino:'4ZMZ',revisionPerdida:'No',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:10},
    {id:51,fechaCita:'2025-11-13',servicio:'Ajustes',estado:'Cerrado',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'SANTANDER CC PEÑACASTILLO',revisionPerdida:'Ajuste post venta',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:''},
    {id:52,fechaCita:'2025-11-24',servicio:'Primera Visita',estado:'En curso',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'SANTANDER CC PEÑACASTILLO',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Probando',pvp:'3995',nps:''},
    {id:53,fechaCita:'2025-12-02',servicio:'Seguimiento En Prueba',estado:'En curso',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'SANTANDER CC PEÑACASTILLO',revisionPerdida:'',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:''},
    {id:54,fechaCita:'2025-11-26',servicio:'Primera Visita',estado:'En curso',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'ARANJUEZ Calle San Antonio',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Probando',pvp:'3995',nps:''},
    {id:55,fechaCita:'2025-12-09',servicio:'Primera Visita',estado:'En curso',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'ARANJUEZ Calle San Antonio',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Probando',pvp:'3996',nps:''},
    {id:56,fechaCita:'2025-12-09',servicio:'Primera Visita',estado:'En curso',tiendaOrigen:'Madrid Aranjuez',tiendaDestino:'ARANJUEZ Calle San Antonio',revisionPerdida:'Si',pruebaAudifonos:'Si',cierrePrueba:'Compra Audífonos',pvp:'3796',nps:''},
    {id:57,fechaCita:'2026-01-26',servicio:'Primera Visita',estado:'En curso',tiendaOrigen:'',tiendaDestino:'4ZST',revisionPerdida:'',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:''},
    {id:58,fechaCita:'2026-01-27',servicio:'Primera Visita',estado:'En curso',tiendaOrigen:'',tiendaDestino:'4TCR',revisionPerdida:'',pruebaAudifonos:'',cierrePrueba:'',pvp:'',nps:''},
];
function cargarAAR() {
    // SIEMPRE cargar los 58 registros del Excel actualizado
    aarData = aarDataInicial.slice();
    aarDataFiltrada = aarData.slice();
    localStorage.setItem('aarData', JSON.stringify(aarData));
    
    renderTablaAAR();
    actualizarDashboardAAR();
    actualizarPanelesCentros();
    cargarSelectsFiltros();
    
    // Actualizar contadores
    var elContador = document.getElementById('aarContadorFiltro');
    var elTotal = document.getElementById('aarContadorTotal');
    var elEditorCount = document.getElementById('editorExcelCount');
    if(elContador) elContador.textContent = aarData.length;
    if(elTotal) elTotal.textContent = aarData.length;
    if(elEditorCount) elEditorCount.textContent = aarData.length + ' registros';
}

function resetearAAR() {
    localStorage.removeItem('aarData');
    aarData = aarDataInicial.slice();
    aarDataFiltrada = aarData.slice();
    localStorage.setItem('aarData', JSON.stringify(aarData));
    renderTablaAAR();
    actualizarDashboardAAR();
    actualizarPanelesCentros();
    cargarSelectsFiltros();
    limpiarFiltrosAAR();
    // Actualizar editor si está visible
    var editorContent = document.getElementById('editorExcelContent');
    if (editorContent && editorContent.style.display !== 'none') {
        renderTablaEditorExcelAAR();
    }
    var elEditorCount = document.getElementById('editorExcelCount');
    if (elEditorCount) elEditorCount.textContent = aarData.length + ' registros';
    alert('✅ Datos AAR reseteados (' + aarData.length + ' registros)');
}

function mostrarFormularioAAR() {
    var modal = document.getElementById('modalAAR');
    if(modal) {
        modal.style.display = 'flex';
        // Fecha por defecto: hoy
        var hoy = new Date().toISOString().split('T')[0];
        document.getElementById('aarFormFecha').value = hoy;
        // Limpiar campos
        document.getElementById('aarFormServicio').value = 'Primera Visita';
        document.getElementById('aarFormEstado').value = 'Abierto';
        document.getElementById('aarFormOrigen').value = '';
        document.getElementById('aarFormDestino').value = '';
        document.getElementById('aarFormRevision').value = '';
        document.getElementById('aarFormPrueba').value = 'No';
        document.getElementById('aarFormCierre').value = '';
        document.getElementById('aarFormPVP').value = '';
        document.getElementById('aarFormNPS').value = '';
    }
}

function cerrarModalAAR() {
    var modal = document.getElementById('modalAAR');
    if(modal) modal.style.display = 'none';
}

function guardarNuevoAAR() {
    var fecha = document.getElementById('aarFormFecha').value;
    var servicio = document.getElementById('aarFormServicio').value;
    var estado = document.getElementById('aarFormEstado').value;
    var origen = document.getElementById('aarFormOrigen').value.trim();
    var destino = document.getElementById('aarFormDestino').value.trim();
    var revision = document.getElementById('aarFormRevision').value;
    var prueba = document.getElementById('aarFormPrueba').value;
    var cierre = document.getElementById('aarFormCierre').value;
    var pvp = document.getElementById('aarFormPVP').value;
    var nps = document.getElementById('aarFormNPS').value;
    
    if(!fecha || !origen || !destino) {
        alert('Por favor completa: Fecha, Tienda Origen y Tienda Destino');
        return;
    }
    
    // Formatear fecha y hora actual
    var ahora = new Date();
    var fechaObj = new Date(fecha);
    var meses = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    var fechaFormateada = fechaObj.getFullYear() + '-' + meses[fechaObj.getMonth()] + '-' + String(fechaObj.getDate()).padStart(2,'0');
    
    // Hora actual
    var horaFormateada = String(ahora.getHours()).padStart(2,'0') + ':' + String(ahora.getMinutes()).padStart(2,'0');
    
    var nuevoRegistro = {
        id: Date.now(),
        fechaCita: fechaFormateada,
        horaRegistro: horaFormateada,
        fechaRegistro: ahora.toLocaleDateString('es-ES'),
        servicio: servicio,
        estado: estado,
        tiendaOrigen: origen,
        tiendaDestino: destino,
        revisionPerdida: revision,
        pruebaAudifonos: prueba,
        cierrePrueba: cierre,
        pvp: pvp,
        nps: nps ? parseInt(nps) : ''
    };
    
    aarData.unshift(nuevoRegistro);
    aarDataFiltrada = aarData.slice();
    guardarAAR();
    renderTablaAAR();
    actualizarDashboardAAR();
    actualizarPanelesCentros();
    cargarSelectsFiltros();
    cerrarModalAAR();
    
    // Actualizar contadores
    var elContador = document.getElementById('aarContadorFiltro');
    var elTotal = document.getElementById('aarContadorTotal');
    if(elContador) elContador.textContent = aarData.length;
    if(elTotal) elTotal.textContent = aarData.length;
    
    alert('✅ Servicio añadido: ' + fechaFormateada + ' a las ' + horaFormateada);
}

function agregarActividadAAR() {
    mostrarFormularioAAR();
}

var aarDataFiltrada = [];
// Inicializar aarData con los datos del Excel al cargar
aarData = aarDataInicial.slice();
// Actualizar contador del faldón
setTimeout(function() {
    var elCount = document.getElementById('editorExcelCount');
    if (elCount) elCount.textContent = aarData.length + ' registros';
}, 100);

function cargarSelectsFiltros() {
    var origenes = {};
    var destinos = {};
    aarData.forEach(function(a) {
        if(a.tiendaOrigen) origenes[a.tiendaOrigen] = true;
        if(a.tiendaDestino) destinos[a.tiendaDestino] = true;
    });
    
    var selOrigen = document.getElementById('aarFiltroOrigen');
    var selDestino = document.getElementById('aarFiltroDestino');
    
    if(selOrigen) {
        selOrigen.innerHTML = '<option value="">Todos</option>';
        Object.keys(origenes).sort().forEach(function(o) {
            selOrigen.innerHTML += '<option value="' + o + '">' + o + '</option>';
        });
    }
    
    if(selDestino) {
        selDestino.innerHTML = '<option value="">Todos</option>';
        Object.keys(destinos).sort().forEach(function(d) {
            selDestino.innerHTML += '<option value="' + d + '">' + d + '</option>';
        });
    }
}

function parsearFechaAAR(fechaStr) {
    // Formato: 2025-Jul-08 o 2025-06-03
    if(!fechaStr) return null;
    var meses = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
    var partes = fechaStr.split('-');
    if(partes.length === 3) {
        var year = parseInt(partes[0]);
        var month = meses[partes[1]] !== undefined ? meses[partes[1]] : parseInt(partes[1]) - 1;
        var day = parseInt(partes[2]);
        return new Date(year, month, day);
    }
    return null;
}

function filtrarTablaAAR() {
    var filtroDesde = document.getElementById('aarFiltroDesde').value;
    var filtroHasta = document.getElementById('aarFiltroHasta').value;
    var filtroServicio = document.getElementById('aarFiltroServicio').value;
    var filtroEstado = document.getElementById('aarFiltroEstado').value;
    var filtroOrigen = document.getElementById('aarFiltroOrigen').value;
    var filtroDestino = document.getElementById('aarFiltroDestino').value;
    var filtroRevision = document.getElementById('aarFiltroRevision').value;
    var filtroCierre = document.getElementById('aarFiltroCierre').value;
    
    var fechaDesde = filtroDesde ? new Date(filtroDesde) : null;
    var fechaHasta = filtroHasta ? new Date(filtroHasta) : null;
    
    aarDataFiltrada = aarData.filter(function(a) {
        // Filtro fecha
        if(fechaDesde || fechaHasta) {
            var fechaReg = parsearFechaAAR(a.fechaCita);
            if(fechaReg) {
                if(fechaDesde && fechaReg < fechaDesde) return false;
                if(fechaHasta && fechaReg > fechaHasta) return false;
            }
        }
        
        // Filtro servicio
        if(filtroServicio && a.servicio !== filtroServicio) return false;
        
        // Filtro estado
        if(filtroEstado && a.estado !== filtroEstado) return false;
        
        // Filtro origen
        if(filtroOrigen && a.tiendaOrigen !== filtroOrigen) return false;
        
        // Filtro destino
        if(filtroDestino && a.tiendaDestino !== filtroDestino) return false;
        
        // Filtro revisión
        if(filtroRevision && a.revisionPerdida !== filtroRevision) return false;
        
        // Filtro cierre
        if(filtroCierre) {
            if(filtroCierre === 'sin_cierre') {
                if(a.cierrePrueba && a.cierrePrueba !== '') return false;
            } else {
                if(a.cierrePrueba !== filtroCierre) return false;
            }
        }
        
        return true;
    });
    
    renderTablaAARFiltrada();
    actualizarDashboardAARFiltrado();
    actualizarPanelesCentrosFiltrado();
    
    // Actualizar contador
    var elContador = document.getElementById('aarContadorFiltro');
    var elTotal = document.getElementById('aarContadorTotal');
    if(elContador) elContador.textContent = aarDataFiltrada.length;
    if(elTotal) elTotal.textContent = aarData.length;
}

function limpiarFiltrosAAR() {
    document.getElementById('aarFiltroDesde').value = '';
    document.getElementById('aarFiltroHasta').value = '';
    document.getElementById('aarFiltroServicio').value = '';
    document.getElementById('aarFiltroEstado').value = '';
    document.getElementById('aarFiltroOrigen').value = '';
    document.getElementById('aarFiltroDestino').value = '';
    document.getElementById('aarFiltroRevision').value = '';
    document.getElementById('aarFiltroCierre').value = '';
    aarDataFiltrada = aarData.slice();
    renderTablaAAR();
    actualizarDashboardAAR();
    actualizarPanelesCentros();
    var elContador = document.getElementById('aarContadorFiltro');
    var elTotal = document.getElementById('aarContadorTotal');
    if(elContador) elContador.textContent = aarData.length;
    if(elTotal) elTotal.textContent = aarData.length;
}

function renderTablaAARFiltrada() {
    var tbody = document.getElementById('tbodyAAR');
    if(!tbody) return;
    
    if(aarDataFiltrada.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="padding:30px;text-align:center;color:#888;font-size:13px">No hay registros con los filtros seleccionados</td></tr>';
        return;
    }
    
    var html = '';
    aarDataFiltrada.forEach(function(a, idx) {
        // Encontrar índice real en aarData
        var realIdx = aarData.findIndex(function(item) { return item.id === a.id; });
        
        var estadoColor = a.estado === 'Cerrado' ? '#333' : a.estado === 'En curso' ? '#C9A227' : '#888';
        var estadoBg = a.estado === 'Cerrado' ? '#f0f0f0' : a.estado === 'En curso' ? '#fffbeb' : '#fff';
        
        html += '<tr style="border-bottom:1px solid #eee;background:' + (idx % 2 === 0 ? '#fff' : '#fafafa') + '">';
        html += '<td style="padding:8px 6px;font-size:10px">' + (a.fechaCita || '') + '</td>';
        html += '<td style="padding:8px 6px"><select onchange="updateAAR(' + realIdx + ',\'servicio\',this.value)" style="padding:4px;border:1px solid #ddd;border-radius:4px;font-size:9px;width:100%">';
        html += '<option value="Primera Visita"' + (a.servicio === 'Primera Visita' ? ' selected' : '') + '>Primera Visita</option>';
        html += '<option value="Ajustes"' + (a.servicio === 'Ajustes' ? ' selected' : '') + '>Ajustes</option></select></td>';
        html += '<td style="padding:8px 6px;text-align:center"><span style="background:' + estadoBg + ';color:' + estadoColor + ';padding:3px 8px;border-radius:10px;font-size:9px;font-weight:600">' + (a.estado || '') + '</span></td>';
        html += '<td style="padding:8px 6px;font-size:9px">' + (a.tiendaOrigen || '') + '</td>';
        html += '<td style="padding:8px 6px;font-size:9px">' + (a.tiendaDestino || '') + '</td>';
        html += '<td style="padding:8px 6px;text-align:center"><select onchange="updateAAR(' + realIdx + ',\'revisionPerdida\',this.value)" style="padding:4px;border:1px solid #ddd;border-radius:4px;font-size:9px">';
        html += '<option value=""' + (!a.revisionPerdida ? ' selected' : '') + '>--</option>';
        html += '<option value="Si"' + (a.revisionPerdida === 'Si' ? ' selected' : '') + '>Sí</option>';
        html += '<option value="No"' + (a.revisionPerdida === 'No' ? ' selected' : '') + '>No</option>';
        html += '<option value="Ajuste post venta"' + (a.revisionPerdida === 'Ajuste post venta' ? ' selected' : '') + '>Post venta</option></select></td>';
        html += '<td style="padding:8px 6px;text-align:center"><select onchange="updateAAR(' + realIdx + ',\'pruebaAudifonos\',this.value)" style="padding:4px;border:1px solid #ddd;border-radius:4px;font-size:9px">';
        html += '<option value="No"' + (a.pruebaAudifonos !== 'Si' ? ' selected' : '') + '>No</option>';
        html += '<option value="Si"' + (a.pruebaAudifonos === 'Si' ? ' selected' : '') + '>Sí</option></select></td>';
        html += '<td style="padding:8px 6px;text-align:center"><select onchange="updateAAR(' + realIdx + ',\'cierrePrueba\',this.value)" style="padding:4px;border:1px solid #ddd;border-radius:4px;font-size:9px">';
        html += '<option value=""' + (!a.cierrePrueba ? ' selected' : '') + '>--</option>';
        html += '<option value="Compra Audífonos"' + (a.cierrePrueba === 'Compra Audífonos' ? ' selected' : '') + '>Compra</option>';
        html += '<option value="Devuelve"' + (a.cierrePrueba === 'Devuelve' ? ' selected' : '') + '>Devuelve</option></select></td>';
        html += '<td style="padding:8px 6px;text-align:right"><input type="number" value="' + (a.pvp || '') + '" onchange="updateAAR(' + realIdx + ',\'pvp\',this.value)" style="width:55px;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:9px;text-align:right"></td>';
        html += '<td style="padding:8px 6px;text-align:center"><input type="number" min="0" max="10" value="' + (a.nps || '') + '" onchange="updateAAR(' + realIdx + ',\'nps\',this.value)" style="width:40px;padding:4px;border:1px solid #C9A227;border-radius:4px;font-size:9px;text-align:center"></td>';
        html += '<td style="padding:8px 6px;text-align:center"><button onclick="eliminarAAR(' + realIdx + ')" style="background:#555;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px">🗑️</button></td>';
        html += '</tr>';
    });
    
    tbody.innerHTML = html;
}

function actualizarDashboardAARFiltrado() {
    var datos = aarDataFiltrada.length > 0 ? aarDataFiltrada : aarData;
    actualizarDashboardConDatos(datos);
}

function actualizarPanelesCentrosFiltrado() {
    var datos = aarDataFiltrada.length > 0 ? aarDataFiltrada : aarData;
    actualizarPanelesConDatos(datos);
}

function actualizarDashboardConDatos(datos) {
    var conPerdida = 0, postVenta = 0, sinPerdida = 0;
    var prueban = 0, compran = 0, devuelven = 0;
    var npsTotal = 0, npsCount = 0;
    var facturacionTotal = 0, ventasConPVP = 0;
    
    datos.forEach(function(a) {
        if(a.revisionPerdida === 'Si') conPerdida++;
        else if(a.revisionPerdida === 'Ajuste post venta') postVenta++;
        else if(a.revisionPerdida === 'No') sinPerdida++;
        
        if(a.pruebaAudifonos === 'Si') prueban++;
        if(a.cierrePrueba === 'Compra Audífonos') {
            compran++;
            if(a.pvp && !isNaN(parseFloat(a.pvp)) && parseFloat(a.pvp) > 0) {
                facturacionTotal += parseFloat(a.pvp);
                ventasConPVP++;
            }
        }
        if(a.cierrePrueba === 'Devuelve') devuelven++;
        
        if(a.nps && !isNaN(a.nps) && a.nps !== '') {
            npsTotal += parseFloat(a.nps);
            npsCount++;
        }
    });
    
    var totalRevisiones = conPerdida + postVenta + sinPerdida;
    var npsPromedio = npsCount > 0 ? (npsTotal / npsCount).toFixed(1) : '0';
    var ticketMedio = ventasConPVP > 0 ? Math.round(facturacionTotal / ventasConPVP) : 0;
    var pctPrueban = conPerdida > 0 ? Math.round((prueban / conPerdida) * 100) : 0;
    var pctCompran = prueban > 0 ? Math.round((compran / prueban) * 100) : 0;
    var pctDevuelven = prueban > 0 ? Math.round((devuelven / prueban) * 100) : 0;
    var convNeta = conPerdida > 0 ? Math.round(((compran - devuelven) / conPerdida) * 100) : 0;
    
    var elTotal = document.getElementById('aarTotalRevisiones');
    if(elTotal) elTotal.textContent = totalRevisiones;
    
    var maxVal = totalRevisiones > 0 ? totalRevisiones : 1;
    var elBarCP = document.getElementById('aarBarConPerdida');
    var elBarPV = document.getElementById('aarBarPostVenta');
    var elBarSP = document.getElementById('aarBarSinPerdida');
    var elBarCPF = document.getElementById('aarBarConPerdidaFill');
    var elBarPVF = document.getElementById('aarBarPostVentaFill');
    var elBarSPF = document.getElementById('aarBarSinPerdidaFill');
    
    if(elBarCP) elBarCP.textContent = conPerdida;
    if(elBarPV) elBarPV.textContent = postVenta;
    if(elBarSP) elBarSP.textContent = sinPerdida;
    if(elBarCPF) elBarCPF.style.width = ((conPerdida / maxVal) * 100) + '%';
    if(elBarPVF) elBarPVF.style.width = ((postVenta / maxVal) * 100) + '%';
    if(elBarSPF) elBarSPF.style.width = ((sinPerdida / maxVal) * 100) + '%';
    
    var elFunPer = document.getElementById('aarFunnelPerdida');
    var elFunPru = document.getElementById('aarFunnelPrueban');
    var elFunCom = document.getElementById('aarFunnelCompran');
    var elFunDev = document.getElementById('aarFunnelDevuelven');
    var elPctPru = document.getElementById('aarPctPrueban');
    var elPctCom = document.getElementById('aarPctCompran');
    var elPctDev = document.getElementById('aarPctDevuelven');
    var elConvPct = document.getElementById('aarConversionPct');
    
    if(elFunPer) elFunPer.textContent = conPerdida;
    if(elFunPru) elFunPru.textContent = prueban;
    if(elFunCom) elFunCom.textContent = compran;
    if(elFunDev) elFunDev.textContent = devuelven;
    if(elPctPru) elPctPru.textContent = '(' + pctPrueban + '%)';
    if(elPctCom) elPctCom.textContent = '(' + pctCompran + '%)';
    if(elPctDev) elPctDev.textContent = '(' + pctDevuelven + '%)';
    if(elConvPct) elConvPct.textContent = convNeta + '%';
    
    var elNPSG = document.getElementById('aarNPSGauge');
    var elNPSM = document.getElementById('aarNPSMarker');
    if(elNPSG) elNPSG.textContent = npsPromedio;
    if(elNPSM) {
        var npsVal = parseFloat(npsPromedio) || 0;
        elNPSM.style.left = 'calc(' + (npsVal * 10) + '% - 7px)';
    }
    
    var elVU = document.getElementById('aarVentasUnidades');
    var elTM = document.getElementById('aarTicketMedio');
    var elFT = document.getElementById('aarFacturacionTotal');
    
    if(elVU) elVU.textContent = compran;
    if(elTM) elTM.textContent = ticketMedio.toLocaleString('es-ES') + '€';
    if(elFT) elFT.textContent = facturacionTotal.toLocaleString('es-ES') + '€';
}

function actualizarPanelesConDatos(datos) {
    var tecnicos = {};
    var audiologos = {};
    
    datos.forEach(function(a) {
        if(a.tiendaOrigen) {
            if(!tecnicos[a.tiendaOrigen]) tecnicos[a.tiendaOrigen] = {revisiones:0, ventas:0};
            tecnicos[a.tiendaOrigen].revisiones++;
            if(a.cierrePrueba === 'Compra Audífonos') tecnicos[a.tiendaOrigen].ventas++;
        }
        if(a.tiendaDestino) {
            if(!audiologos[a.tiendaDestino]) audiologos[a.tiendaDestino] = {revisiones:0, ventas:0};
            audiologos[a.tiendaDestino].revisiones++;
            if(a.cierrePrueba === 'Compra Audífonos') audiologos[a.tiendaDestino].ventas++;
        }
    });
    
    var topTecnicos = Object.entries(tecnicos).sort((a,b) => {
        if(b[1].ventas !== a[1].ventas) return b[1].ventas - a[1].ventas;
        return b[1].revisiones - a[1].revisiones;
    });
    var topAudiologos = Object.entries(audiologos).sort((a,b) => {
        if(b[1].ventas !== a[1].ventas) return b[1].ventas - a[1].ventas;
        return b[1].revisiones - a[1].revisiones;
    });
    
    var panelTec = document.getElementById('panelTecnicos');
    if(panelTec) {
        if(topTecnicos.length === 0) {
            panelTec.innerHTML = '<div style="text-align:center;color:#888;padding:15px;font-size:11px">Sin datos</div>';
        } else {
            var htmlTec = '<table style="width:100%;border-collapse:collapse;font-size:10px">';
            htmlTec += '<tr style="background:#f5f5f5"><th style="padding:6px;text-align:center;width:28px">#</th><th style="padding:6px;text-align:left">Técnico</th><th style="padding:6px;text-align:center;width:45px;color:#C9A227">Vtas</th><th style="padding:6px;text-align:center;width:45px">Rev.</th></tr>';
            topTecnicos.forEach(function(t, i) {
                var medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : (i+1);
                var bgRow = i % 2 === 0 ? '#fff' : '#fafafa';
                htmlTec += '<tr style="background:' + bgRow + ';border-bottom:1px solid #eee">';
                htmlTec += '<td style="padding:5px;text-align:center;font-size:11px">' + medal + '</td>';
                htmlTec += '<td style="padding:5px;font-weight:500;font-size:9px">' + t[0] + '</td>';
                htmlTec += '<td style="padding:5px;text-align:center;font-weight:700;color:#C9A227">' + t[1].ventas + '</td>';
                htmlTec += '<td style="padding:5px;text-align:center;font-weight:700">' + t[1].revisiones + '</td>';
                htmlTec += '</tr>';
            });
            htmlTec += '</table>';
            panelTec.innerHTML = htmlTec;
        }
    }
    
    var panelAud = document.getElementById('panelAudiologos');
    if(panelAud) {
        if(topAudiologos.length === 0) {
            panelAud.innerHTML = '<div style="text-align:center;color:#888;padding:15px;font-size:11px">Sin datos</div>';
        } else {
            var htmlAud = '<table style="width:100%;border-collapse:collapse;font-size:10px">';
            htmlAud += '<tr style="background:#fffbeb"><th style="padding:6px;text-align:center;width:28px">#</th><th style="padding:6px;text-align:left">Audiólogo</th><th style="padding:6px;text-align:center;width:45px;color:#C9A227">Vtas</th><th style="padding:6px;text-align:center;width:45px">Rev.</th></tr>';
            topAudiologos.forEach(function(a, i) {
                var medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : (i+1);
                var bgRow = i % 2 === 0 ? '#fff' : '#fffbf5';
                htmlAud += '<tr style="background:' + bgRow + ';border-bottom:1px solid #eee">';
                htmlAud += '<td style="padding:5px;text-align:center;font-size:11px">' + medal + '</td>';
                htmlAud += '<td style="padding:5px;font-weight:500;font-size:9px">' + a[0] + '</td>';
                htmlAud += '<td style="padding:5px;text-align:center;font-weight:700;color:#C9A227">' + a[1].ventas + '</td>';
                htmlAud += '<td style="padding:5px;text-align:center;font-weight:700">' + a[1].revisiones + '</td>';
                htmlAud += '</tr>';
            });
            htmlAud += '</table>';
            panelAud.innerHTML = htmlAud;
        }
    }
}

function renderTablaAAR() {
    var tbody = document.getElementById('tbodyAAR');
    if(!tbody) return;
    
    if(aarData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="padding:30px;text-align:center;color:#888;font-size:13px">No hay registros AAR. Haz clic en "+ Nueva Actividad"</td></tr>';
        return;
    }
    
    var html = '';
    aarData.forEach(function(a, i) {
        var bgColor = i % 2 === 0 ? '#f0fdf4' : '#fff';
        var estadoColor = a.estado === 'Cerrado' ? '#10B981' : a.estado === 'En curso' ? '#F59E0B' : '#3B82F6';
        var estadoBg = a.estado === 'Cerrado' ? '#ecfdf5' : a.estado === 'En curso' ? '#fffbeb' : '#eff6ff';
        
        html += '<tr style="border-bottom:1px solid #d1fae5;background:' + bgColor + '">';
        html += '<td style="padding:6px"><input type="date" value="' + (a.fechaCita || '') + '" onchange="updateAAR(' + i + ',\'fechaCita\',this.value)" style="width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:9px"></td>';
        html += '<td style="padding:6px"><select onchange="updateAAR(' + i + ',\'servicio\',this.value)" style="width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:9px">';
        html += '<option value="Primera Visita"' + (a.servicio==='Primera Visita'?' selected':'') + '>Primera Visita</option>';
        html += '<option value="Ajustes"' + (a.servicio==='Ajustes'?' selected':'') + '>Ajustes</option>';
        html += '</select></td>';
        html += '<td style="padding:6px;text-align:center"><select onchange="updateAAR(' + i + ',\'estado\',this.value)" style="width:100%;padding:4px;border:2px solid ' + estadoColor + ';border-radius:4px;font-size:9px;font-weight:600;background:' + estadoBg + '">';
        html += '<option value="Abierto"' + (a.estado==='Abierto'?' selected':'') + '>Abierto</option>';
        html += '<option value="En curso"' + (a.estado==='En curso'?' selected':'') + '>En curso</option>';
        html += '<option value="Cerrado"' + (a.estado==='Cerrado'?' selected':'') + '>Cerrado</option>';
        html += '</select></td>';
        html += '<td style="padding:6px"><input type="text" value="' + (a.tiendaOrigen || '') + '" onchange="updateAAR(' + i + ',\'tiendaOrigen\',this.value)" placeholder="Tienda origen..." style="width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:9px"></td>';
        html += '<td style="padding:6px"><input type="text" value="' + (a.tiendaDestino || '') + '" onchange="updateAAR(' + i + ',\'tiendaDestino\',this.value)" placeholder="Tienda destino..." style="width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:9px"></td>';
        html += '<td style="padding:6px;text-align:center"><select onchange="updateAAR(' + i + ',\'revisionPerdida\',this.value)" style="width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:9px">';
        html += '<option value=""' + (!a.revisionPerdida?' selected':'') + '>-</option>';
        html += '<option value="Si"' + (a.revisionPerdida==='Si'?' selected':'') + '>Sí</option>';
        html += '<option value="No"' + (a.revisionPerdida==='No'?' selected':'') + '>No</option>';
        html += '<option value="Ajuste post venta"' + (a.revisionPerdida==='Ajuste post venta'?' selected':'') + '>Ajuste post venta</option>';
        html += '</select></td>';
        html += '<td style="padding:6px;text-align:center"><select onchange="updateAAR(' + i + ',\'pruebaAudifonos\',this.value)" style="width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:9px">';
        html += '<option value="No"' + (a.pruebaAudifonos==='No' || a.pruebaAudifonos==='no'?' selected':'') + '>No</option>';
        html += '<option value="Si"' + (a.pruebaAudifonos==='Si'?' selected':'') + '>Sí</option>';
        html += '</select></td>';
        html += '<td style="padding:6px;text-align:center"><select onchange="updateAAR(' + i + ',\'cierrePrueba\',this.value)" style="width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:9px">';
        html += '<option value=""' + (!a.cierrePrueba?' selected':'') + '>-</option>';
        html += '<option value="Compra Audífonos"' + (a.cierrePrueba==='Compra Audífonos'?' selected':'') + '>Compra Audífonos</option>';
        html += '<option value="Devuelve"' + (a.cierrePrueba==='Devuelve'?' selected':'') + '>Devuelve</option>';
        html += '</select></td>';
        html += '<td style="padding:6px"><input type="number" value="' + (a.pvp || '') + '" onchange="updateAAR(' + i + ',\'pvp\',this.value)" placeholder="€" style="width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:9px;text-align:right"></td>';
        html += '<td style="padding:6px;text-align:center"><input type="number" value="' + (a.nps || '') + '" onchange="updateAAR(' + i + ',\'nps\',this.value)" min="0" max="10" placeholder="0-10" style="width:45px;padding:2px;border:2px solid #C9A227;border-radius:4px;font-size:11px;text-align:center;font-weight:700"></td>';
        html += '<td style="padding:6px;text-align:center"><button onclick="eliminarAAR(' + i + ')" style="padding:4px 6px;background:#fee2e2;border:1px solid #fca5a5;border-radius:4px;cursor:pointer;font-size:10px">🗑️</button></td>';
        html += '</tr>';
    });
    
    tbody.innerHTML = html;
}

function actualizarDashboardAAR() {
    var conPerdida = 0, postVenta = 0, sinPerdida = 0;
    var prueban = 0, compran = 0, devuelven = 0;
    var npsTotal = 0, npsCount = 0;
    var facturacionTotal = 0, ventasConPVP = 0;
    
    aarData.forEach(function(a) {
        // Revisiones
        if(a.revisionPerdida === 'Si') conPerdida++;
        else if(a.revisionPerdida === 'Ajuste post venta') postVenta++;
        else if(a.revisionPerdida === 'No') sinPerdida++;
        
        // Conversión
        if(a.pruebaAudifonos === 'Si') prueban++;
        if(a.cierrePrueba === 'Compra Audífonos') {
            compran++;
            if(a.pvp && !isNaN(parseFloat(a.pvp)) && parseFloat(a.pvp) > 0) {
                facturacionTotal += parseFloat(a.pvp);
                ventasConPVP++;
            }
        }
        if(a.cierrePrueba === 'Devuelve') devuelven++;
        
        // NPS
        if(a.nps && !isNaN(a.nps) && a.nps !== '') {
            npsTotal += parseFloat(a.nps);
            npsCount++;
        }
    });
    
    var totalRevisiones = conPerdida + postVenta + sinPerdida;
    var npsPromedio = npsCount > 0 ? (npsTotal / npsCount).toFixed(1) : '0';
    var ticketMedio = ventasConPVP > 0 ? Math.round(facturacionTotal / ventasConPVP) : 0;
    
    // Porcentajes embudo
    var pctPrueban = conPerdida > 0 ? Math.round((prueban / conPerdida) * 100) : 0;
    var pctCompran = prueban > 0 ? Math.round((compran / prueban) * 100) : 0;
    var pctDevuelven = prueban > 0 ? Math.round((devuelven / prueban) * 100) : 0;
    var convNeta = conPerdida > 0 ? Math.round(((compran - devuelven) / conPerdida) * 100) : 0;
    
    // TOTAL REVISIONES
    var elTotal = document.getElementById('aarTotalRevisiones');
    if(elTotal) elTotal.textContent = totalRevisiones;
    
    // BARRAS REVISIONES - Calcular porcentajes basados en total
    var elBarCP = document.getElementById('aarBarConPerdida');
    var elBarPV = document.getElementById('aarBarPostVenta');
    var elBarSP = document.getElementById('aarBarSinPerdida');
    var elBarCPF = document.getElementById('aarBarConPerdidaFill');
    var elBarPVF = document.getElementById('aarBarPostVentaFill');
    var elBarSPF = document.getElementById('aarBarSinPerdidaFill');
    
    if(elBarCP) elBarCP.textContent = conPerdida;
    if(elBarPV) elBarPV.textContent = postVenta;
    if(elBarSP) elBarSP.textContent = sinPerdida;
    
    // Calcular ancho de barras basado en el total de revisiones
    var maxVal = totalRevisiones > 0 ? totalRevisiones : 1;
    if(elBarCPF) elBarCPF.style.width = ((conPerdida / maxVal) * 100) + '%';
    if(elBarPVF) elBarPVF.style.width = ((postVenta / maxVal) * 100) + '%';
    if(elBarSPF) elBarSPF.style.width = ((sinPerdida / maxVal) * 100) + '%';
    
    // EMBUDO CONVERSIÓN
    var elFunPer = document.getElementById('aarFunnelPerdida');
    var elFunPru = document.getElementById('aarFunnelPrueban');
    var elFunCom = document.getElementById('aarFunnelCompran');
    var elFunDev = document.getElementById('aarFunnelDevuelven');
    var elPctPru = document.getElementById('aarPctPrueban');
    var elPctCom = document.getElementById('aarPctCompran');
    var elPctDev = document.getElementById('aarPctDevuelven');
    var elConvPct = document.getElementById('aarConversionPct');
    
    if(elFunPer) elFunPer.textContent = conPerdida;
    if(elFunPru) elFunPru.textContent = prueban;
    if(elFunCom) elFunCom.textContent = compran;
    if(elFunDev) elFunDev.textContent = devuelven;
    if(elPctPru) elPctPru.textContent = '(' + pctPrueban + '%)';
    if(elPctCom) elPctCom.textContent = '(' + pctCompran + '%)';
    if(elPctDev) elPctDev.textContent = '(' + pctDevuelven + '%)';
    if(elConvPct) elConvPct.textContent = convNeta + '%';
    
    // NPS GAUGE
    var elNPSG = document.getElementById('aarNPSGauge');
    var elNPSM = document.getElementById('aarNPSMarker');
    if(elNPSG) elNPSG.textContent = npsPromedio;
    if(elNPSM) {
        var npsVal = parseFloat(npsPromedio) || 0;
        elNPSM.style.left = 'calc(' + (npsVal * 10) + '% - 7px)';
    }
    
    // VENTAS Y CIFRAS
    var elVU = document.getElementById('aarVentasUnidades');
    var elTM = document.getElementById('aarTicketMedio');
    var elFT = document.getElementById('aarFacturacionTotal');
    
    if(elVU) elVU.textContent = compran;
    if(elTM) elTM.textContent = ticketMedio.toLocaleString('es-ES') + '€';
    if(elFT) elFT.textContent = facturacionTotal.toLocaleString('es-ES') + '€';
}

function actualizarPanelesCentros() {
    var tecnicos = {};
    var audiologos = {};
    
    aarData.forEach(function(a) {
        if(a.tiendaOrigen) {
            if(!tecnicos[a.tiendaOrigen]) tecnicos[a.tiendaOrigen] = {revisiones:0, ventas:0};
            tecnicos[a.tiendaOrigen].revisiones++;
            if(a.cierrePrueba === 'Compra Audífonos') tecnicos[a.tiendaOrigen].ventas++;
        }
        if(a.tiendaDestino) {
            if(!audiologos[a.tiendaDestino]) audiologos[a.tiendaDestino] = {revisiones:0, ventas:0};
            audiologos[a.tiendaDestino].revisiones++;
            if(a.cierrePrueba === 'Compra Audífonos') audiologos[a.tiendaDestino].ventas++;
        }
    });
    
    // ORDENAR POR VENTAS (prioridad), luego por revisiones
    var topTecnicos = Object.entries(tecnicos).sort((a,b) => {
        if(b[1].ventas !== a[1].ventas) return b[1].ventas - a[1].ventas;
        return b[1].revisiones - a[1].revisiones;
    });
    var topAudiologos = Object.entries(audiologos).sort((a,b) => {
        if(b[1].ventas !== a[1].ventas) return b[1].ventas - a[1].ventas;
        return b[1].revisiones - a[1].revisiones;
    });
    
    // Render ranking técnicos
    var panelTec = document.getElementById('panelTecnicos');
    if(panelTec) {
        if(topTecnicos.length === 0) {
            panelTec.innerHTML = '<div style="text-align:center;color:#888;padding:15px;font-size:11px">Sin datos</div>';
        } else {
            var htmlTec = '<table style="width:100%;border-collapse:collapse;font-size:10px">';
            htmlTec += '<tr style="background:#f5f5f5"><th style="padding:6px;text-align:center;width:28px">#</th><th style="padding:6px;text-align:left">Técnico</th><th style="padding:6px;text-align:center;width:45px;color:#C9A227">Vtas</th><th style="padding:6px;text-align:center;width:45px">Rev.</th></tr>';
            topTecnicos.forEach(function(t, i) {
                var medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : (i+1);
                var bgRow = i % 2 === 0 ? '#fff' : '#fafafa';
                htmlTec += '<tr style="background:' + bgRow + ';border-bottom:1px solid #eee">';
                htmlTec += '<td style="padding:5px;text-align:center;font-size:11px">' + medal + '</td>';
                htmlTec += '<td style="padding:5px;font-weight:500;font-size:9px">' + t[0] + '</td>';
                htmlTec += '<td style="padding:5px;text-align:center;font-weight:700;color:#C9A227">' + t[1].ventas + '</td>';
                htmlTec += '<td style="padding:5px;text-align:center;font-weight:700">' + t[1].revisiones + '</td>';
                htmlTec += '</tr>';
            });
            htmlTec += '</table>';
            panelTec.innerHTML = htmlTec;
        }
    }
    
    // Render ranking audiólogos
    var panelAud = document.getElementById('panelAudiologos');
    if(panelAud) {
        if(topAudiologos.length === 0) {
            panelAud.innerHTML = '<div style="text-align:center;color:#888;padding:15px;font-size:11px">Sin datos</div>';
        } else {
            var htmlAud = '<table style="width:100%;border-collapse:collapse;font-size:10px">';
            htmlAud += '<tr style="background:#fffbeb"><th style="padding:6px;text-align:center;width:28px">#</th><th style="padding:6px;text-align:left">Audiólogo</th><th style="padding:6px;text-align:center;width:45px;color:#C9A227">Vtas</th><th style="padding:6px;text-align:center;width:45px">Rev.</th></tr>';
            topAudiologos.forEach(function(a, i) {
                var medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : (i+1);
                var bgRow = i % 2 === 0 ? '#fff' : '#fffbf5';
                htmlAud += '<tr style="background:' + bgRow + ';border-bottom:1px solid #eee">';
                htmlAud += '<td style="padding:5px;text-align:center;font-size:11px">' + medal + '</td>';
                htmlAud += '<td style="padding:5px;font-weight:500;font-size:9px">' + a[0] + '</td>';
                htmlAud += '<td style="padding:5px;text-align:center;font-weight:700;color:#C9A227">' + a[1].ventas + '</td>';
                htmlAud += '<td style="padding:5px;text-align:center;font-weight:700">' + a[1].revisiones + '</td>';
                htmlAud += '</tr>';
            });
            htmlAud += '</table>';
            panelAud.innerHTML = htmlAud;
        }
    }
}

function imprimirInformeAAR() {
    // COPIAR TODO DIRECTAMENTE DEL DOM
    var cardRevisiones = document.getElementById('cardRevisiones') ? document.getElementById('cardRevisiones').outerHTML : '';
    var cardEmbudoOriginal = document.getElementById('cardEmbudo') ? document.getElementById('cardEmbudo').outerHTML : '';
    // Corregir embudo para impresión - quitar height:100%, flex y añadir gap
    var cardEmbudo = cardEmbudoOriginal.replace('height:100%','').replace('flex:1;','').replace('justify-content:center;align-items:center','justify-content:center;align-items:center;gap:2px');
    var cardNPS = document.getElementById('cardNPS') ? document.getElementById('cardNPS').outerHTML : '';
    var cardVentas = document.getElementById('cardVentas') ? document.getElementById('cardVentas').outerHTML : '';
    var panelTecnicos = document.getElementById('panelTecnicos') ? document.getElementById('panelTecnicos').innerHTML : '';
    var panelAudiologos = document.getElementById('panelAudiologos') ? document.getElementById('panelAudiologos').innerHTML : '';
    var tablaAAR = document.getElementById('tablaAAR') ? document.getElementById('tablaAAR').outerHTML : '';
    
    // Contar registros
    var datos = (aarDataFiltrada && aarDataFiltrada.length > 0) ? aarDataFiltrada : 
                (aarData && aarData.length > 0) ? aarData : aarDataInicial;
    
    var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Informe AAR</title>';
    html += '<style>@page{size:A4;margin:12mm}body{font-family:Segoe UI,sans-serif;font-size:11px;color:#333;margin:0;padding:15px;background:#f5f5f5}';
    html += '.header{background:linear-gradient(135deg,#555,#444);color:#fff;padding:16px 20px;border-radius:10px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;border:2px solid #C9A227}';
    html += '.header h1{margin:0;font-size:18px;color:#C9A227}.header .fecha{font-size:11px;opacity:0.9}';
    html += '.dashboard{display:grid;grid-template-columns:1.2fr 1fr 0.8fr 1fr;gap:12px;margin-bottom:12px}';
    html += '.rankings{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}';
    html += '.ranking{background:#fff;border-radius:10px;overflow:hidden}';
    html += '.ranking-tec{border:2px solid #555}.ranking-tec .ranking-header{background:#555;color:#C9A227}';
    html += '.ranking-aud{border:2px solid #C9A227}.ranking-aud .ranking-header{background:linear-gradient(135deg,#C9A227,#B8963D);color:#1a1a1a}';
    html += '.ranking-header{padding:10px 14px;font-weight:700;font-size:11px}';
    html += 'table{width:100%;border-collapse:collapse;font-size:10px}th,td{padding:6px;text-align:left;border-bottom:1px solid #eee}';
    html += '.tabla-datos{background:#fff;border:2px solid #ccc;border-radius:10px;overflow:hidden}';
    html += '.tabla-header{background:#666;color:#fff;padding:10px;font-weight:700;font-size:11px}';
    html += '</style></head><body>';
    
    // HEADER
    html += '<div class="header"><div><h1>🎯 Gestión de informes Audio</h1><div>Seguimiento de citas y actividades</div></div>';
    html += '<div class="fecha">' + new Date().toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'}) + '</div></div>';
    
    // DASHBOARD - 4 CARDS (copiados del DOM)
    html += '<div class="dashboard">';
    html += cardRevisiones;
    html += cardEmbudo;
    html += cardNPS;
    html += cardVentas;
    html += '</div>';
    
    // RANKINGS (copiados del DOM)
    html += '<div class="rankings">';
    html += '<div class="ranking ranking-tec"><div class="ranking-header">🏆 RANKING TÉCNICOS <span style="font-size:8px;color:#aaa;margin-left:auto">(por ventas)</span></div>';
    html += panelTecnicos;
    html += '</div>';
    html += '<div class="ranking ranking-aud"><div class="ranking-header">🏆 RANKING AUDIÓLOGOS <span style="font-size:8px;opacity:0.7;margin-left:auto">(por ventas)</span></div>';
    html += panelAudiologos;
    html += '</div></div>';
    
    // TABLA DE DATOS (copiada del DOM)
    html += '<div class="tabla-datos"><div class="tabla-header">📋 DETALLE DE ACTIVIDADES (' + datos.length + ' registros)</div>';
    html += tablaAAR;
    html += '</div>';
    
    html += '</body></html>';
    
    var ventana = window.open('','_blank');
    ventana.document.write(html);
    ventana.document.close();
    setTimeout(function() { ventana.print(); }, 500);
}

function updateAAR(i, campo, valor) {
    if(aarData[i]) {
        aarData[i][campo] = valor;
        actualizarDashboardAAR();
        actualizarPanelesCentros();
        if(campo === 'estado') {
            renderTablaAAR();
        }
        guardarAAR();
    }
}

function eliminarAAR(i) {
    if(confirm('¿Eliminar este registro?')) {
        aarData.splice(i, 1);
        renderTablaAAR();
        actualizarDashboardAAR();
        actualizarPanelesCentros();
        guardarAAR();
    }
}

function guardarAAR() {
    localStorage.setItem('aarData', JSON.stringify(aarData));
}

// ==================== MÓDULO ACCIONES FLOP ====================
var accionesFlop = [];
var centroFlopSeleccionado = '';

function toggleSeccionFlop() {
    var contenido = document.getElementById('contenidoFlop');
    var arrow = document.getElementById('flopArrow');
    if(contenido.style.display === 'none') {
        contenido.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
    } else {
        contenido.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
    }
}

function cargarAccionesFlop() {
    var guardadas = JSON.parse(localStorage.getItem('accionesFlop') || '[]');
    accionesFlop = guardadas;
    renderTablaAccionesFlop();
}

function buscarCentroFlopGeneral(texto) {
    var resultados = document.getElementById('resultadosBuscadorFlop');
    if(!texto || texto.length < 2) {
        resultados.style.display = 'none';
        return;
    }
    
    texto = texto.toLowerCase();
    var encontrados = centrosData.filter(function(c) {
        return c.c.toLowerCase().includes(texto) || c.n.toLowerCase().includes(texto);
    }).slice(0, 10);
    
    if(encontrados.length === 0) {
        resultados.innerHTML = '<div style="padding:10px;color:#888;font-size:11px">No se encontraron centros</div>';
    } else {
        resultados.innerHTML = encontrados.map(function(c) {
            return '<div onclick="seleccionarCentroFlop(\'' + c.c + '\',\'' + c.n.replace(/'/g, "\\'") + '\')" style="padding:8px 12px;cursor:pointer;border-bottom:1px solid #e5e7eb;font-size:11px;display:flex;justify-content:space-between" onmouseover="this.style.background=\'#f3f4f6\'" onmouseout="this.style.background=\'#fff\'">' +
                '<span style="font-weight:600;color:#374151">' + c.c + '</span>' +
                '<span style="color:#6b7280;font-size:10px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + c.n + '</span>' +
            '</div>';
        }).join('');
    }
    resultados.style.display = 'block';
}

function seleccionarCentroFlop(codigo, nombre) {
    centroFlopSeleccionado = codigo;
    document.getElementById('buscadorCentroFlop').value = codigo + ' - ' + nombre;
    document.getElementById('resultadosBuscadorFlop').style.display = 'none';
}

function agregarFilaAccionFlop() {
    var hoy = new Date().toISOString().split('T')[0];
    accionesFlop.push({
        id: Date.now(),
        centro: centroFlopSeleccionado || '',
        fecha: hoy,
        paquete: '',
        tipo: 'AZAFATA',
        derivaciones: 0,
        citas: 0,
        ventas: 0,
        formacion: '',
        areaSocial: '',
        observaciones: '',
        visita: ''
    });
    centroFlopSeleccionado = '';
    document.getElementById('buscadorCentroFlop').value = '';
    renderTablaAccionesFlop();
}

function renderTablaAccionesFlop() {
    var tbody = document.getElementById('tbodyAccionesFlop');
    if(!tbody) return;
    
    if(accionesFlop.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" style="padding:30px;text-align:center;color:#888;font-size:13px">No hay acciones FLOP registradas. Haz clic en "+ Nueva Acción"</td></tr>';
        actualizarTotalesAccionesFlop();
        return;
    }
    
    var html = '';
    accionesFlop.forEach(function(a, i) {
        var paqColor = a.paquete === '1' ? '#16a34a' : a.paquete === '2' ? '#2563eb' : a.paquete === '3' ? '#9333ea' : '#ddd';
        var bgColor = i % 2 === 0 ? '#f9fafb' : '#fff';
        
        html += '<tr style="border-bottom:1px solid #e5e7eb;background:' + bgColor + '">';
        html += '<td style="padding:5px"><input type="text" value="' + (a.centro || '') + '" onchange="updateAccionFlop(' + i + ',\'centro\',this.value)" placeholder="Código..." style="width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:10px;font-weight:600"></td>';
        html += '<td style="padding:5px"><input type="date" value="' + a.fecha + '" onchange="updateAccionFlop(' + i + ',\'fecha\',this.value)" style="width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:9px"></td>';
        html += '<td style="padding:5px"><select onchange="updateAccionFlop(' + i + ',\'paquete\',this.value)" style="width:100%;padding:4px;border:2px solid ' + paqColor + ';border-radius:4px;font-size:9px;font-weight:600">' + getSelectPaquetes(a.paquete) + '</select></td>';
        html += '<td style="padding:5px"><select onchange="updateAccionFlop(' + i + ',\'tipo\',this.value)" style="width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:9px">';
        html += '<option value="AZAFATA"' + (a.tipo==='AZAFATA'?' selected':'') + '>Azafata</option>';
        html += '<option value="BUZONEO"' + (a.tipo==='BUZONEO'?' selected':'') + '>Buzoneo</option>';
        html += '<option value="STAND"' + (a.tipo==='STAND'?' selected':'') + '>Stand</option>';
        html += '<option value="CALL CENTER"' + (a.tipo==='CALL CENTER'?' selected':'') + '>Call Center</option>';
        html += '<option value="MAILING"' + (a.tipo==='MAILING'?' selected':'') + '>Mailing</option>';
        html += '<option value="EVENTO"' + (a.tipo==='EVENTO'?' selected':'') + '>EVENTO</option>';
        html += '<option value="COLABORACIÓN"' + (a.tipo==='COLABORACIÓN'?' selected':'') + '>COLABORACIÓN</option>';
        html += '<option value="FORMACIÓN"' + (a.tipo==='FORMACIÓN'?' selected':'') + '>FORMACIÓN</option>';
        html += '<option value="VISITA"' + (a.tipo==='VISITA'?' selected':'') + '>VISITA</option>';
        html += '<option value="OTRO"' + (a.tipo==='OTRO'?' selected':'') + '>OTRO</option>';
        html += '</select></td>';
        html += '<td style="padding:5px"><input type="number" value="' + a.derivaciones + '" onchange="updateAccionFlop(' + i + ',\'derivaciones\',this.value)" min="0" style="width:100%;padding:4px;border:2px solid #f59e0b;border-radius:4px;font-size:10px;text-align:center;font-weight:700;background:#fffbeb"></td>';
        html += '<td style="padding:5px"><input type="number" value="' + a.citas + '" onchange="updateAccionFlop(' + i + ',\'citas\',this.value)" min="0" style="width:100%;padding:4px;border:2px solid #3b82f6;border-radius:4px;font-size:10px;text-align:center;font-weight:700;background:#eff6ff"></td>';
        html += '<td style="padding:5px"><input type="number" value="' + a.ventas + '" onchange="updateAccionFlop(' + i + ',\'ventas\',this.value)" min="0" style="width:100%;padding:4px;border:2px solid #10b981;border-radius:4px;font-size:10px;text-align:center;font-weight:700;background:#ecfdf5"></td>';
        // FORMACIÓN - Color gris
        html += '<td style="padding:5px"><select onchange="updateAccionFlop(' + i + ',\'formacion\',this.value)" style="width:100%;padding:4px;border:2px solid #6b7280;border-radius:4px;font-size:9px;font-weight:600;background:#f3f4f6">';
        html += '<option value=""' + (!a.formacion?' selected':'') + '>-</option>';
        html += '<option value="APLICA1"' + (a.formacion==='APLICA1'?' selected':'') + '>Aplica 1</option>';
        html += '<option value="APLICA2"' + (a.formacion==='APLICA2'?' selected':'') + '>Aplica 2</option>';
        html += '<option value="APLICA3"' + (a.formacion==='APLICA3'?' selected':'') + '>Aplica 3</option>';
        html += '<option value="APLICA4"' + (a.formacion==='APLICA4'?' selected':'') + '>Aplica 4</option>';
        html += '</select></td>';
        // ÁREA SOCIAL - Color gris
        html += '<td style="padding:5px"><select onchange="updateAccionFlop(' + i + ',\'areaSocial\',this.value)" style="width:100%;padding:4px;border:2px solid #6b7280;border-radius:4px;font-size:9px;font-weight:600;background:#f3f4f6">';
        html += '<option value=""' + (!a.areaSocial?' selected':'') + '>-</option>';
        html += '<option value="COLABORACIONES"' + (a.areaSocial==='COLABORACIONES'?' selected':'') + '>Colaboraciones</option>';
        html += '<option value="AYUDAS"' + (a.areaSocial==='AYUDAS'?' selected':'') + '>Ayudas</option>';
        html += '<option value="AYUDAS-COLABORACIONES"' + (a.areaSocial==='AYUDAS-COLABORACIONES'?' selected':'') + '>Ayudas-Colabor.</option>';
        html += '</select></td>';
        html += '<td style="padding:5px"><input type="text" value="' + (a.observaciones || '') + '" onchange="updateAccionFlop(' + i + ',\'observaciones\',this.value)" placeholder="Obs..." style="width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:9px"></td>';
        // VISITA - Color gris
        html += '<td style="padding:5px"><select onchange="updateAccionFlop(' + i + ',\'visita\',this.value)" style="width:100%;padding:4px;border:2px solid #6b7280;border-radius:4px;font-size:9px;font-weight:600;background:#f3f4f6">';
        html += '<option value=""' + (!a.visita?' selected':'') + '>-</option>';
        html += '<option value="T1"' + (a.visita==='T1'?' selected':'') + '>1º Trim.</option>';
        html += '<option value="T2"' + (a.visita==='T2'?' selected':'') + '>2º Trim.</option>';
        html += '<option value="T3"' + (a.visita==='T3'?' selected':'') + '>3º Trim.</option>';
        html += '<option value="T4"' + (a.visita==='T4'?' selected':'') + '>4º Trim.</option>';
        html += '</select></td>';
        html += '<td style="padding:5px;text-align:center"><button onclick="eliminarAccionFlop(' + i + ')" style="padding:4px 6px;background:#fee2e2;border:1px solid #fca5a5;border-radius:4px;cursor:pointer;font-size:10px">🗑️</button></td>';
        html += '</tr>';
    });
    
    tbody.innerHTML = html;
    actualizarTotalesAccionesFlop();
}

function updateAccionFlop(i, campo, valor) {
    if(accionesFlop[i]) {
        if(['derivaciones','citas','ventas'].includes(campo)) {
            accionesFlop[i][campo] = parseInt(valor) || 0;
        } else {
            accionesFlop[i][campo] = valor;
        }
        actualizarTotalesAccionesFlop();
        guardarAccionesFlop();
    }
}

function eliminarAccionFlop(i) {
    if(confirm('¿Eliminar esta acción FLOP?')) {
        accionesFlop.splice(i, 1);
        renderTablaAccionesFlop();
        guardarAccionesFlop();
    }
}

function actualizarTotalesAccionesFlop() {
    var d = 0, c = 0, v = 0;
    var formacionCount = 0;
    var areaSocialCount = 0;
    var visitasCount = 0;
    
    accionesFlop.forEach(function(a) {
        d += parseInt(a.derivaciones) || 0;
        c += parseInt(a.citas) || 0;
        v += parseInt(a.ventas) || 0;
        
        if(a.formacion) formacionCount++;
        if(a.areaSocial) areaSocialCount++;
        if(a.visita) visitasCount++;
    });
    
    var porcentajeFormacion = Math.min(formacionCount * 25, 100);
    
    var elD = document.getElementById('totalDerivAccionesFlop');
    var elC = document.getElementById('totalCitasAccionesFlop');
    var elV = document.getElementById('totalVentasAccionesFlop');
    var elForm = document.getElementById('totalFormacionFlop');
    var elArea = document.getElementById('totalAreaSocialFlop');
    var elVis = document.getElementById('totalVisitasFlop');
    
    if(elD) elD.textContent = d;
    if(elC) elC.textContent = c;
    if(elV) elV.textContent = v;
    if(elForm) elForm.textContent = porcentajeFormacion + '%';
    if(elArea) elArea.textContent = areaSocialCount;
    if(elVis) elVis.textContent = visitasCount;
}

function guardarAccionesFlop() {
    localStorage.setItem('accionesFlop', JSON.stringify(accionesFlop));
}

function abrirReporteGeneral() {
    // Calcular totales
    let totalVNC = 0, totalPrevisto = 0, totalDiferencia = 0;
    const mesActualGuardado = JSON.parse(localStorage.getItem('cifrasMesActual') || '{}');
    const prevMesGuardado = JSON.parse(localStorage.getItem('cifrasPrevMes') || '{}');
    let totalMesActual = 0, totalPrevMes = 0;
    
    cifrasExclusivos.forEach(c => {
        totalVNC += c.vnc;
        totalPrevisto += c.previsto;
        totalDiferencia += c.diferencia;
        totalMesActual += mesActualGuardado[c.cod] || 0;
        totalPrevMes += prevMesGuardado[c.cod] || 0;
    });
    
    // Calcular totales acciones
    let totalAcciones = accionesExclusivosData.length;
    let totalDeriv = 0, totalCitas = 0, totalVentas = 0;
    let formacionCount = 0, areaSocialCount = 0;
    let visitasT1 = 0, visitasT2 = 0, visitasT3 = 0, visitasT4 = 0;
    
    accionesExclusivosData.forEach(a => {
        totalDeriv += parseInt(a.derivaciones) || 0;
        totalCitas += parseInt(a.citas) || 0;
        totalVentas += parseInt(a.ventas) || 0;
        if(a.formacion) formacionCount++;
        if(a.areaSocial) areaSocialCount++;
        if(a.visita === 'T1') visitasT1++;
        else if(a.visita === 'T2') visitasT2++;
        else if(a.visita === 'T3') visitasT3++;
        else if(a.visita === 'T4') visitasT4++;
    });
    
    const totalVisitas = visitasT1 + visitasT2 + visitasT3 + visitasT4;
    const pctFormacion = Math.min(formacionCount * 25, 100);
    const pctObj = totalPrevisto > 0 ? Math.round((totalVNC / totalPrevisto) * 100) : 0;
    const maxDCV = Math.max(totalDeriv, totalCitas, totalVentas, 1);
    const maxTrim = Math.max(visitasT1, visitasT2, visitasT3, visitasT4, 1);
    
    let html = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>Reporte Centros Exclusivos</title>
<style>
@page{size:A4;margin:10mm}
body{font-family:Arial,sans-serif;margin:0;padding:15px;background:#fff;font-size:11px}
.page{page-break-after:always;min-height:277mm}
.page:last-child{page-break-after:auto}
h1{color:#C9A227;border-bottom:3px solid #C9A227;padding-bottom:8px;font-size:18px;margin-bottom:15px}
h2{color:#2d2d2d;margin-top:20px;border-bottom:2px solid #e0e0e0;padding-bottom:6px;font-size:13px}

/* DASHBOARD KPIs con gráficos */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:15px 0}
.kpi-box{background:#fff;padding:12px;border-radius:8px;border:1px solid #E0E0E0}
.kpi-header{display:flex;align-items:center;gap:6px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #F0F0F0}
.kpi-icon{font-size:14px}
.kpi-title{font-size:9px;font-weight:700;color:#666;text-transform:uppercase}
.kpi-value{font-size:22px;font-weight:800;color:#1A1A1A}
.kpi-sub{font-size:8px;color:#888;margin-top:2px}

/* Barras horizontales */
.bar-row{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.bar-label{font-size:7px;color:#666;width:35px}
.bar-track{flex:1;height:6px;background:#F0F0F0;border-radius:3px;overflow:hidden}
.bar-fill{height:100%;border-radius:3px}
.bar-val{font-size:9px;font-weight:700;width:25px;text-align:right}

/* Donut */
.donut-wrap{display:flex;gap:10px;align-items:center}
.donut{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;color:#C9A227}
.form-list{font-size:8px}
.form-list div{display:flex;justify-content:space-between;margin-bottom:2px}

/* Barras verticales trimestrales */
.trim-bars{display:flex;align-items:flex-end;gap:8px;height:35px;margin:8px 0}
.trim-bar{flex:1;text-align:center}
.trim-bar-fill{width:100%;background:#C9A227;border-radius:2px 2px 0 0;min-height:3px}
.trim-bar-label{font-size:6px;color:#666;margin-top:2px}
.trim-counts{display:flex;justify-content:space-between;font-size:7px;color:#666;margin-top:4px}

/* Barra progreso ventas */
.progress-wrap{margin:8px 0}
.progress-header{display:flex;justify-content:space-between;font-size:7px;color:#888;margin-bottom:3px}
.progress-track{height:8px;background:#E8E8E8;border-radius:4px;overflow:hidden}
.progress-fill{height:100%;border-radius:4px}

/* Tablas */
table{width:100%;border-collapse:collapse;margin:10px 0;font-size:9px}
th{background:#2d2d2d;color:#C9A227;padding:6px 4px;text-align:left;font-size:8px}
td{padding:5px 4px;border-bottom:1px solid #e0e0e0}
tr:nth-child(even){background:#fafafa}
.positive{color:#C9A227;font-weight:bold}
.negative{color:#8B7355;font-weight:bold}
.total-row{background:#2d2d2d !important;color:#C9A227;font-weight:bold}
.total-row td{border:none}
</style></head><body>

<!-- PÁGINA 1: DASHBOARD Y CIFRAS -->
<div class="page">
<h1>📊 REPORTE CENTROS EXCLUSIVOS</h1>
<p style="color:#666;font-size:9px;margin-bottom:15px">Fecha: ${new Date().toLocaleDateString('es-ES', {weekday:'long',year:'numeric',month:'long',day:'numeric'})}</p>

<h2>📈 DASHBOARD</h2>
<div class="kpi-grid">

<!-- KPI ACCIONES -->
<div class="kpi-box">
<div class="kpi-header"><span class="kpi-icon">📋</span><span class="kpi-title">ACCIONES</span></div>
<div class="kpi-value">${totalAcciones}</div>
<div class="kpi-sub">Total acciones</div>
<div style="margin-top:8px">
<div class="bar-row"><span class="bar-label">Deriv.</span><div class="bar-track"><div class="bar-fill" style="width:${(totalDeriv/maxDCV)*100}%;background:#F59E0B"></div></div><span class="bar-val" style="color:#F59E0B">${totalDeriv}</span></div>
<div class="bar-row"><span class="bar-label">Citas</span><div class="bar-track"><div class="bar-fill" style="width:${(totalCitas/maxDCV)*100}%;background:#3B82F6"></div></div><span class="bar-val" style="color:#B8963D">${totalCitas}</span></div>
<div class="bar-row"><span class="bar-label">Ventas</span><div class="bar-track"><div class="bar-fill" style="width:${(totalVentas/maxDCV)*100}%;background:#10B981"></div></div><span class="bar-val" style="color:#10B981">${totalVentas}</span></div>
</div>
</div>

<!-- KPI FORMACIÓN -->
<div class="kpi-box">
<div class="kpi-header"><span class="kpi-icon">🎓</span><span class="kpi-title">FORMACIÓN</span></div>
<div class="donut-wrap">
<div class="donut" style="background:conic-gradient(#C9A227 0% ${pctFormacion}%, #E0E0E0 ${pctFormacion}% 100%)">${pctFormacion}%</div>
<div class="form-list">
<div><span>Aplica 1</span><span style="color:#C9A227">25%</span></div>
<div><span>Aplica 2</span><span style="color:#C9A227">25%</span></div>
<div><span>Aplica 3</span><span style="color:#C9A227">25%</span></div>
<div><span>Aplica 4</span><span style="color:#C9A227">25%</span></div>
</div>
</div>
</div>

<!-- KPI VISITAS -->
<div class="kpi-box">
<div class="kpi-header"><span class="kpi-icon">🔍</span><span class="kpi-title">VISITAS</span></div>
<div class="kpi-value">${totalVisitas}</div>
<div class="kpi-sub">Total visitas</div>
<div class="trim-bars">
<div class="trim-bar"><div class="trim-bar-fill" style="height:${(visitasT1/maxTrim)*100}%"></div><div class="trim-bar-label">T1</div></div>
<div class="trim-bar"><div class="trim-bar-fill" style="height:${(visitasT2/maxTrim)*100}%"></div><div class="trim-bar-label">T2</div></div>
<div class="trim-bar"><div class="trim-bar-fill" style="height:${(visitasT3/maxTrim)*100}%"></div><div class="trim-bar-label">T3</div></div>
<div class="trim-bar"><div class="trim-bar-fill" style="height:${(visitasT4/maxTrim)*100}%"></div><div class="trim-bar-label">T4</div></div>
</div>
<div class="trim-counts"><span>T1: ${visitasT1}</span><span>T2: ${visitasT2}</span><span>T3: ${visitasT3}</span><span>T4: ${visitasT4}</span></div>
</div>

<!-- KPI VENTAS -->
<div class="kpi-box">
<div class="kpi-header"><span class="kpi-icon">💰</span><span class="kpi-title">VENTAS</span></div>
<div style="display:flex;align-items:baseline;gap:6px">
<div class="kpi-value" style="font-size:18px">${formatearEuro(totalVNC)}</div>
<span style="font-size:10px;font-weight:700;color:${totalDiferencia >= 0 ? '#10B981' : '#EF4444'}">${totalDiferencia >= 0 ? '+' : ''}${formatearEuro(totalDiferencia)}</span>
</div>
<div class="kpi-sub">vs ${formatearEuro(totalPrevisto)} previsto</div>
<div class="progress-wrap">
<div class="progress-header"><span>0%</span><span style="font-weight:700;color:${pctObj >= 100 ? '#10B981' : pctObj >= 80 ? '#F59E0B' : '#EF4444'}">${pctObj}%</span></div>
<div class="progress-track"><div class="progress-fill" style="width:${Math.min(pctObj,100)}%;background:${pctObj >= 100 ? '#10B981' : pctObj >= 80 ? '#F59E0B' : '#EF4444'}"></div></div>
</div>
<div style="display:flex;justify-content:space-between;margin-top:6px;padding-top:6px;border-top:1px solid #F0F0F0">
<span style="font-size:7px;color:#888">Mes actual:</span>
<span style="font-size:11px;font-weight:800">${formatearEuro(totalMesActual)}</span>
</div>
</div>

</div>

<h2>💰 CIFRAS POR CENTRO</h2>
<table>
<tr><th>TIPO</th><th>COD</th><th>TIENDA</th><th style="text-align:right">VNC AUDIO</th><th style="text-align:right">PREVISTO</th><th style="text-align:right">DIFERENCIA</th><th style="text-align:right">MES ACT.</th><th style="text-align:right">PREV. MES</th></tr>`;

    cifrasExclusivos.forEach(c => {
        const mesAct = mesActualGuardado[c.cod] || 0;
        const prevM = prevMesGuardado[c.cod] || 0;
        const colorDif = c.diferencia >= 0 ? 'positive' : 'negative';
        html += `<tr>
<td style="font-weight:bold;color:${c.tipo === 'FR' ? '#C9A227' : '#3b82f6'}">${c.tipo}</td>
<td>${c.cod}</td>
<td style="font-size:8px">${c.tienda}</td>
<td style="text-align:right;font-weight:bold">${formatearEuro(c.vnc)}</td>
<td style="text-align:right">${formatearEuro(c.previsto)}</td>
<td style="text-align:right" class="${colorDif}">${c.diferencia >= 0 ? '+' : ''}${formatearEuro(c.diferencia)}</td>
<td style="text-align:right">${formatearEuro(mesAct)}</td>
<td style="text-align:right">${formatearEuro(prevM)}</td>
</tr>`;
    });
    
    html += `<tr class="total-row">
<td colspan="3">TOTALES</td>
<td style="text-align:right">${formatearEuro(totalVNC)}</td>
<td style="text-align:right">${formatearEuro(totalPrevisto)}</td>
<td style="text-align:right;color:${totalDiferencia >= 0 ? '#10b981' : '#ef4444'}">${totalDiferencia >= 0 ? '+' : ''}${formatearEuro(totalDiferencia)}</td>
<td style="text-align:right">${formatearEuro(totalMesActual)}</td>
<td style="text-align:right">${formatearEuro(totalPrevMes)}</td>
</tr></table>
</div>

<!-- PÁGINA 2: ACCIONES DETALLE COMPLETO -->
<div class="page">
<h1>📋 ACCIONES CENTROS EXCLUSIVOS - DETALLE</h1>
<p style="color:#666;font-size:9px;margin-bottom:15px">Total: ${totalAcciones} acciones registradas</p>`;

    if(accionesExclusivosData.length > 0) {
        html += `<table style="font-size:8px">
<tr>
<th style="width:60px">CENTRO</th>
<th style="width:70px">FECHA</th>
<th style="width:70px">PAQUETE</th>
<th style="width:70px">TIPO</th>
<th style="text-align:center;width:40px">DERIV.</th>
<th style="text-align:center;width:35px">CITAS</th>
<th style="text-align:center;width:40px">VENTAS</th>
<th style="width:70px">FORMACIÓN</th>
<th style="width:80px">ÁREA SOCIAL</th>
<th>OBSERVACIONES</th>
<th style="width:55px">VISITA</th>
</tr>`;
        
        accionesExclusivosData.forEach(a => {
            const paqNombre = a.paquete === '1' ? 'TRÁFICO' : a.paquete === '2' ? 'COMERCIAL' : a.paquete === '3' ? 'EQUIPO' : '-';
            const formNombre = a.formacion ? a.formacion.replace('APLICA', 'Aplica ') : '-';
            const areaNombre = a.areaSocial === 'COLABORACIONES' ? 'Colaboraciones' : a.areaSocial === 'AYUDAS' ? 'Ayudas' : a.areaSocial === 'AYUDAS-COLABORACIONES' ? 'Ayudas-Colab.' : '-';
            const visitaNombre = a.visita === 'T1' ? '1º Trim.' : a.visita === 'T2' ? '2º Trim.' : a.visita === 'T3' ? '3º Trim.' : a.visita === 'T4' ? '4º Trim.' : '-';
            
            html += `<tr>
<td style="font-weight:600">${a.centro || '-'}</td>
<td>${a.fecha || '-'}</td>
<td>${paqNombre}</td>
<td>${a.tipo}</td>
<td style="text-align:center;color:#D4AF37;font-weight:bold">${a.derivaciones}</td>
<td style="text-align:center;color:#3b82f6;font-weight:bold">${a.citas}</td>
<td style="text-align:center;color:#C9A227;font-weight:bold">${a.ventas}</td>
<td>${formNombre}</td>
<td>${areaNombre}</td>
<td style="font-size:7px">${a.observaciones || '-'}</td>
<td>${visitaNombre}</td>
</tr>`;
        });
        
        html += `<tr class="total-row">
<td colspan="4">TOTALES</td>
<td style="text-align:center">${totalDeriv}</td>
<td style="text-align:center">${totalCitas}</td>
<td style="text-align:center">${totalVentas}</td>
<td colspan="4" style="text-align:right">Formación: ${pctFormacion}% | Área Social: ${areaSocialCount} | Visitas: ${totalVisitas}</td>
</tr></table>`;
    } else {
        html += `<p style="color:#888;text-align:center;padding:30px">No hay acciones registradas</p>`;
    }
    
    html += '</div></body></html>';
    
    const ventana = window.open('', '_blank');
    ventana.document.write(html);
    ventana.document.close();
    setTimeout(() => ventana.print(), 500);
}

function abrirFichaAcciones(codigo) {
    centroAccionActual = centrosData.find(c => c.c === codigo);
    if (!centroAccionActual) return;
    
    // Rellenar datos del centro
    document.getElementById('accionCentroCodigo').textContent = centroAccionActual.c;
    document.getElementById('accionCentroNombre').textContent = centroAccionActual.n;
    document.getElementById('accionCentroDelegado').textContent = centroAccionActual.d;
    document.getElementById('accionCentroPropietario').textContent = centroAccionActual.p;
    
    // Contar visitas
    const visitasCount = preinformes.filter(p => p.centro && p.centro.includes(centroAccionActual.c)).length;
    document.getElementById('accionVisitasCount').textContent = visitasCount;
    
    // Cargar acciones guardadas
    const acciones = accionesCentros[codigo] || [];
    document.getElementById('accionTotalAcciones').textContent = acciones.length;
    
    // Cargar paquete del centro
    cargarPaqueteEnModal(codigo);
    
    renderTablaAcciones(acciones);
    actualizarTotalesAcciones(acciones);
    
    document.getElementById('modalAcciones').style.display = 'flex';
}

function cerrarModalAcciones() {
    document.getElementById('modalAcciones').style.display = 'none';
    centroAccionActual = null;
}

function renderTablaAcciones(acciones) {
    const tbody = document.getElementById('tbodyAcciones');
    const codigo = centroAccionActual ? centroAccionActual.c : '';
    const numPaquete = getPaqueteCentro(codigo);
    const paquete = numPaquete ? datosPaquetes[numPaquete] : null;
    
    if (acciones.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="padding:30px;text-align:center;color:#888;font-style:italic">No hay acciones registradas. Haz clic en "+ Nueva Acción" para comenzar.</td></tr>';
        return;
    }
    
    tbody.innerHTML = acciones.map((a, idx) => {
        let checklistHtml = '';
        if(paquete) {
            const criteriosAccion = a.criterios || {};
            const aplicados = Object.values(criteriosAccion).filter(v => v === true).length;
            const total = paquete.criterios.length;
            const pct = Math.round((aplicados / total) * 100);
            
            checklistHtml = `
                <tr style="background:${paquete.color}10;border-bottom:2px solid ${paquete.color}">
                    <td colspan="7" style="padding:8px 12px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                            <span style="font-size:10px;font-weight:700;color:${paquete.color}">📦 PAQUETE ${numPaquete}: ${paquete.nombre}</span>
                            <span style="font-size:11px;font-weight:700;color:${paquete.color}">${aplicados}/${total} (${pct}%)</span>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:4px;max-height:150px;overflow-y:auto">
                            ${paquete.criterios.map((crit, cidx) => {
                                const aplicado = criteriosAccion[cidx] === true;
                                const noAplica = criteriosAccion[cidx] === false;
                                return `<div style="display:flex;align-items:center;gap:6px;padding:4px 6px;background:#fff;border-radius:4px;border:1px solid ${aplicado ? paquete.color : noAplica ? '#dc2626' : '#ddd'}">
                                    <div style="flex:1;font-size:8px;color:#333;line-height:1.2">${crit}</div>
                                    <button onclick="marcarCriterioAccion(${idx},${cidx},true)" style="padding:2px 6px;font-size:7px;font-weight:700;border:none;border-radius:3px;cursor:pointer;${aplicado ? 'background:'+paquete.color+';color:#fff' : 'background:#e5e5e5;color:#666'}">SÍ</button>
                                    <button onclick="marcarCriterioAccion(${idx},${cidx},false)" style="padding:2px 6px;font-size:7px;font-weight:700;border:none;border-radius:3px;cursor:pointer;${noAplica ? 'background:#dc2626;color:#fff' : 'background:#e5e5e5;color:#666'}">NO</button>
                                </div>`;
                            }).join('')}
                        </div>
                    </td>
                </tr>
            `;
        }
        
        return `
        <tr style="border-bottom:1px solid #e0e0e0;${idx % 2 === 0 ? 'background:#fafafa' : ''}">
            <td style="padding:8px"><input type="date" value="${a.fecha}" onchange="actualizarAccion(${idx},'fecha',this.value)" style="padding:4px;border:1px solid #ddd;border-radius:4px;font-size:10px;width:90px"></td>
            <td style="padding:8px">
                <select onchange="actualizarAccion(${idx},'tipo',this.value)" style="padding:4px;border:1px solid #ddd;border-radius:4px;font-size:10px;width:100%">
                    ${tiposAccion.map(t => `<option value="${t}" ${a.tipo === t ? 'selected' : ''}>${t}</option>`).join('')}
                </select>
            </td>
            <td style="padding:8px;text-align:center"><input type="number" value="${a.derivaciones || 0}" min="0" onchange="actualizarAccion(${idx},'derivaciones',this.value)" style="padding:4px;border:1px solid #ddd;border-radius:4px;font-size:10px;width:50px;text-align:center"></td>
            <td style="padding:8px;text-align:center"><input type="number" value="${a.citas || 0}" min="0" onchange="actualizarAccion(${idx},'citas',this.value)" style="padding:4px;border:1px solid #ddd;border-radius:4px;font-size:10px;width:50px;text-align:center"></td>
            <td style="padding:8px;text-align:center"><input type="number" value="${a.ventas || 0}" min="0" onchange="actualizarAccion(${idx},'ventas',this.value)" style="padding:4px;border:1px solid #ddd;border-radius:4px;font-size:10px;width:50px;text-align:center"></td>
            <td style="padding:8px"><input type="text" value="${a.observaciones || ''}" onchange="actualizarAccion(${idx},'observaciones',this.value)" placeholder="Observaciones..." style="padding:4px;border:1px solid #ddd;border-radius:4px;font-size:10px;width:100%"></td>
            <td style="padding:8px;text-align:center"><button onclick="eliminarAccion(${idx})" style="background:#5c5c5c;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px">🗑️</button></td>
        </tr>
        ${checklistHtml}
    `;
    }).join('');
}

function marcarCriterioAccion(accionIdx, criterioIdx, valor) {
    if (!centroAccionActual) return;
    const codigo = centroAccionActual.c;
    
    if (!accionesCentros[codigo][accionIdx].criterios) {
        accionesCentros[codigo][accionIdx].criterios = {};
    }
    accionesCentros[codigo][accionIdx].criterios[criterioIdx] = valor;
    
    renderTablaAcciones(accionesCentros[codigo]);
}

function agregarFilaAccion() {
    if (!centroAccionActual) return;
    
    const codigo = centroAccionActual.c;
    if (!accionesCentros[codigo]) {
        accionesCentros[codigo] = [];
    }
    
    const hoy = new Date().toISOString().split('T')[0];
    accionesCentros[codigo].push({
        fecha: hoy,
        tipo: 'AZAFATA',
        derivaciones: 0,
        citas: 0,
        ventas: 0,
        observaciones: ''
    });
    
    renderTablaAcciones(accionesCentros[codigo]);
    actualizarTotalesAcciones(accionesCentros[codigo]);
    document.getElementById('accionTotalAcciones').textContent = accionesCentros[codigo].length;
}

function actualizarAccion(idx, campo, valor) {
    if (!centroAccionActual) return;
    const codigo = centroAccionActual.c;
    
    if (campo === 'derivaciones' || campo === 'citas' || campo === 'ventas') {
        accionesCentros[codigo][idx][campo] = parseInt(valor) || 0;
    } else {
        accionesCentros[codigo][idx][campo] = valor;
    }
    
    actualizarTotalesAcciones(accionesCentros[codigo]);
}

function eliminarAccion(idx) {
    if (!centroAccionActual) return;
    if (!confirm('¿Eliminar esta acción?')) return;
    
    const codigo = centroAccionActual.c;
    accionesCentros[codigo].splice(idx, 1);
    
    renderTablaAcciones(accionesCentros[codigo]);
    actualizarTotalesAcciones(accionesCentros[codigo]);
    document.getElementById('accionTotalAcciones').textContent = accionesCentros[codigo].length;
}

function actualizarTotalesAcciones(acciones) {
    const totales = acciones.reduce((acc, a) => {
        acc.derivaciones += (parseInt(a.derivaciones) || 0);
        acc.citas += (parseInt(a.citas) || 0);
        acc.ventas += (parseInt(a.ventas) || 0);
        return acc;
    }, {derivaciones: 0, citas: 0, ventas: 0});
    
    document.getElementById('totalDerivaciones').textContent = totales.derivaciones;
    document.getElementById('totalCitas').textContent = totales.citas;
    document.getElementById('totalVentas').textContent = totales.ventas;
}

function guardarAcciones() {
    localStorage.setItem('accionesCentros', JSON.stringify(accionesCentros));
    cerrarModalAcciones();
    renderExclusivosFlop();
    alert('✅ Acciones guardadas correctamente');
}

// Funciones para FLOP
function abrirModalSeleccionarFlop() {
    filtrarCentrosFlopModal();
    document.getElementById('modalSeleccionarFlop').style.display = 'flex';
}

function cerrarModalSeleccionarFlop() {
    document.getElementById('modalSeleccionarFlop').style.display = 'none';
}

function filtrarCentrosFlopModal() {
    const buscar = (document.getElementById('buscadorFlopModal')?.value || '').toLowerCase();
    
    // Mostrar centros que no son exclusivos ni están ya en FLOP
    const disponibles = centrosData.filter(c => 
        c.t !== 'EXCLUSIVO' && 
        !centrosFlop.includes(c.c) &&
        (c.n.toLowerCase().includes(buscar) || c.c.toLowerCase().includes(buscar))
    ).slice(0, 30); // Limitar a 30 resultados
    
    document.getElementById('listaCentrosFlopModal').innerHTML = disponibles.length > 0
        ? disponibles.map(c => `
            <div onclick="agregarFlop('${c.c}')" style="padding:10px;border-bottom:1px solid #eee;cursor:pointer;display:flex;justify-content:space-between;align-items:center" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='#fff'">
                <div>
                    <div style="font-weight:600;font-size:11px;color:#333">${c.c} - ${c.n}</div>
                    <div style="font-size:9px;color:#888">${c.d} · ${c.p}</div>
                </div>
                <span style="color:#5c5c5c;font-size:16px">+</span>
            </div>
        `).join('')
        : '<p style="text-align:center;color:#888;font-size:10px;padding:20px">No se encontraron centros</p>';
}

function agregarFlop(codigo) {
    if (!centrosFlop.includes(codigo)) {
        centrosFlop.push(codigo);
        localStorage.setItem('centrosFlop', JSON.stringify(centrosFlop));
        cerrarModalSeleccionarFlop();
        renderExclusivosFlop();
    }
}

function quitarFlop(codigo) {
    if (confirm('¿Quitar este centro de la lista FLOP?')) {
        centrosFlop = centrosFlop.filter(c => c !== codigo);
        localStorage.setItem('centrosFlop', JSON.stringify(centrosFlop));
        renderExclusivosFlop();
    }
}

// ==================== TOGGLE DASHBOARDS ====================
function toggleDashboardExclusivos() {
    var content = document.getElementById('dashboardExclusivosContent');
    var icon = document.getElementById('toggleIconExclusivos');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '▼ Clic para ocultar';
    } else {
        content.style.display = 'none';
        icon.textContent = '▶ Clic para expandir';
    }
}

function toggleDashboardAAR() {
    var content = document.getElementById('dashboardAARContent');
    var icon = document.getElementById('toggleIconAAR');
    // Cerrar otros paneles
    document.getElementById('editorExcelContent').style.display = 'none';
    document.getElementById('toggleIconEditorExcel').textContent = '▶';
    document.getElementById('formacionesAARContent').style.display = 'none';
    document.getElementById('toggleIconFormaciones').textContent = '▶';
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '▼ Clic para ocultar';
    } else {
        content.style.display = 'none';
        icon.textContent = '▶ Clic para expandir';
    }
}

function toggleFormacionesAAR() {
    var content = document.getElementById('formacionesAARContent');
    var icon = document.getElementById('toggleIconFormaciones');
    // Cerrar otros paneles
    document.getElementById('dashboardAARContent').style.display = 'none';
    document.getElementById('toggleIconAAR').textContent = '▶ Clic para expandir';
    document.getElementById('editorExcelContent').style.display = 'none';
    document.getElementById('toggleIconEditorExcel').textContent = '▶';
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '▼';
        poblarFiltroDelegado();
        renderRetroplanningAAR();
    } else {
        content.style.display = 'none';
        icon.textContent = '▶';
    }
}

// ==================== RETROPLANNING AAR - DATOS EXCEL ====================
var retroTabActual = 'AAO';

var datosRetroAAO_original = [{"c":"4BAN","n":"RONDA SANT ANTONI","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"Formado","k":[1,1,1,1,1]},{"c":"4ZDE","n":"ZARAGOZA CALLE DELICIAS","d":"ENERITZ ARANGUREN","a":"ARY","e":"Formado","k":[1,1,1,1,1]},{"c":"4MTQ","n":"SEVILLA MONTEQUINTO CARREFOUR CC","d":"Maribel Amezcua","a":"SGUASQUE","e":"Formado","k":[1,1,1,1,1]},{"c":"4AZN","n":"SEVILLA CARREFOUR ALZNALFARACHE","d":"Maribel Amezcua","a":"SGUASQUE","e":"Formado","k":[1,1,1,1,1]},{"c":"4MAC","n":"SEVILLA CARREFOUR MACARENA","d":"Maribel Amezcua","a":"SGUASQUE","e":"Formado","k":[1,1,1,1,1]},{"c":"4GMA","n":"GANDÍA","d":"Marisa Carmona","a":"SGUASQUE","e":"Formado","k":[1,1,1,1,1]},{"c":"4MRM","n":"REINA DE MERCEDES","d":"Sergio Perán","a":"ARY","e":"Formado","k":[1,1,1,1,1]},{"c":"4PEC","n":"SANTANDER CC PEÑACASTILLO","d":"Sergio Perán","a":"ARY","e":"Formado","k":[1,1,1,1,1]},{"c":"4TOL","n":"TORRELAVEGA CARREFOUR CC","d":"Sergio Perán","a":"ARY","e":"Formado","k":[1,1,1,1,1]},{"c":"4VGA","n":"C.C. LA GAVIA","d":"Marisa Carmona","a":"ARY","e":"Formado","k":[1,1,1,1,1]},{"c":"4ARA","n":"ARANJUEZ Calle San Antonio","d":"Marisa Carmona","a":"ARY","e":"Formado","k":[1,1,1,1,1]},{"c":"4FIG","n":"VILATENIM CARREFOUR CC","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"Formado","k":[1,1,1,1,1]},{"c":"4ZST","n":"ZARAGOZA C/Santa Teresa","d":"ENERITZ ARANGUREN","a":"ARY","e":"Formado","k":[1,1,1,1,1]},{"c":"4ZMZ","n":"ZARAGOZA CARREFOUR CC ACTUR","d":"ENERITZ ARANGUREN","a":"ARY","e":"Formado","k":[1,1,1,1,1]},{"c":"4GIR","n":"GIRONA Plaza Miguel Santaló I Parvorell","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"Formado","k":[1,1,1,1,1]},{"c":"4LER","n":"LLEIDA","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"En Formación","k":[1,1,1,0,0]},{"c":"4CLL","n":"Lleida CC Carrefour","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"En Formación","k":[1,1,1,0,0]},{"c":"4SAB","n":"SANT ADRIÀ DE BESÒS ALCAMPO CC","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"En Formación","k":[1,1,1,0,0]},{"c":"4TCR","n":"TARRAGONA Calle Comte de Rius, 9","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"En Formación","k":[1,1,1,0,0]},{"c":"4TSP","n":"TERRASSA","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"En Formación","k":[1,1,1,0,0]},{"c":"4BVI","n":"VILADECANS CC VILAMARINA","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"En Formación","k":[1,1,1,0,0]},{"c":"4ZAI","n":"ZARAGOZA ALFONSO I","d":"ENERITZ ARANGUREN","a":"ARY","e":"En Formación","k":[1,1,1,0,0]},{"c":"4ZAU","n":"ZARAGOZA","d":"ENERITZ ARANGUREN","a":"ARY","e":"En Formación","k":[1,1,1,0,0]},{"c":"4MCF","n":"FUENCARRAL","d":"Sergio Perán","a":"ARY","e":"En Formación","k":[1,1,1,0,0]},{"c":"4GPN","n":"CC NEVADA SHOPPING","d":"Maribel Amezcua","a":"SGUASQUE","e":"En Formación","k":[1,1,1,0,0]},{"c":"4GRC","n":"GRANADA Reyes Católicos","d":"Maribel Amezcua","a":"SGUASQUE","e":"En Formación","k":[1,1,1,0,0]},{"c":"4LBR","n":"LOS BARRIOS CARREFOUR CC","d":"Maribel Amezcua","a":"SGUASQUE","e":"En Formación","k":[1,1,1,0,0]},{"c":"4MSB","n":"MALAGA CC LA ROSALEDA","d":"Maribel Amezcua","a":"SGUASQUE","e":"En Formación","k":[1,1,1,0,0]},{"c":"4MPF","n":"MALAGA Plaza Félix Sáenz","d":"Maribel Amezcua","a":"SGUASQUE","e":"En Formación","k":[1,1,1,0,0]},{"c":"4CCC","n":"CACERES","d":"Maribel Amezcua","a":"ARY","e":"En Formación","k":[1,1,1,0,0]},{"c":"4STO","n":"SALAMANCA C/Toro","d":"Sergio Perán","a":"ARY","e":"En Formación","k":[1,1,1,0,0]},{"c":"4MLV","n":"MADRID CC La Vaguada","d":"Sergio Perán","a":"ARY","e":"En Formación","k":[1,1,1,0,0]},{"c":"4ABC","n":"ALBACETE CC ALBACENTER","d":"Marisa Carmona","a":"SGUASQUE","e":"En Formación","k":[1,1,1,0,0]},{"c":"4LLA","n":"ALBACETE CC LOS LLANOS","d":"Marisa Carmona","a":"SGUASQUE","e":"En Formación","k":[1,1,1,0,0]},{"c":"4CPL","n":"CASTELLON DE LA PLANA - Calle Enmedio","d":"Marisa Carmona","a":"SGUASQUE","e":"En Formación","k":[1,1,1,0,0]},{"c":"4CCA","n":"CASTELLON CARREFOUR","d":"Marisa Carmona","a":"SGUASQUE","e":"En Formación","k":[1,1,1,0,0]},{"c":"4VIL","n":"VILANOVA","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"En Formación","k":[1,1,0,0,0]},{"c":"4DIA","n":"AVENIDA DIAGONAL","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"En Formación","k":[1,1,0,0,0]},{"c":"4RFM","n":"RUBÍ Passeig de Francesc Macià","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"En Formación","k":[1,1,0,0,0]},{"c":"4BMT","n":"BARCELONA MUNTANER","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"En Formación","k":[1,1,0,0,0]},{"c":"4BDM","n":"BARCELONA CC DIAGONAL MAR","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"En Formación","k":[1,1,0,0,0]},{"c":"4BCJ","n":"CORNELLÀ Rambla Josep Anselm Clavé","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"En Formación","k":[1,1,0,0,0]},{"c":"4CAM","n":"CARREFOUR CAMAS","d":"Maribel Amezcua","a":"SGUASQUE","e":"En Formación","k":[1,1,0,0,0]},{"c":"4MRI","n":"C.C. MADRID RIO 2","d":"Marisa Carmona","a":"ARY","e":"En Formación","k":[1,1,0,0,0]},{"c":"4MAN","n":"CC EL MANAR","d":"Marisa Carmona","a":"SGUASQUE","e":"Comienzo Inmediato","k":[0,0,0,0,0]},{"c":"4EPA","n":"PUERTO DE SANTA MARIA CARREFOUR CC","d":"Maribel Amezcua","a":"SGUASQUE","e":"Comienzo Inmediato","k":[0,0,0,0,0]},{"c":"4SMO","n":"SEVILLA San Pablo","d":"Maribel Amezcua","a":"SGUASQUE","e":"Comienzo Inmediato","k":[0,0,0,0,0]},{"c":"4BON","n":"BONAIRE","d":"Marisa Carmona","a":"SGUASQUE","e":"Comienzo Inmediato","k":[0,0,0,0,0]},{"c":"4MCI","n":"CC CIUDAD DE LA IMAGEN","d":"Marisa Carmona","a":"ARY","e":"Comienzo Inmediato","k":[0,0,0,0,0]},{"c":"4HAB","n":"TORREVIEJA","d":"Manuel Cánovas","a":"SGUASQUE","e":"Por Comenzar (Abril)","k":[0,0,0,0,0]},{"c":"4MSU","n":"C.C. MADRID SUR","d":"Sergio Perán","a":"ARY","e":"Comienzo Inmediato","k":[0,0,0,0,0]},{"c":"4IAZ","n":"C.C. ISLAZUL","d":"Marisa Carmona","a":"ARY","e":"Comienzo Inmediato","k":[0,0,0,0,0]},{"c":"4TRS","n":"RECONQUISTA","d":"Marisa Carmona","a":"ARY","e":"Por Comenzar (Abril)","k":[0,0,0,0,0]},{"c":"4OGS","n":"MADRID ORTEGA Y GASSET","d":"Sergio Perán","a":"ARY","e":"Comienzo Inmediato","k":[0,0,0,0,0]},{"c":"4EAL","n":"CC ALISAL","d":"Sergio Perán","a":"ARY","e":"Por Comenzar (Abril)","k":[0,0,0,0,0]},{"c":"4SCB","n":"C/BURGOS","d":"Sergio Perán","a":"ARY","e":"Por Comenzar (Abril)","k":[0,0,0,0,0]},{"c":"4MNA","n":"MADRID NARVÁEZ","d":"Sergio Perán","a":"ARY","e":"Comienzo Inmediato","k":[0,0,0,0,0]},{"c":"4SAG","n":"SALAMANCA CARREFOUR CC","d":"Sergio Perán","a":"ARY","e":"Por Comenzar (Abril)","k":[0,0,0,0,0]},{"c":"4TAF","n":"Talavera CC Los Alfares","d":"Marisa Carmona","a":"ARY","e":"Por Comenzar (Abril)","k":[0,0,0,0,0]},{"c":"4SGO","n":"SORIA CC LAS CAMARETAS","d":"ENERITZ ARANGUREN","a":"ARY","e":"Por Comenzar (Abril)","k":[0,0,0,0,0]},{"c":"4BIL","n":"BOADILLA Av. Infante Don Luis","d":"Marisa Carmona","a":"ARY","e":"Comienzo Inmediato","k":[0,0,0,0,0]},{"c":"4MUG","n":"MURCIA","d":"Manuel Cánovas","a":"SGUASQUE","e":"Por Comenzar (Abril)","k":[0,0,0,0,0]},{"c":"4MPC","n":"MALLORCA CAN PICAFORT","d":"Cecilia Pérez","a":"SGUASQUE","e":"Por Comenzar (Abril)","k":[0,0,0,0,0]},{"c":"4BMA","n":"MANRESA CARREFOUR CC","d":"ENERITZ ARANGUREN","a":"SGUASQUE","e":"Por Comenzar (Abril)","k":[0,0,0,0,0]},{"c":"4CUC","n":"CUENCA","d":"Marisa Carmona","a":"SGUASQUE","e":"Por Comenzar (Abril)","k":[0,0,0,0,0]}];

var datosRetroFRA_original = [{"c":"4ADU","n":"VALDEMORO","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"VILLASEÑOR Juan Angel","e":"-","k":[0,0,0,0,0]},{"c":"4ANV","n":"GRAN DE SANT ANDREU 135","d":"LAURA PLAZAS","a":"SGUASQUE","p":"CUBELLS Josep","e":"-","k":[0,0,0,0,0]},{"c":"4ADX","n":"AGUILAS","d":"Manuel Cánovas","a":"SGUASQUE","p":"LOPEZ Jose","e":"-","k":[0,0,0,0,0]},{"c":"4ANB","n":"GAVÁ","d":"LAURA PLAZAS","a":"SGUASQUE","p":"MARTINEZ MONTSE","e":"-","k":[0,0,0,0,0]},{"c":"4APQ","n":"BARAKALDO","d":"SONIA GODINO","a":"ARY","p":"RAMÍREZ  Ruben","e":"-","k":[0,0,0,0,0]},{"c":"4AJQ","n":"C.C. CARREFOUR PONTEVEDRA","d":"Verónica Alfonsín","a":"ARY","p":"FRAGUELA Jacobo","e":"-","k":[0,0,0,0,0]},{"c":"4AQI","n":"MADRID LOPEZ DE HOYOS","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"BERRIO Israel","e":"-","k":[0,0,0,0,0]},{"c":"4AQJ","n":"MADRID ACACIAS","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"BERRIO Israel","e":"-","k":[0,0,0,0,0]},{"c":"4AQU","n":"ALCOBENDAS CONSTITUCION","d":"LAURA RAMOS","a":"ARY","p":"RUIZ Alberto","e":"-","k":[0,0,0,0,0]},{"c":"4AIR","n":"C.C. PONTEVELLA","d":"Daniel Chazo","a":"ARY","p":"SELAS Manel","e":"-","k":[0,0,0,0,0]},{"c":"4AUC","n":"PALMA COLOM","d":"Cecilia Pérez","a":"SGUASQUE","p":"DOS SANTOS Johanes","e":"-","k":[0,0,0,0,0]},{"c":"4AMZ","n":"C.C. NUEVA CONDOMINA","d":"Manuel Cánovas","a":"SGUASQUE","p":"REYES Luis","e":"-","k":[0,0,0,0,0]},{"c":"4ACH","n":"C.C. CARREFOUR AZABACHE","d":"Verónica Alfonsín","a":"ARY","p":"MARTINEZ Alfredo","e":"-","k":[0,0,0,0,0]},{"c":"4ASS","n":"C.C. CARREFOUR ALCOBENDAS","d":"LAURA RAMOS","a":"ARY","p":"RUIZ Alberto","e":"-","k":[0,0,0,0,0]},{"c":"4AOD","n":"ALGECIRAS","d":"Martin SEBASTIÁN","a":"SGUASQUE","p":"VELASCO Mº Valvanera","e":"-","k":[0,0,0,0,0]},{"c":"4ARN","n":"NAVALMORAL","d":"LAURA RAMOS","a":"ARY","p":"OLIVER Javier","e":"-","k":[0,0,0,0,0]},{"c":"4AUE","n":"Oviedo Av . Galicia","d":"Verónica Alfonsín","a":"ARY","p":"MARTINEZ Alfredo","e":"-","k":[0,0,0,0,0]},{"c":"4AES","n":"AAA NARÓN","d":"Daniel Chazo","a":"ARY","p":"FRAGUELA Jacobo","e":"-","k":[0,0,0,0,0]},{"c":"4AMY","n":"C.C. MADRID XANADÚ","d":"LAURA RAMOS","a":"ARY","p":"EL FALAKI Nadia","e":"-","k":[0,0,0,0,0]},{"c":"4AUO","n":"VIC","d":"LAURA PLAZAS","a":"SGUASQUE","p":"JIMENEZ Mª Angeles","e":"-","k":[0,0,0,0,0]},{"c":"4AVA","n":"CARDEDEU","d":"LAURA PLAZAS","a":"SGUASQUE","p":"JIMENEZ Mª Angeles","e":"-","k":[0,0,0,0,0]},{"c":"4ARK","n":"ALAIN AFFLELOU OPTICO CARLET","d":"Cecilia Pérez","a":"SGUASQUE","p":"BELLOT Sonia","e":"-","k":[0,0,0,0,0]},{"c":"4AVN","n":"CASTELAO","d":"Verónica Alfonsín","a":"ARY","p":"FRAGUELA Jacobo","e":"-","k":[0,0,0,0,0]},{"c":"4AHR","n":"VILAGARCIA DE AUROSA","d":"Verónica Alfonsín","a":"ARY","p":"FRAGUELA Jacobo","e":"-","k":[0,0,0,0,0]},{"c":"4AVC","n":"DONOSTI GROS","d":"Sonia Godino","a":"ARY","p":"ALVAREZ JOSUNE","e":"-","k":[0,0,0,0,0]},{"c":"4APP","n":"ESTEPONA","d":"Martin SEBASTIÁN","a":"SGUASQUE","p":"LOZANO Consuelo","e":"-","k":[0,0,0,0,0]},{"c":"4AVP","n":"CALPE","d":"Manuel Cánovas","a":"SGUASQUE","p":"ARGUDO ALBA","e":"-","k":[0,0,0,0,0]},{"c":"4AKI","n":"CC LOS VALLES","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"PIEDRAFITA Rocio","e":"-","k":[0,0,0,0,0]},{"c":"4AVZ","n":"SEVILLA CALLE ASUNCION","d":"Maribel Amezcua","a":"SGUASQUE","p":"SOLA JUAN JOSE","e":"-","k":[0,0,0,0,0]},{"c":"4APE","n":"PULIANAS CARREFOUR CC","d":"Martin SEBASTIÁN","a":"SGUASQUE","p":"VALENTIN Adriana","e":"-","k":[0,0,0,0,0]},{"c":"4AWB","n":"MALAGA CALLE BEETHOVEN (21/6/21)","d":"Martin SEBASTIÁN","a":"SGUASQUE","p":"DE LA TORRE SANTIAGO","e":"-","k":[0,0,0,0,0]},{"c":"4ARC","n":"BURJASSOT Carretera de Llíria","d":"Cecilia Pérez","a":"SGUASQUE","p":"ESPERT VICENTA","e":"-","k":[0,0,0,0,0]},{"c":"4ATE","n":"ALMERIA Calle Navarro Rodrigo","d":"Martin SEBASTIÁN","a":"SGUASQUE","p":"VALENTIN Adriana","e":"-","k":[0,0,0,0,0]},{"c":"4AMD","n":"FERROL ALCAMPO CC","d":"Daniel Chazo","a":"ARY","p":"FRAGUELA Jacobo","e":"-","k":[0,0,0,0,0]},{"c":"4AWI","n":"PRAT DE LLOBREGAT","d":"LAURA PLAZAS","a":"SGUASQUE","p":"GOMEZ Guadalupe","e":"-","k":[0,0,0,0,0]},{"c":"4ATL","n":"CAMBRILS Carrer de les Barques","d":"LAURA PLAZAS","a":"SGUASQUE","p":"GELIS KRISTEL","e":"-","k":[0,0,0,0,0]},{"c":"4AZS","n":"FUENLABRADA Calle Leganes","d":"Laura Ramos","a":"ARY","p":"DIAZ Angel","e":"-","k":[0,0,0,0,0]},{"c":"4AUV","n":"VALLADOLID Paseo Zoriilla","d":"Daniel Chazo","a":"ARY","p":"URRUTIA Esteban","e":"-","k":[0,0,0,0,0]},{"c":"4AIE","n":"INCA Gran Vía Colón","d":"Cecilia Pérez","a":"SGUASQUE","p":"MONTES Manuela","e":"-","k":[0,0,0,0,0]},{"c":"4AWS","n":"C.C. CARREFOUR LAS ROSAS","d":"LAURA RAMOS","a":"ARY","p":"GOMEZ JOSE RAMÓN","e":"-","k":[0,0,0,0,0]},{"c":"4ATQ","n":"XIRIVELLA CC GRAN TURIA","d":"Cecilia Pérez","a":"SGUASQUE","p":"GOMEZ KATHERINE","e":"-","k":[0,0,0,0,0]},{"c":"4AWA","n":"MELIDE Calle Ronda da Coruña","d":"Verónica Alfonsín","a":"ARY","p":"MOSQUERA Marta","e":"-","k":[0,0,0,0,0]},{"c":"4AVF","n":"HOSPITALET CARREFOUR CC","d":"LAURA PLAZAS","a":"SGUASQUE","p":"BANAL Pere","e":"-","k":[0,0,0,0,0]},{"c":"4ATC","n":"C. Comercial Getafe 3","d":"LAURA RAMOS","a":"ARY","p":"CARRILLO Antonio","e":"-","k":[0,0,0,0,0]},{"c":"4AGK","n":"PETRER CARREFOUR CC","d":"Manuel Cánovas","a":"SGUASQUE","p":"CASTELLO Rafael","e":"-","k":[0,0,0,0,0]},{"c":"4ANI","n":"ONDA Avenida de País Valencià","d":"Cecilia Pérez","a":"SGUASQUE","p":"MONSERRAT VILAR MARIA AMPARO","e":"-","k":[0,0,0,0,0]},{"c":"4AWV","n":"C.C. GRAN PLAZA 2","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"PIEDRAFITA Rocio","e":"-","k":[0,0,0,0,0]},{"c":"4AHU","n":"SAN VICENTE DEL RASPEIG Avenida Alicante","d":"Manuel Cánovas","a":"SGUASQUE","p":"BOX Ana Cristina","e":"-","k":[0,0,0,0,0]},{"c":"4AQL","n":"ROTA Avenida de la Libertad","d":"Martin SEBASTIÁN","a":"SGUASQUE","p":"JIMENEZ Leonor","e":"-","k":[0,0,0,0,0]},{"c":"4AKW","n":"ALZIRA Plaza del Reino","d":"Cecilia Pérez","a":"SGUASQUE","p":"BELLOT Sonia","e":"-","k":[0,0,0,0,0]},{"c":"4AQV","n":"SAN SEBASTIAN DE LOS REYES CARREFOUR CC","d":"LAURA RAMOS","a":"ARY","p":"RUIZ Alberto","e":"-","k":[0,0,0,0,0]},{"c":"4AFH","n":"PAMPLONA Calle Sancho el Mayor","d":"Sonia Godino","a":"ARY","p":"MAZA Oriol","e":"-","k":[0,0,0,0,0]},{"c":"4ARM","n":"ZAMORA Calle Santa Clara","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"LOPEZ Mª Angeles","e":"-","k":[0,0,0,0,0]},{"c":"4AQQ","n":"UBEDA Calle Corredera de San Fernando","d":"Martin SEBASTIÁN","a":"SGUASQUE","p":"LÓPEZ José Vicente","e":"-","k":[0,0,0,0,0]},{"c":"4ASA","n":"CORDOBA CARREFOUR CC","d":"Martin SEBASTIÁN","a":"SGUASQUE","p":"MOLINA Ramón","e":"-","k":[0,0,0,0,0]},{"c":"4AXB","n":"FINESTRAT CC LA MARINA","d":"Manuel Cánovas","a":"SGUASQUE","p":"ARGUDO Alba","e":"-","k":[0,0,0,0,0]},{"c":"4ANE","n":"LEGANES CARREFOUR CC","d":"LAURA RAMOS","a":"ARY","p":"MARTINEZ LÓPEZ Raúl","e":"-","k":[0,0,0,0,0]},{"c":"4ARZ","n":"LA CORUÑA Calle Juan Flórez","d":"Daniel Chazo","a":"ARY","p":"LEMA Pablo","e":"-","k":[0,0,0,0,0]},{"c":"4AJR","n":"TORTOSA Plaza Agustí Querol","d":"Cecilia Pérez","a":"SGUASQUE","p":"BERNAL Fernando","e":"-","k":[0,0,0,0,0]},{"c":"4ALJ","n":"MONTIJO Avenida Colón","d":"LAURA RAMOS","a":"ARY","p":"CUERPO Valentín","e":"-","k":[0,0,0,0,0]},{"c":"4AXA","n":"CERDANYOLA","d":"LAURA PLAZAS","a":"SGUASQUE","p":"VADILLO Pedro","e":"-","k":[0,0,0,0,0]},{"c":"4AVE","n":"SANTA POLA Calle d'Elx","d":"Manuel Cánovas","a":"SGUASQUE","p":"DE LA CALLE MILAGROS","e":"-","k":[0,0,0,0,0]},{"c":"4AQT","n":"PUERTO DE SAGUNTO Plaza Ramón Sota","d":"Cecilia Pérez","a":"SGUASQUE","p":"MELGOSO Rafael","e":"-","k":[0,0,0,0,0]},{"c":"4AGW","n":"ONDARA CC PORTAL DE LA MARINA","d":"Cecilia Pérez","a":"SGUASQUE","p":"COLOMAR Julia","e":"-","k":[0,0,0,0,0]},{"c":"4AMJ","n":"OLIVA Calle 9 de Octubre","d":"Cecilia Pérez","a":"SGUASQUE","p":"COLOMAR Julia","e":"-","k":[0,0,0,0,0]},{"c":"4AXD","n":"CC L'Aljub  Elche","d":"Manuel Cánovas","a":"SGUASQUE","p":"BOX NATALIA","e":"-","k":[0,0,0,0,0]},{"c":"4AXF","n":"SANTIAGO DE COMPOSTELA RUA DA ROSA","d":"Daniel Chazo","a":"ARY","p":"URRUTIA Esteban","e":"-","k":[0,0,0,0,0]},{"c":"4ALY","n":"MADRID Calle Ayacucho","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"MARTÍN Laura","e":"-","k":[0,0,0,0,0]},{"c":"4ANJ","n":"OLOT Plaça Clarà","d":"Laura Plazas","a":"SGUASQUE","p":"VALLS Eva","e":"-","k":[0,0,0,0,0]},{"c":"4AXH","n":"MADRID Calle Paseo Delicias","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"BERRIO Israel","e":"-","k":[0,0,0,0,0]},{"c":"4AUB","n":"PALMA DE MALLORCA CC PORTO PI","d":"Cecilia Pérez","a":"SGUASQUE","p":"DOS SANTOS Johanes","e":"-","k":[0,0,0,0,0]},{"c":"4AWM","n":"BARCELONA Vía Augusta","d":"LAURA PLAZAS","a":"SGUASQUE","p":"CUBELLS Josep","e":"-","k":[0,0,0,0,0]},{"c":"4AXL","n":"MOSTOLES DOS MAYO","d":"LAURA RAMOS","a":"ARY","p":"Victor ORTIZ","e":"-","k":[0,0,0,0,0]},{"c":"4AXN","n":"BADAJOZ CARREFOUR CC LA GRANADILLA","d":"Maribel Amezcua","a":"ARY","p":"CASIMIRO, ELENA","e":"-","k":[0,0,0,0,0]},{"c":"4AXM","n":"BADAJOZ CARREFOUR CC","d":"Maribel Amezcua","a":"ARY","p":"CASIMIRO, ELENA","e":"-","k":[0,0,0,0,0]},{"c":"4AVS","n":"ALICANTE Calle General Lacy","d":"Manuel Cánovas","a":"SGUASQUE","p":"LÓPEZ Almudena","e":"-","k":[0,0,0,0,0]},{"c":"4AWL","n":"Torrejon CC Parque Corredor","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"JIMENEZ Juan Luis","e":"-","k":[0,0,0,0,0]},{"c":"4AWG","n":"LUGO","d":"Daniel Chazo","a":"ARY","p":"URRUTIA Esteban","e":"-","k":[0,0,0,0,0]},{"c":"4AXP","n":"TÁRREGA","d":"LAURA PLAZAS","a":"SGUASQUE","p":"GRIMAU Gemma","e":"-","k":[0,0,0,0,0]},{"c":"4AUJ","n":"TORRENT","d":"Cecilia Pérez","a":"SGUASQUE","p":"GUTIERREZ Elena","e":"-","k":[0,0,0,0,0]},{"c":"4AXY","n":"LAIN CALVO","d":"Sonia Godino","a":"ARY","p":"LUNA Ester","e":"-","k":[0,0,0,0,0]},{"c":"4AXS","n":"C.C. CARREFOUR TARRAGONA","d":"ENERITZ ARANGUREN","a":"SGUASQUE","p":"Azahara QUER","e":"-","k":[0,0,0,0,0]},{"c":"4AXO","n":"VIVIERO Avda. Cantarrana","d":"Daniel Chazo","a":"ARY","p":"XISELA LEAL PRIERTO","e":"-","k":[0,0,0,0,0]},{"c":"4AXU","n":"VALLECAS","d":"Laura RAMOS","a":"ARY","p":"BALAGUER Jaime","e":"-","k":[0,0,0,0,0]},{"c":"4AZT","n":"CC PLAZA DE LA ESTACIÓN","d":"laura Ramos","a":"ARY","p":"DIAZ Angel","e":"-","k":[0,0,0,0,0]},{"c":"4AQZ","n":"CC ALCALÁ DE HENARES","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"VENTURA Vanesa","e":"-","k":[0,0,0,0,0]},{"c":"4AXV","n":"BILBAO CORREO","d":"Sonia Godino","a":"ARY","p":"RAMÍREZ  Ruben","e":"-","k":[0,0,0,0,0]},{"c":"4AVV","n":"SANT BOI DE LLOBREGAT-BARCELONA","d":"LAURA PLAZAS","a":"SGUASQUE","p":"PEREZ Mireia","e":"-","k":[0,0,0,0,0]},{"c":"4AKB","n":"GIJÓN","d":"Verónica Alfonsín","a":"ARY","p":"MARTINEZ Alfredo","e":"-","k":[0,0,0,0,0]},{"c":"4AXR","n":"EL PALMAR","d":"Manuel Cánovas","a":"SGUASQUE","p":"GÓMEZ Ana Belén","e":"-","k":[0,0,0,0,0]},{"c":"4AYB","n":"SESTAO","d":"SONIA GODINO","a":"ARY","p":"MARCOS Irene","e":"-","k":[0,0,0,0,0]},{"c":"4AXZ","n":"CC ATALAYAS","d":"Manuel Cánovas","a":"SGUASQUE","p":"MARTÍNEZ Rosa","e":"-","k":[0,0,0,0,0]},{"c":"4AVH","n":"BARCELONA SANTS","d":"Laura Plazas","a":"SGUASQUE","p":"BANAL Pere","e":"-","k":[0,0,0,0,0]},{"c":"4AFY","n":"SAN FERNANDO DE HENARES","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"MUÑOZ Pedro","e":"-","k":[0,0,0,0,0]},{"c":"4AXX","n":"MÁLAGA HILERA","d":"Martin SEBASTIÁN","a":"SGUASQUE","p":"DE LA TORRE Santiago","e":"-","k":[0,0,0,0,0]},{"c":"4AYA","n":"MÁLAGA","d":"Martin SEBASTIÁN","a":"SGUASQUE","p":"MEDINA Delfina","e":"-","k":[0,0,0,0,0]},{"c":"4APH","n":"GETXO","d":"SONIA GODINO","a":"ARY","p":"MARCOS Irene","e":"-","k":[0,0,0,0,0]},{"c":"4AYD","n":"GENERAL RICARDOS","d":"LAURA RAMOS","a":"ARY","p":"BLANCO Ángela","e":"-","k":[0,0,0,0,0]},{"c":"4ANU","n":"ARAVACA","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"SANCHEZ Jesica","e":"-","k":[0,0,0,0,0]},{"c":"4ADQ","n":"TORREJÓN DE ARDOZ","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"MUÑOZ Pedro","e":"-","k":[0,0,0,0,0]},{"c":"4AYF","n":"MADRID FRANCOS RGUEZ","d":"LAURA RAMOS","a":"ARY","p":"ANTONA Ángela","e":"-","k":[0,0,0,0,0]},{"c":"4ASQ","n":"SAN JUAN CARREFOUR CC","d":"Manuel Cánovas","a":"SGUASQUE","p":"PÉREZ Felipe","e":"-","k":[0,0,0,0,0]},{"c":"4AWO","n":"MISLATA","d":"Cecilia Pérez","a":"SGUASQUE","p":"GOMEZ KATHERINE","e":"-","k":[0,0,0,0,0]},{"c":"4AYI","n":"LLIRIA-VALENCIA","d":"Cecilia Pérez","a":"SGUASQUE","p":"OVEJERO Gema","e":"-","k":[0,0,0,0,0]},{"c":"4AYG","n":"VALENCIA CC NUEVO CENTRO","d":"Cecilia Pérez","a":"SGUASQUE","p":"DUCE, IRIS","e":"-","k":[0,0,0,0,0]},{"c":"4AYH","n":"PZA. ESPAÑA","d":"Cecilia Pérez","a":"SGUASQUE","p":"DUCE, IRIS","e":"-","k":[0,0,0,0,0]},{"c":"4ARQ","n":"BOUZAS","d":"Verónica Alfonsín","a":"ARY","p":"TOURIÑO Miguel","e":"-","k":[0,0,0,0,0]},{"c":"4AWQ","n":"PAMPLONA Carlos III","d":"Sonia Godino","a":"ARY","p":"MAZA Oriol","e":"-","k":[0,0,0,0,0]},{"c":"4AYL","n":"ALHAMA-MURCIA","d":"Manuel Cánovas","a":"SGUASQUE","p":"GÓMEZ Ana Belén","e":"-","k":[0,0,0,0,0]},{"c":"4AYK","n":"SAN SEBASTIAN DE LOS REYES","d":"LAURA RAMOS","a":"ARY","p":"RUIZ Alberto","e":"-","k":[0,0,0,0,0]},{"c":"4ABB","n":"PAMPLONA C. Exclusivo","d":"Sonia Godino","a":"ARY","p":"MAZA Oriol","e":"-","k":[0,0,0,0,0]},{"c":"4AVU","n":"LOGROÑO","d":"SONIA GODINO","a":"ARY","p":"GOMEZ ORTIZ Lorena","e":"-","k":[0,0,0,0,0]},{"c":"4AGF","n":"PARLA","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"MUÑOZ Pedro","e":"-","k":[0,0,0,0,0]},{"c":"4AOC","n":"MEDINA DEL CAMPO","d":"Daniel Chazo","a":"ARY","p":"DE LA VEGA Laura","e":"-","k":[0,0,0,0,0]},{"c":"4AZQ","n":"ELGOIBAR","d":"SONIA GODINO","a":"ARY","p":"Iñigo","e":"-","k":[0,0,0,0,0]},{"c":"4ABI","n":"TENERIFE AÑAZA","d":"Blanca Fdez. de la Pradilla","a":"SGUASQUE","p":"DARIAS Beatriz","e":"-","k":[0,0,0,0,0]},{"c":"4ATV","n":"PLASENCIA CARREFOUR CC","d":"Laura Ramos","a":"ARY","p":"GONZALEZ Cristina","e":"-","k":[0,0,0,0,0]},{"c":"4AXC","n":"CASTRO URDIALES","d":"Sonia Godino","a":"ARY","p":"RAMÍREZ  Ruben","e":"-","k":[0,0,0,0,0]},{"c":"4AYX","n":"VALENCIA MARQUES DE SOTELO","d":"Cecilia Pérez","a":"SGUASQUE","p":"GOMEZ KATHERINE","e":"-","k":[0,0,0,0,0]},{"c":"4ADC","n":"URBIETA","d":"SONIA GODINO","a":"ARY","p":"ALBA Javier","e":"-","k":[0,0,0,0,0]},{"c":"4AWU","n":"TORREVIEJA","d":"Manuel Cánovas","a":"SGUASQUE","p":"ARENAS Vanessa","e":"-","k":[0,0,0,0,0]},{"c":"4AQN","n":"PATERNA","d":"Cecilia Pérez","a":"SGUASQUE","p":"SANCHO Silvia","e":"-","k":[0,0,0,0,0]},{"c":"4AYV","n":"MADRID Calle Principe de Vergara","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"WALID BOUHADOU","e":"-","k":[0,0,0,0,0]},{"c":"4AYO","n":"CORDOBA JESUS RESCATADO","d":"Martin SEBASTIÁN","a":"SGUASQUE","p":"MOLINA Ramón","e":"-","k":[0,0,0,0,0]},{"c":"4AYN","n":"ZARAGOZA SOBRARBE","d":"ENERITZ ARANGUREN","a":"ARY","p":"LAGUNA Teresa","e":"-","k":[0,0,0,0,0]},{"c":"4AYQ","n":"ORIHUELA","d":"Manuel Cánovas","a":"SGUASQUE","p":"MARTINEZ Paqui","e":"-","k":[0,0,0,0,0]},{"c":"4AYU","n":"MORATALAZ","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"ERUSTES Maria","e":"-","k":[0,0,0,0,0]},{"c":"4AYT","n":"MALILLA C/Oltá","d":"Cecilia Pérez","a":"SGUASQUE","p":"BONORA Anabel","e":"-","k":[0,0,0,0,0]},{"c":"4AOU","n":"IGUALADA","d":"LAURA PLAZAS","a":"SGUASQUE","p":"CUNYADO Carles","e":"-","k":[0,0,0,0,0]},{"c":"4AUX","n":"HUESCA","d":"ENERITZ ARANGUREN","a":"ARY","p":"LOPEZ Silvia","e":"-","k":[0,0,0,0,0]},{"c":"4ATU","n":"EL VENDRELL","d":"LAURA PLAZAS","a":"SGUASQUE","p":"CASTILLO Ignasi","e":"-","k":[0,0,0,0,0]},{"c":"4AWJ","n":"ANDUJAR","d":"Martin SEBASTIÁN","a":"SGUASQUE","p":"LORITE Joaquín","e":"-","k":[0,0,0,0,0]},{"c":"4AYP","n":"VILLAVERDE","d":"LAURA RAMOS","a":"ARY","p":"DIAZ Angel","e":"-","k":[0,0,0,0,0]},{"c":"4AZA","n":"TERUEL Avenida Sanz Gadea","d":"ENERITZ ARANGUREN","a":"ARY","p":"MALDONADO,Elena","e":"-","k":[0,0,0,0,0]},{"c":"4AHE","n":"VINAROS","d":"Cecilia Pérez","a":"SGUASQUE","p":"BERNAL Fernando","e":"-","k":[0,0,0,0,0]},{"c":"4AWF","n":"LUGO","d":"Daniel Chazo","a":"ARY","p":"URRUTIA Esteban","e":"-","k":[0,0,0,0,0]},{"c":"4APL","n":"LAS PALMAS Viera y Clavijo","d":"Blanca Fdez. de la Pradilla","a":"SGUASQUE","p":"MELIAN Itziar","e":"-","k":[0,0,0,0,0]},{"c":"4AQD","n":"GRANOLLERS","d":"LAURA PLAZAS","a":"SGUASQUE","p":"SANCHEZ Rubén","e":"-","k":[0,0,0,0,0]},{"c":"4ABW","n":"ALMERIA CARREFOUR","d":"Martin SEBASTIÁN","a":"SGUASQUE","p":"VALENTIN Adriana","e":"-","k":[0,0,0,0,0]},{"c":"4AZE","n":"ZARAGOZA Tenor Fleta","d":"ENERITZ ARANGUREN","a":"ARY","p":"GRIMA Raul","e":"-","k":[0,0,0,0,0]},{"c":"4AZB","n":"TRES CANTOS","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"LOPEZ LORENA","e":"-","k":[0,0,0,0,0]},{"c":"4AZI","n":"TOLOSA","d":"Sonia Godino","a":"ARY","p":"VARGAS, Javier David","e":"-","k":[0,0,0,0,0]},{"c":"4AZM","n":"MOLLERUSA","d":"LAURA PLAZAS","a":"SGUASQUE","p":"RATES Oriol","e":"-","k":[0,0,0,0,0]},{"c":"4AFI","n":"MARIN","d":"Verónica Alfonsín","a":"ARY","p":"TOURIÑO Miguel","e":"-","k":[0,0,0,0,0]},{"c":"4AZC","n":"MALAGA Calle Victoria","d":"Martin SEBASTIÁN","a":"SGUASQUE","p":"LOZANO Consuelo","e":"-","k":[0,0,0,0,0]},{"c":"4AZD","n":"GETAFE Calle Madrid","d":"LAURA RAMOS","a":"ARY","p":"BLANCO Ángela","e":"-","k":[0,0,0,0,0]},{"c":"4AYZ","n":"ESPACIO MEDITERRANEO Cartagena","d":"Manuel Cánovas","a":"SGUASQUE","p":"ESPEJO Miriam","e":"-","k":[0,0,0,0,0]},{"c":"4AMU","n":"BILBONDO","d":"Sonia Godino","a":"ARY","p":"ALDAMA, Idurre","e":"-","k":[0,0,0,0,0]},{"c":"4AZH","n":"AMPOSTA","d":"Cecilia Pérez","a":"SGUASQUE","p":"BERNAL Fernando","e":"-","k":[0,0,0,0,0]},{"c":"4ATF","n":"ALAMEDA Malaga","d":"Martin SEBASTIÁN","a":"SGUASQUE","p":"AZNAR, Daniel","e":"-","k":[0,0,0,0,0]},{"c":"4AZG","n":"VITORIA, C/FUEROS","d":"Sonia Godino","a":"ARY","p":"François  BERGUGNANT","e":"-","k":[0,0,0,0,0]},{"c":"4AHY","n":"TORREPACHECO","d":"Manuel Cánovas","a":"SGUASQUE","p":"CASTEJON Olimpia","e":"-","k":[0,0,0,0,0]},{"c":"4ATP","n":"VIDA NOVA PARC SAGUNTO","d":"Cecilia Pérez","a":"SGUASQUE","p":"ESTEVE Mireia","e":"-","k":[0,0,0,0,0]},{"c":"4AZP","n":"SEGORBE","d":"Cecilia Pérez","a":"SGUASQUE","p":"MANZANA Rosa","e":"-","k":[0,0,0,0,0]},{"c":"4AKU","n":"GUADALAJARA","d":"LAURA RAMOS","a":"ARY","p":"SANTOS, Beatriz","e":"-","k":[0,0,0,0,0]},{"c":"4AEQ","n":"JUMILLA","d":"Manuel Cánovas","a":"—","p":"MARTINEZ, Jose Luis","e":"-","k":[0,0,0,0,0]},{"c":"4AZO","n":"MONCADA","d":"CECILIA PEREZ","a":"SGUASQUE","p":"ESPERT VICENTA","e":"-","k":[0,0,0,0,0]},{"c":"4AZL","n":"MADRID GUINDALERA","d":"Blanca Fdez. de la Pradilla","a":"ARY","p":"JIMENEZ Maria Angeles","e":"-","k":[0,0,0,0,0]},{"c":"4AZY","n":"RIBADAVIA ORENSE","d":"VErónica Alfonsín","a":"ARY","p":"LOPEZ MARIA","e":"-","k":[0,0,0,0,0]},{"c":"4AWP","n":"LA LAGUNA","d":"Blanca Fdez. de la Pradilla","a":"SGUASQUE","p":"LOPEZ PATRICIA","e":"-","k":[0,0,0,0,0]}];

var datosRetroAAO = JSON.parse(JSON.stringify(datosRetroAAO_original));
var datosRetroFRA = JSON.parse(JSON.stringify(datosRetroFRA_original));

(function(){
    var g = localStorage.getItem('retroAAO_v1');
    if(g) try { datosRetroAAO = JSON.parse(g); } catch(e){}
    var h = localStorage.getItem('retroFRA_v1');
    if(h) try { datosRetroFRA = JSON.parse(h); } catch(e){}
    // Dibujo inicial del donut AAR
    setTimeout(function(){ actualizarDonutAAR(); }, 300);
})();

// Función central que actualiza el panel donut AAR del dashboard desde datosRetroAAO
function actualizarDonutAAR(gamasRing, convPct) {
    if(typeof datosRetroAAO === 'undefined') return;
    var fc=0, ff=0, fp=0;
    datosRetroAAO.forEach(function(r){
        if(r.e==='Formado') fc++;
        else if(r.e==='En Formación') ff++;
        else fp++; // Comienzo Inmediato + Abril + Sin asignar
    });
    var tot = fc + ff + fp;
    var pct = tot > 0 ? Math.round((fc / tot) * 100) : 0;
    var conv = typeof convPct === 'number' ? convPct : 0;
    var el = function(id){ return document.getElementById(id); };
    if(el('aarTotalCentros')) el('aarTotalCentros').textContent = tot + ' centros AAO';
    if(el('dash-aar-cert')) el('dash-aar-cert').textContent = fc;
    if(el('dash-aar-form')) el('dash-aar-form').textContent = ff;
    if(el('dash-aar-pend')) el('dash-aar-pend').textContent = fp;
    if(el('aarPctCenter')) el('aarPctCenter').textContent = pct + '%';
    if(el('aarBarCert')) el('aarBarCert').style.flex = fc || 1;
    if(el('aarBarForm')) el('aarBarForm').style.flex = ff || 0;
    if(el('aarBarPend')) el('aarBarPend').style.flex = fp || 1;
    if(el('dash-aar-conv')) el('dash-aar-conv').textContent = conv + '%';
    if(typeof dibujarAARMultiRing === 'function') dibujarAARMultiRing(fc, ff, fp, gamasRing || null, conv);
}

function switchRetroTab(tab) {
    retroTabActual = tab;
    var btnAAO = document.getElementById('tabRetroAAO');
    var btnFRA = document.getElementById('tabRetroFRA');
    var thProp = document.getElementById('thPropietario');
    if(tab === 'AAO') {
        btnAAO.style.background = '#C9A227'; btnAAO.style.color = '#1a1a1a'; btnAAO.style.borderColor = '#C9A227';
        btnFRA.style.background = '#f5f5f5'; btnFRA.style.color = '#666'; btnFRA.style.borderColor = '#888';
        if(thProp) thProp.style.display = 'none';
    } else {
        btnFRA.style.background = '#C9A227'; btnFRA.style.color = '#1a1a1a'; btnFRA.style.borderColor = '#C9A227';
        btnAAO.style.background = '#f5f5f5'; btnAAO.style.color = '#666'; btnAAO.style.borderColor = '#888';
        if(thProp) thProp.style.display = '';
    }
    poblarFiltroDelegado();
    renderRetroplanningAAR();
}

function poblarFiltroDelegado() {
    var sel = document.getElementById('retroFiltroDelegado');
    if(!sel) return;
    var datos = retroTabActual === 'AAO' ? datosRetroAAO : datosRetroFRA;
    var deleg = {};
    datos.forEach(function(r){ deleg[r.d] = 1; });
    var sorted = Object.keys(deleg).sort(function(a,b){ return a.localeCompare(b, 'es', {sensitivity:'base'}); });
    sel.innerHTML = '<option value="">Todos Delegados</option>';
    sorted.forEach(function(d){ sel.innerHTML += '<option value="'+d+'">'+d+'</option>'; });
}

function getRetroEstadoInfo(e) {
    switch(e) {
        case 'Formado': return {color:'#10b981',emoji:'🟢',label:'Formado',bg:'#d1fae5',border:'#10b981'};
        case 'En Formación': return {color:'#f59e0b',emoji:'🟡',label:'En Form.',bg:'#fef3c7',border:'#f59e0b'};
        case 'Comienzo Inmediato': return {color:'#ef4444',emoji:'🔴',label:'C.Inmed.',bg:'#fee2e2',border:'#ef4444'};
        case 'Por Comenzar (Abril)': return {color:'#3b82f6',emoji:'🔵',label:'Abril',bg:'#dbeafe',border:'#3b82f6'};
        default: return {color:'#888',emoji:'⚪',label:'—',bg:'#f5f5f5',border:'#ccc'};
    }
}

function renderRetroplanningAAR() {
    var datos = retroTabActual === 'AAO' ? datosRetroAAO : datosRetroFRA;
    var isFRA = retroTabActual === 'FRA';
    
    var filtro = (document.getElementById('retroBuscador')||{}).value||'';
    var fDeleg = (document.getElementById('retroFiltroDelegado')||{}).value||'';
    var fDelAAR = (document.getElementById('retroFiltroDelAAR')||{}).value||'';
    var fEstado = (document.getElementById('retroFiltroEstado')||{}).value||'';
    filtro = filtro.toLowerCase();
    
    // Contadores globales (sin filtro)
    var cnt = {formado:0, enform:0, inmed:0, abril:0, sin:0};
    datos.forEach(function(r){
        if(r.e==='Formado') cnt.formado++;
        else if(r.e==='En Formación') cnt.enform++;
        else if(r.e==='Comienzo Inmediato') cnt.inmed++;
        else if(r.e==='Por Comenzar (Abril)') cnt.abril++;
        else cnt.sin++;
    });
    var total = datos.length;
    
    // Actualizar resumen
    var el = function(id){ return document.getElementById(id); };
    if(el('retroTotalNum')) el('retroTotalNum').textContent = total;
    if(el('retroCntFormado')) el('retroCntFormado').textContent = cnt.formado;
    if(el('retroCntEnForm')) el('retroCntEnForm').textContent = cnt.enform;
    if(el('retroCntInmed')) el('retroCntInmed').textContent = cnt.inmed;
    if(el('retroCntAbril')) el('retroCntAbril').textContent = cnt.abril;
    if(el('retroCntSin')) el('retroCntSin').textContent = cnt.sin;
    var pf = total>0?Math.round(cnt.formado/total*100):0;
    if(el('retroPctFormado')) el('retroPctFormado').textContent = pf+'% ✅';
    if(el('retroPctFormado2')) el('retroPctFormado2').textContent = (total>0?Math.round(cnt.formado/total*100):0)+'%';
    if(el('retroPctEnForm')) el('retroPctEnForm').textContent = (total>0?Math.round(cnt.enform/total*100):0)+'%';
    if(el('retroPctInmed')) el('retroPctInmed').textContent = (total>0?Math.round(cnt.inmed/total*100):0)+'%';
    if(el('retroPctAbril')) el('retroPctAbril').textContent = (total>0?Math.round(cnt.abril/total*100):0)+'%';
    if(el('retroPctSin')) el('retroPctSin').textContent = (total>0?Math.round(cnt.sin/total*100):0)+'%';
    
    // Barra de progreso segmentada
    var seg = el('retroProgressSegments');
    if(seg) {
        var parts = [
            {pct:cnt.formado/total*100||0, color:'#10b981'},
            {pct:cnt.enform/total*100||0, color:'#f59e0b'},
            {pct:cnt.inmed/total*100||0, color:'#ef4444'},
            {pct:cnt.abril/total*100||0, color:'#3b82f6'},
            {pct:cnt.sin/total*100||0, color:'#ccc'}
        ];
        seg.innerHTML = '';
        parts.forEach(function(p){
            if(p.pct>0) seg.innerHTML += '<div style="height:10px;border-radius:3px;background:'+p.color+';width:'+p.pct+'%;transition:width 0.3s"></div>';
        });
    }
    
    // Badges en faldón
    if(el('badgeCertificados')) el('badgeCertificados').textContent = '🟢 '+cnt.formado;
    if(el('badgeFormacion')) el('badgeFormacion').textContent = '🟡 '+cnt.enform;
    if(el('badgePendiente')) el('badgePendiente').textContent = '🔴 '+cnt.inmed;
    if(el('badgeAbril')) el('badgeAbril').textContent = '🔵 '+cnt.abril;
    if(el('badgeSinAsignar')) el('badgeSinAsignar').textContent = '⚪ '+cnt.sin;
    
    // Tab counts
    if(el('tabRetroAAOCount')) el('tabRetroAAOCount').textContent = '('+datosRetroAAO.length+')';
    if(el('tabRetroFRACount')) el('tabRetroFRACount').textContent = '('+datosRetroFRA.length+')';
    
    // Filtrar datos
    var filtrados = datos.filter(function(r, i){
        if(filtro && !(r.c.toLowerCase().includes(filtro) || r.n.toLowerCase().includes(filtro) || r.d.toLowerCase().includes(filtro) || (r.p||'').toLowerCase().includes(filtro))) return false;
        if(fDeleg && r.d !== fDeleg) return false;
        if(fDelAAR && r.a !== fDelAAR) return false;
        if(fEstado && r.e !== fEstado) return false;
        return true;
    });
    
    if(el('retroContadorFiltro')) el('retroContadorFiltro').textContent = filtrados.length+' de '+total;
    
    // Renderizar tabla
    var tbody = document.getElementById('tbodyRetroAAR');
    if(!tbody) return;
    
    var html = '';
    filtrados.forEach(function(r){
        var idx = datos.indexOf(r);
        var info = getRetroEstadoInfo(r.e);
        var sum = r.k.reduce(function(a,b){return a+b;},0);
        var pctRow = Math.round(sum/5*100);
        
        html += '<tr style="background:'+info.bg+';border-left:4px solid '+info.border+'">';
        html += '<td style="padding:5px 4px;border-bottom:1px solid #eee;text-align:center;font-weight:600;font-size:8px;color:#555">'+r.c+'</td>';
        html += '<td style="padding:5px 4px;border-bottom:1px solid #eee;font-weight:500;font-size:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+r.n+'">'+r.n+'</td>';
        html += '<td style="padding:5px 3px;border-bottom:1px solid #eee;font-size:7px;color:#666;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+r.d+'</td>';
        html += '<td style="padding:5px 3px;border-bottom:1px solid #eee;text-align:center;font-size:8px;font-weight:600">'+r.a+'</td>';
        
        if(isFRA) html += '<td style="padding:5px 3px;border-bottom:1px solid #eee;font-size:7px;color:#666;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(r.p||'-')+'</td>';
        
        // Estado dropdown
        html += '<td style="padding:4px 2px;border-bottom:1px solid #eee;text-align:center">';
        html += '<select data-tab="'+retroTabActual+'" data-idx="'+idx+'" data-field="estado" onchange="cambiarRetroEstado(this)" style="font-size:7px;padding:3px 1px;border-radius:4px;border:1px solid '+info.color+';background:'+info.color+';color:#fff;cursor:pointer;width:100%;font-weight:600">';
        html += '<option value="Formado"'+(r.e==='Formado'?' selected':'')+'>🟢 Formado</option>';
        html += '<option value="En Formación"'+(r.e==='En Formación'?' selected':'')+'>🟡 En Form.</option>';
        html += '<option value="Comienzo Inmediato"'+(r.e==='Comienzo Inmediato'?' selected':'')+'>🔴 C.Inmed.</option>';
        html += '<option value="Por Comenzar (Abril)"'+(r.e==='Por Comenzar (Abril)'?' selected':'')+'>🔵 Abril</option>';
        html += '<option value="-"'+(r.e==='-'?' selected':'')+'>⚪ —</option>';
        html += '</select></td>';
        
        // 5 criterios - botones claros ★ Superado / ☆ Pendiente
        var criterioLabels = ['Presenc.','Online','P.Inter.','P.Conf.','Valid.'];
        for(var ki=0; ki<5; ki++) {
            var val = r.k[ki];
            if(val===1) {
                html += '<td style="padding:3px 2px;border-bottom:1px solid #eee;text-align:center;border-left:1px solid #e5e5e5">';
                html += '<div onclick="toggleRetroCriterio(\''+retroTabActual+'\','+idx+','+ki+')" style="cursor:pointer;background:#d1fae5;border:1px solid #10b981;border-radius:4px;padding:3px 1px;line-height:1.1">';
                html += '<div style="font-size:14px;color:#C9A227">★</div>';
                html += '<div style="font-size:6px;color:#065F46;font-weight:600">Superado</div>';
                html += '</div></td>';
            } else {
                html += '<td style="padding:3px 2px;border-bottom:1px solid #eee;text-align:center;border-left:1px solid #e5e5e5">';
                html += '<div onclick="toggleRetroCriterio(\''+retroTabActual+'\','+idx+','+ki+')" style="cursor:pointer;background:#f5f5f5;border:1px solid #ddd;border-radius:4px;padding:3px 1px;line-height:1.1">';
                html += '<div style="font-size:14px;color:#ccc">☆</div>';
                html += '<div style="font-size:6px;color:#999">Pendiente</div>';
                html += '</div></td>';
            }
        }
        
        // Progreso
        html += '<td style="padding:4px 2px;border-bottom:1px solid #eee;text-align:center;font-size:8px;font-weight:700">'+sum+'/5<br><span style="color:#888;font-weight:400;font-size:7px">('+pctRow+'%)</span></td>';
        
        // Rating stars - grandes y doradas
        var starsHtml = r.k.map(function(v){return v?'<span style="color:#C9A227">★</span>':'<span style="color:#ddd">☆</span>';}).join('');
        html += '<td style="padding:4px 2px;border-bottom:1px solid #eee;text-align:center;font-size:12px;letter-spacing:1px">'+starsHtml+'</td>';
        html += '</tr>';
    });
    
    tbody.innerHTML = html || '<tr><td colspan="13" style="padding:20px;text-align:center;color:#888;font-size:11px">Sin resultados para estos filtros</td></tr>';
    
    // Actualizar donut AAR en dashboard al modificar la tabla
    if(typeof actualizarDonutAAR === 'function') actualizarDonutAAR();
}

function cambiarRetroEstado(sel) {
    var tab = sel.getAttribute('data-tab');
    var idx = parseInt(sel.getAttribute('data-idx'));
    var datos = tab === 'AAO' ? datosRetroAAO : datosRetroFRA;
    var nuevoEstado = sel.value;
    datos[idx].e = nuevoEstado;
    if(nuevoEstado === 'Formado') datos[idx].k = [1,1,1,1,1];
    else if(nuevoEstado === '-') datos[idx].k = [0,0,0,0,0];
    guardarRetroAAR();
    renderRetroplanningAAR();
}

function cambiarRetroCriterio(sel) {
    var tab = sel.getAttribute('data-tab');
    var idx = parseInt(sel.getAttribute('data-idx'));
    var ki = parseInt(sel.getAttribute('data-ki'));
    var datos = tab === 'AAO' ? datosRetroAAO : datosRetroFRA;
    datos[idx].k[ki] = parseInt(sel.value);
    // Auto-update estado
    var sum = datos[idx].k.reduce(function(a,b){return a+b;},0);
    if(sum === 5) datos[idx].e = 'Formado';
    else if(sum > 0 && datos[idx].e === 'Formado') datos[idx].e = 'En Formación';
    else if(sum > 0 && datos[idx].e === '-') datos[idx].e = 'En Formación';
    guardarRetroAAR();
    renderRetroplanningAAR();
}

function toggleRetroCriterio(tab, idx, ki) {
    var datos = tab === 'AAO' ? datosRetroAAO : datosRetroFRA;
    datos[idx].k[ki] = datos[idx].k[ki] === 1 ? 0 : 1;
    var sum = datos[idx].k.reduce(function(a,b){return a+b;},0);
    if(sum === 5) datos[idx].e = 'Formado';
    else if(sum > 0 && datos[idx].e === 'Formado') datos[idx].e = 'En Formación';
    else if(sum > 0 && datos[idx].e === '-') datos[idx].e = 'En Formación';
    else if(sum === 0 && datos[idx].e === 'En Formación') datos[idx].e = '-';
    guardarRetroAAR();
    renderRetroplanningAAR();
}

function guardarRetroAAR() {
    localStorage.setItem('retroAAO_v1', JSON.stringify(datosRetroAAO));
    localStorage.setItem('retroFRA_v1', JSON.stringify(datosRetroFRA));
}

function resetRetroLocalStorage() {
    if(!confirm('¿Resetear TODOS los datos de Retroplanning a los originales del Excel?')) return;
    localStorage.removeItem('retroAAO_v1');
    localStorage.removeItem('retroFRA_v1');
    datosRetroAAO = JSON.parse(JSON.stringify(datosRetroAAO_original));
    datosRetroFRA = JSON.parse(JSON.stringify(datosRetroFRA_original));
    renderRetroplanningAAR();
    alert('✅ Datos reseteados');
}

function filtrarFormaciones() {
    renderRetroplanningAAR();
}

function actualizarContadoresFormacion() {
    renderRetroplanningAAR();
}

function guardarFormacionesAAR() {
    guardarRetroAAR();
}

// ==================== EDITOR EXCEL AAR ====================
function toggleEditorExcelAAR() {
    var content = document.getElementById('editorExcelContent');
    var icon = document.getElementById('toggleIconEditorExcel');
    // Cerrar otros paneles
    document.getElementById('dashboardAARContent').style.display = 'none';
    document.getElementById('toggleIconAAR').textContent = '▶ Clic para expandir';
    document.getElementById('formacionesAARContent').style.display = 'none';
    document.getElementById('toggleIconFormaciones').textContent = '▶';
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '▼';
        // Cargar datos si están vacíos
        if (aarData.length === 0) {
            aarData = aarDataInicial.slice();
        }
        renderTablaEditorExcelAAR();
    } else {
        content.style.display = 'none';
        icon.textContent = '▶';
    }
}

function renderTablaEditorExcelAAR() {
    var tbody = document.getElementById('tbodyEditorExcelAAR');
    if (!tbody) return;
    
    // Asegurar que aarData tenga datos
    if (!aarData || aarData.length === 0) {
        aarData = aarDataInicial.slice();
    }
    
    var html = '';
    aarData.forEach(function(row, idx) {
        var bgColor = idx % 2 === 0 ? '#fff' : '#f8fafc';
        html += '<tr data-idx="' + idx + '" style="background:' + bgColor + ';border-bottom:1px solid #e2e8f0">';
        html += '<td style="padding:4px"><input type="date" value="' + (row.fechaCita || '') + '" onchange="actualizarCeldaEditorAAR(' + idx + ',\'fechaCita\',this.value)" style="width:100%;padding:3px;border:1px solid #ddd;border-radius:3px;font-size:9px"></td>';
        html += '<td style="padding:4px"><select onchange="actualizarCeldaEditorAAR(' + idx + ',\'servicio\',this.value)" style="width:100%;padding:3px;border:1px solid #ddd;border-radius:3px;font-size:9px">';
        html += '<option value="Primera Visita"' + (row.servicio === 'Primera Visita' ? ' selected' : '') + '>Primera Visita</option>';
        html += '<option value="Ajustes"' + (row.servicio === 'Ajustes' ? ' selected' : '') + '>Ajustes</option>';
        html += '<option value="Seguimiento En Prueba"' + (row.servicio === 'Seguimiento En Prueba' ? ' selected' : '') + '>Seguimiento</option>';
        html += '</select></td>';
        html += '<td style="padding:4px"><select onchange="actualizarCeldaEditorAAR(' + idx + ',\'estado\',this.value)" style="width:100%;padding:3px;border:1px solid #ddd;border-radius:3px;font-size:9px">';
        html += '<option value="Abierto"' + (row.estado === 'Abierto' ? ' selected' : '') + '>Abierto</option>';
        html += '<option value="En curso"' + (row.estado === 'En curso' ? ' selected' : '') + '>En curso</option>';
        html += '<option value="Cerrado"' + (row.estado === 'Cerrado' ? ' selected' : '') + '>Cerrado</option>';
        html += '</select></td>';
        html += '<td style="padding:4px"><input type="text" value="' + (row.tiendaOrigen || '') + '" onchange="actualizarCeldaEditorAAR(' + idx + ',\'tiendaOrigen\',this.value)" style="width:100%;padding:3px;border:1px solid #ddd;border-radius:3px;font-size:9px"></td>';
        html += '<td style="padding:4px"><input type="text" value="' + (row.tiendaDestino || '') + '" onchange="actualizarCeldaEditorAAR(' + idx + ',\'tiendaDestino\',this.value)" style="width:100%;padding:3px;border:1px solid #ddd;border-radius:3px;font-size:9px"></td>';
        html += '<td style="padding:4px"><select onchange="actualizarCeldaEditorAAR(' + idx + ',\'revisionPerdida\',this.value)" style="width:100%;padding:3px;border:1px solid #ddd;border-radius:3px;font-size:9px">';
        html += '<option value=""' + (!row.revisionPerdida ? ' selected' : '') + '>-</option>';
        html += '<option value="Si"' + (row.revisionPerdida === 'Si' ? ' selected' : '') + '>Sí</option>';
        html += '<option value="No"' + (row.revisionPerdida === 'No' ? ' selected' : '') + '>No</option>';
        html += '<option value="Ajuste post venta"' + (row.revisionPerdida === 'Ajuste post venta' ? ' selected' : '') + '>Ajuste PV</option>';
        html += '</select></td>';
        html += '<td style="padding:4px"><select onchange="actualizarCeldaEditorAAR(' + idx + ',\'pruebaAudifonos\',this.value)" style="width:100%;padding:3px;border:1px solid #ddd;border-radius:3px;font-size:9px">';
        html += '<option value=""' + (!row.pruebaAudifonos ? ' selected' : '') + '>-</option>';
        html += '<option value="Si"' + (row.pruebaAudifonos === 'Si' ? ' selected' : '') + '>Sí</option>';
        html += '<option value="No"' + (row.pruebaAudifonos === 'No' ? ' selected' : '') + '>No</option>';
        html += '</select></td>';
        html += '<td style="padding:4px"><select onchange="actualizarCeldaEditorAAR(' + idx + ',\'cierrePrueba\',this.value)" style="width:100%;padding:3px;border:1px solid #ddd;border-radius:3px;font-size:9px">';
        html += '<option value=""' + (!row.cierrePrueba ? ' selected' : '') + '>-</option>';
        html += '<option value="Compra Audífonos"' + (row.cierrePrueba === 'Compra Audífonos' ? ' selected' : '') + '>Compra</option>';
        html += '<option value="Devuelve"' + (row.cierrePrueba === 'Devuelve' ? ' selected' : '') + '>Devuelve</option>';
        html += '<option value="Probando"' + (row.cierrePrueba === 'Probando' ? ' selected' : '') + '>Probando</option>';
        html += '</select></td>';
        html += '<td style="padding:4px"><input type="number" value="' + (row.pvp || '') + '" onchange="actualizarCeldaEditorAAR(' + idx + ',\'pvp\',this.value)" style="width:100%;padding:3px;border:1px solid #ddd;border-radius:3px;font-size:9px;text-align:right"></td>';
        html += '<td style="padding:4px"><input type="number" min="0" max="10" value="' + (row.nps !== '' && row.nps !== null ? row.nps : '') + '" onchange="actualizarCeldaEditorAAR(' + idx + ',\'nps\',this.value)" style="width:100%;padding:3px;border:1px solid #ddd;border-radius:3px;font-size:9px;text-align:center"></td>';
        html += '<td style="padding:4px;text-align:center"><button onclick="eliminarFilaEditorAAR(' + idx + ')" style="background:#ef4444;color:#fff;border:none;padding:3px 6px;border-radius:3px;font-size:9px;cursor:pointer">🗑️</button></td>';
        html += '</tr>';
    });
    tbody.innerHTML = html;
    
    // Actualizar contadores
    var contador = document.getElementById('editorExcelCount');
    if (contador) contador.textContent = aarData.length + ' registros';
    var contadorFiltro = document.getElementById('contadorFiltroAAR');
    if (contadorFiltro) contadorFiltro.textContent = 'Mostrando: ' + aarData.length + ' de ' + aarData.length;
}

function actualizarCeldaEditorAAR(idx, campo, valor) {
    if (aarData[idx]) {
        if (campo === 'nps') {
            aarData[idx][campo] = valor !== '' ? parseInt(valor) : '';
        } else {
            aarData[idx][campo] = valor;
        }
    }
}

function agregarFilaEditorAAR() {
    var nuevoId = aarData.length > 0 ? Math.max.apply(null, aarData.map(function(r) { return r.id; })) + 1 : 1;
    var hoy = new Date().toISOString().split('T')[0];
    var nuevoRegistro = {
        id: nuevoId,
        fechaCita: hoy,
        servicio: 'Primera Visita',
        estado: 'Abierto',
        tiendaOrigen: '',
        tiendaDestino: '',
        revisionPerdida: '',
        pruebaAudifonos: '',
        cierrePrueba: '',
        pvp: '',
        nps: ''
    };
    aarData.unshift(nuevoRegistro);
    renderTablaEditorExcelAAR();
}

function eliminarFilaEditorAAR(idx) {
    if (confirm('¿Eliminar este registro?')) {
        aarData.splice(idx, 1);
        renderTablaEditorExcelAAR();
    }
}

function cargarExcelEditorAAR(input) {
    var file = input.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, {type: 'array'});
            var sheet = workbook.Sheets[workbook.SheetNames[0]];
            var json = XLSX.utils.sheet_to_json(sheet);
            
            // Mapear columnas del Excel al formato interno
            aarData = json.map(function(row, idx) {
                // Parsear fecha
                var fechaRaw = row['Fecha CIta'] || row['Fecha Cita'] || row['fechaCita'] || row['FECHA'] || '';
                var fecha = '';
                if (fechaRaw) {
                    if (typeof fechaRaw === 'string' && fechaRaw.includes('-')) {
                        var partes = fechaRaw.match(/(\d{4})-(\w+)-(\d{2})/);
                        if (partes) {
                            var meses = {Jan:'01',Feb:'02',Mar:'03',Apr:'04',May:'05',Jun:'06',Jul:'07',Aug:'08',Sep:'09',Oct:'10',Nov:'11',Dec:'12'};
                            fecha = partes[1] + '-' + (meses[partes[2]] || '01') + '-' + partes[3];
                        } else {
                            fecha = fechaRaw;
                        }
                    } else if (typeof fechaRaw === 'number') {
                        var dateObj = new Date((fechaRaw - 25569) * 86400 * 1000);
                        fecha = dateObj.toISOString().split('T')[0];
                    }
                }
                
                // Estado
                var estadoRaw = row['Estado'] || row['estado'] || row['ESTADO'] || '';
                var estado = 'Abierto';
                if (estadoRaw.toString().toLowerCase().includes('cerrado') || estadoRaw.toString().toLowerCase().includes('closed')) estado = 'Cerrado';
                else if (estadoRaw.toString().toLowerCase().includes('progress') || estadoRaw.toString().toLowerCase().includes('curso')) estado = 'En curso';
                
                // Pérdida
                var perdida = row['¿Tiene Perdida?'] || row['revisionPerdida'] || '';
                if (perdida.toString().toLowerCase() === 'si') perdida = 'Si';
                else if (perdida.toString().toLowerCase() === 'no') perdida = 'No';
                else if ((row['Servicio'] || row['servicio'] || '').toString().toLowerCase() === 'ajustes') perdida = 'Ajuste post venta';
                
                // Prueba
                var prueba = row['¿Prueba Audifonos?'] || row['pruebaAudifonos'] || '';
                if (prueba.toString().toLowerCase() === 'si') prueba = 'Si';
                else if (prueba.toString().toLowerCase() === 'no') prueba = 'No';
                else prueba = '';
                
                // Cierre
                var cierre = row['Cierre de la prueba de audífonos'] || row['cierrePrueba'] || '';
                if (cierre.toString().toLowerCase().includes('compra')) cierre = 'Compra Audífonos';
                else if (cierre.toString().toLowerCase().includes('devuelve')) cierre = 'Devuelve';
                else if (cierre.toString().toLowerCase().includes('probando')) cierre = 'Probando';
                else cierre = '';
                
                // PVP
                var pvpRaw = row['Valor de la compra'] || row['pvp'] || row['PVP'] || '';
                var pvp = pvpRaw && !isNaN(parseFloat(pvpRaw)) && parseFloat(pvpRaw) > 0 ? Math.round(parseFloat(pvpRaw)).toString() : '';
                
                // NPS
                var npsRaw = row['¿Te ha gustado?'] || row['nps'] || row['NPS'] || '';
                var nps = npsRaw && !isNaN(parseInt(npsRaw)) ? parseInt(npsRaw) : '';
                
                return {
                    id: idx + 1,
                    fechaCita: fecha,
                    servicio: row['Servicio'] || row['servicio'] || 'Primera Visita',
                    estado: estado,
                    tiendaOrigen: (row['Tienda Origen'] || row['tiendaOrigen'] || '').toString().trim(),
                    tiendaDestino: (row['Tienda de Destino'] || row['tiendaDestino'] || '').toString().trim(),
                    revisionPerdida: perdida,
                    pruebaAudifonos: prueba,
                    cierrePrueba: cierre,
                    pvp: pvp,
                    nps: nps
                };
            });
            
            aarDataFiltrada = aarData.slice();
            renderTablaEditorExcelAAR();
            renderTablaAAR();
            actualizarDashboardAAR();
            alert('✅ Excel cargado: ' + aarData.length + ' registros');
        } catch (err) {
            alert('❌ Error al cargar Excel: ' + err.message);
        }
    };
    reader.readAsArrayBuffer(file);
    input.value = '';
}

function exportarExcelEditorAAR() {
    var datos = aarData.map(function(r) {
        return {
            'Fecha Cita': r.fechaCita,
            'Servicio': r.servicio,
            'Estado': r.estado,
            'Tienda Origen': r.tiendaOrigen,
            'Tienda de Destino': r.tiendaDestino,
            '¿Tiene Perdida?': r.revisionPerdida,
            '¿Prueba Audifonos?': r.pruebaAudifonos,
            'Cierre de la prueba de audífonos': r.cierrePrueba,
            'Valor de la compra': r.pvp ? parseFloat(r.pvp) : '',
            '¿Te ha gustado?': r.nps !== '' ? r.nps : ''
        };
    });
    
    var ws = XLSX.utils.json_to_sheet(datos);
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Informe AAR');
    
    // Ajustar anchos de columna
    ws['!cols'] = [
        {wch: 12}, // Fecha
        {wch: 15}, // Servicio
        {wch: 10}, // Estado
        {wch: 25}, // Tienda Origen
        {wch: 25}, // Tienda Destino
        {wch: 15}, // Pérdida
        {wch: 15}, // Prueba
        {wch: 20}, // Cierre
        {wch: 12}, // PVP
        {wch: 10}  // NPS
    ];
    
    XLSX.writeFile(wb, 'Informe_AAR_' + new Date().toISOString().split('T')[0] + '.xlsx');
}

function guardarCambiosEditorAAR() {
    aarDataFiltrada = aarData.slice();
    localStorage.setItem('aarData', JSON.stringify(aarData));
    renderTablaAAR();
    actualizarDashboardAAR();
    cargarSelectsFiltros();
    
    var elContador = document.getElementById('aarContadorFiltro');
    var elTotal = document.getElementById('aarContadorTotal');
    if (elContador) elContador.textContent = aarData.length;
    if (elTotal) elTotal.textContent = aarData.length;
    
    alert('✅ Cambios guardados: ' + aarData.length + ' registros');
}

// ==================== TABLA COMPLETA DE CENTROS ====================
async function toggleTablaCentros() {
    var content = document.getElementById('tablaCentrosContainer');
    var icon = document.getElementById('toggleIconCentros');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '▼ Ocultar';
        await cargarTablaCentrosCompleta();
    } else {
        content.style.display = 'none';
        icon.textContent = '▶ Expandir';
    }
}

// Lista maestra de centros - generada automáticamente desde centrosData (todos los centros)
const listaCentrosMaestra = centrosData
    .filter(c => c.c !== '5DEM' && c.t !== 'PRUEBAS')
    .map(c => ({
        cod: c.c,
        nombre: c.n,
        delegadoAudio: c.r === 'ARY' ? 'Ariannys Rojas' : c.r === 'SGUASQUE' ? 'Sonia Guasque' : c.r,
        delegadoRegional: c.d,
        tipo: c.t === 'EXCLUSIVO' ? 'EXCL' : c.t === 'DEMO' ? 'DEMO' : c.t === 'CORNER' ? 'STD' : c.t
    }));
console.log('[listaCentrosMaestra] Generada con ' + listaCentrosMaestra.length + ' centros desde centrosData');

async function cargarTablaCentrosCompleta() {
    const tbody = document.getElementById('tbodyCentrosCompleta');
    const countEl = document.getElementById('tablaCentrosCount');
    
    // Mostrar estado de carga
    tbody.innerHTML = '<tr><td colspan="10" style="padding:20px;text-align:center;color:#888">⏳ Conectando con Firebase...</td></tr>';
    
    // Asegurar que Firebase está inicializado (usar la misma conexión que el Cuadro de Mandos)
    if(!db) {
        await inicializarFirebase();
    }
    
    // Obtener datos de Firebase para verificar estado
    let centrosFirebase = {};
    try {
        if(db) {
            const snapshot = await db.collection('audiometrias').get();
            console.log('[Tabla Centros] Documentos en Firebase:', snapshot.size);
            snapshot.forEach(doc => {
                const data = doc.data();
                centrosFirebase[doc.id] = data;
                console.log('[Tabla Centros] Centro:', doc.id, '- Audio:', data.audio ? (Array.isArray(data.audio) ? data.audio.length : Object.keys(data.audio).length) : 0);
            });
        }
    } catch(e) {
        console.warn('[Tabla Centros] No se pudo cargar Firebase:', e);
    }
    
    // Obtener mes actual para verificar datos recientes
    const ahora = new Date();
    const mesActual = ahora.getMonth();
    const anioActual = ahora.getFullYear();
    
    let html = '';
    
    // Aplicar filtros
    const filtroDelegadoFunnel = document.getElementById('filtro-delegado-funnel');
    const delegadoFunnel = filtroDelegadoFunnel ? filtroDelegadoFunnel.value : '';
    const filtroAudioFunnel = document.getElementById('filtro-audio-funnel')?.value || '';
    const filtroPropiedadFunnel = document.getElementById('filtro-propiedad-funnel')?.value || '';
    const filtroPerimetroFunnel = document.getElementById('filtro-perimetro-funnel')?.value || '';
    
    let centrosMostrar = listaCentrosMaestra;
    
    if(delegadoFunnel) {
        centrosMostrar = centrosMostrar.filter(c => c.delegadoRegional === delegadoFunnel);
    }
    if(filtroAudioFunnel) {
        centrosMostrar = centrosMostrar.filter(c => c.delegadoAudio === filtroAudioFunnel);
    }
    if(filtroPropiedadFunnel) {
        const getCentroData = (cod) => centrosData.find(cd => cd.c === cod);
        centrosMostrar = centrosMostrar.filter(c => {
            const cd = getCentroData(c.cod);
            return cd && cd.pr === filtroPropiedadFunnel;
        });
    }
    if(filtroPerimetroFunnel) {
        const getCentroData = (cod) => centrosData.find(cd => cd.c === cod);
        centrosMostrar = centrosMostrar.filter(c => {
            const cd = getCentroData(c.cod);
            return cd && cd.pc === filtroPerimetroFunnel;
        });
    }
    
    let totalCentros = centrosMostrar.length;
    let activos = 0, conDatos = 0, sinConexion = 0, nuncaActivados = 0;
    
    centrosMostrar.forEach((centro, i) => {
        const datosFirebase = centrosFirebase[centro.cod];
        
        // Determinar estado ACTIVO
        let estadoActivo = 'nunca';
        let colorActivo = '#ef4444';
        let textoActivo = '✗';
        
        if(datosFirebase) {
            // Convertir audio a array si viene como objeto
            let audiometrias = datosFirebase.audio || [];
            if(audiometrias && !Array.isArray(audiometrias)) {
                audiometrias = Object.keys(audiometrias)
                    .sort((a,b) => parseInt(a.replace('r','')) - parseInt(b.replace('r','')))
                    .map(k => audiometrias[k]);
            }
            
            if(audiometrias.length > 0) {
                // Buscar la fecha más reciente en todas las audiometrías
                let fechaMasReciente = null;
                audiometrias.forEach(fila => {
                    const fechaStr = fila[0]; // índice 0 = fecha
                    if(fechaStr) {
                        const fecha = new Date(fechaStr);
                        if(!fechaMasReciente || fecha > fechaMasReciente) {
                            fechaMasReciente = fecha;
                        }
                    }
                });
                
                if(fechaMasReciente) {
                    const diffDias = Math.floor((ahora - fechaMasReciente) / (1000 * 60 * 60 * 24));
                    if(diffDias <= 30) {
                        estadoActivo = 'activo';
                        colorActivo = '#10b981';
                        textoActivo = '✓';
                        activos++;
                    } else {
                        estadoActivo = 'sinconexion';
                        colorActivo = '#f59e0b';
                        textoActivo = '⚠️ ' + diffDias + 'd';
                        sinConexion++;
                    }
                } else {
                    // Tiene documento pero sin fechas válidas
                    estadoActivo = 'sindatos';
                    colorActivo = '#f59e0b';
                    textoActivo = '⚠️ Sin fechas';
                    sinConexion++;
                }
            } else {
                // Documento existe pero sin audiometrías
                estadoActivo = 'vacio';
                colorActivo = '#f59e0b';
                textoActivo = '⚠️ Vacío';
                sinConexion++;
            }
        } else {
            nuncaActivados++;
        }
        
        // Determinar ACTUALIZADO (datos en mes actual)
        let tieneDataMes = false;
        let colorActualizado = '#ef4444';
        let textoActualizado = '✗';
        
        if(datosFirebase && datosFirebase.audio) {
            // Convertir audio a array si viene como objeto
            let audioMes = datosFirebase.audio;
            if(audioMes && !Array.isArray(audioMes)) {
                audioMes = Object.keys(audioMes)
                    .sort((a,b) => parseInt(a.replace('r','')) - parseInt(b.replace('r','')))
                    .map(k => audioMes[k]);
            }
            if(Array.isArray(audioMes)) {
                audioMes.forEach(fila => {
                    const fechaFila = fila[0]; // índice 0 = fecha
                    if(fechaFila) {
                        const f = new Date(fechaFila);
                        if(f.getMonth() === mesActual && f.getFullYear() === anioActual) {
                            tieneDataMes = true;
                        }
                    }
                });
            }
        }
        
        if(tieneDataMes) {
            colorActualizado = '#3b82f6';
            textoActualizado = '✓';
            conDatos++;
        }
        
        const bgColor = i % 2 === 0 ? '#fff' : '#f9fafb';
        const tipoColor = centro.tipo === 'EXCL' ? '#C9A227' : (centro.tipo === 'DEMO' ? '#8b5cf6' : '#6b7280');
        
        // Obtener datos del centro (TIPO propiedad y PC/PNC)
        const centroData = centrosData.find(cd => cd.c === centro.cod);
        const propiedad = centroData?.pr || 'FRANQUICIA';
        const esSucursal = propiedad === 'SUCURSAL';
        const tipoProp = esSucursal ? 'SUC' : 'FR';
        const colorTipoProp = esSucursal ? '#3b82f6' : '#C9A227';
        
        const pcStatus = centroData?.pc || '-';
        const colorPC = pcStatus === 'PC' ? '#10b981' : (pcStatus === 'PNC' ? '#ef4444' : '#888');
        
        const codNum = (typeof codigosNumericosCentros !== 'undefined' && codigosNumericosCentros[centro.cod]) ? codigosNumericosCentros[centro.cod] : '-';
const aarStatus = centroData?.a || 'NO';
        const aarColor = aarStatus === 'CERTIFICADO' ? '#0891b2' : (aarStatus === 'FORMACION' ? '#f59e0b' : '#d1d5db');
        const aarText = aarStatus === 'CERTIFICADO' ? '✅' : (aarStatus === 'FORMACION' ? '📚' : '—');
        const aarTitle = aarStatus === 'CERTIFICADO' ? 'AAR Certificado' : (aarStatus === 'FORMACION' ? 'En Formación AAR' : 'No AAR');
        
        html += `<tr style="background:${bgColor};border-bottom:1px solid #e5e7eb">
            <td style="padding:6px;text-align:center;font-size:9px;color:#6b7280;font-weight:600">${codNum}</td>
            <td style="padding:6px;font-weight:600"><span style="color:${tipoColor}">${centro.cod}</span></td>
            <td style="padding:6px;font-size:10px">${centro.nombre} ${centro.tipo === 'EXCL' ? '<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:2px;font-size:8px;margin-left:4px">EXCL</span>' : (centro.tipo === 'DEMO' ? '<span style="background:#8b5cf6;color:#fff;padding:1px 4px;border-radius:2px;font-size:8px;margin-left:4px">DEMO</span>' : '')}</td>
            <td style="padding:6px;text-align:center"><span style="background:${colorTipoProp};color:#fff;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:700">${tipoProp}</span></td>
            <td style="padding:6px;text-align:center"><span style="background:${colorPC};color:#fff;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:700">${pcStatus}</span></td>
            <td style="padding:6px;text-align:center;font-size:9px">${centro.delegadoAudio}</td>
            <td style="padding:6px;text-align:center;font-size:9px">${centro.delegadoRegional}</td>
            <td style="padding:6px;text-align:center"><span style="background:${aarColor};color:#fff;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:700" title="${aarTitle}">${aarText}</span></td>
<td style="padding:6px;text-align:center"><span style="background:${colorActivo};color:#fff;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:600">${textoActivo}</span></td>
            <td style="padding:6px;text-align:center"><span style="background:${colorActualizado};color:#fff;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:600">${textoActualizado}</span></td>
        </tr>`;
    });
    
    tbody.innerHTML = html;
    const delegadoInfo = delegadoFunnel ? ' (' + delegadoFunnel + ')' : '';
    countEl.textContent = totalCentros + ' centros' + delegadoInfo + ' | ' + activos + ' activos | ' + sinConexion + ' sin conexión | ' + conDatos + ' con datos mes';
    
    // Log para debug
    console.log('[Tabla Centros] Resumen: Total=' + totalCentros + ', Activos=' + activos + ', SinConexión=' + sinConexion + ', ConDatosMes=' + conDatos + ', NuncaActivados=' + nuncaActivados);
}

// Filtrar listado de centros completo
function filtrarListadoCentrosCompleto() {
    const buscar = (document.getElementById('filtroListadoBuscar')?.value || '').toLowerCase();
    const tipo = document.getElementById('filtroListadoTipo')?.value || '';
    const pc = document.getElementById('filtroListadoPC')?.value || '';
    const delegAudio = document.getElementById('filtroListadoDelegAudio')?.value || '';
    const delegReg = document.getElementById('filtroListadoDelegReg')?.value || '';
    
    const tbody = document.getElementById('tbodyCentrosCompleta');
    const countEl = document.getElementById('tablaCentrosCount');
    if (!tbody) return;
    
    let visibles = 0;
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const cod = row.querySelector('td:nth-child(2)')?.textContent || '';
        const nombre = row.querySelector('td:nth-child(3)')?.textContent || '';
        const tipoCell = row.querySelector('td:nth-child(4)')?.textContent || '';
        const pcCell = row.querySelector('td:nth-child(5)')?.textContent || '';
        const audioCell = row.querySelector('td:nth-child(6)')?.textContent || '';
        const regCell = row.querySelector('td:nth-child(7)')?.textContent || '';
        
        let visible = true;
        
        // Filtro búsqueda
        if (buscar && !cod.toLowerCase().includes(buscar) && !nombre.toLowerCase().includes(buscar)) {
            visible = false;
        }
        
        // Filtro tipo (FR/SUC)
        if (tipo && !tipoCell.includes(tipo)) {
            visible = false;
        }
        
        // Filtro PC/PNC
        if (pc && !pcCell.includes(pc)) {
            visible = false;
        }
        
        // Filtro delegado audio
        if (delegAudio) {
            const nombreAudio = delegAudio === 'ARY' ? 'Ariannys' : 'Sonia';
            if (!audioCell.includes(nombreAudio)) {
                visible = false;
            }
        }
        
        // Filtro delegado regional
        if (delegReg && !regCell.includes(delegReg.split(' ')[0])) {
            visible = false;
        }
        
        row.style.display = visible ? '' : 'none';
        if (visible) visibles++;
    });
    
    if (countEl) {
        countEl.textContent = visibles + ' de ' + rows.length + ' centros';
    }
}

// Modal para añadir nuevo centro
function abrirModalNuevoCentroListado() {
    const modal = document.createElement('div');
    modal.id = 'modalNuevoCentro';
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999';
    modal.innerHTML = `
        <div style="background:#fff;border-radius:12px;padding:20px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #C9A227">
                <h3 style="margin:0;color:#1a1a1a;font-size:16px">➕ Añadir Nuevo Centro</h3>
                <button onclick="cerrarModalNuevoCentroListado()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#888">✕</button>
            </div>
            <div style="display:grid;gap:12px">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <div>
                        <label style="font-size:11px;font-weight:600;color:#555;display:block;margin-bottom:4px">CÓDIGO *</label>
                        <input type="text" id="nuevoCentroCod" placeholder="4XXX" maxlength="5" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:12px">
                    </div>
                    <div>
                        <label style="font-size:11px;font-weight:600;color:#555;display:block;margin-bottom:4px">TIPO *</label>
                        <select id="nuevoCentroTipo" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:12px">
                            <option value="FRANQUICIA">🟡 Franquicia</option>
                            <option value="SUCURSAL">🔵 Sucursal</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label style="font-size:11px;font-weight:600;color:#555;display:block;margin-bottom:4px">NOMBRE DEL CENTRO *</label>
                    <input type="text" id="nuevoCentroNombre" placeholder="Nombre del centro" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:12px">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <div>
                        <label style="font-size:11px;font-weight:600;color:#555;display:block;margin-bottom:4px">PERÍMETRO</label>
                        <select id="nuevoCentroPC" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:12px">
                            <option value="PNC">❌ PNC</option>
                            <option value="PC">✅ PC</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:11px;font-weight:600;color:#555;display:block;margin-bottom:4px">DELEGADO AUDIO</label>
                        <select id="nuevoCentroDelegAudio" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:12px">
                            <option value="ARY">Ariannys Rojas</option>
                            <option value="SGUASQUE">Sonia Guasque</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label style="font-size:11px;font-weight:600;color:#555;display:block;margin-bottom:4px">DELEGADO REGIONAL</label>
                    <select id="nuevoCentroDelegReg" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:12px">
                        <option value="">Seleccionar...</option>
                        <option value="Blanca Fernández de la Pradilla">Blanca Fernández de la Pradilla</option>
                        <option value="Cecilia Pérez">Cecilia Pérez</option>
                        <option value="Daniel Chazo">Daniel Chazo</option>
                        <option value="Eneritz Aranguren">Eneritz Aranguren</option>
                        <option value="Laura Plazas">Laura Plazas</option>
                        <option value="Laura Ramos">Laura Ramos</option>
                        <option value="Manuel Cánovas">Manuel Cánovas</option>
                        <option value="Maribel Amezcua">Maribel Amezcua</option>
                        <option value="Marisa Carmona">Marisa Carmona</option>
                        <option value="Martín Sebastián">Martín Sebastián</option>
                        <option value="Sergio Perán">Sergio Perán</option>
                        <option value="Sonia Godino">Sonia Godino</option>
                        <option value="Verónica Alfonsín">Verónica Alfonsín</option>
                    </select>
                </div>
            </div>
            <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
                <button onclick="cerrarModalNuevoCentroListado()" style="background:#6b7280;color:#fff;border:none;padding:10px 20px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer">Cancelar</button>
                <button onclick="guardarNuevoCentroListado()" style="background:#10b981;color:#fff;border:none;padding:10px 20px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer">💾 Guardar Centro</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function cerrarModalNuevoCentroListado() {
    const modal = document.getElementById('modalNuevoCentro');
    if (modal) modal.remove();
}

function guardarNuevoCentroListado() {
    const cod = document.getElementById('nuevoCentroCod')?.value?.toUpperCase().trim();
    const nombre = document.getElementById('nuevoCentroNombre')?.value?.trim();
    const tipo = document.getElementById('nuevoCentroTipo')?.value;
    const pc = document.getElementById('nuevoCentroPC')?.value;
    const delegAudio = document.getElementById('nuevoCentroDelegAudio')?.value;
    const delegReg = document.getElementById('nuevoCentroDelegReg')?.value;
    
    if (!cod || !nombre) {
        alert('❌ Código y Nombre son obligatorios');
        return;
    }
    
    // Verificar si ya existe
    if (centrosData.find(c => c.c === cod)) {
        alert('❌ Ya existe un centro con el código ' + cod);
        return;
    }
    
    // Añadir a centrosData
    const nuevoCentro = {
        c: cod,
        n: nombre,
        p: 'AAO',
        d: delegReg || 'Sin asignar',
        r: delegAudio,
        a: 'NO',
        t: 'CORNER',
        pc: pc,
        pr: tipo
    };
    
    centrosData.push(nuevoCentro);
    
    // Guardar en localStorage
    localStorage.setItem('centrosDataExtra', JSON.stringify(centrosData.filter(c => !c.original)));
    
    // Marcar como añadido manualmente
    nuevoCentro.manual = true;
    
    // Recargar tabla
    cargarTablaCentrosCompleta();
    
    cerrarModalNuevoCentroListado();
    alert('✅ Centro ' + cod + ' añadido correctamente');
}

function imprimirTablaCentros() {
    const tabla = document.getElementById('tablaCentrosCompleta');
    const countEl = document.getElementById('tablaCentrosCount');
    
    const ventana = window.open('', '_blank');
    ventana.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Listado de Centros - Audio Afflelou</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { color: #C9A227; font-size: 18px; margin-bottom: 5px; }
                .fecha { color: #666; font-size: 12px; margin-bottom: 15px; }
                .resumen { background: #f3f4f6; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 12px; }
                table { width: 100%; border-collapse: collapse; font-size: 11px; }
                th { background: #1a1a1a; color: #fff; padding: 8px; text-align: left; }
                td { padding: 6px 8px; border-bottom: 1px solid #e5e7eb; }
                tr:nth-child(even) { background: #f9fafb; }
                .badge { padding: 2px 6px; border-radius: 3px; color: #fff; font-size: 9px; font-weight: 600; }
                @media print { body { padding: 10px; } }
            </style>
        </head>
        <body>
            <h1>📋 LISTADO COMPLETO DE CENTROS - AUDIO AFFLELOU</h1>
            <div class="fecha">Generado: ${new Date().toLocaleDateString('es-ES', {weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit'})}</div>
            <div class="resumen">${countEl.textContent}</div>
            <table>
                ${tabla.innerHTML}
            </table>
            <scr` + `ipt>window.print();<\/scr` + `ipt>
        </body>
        </html>
    `);
    ventana.document.close();
}

// ==================== LIMPIAR DATOS DEMO (4ARY, 4DAV, 4SON) ====================
async function limpiarDatosDemo() {
    const DEMO_CENTROS = ['4ARY', '4DAV', '4SON'];
    
    if(!confirm('⚠️ ATENCIÓN: Esto eliminará TODOS los datos de los centros demo (' + DEMO_CENTROS.join(', ') + ') de:\n\n• Firebase (datos del funnel)\n• Gráficas y estadísticas\n• Dashboard\n\n¿Está seguro de continuar?')) {
        return;
    }
    
    try {
        // 1. Eliminar de Firebase
        if(FirebaseManagerAdmin && FirebaseManagerAdmin.db()) {
            const db = FirebaseManagerAdmin.db();
            for(const centro of DEMO_CENTROS) {
                try {
                    await db.collection('audiometrias').doc(centro).delete();
                    console.log('[Demo] ✓ Eliminado de Firebase:', centro);
                } catch(e) {
                    console.warn('[Demo] No se pudo eliminar ' + centro + ':', e.message);
                }
            }
        }
        
        // 2. Limpiar datos locales relacionados con los demos
        const keysToClean = ['cifrasMesActual', 'cifrasPrevMes', 'accionesCentros', 'funnelDashboardData'];
        keysToClean.forEach(key => {
            try {
                const data = JSON.parse(localStorage.getItem(key) || '{}');
                let changed = false;
                DEMO_CENTROS.forEach(centro => {
                    if(data[centro]) { delete data[centro]; changed = true; }
                });
                if(changed) localStorage.setItem(key, JSON.stringify(data));
            } catch(e) {}
        });
        
        // 3. Limpiar funnelDataCache
        DEMO_CENTROS.forEach(centro => delete funnelDataCache[centro]);
        
        // 4. Recargar gráficas y datos
        if(typeof cargarGamasFirebase === 'function') {
            await cargarGamasFirebase();
        }
        
        alert('✅ Datos demo eliminados correctamente.\n\nLa página se recargará.');
        location.reload();
        
    } catch(e) {
        alert('❌ Error al limpiar datos demo: ' + e.message);
        console.error('[Demo] Error:', e);
    }
}

// Inicializar al cargar sección
function initExclusivosFlop() {
    renderExclusivosFlop();
}

// ==================== REPORTE CONSOLIDADO ====================
function generarReporte(tipo) {
    let centros = [];
    let titulo = '';
    
    if (tipo === 'exclusivos') {
        centros = centrosData.filter(c => c.t === 'EXCLUSIVO');
        titulo = '📊 REPORTE CENTROS EXCLUSIVOS';
    } else {
        centros = centrosFlop.map(codigo => centrosData.find(c => c.c === codigo)).filter(c => c);
        titulo = '📊 REPORTE CENTROS FLOP';
    }
    
    document.getElementById('reporteTitulo').textContent = titulo;
    
    // Calcular totales
    let totalAcciones = 0, totalDerivaciones = 0, totalCitas = 0, totalVentas = 0;
    
    let contenidoHTML = '';
    
    centros.forEach(centro => {
        const acciones = accionesCentros[centro.c] || [];
        if (acciones.length === 0) return;
        
        let subtotalDeriv = 0, subtotalCitas = 0, subtotalVentas = 0;
        
        contenidoHTML += `
            <div style="margin-bottom:20px;border:1px solid #e0e0e0;border-radius:8px;overflow:hidden">
                <div style="background:linear-gradient(135deg,#C9A227,#B8963D);padding:10px 14px;color:#fff;display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <span style="font-weight:700;font-size:12px">${centro.c}</span> - 
                        <span style="font-size:11px">${centro.n}</span>
                    </div>
                    <span style="font-size:10px;opacity:0.9">${acciones.length} acciones</span>
                </div>
                <table style="width:100%;border-collapse:collapse;font-size:10px">
                    <thead>
                        <tr style="background:#f8f8f8;border-bottom:1px solid #e0e0e0">
                            <th style="padding:8px;text-align:left">FECHA</th>
                            <th style="padding:8px;text-align:left">TIPO ACCIÓN</th>
                            <th style="padding:8px;text-align:center">DERIV.</th>
                            <th style="padding:8px;text-align:center">CITAS</th>
                            <th style="padding:8px;text-align:center">VENTAS</th>
                            <th style="padding:8px;text-align:left">OBSERVACIONES</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        acciones.forEach((a, idx) => {
            const deriv = parseInt(a.derivaciones) || 0;
            const citas = parseInt(a.citas) || 0;
            const ventas = parseInt(a.ventas) || 0;
            
            subtotalDeriv += deriv;
            subtotalCitas += citas;
            subtotalVentas += ventas;
            
            contenidoHTML += `
                <tr style="border-bottom:1px solid #f0f0f0;${idx % 2 === 0 ? 'background:#fafafa' : ''}">
                    <td style="padding:6px 8px">${a.fecha || '-'}</td>
                    <td style="padding:6px 8px">${a.tipo || '-'}</td>
                    <td style="padding:6px 8px;text-align:center;font-weight:600;color:#C9A227">${deriv}</td>
                    <td style="padding:6px 8px;text-align:center;font-weight:600;color:#6b7280">${citas}</td>
                    <td style="padding:6px 8px;text-align:center;font-weight:600;color:#b8960c">${ventas}</td>
                    <td style="padding:6px 8px;color:#666">${a.observaciones || '-'}</td>
                </tr>`;
        });
        
        contenidoHTML += `
                    </tbody>
                    <tfoot>
                        <tr style="background:#f0f0f0;font-weight:700">
                            <td colspan="2" style="padding:8px;text-align:right">SUBTOTAL:</td>
                            <td style="padding:8px;text-align:center;color:#C9A227">${subtotalDeriv}</td>
                            <td style="padding:8px;text-align:center;color:#6b7280">${subtotalCitas}</td>
                            <td style="padding:8px;text-align:center;color:#b8960c">${subtotalVentas}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>`;
        
        totalAcciones += acciones.length;
        totalDerivaciones += subtotalDeriv;
        totalCitas += subtotalCitas;
        totalVentas += subtotalVentas;
    });
    
    if (contenidoHTML === '') {
        contenidoHTML = '<p style="text-align:center;color:#888;padding:40px">No hay acciones registradas en estos centros</p>';
    }
    
    // Actualizar totales
    document.getElementById('reporteTotalCentros').textContent = centros.length;
    document.getElementById('reporteTotalAcciones').textContent = totalAcciones;
    document.getElementById('reporteTotalDerivaciones').textContent = totalDerivaciones;
    document.getElementById('reporteTotalCitas').textContent = totalCitas;
    document.getElementById('reporteTotalVentas').textContent = totalVentas;
    
    document.getElementById('reporteContenido').innerHTML = contenidoHTML;
    document.getElementById('modalReporte').style.display = 'flex';
}

function cerrarModalReporte() {
    document.getElementById('modalReporte').style.display = 'none';
}

function imprimirReporte() {
    const contenido = document.getElementById('modalReporte').querySelector('div').innerHTML;
    const ventana = window.open('', '_blank');
    ventana.document.write(`
        <html>
        <head>
            <title>Reporte de Acciones</title>
            <style>
                * { font-family: 'Segoe UI', sans-serif; }
                body { padding: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { padding: 8px; border: 1px solid #ddd; }
                th { background: #C9A227; color: #fff; }
                @media print { button { display: none; } }
            </style>
        </head>
        <body>${contenido}</body>
        </html>
    `);
    ventana.document.close();
    ventana.print();
}

// ==================== FIN EXCLUSIVOS Y FLOP ====================

// Visitas agendadas
let visitasAgendadas = JSON.parse(localStorage.getItem('visitasAgendadas') || '[]');
let centroAgendar = null;
let centroEditar = null;

// Visitas puntuales (sin informe completo)
let visitasPuntuales = JSON.parse(localStorage.getItem('visitasPuntuales') || '[]');

// ═══════════════════════════════════════════════════════════════
// LISTADO COMPLETO DE CENTROS EN CALENDARIO
// ═══════════════════════════════════════════════════════════════

function toggleListadoCentrosCalendario() {
    const container = document.getElementById('calListadoContainer');
    const toggle = document.getElementById('calListadoToggle');
    if(container.style.display === 'none') {
        container.style.display = 'block';
        toggle.textContent = '▼ Cerrar';
        renderListadoCentrosCalendario();
    } else {
        container.style.display = 'none';
        toggle.textContent = '▶ Expandir';
    }
}

function renderListadoCentrosCalendario() {
    const tbody = document.getElementById('calListadoTbody');
    const countEl = document.getElementById('calListadoCount');
    const resumenEl = document.getElementById('calListadoResumen');
    if(!tbody) return;
    
    const hoy = new Date().toISOString().slice(0, 10);
    const visitas = JSON.parse(localStorage.getItem('visitasAgendadas') || '[]');
    const finalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');
    const preinformesData = JSON.parse(localStorage.getItem('preinformes') || '[]');
    
    // Filtros
    const buscar = (document.getElementById('calListadoBuscar')?.value || '').toLowerCase();
    const filtroDelegReg = document.getElementById('calListadoFiltroDelegReg')?.value || '';
    const filtroDelegAudio = document.getElementById('calListadoFiltroDelegAudio')?.value || '';
    const filtroEstado = document.getElementById('calListadoFiltroEstado')?.value || '';
    const filtroPropiedad = document.getElementById('calListadoFiltroPropiedad')?.value || '';
    const filtroPerimetro = document.getElementById('calListadoFiltroPerimetro')?.value || '';
    
    // Recoger datos de cada centro
    const filas = [];
    
    centrosData.forEach(centro => {
        if(centro.t === 'PRUEBAS' || centro.c === '5DEM') return;
        
        const cod = centro.c;
        const nombre = centro.n || '';
        const delegReg = centro.d || '-';
        const delegAudio = centro.r === 'ARY' ? 'Ariannys Rojas' : centro.r === 'SGUASQUE' ? 'Sonia Guasque' : centro.r || '-';
        
        // Buscar visitas de este centro (puede haber múltiples)
        const visitasDelCentro = visitas.filter(v => v.codigo === cod);
        const visitaPendiente = visitasDelCentro.find(v => !v.finalizado);
        const visitaFinalizada = visitasDelCentro.find(v => v.finalizado);
        
        // Buscar informe finalizado para este centro
        const informe = finalizados.find(f => f.centro && (f.centro.toUpperCase().includes(cod) || f.centro.toUpperCase() === nombre.toUpperCase()));
        
        // Buscar preinforme para este centro
        const preinforme = preinformesData.find(p => p.centro && (p.centro.toUpperCase().includes(cod) || p.centro.toUpperCase() === nombre.toUpperCase()));
        
        let estado = 'pendiente';
        let fechaAgendada = '';
        let fechaVisitada = '';
        
        if(informe) {
            // Tiene informe finalizado = VISITADO
            estado = 'visitado';
            fechaVisitada = informe.fecha || '';
        } else if(visitaFinalizada || preinforme) {
            // Visita finalizada o preinforme pero SIN informe = PENDIENTE DE INFORME
            estado = 'pendiente_informe';
            fechaVisitada = visitaFinalizada?.fecha || preinforme?.fecha || '';
        } else if(visitaPendiente) {
            // Tiene visita agendada no finalizada
            fechaAgendada = visitaPendiente.fecha || '';
            if(fechaAgendada && fechaAgendada <= hoy) {
                // Fecha pasada pero no finalizada = pendiente de informe
                estado = 'pendiente_informe';
                fechaVisitada = fechaAgendada;
            } else {
                estado = 'agendado';
            }
        }
        
        // Aplicar filtros
        if(buscar && !cod.toLowerCase().includes(buscar) && !nombre.toLowerCase().includes(buscar) && !delegReg.toLowerCase().includes(buscar)) return;
        if(filtroDelegReg && delegReg !== filtroDelegReg) return;
        if(filtroDelegAudio && centro.r !== filtroDelegAudio) return;
        if(filtroEstado && estado !== filtroEstado) return;
        if(filtroPropiedad && centro.pr !== filtroPropiedad) return;
        if(filtroPerimetro && centro.pc !== filtroPerimetro) return;
        
        filas.push({ cod, nombre, delegReg, delegAudio, rKey: centro.r, estado, fechaAgendada, fechaVisitada, propiedad: centro.pr, perimetro: centro.pc });
    });
    
    // Ordenar: visitados, pendiente_informe, agendados, pendientes
    const ordenEstado = { visitado: 0, pendiente_informe: 1, agendado: 2, pendiente: 3 };
    filas.sort((a, b) => {
        const diff = ordenEstado[a.estado] - ordenEstado[b.estado];
        if(diff !== 0) return diff;
        // Dentro del mismo grupo: por fecha desc (más reciente primero) o nombre
        if(a.estado === 'visitado' || a.estado === 'pendiente_informe') return (b.fechaVisitada || '').localeCompare(a.fechaVisitada || '');
        if(a.estado === 'agendado') return (a.fechaAgendada || '').localeCompare(b.fechaAgendada || '');
        return a.nombre.localeCompare(b.nombre);
    });
    
    // Renderizar con separadores de grupo
    let html = '';
    let total = 0, agendados = 0, visitados = 0, pendientes = 0, pendientesInforme = 0;
    let grupoActual = '';
    
    filas.forEach(fila => {
        total++;
        if(fila.estado === 'agendado') agendados++;
        else if(fila.estado === 'visitado') visitados++;
        else if(fila.estado === 'pendiente_informe') pendientesInforme++;
        else pendientes++;
        
        // Separador de grupo
        if(fila.estado !== grupoActual) {
            grupoActual = fila.estado;
            let grupoBg, grupoIcon, grupoLabel;
            if(grupoActual === 'visitado') { grupoBg = '#d1fae5'; grupoIcon = '✅'; grupoLabel = 'V.PROCESO (con informe)'; }
            else if(grupoActual === 'pendiente_informe') { grupoBg = '#fff7ed'; grupoIcon = '👁'; grupoLabel = 'V.PUNTUAL (sin informe)'; }
            else if(grupoActual === 'agendado') { grupoBg = '#dbeafe'; grupoIcon = '📅'; grupoLabel = 'AGENDADOS'; }
            else { grupoBg = '#fee2e2'; grupoIcon = '⏳'; grupoLabel = 'PENDIENTES'; }
            html += `<tr><td colspan="7" style="padding:6px 10px;background:${grupoBg};font-weight:700;font-size:11px;color:#333">${grupoIcon} ${grupoLabel}</td></tr>`;
        }
        
        let estadoBg, estadoText;
        if(fila.estado === 'agendado') { estadoBg = '#3b82f6'; estadoText = '📅 Agendado'; }
        else if(fila.estado === 'visitado') { estadoBg = '#10b981'; estadoText = '✅ V.Proceso'; }
        else if(fila.estado === 'pendiente_informe') { estadoBg = '#f59e0b'; estadoText = '👁 V.Puntual'; }
        else { estadoBg = '#ef4444'; estadoText = '⏳ Pendiente'; }
        
        html += `<tr style="border-bottom:1px solid #f0f0f0">
            <td style="padding:6px;font-weight:700;color:#C9A227">${fila.cod}</td>
            <td style="padding:6px">${fila.nombre}</td>
            <td style="padding:6px;text-align:center;font-size:10px">${fila.delegReg}</td>
            <td style="padding:6px;text-align:center;font-size:10px">${fila.delegAudio}</td>
            <td style="padding:6px;text-align:center;font-size:10px">${fila.fechaAgendada ? '<span style="background:#dbeafe;color:#1e40af;padding:2px 6px;border-radius:4px">' + fila.fechaAgendada + '</span>' : '<span style="color:#ccc">-</span>'}</td>
            <td style="padding:6px;text-align:center;font-size:10px">${fila.fechaVisitada ? '<span style="background:#d1fae5;color:#065f46;padding:2px 6px;border-radius:4px">' + fila.fechaVisitada + '</span>' : '<span style="color:#ccc">-</span>'}</td>
            <td style="padding:6px;text-align:center"><span style="background:${estadoBg};color:#fff;padding:2px 8px;border-radius:4px;font-size:9px;font-weight:600">${estadoText}</span></td>
        </tr>`;
    });
    
    if(total === 0) {
        html = '<tr><td colspan="7" style="padding:20px;text-align:center;color:#888">No se encontraron centros con los filtros seleccionados</td></tr>';
    }
    
    tbody.innerHTML = html;
    if(countEl) countEl.textContent = total + ' centros';
    if(resumenEl) resumenEl.innerHTML = `
        <span><strong>${total}</strong> centros</span>
        <span style="color:#C9A227">✅ <strong>${visitados}</strong> V.Proceso</span>
        <span style="color:#D4AF37">👁 <strong>${pendientesInforme}</strong> V.Puntual</span>
        <span style="color:#3b82f6">📅 <strong>${agendados}</strong> agendados</span>
        <span style="color:#8B7355">⏳ <strong>${pendientes}</strong> pendientes</span>
    `;
}

function filtrarListadoCentrosCalendario() {
    renderListadoCentrosCalendario();
}

function actualizarContadoresResponsable() {
    // Total de centros por responsable
    const totalARY = centrosData.filter(c => c.r === 'ARY').length;
    const totalSG = centrosData.filter(c => c.r === 'SGUASQUE').length;
    
    // Set de centros con informes finalizados (V.PROCESO)
    const informesFinalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');
    const centrosConInforme = new Set();
    informesFinalizados.forEach(f => {
        if(f.centro) centrosConInforme.add(f.centro.toUpperCase());
    });
    
    // Centros únicos con visita finalizada en calendario por responsable
    const centrosVisitCalARY = new Set();
    const centrosVisitCalSG = new Set();
    visitasAgendadas.filter(v => v.finalizado).forEach(v => {
        const centro = centrosData.find(c => c.c === v.codigo);
        if(centro?.r === 'ARY') centrosVisitCalARY.add(v.codigo.toUpperCase());
        if(centro?.r === 'SGUASQUE') centrosVisitCalSG.add(v.codigo.toUpperCase());
    });
    
    // Agendados por responsable (no finalizados) - centros únicos
    const centrosAgendARY = new Set();
    const centrosAgendSG = new Set();
    visitasAgendadas.filter(v => !v.finalizado).forEach(v => {
        const centro = centrosData.find(c => c.c === v.codigo);
        if(centro?.r === 'ARY') centrosAgendARY.add(v.codigo.toUpperCase());
        if(centro?.r === 'SGUASQUE') centrosAgendSG.add(v.codigo.toUpperCase());
    });
    
    // V.PROCESO = centros con informe finalizado Y registrado en calendario (visita finalizada)
    // Si tiene informe, cuenta como proceso aunque no esté en calendario
    let procesoARY = 0, procesoSG = 0;
    centrosData.forEach(c => {
        const cod = c.c.toUpperCase();
        if(centrosConInforme.has(cod)) {
            if(c.r === 'ARY') procesoARY++;
            if(c.r === 'SGUASQUE') procesoSG++;
        }
    });
    
    // V.PUNTUAL = centros con visita finalizada en calendario PERO SIN informe finalizado
    let puntualARY = 0, puntualSG = 0;
    centrosVisitCalARY.forEach(cod => {
        if(!centrosConInforme.has(cod)) puntualARY++;
    });
    centrosVisitCalSG.forEach(cod => {
        if(!centrosConInforme.has(cod)) puntualSG++;
    });
    
    const agendadosARY = centrosAgendARY.size;
    const agendadosSG = centrosAgendSG.size;
    
    // Pendientes = Total - Proceso - Puntual - Agendados
    const pendientesARY = Math.max(0, totalARY - procesoARY - puntualARY - agendadosARY);
    const pendientesSG = Math.max(0, totalSG - procesoSG - puntualSG - agendadosSG);
    
    // Actualizar elementos
    const el = (id) => document.getElementById(id);
    if(el('totalCentrosARY')) el('totalCentrosARY').textContent = totalARY;
    if(el('totalCentrosSG')) el('totalCentrosSG').textContent = totalSG;
    if(el('agendadosARY')) el('agendadosARY').textContent = agendadosARY;
    if(el('agendadosSG')) el('agendadosSG').textContent = agendadosSG;
    if(el('procesoARY')) el('procesoARY').textContent = procesoARY;
    if(el('procesoSG')) el('procesoSG').textContent = procesoSG;
    if(el('puntualARY')) el('puntualARY').textContent = puntualARY;
    if(el('puntualSG')) el('puntualSG').textContent = puntualSG;
    if(el('pendientesARY')) el('pendientesARY').textContent = pendientesARY;
    if(el('pendientesSG')) el('pendientesSG').textContent = pendientesSG;
}

function renderCentrosVisitas() {
    const buscar = (document.getElementById('buscadorCentros')?.value || '').toLowerCase();
    const filtroAAR = document.getElementById('filtroAAR')?.value || '';
    const filtroTipo = document.getElementById('filtroTipo')?.value || '';
    const filtroDelegReg = document.getElementById('filtroDelegRegVisitas')?.value || '';
    const filtroDelegAudio = document.getElementById('filtroDelegAudioVisitas')?.value || '';
    const filtroPropiedad = document.getElementById('filtroPropiedadVisitas')?.value || '';
    const filtroPerimetro = document.getElementById('filtroPerimetroVisitas')?.value || '';
    const listaARY = document.getElementById('listaARY');
    const listaSGUASQUE = document.getElementById('listaSGUASQUE');
    const listaAgendados = document.getElementById('listaAgendados');
    
    // Filtrar por todos los criterios
    const filtrar = (c) => {
        const matchBuscar = c.n.toLowerCase().includes(buscar) || c.c.toLowerCase().includes(buscar);
        const matchAAR = !filtroAAR || c.a === filtroAAR;
        const matchTipo = !filtroTipo || 
            (filtroTipo === 'AAR_CERT' ? c.a === 'CERTIFICADO' : 
             filtroTipo === 'AAR_FORM' ? c.a === 'FORMACION' : 
             filtroTipo === 'AAR_NO' ? (c.a !== 'CERTIFICADO' && c.a !== 'FORMACION') : 
             c.t === filtroTipo);
        const matchDelegReg = !filtroDelegReg || c.d === filtroDelegReg;
        const matchDelegAudio = !filtroDelegAudio || c.r === filtroDelegAudio;
        const matchPropiedad = !filtroPropiedad || c.pr === filtroPropiedad;
        const matchPerimetro = !filtroPerimetro || c.pc === filtroPerimetro;
        return matchBuscar && matchAAR && matchTipo && matchDelegReg && matchDelegAudio && matchPropiedad && matchPerimetro;
    };
    
    const centrosARY = centrosData.filter(c => c.r === 'ARY' && filtrar(c));
    const centrosSGUASQUE = centrosData.filter(c => c.r === 'SGUASQUE' && filtrar(c));
    
    // Contar AAR y tipos
    const aarCertARY = centrosData.filter(c => c.r === 'ARY' && c.a === 'CERTIFICADO').length;
    const aarCertSG = centrosData.filter(c => c.r === 'SGUASQUE' && c.a === 'CERTIFICADO').length;
    const exclARY = centrosData.filter(c => c.r === 'ARY' && c.t === 'EXCLUSIVO').length;
    const exclSG = centrosData.filter(c => c.r === 'SGUASQUE' && c.t === 'EXCLUSIVO').length;
    
    document.getElementById('countARY').innerHTML = `${centrosARY.length} centros <span style="font-size:8px;opacity:0.8">(${aarCertARY} AAR · ${exclARY} Excl)</span>`;
    document.getElementById('countSGUASQUE').innerHTML = `${centrosSGUASQUE.length} centros <span style="font-size:8px;opacity:0.8">(${aarCertSG} AAR · ${exclSG} Excl)`;
    document.getElementById('totalCentrosVisitas').textContent = centrosData.length;
    
    // Actualizar contadores por responsable
    actualizarContadoresResponsable();
    
    const renderCentro = (c) => {
        const aarBadge = c.a === 'CERTIFICADO' ? '<span style="background:#C9A227;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR ✓</span>' :
                         c.a === 'FORMACION' ? '<span style="background:#b8960c;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">AAR 📚</span>' : '';
        const tipoBadge = c.t === 'EXCLUSIVO' ? '<span style="background:#8b5cf6;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">Exclusivo</span>' : 
                          c.t === 'DEMO' ? '<span style="background:#8b5cf6;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">🧪 DEMO</span>' :
                          '<span style="background:#6b7280;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">CÓRNER</span>';
        
        // Badges de PC/PNC y Propiedad
        const pcBadge = c.pc === 'PNC' ? '<span style="background:#ef4444;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">PNC</span>' : 
                        '<span style="background:#22c55e;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">PC</span>';
        const prBadge = c.pr === 'SUCURSAL' ? '<span style="background:#3b82f6;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">SUC</span>' : 
                        '<span style="background:#f59e0b;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">FRQ</span>';
        
        // Determinar estados del centro
        var estadoBadges = '';
        var tieneInforme = informesFinalizados.some(inf => inf.centro === c.c || inf.centro === c.n);
        var tieneInforme = informesFinalizados.some(inf => inf.centro === c.c || inf.centro === c.n);
        var tieneBorrador = informesBorrador.some(b => b.centro === c.c || b.centro === c.n);
        var tienePreinforme = preinformes.some(p => p.centro === c.c || p.centro === c.n);
        var tieneAgendado = visitasAgendadas.some(v => v.codigo === c.c && !v.finalizado);
        
        // Estado progresivo: mostrar solo el más avanzado
        if(tieneInforme) {
            estadoBadges += '<span style="background:#22c55e;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">✅ INFORME</span>';
        } else if(tieneBorrador) {
            estadoBadges += '<span style="background:#f97316;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">📝 BORRADOR</span>';
        } else if(tienePreinforme) {
            estadoBadges += '<span style="background:#eab308;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">📋 EVALUADO</span>';
        } else if(tieneAgendado) {
            var visitaInfo = visitasAgendadas.find(v => v.codigo === c.c && !v.finalizado);
            estadoBadges += '<span style="background:#3b82f6;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;margin-left:4px">📅 ' + (visitaInfo ? visitaInfo.fecha : 'AGENDADO') + '</span>';
        }
        
        return `<div style="background:${c.t === 'DEMO' ? '#f5f3ff' : '#f9f9f9'};border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid ${c.t === 'EXCLUSIVO' ? '#8b5cf6' : c.t === 'DEMO' ? '#8b5cf6' : '#C9A227'};font-size:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span style="font-weight:700;color:#C9A227">${c.c}</span>
                <div style="display:flex;gap:3px">
                    ${pcBadge}${prBadge}
                    <button onclick="abrirModalEditarCentro('${c.c}')" style="background:#6b7280;color:#fff;border:none;padding:3px 6px;border-radius:4px;font-size:8px;cursor:pointer">✏️</button>
                    <button onclick="abrirModalAgendar('${c.c}')" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:8px;cursor:pointer">📅</button>
                </div>
            </div>
            <div style="font-weight:600;color:#333;margin-bottom:2px">${c.n}${aarBadge}${tipoBadge}</div>
            <div style="display:flex;flex-wrap:wrap;gap:2px;margin-bottom:2px">${estadoBadges}</div>
            <div style="color:#666;font-size:9px">${c.p}</div>
            <div style="color:#888;font-size:8px">${c.d}</div>
        </div>`;
    };
    
    listaARY.innerHTML = centrosARY.map(renderCentro).join('') || '<p style="text-align:center;color:#888;font-size:10px;padding:20px">No hay centros</p>';
    listaSGUASQUE.innerHTML = centrosSGUASQUE.map(renderCentro).join('') || '<p style="text-align:center;color:#888;font-size:10px;padding:20px">No hay centros</p>';
    
    // Renderizar agendados/finalizados - ordenados por fecha más reciente primero
    // Helper: check if a centro code already has preinforme/borrador/informe
    var _centroConPreinforme = function(codigo) {
        var centro = centrosData.find(function(c) { return c.c === codigo; });
        var nombre = centro ? centro.n : '';
        return preinformes.some(function(p) {
            return p.codigoCentro === codigo || p.centro === nombre || p.centro === codigo;
        });
    };
    var _centroConBorrador = function(codigo) {
        var centro = centrosData.find(function(c) { return c.c === codigo; });
        var nombre = centro ? centro.n : '';
        return informesBorrador.some(function(b) {
            return b.centro === nombre || b.centro === codigo || (b.preinformeData && b.preinformeData.codigoCentro === codigo);
        });
    };
    var _centroConInforme = function(codigo) {
        var centro = centrosData.find(function(c) { return c.c === codigo; });
        var nombre = centro ? centro.n : '';
        return informesFinalizados.some(function(f) {
            return f.centro === nombre || f.centro === codigo || (f.preinformeData && f.preinformeData.codigoCentro === codigo);
        });
    };
    
    // Pendientes: TODAS las visitas no finalizadas - última agendada primero
    const agendados = visitasAgendadas.filter(function(v) {
        return !v.finalizado;
    }).sort((a,b) => (b.fechaCreacion||b.id||'').localeCompare(a.fechaCreacion||a.id||''));
    
    // Finalizados: marcados como finalizado, pero sin informe finalizado (esos ya están en informes)
    const finalizados = visitasAgendadas.filter(function(v) {
        if(!v.finalizado) return false;
        if(_centroConInforme(v.codigo)) return false;
        return true;
    }).sort((a,b) => (b.fechaCreacion||b.id||'').localeCompare(a.fechaCreacion||a.id||''));
    
    var totalVisibles = agendados.length + finalizados.length;
    document.getElementById('countAgendados').textContent = totalVisibles + ' visitas';
    
    if (totalVisibles === 0) {
        listaAgendados.innerHTML = '<p style="text-align:center;color:#888;font-size:10px;padding:20px">No hay visitas agendadas</p>';
    } else {
        let html = '';
        if (agendados.length > 0) {
            html += '<div style="font-size:9px;font-weight:700;color:#6b7280;margin-bottom:6px;padding:6px;background:#f3f4f6;border-radius:4px;display:flex;align-items:center;gap:6px">⏳ PENDIENTES <span style="background:#6b7280;color:#fff;padding:2px 6px;border-radius:10px;font-size:8px">' + agendados.length + '</span></div>';
            html += agendados.map(v => {
                const centro = centrosData.find(c => c.c === v.codigo);
                const responsable = centro?.r || 'ARY';
                const respColor = responsable === 'ARY' ? '#C9A227' : '#8B7355';
                const respNombre = responsable === 'ARY' ? 'Ariannys' : 'Sonia';
                const visitaId = v.id || '';
                // Mostrar estado previo si existe
                const tieneInf = _centroConInforme(v.codigo);
                const tieneBor = _centroConBorrador(v.codigo);
                const tienePre = _centroConPreinforme(v.codigo);
                const estadoPrevio = tieneInf ? '<span style="background:#22c55e;color:#fff;padding:1px 5px;border-radius:3px;font-size:7px;margin-left:4px">✅ INFORME</span>' :
                                     tieneBor ? '<span style="background:#f97316;color:#fff;padding:1px 5px;border-radius:3px;font-size:7px;margin-left:4px">📝 BORRADOR</span>' :
                                     tienePre ? '<span style="background:#eab308;color:#fff;padding:1px 5px;border-radius:3px;font-size:7px;margin-left:4px">📋 EVALUADO</span>' : '';
                return `<div style="background:#f3f4f6;border-radius:6px;padding:10px;margin-bottom:6px;border-left:4px solid #9ca3af;font-size:10px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <span style="font-weight:700;color:#b8960c">${v.codigo}</span>
                        <div style="display:flex;gap:4px;align-items:center">
                            <span style="font-size:7px;color:#fff;background:${respColor};padding:2px 6px;border-radius:10px;font-weight:600">${respNombre}</span>
                            <span style="font-size:7px;color:#fff;background:${(v.slots||[]).length>=3?'#059669':(v.slots||[]).length>=2?'#6366f1':'#f59e0b'};padding:2px 5px;border-radius:10px;font-weight:600">${(v.slots?v.slots.map(s=>s+1).join('·'):v.turno==='tarde'?'3·4':v.turno==='tododia'?'1·2·3·4':'1')}</span>
                            <span style="font-size:8px;color:#6b7280;background:#fff;padding:2px 6px;border-radius:4px">${v.fecha}</span>
                        </div>
                    </div>
                    <div style="font-weight:600;color:#333;margin-bottom:6px">${centro?.n || v.codigo}${estadoPrevio}</div>
                    <div style="display:flex;gap:4px;flex-wrap:wrap">
                        <button onclick="comenzarEvaluacion('${v.codigo}')" style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:8px;cursor:pointer;font-weight:700;flex:1">🚀 COMENZAR EVALUACIÓN</button>
                    </div>
                    <div style="display:flex;gap:4px;margin-top:4px">
                        <button onclick="verCentro('${v.codigo}')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Ver">👁️ Ver</button>
                        <button onclick="editarVisita('${v.codigo}', '${visitaId}')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Editar">✏️ Editar</button>
                        <button onclick="cancelarVisita('${v.codigo}', '${visitaId}')" style="background:#5c5c5c;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Borrar">🗑️ Borrar</button>
                    </div>
                </div>`;
            }).join('');
        }
        if (finalizados.length > 0) {
            html += '<div style="font-size:9px;font-weight:700;color:#C9A227;margin:10px 0 6px 0;padding:6px;background:#fef9c3;border-radius:4px;display:flex;align-items:center;gap:6px">📋 EVALUADOS (pendiente informe) <span style="background:#eab308;color:#fff;padding:2px 6px;border-radius:10px;font-size:8px">' + finalizados.length + '</span></div>';
            html += finalizados.map(v => {
                const centro = centrosData.find(c => c.c === v.codigo);
                const responsable = centro?.r || 'ARY';
                const respColor = responsable === 'ARY' ? '#C9A227' : '#8B7355';
                const respNombre = responsable === 'ARY' ? 'Ariannys' : 'Sonia';
                const visitaId = v.id || '';
                const tieneBorradorV = informesBorrador.some(b => b.centro === (centro?.n||'') || b.centro === v.codigo);
                const tienePreinformeV = preinformes.some(p => p.centro === (centro?.n||'') || p.centro === v.codigo || p.codigoCentro === v.codigo);
                var estadoTxt = tieneBorradorV ? '📝 Borrador' : tienePreinformeV ? '📋 Evaluado' : '✓ Completado';
                var estadoBg = tieneBorradorV ? '#f97316' : tienePreinformeV ? '#eab308' : '#22c55e';
                return `<div style="background:#fefce8;border-radius:6px;padding:10px;margin-bottom:6px;border-left:4px solid ${estadoBg};font-size:10px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <span style="font-weight:700;color:#C9A227">${v.codigo}</span>
                        <div style="display:flex;gap:4px;align-items:center">
                            <span style="font-size:7px;color:#fff;background:${estadoBg};padding:2px 6px;border-radius:10px;font-weight:600">${estadoTxt}</span>
                            <span style="font-size:7px;color:#fff;background:${respColor};padding:2px 6px;border-radius:10px;font-weight:600">${respNombre}</span>
                            <span style="font-size:8px;color:#92400e;background:#fff;padding:2px 6px;border-radius:4px">${v.fecha}</span>
                        </div>
                    </div>
                    <div style="font-weight:600;color:#333;margin-bottom:6px">${centro?.n || v.codigo}</div>
                    <div style="display:flex;gap:4px">
                        <button onclick="verInforme('${v.codigo}')" style="background:#6b7280;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Ver">👁️ Ver</button>
                        <button onclick="borrarVisitaFinalizada('${v.codigo}', '${visitaId}')" style="background:#5c5c5c;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer" title="Borrar">🗑️ Borrar</button>
                    </div>
                </div>`;
            }).join('');
        }
        listaAgendados.innerHTML = html;
    }
    
    // Renderizar informes finalizados
    renderInformesFinalizados();
}

function renderInformesFinalizados() {
    const lista = document.getElementById('listaInformesFinalizados');
    const count = document.getElementById('countInformesFinalizados');
    if(!lista) return;
    
    const totalInformes = informesBorrador.length + informesFinalizados.length;
    
    if(totalInformes === 0) {
        lista.innerHTML = '<p style="text-align:center;color:#888;font-size:10px;padding:20px">No hay informes</p>';
        if(count) count.textContent = '0 informes';
        return;
    }
    
    if(count) count.textContent = totalInformes + ' informes';
    
    // Indicador de almacenamiento
    var storageInfo = getStorageCapacityInfo();
    var storagePct = storageInfo.pctUsed;
    var storageColor = storagePct > 85 ? '#dc2626' : storagePct > 65 ? '#f59e0b' : '#16a34a';
    
    let html = '';
    
    // Barra de almacenamiento
    html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:4px 8px;background:#f9fafb;border-radius:4px;font-size:9px;color:#666">';
    html += '<span>💾 ' + storageInfo.usedMB + '/' + storageInfo.maxMB + 'MB</span>';
    html += '<div style="flex:1;height:4px;background:#e5e7eb;border-radius:2px;overflow:hidden"><div style="width:' + Math.min(100,storagePct) + '%;height:100%;background:' + storageColor + ';border-radius:2px"></div></div>';
    html += '<span style="color:' + storageColor + '">' + storagePct + '%</span>';
    html += '<span>☁️ Firebase: ∞</span>';
    html += '</div>';
    
    // Ordenar borradores por fecha más reciente
    var borradoresOrdenados = informesBorrador.map((b, idx) => ({...b, _idx: idx}));
    borradoresOrdenados.sort((a, b) => {
        var fechaA = a.fecha || a.guardadoEn || '1900-01-01';
        var fechaB = b.fecha || b.guardadoEn || '1900-01-01';
        return fechaB.localeCompare(fechaA);
    });
    
    // Mostrar borradores primero
    if(borradoresOrdenados.length > 0) {
        html += '<div style="font-size:9px;font-weight:700;color:#6b7280;margin-bottom:6px;padding:6px;background:#f3f4f6;border-radius:4px;display:flex;align-items:center;gap:6px">📝 BORRADORES <span style="background:#6b7280;color:#fff;padding:2px 6px;border-radius:10px;font-size:8px">' + borradoresOrdenados.length + '</span></div>';
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px;margin-bottom:12px">';
        borradoresOrdenados.forEach((inf) => {
            var i = inf._idx;
            const cat = getCategoria(inf.resultado || 0);
            html += `<div style="background:#f8f8f8;border-radius:6px;padding:10px;border-left:4px solid #6b7280;font-size:10px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                    <span style="font-weight:700;color:#6b7280">📝 ${inf.resultado || 0}%</span>
                    <span style="font-size:8px;color:#666;background:#fff;padding:2px 6px;border-radius:4px">${inf.fecha || 'Sin fecha'}</span>
                </div>
                <div style="font-weight:600;color:#333;margin-bottom:2px">${inf.centro || 'Sin centro'}</div>
                <div style="color:#888;font-size:9px;margin-bottom:6px">${inf.audiologo || ''}</div>
                <div style="display:flex;gap:4px">
                    <button onclick="editarBorrador(${i})" style="background:#C9A227;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer">✏️ Editar</button>
                    <button onclick="borrarBorrador(${i})" style="background:#5c5c5c;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer">🗑️</button>
                </div>
            </div>`;
        });
        html += '</div>';
    }
    
    // Ordenar finalizados por fecha más reciente
    var finalizadosOrdenados = informesFinalizados.map((f, idx) => ({...f, _idx: idx}));
    finalizadosOrdenados.sort((a, b) => {
        var fechaA = a.fecha || a.fechaFinalizacion || '1900-01-01';
        var fechaB = b.fecha || b.fechaFinalizacion || '1900-01-01';
        return fechaB.localeCompare(fechaA);
    });
    
    // Mostrar informes finalizados (paginado para rendimiento)
    if(finalizadosOrdenados.length > 0) {
        html += '<div style="font-size:9px;font-weight:700;color:#16a34a;margin-bottom:6px;padding:6px;background:#dcfce7;border-radius:4px;display:flex;align-items:center;gap:6px">✅ FINALIZADOS <span style="background:#16a34a;color:#fff;padding:2px 6px;border-radius:10px;font-size:8px">' + finalizadosOrdenados.length + '</span></div>';
        html += '<div id="grid-finalizados" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px;margin-bottom:12px">';
        var maxVisible = window._mostrarTodosFinalizados ? finalizadosOrdenados.length : Math.min(30, finalizadosOrdenados.length);
        for(var fi = 0; fi < maxVisible; fi++) {
            var inf = finalizadosOrdenados[fi];
            var i = inf._idx;
            const cat = getCategoria(inf.resultado || 0);
            var tieneImgs = inf.imagenes ? inf.imagenes.filter(function(x){return x && x !== '[IMG_EN_FIREBASE]'}).length : 0;
            var imgBadge = tieneImgs > 0 ? ' 📷' + tieneImgs : (inf.imagenes && inf.imagenes.some(function(x){return x==='[IMG_EN_FIREBASE]'}) ? ' ☁️' : '');
            html += `<div style="background:#f0fdf4;border-radius:6px;padding:10px;border-left:4px solid #16a34a;font-size:10px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                    <span style="font-weight:700;color:${cat.color}">✅ ${inf.resultado || 0}%${imgBadge}</span>
                    <span style="font-size:8px;color:#166534;background:#fff;padding:2px 6px;border-radius:4px">${inf.fecha || 'Sin fecha'}</span>
                </div>
                <div style="font-weight:600;color:#333;margin-bottom:2px">${inf.centro || 'Sin centro'}</div>
                <div style="color:#888;font-size:9px;margin-bottom:6px">${inf.delegadoAudio || inf.audiologo || ''}</div>
                <div style="display:flex;gap:4px">
                    <button onclick="verInformeFinalizado(${i})" style="background:#16a34a;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer">👁️ Ver</button>
                    <button onclick="imprimirFinalizadoRapido(${i})" style="background:#3b82f6;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer">🖨️</button>
                    <button onclick="borrarInformeFinalizado(${i})" style="background:#5c5c5c;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:8px;cursor:pointer">🗑️</button>
                </div>
            </div>`;
        }
        html += '</div>';
        if(finalizadosOrdenados.length > 30 && !window._mostrarTodosFinalizados) {
            html += '<div style="text-align:center;padding:10px"><button onclick="window._mostrarTodosFinalizados=true;renderInformesFinalizados()" style="background:#C9A227;color:#fff;border:none;padding:8px 20px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600">📋 Mostrar los ' + finalizadosOrdenados.length + ' informes (' + (finalizadosOrdenados.length - 30) + ' más)</button></div>';
        }
    }
    
    lista.innerHTML = html;
}

function editarBorrador(i) {
    const inf = informesBorrador[i];
    if(!inf) return;
    informeActualIndex = i;
    preinformeActual = inf.preinformeData || null;
    // Limpiar anidación recursiva si existe
    if(preinformeActual && preinformeActual.preinformeData) delete preinformeActual.preinformeData;
    
    // Ir a sección informe
    document.querySelectorAll('.nav-item')[4].click();
    
    // Cargar datos
    setTimeout(() => {
        document.getElementById('inf-centro').value = inf.centro || '';
        document.getElementById('inf-propietario').value = inf.propietario || '';
        document.getElementById('inf-delegado-regional').value = inf.delegadoRegional || '';
        document.getElementById('inf-fecha').value = inf.fecha || '';
        document.getElementById('inf-pcpnc').value = inf.pcpnc || '';
        document.getElementById('inf-horas').value = inf.horasServicio || inf.horas || '';
        document.getElementById('inf-nombre-audiologo').value = inf.nombreAudiologo || inf.audiologo || '';
        
        // Cargar cifras de venta automáticamente
        if(inf.centro) cargarCifrasVentaInforme(inf.centro);
        
        // Cargar resultado y categoría
        if(inf.resultado !== undefined) {
            const cat = getCategoria(inf.resultado || 0);
            document.getElementById('inf-res-valor').textContent = (inf.resultado || 0) + '%';
            document.getElementById('inf-res-valor').style.color = cat.color;
            document.getElementById('inf-res-emoji').textContent = cat.emoji;
            document.getElementById('inf-res-cat').textContent = cat.nombre;
            document.getElementById('inf-res-msg').textContent = cat.mensaje;
        }
        
        // Cargar barras de bloques
        if(inf.bloquesPct) {
            actualizarBarra('pia', inf.bloquesPct.PIA || 0, 25);
            actualizarBarra('form', inf.bloquesPct.FORMACION || 0, 15);
            actualizarBarra('com', inf.bloquesPct.COMUNICACION || 0, 15);
            actualizarBarra('ayu', inf.bloquesPct.AYUDAS || 0, 4);
            actualizarBarra('comp', inf.bloquesPct.COMPLEMENTARIAS || 0, 6);
            actualizarBarra('rt', inf.bloquesPct.RT || 0, 25);
            actualizarBarra('conv', inf.bloquesPct.CONVERSIONES || 0, 0);
            actualizarBarra('age', inf.bloquesPct.AGENDA || 0, 10);
        }
        
        // *** CARGAR CHECKLIST GUARDADO ***
        if(inf.checklistHTML) {
            var checklistEl = document.getElementById('checklist-content');
            if(checklistEl) checklistEl.innerHTML = inf.checklistHTML;
        } else if(inf.respuestas) {
            regenerarChecklistDesdeRespuestas(inf.respuestas, inf.bloquesPct);
        }
        
        if(inf.textos) {
            document.getElementById('txt-observaciones').value = inf.textos.observaciones || '';
            document.getElementById('txt-recomendaciones').value = inf.textos.recomendaciones || '';
            document.getElementById('txt-compromisos').value = inf.textos.compromisos || '';
            document.getElementById('tiempo-compromisos').value = inf.textos.tiempoCompromisos || '1mes';
            if(inf.textos.planAccion) document.getElementById('txt-plan-accion').value = inf.textos.planAccion;
        }
        
        // Cargar 11 básicos
        if(inf.basicos && Array.isArray(inf.basicos)) {
            for(var j = 1; j <= 11; j++) {
                var cb = document.getElementById('basico-' + j);
                if(cb) cb.checked = inf.basicos[j-1] === 1;
            }
            setTimeout(actualizarPentagono, 100);
        }
        
        // Cargar imágenes
        if(inf.imagenes && Array.isArray(inf.imagenes)) {
            var tieneFirebaseImgsB = false;
            for(var k = 1; k <= 6; k++) {
                var imgSrc = inf.imagenes[k-1];
                var imgEl = document.getElementById('img-preview-' + k);
                var placeholder = document.getElementById('placeholder-' + k);
                var btnBorrar = document.getElementById('btn-borrar-' + k);
                if(imgSrc && imgSrc !== '[IMG_EN_FIREBASE]' && imgEl) {
                    imgEl.src = imgSrc;
                    imgEl.style.display = 'block';
                    if(placeholder) placeholder.style.display = 'none';
                    if(btnBorrar) btnBorrar.style.display = 'block';
                    console.log('[Borrador] Imagen ' + k + ' cargada');
                } else if(imgSrc === '[IMG_EN_FIREBASE]') {
                    tieneFirebaseImgsB = true;
                    if(imgEl) { imgEl.style.display = 'none'; imgEl.src = ''; }
                    if(placeholder) { placeholder.style.display = 'flex'; placeholder.innerHTML = '<div style="font-size:9px;color:#C9A227">⏳ Cargando desde nube...</div>'; }
                    if(btnBorrar) btnBorrar.style.display = 'none';
                } else {
                    if(imgEl) { imgEl.style.display = 'none'; imgEl.src = ''; }
                    if(placeholder) placeholder.style.display = 'flex';
                    if(btnBorrar) btnBorrar.style.display = 'none';
                }
            }
            if(tieneFirebaseImgsB) {
                restaurarImagenesDesdeFirebase(inf, 'borrador').then(function(infR) {
                    if(infR.imagenes) {
                        for(var kr = 1; kr <= 6; kr++) {
                            var imgR = infR.imagenes[kr-1];
                            var imgElR = document.getElementById('img-preview-' + kr);
                            var plR = document.getElementById('placeholder-' + kr);
                            var btnR = document.getElementById('btn-borrar-' + kr);
                            if(imgR && imgR !== '[IMG_EN_FIREBASE]' && imgElR) {
                                imgElR.src = imgR; imgElR.style.display = 'block';
                                if(plR) plR.style.display = 'none';
                                if(btnR) btnR.style.display = 'block';
                            }
                        }
                    }
                }).catch(function(e) { console.warn('Error restaurando imgs borrador:', e); });
            }
        }
        
        // Cargar conversiones
        if(inf.conversiones) {
            var convMgm = document.getElementById('conv-mgm-val');
            var convRenove = document.getElementById('conv-renove-val');
            var convSeguro = document.getElementById('conv-seguro-val');
            var convAyudas = document.getElementById('conv-ayudas-val');
            var convDeriv = document.getElementById('conv-deriv-val');
            var convPctPrueba = document.getElementById('conv-pct-prueba');
            var convPctVenta = document.getElementById('conv-pct-venta');
            var convPctScreen = document.getElementById('conv-pct-screen');
            var convImagen = document.getElementById('conv-imagen-val');
            if(convMgm) convMgm.value = inf.conversiones.mgm || '0';
            if(convRenove) convRenove.value = inf.conversiones.renove || '0';
            if(convSeguro) convSeguro.value = inf.conversiones.seguro || '0';
            if(convAyudas) convAyudas.value = inf.conversiones.ayudas || '0';
            if(convDeriv) convDeriv.textContent = inf.conversiones.derivaciones || '0';
            if(convPctPrueba) convPctPrueba.value = inf.conversiones.pctPrueba || '0';
            if(convPctVenta) convPctVenta.value = inf.conversiones.pctVenta || '0';
            if(convPctScreen) convPctScreen.value = inf.conversiones.pctScreen || '0';
            if(convImagen) convImagen.value = inf.conversiones.imagen || '0';
        }
        
        // Cargar gamas
                // Cargar funnel del centro (borrador)
        if(inf.funnel) {
            var fV = document.getElementById('inf-funnel-ventas');
            var fC = document.getElementById('inf-funnel-capacitacion');
            var fD = document.getElementById('inf-funnel-devoluciones');
            if(fV) fV.value = inf.funnel.ventas || 0;
            if(fC) fC.value = inf.funnel.capacitacion || 0;
            if(fD) fD.value = inf.funnel.devoluciones || 0;
        }
        
        // Cargar Plan Local (borrador)
        if(inf.planLocal) {
            var plLabels = document.querySelectorAll('#plan-local-selector label');
            if(plLabels && plLabels.length >= 2) {
                var sCb = plLabels[0].querySelector('input');
                var nCb = plLabels[1].querySelector('input');
                if(inf.planLocal === 'si' && sCb) { sCb.checked = true; sCb.dispatchEvent(new Event('change')); }
                else if(inf.planLocal === 'no' && nCb) { nCb.checked = true; nCb.dispatchEvent(new Event('change')); }
            }
        }
        
        if(inf.gamas) {
            var gamaDiamPlus = document.getElementById('gama-diamante-plus');
            var gamaDiam = document.getElementById('gama-diamante');
            var gamaPlatPlus = document.getElementById('gama-platino-plus');
            var gamaPlat = document.getElementById('gama-platino');
            var gamaOro = document.getElementById('gama-oro');
            if(gamaDiamPlus) gamaDiamPlus.value = inf.gamas.diamantePlus || 0;
            if(gamaDiam) gamaDiam.value = inf.gamas.diamante || 0;
            if(gamaPlatPlus) gamaPlatPlus.value = inf.gamas.platinoPlus || 0;
            if(gamaPlat) gamaPlat.value = inf.gamas.platino || 0;
            if(gamaOro) gamaOro.value = inf.gamas.oro || 0;
            calcularGamas();
        }
        
        // Cargar tipo atención
        if(inf.tipoAtencion) {
            var atenAdulto = document.getElementById('tipoaten-adulto');
            var atenTinnitus = document.getElementById('tipoaten-tinnitus');
            var atenPediatrico = document.getElementById('tipoaten-pediatrico');
            if(atenAdulto) atenAdulto.value = inf.tipoAtencion.adulto || 0;
            if(atenTinnitus) atenTinnitus.value = inf.tipoAtencion.tinnitus || 0;
            if(atenPediatrico) atenPediatrico.value = inf.tipoAtencion.pediatrico || 0;
            calcularTipoAtencion();
        }
        
        // Cargar electromedicina
        if(inf.electromedicina) {
            var elMarca = document.getElementById('electro-marca');
            var elAudio = document.getElementById('electro-audiometro');
            var elRem = document.getElementById('electro-rem');
            var elCampo = document.getElementById('electro-campolibre');
            var elTimpano = document.getElementById('electro-timpano');
            var elVideo = document.getElementById('electro-video');
            var elHit = document.getElementById('electro-hit');
            if(elMarca) elMarca.value = inf.electromedicina.marca || '';
            if(elAudio) elAudio.checked = inf.electromedicina.audiometro || false;
            if(elRem) elRem.checked = inf.electromedicina.rem || false;
            if(elCampo) elCampo.checked = inf.electromedicina.campoLibre || false;
            if(elTimpano) elTimpano.checked = inf.electromedicina.timpanometria || false;
            if(elVideo) elVideo.checked = inf.electromedicina.videotoscopia || false;
            if(elHit) elHit.checked = inf.electromedicina.hit || false;
            // Actualizar aspecto visual de las labels
            actualizarEstiloElectromedicina();
        }
        
        // Habilitar edición
        document.getElementById('txt-observaciones').disabled = false;
        document.getElementById('txt-recomendaciones').disabled = false;
        document.getElementById('txt-compromisos').disabled = false;
        
        // Cargar áreas de mejora
        if(inf.respuestas) {
            generarAreasMejora(inf.respuestas);
        } else if(inf.areasMejora && inf.areasMejora.length > 0) {
            cargarAreasMejoraGuardadas(inf.areasMejora, inf);
        }
        
        // Cargar fotosGuia guardadas
        if(inf.fotosGuia && inf.fotosGuia.length > 0) {
            fotosGuia = inf.fotosGuia.slice();
            try { renderFotosGuia(); } catch(e) { console.log('[Borrador] fotosGuia cargadas:', fotosGuia.length); }
        }
        
        // Inicializar gráficos
        setTimeout(initRadarCharts, 100);
        setTimeout(function() { 
            var pctPrueba = inf.respuestas ? (inf.respuestas[99] || 0) : 0;
            var pctVenta = inf.respuestas ? (inf.respuestas[100] || 0) : 0;
            var pctScreen = inf.respuestas ? (inf.respuestas[98] || 0) : 0;
            initDonutCharts(pctPrueba, pctVenta, pctScreen); 
        }, 150);
    }, 200);
}

function borrarBorrador(i) {
    if(!confirm('¿Eliminar este borrador?')) return;
    
    // 1. Bloquear keys para evitar que merge restaure el dato
    if(typeof SharedSync !== 'undefined' && SharedSync.lockKeyForDelete) {
        SharedSync.lockKeyForDelete('informesBorrador');
        SharedSync.lockKeyForDelete('borradoresInforme');
    }
    
    // 2. Eliminar del array en memoria
    informesBorrador.splice(i, 1);
    
    // 3. Guardar en localStorage
    var jsonData = JSON.stringify(informesBorrador);
    localStorage.setItem('informesBorrador', jsonData);
    localStorage.setItem('borradoresInforme', jsonData);
    
    // 4. Sincronizar con Firebase INMEDIATAMENTE (incluso vacío)
    sincronizarConFirebaseDirecto('informesBorrador', jsonData);
    sincronizarConFirebaseDirecto('borradoresInforme', jsonData);
    
    // 5. Actualizar vistas
    renderInformesFinalizados();
    try { cargarBorradoresInformes(); } catch(e) {}
    try { cargarInformesGestion(); } catch(e) {}
    
    // 6. Mostrar confirmación
    var msg = document.createElement('div');
    msg.innerHTML = '🗑️ Borrador eliminado';
    msg.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#6b7280;color:#fff;padding:12px 24px;border-radius:8px;font-weight:700;font-size:14px;z-index:99999;box-shadow:0 4px 15px rgba(0,0,0,0.3)';
    document.body.appendChild(msg);
    setTimeout(function() { msg.remove(); }, 2000);
}

function verInformeFinalizado(i) {
    const inf = informesFinalizados[i];
    if(!inf) return;
    informeActualIndex = -1;
    preinformeActual = inf.preinformeData || null;
    if(preinformeActual && preinformeActual.preinformeData) delete preinformeActual.preinformeData;
    
    // No limpiar porque cargamos datos existentes
    window.noLimpiarInforme = true;
    
    // Ir a sección informe
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-informe').classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('page-title').textContent = 'Informe Profesional (Solo Lectura)';
    
    // Cargar datos
    setTimeout(function() {
        // Datos de la visita
        document.getElementById('inf-centro').value = inf.centro || '';
        document.getElementById('inf-propietario').value = inf.propietario || '';
        document.getElementById('inf-delegado-regional').value = inf.delegadoRegional || '';
        document.getElementById('inf-delegado-audio').value = inf.delegadoAudio || 'Ariannys Rojas';
        document.getElementById('inf-tipo-visita').value = inf.tipoVisita || 'Seguimiento';
        document.getElementById('inf-fecha').value = inf.fecha || '';
        document.getElementById('inf-pcpnc').value = inf.pcpnc || '';
        document.getElementById('inf-horas').value = inf.horasServicio || inf.horas || '';
        document.getElementById('inf-nombre-audiologo').value = inf.nombreAudiologo || inf.audiologo || '';
        
        // Cargar cifras de venta automáticamente
        if(inf.centro) cargarCifrasVentaInforme(inf.centro);
        
        // Resultado y categoría
        const cat = getCategoria(inf.resultado || 0);
        document.getElementById('inf-res-valor').textContent = (inf.resultado || 0) + '%';
        document.getElementById('inf-res-valor').style.color = cat.color;
        document.getElementById('inf-res-emoji').textContent = cat.emoji;
        document.getElementById('inf-res-cat').textContent = cat.nombre;
        document.getElementById('inf-res-msg').textContent = cat.mensaje;
        
        // Cargar barras de bloques
        if(inf.bloquesPct) {
            actualizarBarra('pia', inf.bloquesPct.PIA || 0, 25);
            actualizarBarra('form', inf.bloquesPct.FORMACION || 0, 15);
            actualizarBarra('com', inf.bloquesPct.COMUNICACION || 0, 15);
            actualizarBarra('ayu', inf.bloquesPct.AYUDAS || 0, 4);
            actualizarBarra('comp', inf.bloquesPct.COMPLEMENTARIAS || 0, 6);
            actualizarBarra('rt', inf.bloquesPct.RT || 0, 25);
            actualizarBarra('conv', inf.bloquesPct.CONVERSIONES || 0, 0);
            actualizarBarra('age', inf.bloquesPct.AGENDA || 0, 10);
        } else if(inf.respuestas) {
            const bloquesPct = calcularBloquesPct(inf.respuestas);
            actualizarBarra('pia', bloquesPct.PIA || 0, 25);
            actualizarBarra('form', bloquesPct.FORMACION || 0, 15);
            actualizarBarra('com', bloquesPct.COMUNICACION || 0, 15);
            actualizarBarra('ayu', bloquesPct.AYUDAS || 0, 4);
            actualizarBarra('comp', bloquesPct.COMPLEMENTARIAS || 0, 6);
            actualizarBarra('rt', bloquesPct.RT || 0, 25);
            actualizarBarra('conv', bloquesPct.CONVERSIONES || 0, 0);
            actualizarBarra('age', bloquesPct.AGENDA || 0, 10);
        }
        
        // *** CARGAR CHECKLIST GUARDADO ***
        var checklistYaCargado = false;
        if(inf.checklistHTML) {
            // Si hay HTML guardado, usarlo directamente (idéntico al guardado)
            var checklistEl = document.getElementById('checklist-content');
            if(checklistEl) {
                checklistEl.innerHTML = inf.checklistHTML;
                checklistYaCargado = true;
            }
        } else if(inf.respuestas) {
            // Si no hay HTML pero sí respuestas, regenerar el checklist
            regenerarChecklistDesdeRespuestas(inf.respuestas, inf.bloquesPct);
            checklistYaCargado = true;
        }
        
        // Cargar conversiones
        if(inf.conversiones) {
            var convMgm = document.getElementById('conv-mgm-val');
            var convRenove = document.getElementById('conv-renove-val');
            var convSeguro = document.getElementById('conv-seguro-val');
            var convAyudas = document.getElementById('conv-ayudas-val');
            var convDeriv = document.getElementById('conv-deriv-val');
            var convPctPrueba = document.getElementById('conv-pct-prueba');
            var convPctVenta = document.getElementById('conv-pct-venta');
            var convPctScreen = document.getElementById('conv-pct-screen');
            var convImagen = document.getElementById('conv-imagen-val');
            if(convMgm) convMgm.value = inf.conversiones.mgm || '0';
            if(convRenove) convRenove.value = inf.conversiones.renove || '0';
            if(convSeguro) convSeguro.value = inf.conversiones.seguro || '0';
            if(convAyudas) convAyudas.value = inf.conversiones.ayudas || '0';
            if(convDeriv) convDeriv.textContent = inf.conversiones.derivaciones || '0';
            if(convPctPrueba) convPctPrueba.value = inf.conversiones.pctPrueba || '0';
            if(convPctVenta) convPctVenta.value = inf.conversiones.pctVenta || '0';
            if(convPctScreen) convPctScreen.value = inf.conversiones.pctScreen || '0';
            if(convImagen) convImagen.value = inf.conversiones.imagen || '0';
        }
        
        // Cargar 11 básicos (checkboxes)
        if(inf.basicos && Array.isArray(inf.basicos)) {
            for(var j = 1; j <= 11; j++) {
                var cb = document.getElementById('basico-' + j);
                if(cb) cb.checked = inf.basicos[j-1] === 1;
            }
            setTimeout(actualizarPentagono, 100);
        }
        
        // Cargar textos
        if(inf.textos) {
            document.getElementById('txt-observaciones').value = inf.textos.observaciones || '';
            document.getElementById('txt-recomendaciones').value = inf.textos.recomendaciones || '';
            document.getElementById('txt-compromisos').value = inf.textos.compromisos || '';
            document.getElementById('tiempo-compromisos').value = inf.textos.tiempoCompromisos || '1mes';
            var txtResumen = document.getElementById('txt-resumen');
            if(txtResumen) txtResumen.value = inf.textos.resumen || '';
            var txtPlan = document.getElementById('txt-plan-accion');
            if(txtPlan) txtPlan.value = inf.textos.planAccion || '';
        }
        
        // Cargar funnel del centro
        if(inf.funnel) {
            var fVentas = document.getElementById('inf-funnel-ventas');
            var fCapac = document.getElementById('inf-funnel-capacitacion');
            var fDevol = document.getElementById('inf-funnel-devoluciones');
            if(fVentas) fVentas.value = inf.funnel.ventas || 0;
            if(fCapac) fCapac.value = inf.funnel.capacitacion || 0;
            if(fDevol) fDevol.value = inf.funnel.devoluciones || 0;
        }
        
        // Cargar Plan Local
        if(inf.planLocal) {
            var planLabels = document.querySelectorAll('#plan-local-selector label');
            if(planLabels && planLabels.length >= 2) {
                var siCb = planLabels[0].querySelector('input');
                var noCb = planLabels[1].querySelector('input');
                if(inf.planLocal === 'si' && siCb) { siCb.checked = true; siCb.dispatchEvent(new Event('change')); }
                else if(inf.planLocal === 'no' && noCb) { noCb.checked = true; noCb.dispatchEvent(new Event('change')); }
            }
        }
        
        // Cargar gamas vendidas
        if(inf.gamas) {
            var gamaDiamPlus = document.getElementById('gama-diamante-plus');
            var gamaDiam = document.getElementById('gama-diamante');
            var gamaPlatPlus = document.getElementById('gama-platino-plus');
            var gamaPlat = document.getElementById('gama-platino');
            var gamaOro = document.getElementById('gama-oro');
            if(gamaDiamPlus) gamaDiamPlus.value = inf.gamas.diamantePlus || 0;
            if(gamaDiam) gamaDiam.value = inf.gamas.diamante || 0;
            if(gamaPlatPlus) gamaPlatPlus.value = inf.gamas.platinoPlus || 0;
            if(gamaPlat) gamaPlat.value = inf.gamas.platino || 0;
            if(gamaOro) gamaOro.value = inf.gamas.oro || 0;
        }
        
        // Cargar tipo de atención
        if(inf.tipoAtencion) {
            var atenAdulto = document.getElementById('tipoaten-adulto');
            var atenTinnitus = document.getElementById('tipoaten-tinnitus');
            var atenPediatrico = document.getElementById('tipoaten-pediatrico');
            if(atenAdulto) atenAdulto.value = inf.tipoAtencion.adulto || 0;
            if(atenTinnitus) atenTinnitus.value = inf.tipoAtencion.tinnitus || 0;
            if(atenPediatrico) atenPediatrico.value = inf.tipoAtencion.pediatrico || 0;
        }
        
        // Cargar electromedicina
        if(inf.electromedicina) {
            var elMarca = document.getElementById('electro-marca');
            var elAudio = document.getElementById('electro-audiometro');
            var elRem = document.getElementById('electro-rem');
            var elCampo = document.getElementById('electro-campolibre');
            var elTimpano = document.getElementById('electro-timpano');
            var elVideo = document.getElementById('electro-video');
            var elHit = document.getElementById('electro-hit');
            if(elMarca) elMarca.value = inf.electromedicina.marca || '';
            if(elAudio) elAudio.checked = inf.electromedicina.audiometro || false;
            if(elRem) elRem.checked = inf.electromedicina.rem || false;
            if(elCampo) elCampo.checked = inf.electromedicina.campoLibre || false;
            if(elTimpano) elTimpano.checked = inf.electromedicina.timpanometria || false;
            if(elVideo) elVideo.checked = inf.electromedicina.videotoscopia || false;
            if(elHit) elHit.checked = inf.electromedicina.hit || false;
            actualizarEstiloElectromedicina();
        }
        
        // Cargar pentágono global
        if(inf.pentagonoGlobal) {
            var pentGlobal = document.getElementById('pent-global');
            if(pentGlobal) pentGlobal.textContent = inf.pentagonoGlobal;
        }
        
        // Cargar checklist completo si hay respuestas Y NO se cargó antes
        if(!checklistYaCargado && (inf.respuestas || (inf.preinformeData && inf.preinformeData.respuestas))) {
            var respForChecklist = inf.respuestas || inf.preinformeData.respuestas;
            var checklistContent = document.getElementById('checklist-content');
            if(checklistContent) {
                try {
                    var resCalc = {porBloque: {}};
                    if(inf.bloquesPct) {
                        bloques.forEach(function(b) {
                            resCalc.porBloque[b.id] = {
                                nombre: b.largo,
                                peso: b.peso,
                                gradient: b.gradient,
                                porcentaje: inf.bloquesPct[b.id] || 0
                            };
                        });
                    } else {
                        var bp = calcularBloquesPct(respForChecklist);
                        bloques.forEach(function(b) {
                            resCalc.porBloque[b.id] = {
                                nombre: b.largo,
                                peso: b.peso,
                                gradient: b.gradient,
                                porcentaje: bp[b.id] || 0
                            };
                        });
                    }
                    // Generar checklist HTML
                    var ckHtml = '';
                    bloques.forEach(function(b) {
                        var pB = preguntas.filter(function(p) { return p.bloque === b.id; });
                        var r = resCalc.porBloque[b.id];
                        ckHtml += '<div class="checklist-bloque"><div class="checklist-header" style="background:' + b.gradient + ';">' + b.largo + ' (' + b.peso + '%)<span>' + (r.porcentaje || 0) + '%</span></div>';
                        pB.forEach(function(p) {
                            var resp = respForChecklist[p.id];
                            var ob = obligatorias.includes(p.id);
                            var badgeClass, badgeText;
                            if(p.tipo === 'agenda_dual') {
                                var pvVal = respForChecklist['90_pv'] || 0, revVal = respForChecklist['90_rev'] || resp || 0;
                                badgeClass = 'num'; badgeText = pvVal + '/' + revVal;
                            } else if(p.tipo === 'binario') {
                                var si = resp === 'si';
                                badgeClass = si ? 'si' : 'no'; badgeText = si ? '✓' : '✗';
                            } else if(p.tipo === 'agenda_confirm') {
                                var cumple = resp >= 75;
                                badgeClass = cumple ? 'si' : 'no'; 
                                badgeText = cumple ? (resp + '% ✓') : (resp + '% ✗');
                            } else {
                                badgeClass = 'num'; badgeText = resp || 0;
                            }
                            ckHtml += '<div class="checklist-item"><span class="check-badge ' + badgeClass + '">' + badgeText + '</span><span style="flex:1;line-height:1.3">' + p.id + '. ' + p.criterio + '</span>' + (ob ? '<span class="check-ob">OBLIGATORIA</span>' : '') + '</div>';
                        });
                        ckHtml += '</div>';
                    });
                    checklistContent.innerHTML = ckHtml;
                } catch(e) { console.error('Error cargando checklist:', e); }
            }
        }
        
        // Cargar imágenes de galería
        if(inf.imagenes && Array.isArray(inf.imagenes)) {
            var tieneFirebaseImgs = false;
            for(var k = 1; k <= 6; k++) {
                var imgSrc = inf.imagenes[k-1];
                var imgEl = document.getElementById('img-preview-' + k);
                var placeholder = document.getElementById('placeholder-' + k);
                var btnBorrar = document.getElementById('btn-borrar-' + k);
                if(imgSrc && imgSrc !== '[IMG_EN_FIREBASE]' && imgEl) {
                    imgEl.src = imgSrc;
                    imgEl.style.display = 'block';
                    if(placeholder) placeholder.style.display = 'none';
                    // X button se controla después según estado (finalizado=oculto)
                } else if(imgSrc === '[IMG_EN_FIREBASE]') {
                    tieneFirebaseImgs = true;
                    if(imgEl) { imgEl.style.display = 'none'; imgEl.src = ''; }
                    if(placeholder) { placeholder.style.display = 'flex'; placeholder.innerHTML = '<div style="font-size:9px;color:#C9A227">⏳ Cargando desde nube...</div>'; }
                    if(btnBorrar) btnBorrar.style.display = 'none';
                } else {
                    if(imgEl) { imgEl.style.display = 'none'; imgEl.src = ''; }
                    if(placeholder) placeholder.style.display = 'flex';
                    if(btnBorrar) btnBorrar.style.display = 'none';
                }
            }
            // Auto-restaurar imágenes desde Firebase
            if(tieneFirebaseImgs) {
                restaurarImagenesDesdeFirebase(inf, 'finalizado').then(function(infRestaurado) {
                    if(infRestaurado.imagenes) {
                        for(var kr = 1; kr <= 6; kr++) {
                            var imgR = infRestaurado.imagenes[kr-1];
                            var imgElR = document.getElementById('img-preview-' + kr);
                            var placeholderR = document.getElementById('placeholder-' + kr);
                            var btnBorrarR = document.getElementById('btn-borrar-' + kr);
                            if(imgR && imgR !== '[IMG_EN_FIREBASE]' && imgElR) {
                                imgElR.src = imgR;
                                imgElR.style.display = 'block';
                                if(placeholderR) placeholderR.style.display = 'none';
                                // NO mostrar X en modo finalizado (solo lectura)
                            }
                        }
                    }
                }).catch(function(e) { console.warn('Error restaurando imgs:', e); });
            }
        }
        
        // Cargar áreas de mejora en tabla - usar generarAreasMejora si hay respuestas (muestra cada pregunta NO con detalle completo)
        if(inf.respuestas) {
            generarAreasMejora(inf.respuestas);
        } else if((inf.areasMejora && inf.areasMejora.length > 0) || inf.todasPreguntasNO) {
            cargarAreasMejoraGuardadas(inf.areasMejora, inf);
        }
        
        // Cargar fotosGuia guardadas
        if(inf.fotosGuia && inf.fotosGuia.length > 0) {
            fotosGuia = inf.fotosGuia.slice();
            try { renderFotosGuia(); } catch(e) { console.log('[Finalizado] fotosGuia:', fotosGuia.length); }
        } else {
            fotosGuia = [];
            try { renderFotosGuia(); } catch(e) {}
        }
        
        // Inicializar radares
        setTimeout(initRadarCharts, 100);
        setTimeout(function() { 
            var pctPrueba = inf.respuestas ? (inf.respuestas[99] || 0) : 0;
            var pctVenta = inf.respuestas ? (inf.respuestas[100] || 0) : 0;
            var pctScreen = inf.respuestas ? (inf.respuestas[98] || 0) : 0;
            initDonutCharts(pctPrueba, pctVenta, pctScreen); 
        }, 150);
        
        // BLOQUEAR TODO - Solo lectura
        const seccionInforme = document.getElementById('section-informe');
        seccionInforme.querySelectorAll('input, textarea, select').forEach(function(el) {
            if(el.dataset.alwaysEditable === 'true') return; // Nombre audiólogo siempre editable
            el.disabled = true;
            el.style.opacity = '0.7';
            el.spellcheck = false;
        });
        
        // Ocultar botones de edición
        seccionInforme.querySelectorAll('button').forEach(function(btn) {
            var texto = btn.textContent.toLowerCase();
            if(texto.indexOf('guardar') >= 0 || texto.indexOf('finalizar') >= 0 || 
               texto.indexOf('adjuntar') >= 0 || texto.indexOf('borrador') >= 0 || 
               texto.indexOf('añadir') >= 0 || texto.indexOf('subir') >= 0) {
                btn.style.display = 'none';
            }
        });
        
        // Ocultar zona adjuntar
        var zonaAdj = document.getElementById('zona-adjuntar');
        if(zonaAdj) zonaAdj.style.display = 'none';
        
        // OCULTAR botones X rojos de eliminar imagen en modo finalizado
        for(var bx = 1; bx <= 6; bx++) {
            var btnX = document.getElementById('btn-borrar-' + bx);
            if(btnX) btnX.style.display = 'none';
        }
        
        // Añadir banner SOLO LECTURA con botón volver
        var existingBanner = document.getElementById('readonly-banner');
        if(existingBanner) existingBanner.remove();
        
        var banner = document.createElement('div');
        banner.id = 'readonly-banner';
        banner.style.cssText = 'position:fixed;top:8px;right:12px;z-index:9999;background:rgba(201,162,39,0.92);color:#fff;padding:6px 14px;border-radius:8px;display:flex;align-items:center;gap:10px;box-shadow:0 2px 10px rgba(201,162,39,0.3);font-size:10px;font-weight:600;backdrop-filter:blur(4px)';
        banner.innerHTML = '<span>🔒 Solo lectura</span><button onclick="volverGestionInformes()" style="background:rgba(255,255,255,0.9);color:#8B7355;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;font-weight:600;font-size:9px">← Volver</button><button onclick="window.print()" style="background:rgba(255,255,255,0.25);color:#fff;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;font-weight:600;font-size:9px">🖨️ Imprimir</button>';
        document.body.appendChild(banner);
    }, 200);
}

// Volver a gestión de informes
function volverGestionInformes() {
    // Quitar banner
    var banner = document.getElementById('readonly-banner');
    if(banner) banner.remove();
    
    // Restaurar campos
    var seccionInforme = document.getElementById('section-informe');
    if(seccionInforme) {
        seccionInforme.querySelectorAll('input, textarea, select').forEach(function(el) {
            el.disabled = false;
            el.style.opacity = '1';
            if(el.tagName === 'TEXTAREA') { el.spellcheck = false; }
        });
        seccionInforme.querySelectorAll('button').forEach(function(btn) {
            btn.style.display = '';
        });
        var zonaAdj = document.getElementById('zona-adjuntar');
        if(zonaAdj) zonaAdj.style.display = '';
    }
    
    // Ir a gestión de informes
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-informes-gestion').classList.add('active');
    document.getElementById('page-title').textContent = 'Gestión de Informes';
    cargarInformesGestion();
}

function pdfInformeFinalizado(i) {
    verInformeFinalizado(i);
    setTimeout(() => descargarInformePDF(), 500);
}

function imprimirInformeFinalizado(i) {
    verInformeFinalizado(i);
    setTimeout(() => window.print(), 500);
}

function toggleInformesFinalizados() {
    const lista = document.getElementById('listaInformesFinalizados');
    const btn = document.getElementById('btnToggleInformes');
    if(!lista || !btn) return;
    
    if(lista.style.maxHeight === '0px') {
        lista.style.maxHeight = '300px';
        lista.style.padding = '8px';
        btn.textContent = '▲ Ocultar';
    } else {
        lista.style.maxHeight = '0px';
        lista.style.padding = '0 8px';
        btn.textContent = '▼ Mostrar';
    }
}

function borrarInformeFinalizado(i) {
    if(!confirm('¿Eliminar este informe finalizado?')) return;
    
    // 1. Bloquear key para evitar que merge restaure el dato (10 segundos)
    if(typeof SharedSync !== 'undefined' && SharedSync.lockKeyForDelete) {
        SharedSync.lockKeyForDelete('informesFinalizados');
    }
    
    // 2. Eliminar del array en memoria
    informesFinalizados.splice(i, 1);
    
    // 3. Guardar en localStorage INMEDIATAMENTE
    var jsonData = JSON.stringify(informesFinalizados);
    localStorage.setItem('informesFinalizados', jsonData);
    
    // 4. Sincronizar con Firebase INMEDIATAMENTE (incluso si está vacío)
    sincronizarConFirebaseDirecto('informesFinalizados', jsonData);
    
    // 5. Actualizar TODAS las vistas
    renderInformesFinalizados();
    updateDashboard();
    actualizarPentagonoDashboard();
    actualizarDashboardMedia();
    try { cargarInformesFinalizados(); } catch(e) {}
    try { cargarInformesGestion(); } catch(e) {}
    
    // 6. Mostrar confirmación
    var msg = document.createElement('div');
    msg.innerHTML = '🗑️ Informe eliminado correctamente';
    msg.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#dc2626;color:#fff;padding:12px 24px;border-radius:8px;font-weight:700;font-size:14px;z-index:99999;box-shadow:0 4px 15px rgba(0,0,0,0.3)';
    document.body.appendChild(msg);
    setTimeout(function() { msg.remove(); }, 2000);
}

function filtrarCentrosVisitas() { renderCentrosVisitas(); }

// Funciones de edición de centro
function abrirModalEditarCentro(codigo) {
    centroEditar = centrosData.find(c => c.c === codigo);
    if (!centroEditar) return;
    document.getElementById('editCentroCodigo').value = centroEditar.c;
    document.getElementById('editCentroNombre').value = centroEditar.n;
    document.getElementById('editCentroAAR').value = centroEditar.a || 'NO';
    document.getElementById('editCentroTipo').value = centroEditar.t || 'CORNER';
    document.getElementById('modalEditarCentro').style.display = 'flex';
}

function cerrarModalEditarCentro() {
    document.getElementById('modalEditarCentro').style.display = 'none';
    centroEditar = null;
}

function guardarEditarCentro() {
    if (!centroEditar) return;
    const idx = centrosData.findIndex(c => c.c === centroEditar.c);
    if (idx >= 0) {
        centrosData[idx].n = document.getElementById('editCentroNombre').value;
        centrosData[idx].a = document.getElementById('editCentroAAR').value;
        centrosData[idx].t = document.getElementById('editCentroTipo').value;
        // Guardar en localStorage
        localStorage.setItem('centrosModificados', JSON.stringify(centrosData.filter(c => c.modificado)));
        centrosData[idx].modificado = true;
    }
    cerrarModalEditarCentro();
    renderCentrosVisitas();
}

// Funciones de nuevo centro
function abrirModalNuevoCentro(responsable) {
    document.getElementById('nuevoCentroResponsable').value = responsable;
    document.getElementById('nuevoCentroCodigo').value = '';
    document.getElementById('nuevoCentroNombre').value = '';
    document.getElementById('nuevoCentroPropietario').value = '';
    document.getElementById('nuevoCentroDelegado').value = '';
    document.getElementById('nuevoCentroAAR').value = 'NO';
    document.getElementById('nuevoCentroTipo').value = 'CORNER';
    document.getElementById('modalNuevoCentro').style.display = 'flex';
}

function cerrarModalNuevoCentro() {
    document.getElementById('modalNuevoCentro').style.display = 'none';
}

function guardarNuevoCentro() {
    const codigo = document.getElementById('nuevoCentroCodigo').value.toUpperCase().trim();
    const nombre = document.getElementById('nuevoCentroNombre').value.trim();
    const propietario = document.getElementById('nuevoCentroPropietario').value.trim();
    const delegado = document.getElementById('nuevoCentroDelegado').value.trim();
    const aar = document.getElementById('nuevoCentroAAR').value;
    const tipo = document.getElementById('nuevoCentroTipo').value;
    const responsable = document.getElementById('nuevoCentroResponsable').value;
    
    if (!codigo || !nombre) {
        alert('Código y nombre son obligatorios');
        return;
    }
    if (centrosData.find(c => c.c === codigo)) {
        alert('Ya existe un centro con ese código');
        return;
    }
    
    centrosData.push({
        c: codigo,
        n: nombre,
        p: propietario || 'N/A',
        d: delegado || 'N/A',
        r: responsable,
        a: aar,
        t: tipo,
        nuevo: true
    });
    
    cerrarModalNuevoCentro();
    renderCentrosVisitas();
}

// Funciones de visitas
// Variable para guardar el centro de la evaluación actual
let centroEvaluacionActual = null;
let saltarLimpiezaEvaluacion = false;

function comenzarEvaluacion(codigo) {
    const centro = centrosData.find(c => c.c === codigo);
    const visita = visitasAgendadas.find(v => v.codigo === codigo && !v.finalizado);
    if (centro) {
        centroEvaluacionActual = {
            codigo: centro.c,
            nombre: centro.n,
            propietario: centro.p,
            delegado: centro.d,
            aar: centro.a,
            tipo: centro.t,
            fechaAgendada: visita ? visita.fecha : null
        };
        
        // Navegar a section-guia-eval directamente (sin showSection que dispara resetEval)
        saltarLimpiezaEvaluacion = true;
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('section-guia-eval').classList.add('active');
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        var navBtn = document.querySelector('.nav-item[onclick*="guia-eval"]');
        if(navBtn) navBtn.classList.add('active');
        document.getElementById('page-title').textContent = 'Evaluación + Guía';
        
        // Activar pestaña evaluación
        cambiarTabGuiaEval('eval');
        
        // Datos a rellenar
        var fechaVisita = visita && visita.fecha ? new Date(visita.fecha) : new Date();
        var pcpnc = centro.pc || '';
        var pcColor = pcpnc === 'PC' ? '#10b981' : (pcpnc === 'PNC' ? '#ef4444' : '#888');
        var responsable = centro.r === 'SGUASQUE' ? 'Sonia Guasque' : 'Ariannys Rojas';
        
        // Rellenar formulario guia-eval (IDs con -2)
        var ec2 = document.getElementById('eval-centro-2');
        if(ec2) ec2.value = centro.n;
        var ef2 = document.getElementById('eval-fecha-2');
        if(ef2) ef2.valueAsDate = fechaVisita;
        var epc2 = document.getElementById('eval-pcpnc-2');
        if(epc2) { epc2.value = pcpnc; epc2.style.color = pcColor; }
        var er2 = document.getElementById('eval-responsable-2');
        if(er2) { for(var i=0;i<er2.options.length;i++){if(er2.options[i].text===responsable){er2.selectedIndex=i;break;}} }
        
        // Rellenar también formulario standalone (IDs sin -2) por si pasa por ahí
        var ec = document.getElementById('eval-centro');
        if(ec) ec.value = centro.n;
        var ef = document.getElementById('eval-fecha');
        if(ef) ef.valueAsDate = fechaVisita;
        var epc = document.getElementById('eval-pcpnc');
        if(epc) { epc.value = pcpnc; epc.style.color = pcColor; }
        var er = document.getElementById('eval-responsable');
        if(er) { for(var j=0;j<er.options.length;j++){if(er.options[j].text===responsable){er.selectedIndex=j;break;}} }
        
        // Guardar código para centroSeleccionadoCodigo
        centroSeleccionadoCodigo = centro.c;
        
        saltarLimpiezaEvaluacion = false;
        renderPreinformes();
    }
}

function comenzarInforme(codigo) {
    comenzarEvaluacion(codigo);
}

function comenzarVisita(codigo) {
    comenzarEvaluacion(codigo);
}

function verCentro(codigo) {
    const centro = centrosData.find(c => c.c === codigo);
    if (centro) {
        alert(`📍 ${centro.c} - ${centro.n}\n\n👤 Propietario: ${centro.p}\n📋 Delegado: ${centro.d}\n🏪 Tipo: ${centro.t || 'CORNER'}\n✅ AAR: ${centro.a || 'NO'}`);
    }
}

function verInforme(codigo) {
    const informe = preinformes.find(p => p.centro && p.centro.includes(codigo));
    if (informe) {
        showSection('informe', document.querySelector('[data-section="informe"]'));
    } else {
        alert('No hay informe guardado para este centro');
    }
}

function editarInforme(codigo) {
    const centro = centrosData.find(c => c.c === codigo);
    if (centro) {
        document.getElementById('eval-centro').value = centro.n;
        showSection('evaluacion', document.querySelector('[data-section="evaluacion"]'));
    }
}

function borrarVisitaFinalizada(codigo, visitaId) {
    if (confirm('¿Eliminar esta visita finalizada?')) {
        // 1. Bloquear key
        if(typeof SharedSync !== 'undefined' && SharedSync.lockKeyForDelete) {
            SharedSync.lockKeyForDelete('visitasAgendadas');
        }
        
        // 2. Eliminar del array
        if (visitaId) {
            visitasAgendadas = visitasAgendadas.filter(v => v.id !== visitaId);
        } else {
            // Compatibilidad con visitas antiguas sin ID - eliminar la primera encontrada
            let eliminado = false;
            visitasAgendadas = visitasAgendadas.filter(v => {
                if (!eliminado && v.codigo === codigo && v.finalizado) {
                    eliminado = true;
                    return false;
                }
                return true;
            });
        }
        
        // 3. Guardar y sincronizar
        var jsonData = JSON.stringify(visitasAgendadas);
        localStorage.setItem('visitasAgendadas', jsonData);
        sincronizarConFirebaseDirecto('visitasAgendadas', jsonData);
        
        // 4. Actualizar vistas
        renderCentrosVisitas();
    }
}

function editarVisita(codigo, visitaId) {
    let visita;
    if (visitaId) {
        visita = visitasAgendadas.find(v => v.id === visitaId && !v.finalizado);
    } else {
        visita = visitasAgendadas.find(v => v.codigo === codigo && !v.finalizado);
    }
    if (!visita) return;
    centroAgendar = centrosData.find(c => c.c === codigo);
    if (!centroAgendar) return;
    document.getElementById('agendarCentroInfo').innerHTML = `<strong style="color:#C9A227">${centroAgendar.c}</strong> - ${centroAgendar.n}<br><span style="color:#666">${centroAgendar.p} · ${centroAgendar.d}</span>`;
    document.getElementById('agendarFecha').value = visita.fecha;
    // Restore quadrant selection
    var slots = visita.slots || turnoToSlots(visita.turno);
    for(var qi=1;qi<=4;qi++){var qe=document.getElementById('turnoQ'+qi);if(qe)qe.classList.toggle('active',slots.indexOf(qi-1)>=0)}
    // Eliminar la visita actual para re-agendar
    if (visitaId) {
        visitasAgendadas = visitasAgendadas.filter(v => v.id !== visitaId);
    } else {
        // Compatibilidad: eliminar la primera visita no finalizada del centro
        let eliminado = false;
        visitasAgendadas = visitasAgendadas.filter(v => {
            if (!eliminado && v.codigo === codigo && !v.finalizado) {
                eliminado = true;
                return false;
            }
            return true;
        });
    }
    localStorage.setItem('visitasAgendadas', JSON.stringify(visitasAgendadas));
    document.getElementById('modalAgendar').style.display = 'flex';
    if(typeof mostrarDisponibilidadAgendar === 'function') mostrarDisponibilidadAgendar();
}

function abrirModalAgendar(codigo) {
    centroAgendar = centrosData.find(c => c.c === codigo);
    if (!centroAgendar) return;
    document.getElementById('agendarCentroInfo').innerHTML = `<strong style="color:#C9A227">${centroAgendar.c}</strong> - ${centroAgendar.n}<br><span style="color:#666">${centroAgendar.p} · ${centroAgendar.d}</span>`;
    document.getElementById('agendarFecha').valueAsDate = new Date();
    // Reset quadrants - default Q1 active
    for(var qi=1;qi<=4;qi++){var qe=document.getElementById('turnoQ'+qi);if(qe)qe.classList.toggle('active',qi===1)}
    document.getElementById('modalAgendar').style.display = 'flex';
    if(typeof mostrarDisponibilidadAgendar === 'function') mostrarDisponibilidadAgendar();
}

function cerrarModalAgendar() {
    document.getElementById('modalAgendar').style.display = 'none';
    centroAgendar = null;
}

function confirmarAgendar() {
    if (!centroAgendar) return;
    const fecha = document.getElementById('agendarFecha').value;
    if (!fecha) { alert('Selecciona una fecha'); return; }
    
    // Get selected quadrants
    const slots = (typeof getSelectedSlots === 'function') ? getSelectedSlots() : [0];
    if(slots.length === 0){ alert('Selecciona al menos un cuadrante'); return; }
    
    // Generar ID único para la visita
    const visitaId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    visitasAgendadas.push({ 
        id: visitaId,
        codigo: centroAgendar.c, 
        fecha: fecha, 
        slots: slots,
        finalizado: false,
        fechaCreacion: new Date().toISOString()
    });
    localStorage.setItem('visitasAgendadas', JSON.stringify(visitasAgendadas));
    sincronizarConFirebaseDirecto('visitasAgendadas', JSON.stringify(visitasAgendadas));
    
    // Auto-escribir en calendario del delegado
    const who = centroAgendar.r;
    const shortName = centroAgendar.c + ' ' + centroAgendar.n.substring(0,18);
    slots.forEach(function(si){
        localStorage.setItem('calV2_'+who+'_'+fecha+'_'+si, JSON.stringify({type:'ocupado', text: shortName}));
    });
    
    cerrarModalAgendar();
    renderCentrosVisitas();
    if(typeof actualizarCalendariosDesdeAgenda === 'function') actualizarCalendariosDesdeAgenda();
}

function finalizarVisita(codigo, visitaId) {
    // Buscar por ID si existe, o por código si no hay ID (compatibilidad con visitas antiguas)
    let idx = -1;
    if (visitaId) {
        idx = visitasAgendadas.findIndex(v => v.id === visitaId && !v.finalizado);
    }
    if (idx < 0) {
        idx = visitasAgendadas.findIndex(v => v.codigo === codigo && !v.finalizado);
    }
    if (idx >= 0) {
        visitasAgendadas[idx].finalizado = true;
        visitasAgendadas[idx].fechaFinalizacion = new Date().toISOString();
        localStorage.setItem('visitasAgendadas', JSON.stringify(visitasAgendadas));
        renderCentrosVisitas();
    }
}

function cancelarVisita(codigo, visitaId) {
    if (!confirm('¿Cancelar esta visita?')) return;
    
    // 1. Bloquear key para evitar que merge restaure el dato
    if(typeof SharedSync !== 'undefined' && SharedSync.lockKeyForDelete) {
        SharedSync.lockKeyForDelete('visitasAgendadas');
    }
    
    // 2. Eliminar del array
    if (visitaId) {
        visitasAgendadas = visitasAgendadas.filter(v => v.id !== visitaId);
    } else {
        // Compatibilidad con visitas antiguas sin ID
        visitasAgendadas = visitasAgendadas.filter(v => !(v.codigo === codigo && !v.finalizado));
    }
    
    // 3. Guardar en localStorage
    var jsonData = JSON.stringify(visitasAgendadas);
    localStorage.setItem('visitasAgendadas', jsonData);
    
    // 4. Sincronizar con Firebase
    sincronizarConFirebaseDirecto('visitasAgendadas', jsonData);
    
    // 5. Actualizar vistas
    renderCentrosVisitas();
    if(typeof actualizarCalendariosDesdeAgenda === 'function') actualizarCalendariosDesdeAgenda();
}

// Inicializar visitas
setTimeout(renderCentrosVisitas, 100);

// ═══════════════════════════════════════════════════════════════
// VISITAS PUNTUALES
// ═══════════════════════════════════════════════════════════════
function abrirModalPuntual(codigo) {
    const centro = centrosData.find(c => c.c === codigo);
    if(!centro) return;
    var old = document.getElementById('modalPuntual');
    if(old) old.remove();
    var modal = document.createElement('div');
    modal.id = 'modalPuntual';
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;display:flex;align-items:center;justify-content:center';
    var today = new Date().toISOString().split('T')[0];
    modal.innerHTML = '<div style="background:#fff;border-radius:12px;padding:20px;width:340px;max-width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.3)">' +
        '<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px"><span style="font-size:20px">⚡</span><div><div style="font-size:13px;font-weight:700;color:#C9A227">VISITA PUNTUAL</div><div style="font-size:10px;color:#666">' + codigo + ' - ' + centro.n + '</div></div></div>' +
        '<div style="margin-bottom:10px"><label style="font-size:10px;font-weight:600;color:#555;display:block;margin-bottom:3px">Fecha</label><input type="date" id="puntualFecha" value="' + today + '" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:12px;box-sizing:border-box"></div>' +
        '<div style="margin-bottom:10px"><label style="font-size:10px;font-weight:600;color:#555;display:block;margin-bottom:3px">Motivo / Nota (opcional)</label><input type="text" id="puntualNota" placeholder="Ej: Revisión stock, Entrega material..." style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:11px;box-sizing:border-box"></div>' +
        '<div style="display:flex;gap:8px"><button onclick="confirmarPuntual(\'' + codigo + '\')" style="flex:1;padding:10px;background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border:none;border-radius:6px;font-weight:700;font-size:11px;cursor:pointer">✓ Registrar</button><button onclick="document.getElementById(\'modalPuntual\').remove()" style="padding:10px 16px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-weight:600;font-size:11px;cursor:pointer">Cancelar</button></div>' +
        '</div>';
    document.body.appendChild(modal);
    modal.addEventListener('click', function(e) { if(e.target === modal) modal.remove(); });
}

function confirmarPuntual(codigo) {
    var fecha = document.getElementById('puntualFecha').value;
    if(!fecha) { alert('Selecciona una fecha'); return; }
    var nota = document.getElementById('puntualNota').value.trim();
    var centro = centrosData.find(c => c.c === codigo);
    var responsable = centro ? centro.r : 'ARY';
    
    visitasPuntuales.push({
        id: Date.now() + '_p_' + Math.random().toString(36).substr(2,6),
        codigo: codigo,
        fecha: fecha,
        responsable: responsable,
        nota: nota,
        fechaCreacion: new Date().toISOString()
    });
    localStorage.setItem('visitasPuntuales', JSON.stringify(visitasPuntuales));
    sincronizarConFirebaseDirecto('visitasPuntuales', JSON.stringify(visitasPuntuales));
    
    // Auto-escribir en calendario del delegado
    var shortName = '⚡' + codigo + ' ' + (centro ? centro.n.substring(0,15) : '');
    localStorage.setItem('calV2_' + responsable + '_' + fecha + '_0', JSON.stringify({type:'ocupado', text: shortName}));
    
    document.getElementById('modalPuntual').remove();
    renderCentrosVisitas();
    actualizarDashboardMedia();
    if(typeof updateDashboard === 'function') updateDashboard();
    alert('✅ Visita puntual registrada para ' + codigo + ' el ' + fecha);
}

function eliminarVisitaPuntual(id) {
    if(!confirm('¿Eliminar esta visita puntual?')) return;
    if(typeof SharedSync !== 'undefined' && SharedSync.lockKeyForDelete) SharedSync.lockKeyForDelete('visitasPuntuales');
    visitasPuntuales = visitasPuntuales.filter(v => v.id !== id);
    localStorage.setItem('visitasPuntuales', JSON.stringify(visitasPuntuales));
    sincronizarConFirebaseDirecto('visitasPuntuales', JSON.stringify(visitasPuntuales));
    renderCentrosVisitas();
    actualizarDashboardMedia();
    if(typeof updateDashboard === 'function') updateDashboard();
}

let preinformes = JSON.parse(localStorage.getItem('preinformes') || '[]');
let preguntaActual = 0, respuestas = {}, datosPortada = {}, huboObligatoriaNo = false;

// Función centralizada para guardar preinformes con manejo robusto de quota + Firebase
function guardarPreinformesEnStorage() {
    // Limitar preinformes antiguos
    if(preinformes.length > 20) {
        preinformes = preinformes.slice(0, 20);
    }
    
    var jsonData = JSON.stringify(preinformes);
    
    // Intentar guardar en localStorage (SharedSync intercepta y sube a Firebase)
    var localOK = false;
    try {
        localStorage.setItem('preinformes', jsonData);
        localOK = true;
    } catch(e) {
        console.warn('[Guardar] localStorage lleno, limpiando...', e);
        try {
            // Limpiar items no esenciales sin usar localStorage.clear()
            var keysToKeep = ['preinformes','visitasAgendadas','evaluaciones','accionesCentros','centrosFlop','informesBorrador','borradoresInforme','informesFinalizados'];
            for(var i = localStorage.length - 1; i >= 0; i--) {
                var key = localStorage.key(i);
                if(keysToKeep.indexOf(key) === -1) localStorage.removeItem(key);
            }
            if(preinformes.length > 10) preinformes = preinformes.slice(0, 10);
            jsonData = JSON.stringify(preinformes);
            localStorage.setItem('preinformes', jsonData);
            localOK = true;
        } catch(e2) {
            try {
                preinformes = preinformes.slice(0, 5);
                jsonData = JSON.stringify(preinformes);
                localStorage.setItem('preinformes', jsonData);
                localOK = true;
            } catch(e3) {
                console.error('[Guardar] localStorage no disponible');
            }
        }
    }
    
    // SIEMPRE intentar subir directamente a Firebase como respaldo
    sincronizarConFirebaseDirecto('preinformes', jsonData);
    
    return localOK || true; // Retornar true si al menos Firebase recibió los datos
}

// Función directa de sincronización a Firebase (no depende de interceptor localStorage)
function sincronizarConFirebaseDirecto(key, value) {
    try {
        if(db && typeof firebase !== 'undefined') {
            db.collection('plataformaAdmin').doc(key).set({
                v: value,
                ts: firebase.firestore.FieldValue.serverTimestamp()
            }).then(function() {
                console.log('[Firebase] ✅ ' + key + ' guardado en Firebase directamente');
            }).catch(function(e) {
                console.warn('[Firebase] ⚠️ Error guardando ' + key + ':', e.message);
            });
        } else {
            console.warn('[Firebase] DB no disponible, datos solo en localStorage');
        }
    } catch(e) {
        console.warn('[Firebase] Error sync directo:', e);
    }
}

// Sincronizar múltiples keys a Firebase de una vez
function sincronizarTodoAFirebase() {
    var keys = ['preinformes','informesBorrador','borradoresInforme','informesFinalizados','visitasAgendadas','evaluaciones'];
    keys.forEach(function(key) {
        var val = null;
        try { val = localStorage.getItem(key); } catch(e) {}
        if(val && val !== '[]' && val !== '{}' && val !== 'null') {
            sincronizarConFirebaseDirecto(key, val);
        }
    });
}

// ═══════════════════════════════════════════════════════════════
// GUARDAR GLOBAL - Guarda TODOS los datos de TODOS los módulos
// ═══════════════════════════════════════════════════════════════
var _hayDatosSinGuardar = false;
var _ultimoGuardadoGlobal = 0;

// Marcar que hay cambios pendientes
function marcarCambiosPendientes() {
    _hayDatosSinGuardar = true;
    var btn = document.getElementById('btn-guardar-global');
    if(btn) {
        btn.style.background = 'linear-gradient(135deg,#f59e0b,#d97706)';
        btn.innerHTML = '💾 GUARDAR*';
    }
    var est = document.getElementById('guardar-estado');
    if(est) { est.textContent = '⚠️ Sin guardar'; est.style.color = '#f59e0b'; }
}

// Interceptar localStorage.setItem para detectar cambios
(function() {
    var _origSetItem = localStorage.setItem.bind(localStorage);
    localStorage.setItem = function(key, value) {
        _origSetItem(key, value);
        // Solo marcar si es una key de datos relevante
        var keysRelevantes = ['visitasAgendadas','preinformes','informesFinalizados','informesBorrador','borradoresInforme','evaluaciones','centrosFlop','accionesCentros','paquetesCentros','centrosModificados','accionesFlop','accionesExclusivosFunnel','accionesFlopFunnel'];
        if(keysRelevantes.indexOf(key) >= 0 || key.indexOf('criteriosPaq_') === 0 || key.indexOf('calV2_') === 0) {
            marcarCambiosPendientes();
        }
    };
})();

async function guardarTodoGlobal() {
    var btn = document.getElementById('btn-guardar-global');
    var est = document.getElementById('guardar-estado');
    if(btn) { btn.style.background = '#6b7280'; btn.innerHTML = '⏳ Guardando...'; btn.disabled = true; }
    if(est) { est.textContent = '⏳ Guardando...'; est.style.color = '#6b7280'; }
    
    var guardados = 0, errores = 0;
    
    // 1. Guardar TODAS las keys compartidas en Firebase
    var allKeys = [
        'visitasAgendadas', 'preinformes', 'informesFinalizados', 'informesBorrador',
        'borradoresInforme', 'evaluaciones', 'accionesFlop',
        'accionesExclusivosFunnel', 'accionesFlopFunnel',
        'centrosFlop', 'accionesCentros', 'paquetesCentros', 'centrosModificados',
        'cifrasMesActual', 'cifrasPrevMes', 'datosCVNMes',
        'funnelDashboardData', 'gamasDashboardData', 'aarData'
    ];
    
    // Añadir keys con prefijo criteriosPaq_
    for(var i = 0; i < localStorage.length; i++) {
        var k = localStorage.key(i);
        if(k && k.indexOf('criteriosPaq_') === 0 && allKeys.indexOf(k) < 0) allKeys.push(k);
        if(k && k.indexOf('calV2_') === 0 && allKeys.indexOf(k) < 0) allKeys.push(k);
    }
    
    // Firebase batch para eficiencia
    try {
        if(db) {
            var batch = db.batch();
            var batchCount = 0;
            
            allKeys.forEach(function(key) {
                var val = null;
                try { val = localStorage.getItem(key); } catch(e) {}
                if(val && val !== 'null' && val !== '' && val !== '[]' && val !== '{}') {
                    batch.set(db.collection('plataformaAdmin').doc(key), {
                        v: val,
                        ts: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    batchCount++;
                }
            });
            
            if(batchCount > 0) {
                await batch.commit();
                guardados = batchCount;
                console.log('[GUARDAR GLOBAL] ✅ ' + guardados + ' claves guardadas en Firebase');
            }
        } else {
            // Sin Firebase, solo confirmar localStorage
            allKeys.forEach(function(key) {
                var val = localStorage.getItem(key);
                if(val) guardados++;
            });
            console.warn('[GUARDAR GLOBAL] ⚠️ Firebase no disponible, datos solo en localStorage');
        }
    } catch(e) {
        errores++;
        console.error('[GUARDAR GLOBAL] ❌ Error:', e);
        // Fallback: guardar key por key
        allKeys.forEach(function(key) {
            var val = localStorage.getItem(key);
            if(val && val !== 'null' && val !== '[]' && val !== '{}') {
                sincronizarConFirebaseDirecto(key, val);
                guardados++;
            }
        });
    }
    
    // Actualizar UI
    _hayDatosSinGuardar = false;
    _ultimoGuardadoGlobal = Date.now();
    
    if(btn) {
        btn.disabled = false;
        if(errores > 0) {
            btn.style.background = 'linear-gradient(135deg,#f59e0b,#d97706)';
            btn.innerHTML = '⚠️ GUARDAR';
        } else {
            btn.style.background = 'linear-gradient(135deg,#10b981,#059669)';
            btn.innerHTML = '✅ GUARDADO';
            setTimeout(function() { btn.innerHTML = '💾 GUARDAR'; }, 2000);
        }
    }
    if(est) {
        var ahora = new Date();
        est.textContent = '✅ ' + ahora.getHours().toString().padStart(2,'0') + ':' + ahora.getMinutes().toString().padStart(2,'0');
        est.style.color = '#10b981';
    }
    
    return { guardados: guardados, errores: errores };
}

// Backup: descargar HTML completo
function descargarBackupHTML() {
    try {
        var html = document.documentElement.outerHTML;
        var blob = new Blob(['<!DOCTYPE html>\n' + html], { type: 'text/html;charset=utf-8' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        var fecha = new Date().toISOString().split('T')[0];
        var hora = new Date().toTimeString().split(' ')[0].replace(/:/g,'-');
        a.href = url;
        a.download = 'backup_admin_' + fecha + '_' + hora + '.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        var est = document.getElementById('guardar-estado');
        if(est) { est.textContent = '📦 Backup OK'; est.style.color = '#6366f1'; setTimeout(function(){ est.textContent = ''; }, 3000); }
    } catch(e) {
        alert('Error al crear backup: ' + e.message);
    }
}

// Aviso al cerrar/salir con cambios pendientes
window.addEventListener('beforeunload', function(e) {
    if(_hayDatosSinGuardar) {
        e.preventDefault();
        e.returnValue = '¿Tienes cambios sin guardar. Seguro que quieres salir?';
        return e.returnValue;
    }
});

// Auto-guardado cada 5 minutos si hay cambios
setInterval(function() {
    if(_hayDatosSinGuardar && (Date.now() - _ultimoGuardadoGlobal > 120000)) {
        console.log('[AUTO-SAVE] Guardando automáticamente...');
        guardarTodoGlobal();
    }
}, 300000);

function showSection(id, btn) {
    // SIEMPRE eliminar el banner de solo lectura al cambiar de sección
    var readonlyBanner = document.getElementById('readonly-banner');
    if(readonlyBanner) readonlyBanner.remove();
    
    // Rehabilitar inputs si estaban deshabilitados
    var seccionInforme = document.getElementById('section-informe');
    if(seccionInforme) {
        seccionInforme.querySelectorAll('input, textarea, select').forEach(function(el) {
            el.disabled = false;
            el.style.opacity = '1';
            if(el.tagName === 'TEXTAREA') { el.spellcheck = false; }
        });
        seccionInforme.querySelectorAll('button').forEach(function(btn) {
            btn.style.display = '';
        });
        var zonaAdj = document.getElementById('zona-adjuntar');
        if(zonaAdj) zonaAdj.style.display = '';
    }
    
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-' + id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    const titles = {
        dashboard:'Dashboard',
        calendario:'Calendario de Visitas',
        'guia-eval':'Evaluación + Guía',
        informes:'Informes',
        visitas:'Visitas',
        guia:'Guía de la Visita',
        evaluacion:'Evaluación',
        informe:'Crear Informe',
        'informes-gestion':'Gestión de Informes',
        exclusivos:'Exclusivos-Flop',
        aar:'AAR',
        funnel:'Funnel'
    };
    document.getElementById('page-title').textContent = titles[id] || id;
    if(id === 'evaluacion' || id === 'guia-eval') resetEval();
    if(id === 'informe' || id === 'informes') {
        // Solo limpiar si no venimos de un preinforme
        if(!window.noLimpiarInforme) {
            limpiarInforme();
        }
        window.noLimpiarInforme = false; // Resetear bandera
        setTimeout(initRadarCharts, 100);
        setTimeout(function() { initDonutCharts(0, 0, 0); }, 150);
        if(id === 'informes') cargarListasBorradoresFinalizados();
    }
    if(id === 'informes-gestion') cargarInformesGestion();
    if(id === 'dashboard') {
        updateDashboard();
        actualizarDashboardMedia();
    }
    if(id === 'visitas' || id === 'calendario') setTimeout(renderCentrosVisitas, 100);
    if(id === 'exclusivos') setTimeout(initExclusivosFlop, 100);
    if(id === 'funnel') setTimeout(initFunnel, 100);
}

// Toggle navegación grupo Visitas
function toggleNavGroup(btn) {
    const submenu = btn.parentElement.querySelector('.nav-submenu');
    const isOpen = submenu.style.display === 'block';
    submenu.style.display = isOpen ? 'none' : 'block';
    btn.classList.toggle('open', !isOpen);
}

// Cambiar pestañas Guía/Evaluación
function cambiarTabGuiaEval(tab) {
    const tabGuia = document.getElementById('tab-guia');
    const tabEval = document.getElementById('tab-eval');
    const contGuia = document.getElementById('contenido-guia');
    const contEval = document.getElementById('contenido-eval');
    
    if(tab === 'guia') {
        tabGuia.style.background = '#C9A227';
        tabGuia.style.color = '#fff';
        tabEval.style.background = '#4a4a4a';
        tabEval.style.color = '#888';
        contGuia.style.display = 'block';
        contEval.style.display = 'none';
    } else {
        tabEval.style.background = '#C9A227';
        tabEval.style.color = '#fff';
        tabGuia.style.background = '#4a4a4a';
        tabGuia.style.color = '#888';
        contGuia.style.display = 'none';
        contEval.style.display = 'block';
    }
}

// Toggle desplegables en Informes
function toggleDesplegable(id) {
    const desp = document.getElementById(id);
    const arrow = document.getElementById('arrow-' + id.replace('desp-', ''));
    const isOpen = desp.style.display === 'block';
    desp.style.display = isOpen ? 'none' : 'block';
    if(arrow) arrow.textContent = isOpen ? '▼' : '▲';
}

// Cargar listas de borradores y finalizados
function cargarListasBorradoresFinalizados() {
    const borradores = JSON.parse(localStorage.getItem('borradoresInforme') || '[]');
    const finalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');
    
    document.getElementById('badge-borradores-main').textContent = borradores.length;
    document.getElementById('badge-finalizados-main').textContent = finalizados.length;
    
    const listaBorr = document.getElementById('lista-borradores-main');
    const listaFin = document.getElementById('lista-finalizados-main');
    
    if(borradores.length === 0) {
        listaBorr.innerHTML = '<div style="text-align:center;color:#888;font-size:10px;padding:15px">No hay borradores</div>';
    } else {
        listaBorr.innerHTML = borradores.map((b, i) => `
            <div style="background:#fff;padding:8px 12px;border-radius:6px;border-left:4px solid #C9A227;display:flex;justify-content:space-between;align-items:center">
                <div>
                    <div style="font-weight:700;font-size:10px">${b.centro || 'Sin nombre'}</div>
                    <div style="font-size:8px;color:#888">${b.fecha || '-'} • ${b.audiologo || '-'}</div>
                </div>
                <div style="display:flex;gap:4px">
                    <button onclick="editarBorradorMain(${i})" style="background:#C9A227;color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:8px;cursor:pointer">✏️ Editar</button>
                    <button onclick="borrarBorradorMain(${i})" style="background:#dc2626;color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:8px;cursor:pointer">🗑️</button>
                </div>
            </div>
        `).join('');
    }
    
    if(finalizados.length === 0) {
        listaFin.innerHTML = '<div style="text-align:center;color:#888;font-size:10px;padding:15px">No hay informes finalizados</div>';
    } else {
        listaFin.innerHTML = finalizados.map((f, i) => `
            <div style="background:#fff;padding:8px 12px;border-radius:6px;border-left:4px solid #22c55e;display:flex;justify-content:space-between;align-items:center">
                <div>
                    <div style="font-weight:700;font-size:10px">${f.centro || 'Sin nombre'}</div>
                    <div style="font-size:8px;color:#888">${f.fecha || '-'} • ${f.audiologo || '-'}</div>
                </div>
                <div style="display:flex;gap:4px">
                    <button onclick="verFinalizadoMain(${i})" style="background:#22c55e;color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:8px;cursor:pointer">👁️ Ver</button>
                    <button onclick="imprimirFinalizadoMain(${i})" style="background:#3b82f6;color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:8px;cursor:pointer">🖨️</button>
                </div>
            </div>
        `).join('');
    }
}

// Guardar borrador desde sección principal
function guardarBorradorInformeMain() {
    const borrador = {
        centro: document.getElementById('inf-centro-main').value,
        propietario: document.getElementById('inf-propietario-main').value,
        delegadoRegional: document.getElementById('inf-delegado-regional-main').value,
        delegadoAudio: document.getElementById('inf-delegado-audio-main').value,
        tipoVisita: document.getElementById('inf-tipo-visita-main').value,
        fecha: document.getElementById('inf-fecha-main').value,
        audiologo: document.getElementById('inf-audiologo-main').value,
        horas: document.getElementById('inf-horas-main').value,
        positivos: document.getElementById('inf-positivos-main').value,
        mejora: document.getElementById('inf-mejora-main').value,
        plan: document.getElementById('inf-plan-main').value,
        guardadoEn: new Date().toISOString()
    };
    
    if(!borrador.centro) {
        alert('⚠️ Introduce al menos el nombre del centro');
        return;
    }
    
    const borradores = JSON.parse(localStorage.getItem('borradoresInforme') || '[]');
    borradores.unshift(borrador);
    localStorage.setItem('borradoresInforme', JSON.stringify(borradores)); localStorage.setItem('informesBorrador', JSON.stringify(borradores)); informesBorrador = borradores;
    
    alert('✅ Borrador guardado correctamente');
    cargarListasBorradoresFinalizados();
    limpiarInformeMain();
}

// Finalizar informe
function finalizarInformeMain() {
    const informe = {
        centro: document.getElementById('inf-centro-main').value,
        propietario: document.getElementById('inf-propietario-main').value,
        delegadoRegional: document.getElementById('inf-delegado-regional-main').value,
        delegadoAudio: document.getElementById('inf-delegado-audio-main').value,
        tipoVisita: document.getElementById('inf-tipo-visita-main').value,
        fecha: document.getElementById('inf-fecha-main').value,
        audiologo: document.getElementById('inf-audiologo-main').value,
        horas: document.getElementById('inf-horas-main').value,
        positivos: document.getElementById('inf-positivos-main').value,
        mejora: document.getElementById('inf-mejora-main').value,
        plan: document.getElementById('inf-plan-main').value,
        finalizadoEn: new Date().toISOString()
    };
    
    if(!informe.centro || !informe.fecha) {
        alert('⚠️ Introduce al menos Centro y Fecha');
        return;
    }
    
    if(!confirm('¿Finalizar este informe? Una vez finalizado no se podrá editar.')) return;
    
    const finalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');
    finalizados.unshift(informe);
    localStorage.setItem('informesFinalizados', JSON.stringify(finalizados));
    
    alert('✅ Informe finalizado correctamente');
    cargarListasBorradoresFinalizados();
    limpiarInformeMain();
}

// Limpiar formulario
function limpiarInformeMain() {
    document.getElementById('inf-centro-main').value = '';
    document.getElementById('inf-propietario-main').value = '';
    document.getElementById('inf-delegado-regional-main').value = '';
    document.getElementById('inf-fecha-main').value = '';
    document.getElementById('inf-audiologo-main').value = '';
    document.getElementById('inf-horas-main').value = '';
    document.getElementById('inf-positivos-main').value = '';
    document.getElementById('inf-mejora-main').value = '';
    document.getElementById('inf-plan-main').value = '';
}

// Editar borrador
function editarBorradorMain(idx) {
    const borradores = JSON.parse(localStorage.getItem('borradoresInforme') || '[]');
    const b = borradores[idx];
    if(!b) return;
    
    document.getElementById('inf-centro-main').value = b.centro || '';
    document.getElementById('inf-propietario-main').value = b.propietario || '';
    document.getElementById('inf-delegado-regional-main').value = b.delegadoRegional || '';
    document.getElementById('inf-delegado-audio-main').value = b.delegadoAudio || '';
    document.getElementById('inf-tipo-visita-main').value = b.tipoVisita || '';
    document.getElementById('inf-fecha-main').value = b.fecha || '';
    document.getElementById('inf-audiologo-main').value = b.audiologo || '';
    document.getElementById('inf-horas-main').value = b.horas || '';
    document.getElementById('inf-positivos-main').value = b.positivos || '';
    document.getElementById('inf-mejora-main').value = b.mejora || '';
    document.getElementById('inf-plan-main').value = b.plan || '';
    
    // Eliminar el borrador de la lista
    borradores.splice(idx, 1);
    localStorage.setItem('borradoresInforme', JSON.stringify(borradores)); localStorage.setItem('informesBorrador', JSON.stringify(borradores)); informesBorrador = borradores;
    cargarListasBorradoresFinalizados();
    
    // Cerrar desplegable
    document.getElementById('desp-borradores-main').style.display = 'none';
}

// Borrar borrador
function borrarBorradorMain(idx) {
    if(!confirm('¿Eliminar este borrador?')) return;
    // Bloquear keys para evitar que merge restaure el dato
    if(typeof SharedSync !== 'undefined' && SharedSync.lockKeyForDelete) {
        SharedSync.lockKeyForDelete('informesBorrador');
        SharedSync.lockKeyForDelete('borradoresInforme');
    }
    const borradores = JSON.parse(localStorage.getItem('borradoresInforme') || '[]');
    borradores.splice(idx, 1);
    localStorage.setItem('borradoresInforme', JSON.stringify(borradores)); 
    localStorage.setItem('informesBorrador', JSON.stringify(borradores)); 
    informesBorrador = borradores;
    // Sincronizar con Firebase
    sincronizarConFirebaseDirecto('borradoresInforme', JSON.stringify(borradores));
    sincronizarConFirebaseDirecto('informesBorrador', JSON.stringify(borradores));
    cargarListasBorradoresFinalizados();
}

// Ver finalizado
function verFinalizadoMain(idx) {
    const finalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');
    const f = finalizados[idx];
    if(!f) return;
    
    // Usar verInformeFinalizado para cargar el informe completo
    informesFinalizados = finalizados;
    verInformeFinalizado(idx);
}

// Imprimir finalizado desde main
function imprimirFinalizadoMain(idx) {
    const finalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');
    informesFinalizados = finalizados;
    verInformeFinalizado(idx);
    setTimeout(() => window.print(), 600);
}

// Cargar informes finalizados en la sección dedicada
function cargarInformesFinalizados() {
    const finalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');
    const container = document.getElementById('lista-finalizados');
    const countEl = document.getElementById('count-finalizados-tab');
    
    if(countEl) countEl.textContent = finalizados.length;
    
    if(!container) return;
    
    if(finalizados.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#888;font-size:11px;padding:40px">No hay informes finalizados</div>';
        return;
    }
    
    // Ordenar por fecha más reciente
    var finalizadosOrdenados = finalizados.map((f, idx) => ({...f, _idx: idx}));
    finalizadosOrdenados.sort((a, b) => {
        var fechaA = a.fecha || a.fechaFinalizacion || '1900-01-01';
        var fechaB = b.fecha || b.fechaFinalizacion || '1900-01-01';
        return fechaB.localeCompare(fechaA);
    });
    
    container.innerHTML = finalizadosOrdenados.map((f) => {
        var i = f._idx;
        const resultado = f.resultado || 0;
        const colorRes = resultado >= 80 ? '#22c55e' : resultado >= 60 ? '#C9A227' : '#dc2626';
        return `
        <div class="informe-item-fin" data-centro="${(f.centro || '').toLowerCase()}" data-responsable="${f.delegadoAudio || ''}" style="display:grid;grid-template-columns:2fr 1fr 1fr 0.8fr 1fr 120px;gap:10px;padding:12px 15px;background:#fff;border:1px solid #e5e7eb;border-radius:6px;align-items:center;font-size:11px;transition:all 0.2s" onmouseover="this.style.background='#f9fafb';this.style.borderColor='#22c55e'" onmouseout="this.style.background='#fff';this.style.borderColor='#e5e7eb'">
            <div style="font-weight:600;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${f.centro || 'Sin nombre'}</div>
            <div style="color:#666">${f.fecha || '-'}</div>
            <div style="color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${f.audiologo || '-'}</div>
            <div style="font-weight:700;color:${colorRes}">${resultado}%</div>
            <div style="color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${f.delegadoAudio || '-'}</div>
            <div style="display:flex;gap:4px;justify-content:center">
                <button onclick="verFinalizadoDetalle(${i})" style="background:#6b7280;color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:9px;cursor:pointer" title="Ver">👁️</button>
                <button onclick="imprimirInformeFinalizado(${i})" style="background:#3b82f6;color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:9px;cursor:pointer" title="Imprimir">🖨️</button>
                <button onclick="eliminarInformeFinalizado(${i})" style="background:#dc2626;color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:9px;cursor:pointer" title="Eliminar">🗑️</button>
            </div>
        </div>
    `}).join('');
    
    // Actualizar dashboard con media de finalizados
    actualizarDashboardMedia();
}

// Cargar borradores en la sección dedicada
function cargarBorradoresInformes() {
    // Leer de AMBAS keys por compatibilidad, priorizar 'informesBorrador'
    var borradores = JSON.parse(localStorage.getItem('informesBorrador') || '[]');
    if(borradores.length === 0) {
        borradores = JSON.parse(localStorage.getItem('borradoresInforme') || '[]');
    }
    // Sincronizar variable en memoria
    informesBorrador = borradores;
    
    const container = document.getElementById('lista-borradores');
    const countEl = document.getElementById('count-borradores-tab');
    
    if(countEl) countEl.textContent = borradores.length;
    
    if(!container) return;
    
    if(borradores.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#888;font-size:11px;padding:40px">No hay borradores guardados</div>';
        return;
    }
    
    container.innerHTML = borradores.map((b, i) => `
        <div class="informe-item-borr" data-centro="${(b.centro || '').toLowerCase()}" style="display:grid;grid-template-columns:2fr 1fr 1fr 0.8fr 1fr 120px;gap:10px;padding:12px 15px;background:#fff;border:1px solid #e5e7eb;border-radius:6px;align-items:center;font-size:11px;transition:all 0.2s" onmouseover="this.style.background='#fffbeb';this.style.borderColor='#C9A227'" onmouseout="this.style.background='#fff';this.style.borderColor='#e5e7eb'">
            <div style="font-weight:600;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${b.centro || 'Sin nombre'}</div>
            <div style="color:#666">${b.fecha || '-'}</div>
            <div style="color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${b.audiologo || '-'}</div>
            <div style="font-weight:700;color:#C9A227">${b.resultado || 0}%</div>
            <div style="color:#888;font-size:9px">${b.guardadoEn ? new Date(b.guardadoEn).toLocaleDateString('es-ES') : '-'}</div>
            <div style="display:flex;gap:4px;justify-content:center">
                <button onclick="editarBorradorSeccion(${i})" style="background:#C9A227;color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:9px;cursor:pointer;font-weight:600">✏️ Editar</button>
                <button onclick="eliminarBorradorSeccion(${i})" style="background:#dc2626;color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:9px;cursor:pointer">🗑️</button>
            </div>
        </div>
    `).join('');
}

// Cambiar tab entre finalizados y borradores
function cambiarTabInformes(tab) {
    const tabFin = document.getElementById('tab-finalizados');
    const tabBorr = document.getElementById('tab-borradores');
    const contFin = document.getElementById('contenido-finalizados');
    const contBorr = document.getElementById('contenido-borradores');
    
    if(tab === 'finalizados') {
        tabFin.style.background = '#22c55e';
        tabFin.style.color = '#fff';
        tabBorr.style.background = '#f3f4f6';
        tabBorr.style.color = '#666';
        contFin.style.display = 'block';
        contBorr.style.display = 'none';
    } else {
        tabBorr.style.background = '#C9A227';
        tabBorr.style.color = '#fff';
        tabFin.style.background = '#f3f4f6';
        tabFin.style.color = '#666';
        contBorr.style.display = 'block';
        contFin.style.display = 'none';
    }
}

// Filtrar informes por búsqueda
function filtrarInformesGestion(tipo) {
    if(tipo === 'finalizados') {
        const filtro = document.getElementById('filtro-finalizados').value.toLowerCase();
        const responsable = document.getElementById('filtro-responsable-fin').value;
        const delegReg = document.getElementById('filtro-delegreg-fin')?.value || '';
        const propiedad = document.getElementById('filtro-propiedad-fin')?.value || '';
        const perimetro = document.getElementById('filtro-perimetro-fin')?.value || '';
        
        const items = document.querySelectorAll('.informe-item-fin');
        items.forEach(item => {
            const centro = item.getAttribute('data-centro') || '';
            const codigo = item.getAttribute('data-codigo') || '';
            const resp = item.getAttribute('data-responsable') || '';
            
            // Buscar datos del centro en centrosData
            const centroData = centrosData.find(c => c.c === codigo);
            
            const matchCentro = centro.toLowerCase().includes(filtro) || codigo.toLowerCase().includes(filtro);
            const matchResp = !responsable || resp === responsable;
            const matchDelegReg = !delegReg || (centroData && centroData.d === delegReg);
            const matchPropiedad = !propiedad || (centroData && centroData.pr === propiedad);
            const matchPerimetro = !perimetro || (centroData && centroData.pc === perimetro);
            
            item.style.display = (matchCentro && matchResp && matchDelegReg && matchPropiedad && matchPerimetro) ? 'block' : 'none';
        });
    } else {
        const filtro = document.getElementById('filtro-borradores').value.toLowerCase();
        const responsable = document.getElementById('filtro-responsable-borr')?.value || '';
        const delegReg = document.getElementById('filtro-delegreg-borr')?.value || '';
        const propiedad = document.getElementById('filtro-propiedad-borr')?.value || '';
        const perimetro = document.getElementById('filtro-perimetro-borr')?.value || '';
        
        const items = document.querySelectorAll('.informe-item-borr');
        items.forEach(item => {
            const centro = item.getAttribute('data-centro') || '';
            const codigo = item.getAttribute('data-codigo') || '';
            
            // Buscar datos del centro en centrosData
            const centroData = centrosData.find(c => c.c === codigo);
            
            const matchCentro = centro.toLowerCase().includes(filtro) || codigo.toLowerCase().includes(filtro);
            const matchResp = !responsable || (centroData && centroData.r === responsable);
            const matchDelegReg = !delegReg || (centroData && centroData.d === delegReg);
            const matchPropiedad = !propiedad || (centroData && centroData.pr === propiedad);
            const matchPerimetro = !perimetro || (centroData && centroData.pc === perimetro);
            
            item.style.display = (matchCentro && matchResp && matchDelegReg && matchPropiedad && matchPerimetro) ? 'block' : 'none';
        });
    }
}

// Exportar informes a CSV
function exportarInformesCSV(tipo) {
    const data = tipo === 'finalizados' 
        ? JSON.parse(localStorage.getItem('informesFinalizados') || '[]')
        : JSON.parse(localStorage.getItem('borradoresInforme') || '[]');
    
    if(data.length === 0) {
        alert('No hay datos para exportar');
        return;
    }
    
    const headers = ['Centro','Fecha','Audiólogo','Delegado Audio','Resultado','Propietario','Tipo Visita'];
    const rows = data.map(d => [
        d.centro || '',
        d.fecha || '',
        d.audiologo || '',
        d.delegadoAudio || '',
        d.resultado || '',
        d.propietario || '',
        d.tipoVisita || ''
    ]);
    
    const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
    const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `informes_${tipo}_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
}

// Actualizar dashboard con media de informes finalizados
function actualizarDashboardMedia() {
    const todosFinalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');
    
    // Aplicar filtro de delegado regional si está activo
    const filtroDelegado = document.getElementById('filtro-delegado-dashboard');
    const delegadoSeleccionado = filtroDelegado ? filtroDelegado.value : '';
    const centrosFiltrados = delegadoSeleccionado ? getCentrosPorDelegado(delegadoSeleccionado) : null;
    
    const finalizados = centrosFiltrados 
        ? todosFinalizados.filter(f => {
            // Coincidir por delegadoRegional del informe O por código de centro
            if(f.delegadoRegional === delegadoSeleccionado) return true;
            if(f.centro) {
                const codigoCentro = f.centro.split(' ')[0].toUpperCase();
                return centrosFiltrados.includes(codigoCentro);
            }
            return false;
        })
        : todosFinalizados;
    
    if(centrosFiltrados) {
        console.log('[actualizarDashboardMedia] 🔍 Filtro delegado:', delegadoSeleccionado, '- Informes filtrados:', finalizados.length, '/', todosFinalizados.length);
    }
    
    // Calcular media de resultados y otros KPIs
    let sumaResultado = 0, countResultado = 0;
    let sumaPIA = 0, sumaFormacion = 0, sumaComunicacion = 0, sumaRT = 0, sumaAgenda = 0;
    let sumaConversiones = 0, sumaAyudas = 0, sumaComplementarias = 0;
    let countBloques = 0;
    let totalGamasDiamantePlus = 0, totalGamasDiamante = 0, totalGamasPlatinoPlus = 0, totalGamasPlatino = 0, totalGamasOro = 0;
    let totalTipoAtenAdulto = 0, totalTipoAtenTinnitus = 0, totalTipoAtenPediatrico = 0;
    let totalBasicos = 0, countBasicos = 0;
    let centrosEvaluados = new Set();
    
    finalizados.forEach(f => {
        // Media de resultados globales
        if(f.resultado && !isNaN(parseFloat(f.resultado))) {
            sumaResultado += parseFloat(f.resultado);
            countResultado++;
        }
        
        // Centros únicos
        if(f.centro) centrosEvaluados.add(f.centro.toUpperCase());
        
        // Bloques porcentuales
        if(f.bloquesPct) {
            countBloques++;
            sumaPIA += f.bloquesPct.PIA || 0;
            sumaFormacion += f.bloquesPct.FORMACION || 0;
            sumaComunicacion += f.bloquesPct.COMUNICACION || 0;
            sumaRT += f.bloquesPct.RT || 0;
            sumaAgenda += f.bloquesPct.AGENDA || 0;
            sumaConversiones += f.bloquesPct.CONVERSIONES || 0;
            sumaAyudas += f.bloquesPct.AYUDAS || 0;
            sumaComplementarias += f.bloquesPct.COMPLEMENTARIAS || 0;
        }
        
        // Gamas
        if(f.gamas) {
            totalGamasDiamantePlus += f.gamas.diamantePlus || 0;
            totalGamasDiamante += f.gamas.diamante || 0;
            totalGamasPlatinoPlus += f.gamas.platinoPlus || 0;
            totalGamasPlatino += f.gamas.platino || 0;
            totalGamasOro += f.gamas.oro || 0;
        }
        
        // Tipo de atención
        if(f.tipoAtencion) {
            totalTipoAtenAdulto += f.tipoAtencion.adulto || 0;
            totalTipoAtenTinnitus += f.tipoAtencion.tinnitus || 0;
            totalTipoAtenPediatrico += f.tipoAtencion.pediatrico || 0;
        }
        
        // 11 Básicos
        if(f.basicos && Array.isArray(f.basicos)) {
            countBasicos++;
            const cumplidos = f.basicos.filter(b => b === 1).length;
            totalBasicos += Math.round((cumplidos / 11) * 100);
        }
    });
    
    const media = countResultado > 0 ? Math.round(sumaResultado / countResultado) : 0;
    const mediaBasicos = countBasicos > 0 ? Math.round(totalBasicos / countBasicos) : 0;
    
    // Medias de bloques
    const mediaPIA = countBloques > 0 ? Math.round(sumaPIA / countBloques) : 0;
    const mediaFormacion = countBloques > 0 ? Math.round(sumaFormacion / countBloques) : 0;
    const mediaComunicacion = countBloques > 0 ? Math.round(sumaComunicacion / countBloques) : 0;
    const mediaRT = countBloques > 0 ? Math.round(sumaRT / countBloques) : 0;
    const mediaAgenda = countBloques > 0 ? Math.round(sumaAgenda / countBloques) : 0;
    
    // Actualizar elementos del dashboard
    const mediaEl = document.getElementById('dashboard-media-evaluaciones');
    if(mediaEl) mediaEl.textContent = media + '%';
    
    const totalEl = document.getElementById('dashboard-total-evaluaciones');
    if(totalEl) totalEl.textContent = finalizados.length;
    
    // Actualizar stat cards si existen
    const statProm = document.getElementById('stat-prom');
    if(statProm) statProm.textContent = media + '%';
    const statProm2 = document.getElementById('stat-prom-2');
    if(statProm2) statProm2.textContent = media + '%';
    const statEvals = document.getElementById('stat-evals');
    if(statEvals) statEvals.textContent = finalizados.length;
    const statEvals2 = document.getElementById('stat-evals-2');
    if(statEvals2) statEvals2.textContent = finalizados.length;
    
    // Centros visitados - Actualizar donut estilo AAR
    const visitadosProceso = centrosEvaluados.size; // Centros con informe finalizado
    // Total de centros oficiales: 227 (sin contar DEMO ni PRUEBAS)
    const totalCentros = centrosData.filter(c => c.t !== 'DEMO' && c.t !== 'PRUEBAS').length || 227;
    
    // V.PUNTUAL = centros con visita finalizada en calendario PERO SIN informe finalizado
    const centrosConVisitaPuntual = new Set();
    visitasAgendadas.filter(v => v.finalizado).forEach(v => {
        const cod = (v.codigo || '').toUpperCase();
        if(cod && !centrosEvaluados.has(cod)) centrosConVisitaPuntual.add(cod);
    });
    const visitadosPuntual = centrosConVisitaPuntual.size;
    
    const pendientes = totalCentros - visitadosProceso - visitadosPuntual;
    const cobertura = totalCentros > 0 ? Math.round(((visitadosProceso + visitadosPuntual) / totalCentros) * 100) : 0;
    
    // Actualizar valores
    const dashCentrosVisit = document.getElementById('dash-centros-visit');
    const dashCentrosActivos = document.getElementById('dash-centros-activos');
    const dashCentrosPend = document.getElementById('dash-centros-pend');
    const centrosTotalNum = document.getElementById('centrosTotalNum');
    const centrosPctCenter = document.getElementById('centrosPctCenter');
    
    if(dashCentrosVisit) dashCentrosVisit.textContent = visitadosProceso;
    if(dashCentrosActivos) dashCentrosActivos.textContent = visitadosPuntual;
    if(dashCentrosPend) dashCentrosPend.textContent = pendientes;
    if(centrosTotalNum) centrosTotalNum.textContent = totalCentros + ' total';
    if(centrosPctCenter) centrosPctCenter.textContent = cobertura + '%';
    
    // Nuevos campos leyenda
    var elRestProc = document.getElementById('dash-centros-resto-proc');
    var elRestPunt = document.getElementById('dash-centros-resto-punt');
    var elPctProc = document.getElementById('dash-centros-pct-proc');
    var elPctPunt = document.getElementById('dash-centros-pct-punt');
    if(elRestProc) elRestProc.textContent = totalCentros - visitadosProceso;
    if(elRestPunt) elRestPunt.textContent = totalCentros - visitadosPuntual;
    var pProc = totalCentros > 0 ? Math.round((visitadosProceso / totalCentros) * 100) : 0;
    var pPunt = totalCentros > 0 ? Math.round((visitadosPuntual / totalCentros) * 100) : 0;
    if(elPctProc) elPctProc.textContent = pProc + '%';
    if(elPctPunt) elPctPunt.textContent = pPunt + '%';
    
    // Dibujar canvas 2-ring Centros
    dibujarCentrosRing(visitadosProceso, visitadosPuntual, totalCentros);
    
    // Actualizar semáforo
    const pctVisit = (visitadosProceso / totalCentros) * 100;
    const pctActiv = (visitadosPuntual / totalCentros) * 100;
    const pctPend = (pendientes / totalCentros) * 100;
    const semaforoVisit = document.getElementById('centrosSemaforoVisit');
    const semaforoActiv = document.getElementById('centrosSemaforoActiv');
    const semaforoPend = document.getElementById('centrosSemaforoPend');
    
    if(semaforoVisit) semaforoVisit.style.flex = pctVisit || 0.1;
    if(semaforoActiv) semaforoActiv.style.flex = pctActiv || 0;
    if(semaforoPend) semaforoPend.style.flex = pctPend || 0.1;
    
    // Actualizar medias de bloques si existen elementos
    const elMediaPIA = document.getElementById('dash-media-pia');
    const elMediaFormacion = document.getElementById('dash-media-formacion');
    const elMediaComunicacion = document.getElementById('dash-media-comunicacion');
    const elMediaRT = document.getElementById('dash-media-rt');
    const elMediaAgenda = document.getElementById('dash-media-agenda');
    const elMediaBasicos = document.getElementById('dash-media-basicos');
    
    if(elMediaPIA) elMediaPIA.textContent = mediaPIA + '%';
    if(elMediaFormacion) elMediaFormacion.textContent = mediaFormacion + '%';
    if(elMediaComunicacion) elMediaComunicacion.textContent = mediaComunicacion + '%';
    if(elMediaRT) elMediaRT.textContent = mediaRT + '%';
    if(elMediaAgenda) elMediaAgenda.textContent = mediaAgenda + '%';
    if(elMediaBasicos) elMediaBasicos.textContent = mediaBasicos + '%';
    
    // Actualizar gamas desde informes si no hay datos de Firebase
    const gamasEl = document.getElementById('dash-gama-diamante');
    if(gamasEl && gamasEl.textContent === '0' && (totalGamasDiamantePlus + totalGamasDiamante + totalGamasPlatinoPlus + totalGamasPlatino + totalGamasOro) > 0) {
        actualizarGraficaGamas(totalGamasDiamantePlus, totalGamasDiamante, totalGamasPlatinoPlus, totalGamasPlatino, totalGamasOro);
    }
    
    console.log('[Dashboard] Media evaluaciones:', media + '%', 'Total:', finalizados.length, 'Centros:', centrosEvaluados.size);
}

// Editar informe finalizado (pasarlo a edición)
function editarInformeFinalizado(idx) {
    const finalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');
    const f = finalizados[idx];
    if(!f) return;
    
    // Cargar datos en el formulario de informe
    cargarDatosInforme(f);
    
    // Ir a la sección de informe
    showSection('informe');
}

// Cargar informes de gestión (llamada cuando se abre la sección)
function cargarInformesGestion() {
    // Always refresh from localStorage first (SharedSync may have updated it)
    try { informesBorrador = JSON.parse(localStorage.getItem('informesBorrador') || '[]'); } catch(e) { informesBorrador = []; }
    try { informesFinalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]'); } catch(e) { informesFinalizados = []; }
    
    // If empty and Firebase connected, attempt restore (non-blocking)
    if(informesFinalizados.length === 0 && informesBorrador.length === 0 && db) {
        verificarYRestaurarInformes().then(function() {
            // Re-read after potential restore
            try { informesBorrador = JSON.parse(localStorage.getItem('informesBorrador') || '[]'); } catch(e) {}
            try { informesFinalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]'); } catch(e) {}
            if(informesFinalizados.length > 0 || informesBorrador.length > 0) {
                // Data was restored - refresh the UI
                cargarInformesFinalizados();
                cargarBorradoresInformes();
                console.log('[Gestión] 🔄 Datos restaurados desde Firebase');
            }
        }).catch(function(e) { console.warn('[Gestión] Error restore:', e); });
    }
    
    cargarInformesFinalizados();
    cargarBorradoresInformes();
    
    // Mostrar indicador de almacenamiento
    var storageBar = document.getElementById('storage-indicator-bar');
    if(!storageBar) {
        var container = document.getElementById('section-informes-gestion');
        if(container) {
            var div = document.createElement('div');
            div.id = 'storage-indicator-bar';
            div.style.cssText = 'padding:6px 12px;background:#f8f8f8;border-radius:6px;border:1px solid #e0e0e0;margin-bottom:8px;display:flex;align-items:center;gap:10px;font-size:10px;color:#666';
            container.insertBefore(div, container.firstChild);
            storageBar = div;
        }
    }
    if(storageBar) {
        var info = getStorageCapacityInfo();
        var barColor = info.pctUsed > 85 ? '#dc2626' : info.pctUsed > 60 ? '#f59e0b' : '#22c55e';
        storageBar.innerHTML = '<span style="font-weight:600">💾 Almacenamiento:</span>' +
            '<div style="flex:1;max-width:150px;height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden"><div style="width:' + info.pctUsed + '%;height:100%;background:' + barColor + ';border-radius:3px"></div></div>' +
            '<span>' + info.usedMB + ' / ' + info.maxMB + ' MB (' + info.pctUsed + '%)</span>' +
            '<span style="margin-left:auto">📊 <strong>' + info.finalizados + '</strong> finalizados · <strong>' + info.borradores + '</strong> borradores · Caben ~<strong>' + info.canFitMore + '</strong> más</span>';
    }
}

// Ver detalle de informe finalizado - CARGA COMPLETA EN VISTA INFORME
function verFinalizadoDetalle(idx) {
    const finalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');
    const inf = finalizados[idx];
    if(!inf) return;
    
    // Usar verInformeFinalizado para cargar el informe completo
    informesFinalizados = finalizados; // Sincronizar variable en memoria
    verInformeFinalizado(idx);
}

// Generar PDF de informe
function generarPDFInforme(idx) {
    alert('📄 Generando PDF del informe...');
}

// Imprimir informe finalizado
function imprimirInformeFinalizado(idx) {
    verFinalizadoDetalle(idx);
    setTimeout(() => window.print(), 500);
}

// Imprimir finalizado rápido desde lista
function imprimirFinalizadoRapido(idx) {
    verInformeFinalizado(idx);
    setTimeout(() => window.print(), 500);
}

// Eliminar informe finalizado
function eliminarInformeFinalizado(idx) {
    if(!confirm('¿Eliminar este informe finalizado? Esta acción no se puede deshacer.')) return;
    
    // 1. Bloquear key para evitar que merge restaure el dato
    if(typeof SharedSync !== 'undefined' && SharedSync.lockKeyForDelete) {
        SharedSync.lockKeyForDelete('informesFinalizados');
    }
    
    // 2. Leer datos actuales y eliminar
    var finalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');
    finalizados.splice(idx, 1);
    
    // 3. Actualizar variable en memoria
    informesFinalizados = finalizados;
    
    // 4. Guardar en localStorage
    var jsonData = JSON.stringify(finalizados);
    localStorage.setItem('informesFinalizados', jsonData);
    
    // 5. Sincronizar con Firebase INMEDIATAMENTE (incluso vacío)
    sincronizarConFirebaseDirecto('informesFinalizados', jsonData);
    
    // 6. Actualizar TODAS las vistas
    cargarInformesFinalizados();
    updateDashboard();
    actualizarDashboardMedia();
    actualizarPentagonoDashboard();
    try { renderInformesFinalizados(); } catch(e) {}
    try { cargarInformesGestion(); } catch(e) {}
    
    // 7. Mostrar confirmación
    var msg = document.createElement('div');
    msg.innerHTML = '🗑️ Informe eliminado correctamente';
    msg.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#dc2626;color:#fff;padding:12px 24px;border-radius:8px;font-weight:700;font-size:14px;z-index:99999;box-shadow:0 4px 15px rgba(0,0,0,0.3)';
    document.body.appendChild(msg);
    setTimeout(function() { msg.remove(); }, 2000);
}

// Editar borrador desde sección
function editarBorradorSeccion(idx) {
    // Leer de la key correcta
    var borradores = JSON.parse(localStorage.getItem('informesBorrador') || '[]');
    if(borradores.length === 0) borradores = JSON.parse(localStorage.getItem('borradoresInforme') || '[]');
    const b = borradores[idx];
    if(!b) return;
    
    // Guardar índice para que guardarBorradorInforme() actualice en lugar de crear nuevo
    informeActualIndex = idx;
    informesBorrador = borradores;
    
    // Si tiene preinformeData, cargar como preinformeActual
    if(b.preinformeData) {
        preinformeActual = b.preinformeData;
        if(preinformeActual.preinformeData) delete preinformeActual.preinformeData;
    }
    
    // No limpiar porque cargamos datos existentes
    window.noLimpiarInforme = true;
    
    // Ir a la sección de informe
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-informe').classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('page-title').textContent = 'Informe Profesional (Editando Borrador)';
    
    // Cargar los datos del borrador en el formulario principal
    setTimeout(function() {
        // Datos básicos del informe
        document.getElementById('inf-centro').value = b.centro || '';
        document.getElementById('inf-propietario').value = b.propietario || '';
        document.getElementById('inf-delegado-regional').value = b.delegadoRegional || '';
        document.getElementById('inf-delegado-audio').value = b.delegadoAudio || '';
        document.getElementById('inf-tipo-visita').value = b.tipoVisita || '';
        document.getElementById('inf-fecha').value = b.fecha || '';
        document.getElementById('inf-pcpnc').value = b.pcpnc || '';
        document.getElementById('inf-horas').value = b.horasServicio || b.horas || '';
        
        // Cargar cifras de venta automáticamente
        if(b.centro) cargarCifrasVentaInforme(b.centro);
        
        // Textos
        if(b.textos) {
            document.getElementById('txt-observaciones').value = b.textos.observaciones || '';
            document.getElementById('txt-recomendaciones').value = b.textos.recomendaciones || '';
            document.getElementById('txt-compromisos').value = b.textos.compromisos || '';
            document.getElementById('tiempo-compromisos').value = b.textos.tiempoCompromisos || '1mes';
            if(b.textos.planAccion) document.getElementById('txt-plan-accion').value = b.textos.planAccion;
        }
        
        // Resultado
        if(b.resultado) {
            var cat = getCategoria(b.resultado);
            document.getElementById('inf-res-valor').textContent = b.resultado + '%';
            document.getElementById('inf-res-valor').style.color = cat.color;
            document.getElementById('inf-res-emoji').textContent = cat.emoji;
            document.getElementById('inf-res-cat').textContent = cat.nombre;
            document.getElementById('inf-res-msg').textContent = cat.mensaje;
        }
        
        // Barras de bloques
        if(b.respuestas || (b.preinformeData && b.preinformeData.respuestas)) {
            var resp = b.respuestas || b.preinformeData.respuestas;
            var bp = calcularBloquesPct(resp);
            actualizarBarra('pia', bp.PIA, 25);
            actualizarBarra('form', bp.FORMACION, 15);
            actualizarBarra('com', bp.COMUNICACION, 15);
            actualizarBarra('ayu', bp.AYUDAS, 4);
            actualizarBarra('comp', bp.COMPLEMENTARIAS, 6);
            actualizarBarra('rt', bp.RT, 25);
            actualizarBarra('conv', bp.CONVERSIONES, 0);
            actualizarBarra('age', bp.AGENDA, 10);
            
            // *** CARGAR CHECKLIST ***
            if(b.checklistHTML) {
                var checklistEl = document.getElementById('checklist-content');
                if(checklistEl) checklistEl.innerHTML = b.checklistHTML;
            } else {
                regenerarChecklistDesdeRespuestas(resp, bp);
            }
            
            // Conversiones
            document.getElementById('conv-pct-prueba').value = resp[99] || 0;
            document.getElementById('conv-pct-venta').value = resp[100] || 0;
            document.getElementById('conv-pct-screen').value = resp[98] || 0;
            document.getElementById('conv-mgm-val').value = resp[95] || 0;
            document.getElementById('conv-renove-val').value = resp[96] || 0;
            document.getElementById('conv-seguro-val').value = resp[97] || 0;
            document.getElementById('conv-ayudas-val').value = resp[94] || 0;
            
            actualizarKPIsInf(resp);
            generarAreasMejora(resp);
        }
        
        // Gamas
        if(b.gamas) {
            document.getElementById('gama-diamante-plus').value = b.gamas.diamantePlus || 0;
            document.getElementById('gama-diamante').value = b.gamas.diamante || 0;
            document.getElementById('gama-platino-plus').value = b.gamas.platinoPlus || 0;
            document.getElementById('gama-platino').value = b.gamas.platino || 0;
            document.getElementById('gama-oro').value = b.gamas.oro || 0;
            calcularGamas();
        }
        
        // Tipo atención
        if(b.tipoAtencion) {
            document.getElementById('tipoaten-adulto').value = b.tipoAtencion.adulto || 0;
            document.getElementById('tipoaten-tinnitus').value = b.tipoAtencion.tinnitus || 0;
            document.getElementById('tipoaten-pediatrico').value = b.tipoAtencion.pediatrico || 0;
            calcularTipoAtencion();
        }
        
        // Básicos
        if(b.basicos) {
            for(var i = 0; i < b.basicos.length; i++) {
                var cb = document.getElementById('basico-' + (i+1));
                if(cb) cb.checked = !!b.basicos[i];
            }
            actualizarPentagono();
        }
        
        // Habilitar edición
        document.getElementById('txt-observaciones').disabled = false;
        document.getElementById('txt-recomendaciones').disabled = false;
        document.getElementById('txt-compromisos').disabled = false;
        
        // Init charts
        try { 
            var pctP = b.respuestas ? (b.respuestas[99] || 0) : 0;
            var pctV = b.respuestas ? (b.respuestas[100] || 0) : 0;
            var pctS = b.respuestas ? (b.respuestas[98] || 0) : 0;
            initDonutCharts(pctP, pctV, pctS);
            initRadarCharts();
        } catch(e) {}
        
        // Cargar horas y actualizar básico 2
        if(b.horasServicio || b.horas) {
            actualizarBasico2Horas();
        }
    }, 300);
}

// Eliminar borrador desde sección
function eliminarBorradorSeccion(idx) {
    if(!confirm('¿Eliminar este borrador?')) return;
    // Bloquear keys para evitar que merge restaure el dato
    if(typeof SharedSync !== 'undefined' && SharedSync.lockKeyForDelete) {
        SharedSync.lockKeyForDelete('informesBorrador');
        SharedSync.lockKeyForDelete('borradoresInforme');
    }
    var borradores = JSON.parse(localStorage.getItem('informesBorrador') || '[]');
    if(borradores.length === 0) borradores = JSON.parse(localStorage.getItem('borradoresInforme') || '[]');
    borradores.splice(idx, 1);
    localStorage.setItem('informesBorrador', JSON.stringify(borradores));
    localStorage.setItem('borradoresInforme', JSON.stringify(borradores));
    informesBorrador = borradores;
    // Sincronizar con Firebase
    sincronizarConFirebaseDirecto('informesBorrador', JSON.stringify(borradores));
    sincronizarConFirebaseDirecto('borradoresInforme', JSON.stringify(borradores));
    cargarBorradoresInformes();
}

function resetEval() {
    if(saltarLimpiezaEvaluacion) return;
    // Volver a section-guia-eval
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-guia-eval').classList.add('active');
    document.getElementById('page-title').textContent = 'Evaluación + Guía';
    
    // Mostrar contenido-eval
    var contenidoEval = document.getElementById('contenido-eval');
    if(contenidoEval) contenidoEval.style.display = 'block';
    
    // Para section-evaluacion (ocultar todo)
    var evalPortada = document.getElementById('eval-portada');
    if(evalPortada) evalPortada.classList.add('active');
    
    // Ocultar otras pantallas
    var evalDinamica = document.getElementById('eval-dinamica');
    if(evalDinamica) evalDinamica.classList.remove('active');
    var evalInforme = document.getElementById('eval-informe');
    if(evalInforme) evalInforme.classList.remove('active');
    var evalInstrucciones = document.getElementById('eval-instrucciones');
    if(evalInstrucciones) evalInstrucciones.classList.remove('active');
    
    // Limpiar campos de portada (IDs originales)
    var ec = document.getElementById('eval-centro');
    if(ec) ec.value = '';
    var ef = document.getElementById('eval-fecha');
    if(ef) ef.valueAsDate = new Date();
    var epc = document.getElementById('eval-pcpnc');
    if(epc) epc.value = '';
    var er = document.getElementById('eval-responsable');
    if(er) er.value = '';
    
    // Limpiar campos de portada (IDs con -2 para Evaluación + Guía)
    var ec2 = document.getElementById('eval-centro-2');
    if(ec2) ec2.value = '';
    var ef2 = document.getElementById('eval-fecha-2');
    if(ef2) ef2.valueAsDate = new Date();
    var epc2 = document.getElementById('eval-pcpnc-2');
    if(epc2) epc2.value = '';
    var er2 = document.getElementById('eval-responsable-2');
    if(er2) er2.value = '';
    
    // Limpiar campos de instrucciones
    var ena = document.getElementById('eval-nombre-audiologo');
    if(ena) ena.value = '';
    var ehs = document.getElementById('eval-horas-servicio');
    if(ehs) ehs.value = '';
    
    nombreAudiologoEval = '';
    horasServicioEval = 0;
    centroSeleccionadoCodigo = null;
    renderPreinformes();
}

var centroSeleccionadoCodigo = null;

function mostrarSugerenciasCentro(valor) {
    const container = document.getElementById('sugerencias-centro');
    if(!container) return;
    
    if(!valor || valor.length < 1) {
        container.style.display = 'none';
        return;
    }
    
    const busqueda = valor.toLowerCase();
    const coincidencias = centrosData.filter(c => 
        c.n.toLowerCase().includes(busqueda) || 
        c.c.toLowerCase().includes(busqueda)
    ).slice(0, 15);
    
    if(coincidencias.length === 0) {
        container.innerHTML = '<div style="padding:10px;color:#888;font-size:11px;text-align:center">No se encontraron centros</div>';
        container.style.display = 'block';
        return;
    }
    
    container.innerHTML = coincidencias.map(c => `
        <div onclick="seleccionarCentro('${c.c}', '${c.n.replace(/'/g, "\\'")}')" 
             style="padding:8px 12px;cursor:pointer;border-bottom:1px solid #eee;font-size:11px;transition:background 0.2s"
             onmouseover="this.style.background='#f5f5f5'" 
             onmouseout="this.style.background='#fff'">
            <div style="font-weight:600;color:#333">${c.n}</div>
            <div style="font-size:9px;color:#888">${c.c} • ${c.p || '-'}</div>
        </div>
    `).join('');
    container.style.display = 'block';
}

function seleccionarCentro(codigo, nombre) {
    document.getElementById('eval-centro-2').value = nombre;
    centroSeleccionadoCodigo = codigo;
    document.getElementById('sugerencias-centro').style.display = 'none';
}

// Cerrar sugerencias al hacer clic fuera
document.addEventListener('click', function(e) {
    const container = document.getElementById('sugerencias-centro');
    const input = document.getElementById('eval-centro-2');
    if(container && input && !container.contains(e.target) && e.target !== input) {
        container.style.display = 'none';
    }
});

// Iniciar evaluación desde Evaluación + Guía (usa IDs con -2)
function iniciarEvaluacion2() {
    const c = document.getElementById('eval-centro-2').value;
    const f = document.getElementById('eval-fecha-2').value;
    if(!c || !f) { alert('Complete Centro y Fecha'); return; }
    datosPortada = {
        centro: c, 
        fecha: f, 
        pcpnc: document.getElementById('eval-pcpnc-2').value, 
        responsable: document.getElementById('eval-responsable-2').value
    };
    // Cambiar a section-evaluacion y mostrar instrucciones
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-evaluacion').classList.add('active');
    document.getElementById('eval-portada').classList.remove('active');
    document.getElementById('eval-instrucciones').classList.add('active');
    document.getElementById('page-title').textContent = 'Evaluación';
}

// Buscar centro en evaluación 2 y rellenar PC/PNC
function buscarCentroEval2(texto) {
    if(!texto || texto.length < 2) return;
    
    const busqueda = texto.toUpperCase().trim();
    const centro = centrosData.find(c => 
        c.c === busqueda || 
        (c.n && c.n.toUpperCase().includes(busqueda)) ||
        busqueda.includes(c.n?.toUpperCase() || '')
    );
    
    if(centro && centro.pc) {
        const inputPCPNC = document.getElementById('eval-pcpnc-2');
        if(inputPCPNC) {
            inputPCPNC.value = centro.pc;
            inputPCPNC.style.color = centro.pc === 'PC' ? '#10b981' : (centro.pc === 'PNC' ? '#ef4444' : '#888');
        }
    }
}

function iniciarEvaluacion() {
    const c = document.getElementById('eval-centro').value;
    const f = document.getElementById('eval-fecha').value;
    if(!c || !f) { alert('Complete Centro y Fecha'); return; }
    datosPortada = {centro: c, fecha: f, pcpnc: document.getElementById('eval-pcpnc').value, responsable: document.getElementById('eval-responsable').value};
    document.getElementById('eval-portada').classList.remove('active');
    document.getElementById('eval-instrucciones').classList.add('active');
}

// Buscar centro en evaluación y rellenar PC/PNC automáticamente
function buscarCentroEval(texto) {
    const container = document.getElementById('eval-centro-resultados');
    if(!container) return;
    
    if(!texto || texto.length < 2) {
        container.style.display = 'none';
        return;
    }
    
    const busqueda = texto.toLowerCase();
    const resultados = centrosData.filter(c => 
        c.c.toLowerCase().includes(busqueda) || 
        c.n.toLowerCase().includes(busqueda)
    ).slice(0, 8);
    
    if(resultados.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.innerHTML = resultados.map(c => {
        const pcStatus = c.pc || '-';
        const colorPC = pcStatus === 'PC' ? '#10b981' : (pcStatus === 'PNC' ? '#ef4444' : '#888');
        return `<div onclick="seleccionarCentroEval('${c.c}','${c.n.replace(/'/g,"\\'")}','${pcStatus}')" style="padding:8px 10px;cursor:pointer;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;font-size:11px" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#fff'">
            <span><strong>${c.c}</strong> - ${c.n.substring(0,30)}</span>
            <span style="background:${colorPC};color:#fff;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:700">${pcStatus}</span>
        </div>`;
    }).join('');
    container.style.display = 'block';
}

function seleccionarCentroEval(cod, nombre, pcpnc) {
    document.getElementById('eval-centro').value = nombre;
    document.getElementById('eval-pcpnc').value = pcpnc;
    document.getElementById('eval-pcpnc').style.color = pcpnc === 'PC' ? '#10b981' : (pcpnc === 'PNC' ? '#ef4444' : '#888');
    document.getElementById('eval-centro-resultados').style.display = 'none';
}

function cerrarResultadosCentroEval() {
    const container = document.getElementById('eval-centro-resultados');
    if(container) container.style.display = 'none';
}

function volverPortadaEval() {
    document.getElementById('eval-instrucciones').classList.remove('active');
    // Volver a section-guia-eval con contenido-eval visible
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-guia-eval').classList.add('active');
    document.getElementById('contenido-eval').style.display = 'block';
    document.getElementById('page-title').textContent = 'Evaluación + Guía';
}

var nombreAudiologoEval = '';
var horasServicioEval = 0;

function comenzarPreguntasEvaluacion() {
    nombreAudiologoEval = document.getElementById('eval-nombre-audiologo').value.trim();
    horasServicioEval = parseInt(document.getElementById('eval-horas-servicio').value) || 0;
    
    if(!nombreAudiologoEval) {
        alert('Por favor, introduce el nombre del audiólogo');
        return;
    }
    if(horasServicioEval <= 0) {
        alert('Por favor, introduce las horas de servicio');
        return;
    }
    
    preguntaActual = 0; respuestas = {}; huboObligatoriaNo = false;
    
    // FIX 5: Pre-fill KPIs from cuadro de mando (funnelDataCache)
    try {
        var codigoCentroEval = centroEvaluacionActual ? centroEvaluacionActual.codigo : null;
        if(!codigoCentroEval && datosPortada.centro) {
            // Try to find code from center name
            var cd = centrosData.find(function(c) { return datosPortada.centro.toUpperCase().includes(c.n.toUpperCase()) || c.n.toUpperCase().includes(datosPortada.centro.toUpperCase()); });
            if(cd) codigoCentroEval = cd.c;
        }
        if(codigoCentroEval && typeof funnelDataCache !== 'undefined' && funnelDataCache[codigoCentroEval]) {
            var kpis = funnelDataCache[codigoCentroEval].kpis;
            if(kpis) {
                // Q95: MGM
                if(kpis.mgm !== undefined) respuestas[95] = kpis.mgm;
                // Q96: Renove
                if(kpis.renove !== undefined) respuestas[96] = kpis.renove;
                // Q97: Seguros (if available)
                if(kpis.seguros !== undefined) respuestas[97] = kpis.seguros;
                // Q99: % Conversión a Prueba
                if(kpis.conPerdida > 0 && kpis.prueban !== undefined) {
                    respuestas[99] = Math.round((kpis.prueban / kpis.conPerdida) * 100);
                }
                // Q100: % Conversión a Venta
                if(kpis.prueban > 0 && kpis.ventas !== undefined) {
                    respuestas[100] = Math.round((kpis.ventas / kpis.prueban) * 100);
                }
                console.log('[Eval] ✓ KPIs pre-rellenados desde cuadro de mando:', codigoCentroEval, kpis);
            }
        }
    } catch(e) { console.warn('[Eval] No se pudieron cargar KPIs:', e); }
    
    document.getElementById('eval-instrucciones').classList.remove('active');
    document.getElementById('eval-dinamica').classList.add('active');
    document.getElementById('q-total').textContent = preguntas.length;
    mostrarPregunta();
}

function mostrarPregunta() {
    const p = preguntas[preguntaActual];
    const b = bloques.find(x => x.id === p.bloque);
    const ob = obligatorias.includes(p.id);
    document.getElementById('q-current').textContent = preguntaActual + 1;
    document.getElementById('q-number').textContent = p.id;
    document.getElementById('q-text').textContent = p.criterio;
    document.getElementById('q-valor').textContent = p.valor;
    document.getElementById('q-detalle').textContent = p.detalle;
    document.getElementById('obligatoria-badge').classList.toggle('show', ob);
    document.getElementById('bloque-badge').textContent = b.nombre;
    document.getElementById('bloque-badge').style.background = b.gradient;
    document.getElementById('bloque-peso').textContent = b.peso + '%';
    document.getElementById('progress-fill').style.width = ((preguntaActual + 1) / preguntas.length * 100) + '%';
    document.getElementById('progress-fill').style.background = b.gradient;
    
    // Hide all button panels first
    document.getElementById('btns-binario').classList.add('hidden');
    document.getElementById('btns-numerico').classList.add('hidden');
    var dualBox = document.getElementById('agenda-dual-box');
    var autoBox = document.getElementById('agenda-auto-box');
    var agBox = document.getElementById('agenda-box');
    if(dualBox) { dualBox.style.display = 'none'; dualBox.classList.remove('show'); }
    if(autoBox) { autoBox.style.display = 'none'; autoBox.classList.remove('show'); }
    if(agBox) agBox.classList.remove('show');
    var hintEl = document.getElementById('q91-hint');
    if(hintEl) hintEl.style.display = 'none';
    var confirmBox = document.getElementById('agenda-confirm-box');
    if(confirmBox) confirmBox.style.display = 'none';
    
    if(p.tipo === 'agenda_dual') {
        // Q90: Two inputs for primeras visitas and revisiones
        if(!dualBox) {
            dualBox = document.createElement('div');
            dualBox.id = 'agenda-dual-box';
            dualBox.style.cssText = 'margin:15px 0;padding:20px;background:#f8fafc;border:2px solid #d4af37;border-radius:12px;text-align:center;display:none';
            dualBox.innerHTML = '<div style="display:flex;gap:20px;justify-content:center;align-items:center;flex-wrap:wrap">' +
                '<div style="text-align:center"><label style="font-size:11px;font-weight:700;color:#1e40af;display:block;margin-bottom:6px">📋 Primeras Visitas</label>' +
                '<input type="number" id="input-pv" min="0" style="width:100px;padding:14px;font-size:22px;text-align:center;border:2px solid #3b82f6;border-radius:10px;background:#eff6ff;font-weight:700;color:#1e40af" placeholder="0"></div>' +
                '<div style="font-size:24px;color:#6b7280;padding-top:20px">+</div>' +
                '<div style="text-align:center"><label style="font-size:11px;font-weight:700;color:#7c3aed;display:block;margin-bottom:6px">🔄 Revisiones Postventa</label>' +
                '<input type="number" id="input-rev" min="0" style="width:100px;padding:14px;font-size:22px;text-align:center;border:2px solid #7c3aed;border-radius:10px;background:#f5f3ff;font-weight:700;color:#7c3aed" placeholder="0"></div></div>' +
                '<button onclick="responderDual()" style="margin-top:15px;padding:12px 40px;background:linear-gradient(135deg,#d4af37,#b8963d);color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer">✓ Confirmar</button>';
            document.getElementById('btns-numerico').parentNode.insertBefore(dualBox, document.getElementById('btns-numerico'));
        }
        dualBox.style.display = 'block';
        dualBox.classList.add('show');
        var pvInput = document.getElementById('input-pv');
        var revInput = document.getElementById('input-rev');
        pvInput.value = respuestas['90_pv'] || '';
        revInput.value = respuestas['90_rev'] || '';
        setTimeout(function(){ pvInput.focus(); }, 100);
        
    } else if(p.tipo === 'binario') {
        document.getElementById('btns-binario').classList.remove('hidden');
    } else if(p.tipo === 'agenda_confirm') {
        // Q91: Mostrar cálculo automático y botones Sí/No
        var v1 = respuestas['90_pv'] || 0, rev = respuestas['90_rev'] || 0, total = v1 + rev;
        var pct1 = total > 0 ? Math.round((v1/total)*100) : 0;
        var pctRev = total > 0 ? Math.round((rev/total)*100) : 0;
        var cumple = pct1 >= 75;
        
        // Crear o actualizar el box de confirmación
        var confirmBox = document.getElementById('agenda-confirm-box');
        if(!confirmBox) {
            confirmBox = document.createElement('div');
            confirmBox.id = 'agenda-confirm-box';
            confirmBox.style.cssText = 'margin:15px auto;max-width:400px;text-align:center';
            document.getElementById('btns-numerico').parentNode.insertBefore(confirmBox, document.getElementById('btns-numerico'));
        }
        
        confirmBox.innerHTML = '<div style="background:linear-gradient(135deg,#f8fafc,#e2e8f0);border:2px solid ' + (cumple ? '#16a34a' : '#dc2626') + ';border-radius:16px;padding:20px;margin-bottom:15px">' +
            '<div style="font-size:12px;color:#64748b;margin-bottom:12px;font-weight:600">📊 CÁLCULO AUTOMÁTICO</div>' +
            '<div style="display:flex;justify-content:center;gap:20px;margin-bottom:15px">' +
                '<div style="background:#fff;padding:15px 25px;border-radius:12px;border:2px solid #3b82f6;box-shadow:0 2px 8px rgba(59,130,246,0.15)">' +
                    '<div style="font-size:11px;color:#3b82f6;font-weight:700">📋 Primeras Visitas</div>' +
                    '<div style="font-size:32px;font-weight:800;color:#1e40af">' + pct1 + '%</div>' +
                    '<div style="font-size:10px;color:#64748b">(' + v1 + ' citas)</div>' +
                '</div>' +
                '<div style="background:#fff;padding:15px 25px;border-radius:12px;border:2px solid #8b5cf6;box-shadow:0 2px 8px rgba(139,92,246,0.15)">' +
                    '<div style="font-size:11px;color:#8b5cf6;font-weight:700">🔄 Revisiones</div>' +
                    '<div style="font-size:32px;font-weight:800;color:#6d28d9">' + pctRev + '%</div>' +
                    '<div style="font-size:10px;color:#64748b">(' + rev + ' citas)</div>' +
                '</div>' +
            '</div>' +
            '<div style="background:' + (cumple ? '#dcfce7' : '#fef2f2') + ';padding:10px 15px;border-radius:8px;margin-bottom:5px">' +
                '<span style="font-size:13px;font-weight:700;color:' + (cumple ? '#16a34a' : '#dc2626') + '">' + 
                (cumple ? '✅ CUMPLE objetivo ≥75% primeras visitas' : '⚠️ NO CUMPLE objetivo ≥75% primeras visitas') + '</span>' +
            '</div>' +
        '</div>' +
        '<div style="font-size:13px;font-weight:600;color:#374151;margin-bottom:12px">¿Son correctos estos datos?</div>' +
        '<div style="display:flex;gap:12px;justify-content:center">' +
            '<button type="button" onclick="responderAgendaConfirm(\'no\')" style="padding:14px 40px;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;background:#fff;border:2px solid #dc2626;color:#dc2626;transition:all 0.15s">✗ NO</button>' +
            '<button type="button" onclick="responderAgendaConfirm(\'si\')" style="padding:14px 40px;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;background:#16a34a;border:none;color:#fff;transition:all 0.15s">✓ SÍ</button>' +
        '</div>';
        confirmBox.style.display = 'block';
        
        // Guardar el valor calculado para uso posterior
        respuestas[91] = pct1;
        
    } else {
        document.getElementById('btns-numerico').classList.remove('hidden');
        var numInput = document.getElementById('input-num');
        // Q91: show calculated % as hint, prefill input
        if(p.id === 91) {
            var v1 = respuestas['90_pv'] || 0, rev = respuestas['90_rev'] || 0, total = v1 + rev;
            var pct1 = total > 0 ? Math.round((v1/total)*100) : 0;
            var hintEl = document.getElementById('q91-hint');
            if(!hintEl) {
                hintEl = document.createElement('div');
                hintEl.id = 'q91-hint';
                hintEl.style.cssText = 'margin:0 auto 10px;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:700;text-align:center;max-width:260px';
                document.getElementById('input-num').parentNode.insertBefore(hintEl, document.getElementById('input-num'));
            }
            hintEl.textContent = '📊 Cálculo: ' + pct1 + '% primeras visitas';
            hintEl.style.background = pct1 >= 75 ? '#dcfce7' : '#fef2f2';
            hintEl.style.color = pct1 >= 75 ? '#16a34a' : '#dc2626';
            hintEl.style.display = 'block';
            numInput.value = pct1;
        } else {
            var hintEl = document.getElementById('q91-hint');
            if(hintEl) hintEl.style.display = 'none';
            var prefilledVal = respuestas[p.id];
            numInput.value = (prefilledVal !== undefined && prefilledVal !== null) ? prefilledVal : '';
        }
        // Reset input styling and focus
        numInput.style.border = '2px solid #E0E0E0';
        numInput.style.background = '';
        numInput.placeholder = '0';
        setTimeout(function(){ numInput.focus(); numInput.select(); }, 150);
    }
}

function responder(v) {
    const p = preguntas[preguntaActual];
    respuestas[p.id] = v;
    if(obligatorias.includes(p.id) && v === 'no') huboObligatoriaNo = true;
    siguiente();
}

function responderNum() {
    var input = document.getElementById('input-num');
    if(!input) return;
    var valor = input.value.trim();
    
    // Validar: vacío no se acepta, pero 0 SÍ es válido
    if(valor === '') {
        input.style.border = '2px solid #dc2626';
        input.style.background = '#fef2f2';
        input.placeholder = '¡Introduce un valor!';
        input.focus();
        setTimeout(function() {
            input.style.border = '2px solid #E0E0E0';
            input.style.background = '';
            input.placeholder = '0';
        }, 2000);
        return;
    }
    
    var numVal = parseFloat(valor);
    if(isNaN(numVal)) numVal = 0;
    
    var p = preguntas[preguntaActual];
    if(!p) return;
    
    respuestas[p.id] = numVal;
    
    // Limpiar input antes de avanzar para evitar conflictos
    input.value = '';
    input.blur();
    
    siguiente();
}

// Responder confirmación de agenda (Q91) - RÁPIDO
var _agendaConfirmLock = false;
function responderAgendaConfirm(v) {
    if(_agendaConfirmLock) return;
    _agendaConfirmLock = true;
    setTimeout(function(){ _agendaConfirmLock = false; }, 250);
    
    var p = preguntas[preguntaActual];
    if(!p || p.tipo !== 'agenda_confirm') return;
    
    // Si confirma SÍ, el valor ya está guardado (el % calculado)
    // Si dice NO, ponemos 0 para indicar que no cumple
    if(v === 'no') {
        respuestas[p.id] = 0;
    }
    // El valor calculado ya está en respuestas[91] desde mostrarPregunta
    
    siguiente();
}

function responderDual() {
    var pvInput = document.getElementById('input-pv');
    var revInput = document.getElementById('input-rev');
    var pv = pvInput ? pvInput.value : '';
    var rev = revInput ? revInput.value : '';
    if(pv === '' && rev === '') {
        pvInput.style.border = '2px solid #dc2626';
        revInput.style.border = '2px solid #dc2626';
        setTimeout(function(){ pvInput.style.border = '2px solid #3b82f6'; revInput.style.border = '2px solid #7c3aed'; }, 2000);
        pvInput.focus();
        return;
    }
    respuestas['90_pv'] = parseFloat(pv) || 0;
    respuestas['90_rev'] = parseFloat(rev) || 0;
    respuestas[90] = respuestas['90_rev'];
    siguiente();
}

function anterior() { if(preguntaActual > 0) { preguntaActual--; mostrarPregunta(); } }
var _siguienteLock = false;
function siguiente() { 
    if(_siguienteLock) return;
    _siguienteLock = true;
    setTimeout(function(){ _siguienteLock = false; }, 200);
    
    if(preguntaActual < preguntas.length - 1) { 
        preguntaActual++; 
        mostrarPregunta(); 
    } else { 
        finalizarEval(); 
    } 
}
function cancelar() { if(confirm('¿Cancelar evaluación?')) resetEval(); }

var _evalKeyDebounce = false;
document.addEventListener('keydown', function(e) {
    if(!document.getElementById('eval-dinamica').classList.contains('active')) return;
    if(_evalKeyDebounce) return;
    
    var p = preguntas[preguntaActual];
    if(!p) return;
    
    if(e.key === 'Enter') {
        e.preventDefault();
        e.stopPropagation();
        _evalKeyDebounce = true;
        setTimeout(function(){ _evalKeyDebounce = false; }, 300);
        
        if(p.tipo === 'binario') { responder('si'); }
        else if(p.tipo === 'agenda_dual') { responderDual(); }
        else if(p.tipo === 'agenda_confirm') { responderAgendaConfirm('si'); }
        else { responderNum(); }
    } else if(p.tipo === 'binario' || p.tipo === 'agenda_confirm') {
        var fn = p.tipo === 'binario' ? responder : responderAgendaConfirm;
        if(e.key === 's' || e.key === 'S' || e.key === '1') { _evalKeyDebounce = true; setTimeout(function(){ _evalKeyDebounce = false; }, 300); fn('si'); }
        else if(e.key === 'n' || e.key === 'N' || e.key === '0') { _evalKeyDebounce = true; setTimeout(function(){ _evalKeyDebounce = false; }, 300); fn('no'); }
    }
    if(e.key === 'Backspace' && document.activeElement.tagName !== 'INPUT') { e.preventDefault(); anterior(); }
});

function calcularResultados() {
    if(huboObligatoriaNo) {
        const r = {}; bloques.forEach(b => { r[b.id] = {nombre:b.largo,peso:b.peso,gradient:b.gradient,porcentaje:0,puntos:0,maximo:0,aplicacion:'0.0'}; });
        return {porBloque:r, resultadoFinal:0};
    }
    const res = {}; let totalPonderado = 0;
    bloques.forEach(b => {
        const pB = preguntas.filter(p => p.bloque === b.id);
        let puntosPosibles = 0, puntosObtenidos = 0;
        pB.forEach(p => {
            puntosPosibles += p.valor;
            if(p.tipo === 'binario') { if(respuestas[p.id] === 'si') puntosObtenidos += p.valor; }
            else if(p.tipo === 'agenda_dual') { /* Q90: valor=0, informational only */ }
            else if(p.tipo === 'agenda_confirm') { 
                // Q91: Solo da puntos si el % de primeras visitas >= 75 Y el usuario confirmó
                if(respuestas[p.id] >= 75) puntosObtenidos += p.valor; 
            }
            else { if(respuestas[p.id] > 0) puntosObtenidos += p.valor; }
        });
        const porcentajeBloque = puntosPosibles > 0 ? (puntosObtenidos/puntosPosibles)*100 : 0;
        const aplicacionBloque = b.peso > 0 ? (porcentajeBloque/100)*b.peso : 0;
        totalPonderado += aplicacionBloque;
        res[b.id] = {nombre:b.largo,peso:b.peso,gradient:b.gradient,porcentaje:Math.round(porcentajeBloque),puntos:puntosObtenidos,maximo:puntosPosibles,aplicacion:aplicacionBloque.toFixed(1)};
    });
    return {porBloque:res, resultadoFinal:Math.round(totalPonderado)};
}

function getCategoria(p) {
    if(p >= 95) return {nombre:'MAESTRO',emoji:'🏆',color:'#C9A227',bg:'linear-gradient(135deg,rgba(201,162,39,0.2),rgba(201,162,39,0.1))',mensaje:'EXCELENTE, ENHORABUENA'};
    if(p >= 90) return {nombre:'ELITE',emoji:'🥇',color:'#8b8b8b',bg:'linear-gradient(135deg,rgba(168,85,247,0.2),rgba(168,85,247,0.1))',mensaje:'Estás a punto de brillar'};
    if(p >= 80) return {nombre:'PRO',emoji:'🥈',color:'#C9A227',bg:'linear-gradient(135deg,rgba(34,197,94,0.2),rgba(34,197,94,0.1))',mensaje:'Estás en el buen camino'};
    if(p === 0) return {nombre:'NO EVALÚA',emoji:'🚫',color:'#dc2626',bg:'linear-gradient(135deg,rgba(239,68,68,0.2),rgba(239,68,68,0.1))',mensaje:'No cumple criterio obligatorio'};
    return {nombre:'MEJORABLE',emoji:'🛠️',color:'#e67e22',bg:'linear-gradient(135deg,rgba(230,126,34,0.2),rgba(230,126,34,0.1))',mensaje:'Estás en el camino, ¡puedes conseguirlo!'};
}

function finalizarEval() {
    try {
        const res = calcularResultados();
        // Incluir datos del centro si existen
        const preinforme = {
            id: Date.now(),
            centro: datosPortada.centro,
            fecha: datosPortada.fecha,
            audiologo: datosPortada.audiologo,
            responsable: datosPortada.responsable,
            resultado: res.resultadoFinal,
            respuestas: {...respuestas},
            huboObligatoriaNo,
            horasServicio: horasServicioEval,
            nombreAudiologo: nombreAudiologoEval,
            // Datos adicionales del centro
            codigoCentro: centroEvaluacionActual ? centroEvaluacionActual.codigo : null,
            propietario: centroEvaluacionActual ? centroEvaluacionActual.propietario : '',
            delegadoRegional: centroEvaluacionActual ? centroEvaluacionActual.delegado : '',
            pcpnc: datosPortada.pcpnc || (centroEvaluacionActual ? (centrosData.find(function(c){return c.c===centroEvaluacionActual.codigo})||{}).pc : '') || '',
            delegadoAudio: datosPortada.responsable || 'Ariannys Rojas',
            aar: centroEvaluacionActual ? centroEvaluacionActual.aar : 'NO',
            tipoCentro: centroEvaluacionActual ? centroEvaluacionActual.tipo : 'CORNER',
            estado: 'borrador'
        };
        preinformes.unshift(preinforme);
        
        // Guardar en localStorage + Firebase directo
        guardarPreinformesEnStorage();
        
        // También guardar en colección 'evaluaciones' como respaldo independiente
        try {
            var evaluaciones = JSON.parse(localStorage.getItem('evaluaciones') || '[]');
            evaluaciones.unshift(preinforme);
            if(evaluaciones.length > 50) evaluaciones = evaluaciones.slice(0, 50);
            localStorage.setItem('evaluaciones', JSON.stringify(evaluaciones));
            sincronizarConFirebaseDirecto('evaluaciones', JSON.stringify(evaluaciones));
        } catch(ee) { console.warn('[Eval] Error guardando evaluaciones:', ee); }
        
        // Forzar sincronización explícita
        sincronizarConFirebaseDirecto('preinformes', JSON.stringify(preinformes));
        
        console.log('[Eval] ✅ Evaluación finalizada y guardada. Centro:', preinforme.centro, 'Resultado:', preinforme.resultado + '%');
        
        // Marcar la visita agendada como finalizada (sale de pendientes)
        var codigoVisita = preinforme.codigoCentro || (centroEvaluacionActual ? centroEvaluacionActual.codigo : null);
        if(codigoVisita) {
            var idxVisita = visitasAgendadas.findIndex(function(v) { return v.codigo === codigoVisita && !v.finalizado; });
            if(idxVisita >= 0) {
                visitasAgendadas[idxVisita].finalizado = true;
                visitasAgendadas[idxVisita].fechaFinalizacion = new Date().toISOString();
                visitasAgendadas[idxVisita].estado = 'evaluado';
                localStorage.setItem('visitasAgendadas', JSON.stringify(visitasAgendadas));
                sincronizarConFirebaseDirecto('visitasAgendadas', JSON.stringify(visitasAgendadas));
                console.log('[Eval] ✅ Visita marcada como finalizada:', codigoVisita);
            }
        }
        
        mostrarInforme();
    } catch(e) {
        console.error('Error en finalizarEval:', e);
        alert('Error: ' + e.message);
    }
}

function mostrarInforme() {
    document.getElementById('eval-dinamica').classList.remove('active');
    document.getElementById('eval-instrucciones').classList.remove('active');
    document.getElementById('eval-informe').classList.add('active');
    const res = calcularResultados(), cat = getCategoria(res.resultadoFinal);
    document.getElementById('inf-titulo').textContent = datosPortada.centro;
    document.getElementById('inf-meta').textContent = datosPortada.fecha + ' • ' + (datosPortada.audiologo || '-') + ' • ' + datosPortada.responsable;
    
    // Actualizar badges de TIPO y PC/PNC
    const centroInforme = centrosData.find(c => datosPortada.centro && (datosPortada.centro.toUpperCase().includes(c.n.toUpperCase()) || c.n.toUpperCase().includes(datosPortada.centro.toUpperCase()) || datosPortada.centro.includes(c.c)));
    const tipoBadge = document.getElementById('inf-tipo-badge');
    const pcBadge = document.getElementById('inf-pc-badge');
    if (tipoBadge && centroInforme) {
        const esSucursal = centroInforme.pr === 'SUCURSAL';
        tipoBadge.textContent = esSucursal ? 'SUCURSAL' : 'FRANQUICIA';
        tipoBadge.style.background = esSucursal ? '#3b82f6' : '#C9A227';
        tipoBadge.style.color = esSucursal ? '#fff' : '#1a1a1a';
    }
    if (pcBadge && centroInforme) {
        const esPC = centroInforme.pc === 'PC';
        pcBadge.textContent = esPC ? 'PC' : 'PNC';
        pcBadge.style.background = esPC ? '#C9A227' : '#8B7355';
    }
    
    document.getElementById('res-valor').textContent = res.resultadoFinal + '%';
    document.getElementById('res-valor').style.color = cat.color;
    document.getElementById('res-emoji').textContent = cat.emoji;
    document.getElementById('res-cat').textContent = cat.nombre;
    document.getElementById('res-cat').style.background = cat.bg;
    document.getElementById('res-cat').style.color = cat.color;
    document.getElementById('res-msg').textContent = cat.mensaje;
    
    // Mensaje personalizado
    var nombreCompleto = nombreAudiologoEval || datosPortada.audiologo || 'Audiólogo';
    var nombreCorto = nombreCompleto.split(' ')[0];
    document.getElementById('msg-nombre').textContent = nombreCorto;
    
    // Fortalezas y áreas de mejora
    var fortalezas = [], mejoras = [];
    bloques.forEach(function(b) {
        var r = res.porBloque[b.id];
        if(r.porcentaje >= 80) {
            fortalezas.push(b.nombre);
        } else if(r.porcentaje < 80 && r.peso > 0) {
            mejoras.push({nombre: b.nombre, pct: r.porcentaje});
        }
    });
    
    var msgFortalezas = document.getElementById('msg-fortalezas');
    if(fortalezas.length > 0) {
        msgFortalezas.innerHTML = '<span style="font-size:10px;font-weight:600;color:#16a34a">✅ FORTALEZAS (≥80%):</span> <span style="font-size:11px;color:#333">' + fortalezas.join(', ') + '</span>';
    } else {
        msgFortalezas.innerHTML = '<span style="font-size:10px;font-weight:600;color:#16a34a">✅ FORTALEZAS:</span> <span style="font-size:11px;color:#888">Ninguna alcanzada aún</span>';
    }
    
    var msgMejoras = document.getElementById('msg-mejoras');
    if(mejoras.length > 0) {
        var mejorasHtml = '<span style="font-size:10px;font-weight:600;color:#dc2626">⚠️ ÁREAS DE MEJORA:</span> ';
        mejoras.forEach(function(m) {
            mejorasHtml += '<span style="display:inline-block;background:#f3f4f6;padding:2px 6px;border-radius:4px;margin:1px;font-size:9px;color:#666">' + m.nombre + ' (' + m.pct + '%)</span>';
        });
        msgMejoras.innerHTML = mejorasHtml;
    } else {
        msgMejoras.innerHTML = '<span style="font-size:10px;font-weight:600;color:#16a34a">✅ Sin áreas de mejora - ¡Excelente!</span>';
    }
    
    var msgHoras = document.getElementById('msg-horas');
    if(horasServicioEval > 0) {
        var cumpleHoras = horasServicioEval >= 20;
        msgHoras.innerHTML = '⏱️ Horas: <strong>' + horasServicioEval + 'h</strong> ' + 
            (cumpleHoras ? '<span style="color:#16a34a">✅ Cumple presencia</span>' : '<span style="color:#dc2626">❌ No cumple (<20h)</span>');
    } else {
        msgHoras.innerHTML = '⏱️ Horas: <span style="color:#888">No registradas</span>';
    }
    
    // Datos Agenda
    const v1 = respuestas['90_pv'] || 0, rev = respuestas['90_rev'] || respuestas[90] || 0, total = v1 + rev;
    const pct1v = total > 0 ? Math.round((v1/total)*100) : 0;
    document.getElementById('inf-1visitas').textContent = v1;
    document.getElementById('inf-revisiones').textContent = rev;
    document.getElementById('inf-pct1v').textContent = pct1v + '%';
    document.getElementById('inf-pct1v').style.color = pct1v >= 75 ? '#16a34a' : '#dc2626';
    document.getElementById('inf-noasist').textContent = respuestas[92] || 0;
    document.getElementById('inf-reagend').textContent = respuestas[93] || 0;
    
    // Datos Conversiones
    document.getElementById('inf-vayuda').textContent = respuestas[94] || 0;
    document.getElementById('inf-vmgm').textContent = respuestas[95] || 0;
    document.getElementById('inf-vrenove').textContent = respuestas[96] || 0;
    document.getElementById('inf-vseguros').textContent = respuestas[97] || 0;
    document.getElementById('inf-screen').textContent = (respuestas[98] || 0) + '%';
    document.getElementById('inf-cprueba').textContent = (respuestas[99] || 0) + '%';
    document.getElementById('inf-cventa').textContent = (respuestas[100] || 0) + '%';
    
    // Tabla
    let tb = '';
    bloques.forEach(b => {
        const r = res.porBloque[b.id];
        tb += '<tr><td><strong>' + b.nombre + '</strong></td><td>' + r.peso + '%</td><td>' + r.puntos + '</td><td>' + r.maximo + '</td><td style="color:' + (r.porcentaje >= 80 ? '#16a34a' : '#dc2626') + '"><strong>' + r.porcentaje + '%</strong></td><td>' + r.aplicacion + '%</td></tr>';
    });
    tb += '<tr style="background:#2d2d2d;color:#fff"><td colspan="4"><strong>TOTAL</strong></td><td colspan="2"><strong>' + res.resultadoFinal + '%</strong></td></tr>';
    document.getElementById('tabla-body').innerHTML = tb;
    
    // Checklist
    let ck = '';
    bloques.forEach(b => {
        const pB = preguntas.filter(p => p.bloque === b.id), r = res.porBloque[b.id];
        ck += '<div class="checklist-bloque"><div class="checklist-header" style="background:' + b.gradient + ';">' + b.largo + ' (' + b.peso + '%)<span>' + r.porcentaje + '%</span></div>';
        pB.forEach(p => {
            const resp = respuestas[p.id], ob = obligatorias.includes(p.id);
            var badgeClass, badgeText;
            if(p.tipo === 'agenda_dual') {
                var pvVal = respuestas['90_pv'] || 0, revVal = respuestas['90_rev'] || resp || 0;
                badgeClass = 'num'; badgeText = pvVal + '/' + revVal;
            } else if(p.tipo === 'binario') {
                var si = resp === 'si';
                badgeClass = si ? 'si' : 'no'; badgeText = si ? '✓' : '✗';
            } else if(p.tipo === 'agenda_confirm') {
                // Q91: mostrar % y si cumple (>=75)
                var cumple = resp >= 75;
                badgeClass = cumple ? 'si' : 'no'; 
                badgeText = cumple ? (resp + '% ✓') : (resp + '% ✗');
            } else {
                badgeClass = 'num'; badgeText = resp || 0;
            }
            ck += '<div class="checklist-item"><span class="check-badge ' + badgeClass + '">' + badgeText + '</span><span style="flex:1;line-height:1.3">' + p.id + '. ' + p.criterio + '</span>' + (ob ? '<span class="check-ob">OBLIGATORIA</span>' : '') + '</div>';
        });
        ck += '</div>';
    });
    document.getElementById('checklist-content').innerHTML = ck;
    
    // AUTO-RELLENAR desde funnelDataCache: gamas, tipo atención, datos funnel
    try {
        var codigoEval = null;
        if(centroEvaluacionActual && centroEvaluacionActual.c) {
            codigoEval = centroEvaluacionActual.c;
        } else if(datosPortada && datosPortada.centro) {
            var cFind = centrosData.find(function(c) { return c.n === datosPortada.centro || c.c === datosPortada.centro; });
            if(cFind) codigoEval = cFind.c;
        }
        
        if(codigoEval && typeof funnelDataCache !== 'undefined' && funnelDataCache[codigoEval]) {
            var fd = funnelDataCache[codigoEval];
            var kp = fd.kpis || {};
            console.log('[Informe] ✓ Auto-rellenando desde funnelDataCache:', codigoEval, kp);
            
            // DATOS FUNNEL DEL CENTRO (ventas, capacitación, devoluciones)
            var elVentas = document.getElementById('inf-funnel-ventas');
            var elCapac = document.getElementById('inf-funnel-capacitacion');
            var elDevol = document.getElementById('inf-funnel-devoluciones');
            if(elVentas && (!elVentas.value || elVentas.value == '0')) elVentas.value = kp.ventas || 0;
            if(elCapac && (!elCapac.value || elCapac.value == '0')) elCapac.value = kp.prueban || 0;
            if(elDevol && (!elDevol.value || elDevol.value == '0')) elDevol.value = kp.devoluciones || 0;
            
            // Cargar gamas automáticamente en el cuadro de mandos audio
            if(datosPortada && datosPortada.centro) {
                setTimeout(function() { cargarGamasAutomatico(codigoEval); }, 500);
            }
        } else if(datosPortada && datosPortada.centro) {
            // Fallback: intentar cargarGamasAutomatico con el nombre
            setTimeout(function() { cargarGamasAutomatico(datosPortada.centro); }, 500);
        }
    } catch(e) { console.warn('[Informe] Error auto-rellenando funnel:', e); }
    
    renderPreinformes();
}

function nuevaEval() {
    document.getElementById('eval-informe').classList.remove('active');
    document.getElementById('eval-instrucciones').classList.remove('active');
    document.getElementById('eval-dinamica').classList.remove('active');
    document.getElementById('eval-portada').classList.add('active');
    document.getElementById('eval-centro').value = '';
    document.getElementById('eval-pcpnc').value = '';
    document.getElementById('eval-fecha').valueAsDate = new Date();
    document.getElementById('eval-responsable').selectedIndex = 0;
    document.getElementById('eval-nombre-audiologo').value = '';
    document.getElementById('eval-horas-servicio').value = '';
    nombreAudiologoEval = '';
    horasServicioEval = 0;
    respuestas = {};
    currentQuestion = 0;
    huboObligatoriaNo = false;
    centroEvaluacionActual = null;
    renderPreinformes();
}

function limpiarYNuevaEval() {
    nuevaEval();
    const msg = document.createElement('div');
    msg.innerHTML = '🗑️ EVALUACIÓN LIMPIADA';
    msg.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#5c5c5c;color:#fff;padding:12px 24px;border-radius:8px;font-weight:700;font-size:14px;z-index:99999;box-shadow:0 4px 15px rgba(0,0,0,0.3)';
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 2000);
}

function guardarPreinformeActual() {
    var guardado = guardarPreinformesEnStorage();
    // Forzar push directo a Firebase
    sincronizarConFirebaseDirecto('preinformes', JSON.stringify(preinformes));
    
    var msg = document.createElement('div');
    msg.innerHTML = '✅ PREINFORME GUARDADO';
    msg.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#C9A227;color:#fff;padding:12px 24px;border-radius:8px;font-weight:700;font-size:14px;z-index:99999;box-shadow:0 4px 15px rgba(0,0,0,0.3)';
    document.body.appendChild(msg);
    setTimeout(function() { msg.remove(); }, 2000);
}

// Variables para gestión de informes
let preinformeActualIndex = -1;
let informeActualIndex = -1; // Índice del informe borrador que se está editando
let informesBorrador = JSON.parse(localStorage.getItem('informesBorrador') || '[]');
let informesFinalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');

// Guardar textos del informe actual
// Actualizar estilo visual de checkboxes electromedicina
function actualizarEstiloElectromedicina() {
    ['electro-audiometro','electro-rem','electro-campolibre','electro-timpano','electro-video','electro-hit'].forEach(function(id) {
        var cb = document.getElementById(id);
        if(cb && cb.parentElement) {
            var label = cb.parentElement;
            if(cb.checked) {
                label.style.borderColor = '#C9A227';
                label.style.background = '#fef9e7';
            } else {
                label.style.borderColor = '#ddd';
                label.style.background = '#fff';
            }
        }
    });
}

function obtenerDatosInforme() {
    // Obtener 11 básicos
    var basicos = [];
    for (var i = 1; i <= 11; i++) {
        var cb = document.getElementById('basico-' + i);
        basicos.push(cb && cb.checked ? 1 : 0);
    }
    
    // Obtener imágenes de galería
    var imagenes = [];
    for (var i = 1; i <= 6; i++) {
        var img = document.getElementById('img-preview-' + i);
        var imgSrc = null;
        if (img && img.src && img.style.display !== 'none' && img.src !== '' && img.src !== window.location.href) {
            if(img.src.startsWith('data:image') || img.src.startsWith('http')) {
                imgSrc = img.src;
                // Seguridad: si la imagen es demasiado grande (>200KB), marcar para recomprimir
                if(imgSrc.length > 200000) {
                    console.warn('[Informe] ⚠️ Imagen ' + i + ' grande (' + Math.round(imgSrc.length/1024) + 'KB), se recomprimirá al guardar');
                }
                console.log('[Informe] Imagen ' + i + ' capturada (' + Math.round(imgSrc.length/1024) + ' KB)');
            }
        }
        imagenes.push(imgSrc);
    }
    console.log('[Informe] Total imágenes capturadas:', imagenes.filter(x => x !== null).length);
    
    // Calcular bloques porcentajes si hay respuestas
    var bloquesPct = null;
    var areasMejora = [];
    var respuestasActuales = (preinformeActual && preinformeActual.respuestas) ? preinformeActual.respuestas : 
        (informeActualIndex >= 0 && informesBorrador[informeActualIndex] && informesBorrador[informeActualIndex].respuestas) ? informesBorrador[informeActualIndex].respuestas : null;
    if (respuestasActuales) {
        bloquesPct = calcularBloquesPct(respuestasActuales);
        // Áreas de mejora: cada pregunta con NO, agrupada por bloque
        bloques.forEach(function(b) {
            var pct = bloquesPct[b.id] || 0;
            if (pct < 80 && b.peso > 0) {
                // Recoger todas las preguntas NO de este bloque
                var preguntasNO = [];
                preguntas.filter(function(p) { return p.bloque === b.id; }).forEach(function(p) {
                    if(p.tipo === 'binario' && respuestasActuales[p.id] === 'no') {
                        preguntasNO.push({id: p.id, criterio: p.criterio, detalle: p.detalle || '', obligatoria: p.obligatoria || false});
                    }
                });
                areasMejora.push({nombre: b.nombre, porcentaje: pct, preguntasNO: preguntasNO});
            }
        });
    }
    
    // También recoger TODAS las preguntas NO globales para referencia directa
    var todasPreguntasNO = [];
    if(respuestasActuales) {
        preguntas.forEach(function(p) {
            if(p.tipo === 'binario' && respuestasActuales[p.id] === 'no') {
                todasPreguntasNO.push({id: p.id, bloque: p.bloque, criterio: p.criterio, detalle: p.detalle || '', obligatoria: p.obligatoria || false});
            }
        });
    }
    
    // Obtener conversiones
    var conversiones = {
        mgm: document.getElementById('conv-mgm-val')?.value || '0',
        renove: document.getElementById('conv-renove-val')?.value || '0',
        seguro: document.getElementById('conv-seguro-val')?.value || '0',
        ayudas: document.getElementById('conv-ayudas-val')?.value || '0',
        derivaciones: document.getElementById('conv-deriv-val')?.textContent || '0',
        pctPrueba: document.getElementById('conv-pct-prueba')?.value || '0',
        pctVenta: document.getElementById('conv-pct-venta')?.value || '0',
        pctScreen: document.getElementById('conv-pct-screen')?.value || '0',
        imagen: document.getElementById('conv-imagen-val')?.value || '0'
    };
    
    // Pentágono global
    var pentagonoGlobal = document.getElementById('pent-global')?.textContent || '0%';
    
    // Gamas vendidas
    var gamas = {
        diamantePlus: parseInt(document.getElementById('gama-diamante-plus')?.value) || 0,
        diamante: parseInt(document.getElementById('gama-diamante')?.value) || 0,
        platinoPlus: parseInt(document.getElementById('gama-platino-plus')?.value) || 0,
        platino: parseInt(document.getElementById('gama-platino')?.value) || 0,
        oro: parseInt(document.getElementById('gama-oro')?.value) || 0
    };
    
    // Tipo de atención
    var tipoAtencion = {
        adulto: parseInt(document.getElementById('tipoaten-adulto')?.value) || 0,
        tinnitus: parseInt(document.getElementById('tipoaten-tinnitus')?.value) || 0,
        pediatrico: parseInt(document.getElementById('tipoaten-pediatrico')?.value) || 0
    };
    
    // Electromedicina
    var electromedicina = {
        marca: document.getElementById('electro-marca')?.value || '',
        audiometro: document.getElementById('electro-audiometro')?.checked || false,
        rem: document.getElementById('electro-rem')?.checked || false,
        campoLibre: document.getElementById('electro-campolibre')?.checked || false,
        timpanometria: document.getElementById('electro-timpano')?.checked || false,
        videotoscopia: document.getElementById('electro-video')?.checked || false,
        hit: document.getElementById('electro-hit')?.checked || false
    };
    
    // Guardar también el HTML del checklist para mostrar idéntico al reabrir
    var checklistHTML = document.getElementById('checklist-content')?.innerHTML || '';
    
    // Funnel del centro
    var funnel = {
        ventas: parseInt(document.getElementById('inf-funnel-ventas')?.value) || 0,
        capacitacion: parseInt(document.getElementById('inf-funnel-capacitacion')?.value) || 0,
        devoluciones: parseInt(document.getElementById('inf-funnel-devoluciones')?.value) || 0
    };
    
    // Plan Local
    var planLocalLabels = document.querySelectorAll('#plan-local-selector label');
    var planLocal = null;
    if(planLocalLabels && planLocalLabels.length >= 2) {
        var siCheck = planLocalLabels[0].querySelector('input');
        var noCheck = planLocalLabels[1].querySelector('input');
        if(siCheck && siCheck.checked) planLocal = 'si';
        else if(noCheck && noCheck.checked) planLocal = 'no';
    }
    
    return {
        id: Date.now(),
        centro: document.getElementById('inf-centro')?.value || '',
        propietario: document.getElementById('inf-propietario')?.value || '',
        delegadoRegional: document.getElementById('inf-delegado-regional')?.value || '',
        delegadoAudio: document.getElementById('inf-delegado-audio')?.value || '',
        tipoVisita: document.getElementById('inf-tipo-visita')?.value || '',
        fecha: document.getElementById('inf-fecha')?.value || '',
        pcpnc: document.getElementById('inf-pcpnc')?.value || '',
        horasServicio: document.getElementById('inf-horas')?.value || '',
        nombreAudiologo: document.getElementById('inf-nombre-audiologo')?.value || '',
        resultado: parseInt(document.getElementById('inf-res-valor')?.textContent) || 0,
        basicos: basicos,
        pentagonoGlobal: pentagonoGlobal,
        gamas: gamas,
        tipoAtencion: tipoAtencion,
        electromedicina: electromedicina,
        bloquesPct: bloquesPct,
        areasMejora: areasMejora,
        todasPreguntasNO: todasPreguntasNO,
        conversiones: conversiones,
        funnel: funnel,
        planLocal: planLocal,
        imagenes: imagenes,
        respuestas: respuestasActuales || (preinformeActual ? preinformeActual.respuestas : (informeActualIndex >= 0 && informesBorrador[informeActualIndex] ? (informesBorrador[informeActualIndex].respuestas || null) : null)),
        checklistHTML: (checklistHTML && checklistHTML.length < 100000) ? checklistHTML : '', // Limitar tamaño, se regenera desde respuestas
        textos: {
            observaciones: document.getElementById('txt-observaciones')?.value || '',
            recomendaciones: document.getElementById('txt-recomendaciones')?.value || '',
            compromisos: document.getElementById('txt-compromisos')?.value || '',
            tiempoCompromisos: document.getElementById('tiempo-compromisos')?.value || '1mes',
            resumen: document.getElementById('txt-resumen')?.value || '',
            planAccion: document.getElementById('txt-plan-accion')?.value || ''
        },
        fotosGuia: (typeof fotosGuia !== 'undefined' && fotosGuia.length > 0) ? fotosGuia.slice() : [],
        preinformeData: preinformeActual ? (function() {
            var pd = Object.assign({}, preinformeActual);
            // CRÍTICO: Evitar anidación recursiva - eliminar preinformeData dentro de preinformeData
            delete pd.preinformeData;
            // No duplicar checklistHTML ni imágenes en el preinformeData
            delete pd.checklistHTML;
            delete pd.imagenes;
            delete pd.fotosGuia;
            return pd;
        })() : null
    };
}

// Regenerar checklist desde respuestas guardadas
function regenerarChecklistDesdeRespuestas(respuestasGuardadas, bloquesPctGuardados) {
    if(!respuestasGuardadas) return;
    
    var ck = '';
    bloques.forEach(function(b) {
        var pB = preguntas.filter(function(p) { return p.bloque === b.id; });
        var porcentajeBloque = bloquesPctGuardados ? (bloquesPctGuardados[b.id] || 0) : 0;
        
        ck += '<div class="checklist-bloque"><div class="checklist-header" style="background:' + b.gradient + ';">' + b.largo + ' (' + b.peso + '%)<span>' + porcentajeBloque + '%</span></div>';
        
        pB.forEach(function(p) {
            var resp = respuestasGuardadas[p.id];
            var ob = obligatorias.includes(p.id);
            var badgeClass, badgeText;
            
            if(p.tipo === 'agenda_dual') {
                var pvVal = respuestasGuardadas['90_pv'] || 0;
                var revVal = respuestasGuardadas['90_rev'] || resp || 0;
                badgeClass = 'num'; 
                badgeText = pvVal + '/' + revVal;
            } else if(p.tipo === 'binario') {
                var si = resp === 'si';
                badgeClass = si ? 'si' : 'no'; 
                badgeText = si ? '✓' : '✗';
            } else if(p.tipo === 'agenda_confirm') {
                var cumple = resp >= 75;
                badgeClass = cumple ? 'si' : 'no'; 
                badgeText = cumple ? (resp + '% ✓') : (resp + '% ✗');
            } else {
                badgeClass = 'num'; 
                badgeText = (resp !== undefined && resp !== null) ? resp : 0;
            }
            
            ck += '<div class="checklist-item"><span class="check-badge ' + badgeClass + '">' + badgeText + '</span><span style="flex:1;line-height:1.3">' + p.id + '. ' + p.criterio + '</span>' + (ob ? '<span class="check-ob">OBLIGATORIA</span>' : '') + '</div>';
        });
        
        ck += '</div>';
    });
    
    var checklistEl = document.getElementById('checklist-content');
    if(checklistEl) {
        checklistEl.innerHTML = ck;
    }
}

async function guardarBorradorInforme() {
    try {
    const datos = obtenerDatosInforme();
    datos.guardadoEn = new Date().toISOString();
    
    if(preinformeActual) {
        var pd = {};
        for(var pk in preinformeActual) {
            if(pk !== 'preinformeData' && pk !== 'checklistHTML') pd[pk] = preinformeActual[pk];
        }
        datos.preinformeData = pd;
    }
    
    // Comprimir imágenes (ya vienen pre-comprimidas de previewFile, esto es seguridad extra)
    if(datos.imagenes && datos.imagenes.length > 0) {
        datos.imagenes = await comprimirImagenesArray(datos.imagenes);
    }
    if(datos.fotosGuia && datos.fotosGuia.length > 0) {
        for(var fg = 0; fg < datos.fotosGuia.length; fg++) {
            if(datos.fotosGuia[fg] && datos.fotosGuia[fg].data && typeof datos.fotosGuia[fg].data === 'string' && datos.fotosGuia[fg].data.startsWith('data:image') && datos.fotosGuia[fg].data.length > 80000) {
                datos.fotosGuia[fg].data = await comprimirImagen(datos.fotosGuia[fg].data, 600, 450, 0.4);
            }
        }
    }
    
    // Limitar checklistHTML
    if(datos.checklistHTML && datos.checklistHTML.length > 100000) datos.checklistHTML = '';
    
    console.log('[guardarBorrador] Centro:', datos.centro, '| Imgs:', datos.imagenes ? datos.imagenes.filter(function(x){return x}).length : 0);
    
    // Guardar en array
    if(informeActualIndex >= 0 && informeActualIndex < informesBorrador.length) {
        informesBorrador[informeActualIndex] = datos;
    } else {
        informesBorrador.unshift(datos);
        informeActualIndex = 0;
    }
    
    // Guardar en localStorage
    var jsonBorr = JSON.stringify(informesBorrador);
    console.log('[guardarBorrador] Tamaño:', Math.round(jsonBorr.length/1024), 'KB');
    
    // Firebase SIEMPRE primero (ilimitado, nunca falla por espacio)
    sincronizarConFirebaseDirecto('informesBorrador', jsonBorr);
    sincronizarConFirebaseDirecto('borradoresInforme', jsonBorr);
    
    // localStorage con reintentos inteligentes
    try {
        localStorage.setItem('informesBorrador', jsonBorr);
        localStorage.setItem('borradoresInforme', jsonBorr);
    } catch(eStorage) {
        console.warn('[guardarBorrador] localStorage lleno, optimizando...');
        optimizarStorage();
        try {
            localStorage.setItem('informesBorrador', jsonBorr);
            localStorage.setItem('borradoresInforme', jsonBorr);
        } catch(e2) {
            await liberarEspacioStorage();
            try {
                localStorage.setItem('informesBorrador', jsonBorr);
                localStorage.setItem('borradoresInforme', jsonBorr);
            } catch(e3) {
                console.warn('[guardarBorrador] localStorage lleno. Datos seguros en Firebase.');
            }
        }
    }
    
    // Optimizar para siguiente guardado
    try { optimizarStorage(); } catch(eo) {}
    
    // Eliminar preinforme
    var preinformeEliminado = false;
    var centroInforme = datos.centro ? datos.centro.toUpperCase().trim() : '';
    if(centroInforme || preinformeActual) {
        var preinformesActuales = JSON.parse(localStorage.getItem('preinformes') || '[]');
        var nuevosPreinformes = preinformesActuales.filter(function(p) {
            var pCentro = p.centro ? p.centro.toUpperCase().trim() : '';
            if(preinformeActual && preinformeActual.centro) {
                var paCentro = preinformeActual.centro.toUpperCase().trim();
                if(pCentro.includes(paCentro) || paCentro.includes(pCentro)) return false;
            }
            if(centroInforme && (pCentro.includes(centroInforme) || centroInforme.includes(pCentro))) return false;
            return true;
        });
        if(nuevosPreinformes.length < preinformesActuales.length) {
            preinformeEliminado = true;
            preinformes = nuevosPreinformes;
            localStorage.setItem('preinformes', JSON.stringify(preinformes));
            sincronizarConFirebaseDirecto('preinformes', JSON.stringify(preinformes));
        }
    }
    
    // Marcar visita agendada como finalizada (si existe)
    var codigoCentroBorr = datos.preinformeData ? datos.preinformeData.codigoCentro : null;
    if(!codigoCentroBorr && centroEvaluacionActual) codigoCentroBorr = centroEvaluacionActual.codigo;
    if(!codigoCentroBorr && centroInforme) {
        var _cb = centrosData.find(function(c) { return centroInforme.includes(c.n.toUpperCase()) || c.n.toUpperCase().includes(centroInforme); });
        if(_cb) codigoCentroBorr = _cb.c;
    }
    if(codigoCentroBorr) {
        var idxVB = visitasAgendadas.findIndex(function(v) { return v.codigo === codigoCentroBorr && !v.finalizado; });
        if(idxVB >= 0) {
            visitasAgendadas[idxVB].finalizado = true;
            visitasAgendadas[idxVB].fechaFinalizacion = new Date().toISOString();
            visitasAgendadas[idxVB].estado = 'borrador';
            localStorage.setItem('visitasAgendadas', JSON.stringify(visitasAgendadas));
            sincronizarConFirebaseDirecto('visitasAgendadas', JSON.stringify(visitasAgendadas));
        }
    }
    
    const msg = document.createElement('div');
    msg.innerHTML = '📝 BORRADOR GUARDADO' + (preinformeEliminado ? ' (preinforme archivado)' : '');
    msg.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#C9A227;color:#fff;padding:12px 24px;border-radius:8px;font-weight:700;font-size:14px;z-index:99999;box-shadow:0 4px 15px rgba(0,0,0,0.3)';
    document.body.appendChild(msg);
    setTimeout(function() { msg.remove(); }, 2500);
    
    var countBorr = document.getElementById('count-borradores-tab');
    if(countBorr) countBorr.textContent = informesBorrador.length;
    
    try { cargarBorradoresInformes(); } catch(e) {}
    try { renderInformesFinalizados(); } catch(e) {}
    try { renderPreinformes(); } catch(e) {}
    
    console.log('[guardarBorrador] ✅ Completado');
    
    } catch(err) {
        console.error('[guardarBorrador] ERROR:', err);
        alert('Error guardando borrador: ' + err.message + '. Los datos siguen en pantalla.');
    }
}

async function finalizarInforme() {
    // Validar horas de servicio obligatorio
    const horasInput = document.getElementById('inf-horas');
    const horas = horasInput ? horasInput.value.trim() : '';
    if(!horas) {
        alert('⚠️ CAMPO OBLIGATORIO\n\nDebe indicar las "Horas de Servicio" para finalizar el informe.');
        if(horasInput) {
            horasInput.focus();
            horasInput.style.border = '2px solid #dc2626';
            horasInput.style.background = '#fef2f2';
        }
        return;
    }
    
    // Validar Plan de acción local
    if(!verificarPlanLocalSeleccionado()) {
        alert('⚠️ CAMPO OBLIGATORIO\n\nDebe indicar si existe "Plan de acción local" (Sí/No) en la sección 11 Básicos.');
        const selector = document.getElementById('plan-local-selector');
        if(selector) {
            selector.style.display = 'block';
            selector.style.border = '2px solid #dc2626';
            selector.scrollIntoView({behavior: 'smooth', block: 'center'});
        }
        return;
    }
    
    if(!confirm('¿Finalizar este informe? Una vez finalizado no se podrá editar.')) return;
    
    try {
    const datos = obtenerDatosInforme();
    datos.estado = 'finalizado';
    datos.fechaFinalizacion = new Date().toISOString().split('T')[0];
    
    if(preinformeActual) {
        var pd = {};
        for(var pk in preinformeActual) {
            if(pk !== 'preinformeData' && pk !== 'checklistHTML') pd[pk] = preinformeActual[pk];
        }
        datos.preinformeData = pd;
    }
    
    // Comprimir imágenes
    if(datos.imagenes && datos.imagenes.length > 0) {
        datos.imagenes = await comprimirImagenesArray(datos.imagenes);
    }
    if(datos.fotosGuia && datos.fotosGuia.length > 0) {
        for(var fg = 0; fg < datos.fotosGuia.length; fg++) {
            if(datos.fotosGuia[fg] && datos.fotosGuia[fg].data && typeof datos.fotosGuia[fg].data === 'string' && datos.fotosGuia[fg].data.startsWith('data:image') && datos.fotosGuia[fg].data.length > 80000) {
                datos.fotosGuia[fg].data = await comprimirImagen(datos.fotosGuia[fg].data, 600, 450, 0.4);
            }
        }
    }
    
    // Limitar checklistHTML
    if(datos.checklistHTML && datos.checklistHTML.length > 100000) datos.checklistHTML = '';
    
    console.log('[finalizar] Centro:', datos.centro, '| Imgs:', datos.imagenes ? datos.imagenes.filter(function(x){return x}).length : 0);
    
    const centroInforme = datos.centro ? datos.centro.toUpperCase().trim() : '';
    const fechaInforme = datos.fecha || '';
    
    // 1. ELIMINAR BORRADOR
    var borradorEliminado = false;
    if(centroInforme || informeActualIndex >= 0) {
        var borradoresActuales = JSON.parse(localStorage.getItem('informesBorrador') || '[]');
        var nuevoBorradores = borradoresActuales.filter(function(b) {
            var bCentro = b.centro ? b.centro.toUpperCase().trim() : '';
            var bFecha = b.fecha || '';
            if(centroInforme && bCentro.includes(centroInforme) && bFecha === fechaInforme) return false;
            if(centroInforme && bCentro.includes(centroInforme) && !bFecha) return false;
            return true;
        });
        if(informeActualIndex >= 0 && informeActualIndex < borradoresActuales.length) {
            var idxEnNuevo = nuevoBorradores.findIndex(function(b) {
                return b.centro === borradoresActuales[informeActualIndex].centro && b.fecha === borradoresActuales[informeActualIndex].fecha;
            });
            if(idxEnNuevo >= 0) nuevoBorradores.splice(idxEnNuevo, 1);
        }
        if(nuevoBorradores.length < borradoresActuales.length) {
            borradorEliminado = true;
            informesBorrador = nuevoBorradores;
            localStorage.setItem('informesBorrador', JSON.stringify(informesBorrador));
            localStorage.setItem('borradoresInforme', JSON.stringify(informesBorrador));
            sincronizarConFirebaseDirecto('informesBorrador', JSON.stringify(informesBorrador));
            sincronizarConFirebaseDirecto('borradoresInforme', JSON.stringify(informesBorrador));
        }
    }
    
    // 2. ELIMINAR PREINFORME
    var preinformeEliminado = false;
    if(centroInforme || preinformeActual) {
        var preinformesActuales = JSON.parse(localStorage.getItem('preinformes') || '[]');
        var nuevosPreinformes = preinformesActuales.filter(function(p) {
            var pCentro = p.centro ? p.centro.toUpperCase().trim() : '';
            var pFecha = p.fecha || '';
            if(preinformeActual && preinformeActual.centro && preinformeActual.fecha) {
                var paCentro = preinformeActual.centro.toUpperCase().trim();
                if(pCentro.includes(paCentro) && pFecha === preinformeActual.fecha) return false;
            }
            if(centroInforme && pCentro.includes(centroInforme) && pFecha === fechaInforme) return false;
            return true;
        });
        if(nuevosPreinformes.length < preinformesActuales.length) {
            preinformeEliminado = true;
            preinformes = nuevosPreinformes;
            localStorage.setItem('preinformes', JSON.stringify(preinformes));
            sincronizarConFirebaseDirecto('preinformes', JSON.stringify(preinformes));
        }
    }
    
    // 2b. MARCAR VISITA AGENDADA COMO FINALIZADA
    var codigoCentroFin = datos.preinformeData ? datos.preinformeData.codigoCentro : null;
    if(!codigoCentroFin && centroEvaluacionActual) codigoCentroFin = centroEvaluacionActual.codigo;
    if(!codigoCentroFin && centroInforme) {
        var _cf = centrosData.find(function(c) { return centroInforme.includes(c.n.toUpperCase()) || c.n.toUpperCase().includes(centroInforme); });
        if(_cf) codigoCentroFin = _cf.c;
    }
    if(codigoCentroFin) {
        var idxVF = visitasAgendadas.findIndex(function(v) { return v.codigo === codigoCentroFin && !v.finalizado; });
        if(idxVF >= 0) {
            visitasAgendadas[idxVF].finalizado = true;
            visitasAgendadas[idxVF].fechaFinalizacion = new Date().toISOString();
            visitasAgendadas[idxVF].estado = 'finalizado';
            localStorage.setItem('visitasAgendadas', JSON.stringify(visitasAgendadas));
            sincronizarConFirebaseDirecto('visitasAgendadas', JSON.stringify(visitasAgendadas));
        }
    }
    
    // 3. AÑADIR A INFORMES FINALIZADOS
    informesFinalizados.unshift(datos);
    
    // Firebase SIEMPRE primero (ilimitado)
    sincronizarConFirebaseDirecto('informesFinalizados', JSON.stringify(informesFinalizados));
    
    var jsonFin = JSON.stringify(informesFinalizados);
    console.log('[finalizar] Tamaño finalizados:', Math.round(jsonFin.length/1024), 'KB | Total informes:', informesFinalizados.length);
    
    try {
        localStorage.setItem('informesFinalizados', jsonFin);
    } catch(e) {
        console.warn('[finalizar] localStorage lleno, optimizando...');
        optimizarStorage();
        try {
            localStorage.setItem('informesFinalizados', JSON.stringify(informesFinalizados));
        } catch(e2) {
            await liberarEspacioStorage();
            try {
                localStorage.setItem('informesFinalizados', JSON.stringify(informesFinalizados));
            } catch(e3) {
                console.warn('[finalizar] localStorage lleno. Informe seguro en Firebase.');
            }
        }
    }
    
    // Optimizar para próximo guardado
    try { optimizarStorage(); } catch(eo) {}
    
    informeActualIndex = -1;
    preinformeActual = null;
    
    const msg = document.createElement('div');
    msg.innerHTML = '✅ INFORME FINALIZADO' + (borradorEliminado ? ' (borrador eliminado)' : '') + (preinformeEliminado ? ' (preinforme eliminado)' : '');
    msg.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#C9A227;color:#fff;padding:12px 24px;border-radius:8px;font-weight:700;font-size:14px;z-index:99999;box-shadow:0 4px 15px rgba(0,0,0,0.3)';
    document.body.appendChild(msg);
    setTimeout(function() { msg.remove(); }, 2500);
    
    renderInformesFinalizados();
    renderPreinformes();
    updateDashboard();
    actualizarPentagonoDashboard();
    actualizarDashboardMedia();
    cargarInformesFinalizados();
    try { cargarBorradoresInformes(); } catch(e) {}
    try { cargarListasBorradoresFinalizados(); } catch(e) {}
    
    setTimeout(function() { showSection('informes-gestion'); }, 1000);
    
    console.log('[finalizar] ✅ Completado');
    
    } catch(err) {
        console.error('[finalizar] ERROR:', err);
        alert('Error finalizando informe: ' + err.message + '. Los datos siguen en pantalla.');
    }
}

function limpiarPreinforme() {
    nuevaEval();
    const msg = document.createElement('div');
    msg.innerHTML = '🗑️ LIMPIADO - Nueva evaluación';
    msg.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#6b7280;color:#fff;padding:12px 24px;border-radius:8px;font-weight:700;font-size:14px;z-index:99999;box-shadow:0 4px 15px rgba(0,0,0,0.3)';
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 2000);
}

function irAInformeDesdePreinforme() {
    // El preinforme recién creado está en posición 0
    if(preinformes.length > 0) {
        irAInforme(0);
    } else {
        alert('No hay preinforme para mostrar');
    }
}

function renderPreinformes() {
    const lista = document.getElementById('preinformes-lista'), empty = document.getElementById('preinformes-empty');
    const lista2 = document.getElementById('preinformes-lista-2'), empty2 = document.getElementById('preinformes-empty-2');
    
    if(preinformes.length === 0) { 
        lista.innerHTML = ''; 
        empty.style.display = 'block'; 
        if(lista2) lista2.innerHTML = '';
        if(empty2) empty2.style.display = 'block';
        return; 
    }
    empty.style.display = 'none';
    if(empty2) empty2.style.display = 'none';
    
    // Ordenar por fecha más reciente
    var preinformesOrdenados = preinformes.map((p, idx) => ({...p, _idx: idx}));
    preinformesOrdenados.sort((a, b) => {
        var fechaA = a.fecha || '1900-01-01';
        var fechaB = b.fecha || '1900-01-01';
        return fechaB.localeCompare(fechaA);
    });
    
    let html = '';
    preinformesOrdenados.forEach((p) => {
        var i = p._idx;
        const cat = getCategoria(p.resultado);
        html += '<div class="preinforme-item"><div class="preinforme-top"><div class="preinforme-dot" style="background:' + cat.color + '"></div><div class="preinforme-centro">' + p.centro + '</div><div class="preinforme-score" style="color:' + cat.color + '">' + p.resultado + '%</div></div><div class="preinforme-meta">' + p.fecha + ' • ' + (p.audiologo || '-') + '</div><div class="preinforme-btns"><button class="preinforme-btn ver" onclick="verPre(' + i + ')">👁️ Ver</button><button class="preinforme-btn" style="background:#C9A227;color:#fff" onclick="guardarPreinforme(' + i + ')">💾 Guardar</button><button class="preinforme-btn" style="background:#6b7280;color:#fff" onclick="irAInforme(' + i + ')">📄 Informe</button><button class="preinforme-btn borrar" onclick="borrarPre(' + i + ')">🗑️</button><button class="preinforme-btn" style="background:#3b82f6;color:#fff" onclick="imprimirPre(' + i + ')">🖨️</button></div></div>';
    });
    lista.innerHTML = html;
    if(lista2) lista2.innerHTML = html;
    
    document.getElementById('stat-evals').textContent = preinformes.length;
    if(preinformes.length > 0) document.getElementById('stat-prom').textContent = Math.round(preinformes.reduce((a,b) => a + b.resultado, 0) / preinformes.length) + '%';
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('stat-mes').textContent = preinformes.filter(p => p.fecha && p.fecha.substring(0,7) === hoy.substring(0,7)).length;
}

function verPre(i) {
    const p = preinformes[i];
    datosPortada = {centro:p.centro,fecha:p.fecha,audiologo:p.audiologo,responsable:p.responsable};
    respuestas = {...p.respuestas};
    huboObligatoriaNo = p.huboObligatoriaNo;
    mostrarInforme();
}

function borrarPre(i) {
    if(!preinformes[i]) return;
    if(confirm('¿Eliminar preinforme de ' + preinformes[i].centro + '?')) {
        // 1. Bloquear key para evitar que merge restaure el dato
        if(typeof SharedSync !== 'undefined' && SharedSync.lockKeyForDelete) {
            SharedSync.lockKeyForDelete('preinformes');
        }
        
        // 2. Eliminar del array en memoria
        preinformes.splice(i, 1);
        
        // 3. Guardar en localStorage
        var jsonData = JSON.stringify(preinformes);
        localStorage.setItem('preinformes', jsonData);
        
        // 4. Sincronizar con Firebase INMEDIATAMENTE (incluso vacío)
        sincronizarConFirebaseDirecto('preinformes', jsonData);
        
        // 5. Actualizar vistas
        renderPreinformes();
        updateDashboard();
        actualizarDashboardMedia();
        try { renderCentrosVisitas(); } catch(e) {}
        
        // 6. Mostrar confirmación
        var msg = document.createElement('div');
        msg.innerHTML = '🗑️ Preinforme eliminado';
        msg.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#dc2626;color:#fff;padding:12px 24px;border-radius:8px;font-weight:700;font-size:14px;z-index:99999;box-shadow:0 4px 15px rgba(0,0,0,0.3)';
        document.body.appendChild(msg);
        setTimeout(function() { msg.remove(); }, 2000);
    }
}

function imprimirPre(i) { verPre(i); setTimeout(() => window.print(), 300); }

function guardarPreinforme(i) {
    var guardado = guardarPreinformesEnStorage();
    // Forzar push directo a Firebase
    sincronizarConFirebaseDirecto('preinformes', JSON.stringify(preinformes));
    
    var msg = document.createElement('div');
    msg.innerHTML = '✅ PREINFORME GUARDADO EN FIREBASE';
    msg.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#C9A227;color:#fff;padding:12px 24px;border-radius:8px;font-weight:700;font-size:14px;z-index:99999;box-shadow:0 4px 15px rgba(0,0,0,0.3)';
    document.body.appendChild(msg);
    setTimeout(function() { msg.remove(); }, 2000);
}

let dashRadarCharts = {};

// ========== PENTÁGONO 11 BÁSICOS ==========
var pentagonoDashboardChart = null;
var pentagonoInformeChart = null;

function actualizarPentagonoDashboard() {
    dibujarPentagonoDashboard();
}

function dibujarPentagonoDashboard() {
    var canvas = document.getElementById('pentagono-dashboard');
    if (!canvas) return;
    
    if (pentagonoDashboardChart) pentagonoDashboardChart.destroy();
    
    // Aplicar filtro de delegado regional
    var filtroDelegado = document.getElementById('filtro-delegado-dashboard');
    var delegadoSel = filtroDelegado ? filtroDelegado.value : '';
    var centrosFilt = delegadoSel ? getCentrosPorDelegado(delegadoSel) : null;
    
    // Filtrar informesFinalizados
    var infFiltrados = centrosFilt
        ? informesFinalizados.filter(function(p) {
            if(p.delegadoRegional === delegadoSel) return true;
            if(p.centro) {
                var cod = p.centro.split(' ')[0].toUpperCase();
                return centrosFilt.indexOf(cod) >= 0;
            }
            return false;
        })
        : informesFinalizados;
    
    var n = infFiltrados.length;
    var dataValues = [0, 0, 0, 0, 0];
    var globalPct = 0;
    
    // Actualizar contador
    var dashPentTotal = document.getElementById('dash-pent-total');
    if (dashPentTotal) dashPentTotal.textContent = '(' + n + ' inf.)';
    
    if (n > 0) {
        var sumBasicos = [0,0,0,0,0,0,0,0,0,0,0];
        infFiltrados.forEach(function(inf) {
            if (inf.basicos && Array.isArray(inf.basicos)) {
                for (var i = 0; i < 11; i++) {
                    sumBasicos[i] += (inf.basicos[i] || 0);
                }
            }
        });
        var avgBasicos = sumBasicos.map(function(s) { return Math.round((s / n) * 100); });
        dataValues = [
            avgBasicos[0],
            avgBasicos[1],
            Math.round((avgBasicos[2] + avgBasicos[3]) / 2),
            Math.round((avgBasicos[4] + avgBasicos[5]) / 2),
            Math.round((avgBasicos[6] + avgBasicos[7] + avgBasicos[8] + avgBasicos[9] + avgBasicos[10]) / 5)
        ];
        globalPct = Math.round(sumBasicos.reduce(function(a,b) { return a+b; }, 0) / (n * 11) * 100);
    }
    
    var dashPentGlobal = document.getElementById('dash-pent-global');
    if (dashPentGlobal) dashPentGlobal.textContent = globalPct + '%';
    
    pentagonoDashboardChart = new Chart(canvas, {
        type: 'radar',
        data: {
            labels: ['Imagen', 'Presencia', 'Conocimiento', 'Integración', 'Comercial'],
            datasets: [{
                data: dataValues,
                backgroundColor: 'rgba(220, 38, 38, 0.2)',
                borderColor: '#dc2626',
                borderWidth: 2,
                pointBackgroundColor: '#dc2626',
                pointBorderColor: '#fff',
                pointRadius: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { display: false },
                    grid: { color: '#ddd' },
                    angleLines: { color: '#ddd' },
                    pointLabels: { font: { size: 9, weight: '600' }, color: '#8B7355', padding: 2 }
                }
            },
            plugins: { legend: { display: false } }
        }
    });
}

function cargarAreasMejoraGuardadas(areasMejora, infData) {
    var tablaMejoras = document.getElementById('tabla-mejoras');
    if(!tablaMejoras) return;
    
    var tbody = tablaMejoras.querySelector('tbody');
    if(!tbody) return;
    
    // Limpiar filas existentes
    tbody.innerHTML = '';
    
    // Si no hay áreas de mejora, intentar reconstruir desde respuestas
    if((!areasMejora || areasMejora.length === 0) && infData && infData.respuestas) {
        areasMejora = [];
        var bPct = calcularBloquesPct(infData.respuestas);
        bloques.forEach(function(b) {
            var pct = bPct[b.id] || 0;
            if(pct < 80 && b.peso > 0) {
                var preguntasNO = [];
                preguntas.filter(function(p) { return p.bloque === b.id; }).forEach(function(p) {
                    if(p.tipo === 'binario' && infData.respuestas[p.id] === 'no') {
                        preguntasNO.push({id: p.id, criterio: p.criterio, detalle: p.detalle || '', obligatoria: p.obligatoria || false});
                    }
                });
                areasMejora.push({nombre: b.nombre, porcentaje: pct, preguntasNO: preguntasNO});
            }
        });
    }
    
    if(!areasMejora || areasMejora.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:10px;color:#22c55e;border:1px solid #ddd;font-weight:600">✅ Sin áreas de mejora — Todos los bloques ≥80%</td></tr>';
        return;
    }
    
    // Renderizar cada bloque con sus preguntas NO
    areasMejora.forEach(function(area) {
        // Cabecera de bloque
        var trHeader = document.createElement('tr');
        trHeader.innerHTML = '<td colspan="3" style="padding:8px 6px;background:rgba(201,162,39,0.92);color:#fff;font-weight:700;font-size:11px;border:1px solid #ccc">' +
            '⚠️ ' + area.nombre + ' — <span style="font-size:10px">' + area.porcentaje + '%</span>' +
            '</td>';
        tbody.appendChild(trHeader);
        
        // Si tiene preguntasNO detalladas
        if(area.preguntasNO && area.preguntasNO.length > 0) {
            area.preguntasNO.forEach(function(p) {
                var tr = document.createElement('tr');
                var obTag = p.obligatoria ? ' <span style="background:#dc2626;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;font-weight:700">OBLIGATORIA</span>' : '';
                tr.innerHTML = '<td style="padding:5px 6px;border:1px solid #ddd;font-weight:600;color:#dc2626;font-size:10px;width:5%;text-align:center;vertical-align:top">' + 
                    '<span style="background:#dc2626;color:#fff;padding:2px 6px;border-radius:4px;font-size:9px">✗ ' + p.id + '</span></td>' +
                    '<td style="padding:5px 6px;border:1px solid #ddd;font-size:10px;line-height:1.4;vertical-align:top">' +
                    '<div style="font-weight:600;color:#333;margin-bottom:2px">' + p.criterio + obTag + '</div>' +
                    (p.detalle ? '<div style="color:#666;font-size:9px;line-height:1.3;margin-top:3px;padding:4px 6px;background:#fef2f2;border-radius:4px;border-left:3px solid #dc2626">' + p.detalle + '</div>' : '') +
                    '</td>' +
                    '<td style="padding:5px 6px;border:1px solid #ddd;text-align:center;vertical-align:top"><span style="color:#dc2626;font-weight:700;font-size:11px">❌ NO</span></td>';
                tbody.appendChild(tr);
            });
        } else {
            // Fallback para áreas sin detalle de preguntas (compatibilidad con datos antiguos)
            // Intentar reconstruir desde respuestas si están disponibles
            if(infData && infData.respuestas) {
                preguntas.filter(function(p) { return p.bloque === area.nombre || bloques.some(function(b) { return b.nombre === area.nombre && b.id === p.bloque; }); }).forEach(function(p) {
                    if(p.tipo === 'binario' && infData.respuestas[p.id] === 'no') {
                        var tr = document.createElement('tr');
                        var obTag = p.obligatoria ? ' <span style="background:#dc2626;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px;font-weight:700">OBLIGATORIA</span>' : '';
                        tr.innerHTML = '<td style="padding:5px 6px;border:1px solid #ddd;font-weight:600;color:#dc2626;font-size:10px;width:5%;text-align:center;vertical-align:top">' + 
                            '<span style="background:#dc2626;color:#fff;padding:2px 6px;border-radius:4px;font-size:9px">✗ ' + p.id + '</span></td>' +
                            '<td style="padding:5px 6px;border:1px solid #ddd;font-size:10px;line-height:1.4;vertical-align:top">' +
                            '<div style="font-weight:600;color:#333;margin-bottom:2px">' + p.criterio + obTag + '</div>' +
                            (p.detalle ? '<div style="color:#666;font-size:9px;line-height:1.3;margin-top:3px;padding:4px 6px;background:#fef2f2;border-radius:4px;border-left:3px solid #dc2626">' + p.detalle + '</div>' : '') +
                            '</td>' +
                            '<td style="padding:5px 6px;border:1px solid #ddd;text-align:center;vertical-align:top"><span style="color:#dc2626;font-weight:700;font-size:11px">❌ NO</span></td>';
                        tbody.appendChild(tr);
                    }
                });
            } else {
                var tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="3" style="padding:6px;border:1px solid #ddd;color:#dc2626;font-size:10px">Revisar criterios de este bloque</td>';
                tbody.appendChild(tr);
            }
        }
    });
}

function actualizarPentagono() {
    var canvas = document.getElementById('pentagono-informe');
    if (!canvas) return;
    
    if (pentagonoInformeChart) pentagonoInformeChart.destroy();
    
    // Leer checkboxes - checked = SÍ CUMPLE
    var basicos = [];
    for (var i = 1; i <= 11; i++) {
        var cb = document.getElementById('basico-' + i);
        var lbl = document.getElementById('lbl-basico-' + i);
        var checked = cb && cb.checked;
        basicos.push(checked ? 100 : 0);
        // Colorear label: verde si cumple, rojo si no cumple
        if (lbl) {
            lbl.style.background = checked ? '#dcfce7' : '#fee2e2';
            lbl.style.borderLeft = checked ? '3px solid #16a34a' : '3px solid #dc2626';
            lbl.style.color = checked ? '#16a34a' : '#dc2626';
            lbl.style.fontWeight = '600';
        }
    }
    
    // Calcular valores porcentuales por área
    var dataValues = [
        basicos[0],                                              // IMAGEN (solo 1)
        basicos[1],                                              // PRESENCIA (solo 2)
        Math.round((basicos[2] + basicos[3]) / 2),              // CONOCIMIENTO (3,4)
        Math.round((basicos[4] + basicos[5]) / 2),              // INTEGRACIÓN (5,6)
        Math.round((basicos[6] + basicos[7] + basicos[8] + basicos[9] + basicos[10]) / 5) // COMERCIAL (7-11)
    ];
    
    var cumplidos = basicos.filter(function(v) { return v === 100; }).length;
    var globalPct = Math.round(cumplidos / 11 * 100);
    
    var pentGlobal = document.getElementById('pent-global');
    if (pentGlobal) {
        pentGlobal.textContent = globalPct + '%';
        pentGlobal.style.color = '#dc2626';
    }
    
    // Pentágono siempre ROJO
    pentagonoInformeChart = new Chart(canvas, {
        type: 'radar',
        data: {
            labels: ['Imagen', 'Presencia', 'Conocimiento', 'Integración', 'Comercial'],
            datasets: [{
                data: dataValues,
                backgroundColor: 'rgba(220, 38, 38, 0.25)',
                borderColor: '#dc2626',
                borderWidth: 2,
                pointBackgroundColor: '#dc2626',
                pointBorderColor: '#fff',
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { stepSize: 25, font: { size: 8 }, color: '#666', backdropColor: 'transparent' },
                    grid: { color: '#ddd' },
                    angleLines: { color: '#ddd' },
                    pointLabels: { font: { size: 9, weight: '700' }, color: '#333' }
                }
            },
            plugins: { legend: { display: false } }
        }
    });
}

// ═══════════════════════════════════════════════════════════════════════════════
// FUNCIONES DE GAMAS (Diamante, Platino, Oro)
// ═══════════════════════════════════════════════════════════════════════════════
function calcularGamas() {
    const diamantePlus = parseInt(document.getElementById('gama-diamante-plus')?.value) || 0;
    const diamante = parseInt(document.getElementById('gama-diamante')?.value) || 0;
    const platinoPlus = parseInt(document.getElementById('gama-platino-plus')?.value) || 0;
    const platino = parseInt(document.getElementById('gama-platino')?.value) || 0;
    const oro = parseInt(document.getElementById('gama-oro')?.value) || 0;
    const total = diamantePlus + diamante + platinoPlus + platino + oro;
    
    // Calcular porcentajes
    const pctDiamantePlus = total > 0 ? Math.round((diamantePlus / total) * 100) : 0;
    const pctDiamante = total > 0 ? Math.round((diamante / total) * 100) : 0;
    const pctPlatinoPlus = total > 0 ? Math.round((platinoPlus / total) * 100) : 0;
    const pctPlatino = total > 0 ? Math.round((platino / total) * 100) : 0;
    const pctOro = total > 0 ? Math.round((oro / total) * 100) : 0;
    
    // Actualizar porcentajes en pantalla
    const elDiamantePlusPct = document.getElementById('gama-diamante-plus-pct');
    const elDiamantePct = document.getElementById('gama-diamante-pct');
    const elPlatinoPlusPct = document.getElementById('gama-platino-plus-pct');
    const elPlatinoPct = document.getElementById('gama-platino-pct');
    const elOroPct = document.getElementById('gama-oro-pct');
    const elTotal = document.getElementById('gamas-total');
    
    if(elDiamantePlusPct) elDiamantePlusPct.textContent = pctDiamantePlus + '%';
    if(elDiamantePct) elDiamantePct.textContent = pctDiamante + '%';
    if(elPlatinoPlusPct) elPlatinoPlusPct.textContent = pctPlatinoPlus + '%';
    if(elPlatinoPct) elPlatinoPct.textContent = pctPlatino + '%';
    if(elOroPct) elOroPct.textContent = pctOro + '%';
    if(elTotal) elTotal.textContent = total;
    
    console.log('[Gamas] DiamantePlus:', diamantePlus, '| Diamante:', diamante, '| PlatinoPlus:', platinoPlus, '| Platino:', platino, '| Oro:', oro, '| Total:', total);
}

// Calcular tipo de atención (porcentajes)
function calcularTipoAtencion() {
    const adulto = parseInt(document.getElementById('tipoaten-adulto')?.value) || 0;
    const tinnitus = parseInt(document.getElementById('tipoaten-tinnitus')?.value) || 0;
    const pediatrico = parseInt(document.getElementById('tipoaten-pediatrico')?.value) || 0;
    const total = adulto + tinnitus + pediatrico;
    
    const elTotal = document.getElementById('tipoaten-total');
    if(elTotal) elTotal.textContent = total;
}

// Cargar PC/PNC automáticamente en el informe basado en el centro
function cargarPCPNCInforme(centroNombre) {
    if(!centroNombre) return;
    
    const centroUpper = centroNombre.toUpperCase().trim();
    let pcpnc = '-';
    
    // Buscar en centrosData por código o nombre
    const centro = centrosData.find(c => 
        c.c === centroUpper || 
        (c.n && c.n.toUpperCase().includes(centroUpper)) ||
        centroUpper.includes(c.n?.toUpperCase() || '')
    );
    
    if(centro && centro.pc) {
        pcpnc = centro.pc;
    }
    
    const inputPCPNC = document.getElementById('inf-pcpnc');
    if(inputPCPNC) {
        inputPCPNC.value = pcpnc;
        inputPCPNC.style.color = pcpnc === 'PC' ? '#10b981' : (pcpnc === 'PNC' ? '#ef4444' : '#888');
    }
}

// Cargar Cifras de Venta Audio automáticamente en el informe
function cargarCifrasVentaInforme(centroNombre) {
    if(!centroNombre || centroNombre.length < 2) return;
    
    var centroUpper = centroNombre.toUpperCase().trim();
    var codigoCentro = null;
    
    // 1. Buscar en centrosData
    for(var i = 0; i < centrosData.length; i++) {
        var c = centrosData[i];
        if(!c.c || !c.n) continue;
        
        // Coincidencia por nombre (contiene)
        if(c.n.toUpperCase().indexOf(centroUpper) !== -1 || centroUpper.indexOf(c.n.toUpperCase()) !== -1) {
            codigoCentro = c.c;
            break;
        }
    }
    
    // 2. Buscar por palabras clave si no encontró
    if(!codigoCentro) {
        var palabras = centroUpper.replace(/C\.C\.|CC\./g, '').trim().split(/\s+/);
        for(var i = 0; i < centrosData.length; i++) {
            var c = centrosData[i];
            if(!c.n) continue;
            var nombreUpper = c.n.toUpperCase();
            for(var j = 0; j < palabras.length; j++) {
                if(palabras[j].length > 2 && nombreUpper.indexOf(palabras[j]) !== -1) {
                    codigoCentro = c.c;
                    break;
                }
            }
            if(codigoCentro) break;
        }
    }
    
    // 3. Actualizar campos si encontró el centro Y tiene cifras
    if(codigoCentro && cifrasVentaAudio && cifrasVentaAudio[codigoCentro]) {
        var cifras = cifrasVentaAudio[codigoCentro];
        
        var elAcum = document.getElementById('inf-cifra-acum');
        var elPrev = document.getElementById('inf-cifra-prev');
        var elDif = document.getElementById('inf-cifra-dif');
        var elPct = document.getElementById('inf-cifra-pct');
        
        if(elAcum) elAcum.value = Math.round(cifras.acumulado);
        if(elPrev) elPrev.value = Math.round(cifras.previsto);
        
        var dif = cifras.diferencia;
        if(elDif) {
            elDif.textContent = (dif >= 0 ? '+' : '') + Math.round(dif).toLocaleString('es-ES') + ' €';
            elDif.style.color = dif >= 0 ? '#10b981' : '#ef4444';
        }
        
        // Mostrar % crecimiento sobre previsto con flecha
        var pct = cifras.pctCumplimiento;
        if(elPct) {
            var crecimiento = pct - 100; // Diferencia respecto al 100%
            if(crecimiento >= 0) {
                elPct.innerHTML = '<span style="color:#C9A227">▲ +' + crecimiento.toFixed(1) + '%</span>';
            } else {
                elPct.innerHTML = '<span style="color:#8B7355">▼ ' + crecimiento.toFixed(1) + '%</span>';
            }
        }
    }
}

// Carga automática de gamas, tipo de atención y KPIs desde Funnel del centro
async function cargarGamasAutomatico(centroNombre) {
    if(!centroNombre) return;
    
    const centroUpper = centroNombre.toUpperCase().trim();
    
    // Buscar código del centro - primero intentar como código directo
    let codigoCentro = null;
    
    // Si es un código de 4 caracteres y existe en centrosData, usarlo directamente
    if(centroUpper.length <= 5) {
        var directMatch = centrosData.find(function(c) { return c.c === centroUpper; });
        if(directMatch) codigoCentro = directMatch.c;
    }
    
    // Si no, buscar en la lista maestra por nombre
    if(!codigoCentro) {
        for(const c of listaCentrosMaestra) {
            if(c.nombre.toUpperCase().includes(centroUpper) || centroUpper.includes(c.nombre.toUpperCase()) || c.cod === centroUpper) {
                codigoCentro = c.cod;
                break;
            }
        }
    }
    
    // Fallback: buscar en centrosData por nombre
    if(!codigoCentro) {
        var cMatch = centrosData.find(function(c) { return c.n && c.n.toUpperCase().includes(centroUpper); });
        if(cMatch) codigoCentro = cMatch.c;
    }
    
    if(!codigoCentro) {
        codigoCentro = centroUpper.length === 4 ? centroUpper : null;
    }
    
    if(!codigoCentro) {
        console.log('[Funnel Centro] Centro no encontrado:', centroNombre);
        return;
    }
    
    console.log('[Funnel Centro] Cargando datos desde:', codigoCentro);
    
    try {
        if(!FirebaseManagerAdmin.isReady()) {
            await FirebaseManagerAdmin.init();
        }
        
        const datos = await FirebaseManagerAdmin.loadCentro(codigoCentro);
        if(!datos || !datos.audio) {
            console.log('[Funnel Centro] Sin datos de audiometrías para:', codigoCentro);
            return;
        }
        
        // Contadores del funnel del centro
        let gamaDiamantePlus = 0, gamaDiamante = 0, gamaPlatinoPLus = 0, gamaPlatino = 0, gamaOro = 0;
        let tipoAdulto = 0, tipoTinnitus = 0, tipoPediatrico = 0;
        let totalAudiencias = 0, totalConPerdida = 0, totalPruebas = 0, totalVentas = 0;
        let totalNoPrueba = 0, totalDevuelve = 0, totalTapones = 0;
        let totalBinaural = 0, totalImporte = 0;
        let totalMgm = 0, totalRenove = 0, totalInfinity = 0, totalSeguros = 0;
        
        datos.audio.forEach(fila => {
            // Solo contar filas con fecha (índice 0)
            if(!fila[0]) return;
            totalAudiencias++;
            
            // PÉRDIDA (índice 6)
            const perdida = (fila[6] || '').toUpperCase();
            if(perdida === 'ADAPTABLE') totalConPerdida++;
            if(perdida.includes('TAPÓN') || perdida.includes('CERA')) totalTapones++;
            
            // CAPACITACIÓN (índice 8)
            if(fila[8] === 'EN PRUEBA') totalPruebas++;
            if(fila[8] === 'NO PRUEBA') totalNoPrueba++;
            
            // COMPRA (índice 11) y GAMA (índice 10)
            if(fila[11] === 'SI') {
                totalVentas++;
                const gamaStr = (fila[10] || '').toString().toUpperCase();
                if(gamaStr === 'DIAMANTE PLUS' || gamaStr === 'DIAMANTE PLUS +') gamaDiamantePlus++;
                else if(gamaStr === 'DIAMANTE') gamaDiamante++;
                else if(gamaStr === 'PLATINO PLUS') gamaPlatinoPLus++;
                else if(gamaStr === 'PLATINO') gamaPlatino++;
                else if(gamaStr === 'ORO') gamaOro++;
                
                // Binaural (índice 7)
                if(fila[7] === 'SI') totalBinaural++;
                
                // Importe (índice 9)
                totalImporte += parseFloat(fila[9]) || 0;
            }
            if(fila[11] === 'DEVUELVE') totalDevuelve++;
            
            // TIPO VENTA (índice 12)
            const tipoVenta = (fila[12] || '').toUpperCase();
            if(tipoVenta.includes('MGM')) totalMgm++;
            if(tipoVenta.includes('RENOVE')) totalRenove++;
            if(tipoVenta.includes('INFINITY')) totalInfinity++;
            
            // SEGURO (índice 13)
            if(fila[13] === 'SI') totalSeguros++;
            
            // TIPO ATENCIÓN (índice 4)
            const tipoAt = (fila[4] || '').toString().toUpperCase();
            if(tipoAt.includes('TINNITUS')) tipoTinnitus++;
            else if(tipoAt.includes('PEDIÁTRICO') || tipoAt.includes('PEDIATRICO')) tipoPediatrico++;
            else if(tipoAt.includes('ADULTO') || tipoAt) tipoAdulto++;
        });
        
        // Calcular KPIs
        const totalFugas = totalNoPrueba + totalDevuelve + totalTapones;
        const convPrueba = totalConPerdida > 0 ? Math.round((totalPruebas / totalConPerdida) * 100) : 0;
        const convVenta = totalPruebas > 0 ? Math.round((totalVentas / totalPruebas) * 100) : 0;
        const pctBinaural = totalVentas > 0 ? Math.round((totalBinaural / totalVentas) * 100) : 0;
        const ticketMedio = totalVentas > 0 ? Math.round(totalImporte / totalVentas) : 0;
        
        // Solo actualizar GAMAS si no hay datos previos
        const currentDiamantePlus = parseInt(document.getElementById('gama-diamante-plus')?.value) || 0;
        const currentDiamante = parseInt(document.getElementById('gama-diamante')?.value) || 0;
        const currentPlatinoPlus = parseInt(document.getElementById('gama-platino-plus')?.value) || 0;
        const currentPlatino = parseInt(document.getElementById('gama-platino')?.value) || 0;
        const currentOro = parseInt(document.getElementById('gama-oro')?.value) || 0;
        
        if(currentDiamantePlus === 0 && currentDiamante === 0 && currentPlatinoPlus === 0 && currentPlatino === 0 && currentOro === 0) {
            document.getElementById('gama-diamante-plus').value = gamaDiamantePlus;
            document.getElementById('gama-diamante').value = gamaDiamante;
            document.getElementById('gama-platino-plus').value = gamaPlatinoPLus;
            document.getElementById('gama-platino').value = gamaPlatino;
            document.getElementById('gama-oro').value = gamaOro;
            calcularGamas();
        }
        
        // Solo actualizar TIPO ATENCIÓN si no hay datos previos
        const currentAdulto = parseInt(document.getElementById('tipoaten-adulto')?.value) || 0;
        const currentTinnitus = parseInt(document.getElementById('tipoaten-tinnitus')?.value) || 0;
        const currentPediatrico = parseInt(document.getElementById('tipoaten-pediatrico')?.value) || 0;
        
        if(currentAdulto === 0 && currentTinnitus === 0 && currentPediatrico === 0) {
            document.getElementById('tipoaten-adulto').value = tipoAdulto;
            document.getElementById('tipoaten-tinnitus').value = tipoTinnitus;
            document.getElementById('tipoaten-pediatrico').value = tipoPediatrico;
            calcularTipoAtencion();
        }
        
        // Actualizar elementos del informe con KPIs del funnel si existen
        const elInfConvPrueba = document.getElementById('inf-conv-prueba');
        const elInfConvVenta = document.getElementById('inf-conv-venta');
        const elInfBinaural = document.getElementById('inf-binaural');
        const elInfTicket = document.getElementById('inf-ticket-medio');
        const elInfFugas = document.getElementById('inf-fugas');
        
        if(elInfConvPrueba) elInfConvPrueba.textContent = convPrueba + '%';
        if(elInfConvVenta) elInfConvVenta.textContent = convVenta + '%';
        if(elInfBinaural) elInfBinaural.textContent = pctBinaural + '%';
        if(elInfTicket) elInfTicket.textContent = ticketMedio.toLocaleString('es-ES') + '€';
        if(elInfFugas) elInfFugas.textContent = totalFugas;
        
        console.log('[Funnel Centro] ✓ Datos cargados -', 
            'Ventas:', totalVentas, 
            'Conv.Prueba:', convPrueba + '%',
            'Conv.Venta:', convVenta + '%',
            'Gamas D/P/O:', gamaDiamante + '/' + gamaPlatino + '/' + gamaOro);
        
    } catch(e) {
        console.warn('[Funnel Centro] Error cargando desde Firebase:', e);
        // Fallback: usar funnelDataCache si está disponible
        try {
            if(typeof funnelDataCache !== 'undefined' && funnelDataCache[codigoCentro]) {
                var kf = funnelDataCache[codigoCentro].kpis || {};
                console.log('[Funnel Centro] Fallback a funnelDataCache:', codigoCentro);
                // Rellenar funnel data
                var elV = document.getElementById('inf-funnel-ventas');
                var elC = document.getElementById('inf-funnel-capacitacion');
                var elD = document.getElementById('inf-funnel-devoluciones');
                if(elV && elV.value == '0') elV.value = kf.ventas || 0;
                if(elC && elC.value == '0') elC.value = kf.prueban || 0;
                if(elD && elD.value == '0') elD.value = kf.devoluciones || 0;
            }
        } catch(e2) { console.warn('[Funnel Centro] Fallback also failed:', e2); }
    }
}

function initDashboardRadars() {
    // Destruir anteriores
    Object.values(dashRadarCharts).forEach(c => { if(c) c.destroy(); });
    dashRadarCharts = {};
    
    const radarOptions = {
        responsive:true, 
        maintainAspectRatio:false,
        plugins:{legend:{display:false}}, 
        scales:{
            r:{
                beginAtZero:true,
                max:100,
                min:0,
                ticks:{display:false},
                grid:{color:'#e0d9c8', lineWidth:1},
                angleLines:{color:'#e0d9c8'},
                pointLabels:{color:'#8B7355', font:{size:8, weight:'600'}, padding: 2}
            }
        }
    };
    
    // Radar PIA vacío
    const ctxPIA = document.getElementById('radar-dash-pia');
    if(ctxPIA) {
        dashRadarCharts.pia = new Chart(ctxPIA, {
            type: 'radar',
            data: {
                labels: ['Gabinete', 'Anamnes.', 'Timpano.', 'Capacit.', 'Stock', 'Tchin T.', 'NextYear', 'Infinity', 'Comprom.'],
                datasets: [{data: [0,0,0,0,0,0,0,0,0], backgroundColor: 'rgba(201,162,39,0.3)', borderColor: '#C9A227', borderWidth: 2, pointBackgroundColor: '#C9A227', pointRadius: 3}]
            },
            options: radarOptions
        });
    }
    
    // Radar RT vacío
    const ctxRT = document.getElementById('radar-dash-rt');
    if(ctxRT) {
        dashRadarCharts.rt = new Chart(ctxRT, {
            type: 'radar',
            data: {
                labels: ['Incógnito', 'Condic.', 'Funnel', 'Stock', 'Form.Aud.', 'Sinergias', 'Screen.', 'Derivac.'],
                datasets: [{data: [0,0,0,0,0,0,0,0], backgroundColor: 'rgba(201,162,39,0.25)', borderColor: '#B8963D', borderWidth: 2, pointBackgroundColor: '#B8963D', pointRadius: 3}]
            },
            options: radarOptions
        });
    }
    
    // Radar FORMACIÓN vacío
    const ctxForm = document.getElementById('radar-dash-form');
    if(ctxForm) {
        dashRadarCharts.form = new Chart(ctxForm, {
            type: 'radar',
            data: {
                labels: ['Onboard.', 'WSA-Star.', 'PIA', 'Campañas', 'Eq.Ópt.', 'HIT', 'Aj.Rem.', 'Hab.Vta.'],
                datasets: [{data: [0,0,0,0,0,0,0,0], backgroundColor: 'rgba(212,175,55,0.3)', borderColor: '#D4AF37', borderWidth: 2, pointBackgroundColor: '#D4AF37', pointRadius: 3}]
            },
            options: radarOptions
        });
    }
    
    // Radar KPIs vacío
    const ctxKpis = document.getElementById('radar-dash-kpis');
    if(ctxKpis) {
        dashRadarCharts.kpis = new Chart(ctxKpis, {
            type: 'radar',
            data: {
                labels: ['Ayudas', 'Imagen', 'Seguro', 'Renove', 'MGM', 'HIT +34M'],
                datasets: [{data: [0,0,0,0,0,0], backgroundColor: 'rgba(201,162,39,0.3)', borderColor: '#C9A227', borderWidth: 2, pointBackgroundColor: '#C9A227', pointRadius: 3}]
            },
            options: radarOptions
        });
    }
}

function imprimirDashboard() {
    // Actualizar fecha de impresión
    const fechaEl = document.getElementById('dash-print-fecha');
    if(fechaEl) {
        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        fechaEl.textContent = 'Generado: ' + now.toLocaleDateString('es-ES', options);
    }
    
    // Mostrar header de impresión
    const headerPrint = document.querySelector('.dash-print-header');
    if(headerPrint) headerPrint.style.display = 'flex';
    
    // Añadir clase para estilos de impresión
    document.body.classList.add('print-dashboard');
    
    // Imprimir
    setTimeout(() => {
        window.print();
        
        // Restaurar después de imprimir
        setTimeout(() => {
            document.body.classList.remove('print-dashboard');
            if(headerPrint) headerPrint.style.display = 'none';
        }, 500);
    }, 300);
}

function updateDashboard() {
    // Aplicar filtro de delegado regional si está activo
    const filtroDelegado = document.getElementById('filtro-delegado-dashboard');
    const delegadoSeleccionado = filtroDelegado ? filtroDelegado.value : '';
    const centrosFiltrados = delegadoSeleccionado ? getCentrosPorDelegado(delegadoSeleccionado) : null;
    
    // Filtrar informesFinalizados según delegado
    const todosInformes = centrosFiltrados
        ? informesFinalizados.filter(p => {
            if(p.delegadoRegional === delegadoSeleccionado) return true;
            if(p.centro) {
                const codigoCentro = p.centro.split(' ')[0].toUpperCase();
                return centrosFiltrados.includes(codigoCentro);
            }
            return false;
        })
        : [...informesFinalizados];
    
    const centrosUnicos = [...new Set(todosInformes.map(p => p.centro))];
    var visitadosEl = document.getElementById('dash-centros-visit');
    if(visitadosEl) visitadosEl.textContent = centrosUnicos.length;
    
    // Inicializar radares vacíos
    initDashboardRadars();
    
    // Si no hay informes, NO resetear conversiones si Firebase tiene datos
    if(todosInformes.length === 0) {
        // Promedio general de informes sí se resetea
        var promEl = document.getElementById('dash-prom-general');
        if(promEl) promEl.textContent = '0%';
        
        // Conversiones: SOLO resetear si Firebase NO tiene datos
        if(!datosFirebaseGlobal || !datosFirebaseGlobal.cargado || datosFirebaseGlobal.totalAudiencias === 0) {
            var convPruebaEl = document.getElementById('dash-conv-prueba');
            var convVentaEl = document.getElementById('dash-conv-venta');
            if(convPruebaEl) convPruebaEl.textContent = '0%';
            if(convVentaEl) convVentaEl.textContent = '0%';
            console.log('[Dashboard] ⚠️ Sin informes ni datos Firebase - conversiones en 0%');
        } else {
            console.log('[Dashboard] ℹ️ Sin informes pero Firebase tiene datos - manteniendo conversiones de Firebase');
        }
        
        // Barras de bloques a 0 (esto sí se resetea porque son datos de informes)
        const ids = ['pia', 'form', 'com', 'ayu', 'comp', 'rt', 'age', 'conv'];
        ids.forEach(id => {
            var barEl = document.getElementById('dash-bar-' + id);
            var aplEl = document.getElementById('dash-apl-' + id);
            if(barEl) barEl.style.width = '0%';
            if(aplEl) aplEl.textContent = '0%';
        });
        
        // Leyendas vacías
        const leyendaPia = document.getElementById('leyenda-pia');
        const leyendaRt = document.getElementById('leyenda-rt');
        const leyendaForm = document.getElementById('leyenda-form');
        const leyendaKpis = document.getElementById('leyenda-kpis');
        if(leyendaPia) leyendaPia.innerHTML = '-';
        if(leyendaRt) leyendaRt.innerHTML = '-';
        if(leyendaForm) leyendaForm.innerHTML = '-';
        if(leyendaKpis) leyendaKpis.innerHTML = '-';
        
        // Indicadores de radares
        ['radar-pia-total', 'radar-rt-total', 'radar-form-total', 'radar-kpis-total'].forEach(id => {
            var el = document.getElementById(id);
            if(el) el.textContent = '(0 inf.)';
        });
        
        // Ranking vacío
        const tbody = document.getElementById('dash-ranking-tbody');
        if(tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#aaa">Sin informes finalizados</td></tr>';
        
        // Dibujar pentágono vacío
        setTimeout(dibujarPentagonoDashboard, 100);
        
        return;
    }
    
    // Promedio general
    const promGen = Math.round(todosInformes.reduce((a,b) => a + b.resultado, 0) / todosInformes.length);
    var promEl2 = document.getElementById('dash-prom-general');
    if(promEl2) promEl2.textContent = promGen + '%';
    
    // Calcular promedios de conversión a prueba y venta SOLO DE INFORMES
    let sumConvPrueba = 0, sumConvVenta = 0, countConv = 0;
    let fechaMasRecienteInforme = null;
    
    todosInformes.forEach(p => {
        if(p.respuestas) {
            sumConvPrueba += (p.respuestas[99] || 0);
            sumConvVenta += (p.respuestas[100] || 0);
            countConv++;
            // Tracking de fecha más reciente de informes
            if(p.fecha) {
                const fechaInf = new Date(p.fecha);
                if(!isNaN(fechaInf) && (!fechaMasRecienteInforme || fechaInf > fechaMasRecienteInforme)) {
                    fechaMasRecienteInforme = fechaInf;
                }
            }
        }
    });
    const promConvPrueba = countConv > 0 ? Math.round(sumConvPrueba / countConv) : 0;
    const promConvVenta = countConv > 0 ? Math.round(sumConvVenta / countConv) : 0;
    
    // ═══════════════════════════════════════════════════════════════
    // LÓGICA DE PRIORIDAD: Firebase vs Informes
    // Por defecto usar Firebase, solo usar informes si son MÁS RECIENTES
    // ═══════════════════════════════════════════════════════════════
    var convPruebaEl = document.getElementById('dash-conv-prueba');
    var convVentaEl = document.getElementById('dash-conv-venta');
    
    let usarInformes = false;
    
    // Si Firebase está cargado, comparar fechas
    if(datosFirebaseGlobal && datosFirebaseGlobal.cargado && datosFirebaseGlobal.fechaMasReciente) {
        // Si hay informes más recientes que Firebase, usar informes
        if(fechaMasRecienteInforme && fechaMasRecienteInforme > datosFirebaseGlobal.fechaMasReciente) {
            usarInformes = true;
            console.log('[Dashboard Conv] 📋 Usando INFORMES (más recientes):', 
                fechaMasRecienteInforme.toISOString().split('T')[0], 
                '> Firebase:', datosFirebaseGlobal.fechaMasReciente.toISOString().split('T')[0]);
        } else {
            console.log('[Dashboard Conv] 🔥 Usando FIREBASE (más reciente o igual)');
        }
    } else if(!datosFirebaseGlobal || !datosFirebaseGlobal.cargado) {
        // Firebase no cargado, usar informes si hay
        if(countConv > 0) {
            usarInformes = true;
            console.log('[Dashboard Conv] 📋 Firebase no cargado, usando INFORMES');
        }
    }
    
    // Aplicar la fuente de datos correcta
    if(usarInformes && countConv > 0) {
        if(convPruebaEl) convPruebaEl.textContent = promConvPrueba + '%';
        if(convVentaEl) convVentaEl.textContent = promConvVenta + '%';
    }
    // Si no usarInformes, las conversiones ya fueron actualizadas por cargarGamasFirebase()
    
    // Calcular promedios por bloque
    const promediosBloques = {PIA:0, FORMACION:0, COMUNICACION:0, AYUDAS:0, COMPLEMENTARIAS:0, RT:0, AGENDA:0, CONVERSIONES:0};
    const kpisPromedio = {ayudas:0, imagen:0, seguro:0, renove:0, mgm:0, hit34:0};
    
    todosInformes.forEach(p => {
        if(p.respuestas) {
            const bloquesPct = calcularBloquesPct(p.respuestas);
            Object.keys(promediosBloques).forEach(b => {
                promediosBloques[b] += bloquesPct[b] || 0;
            });
            kpisPromedio.ayudas += (p.respuestas[69] === 'si' ? 100 : 0);
            kpisPromedio.imagen += (p.respuestas[66] === 'si' ? 100 : 0);
            kpisPromedio.seguro += (p.respuestas[46] === 'si' ? 100 : 0);
            kpisPromedio.renove += (p.respuestas[58] === 'si' ? 100 : 0);
            kpisPromedio.mgm += (p.respuestas[57] === 'si' ? 100 : 0);
            kpisPromedio.hit34 += (p.respuestas[52] === 'si' ? 100 : 0);
        }
    });
    
    const n = todosInformes.length;
    Object.keys(promediosBloques).forEach(b => { promediosBloques[b] = Math.round(promediosBloques[b] / n); });
    Object.keys(kpisPromedio).forEach(k => { kpisPromedio[k] = Math.round(kpisPromedio[k] / n); });
    
    // Actualizar barras
    const pesos = {PIA:25, FORMACION:15, COMUNICACION:15, AYUDAS:4, COMPLEMENTARIAS:6, RT:25, AGENDA:10, CONVERSIONES:0};
    const ids = {PIA:'pia', FORMACION:'form', COMUNICACION:'com', AYUDAS:'ayu', COMPLEMENTARIAS:'comp', RT:'rt', AGENDA:'age', CONVERSIONES:'conv'};
    
    Object.keys(promediosBloques).forEach(b => {
        const id = ids[b];
        const pct = promediosBloques[b];
        const peso = pesos[b];
        var barEl = document.getElementById('dash-bar-' + id);
        var aplEl = document.getElementById('dash-apl-' + id);
        if(barEl) barEl.style.width = pct + '%';
        if(aplEl) aplEl.textContent = (peso > 0 ? ((pct/100)*peso).toFixed(1) : '0.0') + '%';
    });
    
    // Actualizar radares con datos
    if(dashRadarCharts.kpis) {
        dashRadarCharts.kpis.data.datasets[0].data = [kpisPromedio.ayudas, kpisPromedio.imagen, kpisPromedio.seguro, kpisPromedio.renove, kpisPromedio.mgm, kpisPromedio.hit34];
        dashRadarCharts.kpis.update();
    }
    
    // Actualizar indicadores de total de informes en radares
    const radarTotalKpis = document.getElementById('radar-kpis-total');
    const radarTotalRt = document.getElementById('radar-rt-total');
    const radarTotalPia = document.getElementById('radar-pia-total');
    const infText = '(' + n + ' inf.)';
    if(radarTotalKpis) radarTotalKpis.textContent = infText;
    if(radarTotalRt) radarTotalRt.textContent = infText;
    if(radarTotalPia) radarTotalPia.textContent = infText;
    
    // RT data - preguntas individuales (binario)
    const rtPreguntas = [78,79,80,82,83,84,86,88];
    const rtData = rtPreguntas.map(p => {
        let sum = 0;
        todosInformes.forEach(pr => { if(pr.respuestas) sum += (pr.respuestas[p] === 'si' ? 100 : 0); });
        return Math.round(sum/n);
    });
    if(dashRadarCharts.rt) {
        dashRadarCharts.rt.data.datasets[0].data = rtData;
        dashRadarCharts.rt.update();
    }
    
    // PIA data - preguntas individuales (binario)
    const piaPreguntas = [1,12,17,28,29,42,43,44,47];
    const piaData = piaPreguntas.map(p => {
        let sum = 0;
        todosInformes.forEach(pr => { if(pr.respuestas) sum += (pr.respuestas[p] === 'si' ? 100 : 0); });
        return Math.round(sum/n);
    });
    if(dashRadarCharts.pia) {
        dashRadarCharts.pia.data.datasets[0].data = piaData;
        dashRadarCharts.pia.update();
    }
    
    // FORMACIÓN data - preguntas individuales (binario)
    const formPreguntas = [58,59,60,61,62,63,64,65];
    const formData = formPreguntas.map(p => {
        let sum = 0;
        todosInformes.forEach(pr => { if(pr.respuestas) sum += (pr.respuestas[p] === 'si' ? 100 : 0); });
        return Math.round(sum/n);
    });
    if(dashRadarCharts.form) {
        dashRadarCharts.form.data.datasets[0].data = formData;
        dashRadarCharts.form.update();
    }
    
    // Actualizar indicador de FORMACIÓN
    const radarFormTotal = document.getElementById('radar-form-total');
    if(radarFormTotal) radarFormTotal.textContent = '(' + n + ' inf.)';
    
    // Actualizar leyendas con promedios
    const leyendaPia = document.getElementById('leyenda-pia');
    const leyendaRt = document.getElementById('leyenda-rt');
    const leyendaForm = document.getElementById('leyenda-form');
    const leyendaKpis = document.getElementById('leyenda-kpis');
    
    const piaLabels = ['Gabinete','Anamnesis','Timpano.','Capacit.','Stock','Tchin','NextYear','Infinity','Comprom.'];
    const rtLabels = ['Incógnito','Condic.','Funnel','Stock','Form.Audio','Sinergias','Screen.','Deriv.'];
    const formLabels = ['Onboard.','WSA-Star.','PIA','Campañas','Eq.Ópt.','HIT','Aj.Rem.','Hab.Vta'];
    const kpisLabels = ['Ayudas','Imagen','Seguro','Renove','MGM','HIT+34'];
    const kpisData = [kpisPromedio.ayudas, kpisPromedio.imagen, kpisPromedio.seguro, kpisPromedio.renove, kpisPromedio.mgm, kpisPromedio.hit34];
    
    if(leyendaPia) leyendaPia.innerHTML = piaLabels.map((l,i) => '<span style="color:' + (piaData[i]>=80?'#166534':piaData[i]>=50?'#b8960c':'#dc2626') + '">' + l + ':' + piaData[i] + '%</span>').join(' · ');
    if(leyendaRt) leyendaRt.innerHTML = rtLabels.map((l,i) => '<span style="color:' + (rtData[i]>=80?'#166534':rtData[i]>=50?'#b8960c':'#dc2626') + '">' + l + ':' + rtData[i] + '%</span>').join(' · ');
    if(leyendaForm) leyendaForm.innerHTML = formLabels.map((l,i) => '<span style="color:' + (formData[i]>=80?'#166534':formData[i]>=50?'#b8960c':'#dc2626') + '">' + l + ':' + formData[i] + '%</span>').join(' · ');
    if(leyendaKpis) leyendaKpis.innerHTML = kpisLabels.map((l,i) => '<span style="color:' + (kpisData[i]>=80?'#166534':kpisData[i]>=50?'#b8960c':'#dc2626') + '">' + l + ':' + kpisData[i] + '%</span>').join(' · ');
    
    // Actualizar semáforo KPIs del dashboard - PROMEDIOS en %
    // Para binarios: % de informes con SI
    // Para numéricos: promedio de valores
    let sumHit = 0, sumMgm = 0, sumRenove = 0, sumSeguro = 0, sumInfinity = 0, sumTchin = 0, sumScreen = 0, sumDeriv = 0;
    todosInformes.forEach(p => {
        if(p.respuestas) {
            // HIT+34 = pregunta 52 (binario)
            sumHit += (p.respuestas[52] === 'si' ? 100 : 0);
            // MGM = pregunta 57 (binario - fomenta MGM)
            sumMgm += (p.respuestas[57] === 'si' ? 100 : 0);
            // RENOVE = pregunta 58 (binario - fomenta RENOVE)
            sumRenove += (p.respuestas[58] === 'si' ? 100 : 0);
            // SEGURO = pregunta 46 (binario - ofrece seguro)
            sumSeguro += (p.respuestas[46] === 'si' ? 100 : 0);
            // INFINITY = pregunta 44 (binario)
            sumInfinity += (p.respuestas[44] === 'si' ? 100 : 0);
            // TCHIN = pregunta 42 (binario)
            sumTchin += (p.respuestas[42] === 'si' ? 100 : 0);
            // SCREENING = pregunta 98 (porcentaje directo)
            sumScreen += (p.respuestas[98] || 0);
            // DERIVACIONES = pregunta 87 > 0 cuenta como cumplido
            sumDeriv += (p.respuestas[87] > 0 ? 100 : 0);
        }
    });
    
    // Calcular promedios en %
    const avgHit = Math.round(sumHit / n);
    const avgMgm = Math.round(sumMgm / n);
    const avgRenove = Math.round(sumRenove / n);
    const avgSeguro = Math.round(sumSeguro / n);
    const avgInfinity = Math.round(sumInfinity / n);
    const avgTchin = Math.round(sumTchin / n);
    const avgScreen = Math.round(sumScreen / n);
    const avgDeriv = Math.round(sumDeriv / n);
    
    // Actualizar valores del semáforo con %
    const semIds = ['hit', 'mgm', 'renove', 'seguro', 'infinity', 'tchin', 'screen', 'deriv'];
    const semVals = [avgHit, avgMgm, avgRenove, avgSeguro, avgInfinity, avgTchin, avgScreen, avgDeriv];
    
    semIds.forEach((id, idx) => {
        const ledEl = document.getElementById('sem-' + id);
        const valEl = document.getElementById('sem-' + id + '-val');
        const val = semVals[idx];
        if(valEl) valEl.textContent = val + '%';
        if(ledEl) {
            // Verde >= 80%, Ámbar >= 50%, Rojo < 50%
            if(val >= 80) {
                ledEl.style.background = '#C9A227';
                ledEl.style.boxShadow = '0 0 8px rgba(34,197,94,0.4)';
            } else if(val >= 50) {
                ledEl.style.background = '#b8960c';
                ledEl.style.boxShadow = '0 0 8px rgba(245,158,11,0.4)';
            } else {
                ledEl.style.background = '#5c5c5c';
                ledEl.style.boxShadow = '0 0 8px rgba(239,68,68,0.4)';
            }
        }
    });
    
    // Actualizar indicador de total de informes
    const totalInformesEl = document.getElementById('sem-total-informes');
    if(totalInformesEl) {
        totalInformesEl.textContent = '(promedio de ' + n + ' informe' + (n !== 1 ? 's' : '') + ')';
    }
    
    // Ranking tabla (top 10 ordenado por nota)
    const ranking = [...todosInformes].sort((a,b) => b.resultado - a.resultado).slice(0,10);
    const tbody = document.getElementById('dash-ranking-tbody');
    if(!tbody) return;
    if(ranking.length > 0) {
        tbody.innerHTML = ranking.map((p,i) => {
            const medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : (i+1);
            const cat = getCategoria(p.resultado);
            const delegAudio = p.responsable || '-';
            const delegRegional = p.delegadoRegional || '-';
            return '<tr style="border-bottom:1px solid #eee;' + (i < 3 ? 'background:#fffbeb' : '') + '">' +
                '<td style="padding:5px 4px;font-weight:600">' + medal + '</td>' +
                '<td style="padding:5px 4px">' + (p.centro || '-') + '</td>' +
                '<td style="padding:5px 4px;color:#888">' + (p.fecha || '-') + '</td>' +
                '<td style="padding:5px 4px">' + delegAudio + '</td>' +
                '<td style="padding:5px 4px">' + delegRegional + '</td>' +
                '<td style="padding:5px 4px;text-align:right;font-weight:700;color:' + cat.color + '">' + p.resultado + '%</td>' +
            '</tr>';
        }).join('');
    } else {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#aaa">Sin visitas registradas</td></tr>';
    }
    
    // Dibujar pentágono del Dashboard
    setTimeout(dibujarPentagonoDashboard, 100);
}

// ═══════════════════════════════════════════════════════════════
// FILTROS DEL DASHBOARD - DELEGADO + PC/PNC + FRANQUICIA/SUCURSAL
// ═══════════════════════════════════════════════════════════════

// Variable para almacenar los centros filtrados
var centrosFiltradosDashboard = null;

function aplicarFiltrosDashboard() {
    var filtroDelegado = document.getElementById('filtro-delegado-dashboard').value;
    var filtroPC = document.getElementById('filtroDashPC').value;
    var filtroPropiedad = document.getElementById('filtroDashPropiedad').value;
    
    // Obtener centros del delegado seleccionado
    var centrosDelegado = filtroDelegado ? getCentrosPorDelegado(filtroDelegado) : null;
    
    // Filtrar centrosData según los criterios
    var centrosFiltrados = centrosData.filter(function(c) {
        // Excluir DEMO y PRUEBAS
        if(c.t === 'DEMO' || c.t === 'PRUEBAS') return false;
        
        // Filtro por delegado regional
        if(centrosDelegado && centrosDelegado.indexOf(c.c) === -1) return false;
        
        // Filtro PC/PNC
        if(filtroPC && c.pc !== filtroPC) return false;
        
        // Filtro Franquicia/Sucursal
        if(filtroPropiedad && c.pr !== filtroPropiedad) return false;
        
        return true;
    });
    
    // Guardar lista de códigos filtrados
    centrosFiltradosDashboard = centrosFiltrados.map(function(c) { return c.c; });
    
    // Actualizar contador
    var countEl = document.getElementById('filtrosDashCount');
    if(countEl) countEl.textContent = centrosFiltrados.length;
    
    // Actualizar todas las estadísticas del dashboard con los centros filtrados
    actualizarDashboardFiltrado(centrosFiltrados);
    
    // Actualizar gráficas de PROCESOS con informes filtrados
    actualizarDashboardMedia();
    
    // IMPORTANTE: Actualizar radares y pentágono con datos filtrados
    updateDashboard();
    dibujarPentagonoDashboard();
    
    // Recargar datos de Firebase filtrados (FUNNEL)
    cargarGamasFirebase();
}

function limpiarFiltrosDashboard() {
    document.getElementById('filtro-delegado-dashboard').value = '';
    document.getElementById('filtroDashPC').value = '';
    document.getElementById('filtroDashPropiedad').value = '';
    centrosFiltradosDashboard = null;
    
    // Actualizar contador
    var totalCentros = centrosData.filter(function(c) { return c.t !== 'DEMO' && c.t !== 'PRUEBAS'; }).length;
    var countEl = document.getElementById('filtrosDashCount');
    if(countEl) countEl.textContent = totalCentros;
    
    // Restaurar dashboard completo
    updateDashboard();
    actualizarDashboardMedia();
}

function actualizarDashboardFiltrado(centrosFiltrados) {
    var codigosFiltrados = centrosFiltrados.map(function(c) { return c.c; });
    
    // Filtrar informes finalizados por los centros filtrados
    var informesFiltrados = informesFinalizados.filter(function(inf) {
        if(!inf.centro) return false;
        var codigoInforme = inf.centro.substring(0, 4).toUpperCase();
        return codigosFiltrados.indexOf(codigoInforme) !== -1 || centrosFiltrados.some(function(c) {
            return inf.centro.toUpperCase().indexOf(c.n.toUpperCase()) !== -1;
        });
    });
    
    // Actualizar panel CENTROS con datos filtrados
    var centrosVisitados = [];
    informesFiltrados.forEach(function(inf) {
        var cod = inf.centro ? inf.centro.substring(0, 4).toUpperCase() : '';
        if(cod && centrosVisitados.indexOf(cod) === -1) centrosVisitados.push(cod);
    });
    
    // V.PUNTUAL = centros con visita finalizada en calendario PERO sin informe
    var centrosPuntual = [];
    visitasAgendadas.filter(function(v) { return v.finalizado; }).forEach(function(v) {
        var cod = (v.codigo || '').toUpperCase();
        if(cod && centrosVisitados.indexOf(cod) === -1 && centrosPuntual.indexOf(cod) === -1) {
            // Verificar que es un centro filtrado
            if(codigosFiltrados.indexOf(cod) !== -1) centrosPuntual.push(cod);
        }
    });
    
    var totalCentros = centrosFiltrados.length;
    var numVisitados = centrosVisitados.length; // V.PROCESO
    var numPuntual = centrosPuntual.length; // V.PUNTUAL
    var numPendientes = totalCentros - numVisitados - numPuntual;
    
    // Actualizar elementos del panel CENTROS
    var totalEl = document.getElementById('centrosTotalNum');
    var visitadosEl = document.getElementById('dash-centros-visit');
    var activosEl = document.getElementById('dash-centros-activos');
    var pendEl = document.getElementById('dash-centros-pend');
    
    if(totalEl) totalEl.textContent = totalCentros + ' total';
    if(visitadosEl) visitadosEl.textContent = numVisitados;
    if(activosEl) activosEl.textContent = numPuntual;
    if(pendEl) pendEl.textContent = numPendientes;
    
    // Actualizar donut de cobertura CENTROS
    var pctCobertura = totalCentros > 0 ? Math.round(((numVisitados + numPuntual) / totalCentros) * 100) : 0;
    var pctProceso = totalCentros > 0 ? Math.round((numVisitados / totalCentros) * 100) : 0;
    var pctPuntual = totalCentros > 0 ? Math.round((numPuntual / totalCentros) * 100) : 0;
    var pctPendientes = totalCentros > 0 ? Math.round((numPendientes / totalCentros) * 100) : 0;
    
    var donutCentros = document.getElementById('centrosPctCenter');
    if(donutCentros) {
        donutCentros.textContent = pctCobertura + '%';
        donutCentros.style.color = pctCobertura >= 50 ? '#10b981' : pctCobertura >= 25 ? '#f59e0b' : '#C9A227';
    }
    
    // Leyenda nuevos campos
    var erp = document.getElementById('dash-centros-resto-proc');
    var ept = document.getElementById('dash-centros-resto-punt');
    var epp = document.getElementById('dash-centros-pct-proc');
    var eppt = document.getElementById('dash-centros-pct-punt');
    if(erp) erp.textContent = totalCentros - numVisitados;
    if(ept) ept.textContent = totalCentros - numPuntual;
    if(epp) epp.textContent = pctProceso + '%';
    if(eppt) eppt.textContent = pctPuntual + '%';
    
    // Dibujar canvas
    dibujarCentrosRing(numVisitados, numPuntual, totalCentros);
    
    // Actualizar barra semáforo CENTROS
    var semVisit = document.getElementById('centrosSemaforoVisit');
    var semActiv = document.getElementById('centrosSemaforoActiv');
    var semPend = document.getElementById('centrosSemaforoPend');
    if(semVisit) semVisit.style.flex = pctProceso || 1;
    if(semActiv) semActiv.style.flex = pctPuntual || 0;
    if(semPend) semPend.style.flex = pctPendientes || 1;
    
    // Actualizar donut AAR desde retroplanning
    actualizarDonutAAR();
    
    // Actualizar lista de centros exclusivos filtrados
    actualizarCentrosExclusivosFiltrado(centrosFiltrados);
    
    console.log('[Filtros Dashboard] Aplicados - ' + centrosFiltrados.length + ' centros, ' + informesFiltrados.length + ' informes');
}

function actualizarCentrosExclusivosFiltrado(centrosFiltrados) {
    // Filtrar solo los exclusivos de los centros filtrados
    var exclusivosCodigos = ['4MRM', '4AKI', '4TOL', '4PEC', '4ZDE', '4ABB', '4AXF', '4AZT', '4AZP'];
    var exclusivosFiltrados = centrosFiltrados.filter(function(c) {
        return exclusivosCodigos.indexOf(c.c) !== -1 || c.t === 'EXCLUSIVO';
    });
    
    var lista = document.getElementById('listaCentrosExclusivos');
    var badge = document.getElementById('exclusivos-count-badge');
    
    // Actualizar badge de cantidad
    if(badge) {
        if(exclusivosFiltrados.length > 0) {
            badge.textContent = '✓ ' + exclusivosFiltrados.length;
            badge.style.background = '#C9A227';
        } else {
            badge.textContent = '0';
            badge.style.background = '#9ca3af';
        }
    }
    
    if(!lista) return;
    
    if(exclusivosFiltrados.length === 0) {
        lista.innerHTML = '<div style="text-align:center;color:#888;font-size:10px;padding:20px">No hay exclusivos con estos filtros</div>';
        return;
    }
    
    var html = '';
    exclusivosFiltrados.forEach(function(c) {
        var cifras = cifrasVentaAudio[c.c] || {acumulado:0, previsto:0, diferencia:0, pctCumplimiento:100};
        var crecimiento = (cifras.pctCumplimiento || 100) - 100;
        var colorCrec = crecimiento >= 0 ? '#10b981' : '#ef4444';
        var flechaCrec = crecimiento >= 0 ? '▲' : '▼';
        var signoCrec = crecimiento >= 0 ? '+' : '';
        var pctDif = Math.abs(crecimiento).toFixed(1);
        
        html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 6px;border-bottom:1px solid #f3f4f6;font-size:10px">';
        html += '<div style="display:flex;align-items:center;gap:4px">';
        html += '<span style="font-weight:600;color:#6b7280">' + c.c + '</span>';
        html += '<span style="color:#333">' + (c.n || '-') + '</span>';
        html += '</div>';
        html += '<div style="display:flex;gap:20px;align-items:center">';
        html += '<span style="width:50px;text-align:center;color:#888">-</span>';
        html += '<span style="width:40px;text-align:center;font-weight:600;color:' + colorCrec + ';cursor:pointer" title="' + signoCrec + pctDif + '%">' + flechaCrec + '</span>';
        html += '</div></div>';
    });
    
    lista.innerHTML = html;
}

// ═══════════════════════════════════════════════════════════════
// GENERAR REPORTE DEL DELEGADO REGIONAL
// ═══════════════════════════════════════════════════════════════

function generarReporteDelegado() {
    // Abrir modal de configuración de reporte
    abrirModalReporte();
}

// ═══════════════════════════════════════════════════════════════
// SISTEMA DE REPORTES - MODAL Y ENVÍO
// ═══════════════════════════════════════════════════════════════

function abrirModalReporte() {
    var existente = document.getElementById('modal-reporte');
    if(existente) existente.remove();
    
    var delegadosLista = [
        'Blanca Fdez. de la Pradilla', 'Cecilia Pérez', 'Daniel Chazo', 'Eneritz Aranguren',
        'Laura Plazas', 'Laura Ramos', 'Manuel Cánovas', 'Maribel Amezcua',
        'Marisa Carmona', 'Martín Sebastián', 'Sergio Perán', 'Sonia Godino', 'Verónica Alfonsín'
    ];
    
    var modal = document.createElement('div');
    modal.id = 'modal-reporte';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:10px';
    
    var checkboxesHTML = '';
    delegadosLista.forEach(function(nombre) {
        checkboxesHTML += '<label style="display:flex;align-items:center;padding:10px 15px;border-bottom:1px solid #eee;cursor:pointer;transition:background 0.2s" onmouseover="this.style.background=\'#f5f5f5\'" onmouseout="this.style.background=\'#fff\'">';
        checkboxesHTML += '<input type="checkbox" class="delegado-check" value="' + nombre + '" onchange="actualizarResumenReporte()" style="width:18px;height:18px;margin-right:10px;accent-color:#C9A227">';
        checkboxesHTML += '<span style="font-size:13px;color:#333">' + nombre + '</span>';
        checkboxesHTML += '</label>';
    });
    
    modal.innerHTML = '<div style="background:#fff;border-radius:12px;width:100%;max-width:420px;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.3)">' +
        '<div style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center;border-radius:12px 12px 0 0;flex-shrink:0">' +
            '<div style="display:flex;align-items:center;gap:8px"><span style="font-size:20px">📄</span><span style="font-size:15px;font-weight:700">Descargar Informe PDF</span></div>' +
            '<button onclick="cerrarModalReporte()" style="background:rgba(0,0,0,0.2);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:16px">✕</button>' +
        '</div>' +
        '<div style="padding:12px 18px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;flex-shrink:0">' +
            '<div style="display:flex;align-items:center;gap:6px"><span style="color:#C9A227">👤</span><span style="font-size:11px;font-weight:600;color:#555">Seleccionar delegados</span></div>' +
            '<div style="display:flex;gap:6px">' +
                '<button onclick="seleccionarTodosDelegados(true)" style="padding:5px 10px;border:1px solid #C9A227;background:#fff;color:#C9A227;border-radius:4px;font-size:10px;cursor:pointer;font-weight:600">✓ Todos</button>' +
                '<button onclick="seleccionarTodosDelegados(false)" style="padding:5px 10px;border:1px solid #999;background:#fff;color:#666;border-radius:4px;font-size:10px;cursor:pointer;font-weight:600">✗ Ninguno</button>' +
            '</div>' +
        '</div>' +
        '<div style="flex:1;overflow-y:auto;min-height:0">' + checkboxesHTML + '</div>' +
        '<div style="padding:12px 18px;border-top:1px solid #eee;display:flex;justify-content:space-between;align-items:center;background:#fafafa;border-radius:0 0 12px 12px;flex-shrink:0">' +
            '<div id="resumen-reporte" style="font-size:11px;color:#666">Ningún delegado seleccionado</div>' +
            '<div style="display:flex;gap:8px">' +
                '<button onclick="cerrarModalReporte()" style="padding:8px 14px;border:1px solid #ddd;background:#fff;border-radius:6px;font-size:12px;cursor:pointer;color:#666">Cancelar</button>' +
                '<button onclick="generarInformePDFDelegados()" style="padding:8px 14px;border:none;background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer">📄 Descargar</button>' +
            '</div>' +
        '</div>' +
    '</div>';
    
    document.body.appendChild(modal);
}

function seleccionarTodosDelegados(seleccionar) {
    var checks = document.querySelectorAll('.delegado-check');
    checks.forEach(function(c) { c.checked = seleccionar; });
    actualizarResumenReporte();
}

function actualizarResumenReporte() {
    var checks = document.querySelectorAll('.delegado-check:checked');
    var resumen = document.getElementById('resumen-reporte');
    if(!resumen) return;
    if(checks.length === 0) {
        resumen.textContent = 'Ningún delegado seleccionado';
    } else if(checks.length === 1) {
        resumen.textContent = '1 reporte: ' + checks[0].value;
    } else {
        resumen.textContent = checks.length + ' reportes serán generados';
    }
}

function cerrarModalReporte() {
    var modal = document.getElementById('modal-reporte');
    if(modal) modal.remove();
}

async function generarInformePDFDelegados() {
    var checks = document.querySelectorAll('.delegado-check:checked');
    if(checks.length === 0) {
        alert('Selecciona al menos un delegado');
        return;
    }
    
    if(checks.length > 1) {
        alert('Para vista previa, selecciona solo 1 delegado');
        return;
    }
    
    var delegado = checks[0].value;
    cerrarModalReporte();
    
    // Loading
    var loading = document.createElement('div');
    loading.id = 'loading-reporte';
    loading.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff';
    loading.innerHTML = '<div style="font-size:60px;margin-bottom:20px">📄</div><div style="font-size:18px;font-weight:600">Generando informe completo...</div><div style="font-size:13px;margin-top:10px;color:#C9A227">' + delegado + '</div><div style="font-size:11px;margin-top:5px;color:#888">Capturando Dashboard, KPIs, Funnel, Procesos...</div>';
    document.body.appendChild(loading);
    
    // 1. Aplicar filtro al dashboard
    document.getElementById('filtro-delegado-dashboard').value = delegado;
    aplicarFiltrosDashboard();
    await new Promise(function(r) { setTimeout(r, 1500); });
    
    // 2. Capturar TODO el dashboard completo (section-dashboard)
    var dashboardImg = null;
    try {
        var sectionDashboard = document.getElementById('section-dashboard');
        var pageContent = document.querySelector('.page-content');
        var mainContent = document.querySelector('.main-content');
        var bodyEl = document.body;
        
        if(sectionDashboard && typeof html2canvas !== 'undefined') {
            // Ocultar barras de filtros y ranking temporalmente
            var filterBar = document.getElementById('filter-bar-dashboard');
            var filtrosBar = document.getElementById('dashboard-filtros-bar');
            var rankingPanel = document.getElementById('panel-ranking-dashboard');
            var faldonDelegado = document.getElementById('faldon-delegado-nombre');
            
            if(filterBar) filterBar.style.display = 'none';
            if(filtrosBar) filtrosBar.style.display = 'none';
            if(rankingPanel) rankingPanel.style.display = 'none';
            
            // Mostrar nombre del delegado en faldón
            if(faldonDelegado) {
                faldonDelegado.textContent = '🎧 ' + delegado;
            }
            
            // Guardar estilos originales
            var origStyles = {
                sectionOverflow: sectionDashboard.style.overflow,
                sectionHeight: sectionDashboard.style.height,
                sectionMaxHeight: sectionDashboard.style.maxHeight,
                pageOverflow: pageContent ? pageContent.style.overflow : '',
                mainOverflow: mainContent ? mainContent.style.overflow : '',
                bodyOverflow: bodyEl.style.overflow
            };
            
            // Expandir TODOS los contenedores
            sectionDashboard.style.overflow = 'visible';
            sectionDashboard.style.height = 'auto';
            sectionDashboard.style.maxHeight = 'none';
            if(pageContent) pageContent.style.overflow = 'visible';
            if(mainContent) mainContent.style.overflow = 'visible';
            bodyEl.style.overflow = 'visible';
            
            // Scroll al inicio y forzar reflow
            sectionDashboard.scrollTop = 0;
            window.scrollTo(0, 0);
            sectionDashboard.offsetHeight;
            
            await new Promise(function(r) { setTimeout(r, 500); });
            
            var totalHeight = sectionDashboard.scrollHeight;
            
            var canvas = await html2canvas(sectionDashboard, { 
                scale: 1, 
                useCORS: true, 
                backgroundColor: '#1a1a1a',
                logging: false,
                height: totalHeight,
                windowHeight: totalHeight,
                scrollY: 0,
                scrollX: 0
            });
            dashboardImg = canvas.toDataURL('image/jpeg', 0.85);
            
            // Restaurar TODOS los estilos originales
            sectionDashboard.style.overflow = origStyles.sectionOverflow;
            sectionDashboard.style.height = origStyles.sectionHeight;
            sectionDashboard.style.maxHeight = origStyles.sectionMaxHeight;
            if(pageContent) pageContent.style.overflow = origStyles.pageOverflow;
            if(mainContent) mainContent.style.overflow = origStyles.mainOverflow;
            bodyEl.style.overflow = origStyles.bodyOverflow;
            
            // Restaurar elementos ocultos
            if(filterBar) filterBar.style.display = '';
            if(filtrosBar) filtrosBar.style.display = '';
            if(rankingPanel) rankingPanel.style.display = '';
            if(faldonDelegado) faldonDelegado.textContent = '';
        }
    } catch(e) { console.error('Error captura dashboard:', e); }
    
    // 3. Obtener centros del delegado
    var centrosCodigos = getCentrosPorDelegado(delegado) || [];
    var centrosDelegado = (centrosData || []).filter(function(c) {
        return centrosCodigos.indexOf(c.c) !== -1;
    });
    
    document.getElementById('loading-reporte').remove();
    
    // 4. Mostrar modal de vista previa
    var modalPreview = document.createElement('div');
    modalPreview.id = 'modal-preview-pdf';
    modalPreview.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:99999;display:flex;flex-direction:column;padding:15px';
    
    var fechaHoy = new Date().toLocaleDateString('es-ES', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    
    // Generar contenido del informe - SIN HEADER, el nombre del delegado ya está en el faldón del dashboard
    var contenidoHTML = '<div id="preview-paper-wrap" style="display:flex;justify-content:center;">' +
        '<div id="preview-paper" style="width:820px;max-width:100%;background:#111;border-radius:12px;overflow:hidden;box-shadow:0 18px 60px rgba(0,0,0,0.35);border:1px solid rgba(0,0,0,0.15)">' +
            '<div style="margin:0;padding:0">';
    
    // DASHBOARD CAPTURADO - directamente sin header
    if(dashboardImg) {
        contenidoHTML += '<img src="' + dashboardImg + '" style="width:100%;display:block;margin:0;padding:0">';
    } else {
        contenidoHTML += '<div style="padding:10px;background:#fee2e2;text-align:center;color:#8B7355;font-size:10px">⚠️ No se pudo capturar el dashboard.</div>';
    }
    
    // Tabla de centros
    contenidoHTML += '<div style="margin:0;padding:0">';
    contenidoHTML += '<div style="font-size:9px;font-weight:700;color:#C9A227;padding:2px 0;border-bottom:1px solid #C9A227">🏪 CENTROS (' + centrosDelegado.length + ')</div>';
    contenidoHTML += '<table style="width:100%;border-collapse:collapse;font-size:7px">';
    contenidoHTML += '<tr style="background:#374151;color:#fff">';
    contenidoHTML += '<th style="padding:2px;text-align:left;border:1px solid #4b5563;color:#C9A227">CÓD</th>';
    contenidoHTML += '<th style="padding:2px;text-align:left;border:1px solid #4b5563">CENTRO</th>';
    contenidoHTML += '<th style="padding:2px;text-align:center;border:1px solid #4b5563">TIPO</th>';
    contenidoHTML += '<th style="padding:2px;text-align:center;border:1px solid #4b5563">PC</th>';
    contenidoHTML += '<th style="padding:3px;text-align:left;border:1px solid #4b5563">D.AUDIO</th>';
    contenidoHTML += '<th style="padding:3px;text-align:left;border:1px solid #4b5563">D.REG</th>';
    contenidoHTML += '<th style="padding:3px;text-align:center;border:1px solid #4b5563">ACT</th>';
    contenidoHTML += '<th style="padding:3px;text-align:center;border:1px solid #4b5563">ACT.</th>';
    contenidoHTML += '</tr>';
    
    centrosDelegado.forEach(function(c, idx) {
        var cifras = (cifrasVentaAudio || {})[c.c] || {};
        var tieneVentas = parseFloat(cifras.ventaReal) > 0;
        var tipoTexto = c.t === 'EXCLUSIVO' ? 'EXC' : (c.pr === 'FRANQUICIA' ? 'FR' : 'SUC');
        var tipoColor = c.t === 'EXCLUSIVO' ? '#9333ea' : (c.pr === 'FRANQUICIA' ? '#f59e0b' : '#10b981');
        var pcColor = c.pc === 'PC' ? '#10b981' : '#f59e0b';
        var bg = idx % 2 === 0 ? '#f9fafb' : '#fff';
        var delegAudio = c.r === 'ARY' ? 'A.Rojas' : c.r === 'SGUASQUE' ? 'S.Guasque' : (c.r || '-');
        var delegRegional = c.d || delegado;
        var activo = tieneVentas;
        var actual = tieneVentas && cifras.ventaPrev > 0;
        
        contenidoHTML += '<tr style="background:' + bg + '">';
        contenidoHTML += '<td style="padding:2px;border:1px solid #e5e7eb;font-weight:700;color:#C9A227">' + c.c + '</td>';
        contenidoHTML += '<td style="padding:2px;border:1px solid #e5e7eb;font-size:7px">' + (c.n || '-') + '</td>';
        contenidoHTML += '<td style="padding:2px;border:1px solid #e5e7eb;text-align:center"><span style="background:' + tipoColor + ';color:#fff;padding:1px 2px;border-radius:2px;font-size:6px">' + tipoTexto + '</span></td>';
        contenidoHTML += '<td style="padding:2px;border:1px solid #e5e7eb;text-align:center"><span style="background:' + pcColor + ';color:#fff;padding:1px 2px;border-radius:2px;font-size:6px">' + (c.pc || 'PC') + '</span></td>';
        contenidoHTML += '<td style="padding:2px;border:1px solid #e5e7eb;font-size:7px">' + delegAudio + '</td>';
        contenidoHTML += '<td style="padding:2px;border:1px solid #e5e7eb;font-size:7px">' + delegRegional + '</td>';
        contenidoHTML += '<td style="padding:2px;border:1px solid #e5e7eb;text-align:center">' + (activo ? '<span style="color:#C9A227;font-size:10px">✓</span>' : '<span style="color:#8B7355;font-size:10px">✗</span>') + '</td>';
        contenidoHTML += '<td style="padding:2px;border:1px solid #e5e7eb;text-align:center">' + (actual ? '<span style="color:#C9A227;font-size:10px">✓</span>' : '<span style="color:#8B7355;font-size:10px">✗</span>') + '</td>';
        contenidoHTML += '</tr>';
    });
    
    contenidoHTML += '</table></div>';
    
    // Pie compacto
    contenidoHTML += '<div style="text-align:center;padding:2px;background:#1a1a1a;color:#C9A227;font-size:6px">';
    contenidoHTML += 'AFFLELOU AUDIO | ' + new Date().toLocaleString('es-ES');
    contenidoHTML += '</div></div></div></div>';
    
    modalPreview.innerHTML = '<div style="background:#C9A227;padding:10px 15px;border-radius:10px 10px 0 0;display:flex;justify-content:space-between;align-items:center">' +
        '<span style="color:#fff;font-weight:700;font-size:13px">📄 Vista Previa - ' + delegado + '</span>' +
        '<div style="display:flex;gap:8px">' +
            '<button onclick="imprimirVistaPrevia()" style="background:#fff;color:#C9A227;border:none;padding:8px 14px;border-radius:5px;font-weight:700;cursor:pointer;font-size:11px">🖨️ Imprimir / PDF</button>' +
            '<button onclick="document.getElementById(\'modal-preview-pdf\').remove()" style="background:rgba(0,0,0,0.3);color:#fff;border:none;padding:8px 14px;border-radius:5px;font-weight:700;cursor:pointer;font-size:11px">✕ Cerrar</button>' +
        '</div>' +
    '</div>' +
    '<div id="contenido-preview-pdf" style="flex:1;overflow:auto;background:#e5e7eb;padding:15px;border-radius:0 0 10px 10px">' + contenidoHTML + '</div>';
    
    document.body.appendChild(modalPreview);
}

function imprimirVistaPrevia() {
    var contenido = document.getElementById('contenido-preview-pdf');
    if(!contenido) return;
    
    var ventana = window.open('', '_blank');
    var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Informe Audio</title>';
    html += '<style>';
        html += '*{margin:0;padding:0;box-sizing:border-box}';
    html += 'body{font-family:Arial,sans-serif;background:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact}';
    html += 'img{max-width:100%;height:auto;display:block}';
    html += '#preview-paper-wrap{display:block}';
    html += '#preview-paper{width:100%!important;max-width:100%!important;box-shadow:none!important;border:none!important;border-radius:0!important;background:#fff!important}';
    html += '@media print{@page{size:A4;margin:10mm}body{margin:0;padding:0}}';

    html += '</style></head><body>';
    html += contenido.innerHTML;
    html += '</body></html>';
    
    ventana.document.write(html);
    ventana.document.close();
    
    // Esperar a que las imágenes carguen antes de imprimir
    var imgs = ventana.document.querySelectorAll('img');
    var loaded = 0;
    var total = imgs.length;
    
    if(total === 0) {
        setTimeout(function() { ventana.print(); }, 300);
    } else {
        imgs.forEach(function(img) {
            if(img.complete) {
                loaded++;
                if(loaded === total) setTimeout(function() { ventana.print(); }, 300);
            } else {
                img.onload = function() {
                    loaded++;
                    if(loaded === total) setTimeout(function() { ventana.print(); }, 300);
                };
                img.onerror = function() {
                    loaded++;
                    if(loaded === total) setTimeout(function() { ventana.print(); }, 300);
                };
            }
        });
    }
}

async function generarPDFParaDelegado(delegado) {
    // 1. Aplicar filtro al dashboard
    document.getElementById('filtro-delegado-dashboard').value = delegado;
    aplicarFiltrosDashboard();
    await new Promise(function(r) { setTimeout(r, 2500); });
    
    // 2. Capturar TODO el dashboard completo
    var dashboardImg = null;
    try {
        var sectionDashboard = document.getElementById('section-dashboard');
        var pageContent = document.querySelector('.page-content');
        var mainContent = document.querySelector('.main-content');
        var bodyEl = document.body;
        
        if(sectionDashboard && typeof html2canvas !== 'undefined') {
            var filterBar = document.getElementById('filter-bar-dashboard');
            var filtrosBar = document.getElementById('dashboard-filtros-bar');
            var rankingPanel = document.getElementById('panel-ranking-dashboard');
            var faldonDelegado = document.getElementById('faldon-delegado-nombre');
            
            if(filterBar) filterBar.style.display = 'none';
            if(filtrosBar) filtrosBar.style.display = 'none';
            if(rankingPanel) rankingPanel.style.display = 'none';
            
            // Mostrar nombre del delegado en faldón
            if(faldonDelegado) {
                faldonDelegado.textContent = '🎧 ' + delegado;
            }
            
            // Guardar estilos originales
            var origStyles = {
                sectionOverflow: sectionDashboard.style.overflow,
                sectionHeight: sectionDashboard.style.height,
                sectionMaxHeight: sectionDashboard.style.maxHeight,
                pageOverflow: pageContent ? pageContent.style.overflow : '',
                mainOverflow: mainContent ? mainContent.style.overflow : '',
                bodyOverflow: bodyEl.style.overflow
            };
            
            // Expandir TODOS los contenedores
            sectionDashboard.style.overflow = 'visible';
            sectionDashboard.style.height = 'auto';
            sectionDashboard.style.maxHeight = 'none';
            if(pageContent) pageContent.style.overflow = 'visible';
            if(mainContent) mainContent.style.overflow = 'visible';
            bodyEl.style.overflow = 'visible';
            
            sectionDashboard.scrollTop = 0;
            window.scrollTo(0, 0);
            sectionDashboard.offsetHeight;
            
            await new Promise(function(r) { setTimeout(r, 500); });
            
            var totalHeight = sectionDashboard.scrollHeight;
            
            var canvas = await html2canvas(sectionDashboard, { 
                scale: 1, 
                useCORS: true, 
                backgroundColor: '#1a1a1a',
                logging: false,
                height: totalHeight,
                windowHeight: totalHeight,
                scrollY: 0,
                scrollX: 0
            });
            dashboardImg = canvas.toDataURL('image/jpeg', 0.85);
            
            // Restaurar TODOS los estilos
            sectionDashboard.style.overflow = origStyles.sectionOverflow;
            sectionDashboard.style.height = origStyles.sectionHeight;
            sectionDashboard.style.maxHeight = origStyles.sectionMaxHeight;
            if(pageContent) pageContent.style.overflow = origStyles.pageOverflow;
            if(mainContent) mainContent.style.overflow = origStyles.mainOverflow;
            bodyEl.style.overflow = origStyles.bodyOverflow;
            
            if(filterBar) filterBar.style.display = '';
            if(filtrosBar) filtrosBar.style.display = '';
            if(rankingPanel) rankingPanel.style.display = '';
            if(faldonDelegado) faldonDelegado.textContent = '';
        }
    } catch(e) { console.error('Error captura:', e); }
    
    // 3. Obtener centros del delegado
    var centrosCodigos = getCentrosPorDelegado(delegado) || [];
    var centrosDelegado = (centrosData || []).filter(function(c) {
        return centrosCodigos.indexOf(c.c) !== -1;
    });
    
    // 4. Generar HTML del informe
    var fechaHoy = new Date().toLocaleDateString('es-ES', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    
    var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Informe ' + delegado + '</title>';
    html += '<style>body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#fff}table{border-collapse:collapse;width:100%}th,td{padding:10px;text-align:left;border:1px solid #ddd}@media print{body{padding:10px}}</style>';
    html += '</head><body>';
    
    // Header
    html += '<div style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;padding:25px;border-radius:12px;text-align:center;margin-bottom:20px">';
    html += '<div style="font-size:28px;margin-bottom:8px">🎧 INFORME AUDIO</div>';
    html += '<div style="font-size:20px;font-weight:700">' + delegado + '</div>';
    html += '<div style="font-size:12px;opacity:0.9;margin-top:5px">' + fechaHoy + '</div>';
    html += '</div>';
    
    // Dashboard capturado
    if(dashboardImg) {
        html += '<div style="margin-bottom:25px">';
        html += '<div style="font-size:14px;font-weight:700;color:#C9A227;margin-bottom:10px;padding-bottom:5px;border-bottom:2px solid #C9A227">📊 Dashboard</div>';
        html += '<img src="' + dashboardImg + '" style="width:100%;border-radius:8px;border:1px solid #e0e0e0">';
        html += '</div>';
    }
    
    // Tabla de centros
    html += '<div style="margin-bottom:20px">';
    html += '<div style="font-size:14px;font-weight:700;color:#C9A227;margin-bottom:10px;padding-bottom:5px;border-bottom:2px solid #C9A227">🏪 LISTADO DE CENTROS (' + centrosDelegado.length + ')</div>';
    html += '<table style="font-size:12px">';
    html += '<tr style="background:#2d2d2d;color:#fff">';
    html += '<th style="padding:12px;color:#C9A227">CÓDIGO</th>';
    html += '<th style="padding:12px">CENTRO</th>';
    html += '<th style="padding:12px;text-align:center">TIPO</th>';
    html += '<th style="padding:12px;text-align:center">PC</th>';
    html += '<th style="padding:12px">DELEG. AUDIO</th>';
    html += '<th style="padding:12px">DELEG. REGIONAL</th>';
    html += '<th style="padding:12px;text-align:center">ACTIVO</th>';
    html += '<th style="padding:12px;text-align:center">ACTUAL.</th>';
    html += '</tr>';
    
    centrosDelegado.forEach(function(c, idx) {
        var cifras = (cifrasVentaAudio || {})[c.c] || {};
        var tieneVentas = parseFloat(cifras.ventaReal) > 0;
        var tipoTexto = c.t === 'EXCLUSIVO' ? 'EXC' : (c.pr === 'FRANQUICIA' ? 'FR' : 'SUC');
        var tipoColor = c.t === 'EXCLUSIVO' ? '#9333ea' : (c.pr === 'FRANQUICIA' ? '#f59e0b' : '#10b981');
        var pcColor = c.pc === 'PC' ? '#10b981' : '#f59e0b';
        var bg = idx % 2 === 0 ? '#f9f9f9' : '#fff';
        
        // Mapear delegado audio desde c.r
        var delegAudio = c.r === 'ARY' ? 'Ariannys Rojas' : c.r === 'SGUASQUE' ? 'Sonia Guasque' : (c.r || '-');
        var delegRegional = c.d || delegado;
        
        var activo = tieneVentas;
        var actual = tieneVentas && cifras.ventaPrev > 0;
        
        html += '<tr style="background:' + bg + '">';
        html += '<td style="padding:10px;font-weight:700;color:#C9A227">' + c.c + '</td>';
        html += '<td style="padding:10px">' + (c.n || '-') + '</td>';
        html += '<td style="padding:10px;text-align:center"><span style="background:' + tipoColor + ';color:#fff;padding:3px 8px;border-radius:4px;font-size:10px;font-weight:600">' + tipoTexto + '</span></td>';
        html += '<td style="padding:10px;text-align:center"><span style="background:' + pcColor + ';color:#fff;padding:3px 8px;border-radius:4px;font-size:10px;font-weight:600">' + (c.pc || 'PC') + '</span></td>';
        html += '<td style="padding:10px;font-size:11px">' + delegAudio + '</td>';
        html += '<td style="padding:10px;font-size:11px">' + delegRegional + '</td>';
        html += '<td style="padding:10px;text-align:center">' + (activo ? '<span style="display:inline-block;width:28px;height:28px;line-height:28px;background:#10b981;color:#fff;border-radius:4px;font-weight:bold">✓</span>' : '<span style="display:inline-block;width:28px;height:28px;line-height:28px;background:#ef4444;color:#fff;border-radius:4px;font-weight:bold">✗</span>') + '</td>';
        html += '<td style="padding:10px;text-align:center">' + (actual ? '<span style="display:inline-block;width:28px;height:28px;line-height:28px;background:#10b981;color:#fff;border-radius:4px;font-weight:bold">✓</span>' : '<span style="display:inline-block;width:28px;height:28px;line-height:28px;background:#ef4444;color:#fff;border-radius:4px;font-weight:bold">✗</span>') + '</td>';
        html += '</tr>';
    });
    
    html += '</table></div>';
    
    // Pie
    html += '<div style="text-align:center;padding:15px;background:#1a1a1a;color:#C9A227;border-radius:8px;font-size:11px">';
    html += '<strong>AFFLELOU AUDIO</strong> | Generado: ' + new Date().toLocaleString('es-ES');
    html += '</div>';
    
    html += '</body></html>';
    
    // 5. Abrir ventana e imprimir
    var ventana = window.open('', '_blank');
    ventana.document.write(html);
    ventana.document.close();
    
    await new Promise(function(r) { setTimeout(r, 800); });
    ventana.print();
}

async function ejecutarDescargarReporte() {
    // Obtener delegados seleccionados
    var checks = document.querySelectorAll('.delegado-check:checked');
    var delegadosSeleccionados = [];
    checks.forEach(function(c) { delegadosSeleccionados.push(c.value); });
    
    if(delegadosSeleccionados.length === 0) {
        alert('Selecciona al menos un delegado');
        return;
    }
    
    cerrarModalReporte();
    
    // Mostrar loading
    var loading = document.createElement('div');
    loading.id = 'loading-descarga';
    loading.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff';
    loading.innerHTML = '<div style="font-size:48px;margin-bottom:15px">📄</div><div style="font-size:18px;font-weight:600">Generando PDFs...</div><div id="descarga-progreso" style="font-size:12px;margin-top:10px;opacity:0.8">Preparando...</div><div style="width:300px;height:8px;background:#333;border-radius:4px;margin-top:15px;overflow:hidden"><div id="descarga-bar" style="width:0%;height:100%;background:#C9A227;transition:width 0.3s"></div></div>';
    document.body.appendChild(loading);
    
    var pdfsGenerados = [];
    
    for(var i = 0; i < delegadosSeleccionados.length; i++) {
        var delegado = delegadosSeleccionados[i];
        document.getElementById('descarga-progreso').textContent = 'Generando: ' + delegado + ' (' + (i+1) + '/' + delegadosSeleccionados.length + ')';
        document.getElementById('descarga-bar').style.width = ((i+1) / delegadosSeleccionados.length * 100) + '%';
        
        // Aplicar filtro del delegado
        document.getElementById('filtro-delegado-dashboard').value = delegado;
        aplicarFiltrosDashboard();
        await new Promise(r => setTimeout(r, 1200));
        
        // Capturar dashboard
        var dashboardImg = await capturarDashboardImagen();
        
        // Generar HTML del reporte para PDF
        var htmlReporte = generarHTMLReporteParaPDF(delegado, dashboardImg);
        
        // Crear contenedor temporal
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlReporte;
        tempDiv.style.cssText = 'position:absolute;left:-9999px;width:800px';
        document.body.appendChild(tempDiv);
        
        // Generar PDF y descargar
        var nombrePDF = 'Reporte_Audio_' + delegado.replace(/\s+/g, '_') + '_' + new Date().toISOString().split('T')[0] + '.pdf';
        
        await html2pdf().set({
            margin: 10,
            filename: nombrePDF,
            image: { type: 'jpeg', quality: 0.95 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).from(tempDiv).save();
        
        pdfsGenerados.push(nombrePDF);
        tempDiv.remove();
        
        await new Promise(r => setTimeout(r, 500));
    }
    
    loading.remove();
    
    // Mostrar confirmación
    var toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#10b981;color:#fff;padding:16px 24px;border-radius:12px;font-size:13px;z-index:99999;box-shadow:0 4px 20px rgba(0,0,0,0.2)';
    toast.innerHTML = '<div style="font-weight:700;margin-bottom:4px">✅ ' + pdfsGenerados.length + ' PDF(s) descargados</div><div style="font-size:11px;opacity:0.9">Revisa tu carpeta de descargas</div>';
    document.body.appendChild(toast);
    setTimeout(function() { toast.remove(); }, 5000);
}

function generarHTMLReporteParaPDF(delegado, dashboardImg) {
    // Datos del delegado
    var centrosDelegadoCodigos = [];
    try {
        centrosDelegadoCodigos = getCentrosPorDelegado(delegado) || [];
    } catch(e) {
        console.error('Error getCentrosPorDelegado:', e);
    }
    
    var centrosDelegado = (centrosData || []).filter(function(c) {
        return centrosDelegadoCodigos.indexOf(c.c) !== -1;
    });
    
    var exclusivosCodigos = ['4MRM', '4AKI', '4TOL', '4PEC', '4ZDE', '4ABB', '4AXF', '4AZT', '4AZP'];
    var centrosExclusivos = centrosDelegado.filter(function(c) {
        return c.t === 'EXCLUSIVO' || exclusivosCodigos.indexOf(c.c) !== -1;
    });
    
    // Contadores AAR
    var aarCert = 0, aarForm = 0, aarPend = 0;
    centrosDelegado.forEach(function(c) {
        if(c.a === 'SI' || c.a === 'CERTIFICADO') aarCert++;
        else if(c.a === 'FORMACIÓN' || c.a === 'EN FORMACIÓN') aarForm++;
        else aarPend++;
    });
    
    // Visitas
    var informesDelegado = (informesFinalizados || []).filter(function(inf) {
        if(!inf.centro) return false;
        var codigo = inf.centro.substring(0, 4).toUpperCase();
        return centrosDelegadoCodigos.indexOf(codigo) !== -1;
    });
    
    // Totales ventas y funnel
    var totalVentaReal = 0, totalVentaPrev = 0;
    var centrosConFunnel = 0, centrosSinFunnel = 0;
    
    centrosDelegado.forEach(function(c) {
        var cifras = (cifrasVentaAudio || {})[c.c] || {};
        var vReal = parseFloat(cifras.ventaReal) || 0;
        var vPrev = parseFloat(cifras.ventaPrev) || 0;
        totalVentaReal += vReal;
        totalVentaPrev += vPrev;
        if(vReal > 0) centrosConFunnel++; else centrosSinFunnel++;
    });
    
    var pctCumplimiento = totalVentaPrev > 0 ? ((totalVentaReal / totalVentaPrev) * 100).toFixed(1) : '100.0';
    var fechaHoy = new Date().toLocaleDateString('es-ES', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    
    // CONSTRUIR HTML
    var html = '';
    
    // HEADER
    html += '<div style="font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:15px;background:#fff">';
    html += '<div style="background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;padding:20px;border-radius:12px;text-align:center;margin-bottom:15px">';
    html += '<div style="font-size:28px;margin-bottom:5px">🎧 REPORTE AUDIO</div>';
    html += '<div style="font-size:18px;font-weight:700">' + delegado + '</div>';
    html += '<div style="font-size:11px;opacity:0.9">' + fechaHoy + '</div>';
    html += '</div>';
    
    // DASHBOARD IMAGE
    if(dashboardImg) {
        html += '<div style="margin-bottom:15px">';
        html += '<div style="font-size:13px;font-weight:700;color:#C9A227;margin-bottom:8px;border-bottom:2px solid #C9A227;padding-bottom:4px">📊 Captura del Dashboard</div>';
        html += '<img src="' + dashboardImg + '" style="width:100%;border-radius:8px;border:1px solid #e5e7eb">';
        html += '</div>';
    }
    
    // RESUMEN EJECUTIVO
    html += '<div style="margin-bottom:15px">';
    html += '<div style="font-size:13px;font-weight:700;color:#C9A227;margin-bottom:8px;border-bottom:2px solid #C9A227;padding-bottom:4px">📈 Resumen Ejecutivo</div>';
    html += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">';
    html += '<div style="background:#1a1a1a;padding:12px 8px;border-radius:8px;text-align:center">';
    html += '<div style="font-size:22px;font-weight:800;color:#C9A227">' + centrosDelegado.length + '</div>';
    html += '<div style="font-size:9px;color:#aaa">CENTROS</div></div>';
    html += '<div style="background:#1a1a1a;padding:12px 8px;border-radius:8px;text-align:center">';
    html += '<div style="font-size:22px;font-weight:800;color:#fff">' + totalVentaReal.toLocaleString('es-ES') + '€</div>';
    html += '<div style="font-size:9px;color:#aaa">Venta Real</div></div>';
    var pctColor = parseFloat(pctCumplimiento) >= 100 ? '#10b981' : '#ef4444';
    html += '<div style="background:#1a1a1a;padding:12px 8px;border-radius:8px;text-align:center">';
    html += '<div style="font-size:22px;font-weight:800;color:' + pctColor + '">' + pctCumplimiento + '%</div>';
    html += '<div style="font-size:9px;color:#aaa">vs PREVISTO</div></div>';
    html += '<div style="background:#1a1a1a;padding:12px 8px;border-radius:8px;text-align:center">';
    html += '<div style="font-size:22px;font-weight:800;color:#3b82f6">' + informesDelegado.length + '</div>';
    html += '<div style="font-size:9px;color:#aaa">VISITAS</div></div>';
    html += '</div></div>';
    
    // ESTADO AAR
    html += '<div style="margin-bottom:15px">';
    html += '<div style="font-size:13px;font-weight:700;color:#C9A227;margin-bottom:8px;border-bottom:2px solid #C9A227;padding-bottom:4px">🎯 Estado AAR</div>';
    html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">';
    html += '<div style="background:#d1fae5;padding:12px;border-radius:8px;text-align:center;border:2px solid #10b981">';
    html += '<div style="font-size:28px;font-weight:800;color:#C9A227">' + aarCert + '</div>';
    html += '<div style="font-size:10px;color:#065f46;font-weight:600">🟢 CERTIFICADOS</div></div>';
    html += '<div style="background:#fef3c7;padding:12px;border-radius:8px;text-align:center;border:2px solid #f59e0b">';
    html += '<div style="font-size:28px;font-weight:800;color:#D4AF37">' + aarForm + '</div>';
    html += '<div style="font-size:10px;color:#8B7355;font-weight:600">🟡 EN FORMACIÓN</div></div>';
    html += '<div style="background:#fee2e2;padding:12px;border-radius:8px;text-align:center;border:2px solid #ef4444">';
    html += '<div style="font-size:28px;font-weight:800;color:#8B7355">' + aarPend + '</div>';
    html += '<div style="font-size:10px;color:#991b1b;font-weight:600">🔴 PENDIENTES</div></div>';
    html += '</div></div>';
    
    // CENTROS EXCLUSIVOS
    if(centrosExclusivos.length > 0) {
        html += '<div style="margin-bottom:15px">';
        html += '<div style="font-size:13px;font-weight:700;color:#C9A227;margin-bottom:8px;border-bottom:2px solid #C9A227;padding-bottom:4px">⭐ CENTROS EXCLUSIVOS (' + centrosExclusivos.length + ')</div>';
        html += '<table style="width:100%;border-collapse:collapse;font-size:10px">';
        html += '<tr style="background:#fef3c7"><th style="padding:8px;text-align:left;border:1px solid #fcd34d">Código</th><th style="padding:8px;text-align:left;border:1px solid #fcd34d">Centro</th><th style="padding:8px;text-align:right;border:1px solid #fcd34d">Venta</th><th style="padding:8px;text-align:center;border:1px solid #fcd34d">%</th><th style="padding:8px;text-align:center;border:1px solid #fcd34d">Funnel</th></tr>';
        centrosExclusivos.forEach(function(c, idx) {
            var cifras = (cifrasVentaAudio || {})[c.c] || {};
            var vReal = parseFloat(cifras.ventaReal) || 0;
            var pct = parseFloat(cifras.pctCumplimiento) || 100;
            var crec = pct - 100;
            var funnelOK = vReal > 0;
            var bg = idx % 2 === 0 ? '#fffbeb' : '#fff';
            var crecColor = crec >= 0 ? '#10b981' : '#ef4444';
            var crecSign = crec >= 0 ? '+' : '';
            html += '<tr style="background:' + bg + '">';
            html += '<td style="padding:6px;border:1px solid #fcd34d;font-weight:700">' + c.c + '</td>';
            html += '<td style="padding:6px;border:1px solid #fcd34d">' + (c.n || '-') + '</td>';
            html += '<td style="padding:6px;border:1px solid #fcd34d;text-align:right;font-weight:600">' + vReal.toLocaleString('es-ES') + '€</td>';
            html += '<td style="padding:6px;border:1px solid #fcd34d;text-align:center;color:' + crecColor + ';font-weight:700">' + crecSign + crec.toFixed(1) + '%</td>';
            html += '<td style="padding:6px;border:1px solid #fcd34d;text-align:center">' + (funnelOK ? '✅' : '⚠️') + '</td>';
            html += '</tr>';
        });
        html += '</table></div>';
    }
    
    // LISTADO COMPLETO DE CENTROS
    html += '<div style="margin-bottom:15px">';
    html += '<div style="font-size:13px;font-weight:700;color:#C9A227;margin-bottom:8px;border-bottom:2px solid #C9A227;padding-bottom:4px">🏪 LISTADO CENTROS (' + centrosDelegado.length + ')</div>';
    html += '<table style="width:100%;border-collapse:collapse;font-size:9px;color:#3a3a3a">';
    html += '<tr style="background:#374151;color:#fff">';
    html += '<th style="padding:6px;text-align:left;border:1px solid #4b5563">Código</th>';
    html += '<th style="padding:6px;text-align:left;border:1px solid #4b5563">Centro</th>';
    html += '<th style="padding:6px;text-align:center;border:1px solid #4b5563">Tipo</th>';
    html += '<th style="padding:6px;text-align:center;border:1px solid #4b5563">AAR</th>';
    html += '<th style="padding:6px;text-align:right;border:1px solid #4b5563">Venta</th>';
    html += '<th style="padding:6px;text-align:center;border:1px solid #4b5563">%</th>';
    html += '<th style="padding:6px;text-align:center;border:1px solid #4b5563">Funnel</th>';
    html += '</tr>';
    
    // Ordenar por venta
    var centrosOrdenados = centrosDelegado.slice().sort(function(a, b) {
        var vA = parseFloat(((cifrasVentaAudio || {})[a.c] || {}).ventaReal) || 0;
        var vB = parseFloat(((cifrasVentaAudio || {})[b.c] || {}).ventaReal) || 0;
        return vB - vA;
    });
    
    centrosOrdenados.forEach(function(c, idx) {
        var cifras = (cifrasVentaAudio || {})[c.c] || {};
        var vReal = parseFloat(cifras.ventaReal) || 0;
        var vPrev = parseFloat(cifras.ventaPrev) || 0;
        var pct = vPrev > 0 ? ((vReal / vPrev) * 100) : 100;
        var aarIcon = (c.a === 'SI' || c.a === 'CERTIFICADO') ? '🟢' : ((c.a === 'FORMACIÓN' || c.a === 'EN FORMACIÓN') ? '🟡' : '🔴');
        var tipoColor = c.t === 'EXCLUSIVO' ? '#9333ea' : (c.pr === 'FRANQUICIA' ? '#f59e0b' : '#10b981');
        var tipoTexto = c.t === 'EXCLUSIVO' ? 'EXC' : (c.pr === 'FRANQUICIA' ? 'FRA' : 'SUC');
        var funnelOK = vReal > 0;
        var bg = idx % 2 === 0 ? '#f9fafb' : '#fff';
        var pctColor = pct >= 100 ? '#10b981' : '#ef4444';
        
        html += '<tr style="background:' + bg + '">';
        html += '<td style="padding:5px;border:1px solid #e5e7eb;font-weight:700">' + c.c + '</td>';
        html += '<td style="padding:5px;border:1px solid #e5e7eb">' + (c.n || '-') + '</td>';
        html += '<td style="padding:5px;border:1px solid #e5e7eb;text-align:center"><span style="background:' + tipoColor + ';color:#fff;padding:1px 4px;border-radius:3px;font-size:8px">' + tipoTexto + '</span></td>';
        html += '<td style="padding:5px;border:1px solid #e5e7eb;text-align:center">' + aarIcon + '</td>';
        html += '<td style="padding:5px;border:1px solid #e5e7eb;text-align:right;font-weight:600">' + vReal.toLocaleString('es-ES') + '€</td>';
        html += '<td style="padding:5px;border:1px solid #e5e7eb;text-align:center;color:' + pctColor + ';font-weight:700">' + pct.toFixed(0) + '%</td>';
        html += '<td style="padding:5px;border:1px solid #e5e7eb;text-align:center">' + (funnelOK ? '✅' : '⚠️') + '</td>';
        html += '</tr>';
    });
    
    html += '</table>';
    html += '<div style="margin-top:8px;font-size:9px;color:#666">✅ Funnel Activo (con ventas) | ⚠️ Sin actividad</div>';
    html += '</div>';
    
    // RESUMEN FUNNEL
    html += '<div style="margin-bottom:15px">';
    html += '<div style="font-size:13px;font-weight:700;color:#C9A227;margin-bottom:8px;border-bottom:2px solid #C9A227;padding-bottom:4px">📊 Estado Funnel</div>';
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
    html += '<div style="background:#d1fae5;padding:15px;border-radius:8px;text-align:center;border:2px solid #10b981">';
    html += '<div style="font-size:32px;font-weight:800;color:#C9A227">' + centrosConFunnel + '</div>';
    html += '<div style="font-size:11px;color:#065f46;font-weight:600">✅ ACTIVOS</div></div>';
    html += '<div style="background:#fef3c7;padding:15px;border-radius:8px;text-align:center;border:2px solid #f59e0b">';
    html += '<div style="font-size:32px;font-weight:800;color:#D4AF37">' + centrosSinFunnel + '</div>';
    html += '<div style="font-size:11px;color:#8B7355;font-weight:600">⚠️ REVISAR</div></div>';
    html += '</div></div>';
    
    // PIE
    html += '<div style="text-align:center;padding:12px;background:#1a1a1a;border-radius:8px;color:#C9A227;font-size:10px">';
    html += '<strong>AFFLELOU AUDIO</strong> | ' + new Date().toLocaleString('es-ES');
    html += '</div></div>';
    
    return html;
}

function guardarProgramacionReporte(delegados, frecuencia, remitente) {
    var config = {
        delegados: delegados,
        frecuencia: frecuencia,
        remitente: remitente,
        creado: new Date().toISOString()
    };
    
    localStorage.setItem('reporteProgramado', JSON.stringify(config));
    console.log('[Reportes] Programación guardada:', config);
}

function enviarReporteMultiplesDelegados(delegados, remitente) {
    // Mostrar progreso
    var progreso = document.createElement('div');
    progreso.id = 'progreso-reportes';
    progreso.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff';
    progreso.innerHTML = '<div style="font-size:48px;margin-bottom:20px">📊</div><div style="font-size:18px;font-weight:600;margin-bottom:10px">Generando Reportes...</div><div id="progreso-texto" style="font-size:14px">Preparando...</div><div style="width:300px;height:8px;background:#333;border-radius:4px;margin-top:15px;overflow:hidden"><div id="progreso-bar" style="width:0%;height:100%;background:#C9A227;transition:width 0.3s"></div></div><div id="progreso-detalle" style="font-size:11px;margin-top:10px;opacity:0.7"></div>';
    document.body.appendChild(progreso);
    
    var index = 0;
    
    async function procesarSiguiente() {
        if(index >= delegados.length) {
            // Finalizado
            setTimeout(function() {
                progreso.innerHTML = '<div style="font-size:48px;margin-bottom:20px">✅</div><div style="font-size:18px;font-weight:600;margin-bottom:10px">¡Reportes Generados!</div><div style="font-size:14px">' + delegados.length + ' reportes abiertos</div><div style="font-size:11px;margin-top:10px;opacity:0.7">Puedes guardarlos como PDF desde cada pestaña</div>';
                setTimeout(function() { progreso.remove(); }, 3000);
            }, 500);
            return;
        }
        
        var delegado = delegados[index];
        document.getElementById('progreso-texto').textContent = (index + 1) + ' de ' + delegados.length + ': ' + delegado;
        document.getElementById('progreso-bar').style.width = ((index + 1) / delegados.length * 100) + '%';
        document.getElementById('progreso-detalle').textContent = 'Generando...';
        
        try {
            // Aplicar filtro del delegado
            document.getElementById('filtro-delegado-dashboard').value = delegado;
            aplicarFiltrosDashboard();
            await new Promise(r => setTimeout(r, 600));
            
            // Capturar dashboard (sin filtros)
            var dashboardImg = await capturarDashboardImagen();
            
            // Generar reporte
            generarHTMLReporteDelegadoConImagen(delegado, dashboardImg, remitente);
            
        } catch(e) {
            console.error('[Reporte] Error con delegado ' + delegado + ':', e);
        }
        
        index++;
        setTimeout(procesarSiguiente, 1000);
    }
    
    setTimeout(procesarSiguiente, 500);
}

function mostrarConfirmacionProgramacion(frecuencia) {
    var texto = frecuencia === 'mensual' ? 'el día 1 de cada mes' : 'cada lunes';
    
    var toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#10b981;color:#fff;padding:16px 24px;border-radius:12px;font-size:13px;font-weight:600;z-index:99999;box-shadow:0 4px 20px rgba(0,0,0,0.2);display:flex;align-items:center;gap:10px';
    toast.innerHTML = '<span style="font-size:20px">✅</span> Reporte programado para ' + texto;
    document.body.appendChild(toast);
    
    setTimeout(function() { toast.remove(); }, 4000);
}

function enviarReporteTodosDelegados(remitente) {
    var delegados = [
        'Blanca Fdez. de la Pradilla', 'Cecilia Pérez', 'Daniel Chazo', 'Eneritz Aranguren',
        'Laura Plazas', 'Laura Ramos', 'Manuel Cánovas', 'Maribel Amezcua',
        'Marisa Carmona', 'Martín Sebastián', 'Sergio Perán', 'Sonia Godino', 'Verónica Alfonsín'
    ];
    enviarReporteMultiplesDelegados(delegados, remitente);
}

async function enviarReporteUnDelegado(delegado, remitente) {
    var loading = document.createElement('div');
    loading.id = 'loading-reporte';
    loading.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff';
    loading.innerHTML = '<div style="font-size:48px;margin-bottom:15px">📊</div><div style="font-size:16px;font-weight:600">Generando reporte de ' + delegado + '</div>';
    document.body.appendChild(loading);
    
    try {
        // Aplicar filtro del delegado
        document.getElementById('filtro-delegado-dashboard').value = delegado;
        aplicarFiltrosDashboard();
        
        // Esperar a que se actualice el dashboard completamente
        await new Promise(r => setTimeout(r, 1500));
        
        // Capturar dashboard (sin filtros)
        var dashboardImg = await capturarDashboardImagen();
        
        // Generar reporte
        generarHTMLReporteDelegadoConImagen(delegado, dashboardImg, remitente);
        
    } catch(e) {
        console.error('[Reporte] Error:', e);
        alert('Error al generar reporte: ' + e.message);
    } finally {
        loading.remove();
    }
}

async function capturarDashboardImagen() {
    var dashboard = document.getElementById('section-dashboard');
    var barraFiltros = document.getElementById('dashboard-filtros-bar');
    
    if(!dashboard || typeof html2canvas === 'undefined') {
        console.warn('[Reporte] No se pudo capturar dashboard');
        return null;
    }
    
    try {
        // Ocultar barra de filtros durante la captura
        if(barraFiltros) barraFiltros.style.display = 'none';
        
        var canvas = await html2canvas(dashboard, {
            scale: 1,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff',
            height: Math.min(dashboard.scrollHeight, 1200),
            windowHeight: Math.min(dashboard.scrollHeight, 1200)
        });
        
        // Restaurar barra de filtros
        if(barraFiltros) barraFiltros.style.display = '';
        
        return canvas.toDataURL('image/png');
    } catch(e) {
        // Restaurar barra de filtros en caso de error
        if(barraFiltros) barraFiltros.style.display = '';
        console.error('[Reporte] Error capturando dashboard:', e);
        return null;
    }
}

function generarHTMLReporteDelegadoConImagen(delegado, dashboardImg, remitente) {
    // Obtener centros del delegado
    var centrosDelegadoCodigos = getCentrosPorDelegado(delegado);
    var centrosDelegado = centrosData.filter(function(c) {
        return centrosDelegadoCodigos.indexOf(c.c) !== -1;
    });
    
    // Centros Exclusivos del delegado (usar t === 'EXCLUSIVO' o código en lista)
    var exclusivosCodigos = ['4MRM', '4AKI', '4TOL', '4PEC', '4ZDE', '4ABB', '4AXF', '4AZT', '4AZP'];
    var centrosExclusivos = centrosDelegado.filter(function(c) {
        return c.t === 'EXCLUSIVO' || exclusivosCodigos.indexOf(c.c) !== -1;
    });
    
    // Estadísticas AAR
    var aarCert = 0, aarForm = 0, aarPend = 0;
    centrosDelegado.forEach(function(c) {
        if(c.a === 'SI') aarCert++;
        else if(c.a === 'FORMACIÓN' || c.a === 'EN FORMACIÓN') aarForm++;
        else aarPend++;
    });
    var pctAAR = centrosDelegado.length > 0 ? Math.round((aarCert / centrosDelegado.length) * 100) : 0;
    
    // Informes del delegado - SOLO por código de centro
    var informesDelegado = informesFinalizados.filter(function(inf) {
        if(!inf.centro) return false;
        var codigo = inf.centro.substring(0, 4).toUpperCase();
        return centrosDelegadoCodigos && centrosDelegadoCodigos.indexOf(codigo) !== -1;
    });
    
    // Calcular promedios de bloques (PROCESOS)
    var promediosBloques = {PIA:0, FORMACION:0, COMUNICACION:0, AYUDAS:0, COMPLEMENTARIAS:0, RT:0, AGENDA:0, CONVERSIONES:0};
    informesDelegado.forEach(function(inf) {
        if(inf.preinformeData && inf.preinformeData.respuestas) {
            var bloquesPct = calcularBloquesPct(inf.preinformeData.respuestas);
            Object.keys(promediosBloques).forEach(function(b) {
                promediosBloques[b] += bloquesPct[b] || 0;
            });
        }
    });
    var nInf = informesDelegado.length || 1;
    Object.keys(promediosBloques).forEach(function(b) { promediosBloques[b] = Math.round(promediosBloques[b] / nInf); });
    
    // Promedio general de procesos
    var sumResultados = 0;
    informesDelegado.forEach(function(inf) {
        if(inf.preinformeData) sumResultados += inf.preinformeData.resultado || 0;
    });
    var promGeneral = informesDelegado.length > 0 ? Math.round(sumResultados / informesDelegado.length) : 0;
    
    // Cifras de venta
    var totalAcumulado = 0, totalPrevisto = 0;
    centrosDelegado.forEach(function(c) {
        if(cifrasVentaAudio[c.c]) {
            totalAcumulado += cifrasVentaAudio[c.c].acumulado || 0;
            totalPrevisto += cifrasVentaAudio[c.c].previsto || 0;
        }
    });
    var pctCumplimiento = totalPrevisto > 0 ? ((totalAcumulado / totalPrevisto) * 100).toFixed(1) : 0;
    var difVentas = totalAcumulado - totalPrevisto;
    
    // Obtener datos de Funnel
    var funnelData = JSON.parse(localStorage.getItem('datosFunnelCentros') || '{}');
    var totalAudiencias = 0, totalPruebas = 0, totalVentas = 0, totalRenove3a = 0, totalRenove42 = 0, totalMgm = 0;
    
    // Separar centros activos (con funnel) y no activos
    var centrosActivos = [];
    var centrosNoActivos = [];
    
    centrosDelegado.forEach(function(c) {
        var fd = funnelData[c.c] || {};
        var audiencias = fd.audiencias || 0;
        var pruebas = fd.pruebas || 0;
        var ventas = fd.ventas || 0;
        
        totalAudiencias += audiencias;
        totalPruebas += pruebas;
        totalVentas += ventas;
        totalRenove3a += fd.renove3a || 0;
        totalRenove42 += fd.renove42 || 0;
        totalMgm += fd.mgm || 0;
        
        var tieneFunnel = audiencias > 0 || pruebas > 0 || ventas > 0;
        var cifras = cifrasVentaAudio[c.c] || {pctCumplimiento: 100};
        var crec = cifras.pctCumplimiento - 100;
        
        var centroInfo = {
            codigo: c.c,
            nombre: c.n,
            pc: c.pc,
            aar: c.a,
            tipo: c.t,
            propiedad: c.pr,
            audiencias: audiencias,
            pruebas: pruebas,
            ventas: ventas,
            convVenta: audiencias > 0 ? ((ventas / audiencias) * 100).toFixed(1) : 0,
            crec: crec
        };
        
        if(tieneFunnel) {
            centrosActivos.push(centroInfo);
        } else {
            centrosNoActivos.push(centroInfo);
        }
    });
    
    var convPrueba = totalAudiencias > 0 ? ((totalPruebas / totalAudiencias) * 100).toFixed(1) : 0;
    var convVenta = totalAudiencias > 0 ? ((totalVentas / totalAudiencias) * 100).toFixed(1) : 0;
    
    var fechaHoy = new Date().toLocaleDateString('es-ES', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    
    // Generar HTML del reporte
    var html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Reporte ${delegado}</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif}
        body{padding:15px;background:#f5f5f5;font-size:11px}
        .container{max-width:950px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1);overflow:hidden}
        .header{background:linear-gradient(135deg,#C9A227,#B8963D);color:#fff;padding:20px;text-align:center}
        .header h1{font-size:20px;margin-bottom:4px}
        .header p{font-size:11px;opacity:0.9}
        .section{padding:15px 20px;border-bottom:1px solid #eee}
        .section-title{font-size:12px;font-weight:700;color:#C9A227;margin-bottom:10px;display:flex;align-items:center;gap:6px}
        .grid{display:grid;gap:10px}
        .grid-5{grid-template-columns:repeat(5,1fr)}
        .grid-4{grid-template-columns:repeat(4,1fr)}
        .grid-3{grid-template-columns:repeat(3,1fr)}
        .grid-2{grid-template-columns:repeat(2,1fr)}
        .card{background:#f8f9fa;border-radius:8px;padding:12px;text-align:center}
        .card-value{font-size:20px;font-weight:800;color:#333}
        .card-label{font-size:9px;color:#666;margin-top:2px}
        .green{color:#C9A227}.red{color:#8B7355}.yellow{color:#D4AF37}.blue{color:#3b82f6}
        .bar-container{margin-bottom:6px}
        .bar-label{display:flex;justify-content:space-between;font-size:9px;margin-bottom:2px}
        .bar-track{height:10px;background:#e5e7eb;border-radius:5px;overflow:hidden}
        .bar-fill{height:100%;border-radius:5px}
        .centro-row{display:flex;align-items:center;padding:5px 8px;border-bottom:1px solid #f3f4f6;font-size:10px}
        .centro-row:nth-child(even){background:#fafafa}
        .table-header{display:flex;padding:6px 8px;background:#f3f4f6;font-weight:600;font-size:9px;border-radius:4px 4px 0 0}
        .exclusivo-badge{background:#7c3aed;color:#fff;padding:2px 6px;border-radius:3px;font-size:8px;font-weight:600}
        .activo-badge{background:#10b981;color:#fff;padding:2px 6px;border-radius:3px;font-size:8px}
        .inactivo-badge{background:#9ca3af;color:#fff;padding:2px 6px;border-radius:3px;font-size:8px}
        @media print{body{padding:0;background:#fff}.container{box-shadow:none;border-radius:0}.no-print{display:none}}
    </style></head><body>
    <div class="container">
        <div class="header">
            <h1>🎧 REPORTE AUDIO - DELEGADO REGIONAL</h1>
            <p><strong>${delegado}</strong> | ${fechaHoy}</p>
        </div>`;
    
    // Imagen del dashboard (sin filtros)
    if(dashboardImg) {
        html += `
        <div class="section">
            <div class="section-title">📊 Dashboard</div>
            <img src="${dashboardImg}" style="width:100%;border-radius:8px;border:1px solid #e5e7eb" alt="Dashboard">
        </div>`;
    }
    
    // Resumen general
    html += `
        <div class="section">
            <div class="section-title">📈 RESUMEN GENERAL</div>
            <div class="grid grid-5">
                <div class="card"><div class="card-value">${centrosDelegado.length}</div><div class="card-label">Centros</div></div>
                <div class="card"><div class="card-value blue">${centrosActivos.length}</div><div class="card-label">Con Funnel Activo</div></div>
                <div class="card"><div class="card-value">${informesDelegado.length}</div><div class="card-label">Visitas</div></div>
                <div class="card"><div class="card-value ${promGeneral >= 80 ? 'green' : promGeneral >= 60 ? 'yellow' : 'red'}">${promGeneral}%</div><div class="card-label">Prom. Procesos</div></div>
                <div class="card"><div class="card-value ${pctCumplimiento >= 100 ? 'green' : 'red'}">${pctCumplimiento >= 100 ? '▲' : '▼'}${(pctCumplimiento - 100).toFixed(1)}%</div><div class="card-label">vs Previsto</div></div>
            </div>
        </div>`;
    
    // Exclusivos (si tiene)
    if(centrosExclusivos.length > 0) {
        html += `
        <div class="section" style="background:#faf5ff">
            <div class="section-title" style="color:#7c3aed">⭐ CENTROS EXCLUSIVOS (${centrosExclusivos.length})</div>
            <div class="grid grid-${Math.min(centrosExclusivos.length, 4)}">`;
        centrosExclusivos.forEach(function(c) {
            var cifras = cifrasVentaAudio[c.c] || {};
            html += `<div class="card" style="background:#ede9fe">
                <div style="font-weight:700;font-size:12px">${c.c}</div>
                <div style="font-size:9px;color:#6b21a8;margin-top:2px">${c.n || '-'}</div>
                <div style="margin-top:6px;font-size:10px">Acum: <strong>${Math.round(cifras.acumulado || 0).toLocaleString('es-ES')}€</strong></div>
            </div>`;
        });
        html += '</div></div>';
    }
    
    // AAR y Funnel
    html += `
        <div class="section">
            <div class="grid grid-2">
                <div>
                    <div class="section-title">🎯 Estado AAR</div>
                    <div class="grid grid-3">
                        <div class="card"><div class="card-value green">${aarCert}</div><div class="card-label">Certificados</div></div>
                        <div class="card"><div class="card-value yellow">${aarForm}</div><div class="card-label">En Formación</div></div>
                        <div class="card"><div class="card-value red">${aarPend}</div><div class="card-label">Pendientes</div></div>
                    </div>
                </div>
                <div>
                    <div class="section-title">📊 PROMEDIOS FUNNEL</div>
                    <div class="grid grid-3">
                        <div class="card"><div class="card-value">${totalAudiencias}</div><div class="card-label">Audiencias</div></div>
                        <div class="card"><div class="card-value blue">${convPrueba}%</div><div class="card-label">Conv. Prueba</div></div>
                        <div class="card"><div class="card-value green">${convVenta}%</div><div class="card-label">Conv. Venta</div></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Métricas adicionales funnel -->
        <div class="section">
            <div class="section-title">📈 MÉTRICAS FUNNEL DETALLADAS</div>
            <div class="grid grid-5">
                <div class="card"><div class="card-value">${totalPruebas}</div><div class="card-label">Tot. Pruebas</div></div>
                <div class="card"><div class="card-value">${totalVentas}</div><div class="card-label">Tot. Ventas</div></div>
                <div class="card"><div class="card-value">${totalRenove3a}</div><div class="card-label">Renove 3A</div></div>
                <div class="card"><div class="card-value">${totalRenove42}</div><div class="card-label">Renove +42M</div></div>
                <div class="card"><div class="card-value">${totalMgm}</div><div class="card-label">MGM</div></div>
            </div>
        </div>
        
        <!-- PROMEDIOS PROCESOS -->
        <div class="section">
            <div class="section-title">📋 PROMEDIOS PROCESOS (${informesDelegado.length} visitas)</div>
            <div class="grid grid-2">`;
    
    var bloques = [
        {id:'PIA', nombre:'PIA', color:'#6b7280'},
        {id:'FORMACION', nombre:'Formación', color:'#7c3aed'},
        {id:'COMUNICACION', nombre:'Comunicación', color:'#C9A227'},
        {id:'AYUDAS', nombre:'Ayudas', color:'#ea580c'},
        {id:'COMPLEMENTARIAS', nombre:'Complementarias', color:'#dc2626'},
        {id:'RT', nombre:'RT', color:'#0891b2'},
        {id:'AGENDA', nombre:'Agenda', color:'#db2777'},
        {id:'CONVERSIONES', nombre:'Conversiones', color:'#16a34a'}
    ];
    
    bloques.forEach(function(b) {
        var pct = promediosBloques[b.id] || 0;
        html += `<div class="bar-container">
            <div class="bar-label"><span>${b.nombre}</span><span style="font-weight:700;color:${pct >= 80 ? '#10b981' : pct >= 60 ? '#f59e0b' : '#ef4444'}">${pct}%</span></div>
            <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${b.color}"></div></div>
        </div>`;
    });
    
    html += `</div></div>`;
    
    // LISTADO COMPLETO DE CENTROS DEL DELEGADO
    html += `
        <div class="section">
            <div class="section-title">🏪 LISTADO COMPLETO DE CENTROS (${centrosDelegado.length})</div>
            <div style="overflow-x:auto">
                <table style="width:100%;border-collapse:collapse;font-size:10px">
                    <thead>
                        <tr style="background:#C9A227;color:#fff">
                            <th style="padding:8px 6px;text-align:left;font-weight:600">CÓDIGO</th>
                            <th style="padding:8px 6px;text-align:left;font-weight:600">CENTRO</th>
                            <th style="padding:8px 6px;text-align:center;font-weight:600">TIPO</th>
                            <th style="padding:8px 6px;text-align:center;font-weight:600">PC</th>
                            <th style="padding:8px 6px;text-align:center;font-weight:600">AAR</th>
                            <th style="padding:8px 6px;text-align:center;font-weight:600">FUNNEL</th>
                            <th style="padding:8px 6px;text-align:right;font-weight:600">vs PREV</th>
                        </tr>
                    </thead>
                    <tbody>`;
    
    // Códigos de centros exclusivos
    var exclusivosCodigos = ['4MRM', '4AKI', '4TOL', '4PEC', '4ZDE', '4ABB', '4AXF', '4AZT', '4AZP'];
    
    // Primero los activos, luego los no activos
    var todosCentros = centrosActivos.concat(centrosNoActivos);
    todosCentros.forEach(function(c, idx) {
        var esActivo = c.audiencias > 0 || c.pruebas > 0 || c.ventas > 0;
        var esExclusivo = c.tipo === 'EXCLUSIVO' || exclusivosCodigos.indexOf(c.codigo) !== -1;
        var tipoLabel = esExclusivo ? 'EXC' : (c.propiedad === 'FRANQUICIA' || c.tipo === 'FRANQUICIA') ? 'FR' : 'SUC';
        var tipoBg = tipoLabel === 'EXC' ? '#7c3aed' : tipoLabel === 'FR' ? '#f59e0b' : '#10b981';
        var pcBg = c.pc === 'PC' ? '#8b5cf6' : '#ec4899';
        var aarIcon = c.aar === 'SI' ? '🟢' : (c.aar === 'FORMACIÓN' || c.aar === 'EN FORMACIÓN') ? '🟡' : '🔴';
        var funnelIcon = esActivo ? '<span style="background:#10b981;color:#fff;padding:2px 6px;border-radius:3px;font-size:8px">✓ ACTIVO</span>' : '<span style="background:#ef4444;color:#fff;padding:2px 6px;border-radius:3px;font-size:8px">✗</span>';
        var colorCrec = c.crec >= 0 ? '#10b981' : '#ef4444';
        var bgRow = idx % 2 === 0 ? '#fff' : '#fafafa';
        
        html += `<tr style="background:${bgRow};border-bottom:1px solid #f3f4f6">
            <td style="padding:6px;font-weight:600;color:#C9A227">${c.codigo}</td>
            <td style="padding:6px">${c.nombre || '-'}</td>
            <td style="padding:6px;text-align:center"><span style="background:${tipoBg};color:#fff;padding:2px 8px;border-radius:4px;font-size:9px;font-weight:600">${tipoLabel}</span></td>
            <td style="padding:6px;text-align:center"><span style="background:${pcBg};color:#fff;padding:2px 8px;border-radius:4px;font-size:9px;font-weight:600">${c.pc || '-'}</span></td>
            <td style="padding:6px;text-align:center">${aarIcon}</td>
            <td style="padding:6px;text-align:center">${funnelIcon}</td>
            <td style="padding:6px;text-align:right;font-weight:600;color:${colorCrec}">${c.crec >= 0 ? '▲+' : '▼'}${c.crec.toFixed(1)}%</td>
        </tr>`;
    });
    
    html += `</tbody></table>
            </div>
            <div style="margin-top:10px;display:flex;gap:15px;font-size:9px;color:#666">
                <span>✅ Con Funnel: <strong>${centrosActivos.length}</strong></span>
                <span>❌ Sin Funnel: <strong>${centrosNoActivos.length}</strong></span>
            </div>
        </div>`;
    
    // Últimas visitas
    html += `
        <div class="section">
            <div class="section-title">📅 ÚLTIMAS VISITAS</div>`;
    
    if(informesDelegado.length > 0) {
        var ultimasVisitas = informesDelegado.slice(0, 6);
        html += '<div class="table-header"><span style="flex:0 0 70px">Fecha</span><span style="flex:1">Centro</span><span style="flex:0 0 70px;text-align:right">Resultado</span></div>';
        ultimasVisitas.forEach(function(v) {
            var resultado = v.preinformeData ? v.preinformeData.resultado : 0;
            var colorRes = resultado >= 80 ? '#10b981' : resultado >= 60 ? '#f59e0b' : '#ef4444';
            html += `<div class="centro-row">
                <span style="flex:0 0 70px">${v.fecha || '-'}</span>
                <span style="flex:1">${v.centro || '-'}</span>
                <span style="flex:0 0 70px;text-align:right;font-weight:700;color:${colorRes}">${resultado}%</span>
            </div>`;
        });
    } else {
        html += '<div style="padding:15px;text-align:center;color:#888">Sin visitas registradas</div>';
    }
    
    // Footer
    html += `</div>
        <div style="padding:15px 20px;background:#f8f9fa;text-align:center;font-size:9px;color:#888">
            Generado automáticamente | ${new Date().toLocaleString('es-ES')}
        </div>
    </div></body></html>`;
    
    // Abrir en nueva ventana
    var ventana = window.open('', '_blank', 'width=1000,height=900');
    ventana.document.write(html);
    ventana.document.close();
    ventana.focus();
    
    return html;
}

// Verificar reportes programados al cargar
function verificarReportesProgramados() {
    var config = JSON.parse(localStorage.getItem('reporteProgramado') || 'null');
    if(!config) return;
    
    var hoy = new Date();
    var diaHoy = hoy.getDate();
    var diaSemana = hoy.getDay(); // 0=domingo, 1=lunes
    
    // Verificar si toca enviar
    var tocar = false;
    if(config.frecuencia === 'mensual' && diaHoy === 1) tocar = true;
    if(config.frecuencia === 'semanal' && diaSemana === 1) tocar = true;
    
    if(tocar) {
        // Verificar que no se haya enviado hoy ya
        var ultimoEnvio = localStorage.getItem('ultimoReporteEnviado');
        var fechaHoy = hoy.toISOString().split('T')[0];
        
        if(ultimoEnvio !== fechaHoy) {
            console.log('[Reportes] Ejecutando reporte programado...');
            localStorage.setItem('ultimoReporteEnviado', fechaHoy);
            
            // Mostrar notificación
            setTimeout(function() {
                if(confirm('📊 Hay un reporte programado pendiente. ¿Deseas generarlo ahora?')) {
                    if(config.tipo === 'todos') {
                        enviarReporteTodosDelegados(config.remitente);
                    } else {
                        enviarReporteUnDelegado(config.delegado, config.remitente);
                    }
                }
            }, 2000);
        }
    }
}

// Ejecutar verificación al cargar
setTimeout(verificarReportesProgramados, 3000);

// ═══════════════════════════════════════════════════════════════
// SISTEMA DE GUARDADO AUTOMÁTICO - NUNCA SE PIERDE NADA
// ═══════════════════════════════════════════════════════════════

// Guardar todo automáticamente al cerrar/recargar
window.addEventListener('beforeunload', function(e) {
    guardarTodoSilencioso();
});

// Guardar cuando se cambia de pestaña o minimiza
document.addEventListener('visibilitychange', function() {
    if(document.visibilityState === 'hidden') {
        guardarTodoSilencioso();
    }
});

// Guardar para iOS Safari (pagehide es más fiable que beforeunload en iOS)
window.addEventListener('pagehide', function(e) {
    guardarTodoSilencioso();
});

// Guardar cada 30 segundos automáticamente
setInterval(function() {
    guardarTodoSilencioso();
}, 30000);

// Guardado silencioso (sin alerta)
function guardarTodoSilencioso() {
    try {
        // Preinformes y evaluaciones - SIEMPRE sincronizar incluso vacíos
        if(typeof preinformes !== 'undefined') {
            localStorage.setItem('preinformes', JSON.stringify(preinformes));
            sincronizarConFirebaseDirecto('preinformes', JSON.stringify(preinformes));
        }
        if(typeof informesBorrador !== 'undefined') {
            localStorage.setItem('informesBorrador', JSON.stringify(informesBorrador));
            localStorage.setItem('borradoresInforme', JSON.stringify(informesBorrador));
            sincronizarConFirebaseDirecto('informesBorrador', JSON.stringify(informesBorrador));
            sincronizarConFirebaseDirecto('borradoresInforme', JSON.stringify(informesBorrador));
        }
        if(typeof informesFinalizados !== 'undefined') {
            localStorage.setItem('informesFinalizados', JSON.stringify(informesFinalizados));
            sincronizarConFirebaseDirecto('informesFinalizados', JSON.stringify(informesFinalizados));
        }
        
        // Visitas y acciones - SIEMPRE sincronizar
        if(typeof visitasAgendadas !== 'undefined') {
            localStorage.setItem('visitasAgendadas', JSON.stringify(visitasAgendadas));
            sincronizarConFirebaseDirecto('visitasAgendadas', JSON.stringify(visitasAgendadas));
        }
        if(typeof evaluaciones !== 'undefined') {
            localStorage.setItem('evaluaciones', JSON.stringify(evaluaciones));
            sincronizarConFirebaseDirecto('evaluaciones', JSON.stringify(evaluaciones));
        }
        if(typeof accionesCentros !== 'undefined') localStorage.setItem('accionesCentros', JSON.stringify(accionesCentros));
        if(typeof centrosFlop !== 'undefined') localStorage.setItem('centrosFlop', JSON.stringify(centrosFlop));
        
        // Datos de dashboard (para persistencia offline)
        const funnelData = localStorage.getItem('funnelDashboardData');
        const gamasData = localStorage.getItem('gamasDashboardData');
        if(funnelData) localStorage.setItem('funnelDashboardData_backup', funnelData);
        if(gamasData) localStorage.setItem('gamasDashboardData_backup', gamasData);
        
        console.log('[AutoSave] ✅ Datos guardados y sincronizados -', new Date().toLocaleTimeString());
    } catch(e) {
        console.warn('[AutoSave] Error:', e);
    }
}

function guardarTodo() {
    // Guardar todos los datos en localStorage
    guardarTodoSilencioso();
    
    // También guardar preinformes explícitamente
    if(typeof guardarPreinformesEnStorage === 'function') {
        guardarPreinformesEnStorage();
    }
    
    // Mostrar confirmación
    const msg = document.createElement('div');
    msg.innerHTML = '✅ TODOS LOS DATOS GUARDADOS';
    msg.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#C9A227;color:#fff;padding:12px 24px;border-radius:8px;font-weight:700;font-size:14px;z-index:99999;box-shadow:0 4px 15px rgba(0,0,0,0.3)';
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 2000);
}

function guardarRegistro() {
    guardarPreinformesEnStorage();
    alert('✅ Datos guardados correctamente.');
}

function guardarInforme() {
    alert('✅ Informe guardado en preinformes.');
}

function descargarHTML() {
    const blob = new Blob([document.documentElement.outerHTML], {type: 'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'plataforma-audio-visitas.html';
    a.click();
}

function descargarPDFGeneral() {
    alert('Seleccione un informe específico para descargar en PDF.');
}

function descargarPDFInforme() {
    const element = document.getElementById('informe-contenido');
    const opt = {
        margin: 10,
        filename: 'informe-' + datosPortada.centro.replace(/\s+/g, '-') + '-' + datosPortada.fecha + '.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
}

// INFORME PROFESIONAL
let radarCharts = {};
let preinformeActual = null;

const preguntasMapInf = {
    1:'Gabinete limpio',2:'Uniforme/chapa',3:'Desinfección',4:'Acogida',5:'Nombre paciente',
    6:'Acompañar gabinete',7:'Ofrecer acompañante',8:'Motivo visita',9:'Cómo conocido',10:'Presentación',
    11:'RGPD',12:'Anamnesis HACE',13:'Examen completo',14:'Explicar pruebas',15:'TV encendida',
    16:'Videotoscopia',17:'Timpanometría',18:'VA',19:'VO',20:'UCL',21:'HIT',22:'Logoaudiometría',
    23:'Resumir resultados',24:'Gráficas apoyo',25:'Vincular resultados',26:'Crear necesidad',
    27:'Simular sonidos',28:'Capacitación ambientes',29:'Stock audífonos',30:'Control stock',
    31:'Gama Diamante',32:'Programación',33:'Colocación',34:'Funcionamiento',35:'Documentación',
    36:'Contrato',37:'Registrar GIO',38:'Llamada día siguiente',39:'Citar 4 días',40:'Campo libre',
    41:'Neuroventas',42:'Tchin Tchin',43:'Objeciones',44:'Facilidades pago',45:'Gafa graduada',
    46:'Seguro Caser',47:'Compromisos Audio',48:'2ª pareja',49:'Accesorios TV',50:'Kit higiene',
    51:'Ajuste remoto',52:'Revisión mes 34',53:'Llamadas recordatorio',54:'Discurso llamadas',
    55:'Llamadas control',56:'Formar óptica',57:'MGM',58:'RENOVE',59:'Objetivos',
    60:'Onboarding',61:'Portfolio WSA',62:'Curso PIA',63:'Campañas',64:'Primeros auxilios',65:'Neuroventas form',
    66:'Imagen PdV',67:'Elementos audio',68:'Comunicar servicio',69:'Ayudas estatales',70:'Centro adscrito',
    71:'Pediátrico',72:'Telecare',73:'AAR',74:'Mentoring',75:'TRT',76:'REM',77:'FIAPAS/ONCE',
    78:'Portfolio RT',79:'Políticas',80:'Funnel',81:'Llamadas audio',82:'Stock RT',
    83:'Formación RT',84:'Sinergia',85:'Control agenda',86:'Screening',87:'Derivaciones',88:'Tarjeta revisión'
};

function renderInformePreinformes() {
    // Ya no se usa
}

function mostrarListaPreinformes() {
    const modal = document.getElementById('modal-preinformes');
    const lista = document.getElementById('modal-preinformes-lista');
    const empty = document.getElementById('modal-empty');
    
    if(preinformes.length === 0) {
        lista.innerHTML = '';
        empty.style.display = 'block';
    } else {
        empty.style.display = 'none';
        lista.innerHTML = preinformes.map((p, i) => {
            const cat = getCategoria(p.resultado);
            return '<div class="preinforme-item" style="background:#f8f8f8;border:1px solid #e0e0e0;cursor:pointer;margin-bottom:8px" onclick="seleccionarPreinforme(' + i + ')"><div class="preinforme-top"><div class="preinforme-dot" style="background:' + cat.color + '"></div><div class="preinforme-centro" style="color:#333">' + p.centro + '</div><div class="preinforme-score" style="color:' + cat.color + '">' + p.resultado + '% ' + cat.emoji + '</div></div><div class="preinforme-meta" style="color:#888">' + p.fecha + ' • ' + (p.responsable || '-') + '</div></div>';
        }).join('');
    }
    modal.style.display = 'flex';
}

function cerrarModalPreinformes() {
    document.getElementById('modal-preinformes').style.display = 'none';
}

function seleccionarPreinforme(i) {
    cerrarModalPreinformes();
    preinformeActual = preinformes[i];
    cargarDatosInforme(preinformeActual);
    setTimeout(initRadarCharts, 100);
}

function irAInforme(i) {
    const p = preinformes[i];
    preinformeActual = p;
    window.noLimpiarInforme = true; // No limpiar porque cargamos datos existentes
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-informe').classList.add('active');
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    document.getElementById('page-title').textContent = 'Informe Profesional';
    
    cargarDatosInforme(p);
    
    // Cargar horas de servicio en el campo del informe
    if(p.horasServicio) {
        document.getElementById('inf-horas').value = p.horasServicio;
        actualizarBasico2Horas();
    }
    
    setTimeout(initRadarCharts, 100);
    
    // Forzar carga de cifras de venta después de que el DOM esté listo
    if(p.centro) {
        setTimeout(function() {
            cargarCifrasVentaInforme(p.centro);
            console.log('[irAInforme] Cargando cifras para:', p.centro);
        }, 300);
    }
    
    // Mostrar recordatorio de horas obligatorio
    setTimeout(() => {
        const horasVal = document.getElementById('inf-horas').value;
        if(!horasVal || horasVal.trim() === '') {
            mostrarRecordatorioHoras();
        }
    }, 500);
}

function mostrarRecordatorioHoras() {
    const modal = document.createElement('div');
    modal.id = 'modal-recordatorio-horas';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px';
    modal.innerHTML = `
        <div style="background:#fff;border-radius:12px;padding:24px;max-width:420px;width:100%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);border:3px solid #dc2626">
            <div style="font-size:48px;margin-bottom:12px">⚠️</div>
            <h3 style="margin:0 0 12px 0;font-size:18px;color:#dc2626">Campo Obligatorio Vacío</h3>
            <p style="font-size:13px;color:#666;margin:0 0 16px 0;line-height:1.5">
                El campo <strong style="color:#dc2626">"Horas Servicio"</strong> en la sección <strong>Datos de la Visita</strong> está vacío.<br><br>
                Este dato es <strong>OBLIGATORIO</strong> para finalizar el informe.
            </p>
            <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:12px;margin-bottom:16px;text-align:left">
                <div style="font-size:11px;color:#991b1b;font-weight:600;margin-bottom:6px">📋 Recuerde también:</div>
                <div style="font-size:10px;color:#7f1d1d">• Indicar "Plan de acción local" manualmente en 11 Básicos</div>
            </div>
            <button onclick="cerrarRecordatorioHoras()" style="background:rgba(201,162,39,0.92);color:#fff;border:none;padding:12px 32px;border-radius:8px;font-weight:700;font-size:14px;cursor:pointer">
                ✓ Entendido, lo completo ahora
            </button>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Resaltar campo de horas en rojo
    const horasInput = document.getElementById('inf-horas');
    if(horasInput) {
        horasInput.style.border = '2px solid #dc2626';
        horasInput.style.background = '#fef2f2';
        horasInput.placeholder = '⚠️ OBLIGATORIO';
    }
}

function cerrarRecordatorioHoras() {
    const modal = document.getElementById('modal-recordatorio-horas');
    if(modal) modal.remove();
    
    // Enfocar campo de horas
    const horasInput = document.getElementById('inf-horas');
    if(horasInput) horasInput.focus();
}

function cargarInformeArchivo(event) {
    const file = event.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            preinformeActual = data;
            cargarDatosInforme(data);
            setTimeout(initRadarCharts, 100);
        } catch(err) {
            alert('Error al cargar el archivo: ' + err.message);
        }
    };
    reader.readAsText(file);
}

function abrirInforme(i) {
    preinformeActual = preinformes[i];
    cargarDatosInforme(preinformeActual);
    setTimeout(initRadarCharts, 100);
}

function volverSelector() {
    // Ya no se usa
}

function cargarDatosInforme(data) {
    document.getElementById('inf-centro').value = data.centro || '';
    document.getElementById('inf-propietario').value = data.propietario || '';
    document.getElementById('inf-delegado-regional').value = data.delegadoRegional || '';
    document.getElementById('inf-pcpnc').value = data.pcpnc || '';
    document.getElementById('inf-fecha').value = data.fecha || '';
    document.getElementById('inf-delegado-audio').value = data.delegadoAudio || data.responsable || 'Ariannys Rojas';
    document.getElementById('inf-tipo-visita').value = data.tipoVisita || 'Seguimiento';
    document.getElementById('inf-horas').value = data.horasServicio || '';
    document.getElementById('inf-nombre-audiologo').value = data.nombreAudiologo || data.audiologo || '';
    // Cargar PC/PNC automáticamente si no viene en data
    if(!data.pcpnc && data.centro) cargarPCPNCInforme(data.centro);
    // Cargar Cifras de Venta automáticamente - múltiples intentos
    if(data.centro) {
        console.log('[cargarDatosInforme] Centro a cargar cifras:', data.centro);
        // Intento inmediato
        cargarCifrasVentaInforme(data.centro);
        // Intento con delay
        setTimeout(function() { 
            console.log('[cargarDatosInforme] Reintento carga cifras');
            cargarCifrasVentaInforme(data.centro); 
        }, 300);
    }
    var nombreAud = data.nombreAudiologo || data.audiologo || '';
    const firmaEl = document.getElementById('inf-header-firma');
    if(firmaEl) firmaEl.innerHTML = '<span style="font-size:8px;color:#888;display:block">Responsable Audio</span><span style="font-size:11px;font-weight:600;color:#C9A227">' + (data.delegadoAudio || data.responsable || 'Ariannys Rojas') + '</span>' + (nombreAud ? '<span style="font-size:8px;color:#888;display:block;margin-top:2px">Audiólogo</span><span style="font-size:10px;font-weight:600;color:#333">' + nombreAud + '</span>' : '');
    
    // Cargar paquete del centro
    setTimeout(function() { cargarPaqueteInforme(data.centro); }, 100);
    
    // Cargar gamas desde Funnel automáticamente
    if(data.centro) {
        setTimeout(function() { cargarGamasAutomatico(data.centro); }, 200);
    }
    
    // Cargar gamas guardadas si existen
    if(data.gamas) {
        document.getElementById('gama-diamante-plus').value = data.gamas.diamantePlus || 0;
        document.getElementById('gama-diamante').value = data.gamas.diamante || 0;
        document.getElementById('gama-platino-plus').value = data.gamas.platinoPlus || 0;
        document.getElementById('gama-platino').value = data.gamas.platino || 0;
        document.getElementById('gama-oro').value = data.gamas.oro || 0;
        calcularGamas();
    }
    
    // Cargar tipo de atención guardado si existe
    if(data.tipoAtencion) {
        document.getElementById('tipoaten-adulto').value = data.tipoAtencion.adulto || 0;
        document.getElementById('tipoaten-tinnitus').value = data.tipoAtencion.tinnitus || 0;
        document.getElementById('tipoaten-pediatrico').value = data.tipoAtencion.pediatrico || 0;
        calcularTipoAtencion();
    }
    
    if(data.observaciones) document.getElementById('txt-observaciones').value = data.observaciones;
    if(data.recomendaciones) document.getElementById('txt-recomendaciones').value = data.recomendaciones;
    if(data.compromisos) document.getElementById('txt-compromisos').value = data.compromisos;
    if(data.tiempoCompromisos) document.getElementById('tiempo-compromisos').value = data.tiempoCompromisos;
    
    const cat = getCategoria(data.resultado);
    document.getElementById('inf-res-valor').textContent = data.resultado + '%';
    document.getElementById('inf-res-valor').style.color = cat.color;
    document.getElementById('inf-res-emoji').textContent = cat.emoji;
    document.getElementById('inf-res-cat').textContent = cat.nombre;
    document.getElementById('inf-res-msg').textContent = cat.mensaje;
    
    const resp = data.respuestas || {};
    const bloquesPct = calcularBloquesPct(resp);
    
    actualizarBarra('pia', bloquesPct.PIA, 25);
    actualizarBarra('form', bloquesPct.FORMACION, 15);
    actualizarBarra('com', bloquesPct.COMUNICACION, 15);
    actualizarBarra('ayu', bloquesPct.AYUDAS, 4);
    actualizarBarra('comp', bloquesPct.COMPLEMENTARIAS, 6);
    actualizarBarra('rt', bloquesPct.RT, 25);
    actualizarBarra('conv', bloquesPct.CONVERSIONES, 0);
    actualizarBarra('age', bloquesPct.AGENDA, 10);
    
    const v1 = resp['90_pv'] || 0, rev = resp['90_rev'] || resp[90] || 0;
    const pctPrueba = resp[99] || 0;
    const pctVenta = resp[100] || 0;
    const pctScreen = resp[98] || 0;
    
    // Actualizar tarjetas de conversiones principales
    document.getElementById('conv-pct-prueba').value = pctPrueba;
    document.getElementById('conv-pct-venta').value = pctVenta;
    document.getElementById('conv-pct-screen').value = pctScreen;
    
    document.getElementById('conv-mgm-val').value = resp[95] || 0;
    document.getElementById('conv-renove-val').value = resp[96] || 0;
    document.getElementById('conv-seguro-val').value = resp[97] || 0;
    document.getElementById('conv-ayudas-val').value = resp[94] || 0;
    document.getElementById('conv-imagen-val').value = resp[66] === 'si' ? 1 : 0;
    
    setTimeout(() => initDonutCharts(pctPrueba, pctVenta, pctScreen), 100);
    
    actualizarKPIsInf(resp);
    generarAreasMejora(resp);
    generarResumenInterpretacion(data.resultado, bloquesPct, resp);
    
    // Auto-rellenar 11 Básicos basándose en respuestas (después de que el campo horas esté rellenado)
    setTimeout(() => autoRellenarBasicos(resp, null), 150);
    
    // Auto-rellenar CIFRAS VENTA AUDIO del centro
    setTimeout(() => rellenarCifrasCentroInforme(data.centro, data.codigo), 200);
}

// ==================== RELLENAR CIFRAS EN INFORME AUTOMÁTICAMENTE ====================
function rellenarCifrasCentroInforme(nombreCentro, codigoCentro) {
    // Buscar en cifrasExclusivos por código o por nombre
    let centroEncontrado = null;
    
    if(typeof cifrasExclusivos !== 'undefined' && cifrasExclusivos.length > 0) {
        // Primero buscar por código exacto
        if(codigoCentro) {
            centroEncontrado = cifrasExclusivos.find(c => c.cod === codigoCentro);
        }
        
        // Si no encontró, buscar por nombre (parcial)
        if(!centroEncontrado && nombreCentro) {
            const nombreNorm = nombreCentro.toUpperCase().trim();
            centroEncontrado = cifrasExclusivos.find(c => {
                const tiendaNorm = c.tienda.toUpperCase();
                return tiendaNorm.includes(nombreNorm) || nombreNorm.includes(c.cod);
            });
        }
    }
    
    // Obtener elementos del informe (ahora son inputs)
    const elAcum = document.getElementById('inf-cifra-acum');
    const elPrev = document.getElementById('inf-cifra-prev');
    
    if(centroEncontrado) {
        // Rellenar con datos del centro encontrado
        const acumulado = centroEncontrado.vnc || 0;
        const previsto = centroEncontrado.previsto || 0;
        
        if(elAcum) elAcum.value = acumulado;
        if(elPrev) elPrev.value = previsto;
        
        // Recalcular diferencia y porcentaje
        recalcularCifrasInforme();
        
        console.log('[Cifras Informe] ✓ Datos cargados para:', centroEncontrado.tienda);
    } else {
        // No encontrado - dejar en 0 para edición manual
        if(elAcum) elAcum.value = 0;
        if(elPrev) elPrev.value = 0;
        recalcularCifrasInforme();
        
        console.log('[Cifras Informe] Centro no encontrado, campos editables:', nombreCentro);
    }
    
    // También rellenar datos del funnel si hay datos en Firebase
    rellenarFunnelCentroInforme(nombreCentro, codigoCentro);
}

// Recalcular diferencia y % cumplimiento cuando se editan manualmente
function recalcularCifrasInforme() {
    const elAcum = document.getElementById('inf-cifra-acum');
    const elPrev = document.getElementById('inf-cifra-prev');
    const elDif = document.getElementById('inf-cifra-dif');
    const elPct = document.getElementById('inf-cifra-pct');
    
    const acumulado = parseFloat(elAcum?.value) || 0;
    const previsto = parseFloat(elPrev?.value) || 0;
    const diferencia = acumulado - previsto;
    const pctCumplimiento = previsto > 0 ? (acumulado / previsto) * 100 : 0;
    
    if(elDif) {
        elDif.textContent = (diferencia >= 0 ? '+' : '') + Math.round(diferencia).toLocaleString('es-ES') + ' €';
        elDif.style.color = diferencia >= 0 ? '#10b981' : '#ef4444';
    }
    
    // Mostrar % crecimiento sobre previsto con flecha
    if(elPct) {
        var crecimiento = pctCumplimiento - 100; // Diferencia respecto al 100%
        if(crecimiento >= 0) {
            elPct.innerHTML = '<span style="color:#C9A227">▲ +' + crecimiento.toFixed(1) + '%</span>';
        } else {
            elPct.innerHTML = '<span style="color:#8B7355">▼ ' + crecimiento.toFixed(1) + '%</span>';
        }
    }
}

// Rellenar datos del funnel del centro desde Firebase/localStorage
function rellenarFunnelCentroInforme(nombreCentro, codigoCentro) {
    // Cargar datos guardados localmente del funnel
    const funnelData = JSON.parse(localStorage.getItem('funnelDashboardData') || '{}');
    const gamasData = JSON.parse(localStorage.getItem('gamasDashboardData') || '{}');
    
    // Si hay datos de gamas globales, usarlos como referencia
    if(gamasData.diamante !== undefined || gamasData.diamantePlus !== undefined) {
        const elDiamantePlus = document.getElementById('inf-gama-diamante-plus');
        const elDiamante = document.getElementById('inf-gama-diamante');
        const elPlatinoPlus = document.getElementById('inf-gama-platino-plus');
        const elPlatino = document.getElementById('inf-gama-platino');
        const elOro = document.getElementById('inf-gama-oro');
        
        // Solo rellenar si están vacíos (valor 0)
        if(elDiamantePlus && elDiamantePlus.value == '0') elDiamantePlus.value = gamasData.diamantePlus || 0;
        if(elDiamante && elDiamante.value == '0') elDiamante.value = gamasData.diamante || 0;
        if(elPlatinoPlus && elPlatinoPlus.value == '0') elPlatinoPlus.value = gamasData.platinoPlus || 0;
        if(elPlatino && elPlatino.value == '0') elPlatino.value = gamasData.platino || 0;
        if(elOro && elOro.value == '0') elOro.value = gamasData.oro || 0;
        
        // Actualizar
        if(typeof actualizarPctGamasInforme === 'function') actualizarPctGamasInforme();
    }
    
    console.log('[Funnel Informe] Datos del funnel cargados');
}

function formatearEuroInforme(num) {
    if(num === null || num === undefined) return '-';
    return num.toLocaleString('es-ES') + ' €';
}

// Actualizar porcentajes de gamas en el informe (usa cuadro de mandos audio)
function actualizarPctGamasInforme() {
    // Las gamas se manejan en el cuadro de mandos audio (gama-diamante-plus, etc.)
    // Esta función ya no necesita hacer nada con inf-gama-* 
    calcularGamas();
}

function autoRellenarBasicos(resp, horasServicio) {
    // Calcular % bloque Formación (Q60-65)
    let formOk = 0, formTotal = 0;
    for(let i = 60; i <= 65; i++) {
        formTotal++;
        if(resp[i] === 'si') formOk++;
    }
    const pctFormacion = formTotal > 0 ? Math.round((formOk / formTotal) * 100) : 0;
    
    // Calcular % bloque PIA (Q1-59)
    let piaOk = 0, piaTotal = 0;
    for(let i = 1; i <= 59; i++) {
        piaTotal++;
        if(resp[i] === 'si' || (typeof resp[i] === 'number' && resp[i] > 0)) piaOk++;
    }
    const pctPIA = piaTotal > 0 ? Math.round((piaOk / piaTotal) * 100) : 0;
    
    // Valores porcentuales para screening y conversiones
    const pctScreen = parseInt(resp[98]) || 0;
    const pctPrueba = parseInt(resp[99]) || 0;
    const pctVenta = parseInt(resp[100]) || 0;
    
    // Leer horas del campo del informe (tiene prioridad) o del parámetro
    const horasInput = document.getElementById('inf-horas');
    const horas = parseFloat(horasInput ? horasInput.value : horasServicio) || 0;
    
    // Array de cumplimiento (true = SÍ cumple el criterio)
    const basicos = [
        resp[66] === 'si',                    // 1. Visibilidad
        horas >= 20,                          // 2. 20h presencia
        pctFormacion >= 80,                   // 3. Formación >= 80%
        pctPIA >= 80,                         // 4. PIA >= 80%
        resp[84] === 'si',                    // 5. Integración
        pctScreen >= 80,                      // 6. Screening >= 80%
        pctPrueba >= 80 && pctVenta >= 80,   // 7. 80-80
        null,                                 // 8. Plan local - MANUAL
        resp[29] === 'si',                    // 9. Stock
        resp[42] === 'si',                    // 10. Tchin Tchin
        resp[44] === 'si'                     // 11. Infinity
    ];
    
    // Marcar checkboxes: checked = SÍ cumple
    for(let i = 0; i < 11; i++) {
        const cb = document.getElementById('basico-' + (i + 1));
        if(cb) {
            if(i === 7) {
                // Plan local es manual - no tocarlo
            } else {
                cb.checked = basicos[i] === true;
            }
        }
    }
    
    // Actualizar pentágono
    setTimeout(actualizarPentagono, 100);
}

// Función para actualizar básico 2 (presencia) cuando cambia el campo horas
function grabarNombreAudiologo() {
    var nombre = document.getElementById('inf-nombre-audiologo').value.trim();
    if(!nombre) return;
    // Actualizar header firma
    var delegAudio = document.getElementById('inf-delegado-audio')?.value || 'Ariannys Rojas';
    var firmaEl = document.getElementById('inf-header-firma');
    if(firmaEl) firmaEl.innerHTML = '<span style="font-size:8px;color:#888;display:block">Responsable Audio</span><span style="font-size:11px;font-weight:600;color:#C9A227">' + delegAudio + '</span><span style="font-size:8px;color:#888;display:block;margin-top:2px">Audiólogo</span><span style="font-size:10px;font-weight:600;color:#333">' + nombre + '</span>';
    // Auto-guardar borrador si hay centro
    var centro = document.getElementById('inf-centro')?.value;
    if(centro) {
        try { guardarBorradorInforme(); } catch(e) { console.warn('[grabarAudiologo] Auto-save error:', e); }
    }
    // Feedback visual
    var inp = document.getElementById('inf-nombre-audiologo');
    inp.style.border = '2px solid #22c55e';
    inp.style.background = '#f0fdf4';
    setTimeout(function(){ inp.style.border = '1px solid #ddd'; inp.style.background = '#fafafa'; }, 1500);
    inp.blur();
}

function actualizarBasico2Horas() {
    const horasInput = document.getElementById('inf-horas');
    const horas = parseFloat(horasInput ? horasInput.value : 0) || 0;
    const cb = document.getElementById('basico-2');
    if(cb) {
        cb.checked = horas >= 20;
    }
    // Quitar estilo de error si ya tiene valor
    if(horasInput && horas > 0) {
        horasInput.style.border = '';
        horasInput.style.background = '';
        horasInput.placeholder = '';
    }
    actualizarPentagono();
}

function seleccionarPlanLocal(valor) {
    const cb = document.getElementById('basico-8');
    const selector = document.getElementById('plan-local-selector');
    
    // Marcar checkbox según selección
    if(cb) cb.checked = (valor === 'si');
    
    // Ocultar selector
    if(selector) selector.style.display = 'none';
    
    // Marcar que ya se seleccionó
    planLocalSeleccionado = true;
    
    actualizarPentagono();
}

var planLocalSeleccionado = false;

function verificarPlanLocalSeleccionado() {
    return planLocalSeleccionado;
}

function actualizarBarra(id, porcentaje, peso) {
    document.getElementById('bar-' + id).style.width = porcentaje + '%';
    document.getElementById('pct-' + id).textContent = porcentaje + '%';
    document.getElementById('apl-' + id).textContent = (peso > 0 ? ((porcentaje / 100) * peso).toFixed(1) : '0.0') + '%';
}

function calcularBloquesPct(resp) {
    const config = {PIA:{start:1,end:57},FORMACION:{start:58,end:65},COMUNICACION:{start:66,end:68},AYUDAS:{start:69,end:70},COMPLEMENTARIAS:{start:71,end:77},RT:{start:78,end:88},AGENDA:{start:89,end:93},CONVERSIONES:{start:94,end:100}};
    const result = {};
    Object.keys(config).forEach(b => {
        let si = 0, total = 0;
        for(let i = config[b].start; i <= config[b].end; i++) {
            total++;
            if(resp[i] === 'si' || (typeof resp[i] === 'number' && resp[i] > 0)) si++;
        }
        result[b] = total > 0 ? Math.round((si/total)*100) : 0;
    });
    return result;
}

function initRadarCharts() {
    const resp = preinformeActual ? (preinformeActual.respuestas || {}) : {};
    const dataPia = calcRadarPIA(resp);
    const dataRt = calcRadarRT(resp);
    const dataForm = calcRadarForm(resp);
    
    createRadar('radar-pia', ['Gabinete','Anamnesis','Timpanometría','Capacitación','Stock','Tchin Tchin','NextYear','Infinity','Compromisos'], dataPia, '#C9A227');
    createRadar('radar-rt', ['Incógnito','Condiciones','Funnel','Stock','Form. Audio','Sinergias','Screening','Derivaciones'], dataRt, '#8B7355');
    createRadar('radar-form', ['Onboarding','WSA-Starkey','PIA','Campañas','Equipo Ópt.','HIT','Aj. Remoto','Hab. Venta'], dataForm, '#D4AF37');
    
    // Actualizar resúmenes de radares
    const resumenPia = document.getElementById('resumen-pia');
    const resumenRt = document.getElementById('resumen-rt');
    const resumenForm = document.getElementById('resumen-form');
    
    const promPia = dataPia.length > 0 ? Math.round(dataPia.reduce((a,b) => a+b, 0) / dataPia.length) : 0;
    const promRt = dataRt.length > 0 ? Math.round(dataRt.reduce((a,b) => a+b, 0) / dataRt.length) : 0;
    const promForm = dataForm.length > 0 ? Math.round(dataForm.reduce((a,b) => a+b, 0) / dataForm.length) : 0;
    
    if (resumenPia) resumenPia.innerHTML = '<strong>Promedio PIA:</strong> ' + promPia + '%';
    if (resumenRt) resumenRt.innerHTML = '<strong>Promedio RT:</strong> ' + promRt + '%';
    if (resumenForm) resumenForm.innerHTML = '<strong>Promedio Formación:</strong> ' + promForm + '%';
    
    // Inicializar pentágono del informe
    setTimeout(actualizarPentagono, 50);
}

let donutCharts = {};
function initDonutCharts(prueba, venta, screen) {
    const getColor = (value) => {
        if(value >= 80) return '#C9A227';
        if(value >= 50) return '#b8960c';
        return '#5c5c5c';
    };
    
    const configs = [
        {id: 'donut-prueba', value: prueba, color: getColor(prueba)},
        {id: 'donut-venta', value: venta, color: getColor(venta)},
        {id: 'donut-screen', value: screen, color: getColor(screen)}
    ];
    
    configs.forEach(cfg => {
        const canvas = document.getElementById(cfg.id);
        if(!canvas) {
            console.log('Canvas no encontrado:', cfg.id);
            return;
        }
        if(donutCharts[cfg.id]) donutCharts[cfg.id].destroy();
        
        // Capturar valores para el closure
        const displayValue = cfg.value;
        const displayColor = cfg.color;
        
        donutCharts[cfg.id] = new Chart(canvas, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [displayValue, 100 - displayValue],
                    backgroundColor: [displayColor, '#e5e5e5'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '65%',
                plugins: { 
                    legend: { display: false }, 
                    tooltip: { enabled: false }
                }
            },
            plugins: [{
                id: 'centerText',
                afterDraw: function(chart) {
                    const ctx = chart.ctx;
                    const width = chart.width;
                    const height = chart.height;
                    ctx.save();
                    const fontSize = Math.min(width, height) / 4;
                    ctx.font = 'bold ' + fontSize + 'px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = displayColor;
                    ctx.fillText(displayValue + '%', width / 2, height / 2);
                    ctx.restore();
                }
            }]
        });
    });
}

function createRadar(canvasId, labels, data, color) {
    const ctx = document.getElementById(canvasId);
    if(!ctx) return;
    if(radarCharts[canvasId]) radarCharts[canvasId].destroy();
    radarCharts[canvasId] = new Chart(ctx, {
        type: 'radar',
        data: { labels, datasets: [{ data, backgroundColor: color + '40', borderColor: color, borderWidth: 2, pointBackgroundColor: color, pointRadius: 2 }] },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            scales: { 
                r: { 
                    beginAtZero: true, 
                    max: 100, 
                    min: 0,
                    ticks: { 
                        display: true, 
                        stepSize: 20, 
                        font: { size: 9 }, 
                        color: '#666',
                        backdropColor: 'rgba(255,255,255,0.8)'
                    }, 
                    pointLabels: { 
                        font: { size: 11, weight: '700' }, 
                        color: '#222' 
                    }, 
                    grid: { color: '#ddd', lineWidth: 1 },
                    angleLines: { color: '#ddd' }
                } 
            }, 
            plugins: { legend: { display: false } } 
        }
    });
}

function calcRadarPIA(resp) {
    // PIA - UNA pregunta por KPI (BINARIO: 100% o 0%)
    return [
        resp[1] === 'si' ? 100 : 0,   // Gabinete
        resp[12] === 'si' ? 100 : 0,  // Anamnesis
        resp[17] === 'si' ? 100 : 0,  // Timpanometría
        resp[28] === 'si' ? 100 : 0,  // Capacitación
        resp[29] === 'si' ? 100 : 0,  // Stock
        resp[42] === 'si' ? 100 : 0,  // Tchin Tchin
        resp[43] === 'si' ? 100 : 0,  // NextYear
        resp[44] === 'si' ? 100 : 0,  // Infinity
        resp[47] === 'si' ? 100 : 0   // Compromisos
    ];
}

function calcRadarRT(resp) { 
    // RT - UNA pregunta por KPI (BINARIO: 100% o 0%)
    return [
        resp[78] === 'si' ? 100 : 0,  // Incógnito
        resp[79] === 'si' ? 100 : 0,  // Condiciones
        resp[80] === 'si' ? 100 : 0,  // Funnel
        resp[82] === 'si' ? 100 : 0,  // Stock
        resp[83] === 'si' ? 100 : 0,  // Form. Audio
        resp[84] === 'si' ? 100 : 0,  // Sinergias
        resp[86] === 'si' ? 100 : 0,  // Screening
        resp[88] === 'si' ? 100 : 0   // Derivaciones
    ];
}

function calcRadarForm(resp) { 
    // FORMACIÓN - UNA pregunta por KPI (BINARIO: 100% o 0%)
    return [
        resp[58] === 'si' ? 100 : 0,  // Onboarding Academy
        resp[59] === 'si' ? 100 : 0,  // Portfolio WSA/Starkey
        resp[60] === 'si' ? 100 : 0,  // Curso PIA
        resp[61] === 'si' ? 100 : 0,  // Campañas vigentes
        resp[62] === 'si' ? 100 : 0,  // Primeros auxilios equipo óptica
        resp[63] === 'si' ? 100 : 0,  // HIT
        resp[64] === 'si' ? 100 : 0,  // Telecare/Ajuste remoto
        resp[65] === 'si' ? 100 : 0   // Neuroventas/Habilidades comerciales
    ];
}

function actualizarKPIsInf(resp) {
    const kpis = [{id:'kpi-aar',p:73},{id:'kpi-tchin',p:41},{id:'kpi-infinity',p:44},{id:'kpi-seguro',p:46},{id:'kpi-renove',p:58},{id:'kpi-mgm',p:57},{id:'kpi-hit34',p:51},{id:'kpi-screen',p:86},{id:'kpi-imagen',p:66}];
    kpis.forEach(k => {
        const el = document.getElementById(k.id);
        if(!el) return;
        const ok = resp[k.p] === 'si';
        if(ok) {
            el.classList.add('ok');
        } else {
            el.classList.remove('ok');
        }
    });
    // Agenda Inteligente: semáforo basado en % (>=75 verde, 50-74 ambar, <50 rojo)
    const agendaEl = document.getElementById('kpi-agenda');
    if(agendaEl) {
        const pctAgenda = resp[91] || 0;
        agendaEl.classList.remove('ok', 'ambar');
        if(pctAgenda >= 75) {
            agendaEl.classList.add('ok');
        } else if(pctAgenda >= 50) {
            agendaEl.classList.add('ambar');
        }
    }
}

function generarAreasMejora(resp) {
    const mejoras = [];
    
    for(let i = 1; i <= 88; i++) {
        if(resp[i] === 'no' || resp[i] === 0) {
            const preg = preguntas.find(p => p.id === i);
            let bloque = preg ? preg.bloque : '';
            let etiqueta = '';
            
            if(bloque === 'PIA') {
                etiqueta = 'Consulta PIA y Píldoras en Academy';
            } else if(bloque === 'FORMACION') {
                etiqueta = 'Consulta Cursos y Píldoras en Academy';
            } else {
                etiqueta = 'Apóyate en Cursos de Academy, Píldoras, Mentoring y Responsables de Audio';
            }
            
            mejoras.push({
                id: i,
                area: preguntasMapInf[i] || 'Criterio ' + i,
                detalle: preg ? preg.detalle : '',
                etiqueta: etiqueta,
                bloque: bloque
            });
        }
    }
    
    const tbody = document.getElementById('mejoras-tbody');
    if(mejoras.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:10px;color:#C9A227;background:#f0fdf4">✅ Sin áreas de mejora</td></tr>';
        return;
    }
    
    tbody.innerHTML = mejoras.map((m, i) => {
        const bgColor = i % 2 === 0 ? '#fff' : '#f9f9f9';
        return '<tr style="background:' + bgColor + '">' +
            '<td style="padding:4px 6px;border:1px solid #e0e0e0;font-size:9px;vertical-align:top"><strong style="color:#5c5c5c">Q' + m.id + '</strong> ' + m.area + '</td>' +
            '<td style="padding:4px 6px;border:1px solid #e0e0e0;font-size:8px;line-height:1.4">' + m.detalle + ' <span style="color:#6b7280;font-style:italic;font-size:7px">📚 ' + m.etiqueta + '</span></td>' +
            '<td style="padding:4px;border:1px solid #e0e0e0;text-align:center;font-size:8px;vertical-align:middle"><select style="font-size:8px;padding:2px;border:1px solid #ddd;border-radius:3px"><option value="3meses">3 meses</option><option value="1mes">1 mes</option></select></td>' +
        '</tr>';
    }).join('');
}

function generarResumenInterpretacion(resultado, bloquesPct, resp) {
    const el = document.getElementById('inf-resumen-texto');
    const resumenContainer = document.getElementById('resumen-general-container');
    
    // Encontrar bloques fuertes (>=80%) y débiles (<60%)
    const bloquesFuertes = [];
    const bloquesMedios = [];
    const bloquesDebiles = [];
    const nombresBloque = {
        PIA: 'Protocolo PIA',
        FORMACION: 'Formación',
        COMUNICACION: 'Comunicación',
        AYUDAS: 'Ayudas',
        COMPLEMENTARIAS: 'Act. Complementarias',
        RT: 'Responsable Tienda',
        AGENDA: 'Gestión Agenda',
        CONVERSIONES: 'Conversiones'
    };
    
    Object.keys(bloquesPct).forEach(b => {
        const pct = bloquesPct[b];
        if(pct >= 80) bloquesFuertes.push({nombre: nombresBloque[b], pct: pct});
        else if(pct >= 60) bloquesMedios.push({nombre: nombresBloque[b], pct: pct});
        else bloquesDebiles.push({nombre: nombresBloque[b], pct: pct});
    });
    
    // Ordenar por porcentaje
    bloquesFuertes.sort((a,b) => b.pct - a.pct);
    bloquesDebiles.sort((a,b) => a.pct - b.pct);
    
    // Determinar categoría del centro
    let categoria, icono, colorCat, mensajeEspecial = '';
    if (resultado === 0) {
        categoria = 'NO EVALÚA';
        icono = '🚫';
        colorCat = '#dc2626';
        
        // Detectar qué criterio obligatorio no cumple
        const obligatoriasIds = [3,4,6,7,11,14,23,41,43,47,58,59,60];
        const nombresOblig = {
            3: 'Espéculos, olivas y cascos desinfectados, tener un lugar adecuado para almacenar los usados',
            4: 'Acoger al cliente con una sonrisa, amable y cercano',
            6: 'Acompañar al paciente al gabinete para la revisión auditiva',
            7: 'Ofrecer pasar a gabinete al acompañante',
            11: 'Abrir ficha y rellenar RGPD completa (incluidos checks de condiciones comerciales)',
            14: 'Realizar una breve explicación en cada prueba y asegurarnos de que lo ha entendido',
            23: 'Resumir los resultados y dar explicación',
            41: 'Aplicar Tchin Tchin',
            43: 'Explicar facilidades de pago: NextYear',
            47: 'Detallar los compromisos Audio',
            58: 'Onboarding realizado en Afflelou Academy',
            59: 'Portfolio WSA y Starkey',
            60: 'Realizar curso PIA última versión'
        };
        let criteriosFallidos = [];
        for(let i = 0; i < obligatoriasIds.length; i++) {
            const id = obligatoriasIds[i];
            if(resp && resp[id] === 'no') {
                criteriosFallidos.push(nombresOblig[id] || ('Criterio ' + id));
            }
        }
        
        mensajeEspecial = '<div style="background:#fef2f2;border:1px solid #dc2626;border-radius:4px;padding:6px 8px;margin-bottom:8px">';
        mensajeEspecial += '<span style="font-size:8px;color:#dc2626;font-weight:700">⛔ NO EVALÚA: No cumple CRITERIO OBLIGATORIO para Audio</span>';
        if(criteriosFallidos.length > 0) {
            mensajeEspecial += '<br><span style="font-size:8px;color:#dc2626">❌ <strong>Criterio(s) incumplido(s):</strong> ' + criteriosFallidos.join(' | ') + '</span>';
        }
        mensajeEspecial += '</div>';
    } else if (resultado >= 95) {
        categoria = 'CENTRO MAESTRO';
        icono = '🏆';
        colorCat = '#C9A227';
    } else if (resultado >= 90) {
        categoria = 'CENTRO ELITE';
        icono = '🥇';
        colorCat = '#C9A227';
    } else if (resultado >= 80) {
        categoria = 'CENTRO PRO';
        icono = '🥈';
        colorCat = '#6b7280';
    } else {
        categoria = 'MEJORABLE';
        icono = '⚠️';
        colorCat = '#dc2626';
    }
    
    // Generar HTML del resumen general - COMPACTO PARA IMPRESIÓN
    if(resumenContainer) {
        let html = '<div style="background:#f8f8f8;border-radius:6px;padding:10px;border:1px solid #e0e0e0">';
        html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #e0e0e0">';
        html += '<span style="font-size:28px">' + icono + '</span>';
        html += '<div><div style="font-size:14px;font-weight:700;color:' + colorCat + '">' + categoria + '</div>';
        html += '<div style="font-size:10px;color:#666">Puntuación global: <strong>' + resultado + '%</strong></div></div></div>';
        
        // Mensaje especial si es 0%
        html += mensajeEspecial;
        
        // Análisis por bloques - una línea cada tipo
        html += '<div style="margin-bottom:8px;font-size:8px;line-height:1.4">';
        if(bloquesFuertes.length > 0) {
            html += '<span style="color:#166534">✅ <strong>Fortalezas:</strong> ' + bloquesFuertes.slice(0,3).map(b => b.nombre + ' (' + b.pct + '%)').join(', ') + '</span><br>';
        }
        if(bloquesMedios.length > 0) {
            html += '<span style="color:#b8960c">⚠️ <strong>En desarrollo:</strong> ' + bloquesMedios.slice(0,3).map(b => b.nombre + ' (' + b.pct + '%)').join(', ') + '</span><br>';
        }
        if(bloquesDebiles.length > 0) {
            html += '<span style="color:#dc2626">🔴 <strong>Requieren atención:</strong> ' + bloquesDebiles.slice(0,3).map(b => b.nombre + ' (' + b.pct + '%)').join(', ') + '</span>';
        }
        html += '</div>';
        
        // Recomendaciones compactas (todo lo que no sea MAESTRO)
        if (resultado < 95) {
            html += '<div style="background:#fff;border-radius:4px;padding:6px 8px;border-left:3px solid #C9A227">';
            html += '<div style="font-size:9px;font-weight:700;color:#C9A227;margin-bottom:4px">📋 Recomendaciones</div>';
            html += '<div style="font-size:8px;color:#555">📚 Academy · 📄 Hotspot · 👥 Mentoring · 🎧 Píldoras de Audio</div>';
            html += '</div>';
        } else {
            html += '<div style="background:#dcfce7;border-radius:4px;padding:6px;text-align:center">';
            html += '<div style="font-size:10px;font-weight:700;color:#166534">🌟 ¡Felicidades! Centro con máxima excelencia</div>';
            html += '</div>';
        }
        
        html += '</div>';
        resumenContainer.innerHTML = html;
    }
    
    // Generar texto para el textarea de resumen
    if(el) {
        let texto = '';
        
        // Resultado global con categoría
        texto = icono + ' ' + categoria + ' (' + resultado + '%) - ';
        if(resultado === 0) {
            // Detectar qué criterio obligatorio no cumple para el texto
            const obligatoriasIds = [3,4,6,7,11,14,23,41,43,47,58,59,60];
            const nombresOblig = {
                3: 'Espéculos, olivas y cascos desinfectados, tener un lugar adecuado para almacenar los usados',
                4: 'Acoger al cliente con una sonrisa, amable y cercano',
                6: 'Acompañar al paciente al gabinete para la revisión auditiva',
                7: 'Ofrecer pasar a gabinete al acompañante',
                11: 'Abrir ficha y rellenar RGPD completa (incluidos checks de condiciones comerciales)',
                14: 'Realizar una breve explicación en cada prueba y asegurarnos de que lo ha entendido',
                23: 'Resumir los resultados y dar explicación',
                41: 'Aplicar Tchin Tchin',
                43: 'Explicar facilidades de pago: NextYear',
                47: 'Detallar los compromisos Audio',
                58: 'Onboarding realizado en Afflelou Academy',
                59: 'Portfolio WSA y Starkey',
                60: 'Realizar curso PIA última versión'
            };
            let criteriosFallidosTexto = [];
            for(let i = 0; i < obligatoriasIds.length; i++) {
                const id = obligatoriasIds[i];
                if(resp && resp[id] === 'no') {
                    criteriosFallidosTexto.push(nombresOblig[id] || ('Criterio ' + id));
                }
            }
            texto += '⛔ NO EVALÚA - No cumple CRITERIO OBLIGATORIO para Audio.';
            if(criteriosFallidosTexto.length > 0) {
                texto += ' ❌ Incumplido: ' + criteriosFallidosTexto.join(' | ') + '. ';
            } else {
                texto += ' ';
            }
        } else if(resultado >= 95) {
            texto += 'Máxima excelencia en todos los criterios. ';
        } else if(resultado >= 90) {
            texto += 'Excelente desempeño global. ';
        } else if(resultado >= 80) {
            texto += 'Buen desempeño con oportunidades de mejora. ';
        } else {
            texto += 'Requiere atención prioritaria. ';
        }
        
        // Fortalezas
        if(bloquesFuertes.length > 0) {
            texto += '💪 Fortalezas: ' + bloquesFuertes.slice(0,3).map(b => b.nombre + ' (' + b.pct + '%)').join(', ') + '. ';
        }
        
        // Áreas críticas
        if(bloquesDebiles.length > 0) {
            texto += '⚠️ Áreas críticas: ' + bloquesDebiles.slice(0,3).map(b => b.nombre + ' (' + b.pct + '%)').join(', ') + '. ';
        }
        
        // Recomendación según nivel
        if(resultado < 95) {
            texto += '📚 Recomendación: Realizar Cursos en Academy, apoyarse en Píldoras de Audio, consultar material relevante en Hotspot y solicitar Mentoring con responsables de Audio.';
        } else {
            texto += '🌟 Mantén el nivel y comparte buenas prácticas con el equipo.';
        }
        
        el.innerHTML = texto;
    }
}

function manejarNumeracion(event, textarea) {
    if(event.key === 'Enter') {
        event.preventDefault();
        const texto = textarea.value;
        const lineas = texto.split('\n').filter(l => l.trim() !== '');
        
        // Limitar a máximo 5 líneas
        if(lineas.length >= 5) {
            return; // No permitir más líneas
        }
        
        const ultimaLinea = lineas[lineas.length - 1];
        const match = ultimaLinea.match(/^(\d+)\./);
        let siguienteNum = 1;
        if(match) {
            siguienteNum = parseInt(match[1]) + 1;
        } else {
            // Buscar el último número usado
            for(let i = lineas.length - 1; i >= 0; i--) {
                const m = lineas[i].match(/^(\d+)\./);
                if(m) {
                    siguienteNum = parseInt(m[1]) + 1;
                    break;
                }
            }
        }
        
        // Solo añadir si no supera 5
        if(siguienteNum <= 5) {
            textarea.value = texto + '\n' + siguienteNum + '. ';
        }
    }
    // Iniciar con 1. si está vacío
    if(textarea.value === '' && event.key !== 'Backspace') {
        textarea.value = '1. ';
    }
}

// ===== COMPRESIÓN DE IMÁGENES =====
// Comprime imagen base64 con compresión progresiva y fallback garantizado
function comprimirImagen(dataUrl, maxW, maxH, quality) {
    maxW = maxW || 800;
    maxH = maxH || 600;
    quality = quality || 0.5;
    // Límite máximo: 80KB para local, nunca devolver más que el original
    var maxOutputBytes = Math.max(80000, (maxW <= 300 ? 20000 : 80000));
    
    return new Promise(function(resolve) {
        if(!dataUrl || typeof dataUrl !== 'string' || !dataUrl.startsWith('data:image')) { resolve(dataUrl); return; }
        
        // Si ya es pequeña, no comprimir
        if(dataUrl.length < maxOutputBytes) { resolve(dataUrl); return; }
        
        var img = new Image();
        var timeout = setTimeout(function() {
            console.warn('[Compresión] ⏱️ Timeout cargando imagen, creando placeholder');
            resolve(crearPlaceholderImagen(maxW, maxH, '📷'));
        }, 15000); // 15s timeout para móvil lento
        
        img.onload = function() {
            clearTimeout(timeout);
            try {
                var w = img.width, h = img.height;
                
                // Paso 1: Redimensionar
                if(w > maxW || h > maxH) {
                    var ratio = Math.min(maxW / w, maxH / h);
                    w = Math.round(w * ratio);
                    h = Math.round(h * ratio);
                }
                
                var canvas = document.createElement('canvas');
                canvas.width = w;
                canvas.height = h;
                var ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                var compressed = canvas.toDataURL('image/jpeg', quality);
                
                // Paso 2: Si aún es grande, comprimir más agresivamente
                if(compressed.length > maxOutputBytes && quality > 0.1) {
                    var q2 = Math.max(0.1, quality * 0.5);
                    var w2 = Math.round(w * 0.7);
                    var h2 = Math.round(h * 0.7);
                    canvas.width = w2; canvas.height = h2;
                    ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w2, h2);
                    compressed = canvas.toDataURL('image/jpeg', q2);
                    console.log('[Compresión] 🔄 Reintento: ' + w2 + 'x' + h2 + ' q' + q2 + ' → ' + Math.round(compressed.length/1024) + 'KB');
                }
                
                // Paso 3: Si TODAVÍA es grande, reducir al mínimo
                if(compressed.length > maxOutputBytes * 2 && maxW > 200) {
                    canvas.width = 200; canvas.height = 150;
                    ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, 200, 150);
                    compressed = canvas.toDataURL('image/jpeg', 0.1);
                    console.log('[Compresión] 🔄 Ultra: 200x150 q0.1 → ' + Math.round(compressed.length/1024) + 'KB');
                }
                
                // Liberar memoria
                canvas.width = 1; canvas.height = 1;
                canvas = null; ctx = null;
                
                // Si la compresión produjo algo más grande que el original, usar original
                if(compressed.length > dataUrl.length) compressed = dataUrl;
                console.log('[Compresión] ✅ ' + Math.round(dataUrl.length/1024) + 'KB → ' + Math.round(compressed.length/1024) + 'KB');
                resolve(compressed);
            } catch(err) {
                console.error('[Compresión] ❌ Error canvas:', err);
                // Intentar con tamaño mínimo como último recurso
                try {
                    var c2 = document.createElement('canvas');
                    c2.width = 150; c2.height = 112;
                    var ctx2 = c2.getContext('2d');
                    ctx2.drawImage(img, 0, 0, 150, 112);
                    var mini = c2.toDataURL('image/jpeg', 0.15);
                    c2.width = 1; c2.height = 1; c2 = null;
                    console.log('[Compresión] 🆘 Rescate mini: ' + Math.round(mini.length/1024) + 'KB');
                    resolve(mini);
                } catch(err2) {
                    console.error('[Compresión] ❌❌ Canvas imposible, placeholder');
                    resolve(crearPlaceholderImagen(maxW, maxH, '📷'));
                }
            }
        };
        img.onerror = function() {
            clearTimeout(timeout);
            console.error('[Compresión] ❌ Error cargando imagen, placeholder');
            resolve(crearPlaceholderImagen(maxW, maxH, '📷'));
        };
        img.src = dataUrl;
    });
}

// Crear placeholder cuando la compresión falla completamente
function crearPlaceholderImagen(w, h, emoji) {
    w = Math.min(w || 100, 100); h = Math.min(h || 75, 75);
    var c = document.createElement('canvas');
    c.width = w; c.height = h;
    var ctx = c.getContext('2d');
    ctx.fillStyle = '#f3f4f6';
    ctx.fillRect(0, 0, w, h);
    ctx.fillStyle = '#9ca3af';
    ctx.font = Math.round(h * 0.4) + 'px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(emoji || '📷', w/2, h/2);
    var result = c.toDataURL('image/jpeg', 0.3);
    c.width = 1; c.height = 1; c = null;
    return result;
}

// Compresión para Firebase (calidad media-alta, se ven bien)
function comprimirParaFirebase(dataUrl) {
    return comprimirImagen(dataUrl, 800, 600, 0.5);
}

// Compresión para localStorage (miniatura, solo referencia visual)
function comprimirParaLocal(dataUrl) {
    return comprimirImagen(dataUrl, 300, 225, 0.25);
}

// Comprime array de imágenes para localStorage (thumbnails pequeños)
async function comprimirImagenesParaLocal(imagenes) {
    var result = [];
    for(var i = 0; i < imagenes.length; i++) {
        try {
            if(imagenes[i] && typeof imagenes[i] === 'string' && imagenes[i].startsWith('data:image')) {
                result.push(await comprimirParaLocal(imagenes[i]));
            } else {
                result.push(imagenes[i]);
            }
        } catch(err) {
            console.error('[comprimirImagenesParaLocal] Error en imagen ' + i + ':', err);
            result.push(crearPlaceholderImagen(100, 75, '📷'));
        }
    }
    return result;
}

// Comprime array de imágenes (para Firebase/borrador)
async function comprimirImagenesArray(imagenes) {
    var result = [];
    for(var i = 0; i < imagenes.length; i++) {
        try {
            if(imagenes[i] && typeof imagenes[i] === 'string' && imagenes[i].startsWith('data:image')) {
                if(imagenes[i].length > 60000) {
                    result.push(await comprimirImagen(imagenes[i], 600, 450, 0.4));
                } else {
                    result.push(imagenes[i]);
                }
            } else {
                result.push(imagenes[i]);
            }
        } catch(err) {
            console.error('[comprimirImagenesArray] Error en imagen ' + i + ':', err);
            result.push(crearPlaceholderImagen(100, 75, '📷'));
        }
    }
    return result;
}

// ============ GESTIÓN INTELIGENTE DE ALMACENAMIENTO ============
function getStorageUsage() {
    var total = 0;
    for(var key in localStorage) {
        if(localStorage.hasOwnProperty(key)) {
            total += localStorage[key].length * 2; // UTF-16 = 2 bytes per char
        }
    }
    return total;
}

function getStorageUsageMB() {
    return (getStorageUsage() / (1024 * 1024)).toFixed(2);
}

function getStorageCapacityInfo() {
    var usedBytes = getStorageUsage();
    var maxBytes = 5 * 1024 * 1024; // 5MB standard
    var finalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');
    var borradores = JSON.parse(localStorage.getItem('informesBorrador') || '[]');
    var preinformes = JSON.parse(localStorage.getItem('preinformes') || '[]');
    
    // Con thumbnails 300x225 q0.25 (~5-8KB cada imagen = ~30-48KB por informe con 6 fotos)
    // + datos JSON ~8-12KB por informe = ~40-60KB total por informe
    var avgPerReport = 50000; // ~50KB promedio con thumbnails
    if(finalizados.length > 0) {
        var finJson = localStorage.getItem('informesFinalizados') || '[]';
        avgPerReport = Math.max(avgPerReport, Math.round(finJson.length * 2 / finalizados.length));
    }
    var remaining = maxBytes - usedBytes;
    var canFitMore = Math.floor(remaining / avgPerReport);
    
    return {
        usedMB: (usedBytes / (1024 * 1024)).toFixed(2),
        maxMB: (maxBytes / (1024 * 1024)).toFixed(1),
        pctUsed: Math.round((usedBytes / maxBytes) * 100),
        finalizados: finalizados.length,
        borradores: borradores.length,
        preinformes: preinformes.length,
        canFitMore: Math.max(0, canFitMore),
        avgKB: Math.round(avgPerReport / 1024)
    };
}

// Liberar espacio automáticamente eliminando imágenes de informes antiguos
async function liberarEspacioStorage() {
    var finalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');
    if(finalizados.length < 2) return false;
    
    var liberado = false;
    // Ordenar por fecha (más antiguos primero) para eliminar sus imágenes
    var conImagenes = [];
    for(var i = 0; i < finalizados.length; i++) {
        var imgSize = 0;
        if(finalizados[i].imagenes) {
            for(var j = 0; j < finalizados[i].imagenes.length; j++) {
                if(finalizados[i].imagenes[j]) imgSize += finalizados[i].imagenes[j].length;
            }
        }
        if(finalizados[i].fotosGuia) {
            for(var k = 0; k < finalizados[i].fotosGuia.length; k++) {
                if(finalizados[i].fotosGuia[k] && finalizados[i].fotosGuia[k].data) {
                    imgSize += finalizados[i].fotosGuia[k].data.length;
                }
            }
        }
        if(imgSize > 0) conImagenes.push({idx: i, size: imgSize, fecha: finalizados[i].fecha || ''});
    }
    
    // Eliminar imágenes del más antiguo primero (están sincronizadas en Firebase)
    conImagenes.sort(function(a, b) { return (a.fecha || '').localeCompare(b.fecha || ''); });
    
    for(var ci = 0; ci < conImagenes.length; ci++) {
        var idx = conImagenes[ci].idx;
        if(finalizados[idx].imagenes) {
            console.log('[Storage] 🗜️ Eliminando imágenes de informe antiguo: ' + (finalizados[idx].centro || 'N/A') + ' (' + Math.round(conImagenes[ci].size/1024) + 'KB liberados)');
            finalizados[idx].imagenes = finalizados[idx].imagenes.map(function(img) { return img ? '[IMG_EN_FIREBASE]' : null; });
            liberado = true;
        }
        if(finalizados[idx].fotosGuia) {
            finalizados[idx].fotosGuia = finalizados[idx].fotosGuia.map(function(fg) { 
                return fg && fg.data ? {name: fg.name, data: '[IMG_EN_FIREBASE]'} : fg; 
            });
        }
        
        // Intentar guardar después de cada limpieza
        try {
            localStorage.setItem('informesFinalizados', JSON.stringify(finalizados));
            return true; // Éxito, hay espacio
        } catch(e) {
            continue; // Seguir limpiando
        }
    }
    return liberado;
}

// Guardar con gestión inteligente de espacio
async function guardarEnLocalStorageSeguro(key, data) {
    try {
        localStorage.setItem(key, data);
        return true;
    } catch(e) {
        console.warn('[Storage] ⚠️ Sin espacio para ' + key + '. Liberando...');
        var freed = await liberarEspacioStorage();
        if(freed) {
            try {
                localStorage.setItem(key, data);
                console.log('[Storage] ✅ Guardado tras liberar espacio');
                return true;
            } catch(e2) {
                console.error('[Storage] ❌ Sin espacio aún tras limpiar');
                return false;
            }
        }
        return false;
    }
}

// ============================================================
// OPTIMIZADOR DE ALMACENAMIENTO PARA 100+ INFORMES
// Firebase = almacén completo (imágenes full quality, ilimitado)
// localStorage = caché inteligente (últimos N con imágenes, resto solo texto)
// ============================================================
var STORAGE_MAX_BYTES = 4 * 1024 * 1024; // 4MB target (de 5MB limit)
var INFORMES_CON_IMG = 10; // Últimos 10 informes mantienen imágenes en localStorage

function getLocalStorageBytes() {
    var total = 0;
    for(var i = 0; i < localStorage.length; i++) {
        var k = localStorage.key(i);
        var v = localStorage.getItem(k);
        if(v) total += (k.length + v.length) * 2;
    }
    return total;
}

function optimizarStorage() {
    var bytesAntes = getLocalStorageBytes();
    if(bytesAntes < STORAGE_MAX_BYTES) {
        console.log('[Optimizer] ✅ Storage OK: ' + (bytesAntes / 1048576).toFixed(2) + 'MB / 5MB');
        return;
    }
    
    console.log('[Optimizer] ⚠️ Storage alto: ' + (bytesAntes / 1048576).toFixed(2) + 'MB. Optimizando...');
    
    // PASO 1: Limpiar checklistHTML grande (se regenera desde respuestas)
    var keys = ['informesFinalizados', 'informesBorrador', 'borradoresInforme'];
    keys.forEach(function(key) {
        try {
            var arr = JSON.parse(localStorage.getItem(key) || '[]');
            var changed = false;
            for(var i = 0; i < arr.length; i++) {
                // Limpiar checklistHTML
                if(arr[i].checklistHTML && arr[i].checklistHTML.length > 5000) {
                    arr[i].checklistHTML = '';
                    changed = true;
                }
                // Limpiar preinformeData recursivo
                if(arr[i].preinformeData) {
                    delete arr[i].preinformeData.preinformeData;
                    delete arr[i].preinformeData.checklistHTML;
                    delete arr[i].preinformeData.imagenes;
                    delete arr[i].preinformeData.fotosGuia;
                    changed = true;
                }
            }
            if(changed) localStorage.setItem(key, JSON.stringify(arr));
        } catch(e) {}
    });
    
    if(getLocalStorageBytes() < STORAGE_MAX_BYTES) {
        console.log('[Optimizer] ✅ Resuelto tras limpiar metadata: ' + (getLocalStorageBytes() / 1048576).toFixed(2) + 'MB');
        return;
    }
    
    // PASO 2: Quitar imágenes de informes FINALIZADOS antiguos (están en Firebase)
    try {
        var fin = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');
        // Mantener imágenes solo en los últimos INFORMES_CON_IMG
        for(var f = INFORMES_CON_IMG; f < fin.length; f++) {
            if(fin[f].imagenes) {
                var teniaImg = fin[f].imagenes.some(function(x) { return x && typeof x === 'string' && x.startsWith('data:'); });
                if(teniaImg) {
                    fin[f].imagenes = fin[f].imagenes.map(function(img) {
                        return (img && typeof img === 'string' && img.startsWith('data:')) ? '[IMG_EN_FIREBASE]' : img;
                    });
                }
            }
            if(fin[f].fotosGuia) {
                fin[f].fotosGuia = fin[f].fotosGuia.map(function(fg) {
                    return (fg && fg.data && typeof fg.data === 'string' && fg.data.startsWith('data:')) ? {name:fg.name, data:'[IMG_EN_FIREBASE]'} : fg;
                });
            }
        }
        localStorage.setItem('informesFinalizados', JSON.stringify(fin));
    } catch(e) { console.warn('[Optimizer] Error optimizando finalizados:', e); }
    
    if(getLocalStorageBytes() < STORAGE_MAX_BYTES) {
        console.log('[Optimizer] ✅ Resuelto tras limpiar imágenes antiguas finalizados: ' + (getLocalStorageBytes() / 1048576).toFixed(2) + 'MB');
        return;
    }
    
    // PASO 3: Quitar imágenes de BORRADORES antiguos
    try {
        var borr = JSON.parse(localStorage.getItem('informesBorrador') || '[]');
        for(var b = INFORMES_CON_IMG; b < borr.length; b++) {
            if(borr[b].imagenes) {
                borr[b].imagenes = borr[b].imagenes.map(function(img) {
                    return (img && typeof img === 'string' && img.startsWith('data:')) ? '[IMG_EN_FIREBASE]' : img;
                });
            }
            if(borr[b].fotosGuia) {
                borr[b].fotosGuia = borr[b].fotosGuia.map(function(fg) {
                    return (fg && fg.data && typeof fg.data === 'string' && fg.data.startsWith('data:')) ? {name:fg.name, data:'[IMG_EN_FIREBASE]'} : fg;
                });
            }
        }
        localStorage.setItem('informesBorrador', JSON.stringify(borr));
        localStorage.setItem('borradoresInforme', JSON.stringify(borr));
    } catch(e) {}
    
    if(getLocalStorageBytes() < STORAGE_MAX_BYTES) {
        console.log('[Optimizer] ✅ Resuelto tras limpiar imágenes antiguas borradores: ' + (getLocalStorageBytes() / 1048576).toFixed(2) + 'MB');
        return;
    }
    
    // PASO 4: Si aún es mucho, comprimir imágenes de los recientes a micro-thumbnails
    try {
        var fin2 = JSON.parse(localStorage.getItem('informesFinalizados') || '[]');
        for(var f2 = 0; f2 < Math.min(fin2.length, INFORMES_CON_IMG); f2++) {
            if(fin2[f2].imagenes) {
                fin2[f2].imagenes = fin2[f2].imagenes.map(function(img) {
                    if(img && typeof img === 'string' && img.startsWith('data:') && img.length > 30000) {
                        return '[IMG_EN_FIREBASE]'; // Too large, strip
                    }
                    return img;
                });
            }
        }
        localStorage.setItem('informesFinalizados', JSON.stringify(fin2));
    } catch(e) {}
    
    try {
        var borr2 = JSON.parse(localStorage.getItem('informesBorrador') || '[]');
        for(var b2 = 0; b2 < Math.min(borr2.length, INFORMES_CON_IMG); b2++) {
            if(borr2[b2].imagenes) {
                borr2[b2].imagenes = borr2[b2].imagenes.map(function(img) {
                    if(img && typeof img === 'string' && img.startsWith('data:') && img.length > 30000) {
                        return '[IMG_EN_FIREBASE]';
                    }
                    return img;
                });
            }
        }
        localStorage.setItem('informesBorrador', JSON.stringify(borr2));
        localStorage.setItem('borradoresInforme', JSON.stringify(borr2));
    } catch(e) {}
    
    var bytesDespues = getLocalStorageBytes();
    console.log('[Optimizer] 📊 ' + (bytesAntes / 1048576).toFixed(2) + 'MB → ' + (bytesDespues / 1048576).toFixed(2) + 'MB (liberado ' + ((bytesAntes - bytesDespues) / 1024).toFixed(0) + 'KB)');
}

// Restaurar imágenes de un informe desde Firebase
async function restaurarImagenesDesdeFirebase(informe, tipo) {
    if(!db || typeof firebase === 'undefined') return informe;
    
    var tieneFirebase = false;
    if(informe.imagenes) {
        for(var i = 0; i < informe.imagenes.length; i++) {
            if(informe.imagenes[i] === '[IMG_EN_FIREBASE]') { tieneFirebase = true; break; }
        }
    }
    if(!tieneFirebase) return informe;
    
    console.log('[Firebase] 🔄 Restaurando imágenes de', informe.centro, '...');
    try {
        var key = tipo === 'finalizado' ? 'informesFinalizados' : 'informesBorrador';
        var doc = await db.collection('plataformaAdmin').doc(key).get();
        if(!doc.exists) return informe;
        
        var fbData = JSON.parse(doc.data().v || '[]');
        // Buscar el informe por centro + fecha
        var centroUp = (informe.centro || '').toUpperCase().trim();
        var fecha = informe.fecha || '';
        var match = null;
        for(var j = 0; j < fbData.length; j++) {
            var fbCentro = (fbData[j].centro || '').toUpperCase().trim();
            var fbFecha = fbData[j].fecha || '';
            if(fbCentro === centroUp && fbFecha === fecha) { match = fbData[j]; break; }
            if(centroUp && fbCentro.includes(centroUp) && fbFecha === fecha) { match = fbData[j]; break; }
        }
        
        if(match) {
            if(match.imagenes && match.imagenes.length > 0) {
                informe.imagenes = match.imagenes;
                console.log('[Firebase] ✅ Imágenes restauradas:', match.imagenes.filter(function(x){return x && x !== '[IMG_EN_FIREBASE]'}).length);
            }
            if(match.fotosGuia && match.fotosGuia.length > 0) {
                informe.fotosGuia = match.fotosGuia;
            }
        } else {
            console.log('[Firebase] ⚠️ Informe no encontrado en Firebase');
        }
    } catch(e) {
        console.error('[Firebase] Error restaurando imágenes:', e);
    }
    return informe;
}

// Nueva función para manejar imágenes y archivos
var archivosAdjuntos = {};
function previewFile(num) {
    const input = document.getElementById('img-input-' + num);
    const imgPreview = document.getElementById('img-preview-' + num);
    const filePreview = document.getElementById('file-preview-' + num);
    const placeholder = document.getElementById('placeholder-' + num);
    const btnBorrar = document.getElementById('btn-borrar-' + num);
    
    if(input.files && input.files[0]) {
        const file = input.files[0];
        const fileName = file.name;
        const fileType = file.type || 'image/jpeg'; // Móvil a veces no envía type
        const fileExt = fileName.split('.').pop().toLowerCase();
        
        // Guardar referencia al archivo
        archivosAdjuntos[num] = file;
        
        // Detectar si es imagen (incluyendo extensiones sin MIME)
        var esImagen = fileType.startsWith('image/') || ['jpg','jpeg','png','gif','webp','heic','heif','bmp'].indexOf(fileExt) >= 0;
        
        if(esImagen) {
            // Mostrar indicador de carga
            placeholder.innerHTML = '<div style="font-size:10px;color:#C9A227">⏳ Procesando ' + Math.round(file.size/1024) + 'KB...</div>';
            
            // Para archivos muy grandes (>15MB), comprimir en pasos
            var maxW = file.size > 8000000 ? 400 : 600;
            var maxH = file.size > 8000000 ? 300 : 450;
            var quality = file.size > 8000000 ? 0.3 : 0.4;
            
            const reader = new FileReader();
            reader.onload = async function(e) { 
                try {
                    var compressed = await comprimirImagen(e.target.result, maxW, maxH, quality);
                    imgPreview.src = compressed; 
                    imgPreview.style.display = 'block'; 
                    if(filePreview) filePreview.style.display = 'none';
                    placeholder.style.display = 'none';
                    if(btnBorrar) btnBorrar.style.display = 'block';
                    console.log('[previewFile] ✅ Imagen ' + num + ': ' + Math.round(file.size/1024) + 'KB → ' + Math.round(compressed.length/1024) + 'KB');
                } catch(err) {
                    console.error('[previewFile] Error comprimiendo:', err);
                    try {
                        var fallback = await comprimirImagen(e.target.result, 300, 225, 0.2);
                        imgPreview.src = fallback;
                    } catch(err2) {
                        imgPreview.src = crearPlaceholderImagen(100, 75, '📷');
                    }
                    imgPreview.style.display = 'block';
                    placeholder.style.display = 'none';
                    if(btnBorrar) btnBorrar.style.display = 'block';
                }
            };
            reader.onerror = function() {
                console.error('[previewFile] Error leyendo archivo');
                placeholder.innerHTML = '<div style="font-size:9px;color:#dc2626">❌ Error. Toca para reintentar</div>';
                placeholder.style.display = 'flex';
            };
            reader.readAsDataURL(file);
        } else {
            // Para otros archivos mostrar icono y nombre
            let icon = '📄';
            if(fileExt === 'pdf') icon = '📕';
            else if(fileExt === 'xlsx' || fileExt === 'xls') icon = '📊';
            else if(fileExt === 'doc' || fileExt === 'docx') icon = '📘';
            
            imgPreview.style.display = 'none';
            if(btnBorrar) btnBorrar.style.display = 'none';
            if(filePreview) {
                filePreview.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:10px;text-align:center"><span style="font-size:32px">' + icon + '</span><span style="font-size:9px;color:#333;margin-top:5px;word-break:break-all">' + fileName.substring(0,20) + (fileName.length > 20 ? '...' : '') + '</span><button onclick="event.stopPropagation();eliminarArchivo(' + num + ')" style="margin-top:5px;padding:2px 6px;font-size:8px;background:#dc2626;color:#fff;border:none;border-radius:3px;cursor:pointer">✕</button></div>';
                filePreview.style.display = 'flex';
            }
            placeholder.style.display = 'none';
        }
    }
}

function eliminarArchivo(num) {
    const input = document.getElementById('img-input-' + num);
    const imgPreview = document.getElementById('img-preview-' + num);
    const filePreview = document.getElementById('file-preview-' + num);
    const placeholder = document.getElementById('placeholder-' + num);
    const btnBorrar = document.getElementById('btn-borrar-' + num);
    
    input.value = '';
    delete archivosAdjuntos[num];
    imgPreview.style.display = 'none';
    imgPreview.src = '';
    if(filePreview) {
        filePreview.style.display = 'none';
        filePreview.innerHTML = '';
    }
    if(btnBorrar) btnBorrar.style.display = 'none';
    placeholder.style.display = 'flex';
}

// Archivos adjuntos de Guía de Visita
var archivosGuia = {};
function previewGuiaFile(num) {
    const input = document.getElementById('guia-file-' + num);
    const imgPreview = document.getElementById('guia-img-' + num);
    const filePreview = document.getElementById('guia-file-preview-' + num);
    const placeholder = document.getElementById('guia-placeholder-' + num);
    
    if(input.files && input.files[0]) {
        const file = input.files[0];
        const fileName = file.name;
        const fileType = file.type;
        const fileExt = fileName.split('.').pop().toLowerCase();
        
        archivosGuia[num] = file;
        
        if(fileType.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = async function(e) { 
                try {
                    var compressed = await comprimirImagen(e.target.result, 600, 450, 0.4);
                    imgPreview.src = compressed; 
                    imgPreview.style.display = 'block'; 
                    if(filePreview) filePreview.style.display = 'none';
                    placeholder.style.display = 'none'; 
                } catch(err) {
                    try { var fb = await comprimirImagen(e.target.result, 300, 225, 0.25); imgPreview.src = fb; } catch(e2) { imgPreview.src = e.target.result; }
                    imgPreview.style.display = 'block'; placeholder.style.display = 'none';
                }
            };
            reader.onerror = function() { console.error('[previewGuiaFile] Error leyendo archivo'); };
            reader.readAsDataURL(file);
        } else {
            let icon = '📄';
            if(fileExt === 'pdf') icon = '📕';
            else if(fileExt === 'xlsx' || fileExt === 'xls') icon = '📊';
            else if(fileExt === 'doc' || fileExt === 'docx') icon = '📘';
            
            imgPreview.style.display = 'none';
            if(filePreview) {
                filePreview.innerHTML = '<span style="font-size:24px">' + icon + '</span><div style="font-size:7px;color:#333;margin-top:3px;word-break:break-all">' + fileName.substring(0,12) + (fileName.length > 12 ? '...' : '') + '</div><button onclick="event.stopPropagation();eliminarGuiaFile(' + num + ')" style="margin-top:3px;padding:1px 4px;font-size:7px;background:#dc2626;color:#fff;border:none;border-radius:2px;cursor:pointer">✕</button>';
                filePreview.style.display = 'block';
            }
            placeholder.style.display = 'none';
        }
    }
}

function eliminarGuiaFile(num) {
    const input = document.getElementById('guia-file-' + num);
    const imgPreview = document.getElementById('guia-img-' + num);
    const filePreview = document.getElementById('guia-file-preview-' + num);
    const placeholder = document.getElementById('guia-placeholder-' + num);
    
    input.value = '';
    delete archivosGuia[num];
    imgPreview.style.display = 'none';
    imgPreview.src = '';
    if(filePreview) {
        filePreview.style.display = 'none';
        filePreview.innerHTML = '';
    }
    placeholder.style.display = 'block';
}

function guardarInformePro() {
    const data = {
        centro: document.getElementById('inf-centro').value,
        propietario: document.getElementById('inf-propietario').value,
        delegadoRegional: document.getElementById('inf-delegado-regional').value,
        delegadoAudio: document.getElementById('inf-delegado-audio').value,
        tipoVisita: document.getElementById('inf-tipo-visita').value,
        fecha: document.getElementById('inf-fecha').value,
        pcpnc: document.getElementById('inf-pcpnc').value,
        horasServicio: document.getElementById('inf-horas').value,
        resultado: preinformeActual ? preinformeActual.resultado : 0,
        respuestas: preinformeActual ? preinformeActual.respuestas : {},
        observaciones: document.getElementById('txt-observaciones').value,
        recomendaciones: document.getElementById('txt-recomendaciones').value,
        compromisos: document.getElementById('txt-compromisos').value,
        tiempoCompromisos: document.getElementById('tiempo-compromisos').value,
        pdfAdjunto: pdfAdjuntoData
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'informe-' + (data.centro || 'centro').replace(/\s+/g, '-') + '-' + (data.fecha || 'fecha') + '.json';
    a.click();
    alert('✅ Informe guardado como JSON');
}

let pdfAdjuntoData = null;
let pdfAdjuntoNombre = null;

async function cargarPDFPreinforme(event) {
    const file = event.target.files[0];
    if(!file) return;
    
    pdfAdjuntoNombre = file.name;
    
    // Mostrar loading
    alert('⏳ Procesando PDF... Por favor espera.');
    
    try {
        const arrayBuffer = await file.arrayBuffer();
        
        // Configurar PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        let textoCompleto = '';
        
        // Extraer texto de todas las páginas
        for(let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            textoCompleto += pageText + '\n';
        }
        
        console.log('Texto extraído:', textoCompleto);
        
        // Parsear datos del PDF
        const datos = parsearPDFTexto(textoCompleto);
        
        if(datos) {
            // Cargar datos en el informe
            preinformeActual = datos;
            cargarDatosInforme(datos);
            setTimeout(initRadarCharts, 100);
            
            // Guardar PDF como base64 para adjuntar
            const reader = new FileReader();
            reader.onload = function(e) {
                pdfAdjuntoData = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // Mostrar indicador
            const indicator = document.getElementById('pdf-indicator');
            if(indicator) {
                indicator.innerHTML = '<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:#dcfce7;border:1px solid #C9A227;border-radius:6px;font-size:10px"><span>✅</span><span style="font-weight:600">' + pdfAdjuntoNombre + '</span><button onclick="verPDFAdjunto()" style="background:#C9A227;color:#fff;border:none;padding:3px 6px;border-radius:4px;cursor:pointer;font-size:9px">Ver</button></div>';
                indicator.style.display = 'block';
            }
            
            alert('✅ PDF cargado correctamente:\n- Centro: ' + (datos.centro || 'N/A') + '\n- Resultado: ' + (datos.resultado || 0) + '%');
        } else {
            alert('⚠️ No se pudieron extraer datos del PDF.\nAsegúrate de que es un preinforme válido.');
        }
        
    } catch(error) {
        console.error('Error al leer PDF:', error);
        alert('❌ Error al leer el PDF: ' + error.message);
    }
}

function parsearPDFTexto(texto) {
    const datos = {
        centro: '',
        propietario: '',
        delegadoRegional: '',
        audiologo: '',
        fecha: '',
        resultado: 0,
        respuestas: {}
    };
    
    // Buscar patrones comunes en el texto del PDF
    // Centro
    let match = texto.match(/Centro[:\s]+([^\n]+)/i);
    if(match) datos.centro = match[1].trim();
    
    // Propietario
    match = texto.match(/Propietario[:\s]+([^\n]+)/i);
    if(match) datos.propietario = match[1].trim();
    
    // Delegado
    match = texto.match(/Delegado[:\s]+([^\n]+)/i);
    if(match) datos.delegadoRegional = match[1].trim();
    
    // Audiólogo
    match = texto.match(/Audi[óo]logo[:\s]+([^\n]+)/i);
    if(match) datos.audiologo = match[1].trim();
    
    // Fecha
    match = texto.match(/Fecha[:\s]+(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/i);
    if(match) datos.fecha = match[1].trim();
    
    // Resultado/Puntuación total
    match = texto.match(/(?:Resultado|Puntuaci[óo]n|Total|Aplicaci[óo]n)[:\s]+(\d+(?:\.\d+)?)\s*%/i);
    if(match) datos.resultado = parseFloat(match[1]);
    
    // Buscar porcentajes de bloques
    const bloques = {
        'PIA': 'PIA',
        'FORMACI[ÓO]N': 'FORMACION',
        'COMUNICACI[ÓO]N': 'COMUNICACION',
        'AYUDAS': 'AYUDAS',
        'COMPLEMENT': 'COMPLEMENTARIAS',
        'RT': 'RT',
        'CONVERSI[ÓO]N': 'CONVERSIONES',
        'AGENDA': 'AGENDA'
    };
    
    datos.bloquesPct = {};
    Object.keys(bloques).forEach(patron => {
        const regex = new RegExp(patron + '[:\\s]+([\\d.]+)\\s*%', 'i');
        const m = texto.match(regex);
        if(m) datos.bloquesPct[bloques[patron]] = parseFloat(m[1]);
    });
    
    // Buscar valores numéricos de conversiones
    match = texto.match(/MGM[:\s]+(\d+)/i);
    if(match) datos.respuestas[95] = parseInt(match[1]);
    
    match = texto.match(/Renove[:\s]+(\d+)/i);
    if(match) datos.respuestas[96] = parseInt(match[1]);
    
    match = texto.match(/Seguro[s]?[:\s]+(\d+)/i);
    if(match) datos.respuestas[97] = parseInt(match[1]);
    
    match = texto.match(/Ayuda[s]?[:\s]+(\d+)/i);
    if(match) datos.respuestas[94] = parseInt(match[1]);
    
    // Porcentajes de conversión
    match = texto.match(/%\s*Prueba[:\s]+(\d+)/i) || texto.match(/Prueba[:\s]+(\d+)\s*%/i);
    if(match) datos.respuestas[99] = parseInt(match[1]);
    
    match = texto.match(/%\s*Venta[:\s]+(\d+)/i) || texto.match(/Venta[:\s]+(\d+)\s*%/i);
    if(match) datos.respuestas[100] = parseInt(match[1]);
    
    match = texto.match(/%\s*Screen(?:ing)?[:\s]+(\d+)/i) || texto.match(/Screen(?:ing)?[:\s]+(\d+)\s*%/i);
    if(match) datos.respuestas[98] = parseInt(match[1]);
    
    match = texto.match(/Agenda[:\s]+(\d+)\s*%/i);
    if(match) datos.respuestas[91] = parseInt(match[1]);
    
    // Si encontramos al menos centro o resultado, consideramos válido
    if(datos.centro || datos.resultado > 0) {
        return datos;
    }
    
    return null;
}

function verPDFAdjunto() {
    if(pdfAdjuntoData) {
        const win = window.open();
        win.document.write('<iframe src="' + pdfAdjuntoData + '" style="width:100%;height:100%;border:none"></iframe>');
    }
}

function quitarPDFAdjunto() {
    pdfAdjuntoData = null;
    pdfAdjuntoNombre = null;
    const indicator = document.getElementById('pdf-indicator');
    if(indicator) {
        indicator.style.display = 'none';
        indicator.innerHTML = '';
    }
    document.getElementById('file-pdf').value = '';
}

function descargarInformePDF() {
    html2pdf().set({
        margin: [5,5,5,5],
        filename: 'Informe de visita de Audiología.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: 'css', before: '.inf-page' }
    }).from(document.getElementById('informe-pro')).save();
}

function imprimirInforme() {
    const tituloOriginal = document.title;
    document.title = 'Informe de visita de Audiología';
    window.print();
    document.title = tituloOriginal;
}

function limpiarInforme() {
    preinformeActual = null;
    planLocalSeleccionado = false;
    
    // Mostrar selector de plan local
    var selector = document.getElementById('plan-local-selector');
    if(selector) selector.style.display = 'block';
    
    // Limpiar campos de datos
    document.getElementById('inf-centro').value = '';
    document.getElementById('inf-propietario').value = '';
    document.getElementById('inf-delegado-regional').value = '';
    document.getElementById('inf-pcpnc').value = '';
    document.getElementById('inf-fecha').value = '';
    document.getElementById('inf-horas').value = '';
    document.getElementById('inf-nombre-audiologo').value = '';
    
    // Resetear resultado
    document.getElementById('inf-res-valor').textContent = '0%';
    document.getElementById('inf-res-valor').style.color = '#5c5c5c';
    document.getElementById('inf-res-emoji').textContent = '⚙️';
    document.getElementById('inf-res-cat').textContent = 'SIN EVALUAR';
    document.getElementById('inf-res-msg').textContent = '-';
    
    // Resetear cifras de venta
    document.getElementById('inf-cifra-acum').value = 0;
    document.getElementById('inf-cifra-prev').value = 0;
    document.getElementById('inf-cifra-dif').textContent = '+0 €';
    document.getElementById('inf-cifra-dif').style.color = '#10b981';
    document.getElementById('inf-cifra-pct').innerHTML = '<span style="color:#C9A227">▲ +0.0%</span>';
    
    // Resetear barras
    ['pia','form','com','ayu','comp','rt','conv','age'].forEach(id => {
        document.getElementById('bar-' + id).style.width = '0%';
        document.getElementById('pct-' + id).textContent = '0%';
        document.getElementById('apl-' + id).textContent = '0.0%';
    });
    
    // Resetear conversiones
    document.getElementById('conv-mgm-val').value = '0';
    document.getElementById('conv-renove-val').value = '0';
    document.getElementById('conv-seguro-val').value = '0';
    document.getElementById('conv-ayudas-val').value = '0';
    document.getElementById('conv-imagen-val').value = '0';
    
    // Resetear KPIs
    document.querySelectorAll('.inf-kpi-sem').forEach(el => el.classList.remove('ok','ambar'));
    
    // Resetear textos
    document.getElementById('txt-observaciones').value = '';
    document.getElementById('txt-recomendaciones').value = '';
    document.getElementById('txt-compromisos').value = '';
    
    // Limpiar tabla mejoras
    document.getElementById('mejoras-tbody').innerHTML = '<tr><td colspan="3" style="text-align:center;padding:10px;color:#aaa;border:1px solid #ddd">Sin datos</td></tr>';
    
    // Limpiar imágenes
    for(let i=1; i<=6; i++) {
        document.getElementById('img-preview-' + i).style.display = 'none';
        document.getElementById('img-preview-' + i).src = '';
        document.getElementById('placeholder-' + i).style.display = 'flex';
        var btnBorrar = document.getElementById('btn-borrar-' + i);
        if(btnBorrar) btnBorrar.style.display = 'none';
    }
    
    // Resetear electromedicina
    document.getElementById('electro-marca').value = '';
    document.getElementById('electro-audiometro').checked = false;
    document.getElementById('electro-rem').checked = false;
    document.getElementById('electro-campolibre').checked = false;
    document.getElementById('electro-timpano').checked = false;
    document.getElementById('electro-video').checked = false;
    document.getElementById('electro-hit').checked = false;
    
    // Resetear gamas
    document.getElementById('gama-diamante-plus').value = 0;
    document.getElementById('gama-diamante').value = 0;
    document.getElementById('gama-platino-plus').value = 0;
    document.getElementById('gama-platino').value = 0;
    document.getElementById('gama-oro').value = 0;
    calcularGamas();
    
    // Resetear tipo atención
    document.getElementById('tipoaten-adulto').value = 0;
    document.getElementById('tipoaten-tinnitus').value = 0;
    document.getElementById('tipoaten-pediatrico').value = 0;
    calcularTipoAtencion();
    
    // Reinicializar gráficas
    setTimeout(initRadarCharts, 100);
    setTimeout(() => initDonutCharts(0, 0, 0), 150);
}

function mostrarInformeVacio() {
    document.getElementById('informe-selector').style.display = 'block';
    document.getElementById('informe-pro').classList.remove('active');
}

function mostrarInformeDirecto() {
    document.getElementById('informe-selector').style.display = 'none';
    document.getElementById('informe-pro').classList.add('active');
    const firmaEl = document.getElementById('inf-header-firma');
    if(firmaEl) firmaEl.innerHTML = '<span style="font-size:8px;color:#888;display:block">Responsable Audio</span><span style="font-size:11px;font-weight:600;color:#C9A227">Ariannys Rojas</span>';
    document.getElementById('inf-res-valor').textContent = '0%';
    document.getElementById('inf-res-emoji').textContent = '⚙️';
    document.getElementById('inf-res-cat').textContent = 'DEMO';
    document.getElementById('inf-res-msg').textContent = 'Vista previa del informe';
    setTimeout(initRadarCharts, 100);
}

// ========== GUÍA DE VISITA ==========
let fotosGuia = [];

const guiaModales = {
    basicos: {
        title: '🎧 11 BÁSICOS DE AUDIO',
        content: `
            <p style="color:#C9A227;font-size:12px;margin-bottom:14px;padding:10px;background:#fef3c7;border-radius:8px;font-weight:600">📋 Imagen • Presencia • Conocimiento • Integración • Comercial</p>
            <div class="guia-section"><div class="guia-section-title">A. IMAGEN</div>
                <div class="guia-item">1. Visibilidad exterior e interior de audio</div>
            </div>
            <div class="guia-section"><div class="guia-section-title">B. PRESENCIA</div>
                <div class="guia-item">2. Cumplimiento de 20 horas de presencia</div>
            </div>
            <div class="guia-section"><div class="guia-section-title">C. CONOCIMIENTO</div>
                <div class="guia-item">3. Formación actualizada en Academy</div>
                <div class="guia-item">4. Conocimiento y aplicación del Protocolo PIA</div>
            </div>
            <div class="guia-section"><div class="guia-section-title">D. INTEGRACIÓN</div>
                <div class="guia-item">5. Nivel de integración con equipo óptica</div>
                <div class="guia-item">6. Screening auditivo al 80% de clientes</div>
            </div>
            <div class="guia-section"><div class="guia-section-title">E. COMERCIAL</div>
                <div class="guia-item">7. Cumplimiento regla 80-80 (prueba-venta)</div>
                <div class="guia-item">8. Plan de acción local definido</div>
                <div class="guia-item">9. Stock adecuado según perfil centro</div>
                <div class="guia-item">10. Ofrecimiento sistemático de Tchin Tchin</div>
                <div class="guia-item">11. Uso de financiación Infinity</div>
            </div>
        `
    },
    imagen: {
        title: '🖼️ IMAGEN AUDIO',
        content: `
            <p style="color:#C9A227;font-size:12px;margin-bottom:14px;padding:10px;background:#fef3c7;border-radius:8px;font-weight:600">📋 Escaparate • Campañas • Elementos • Visibilidad</p>
            <div class="guia-section"><div class="guia-section-title">Puntos a Revisar</div>
                <div class="guia-item">• Estado del escaparate (limpieza, actualización)</div>
                <div class="guia-item">• Campañas actualizadas y visibles</div>
                <div class="guia-item">• Elementos PLV de audio (manteleta, cartelería)</div>
                <div class="guia-item">• Test de lectura visible en mostrador</div>
                <div class="guia-item">• Folletos de salud auditiva disponibles</div>
                <div class="guia-item">• Material de Infinity y seguros</div>
                <div class="guia-item">• Señalización interior de gabinete audio</div>
            </div>
            <div style="margin-top:12px;padding:10px;background:#fef3c7;border-radius:6px;font-size:10px;color:#8B7355">
                💡 <strong>Tip:</strong> Adjunta fotos del escaparate y elementos de audio en la sección principal.
            </div>
        `
    },
    agenda: {
        title: '📅 AGENDA',
        content: `
            <p style="color:#C9A227;font-size:12px;margin-bottom:14px;padding:10px;background:#fef3c7;border-radius:8px;font-weight:600">📋 1ª Visita • Rev-Post • No Asistidas • Reagendada</p>
            <div class="guia-section"><div class="guia-section-title">Puntos a Revisar</div>
                <div class="guia-item">• Distribución de agenda (75% 1ª visita / 25% revisiones)</div>
                <div class="guia-item">• Ocupación semanal y mensual</div>
                <div class="guia-item">• Tasa de no asistidas y gestión</div>
                <div class="guia-item">• Llamadas de recordatorio día anterior</div>
                <div class="guia-item">• Reagendado de citas no asistidas</div>
                <div class="guia-item">• Huecos disponibles a corto plazo</div>
            </div>
            <div style="margin-top:12px;padding:10px;background:#fef3c7;border-radius:6px">
                <div style="font-size:10px;color:#C9A227;font-weight:600;margin-bottom:4px">📊 Registra los datos de agenda en el Informe:</div>
                <div style="font-size:9px;color:#8B7355">Los valores de agenda se introducen directamente en la pantalla de Informes.</div>
            </div>
        `
    },
    equipo: {
        title: '👥 EQUIPO ÓPTICA',
        content: `
            <p style="color:#C9A227;font-size:12px;margin-bottom:14px;padding:10px;background:#fef3c7;border-radius:8px;font-weight:600">📋 Integración • Conocimiento • Derivación</p>
            <div class="guia-section"><div class="guia-section-title">Puntos a Revisar</div>
                <div class="guia-item">• ¿Realiza screening auditivo el equipo óptica?</div>
                <div class="guia-item">• ¿Conocen los básicos de audio?</div>
                <div class="guia-item">• ¿Saben agendar citas de audio correctamente?</div>
                <div class="guia-item">• ¿Hablan de audio con clientes de óptica?</div>
                <div class="guia-item">• ¿Entregan tarjeta revisión auditiva con encargos?</div>
                <div class="guia-item">• ¿Derivan clientes potenciales?</div>
                <div class="guia-item">• Formación "Primeros auxilios audio" realizada</div>
            </div>
        `
    },
    funnel: {
        title: '📊 FUNNEL',
        content: `
            <p style="color:#C9A227;font-size:12px;margin-bottom:14px;padding:10px;background:#fef3c7;border-radius:8px;font-weight:600">📋 Tráfico • Procedencia • Conversiones • Seguimiento</p>
            <div class="guia-section"><div class="guia-section-title">Puntos a Revisar</div>
                <div class="guia-item">• Volumen de tráfico mensual</div>
                <div class="guia-item">• Procedencia de leads (óptica, calle, MGM, campañas)</div>
                <div class="guia-item">• Ratio de conversión a prueba (objetivo 80%)</div>
                <div class="guia-item">• Ratio de conversión a venta (objetivo 80%)</div>
                <div class="guia-item">• Llamadas de control realizadas</div>
                <div class="guia-item">• Seguimiento de presupuestos pendientes</div>
                <div class="guia-item">• Control de pacientes pérdida-no prueba</div>
                <div class="guia-item">• Gestión de pacientes pilas-HIT</div>
            </div>
        `
    },
    revision: {
        title: '🔧 REVISIÓN TÉCNICA',
        content: `
            <p style="color:#C9A227;font-size:12px;margin-bottom:14px;padding:10px;background:#fef3c7;border-radius:8px;font-weight:600">📋 Protocolo • Pruebas • Equipamiento</p>
            <div class="guia-section"><div class="guia-section-title">Puntos a Revisar</div>
                <div class="guia-item">• Aplicación correcta del protocolo PIA</div>
                <div class="guia-item">• Realización de pruebas completas (VA, VO, UCL)</div>
                <div class="guia-item">• Uso de timpanometría en cada paciente</div>
                <div class="guia-item">• Realización y conocimiento de HIT</div>
                <div class="guia-item">• Ejecución de campo libre</div>
                <div class="guia-item">• Estado de stock de audífonos</div>
                <div class="guia-item">• Control de devoluciones y plazos</div>
                <div class="guia-item">• Estado de equipamiento (audiómetro, impedanciómetro)</div>
                <div class="guia-item">• Gabinete limpio y ordenado</div>
            </div>
        `
    },
    infinity: {
        title: '💳 PLAN INFINITY AUDIO',
        content: `
            <p style="color:#C9A227;font-size:12px;margin-bottom:14px;padding:10px;background:#fef3c7;border-radius:8px;font-weight:600">📋 Financiación cada 3 años · Gama INCOGNITO · PEPPER FINANCE</p>
            <div class="guia-section"><div class="guia-section-title">💰 MODELO DE FINANCIACIÓN</div>
                <div class="guia-item">• <strong>42 cuotas mensuales</strong> divididas en dos tramos</div>
                <div class="guia-item">• <strong>Primer tramo:</strong> 36 cuotas sin intereses (TIN 0%), sin comisión apertura</div>
                <div class="guia-item">• <strong>Segundo tramo:</strong> 3 opciones para las últimas 6 cuotas</div>
            </div>
            <div class="guia-section"><div class="guia-section-title" style="color:#C9A227">✅ OPCIÓN 1 - RENOVAR (La mejor)</div>
                <div class="guia-item">• Cliente desea <strong>renovar audífonos</strong> por otros INCOGNITO</div>
                <div class="guia-item">• Acudir al centro con <strong>20 días de antelación</strong> a la cuota 36</div>
                <div class="guia-item">• El centro se hace cargo de las 6 últimas cuotas (<strong>sin coste para cliente</strong>)</div>
                <div class="guia-item">• <strong>Requisito:</strong> Entregar audífonos actuales</div>
            </div>
            <div class="guia-section"><div class="guia-section-title" style="color:#b8960c">⚠️ OPCIÓN 2 - NO RENOVAR</div>
                <div class="guia-item">• Cliente NO desea renovar</div>
                <div class="guia-item">• Continúa pagando cuotas 37-42 con <strong>TIN 7,95%</strong></div>
            </div>
            <div class="guia-section"><div class="guia-section-title" style="color:#8b5cf6">💜 OPCIÓN 3 - PAGO ÚNICO</div>
                <div class="guia-item">• Solicitar 20 días antes de cuota 36</div>
                <div class="guia-item">• Cuota única nº37 <strong>SIN intereses (TIN 0%)</strong></div>
            </div>
            <div style="margin-top:12px;padding:10px;background:#fef3c7;border-radius:8px;border-left:4px solid #C9A227">
                <div style="font-weight:700;color:#C9A227;margin-bottom:4px;font-size:11px">🎯 Puntos Clave de Venta</div>
                <div style="font-size:10px;color:#8B7355">• "Renueva cada 3 años sin coste adicional"<br>• "36 meses sin intereses"<br>• "Si renuevas, las últimas 6 cuotas te las regalamos"</div>
            </div>
        `
    },
    seguro: {
        title: '🛡️ SEGURO DE AUDÍFONOS CASER',
        content: `
            <p style="color:#C9A227;font-size:12px;margin-bottom:14px;padding:10px;background:#fef3c7;border-radius:8px;font-weight:600">📋 Caser Grupo Helvetia · Protección 3 años · STARKEY y WSA</p>
            <div class="guia-section"><div class="guia-section-title">🛡️ COBERTURAS</div>
                <div class="guia-item">• <strong>Daño accidental:</strong> Causa externa, súbita e imprevisible</div>
                <div class="guia-item">• <strong>Robo:</strong> Sustracción con fuerza, intimidación o violencia</div>
                <div class="guia-item">• <strong>Duración:</strong> 3 años desde la compra</div>
                <div class="guia-item">• Se puede contratar hasta <strong>15 días después</strong> de la venta</div>
            </div>
            <div class="guia-section"><div class="guia-section-title">💰 TARIFAS (Pago único)</div>
                <table style="width:100%;font-size:10px;border-collapse:collapse;margin:6px 0">
                    <tr style="background:#fef3c7"><td style="padding:5px;border:1px solid #fde68a"><strong>Gama Oro</strong></td><td style="padding:5px;border:1px solid #fde68a;text-align:center"><strong>200€</strong></td></tr>
                    <tr><td style="padding:5px;border:1px solid #fde68a"><strong>Gama Platino</strong></td><td style="padding:5px;border:1px solid #fde68a;text-align:center"><strong>250€</strong></td></tr>
                    <tr style="background:#fef3c7"><td style="padding:5px;border:1px solid #fde68a"><strong>Gama Diamante</strong></td><td style="padding:5px;border:1px solid #fde68a;text-align:center"><strong>250€</strong></td></tr>
                </table>
            </div>
            <div class="guia-section"><div class="guia-section-title">📝 OPERATIVA EN TIENDA</div>
                <div class="guia-item">1. Contratación a través de <strong>NOWON</strong></div>
                <div class="guia-item">2. Rellenar: importe, tipo audífono, nº serie</div>
                <div class="guia-item">3. Datos personales + cuenta bancaria del cliente</div>
                <div class="guia-item">4. Cliente firma en su teléfono</div>
                <div class="guia-item">5. Caser envía póliza por email</div>
                <div style="margin-top:6px;padding:6px;background:#fef2f2;border-radius:4px;font-size:9px;color:#5c5c5c">⚠️ <strong>¡ATENCIÓN!</strong> No es venta · No genera cifra · No se mete en GIO</div>
            </div>
            <div style="margin-top:12px;padding:10px;background:#fef3c7;border-radius:8px;border-left:4px solid #C9A227">
                <div style="font-weight:700;color:#C9A227;margin-bottom:4px;font-size:11px">🎯 Argumentario de Venta</div>
                <div style="font-size:10px;color:#8B7355">• "Por solo 250€ y en un único pago, protege tus audífonos 3 años"<br>• "Cobertura ante robo y daño accidental"</div>
            </div>
        `
    },
    seguimiento: {
        title: '📞 PROTOCOLO DE SEGUIMIENTO',
        content: `
            <p style="color:#C9A227;font-size:12px;margin-bottom:14px;padding:10px;background:#fef3c7;border-radius:8px;font-weight:600">📋 Timeline completo · Adaptación · Confort · Control Rendimiento</p>
            <div style="display:flex;gap:4px;margin-bottom:12px;font-size:8px;font-weight:700">
                <div style="flex:1;text-align:center;padding:6px;background:#fef3c7;border-radius:4px;color:#8B7355">Adaptación<br>0-6M</div>
                <div style="flex:1;text-align:center;padding:6px;background:#fed7aa;border-radius:4px;color:#9a3412">Confort<br>12-24M</div>
                <div style="flex:1;text-align:center;padding:6px;background:#C9A227;border-radius:4px;color:#fff">Control<br>34-48M</div>
            </div>
            <div class="guia-section"><div class="guia-section-title">🟡 FASE ADAPTACIÓN (3M - 6M)</div>
                <div class="guia-item">• Ajustar detalles: comodidad y expectativas</div>
                <div class="guia-item">• Llamadas y programaciones con ajuste remoto</div>
                <div class="guia-item">• <strong>Síncrono:</strong> Videollamada en tiempo real</div>
                <div class="guia-item">• <strong>Asíncrono:</strong> Ajuste sin interactuar, envío a App</div>
            </div>
            <div class="guia-section"><div class="guia-section-title" style="color:#ea580c">🔴 FASE CONFORT (MES 12 - MES 24)</div>
                <div class="guia-item">• <strong>PRESENCIAL - SE REALIZA HIT-FreeStyle ⭐</strong></div>
                <div class="guia-item">• Audiometría comparativa</div>
                <div class="guia-item">• Mantenimiento: limpieza, cambio filtros y tulipas</div>
                <div class="guia-item">• Recomendación accesorio conectividad TV</div>
            </div>
            <div class="guia-section"><div class="guia-section-title" style="color:#4a4a4a">⭐ CONTROL RENDIMIENTO - INFINITY (MES 34 - 48)</div>
                <div class="guia-item"><strong>MES 34:</strong> Cliente deja audífonos para comprobación</div>
                <div class="guia-item">• Dejamos unos en sustitución de nueva tecnología</div>
                <div class="guia-item">• HIT estándar y FreeStyle con informe</div>
                <div class="guia-item"><strong>MES 40/48:</strong> Si no renueva - Audiometría + Resultados HIT</div>
            </div>
            <div style="margin-top:12px;padding:10px;background:#fef3c7;border-radius:8px;border-left:4px solid #C9A227">
                <div style="font-weight:700;color:#C9A227;margin-bottom:4px;font-size:11px">🎯 Puntos Clave</div>
                <div style="font-size:10px;color:#8B7355">• HIT obligatorio en Mes 12, 24, 34 y 48<br>• Mes 34: Oportunidad de renovación Infinity</div>
            </div>
        `
    },
    galeria: {
        title: '📷 GALERÍA DE ELEMENTOS AUDIO',
        content: `
            <p style="color:#C9A227;font-size:12px;margin-bottom:14px;padding:10px;background:#fef3c7;border-radius:8px;font-weight:600">📋 Elementos Audio · Campañas · Otros</p>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px">
                <div style="border:2px dashed #C9A227;border-radius:8px;padding:16px;text-align:center;cursor:pointer;background:#fffbeb" onclick="document.getElementById('gal1').click()">
                    <input type="file" id="gal1" accept="image/*" style="display:none" onchange="subirImagenGaleria(event,0)">
                    <div style="font-size:20px;margin-bottom:4px">📷</div>
                    <div style="font-size:9px;color:#C9A227">Elemento 1</div>
                </div>
                <div style="border:2px dashed #C9A227;border-radius:8px;padding:16px;text-align:center;cursor:pointer;background:#fef3c7" onclick="document.getElementById('gal2').click()">
                    <input type="file" id="gal2" accept="image/*" style="display:none" onchange="subirImagenGaleria(event,1)">
                    <div style="font-size:20px;margin-bottom:4px">🎯</div>
                    <div style="font-size:9px;color:#C9A227">Campaña</div>
                </div>
                <div style="border:2px dashed #C9A227;border-radius:8px;padding:16px;text-align:center;cursor:pointer;background:#fde68a" onclick="document.getElementById('gal3').click()">
                    <input type="file" id="gal3" accept="image/*" style="display:none" onchange="subirImagenGaleria(event,2)">
                    <div style="font-size:20px;margin-bottom:4px">📋</div>
                    <div style="font-size:9px;color:#8B7355">PLV</div>
                </div>
                <div style="border:2px dashed #C9A227;border-radius:8px;padding:16px;text-align:center;cursor:pointer;background:#fffbeb" onclick="document.getElementById('gal4').click()">
                    <input type="file" id="gal4" accept="image/*" style="display:none" onchange="subirImagenGaleria(event,3)">
                    <div style="font-size:20px;margin-bottom:4px">🖼️</div>
                    <div style="font-size:9px;color:#C9A227">Escaparate</div>
                </div>
            </div>
            <div id="galeriaPreview" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px"></div>
        `
    },
    repositorio: {
        title: '📁 REPOSITORIO DE DOCUMENTOS',
        content: `
            <p style="color:#C9A227;font-size:12px;margin-bottom:14px;padding:10px;background:#fef3c7;border-radius:8px;font-weight:600">📋 Contratos · Documentos · Archivos</p>
            <div style="margin-bottom:12px">
                <button onclick="document.getElementById('repoFile').click()" style="width:100%;padding:10px;background:#C9A227;color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer">
                    ➕ ADJUNTAR DOCUMENTO
                </button>
                <input type="file" id="repoFile" accept=".pdf,.doc,.docx,.jpg,.png" style="display:none" onchange="subirDocumentoRepo(event)">
            </div>
            <div id="repositorioLista" style="background:#fafafa;border-radius:8px;padding:10px;min-height:150px">
                <p style="text-align:center;color:#C9A227;font-size:11px;padding:30px 20px">
                    📁 Sin documentos adjuntos<br>
                    <span style="font-size:9px;color:#8B7355">Máximo 10 archivos</span>
                </p>
            </div>
        `
    },
    affleloucontigo: {
        title: '💚 AFFLELOU CONTIGO',
        content: `
            <p style="color:#C9A227;font-size:12px;margin-bottom:14px;padding:10px;background:#fef3c7;border-radius:8px;font-weight:600">💚 Paquete Bienestar · Teleasistencia · Cuidado integral</p>
            
            <div style="background:#dcfce7;border-radius:8px;padding:12px;margin-bottom:12px;border-left:4px solid #C9A227">
                <p style="font-size:11px;color:#166534;margin:0;line-height:1.5"><strong>"AFFLELOU Contigo"</strong> está dirigido a todas las personas que realicen una compra de audífonos y nace con un compromiso claro: <strong>cuidar de nuestros pacientes dentro y fuera del centro</strong>, garantizando tranquilidad, seguimiento y acompañamiento constante.</p>
            </div>
            
            <div class="guia-section">
                <div class="guia-section-title">📦 SERVICIOS INCLUIDOS (1 AÑO)</div>
                <div class="guia-item">• <strong>Teleasistencia premium</strong> - Atención 24h ilimitada</div>
                <div class="guia-item">• <strong>Telefarmacia</strong> - Medicamentos en menos de 3h (2 servicios/año)</div>
                <div class="guia-item">• <strong>Consultas médicas</strong> - Vía telefónica 24h, ilimitadas</div>
                <div class="guia-item">• <strong>Asesoramiento social</strong> - Apoyo y orientación, ilimitados</div>
            </div>
            
            <div class="guia-section">
                <div class="guia-section-title">⚙️ PARTE OPERATIVA</div>
                <div class="guia-item">1. Registrar la venta del audífono en GIO</div>
                <div class="guia-item">2. Añadir el artículo <strong>"Servicio AFFLELOU Contigo"</strong> en la línea de encargo</div>
                <div class="guia-item">3. Aplicar la bonificación correspondiente en:<br>
                    <span style="color:#C9A227;font-size:10px;margin-left:12px">→ Descuento Porcentual (Bonificaciones), con nombre <strong>"Servicio Afflelou Contigo"</strong></span>
                </div>
                <div class="guia-item">4. ¡Y ya estaría!</div>
            </div>
            
            <div class="guia-section">
                <div class="guia-section-title">👤 GESTIÓN DEL CLIENTE</div>
                <div class="guia-item">• Al día siguiente, el cliente podrá acceder a la app <strong>"AFFLELOU Contigo"</strong> mediante su número de teléfono</div>
                <div class="guia-item">• Para acceder al servicio, el cliente tendrá que <strong>escanear el QR</strong> que aparece en el tarjetón que le entregaremos después de la compra</div>
            </div>
            
            <div style="background:#fef3c7;border-radius:8px;padding:12px;margin-top:12px;border-left:4px solid #b8960c">
                <p style="font-size:10px;color:#8B7355;margin:0"><strong>⚠️ IMPORTANTE:</strong> Los materiales ya deberíais tenerlos en PDV</p>
            </div>
            
            <div style="margin-top:14px;text-align:center">
                <a href="https://affleloucontigo.vivofacil.com/" target="_blank" style="display:inline-block;background:linear-gradient(135deg,#C9A227,#a88b1e);color:#fff;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:700;font-size:12px">
                    🌐 ACCEDER A WEB AFFLELOU CONTIGO
                </a>
            </div>
        `
    },
    ayudas: {
        title: '🏛️ AYUDAS Y SUBVENCIONES',
        content: `
            <div class="guia-section">
                <div class="guia-section-title">📋 INFORMACIÓN GENERAL</div>
                <div class="guia-item">• Las <strong>ayudas para audífonos</strong> varían según la Comunidad Autónoma</div>
                <div class="guia-item">• Es importante conocer los <strong>requisitos y documentación</strong> necesaria en cada caso</div>
                <div class="guia-item">• El centro debe estar <strong>adscrito</strong> para el reconocimiento de ayudas</div>
            </div>
            
            <div class="guia-section">
                <div class="guia-section-title">🗺️ AYUDAS POR COMUNIDAD AUTÓNOMA</div>
                <div class="guia-item">• <strong>Andalucía:</strong> Consultar Junta de Andalucía - Servicios Sociales</div>
                <div class="guia-item">• <strong>Cataluña:</strong> CatSalut - Prestaciones ortoprotésicas</div>
                <div class="guia-item">• <strong>Madrid:</strong> Comunidad de Madrid - Dependencia</div>
                <div class="guia-item">• <strong>Valencia:</strong> Conselleria de Sanitat</div>
                <div class="guia-item">• <strong>País Vasco:</strong> Osakidetza</div>
                <div class="guia-item">• <strong>Galicia:</strong> SERGAS - Prestaciones</div>
                <div class="guia-item">• <strong>Otras CCAA:</strong> Consultar servicios sociales autonómicos</div>
            </div>
            
            <div class="guia-section">
                <div class="guia-section-title">📝 PROCEDIMIENTO GENERAL</div>
                <div class="guia-item"><strong>1.</strong> Verificar si el paciente cumple requisitos (edad, grado discapacidad, renta)</div>
                <div class="guia-item"><strong>2.</strong> Solicitar prescripción médica del especialista ORL</div>
                <div class="guia-item"><strong>3.</strong> Presentar documentación en servicios sociales</div>
                <div class="guia-item"><strong>4.</strong> Esperar resolución y autorización</div>
                <div class="guia-item"><strong>5.</strong> Adquisición del audífono en centro autorizado</div>
            </div>
            
            <div class="guia-section">
                <div class="guia-section-title">⚠️ REQUISITOS COMUNES</div>
                <div class="guia-item">• Certificado de discapacidad o dependencia</div>
                <div class="guia-item">• Prescripción médica ORL</div>
                <div class="guia-item">• Empadronamiento en la CCAA</div>
                <div class="guia-item">• Límite de renta según baremo autonómico</div>
            </div>
            
            <div style="background:#d1fae5;border-radius:8px;padding:12px;margin-top:12px;border-left:4px solid #166534">
                <p style="font-size:10px;color:#166534;margin:0"><strong>💡 CONSEJO:</strong> Mantener actualizada la documentación y conocer los plazos de solicitud de cada CCAA.</p>
            </div>
            
            <div style="margin-top:14px;text-align:center">
                <p style="font-size:11px;color:#333;margin-bottom:8px"><strong>📌 Para más información, consulta en:</strong></p>
                <a href="https://alainafflelou.my.site.com/hotspot/s/ayudas-y-subvenciones" target="_blank" style="display:inline-block;background:linear-gradient(135deg,#C9A227,#a88b1e);color:#fff;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:700;font-size:12px">
                    🌐 HOTSPOT - AYUDAS Y SUBVENCIONES
                </a>
            </div>
        `
    },
    enlaces: {
        title: '🔗 ENLACES DE INTERÉS',
        content: `
            <div class="guia-section">
                <div style="display:grid;gap:8px;margin-top:8px">
                    <a href="https://www.afflelouacademy.es/v3/space/discover" target="_blank" style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:#f5f5f5;border-radius:8px;text-decoration:none;color:#333;border:1px solid #e0e0e0">
                        <span style="font-size:20px">📚</span>
                        <div><strong style="color:#C9A227">AFFLELOU Academy</strong><br><span style="font-size:10px;color:#666">Plataforma de formación online</span></div>
                    </a>
                    <a href="https://www.afflelouacademy.es/v3/list/discover-schools" target="_blank" style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:#f5f5f5;border-radius:8px;text-decoration:none;color:#333;border:1px solid #e0e0e0">
                        <span style="font-size:20px">💊</span>
                        <div><strong style="color:#C9A227">Píldoras Audio</strong><br><span style="font-size:10px;color:#666">Formación rápida en audio</span></div>
                    </a>
                    <a href="https://www.afflelouacademy.es/v3/plugin/3131510" target="_blank" style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:#f5f5f5;border-radius:8px;text-decoration:none;color:#333;border:1px solid #e0e0e0">
                        <span style="font-size:20px">🤝</span>
                        <div><strong style="color:#C9A227">Sinergias</strong><br><span style="font-size:10px;color:#666">Colaboración óptica-audio</span></div>
                    </a>
                    <a href="https://alainafflelou.my.site.com/hotspot/s/alain-afflelou-audiologo" target="_blank" style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:#f5f5f5;border-radius:8px;text-decoration:none;color:#333;border:1px solid #e0e0e0">
                        <span style="font-size:20px">🔥</span>
                        <div><strong style="color:#C9A227">Hotspot Audiólogo</strong><br><span style="font-size:10px;color:#666">Portal del audiólogo Afflelou</span></div>
                    </a>
                </div>
            </div>
        `
    }
};

let galeriaImagenes = [];
let repositorioArchivos = [];

function openGuiaModal(tipo) {
    const m = guiaModales[tipo];
    if (!m) return;
    document.getElementById('modalGuiaTitle').innerHTML = m.title;
    document.getElementById('modalGuiaBody').innerHTML = m.content;
    document.getElementById('modalGuia').style.display = 'flex';
}

function closeGuiaModal() {
    document.getElementById('modalGuia').style.display = 'none';
}

function adjuntarFotosGuia(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    for (let i = 0; i < files.length && fotosGuia.length < 10; i++) {
        const file = files[i];
        if (!file.type.startsWith('image/')) continue;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const maxSize = 400;
                let w = img.width, h = img.height;
                if (w > h) { if (w > maxSize) { h = h * (maxSize / w); w = maxSize; } }
                else { if (h > maxSize) { w = w * (maxSize / h); h = maxSize; } }
                canvas.width = w;
                canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                fotosGuia.push({ name: file.name, data: canvas.toDataURL('image/jpeg', 0.4) });
                renderFotosGuia();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    event.target.value = '';
}

function renderFotosGuia() {
    const preview = document.getElementById('fotosGuiaPreview');
    const grid = document.getElementById('fotosGuiaGrid');
    const count = document.getElementById('fotosGuiaCount');
    
    if (!preview || !grid) return;
    
    if (fotosGuia.length === 0) {
        preview.style.display = 'none';
        if (count) count.textContent = '';
        return;
    }
    
    preview.style.display = 'block';
    if (count) count.textContent = fotosGuia.length + ' foto(s)';
    
    grid.innerHTML = fotosGuia.map((f, i) => `
        <div style="position:relative;width:60px;height:60px;border-radius:6px;overflow:hidden;border:2px solid #C9A227">
            <img src="${f.data}" style="width:100%;height:100%;object-fit:cover">
            <button onclick="eliminarFotoGuia(${i})" style="position:absolute;top:2px;right:2px;width:16px;height:16px;background:#5c5c5c;color:white;border:none;border-radius:50%;font-size:10px;cursor:pointer">×</button>
        </div>
    `).join('');
}

function eliminarFotoGuia(idx) {
    fotosGuia.splice(idx, 1);
    renderFotosGuia();
}

function subirImagenGaleria(event, idx) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            galeriaImagenes[idx] = await comprimirImagen(e.target.result, 600, 450, 0.4);
        } catch(err) {
            try { galeriaImagenes[idx] = await comprimirImagen(e.target.result, 300, 225, 0.25); } catch(e2) { galeriaImagenes[idx] = e.target.result; }
        }
    };
    reader.onerror = function() { console.error('[subirImagenGaleria] Error leyendo archivo'); };
    reader.readAsDataURL(file);
}

function subirDocumentoRepo(event) {
    const file = event.target.files[0];
    if (!file || repositorioArchivos.length >= 10) return;
    repositorioArchivos.push({ name: file.name, size: file.size });
    renderRepositorio();
}

function renderRepositorio() {
    const lista = document.getElementById('repositorioLista');
    if (!lista) return;
    if (repositorioArchivos.length === 0) {
        lista.innerHTML = '<p style="text-align:center;color:#C9A227;font-size:11px;padding:30px 20px">📁 Sin documentos adjuntos</p>';
        return;
    }
    lista.innerHTML = repositorioArchivos.map((f, i) => `
        <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#fff;border-radius:6px;margin-bottom:6px;border:1px solid #fde68a">
            <span style="font-size:16px">📄</span>
            <span style="flex:1;font-size:11px;color:#1a1a2e">${f.name}</span>
            <button onclick="repositorioArchivos.splice(${i},1);renderRepositorio()" style="background:#5c5c5c;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:9px;cursor:pointer">×</button>
        </div>
    `).join('');
}

// Init
const hoy = new Date();
var fechaHoyEl = document.getElementById('fecha-hoy');
if(fechaHoyEl) fechaHoyEl.textContent = hoy.toLocaleDateString('es-ES', {weekday:'long',year:'numeric',month:'long',day:'numeric'});
var evalFechaEl = document.getElementById('eval-fecha');
if(evalFechaEl) evalFechaEl.valueAsDate = hoy;
renderPreinformes();
updateDashboard();
setTimeout(dibujarPentagonoDashboard, 300);

// Limpiar evaluación al iniciar
function limpiarEvaluacion() {
    if(saltarLimpiezaEvaluacion) return;
    document.getElementById('eval-centro').value = '';
    document.getElementById('eval-pcpnc').value = '';
    document.getElementById('eval-fecha').valueAsDate = new Date();
    document.getElementById('eval-responsable').selectedIndex = 0;
    respuestas = {};
    currentQuestion = 0;
    huboObligatoriaNo = false;
    centroEvaluacionActual = null;
    document.getElementById('eval-portada').classList.add('active');
    var dinamica = document.getElementById('eval-dinamica');
    if(dinamica) dinamica.classList.remove('active');
    var informe = document.getElementById('eval-informe');
    if(informe) informe.classList.remove('active');
}

// FIREBASE Y FUNNEL
var db = null;
var funnelDataCache = {};

// ═══════════════════════════════════════════════════════════════════════════════
// SHAREDSYNC v4 — Sincronización entre PCs via Firestore (plataformaAdmin)
// NOTA: NO toca inicializarFirebase ni audiometrias. Es 100% independiente.
// ═══════════════════════════════════════════════════════════════════════════════
var SharedSync = (function() {
    var ARRAY_KEYS = [
        'visitasAgendadas', 'preinformes', 'informesFinalizados', 'informesBorrador',
        'borradoresInforme', 'evaluaciones', 'accionesFlop',
        'accionesExclusivosFunnel', 'accionesFlopFunnel'
    ];
    var SET_KEYS = ['centrosFlop'];
    var OBJECT_KEYS = ['accionesCentros', 'paquetesCentros', 'centrosModificados'];
    var VALUE_KEYS = [
        'cifrasMesActual', 'cifrasPrevMes', 'datosCVNMes',
        'funnelDashboardData', 'gamasDashboardData', 'aarData'
    ];
    var ALL_KEYS = ARRAY_KEYS.concat(SET_KEYS, OBJECT_KEYS, VALUE_KEYS);
    var SHARED_PREFIXES = ['criteriosPaq_'];
    var COLLECTION = 'plataformaAdmin';
    
    var _db = null, _isReceiving = false, _initDone = false;
    var _pendingWrites = {}, _unsubscribe = null, _syncLog = [];
    var _origGet = localStorage.getItem.bind(localStorage);
    var _origSet = localStorage.setItem.bind(localStorage);
    var _origRemove = localStorage.removeItem.bind(localStorage);
    var _deleteLocks = {}; // Bloqueo temporal para borrados
    
    function log(msg) { _syncLog.push('[' + new Date().toLocaleTimeString() + '] ' + msg); console.log('[SharedSync] ' + msg); }
    
    // Marcar que se acaba de borrar algo en una key (evita merge por 30 segundos)
    function lockKeyForDelete(key) {
        _deleteLocks[key] = Date.now();
        setTimeout(function() { delete _deleteLocks[key]; }, 30000);
    }
    
    function isKeyLockedForDelete(key) {
        if(!_deleteLocks[key]) return false;
        if(Date.now() - _deleteLocks[key] > 30000) {
            delete _deleteLocks[key];
            return false;
        }
        return true;
    }
    
    function isSharedKey(key) {
        if(ALL_KEYS.indexOf(key) >= 0) return true;
        for(var i = 0; i < SHARED_PREFIXES.length; i++) {
            if(key.indexOf(SHARED_PREFIXES[i]) === 0) return true;
        }
        return false;
    }
    
    function getKeyType(key) {
        if(ARRAY_KEYS.indexOf(key) >= 0) return 'array';
        if(SET_KEYS.indexOf(key) >= 0) return 'set';
        if(OBJECT_KEYS.indexOf(key) >= 0) return 'object';
        return 'value';
    }
    
    function getItemId(item) {
        if(item === null || item === undefined) return '';
        if(typeof item !== 'object') return String(item);
        if(item.id !== undefined && item.id !== null) return String(item.id);
        if(item.centro && item.fecha) return item.centro + '_' + item.fecha;
        if(item.centro) return item.centro + '_' + JSON.stringify(item).length;
        return JSON.stringify(item);
    }
    
    function mergeArrays(localArr, remoteArr) {
        // Si el local tiene MENOS elementos, probablemente hubo un borrado - usar local
        if(localArr.length < remoteArr.length) {
            return localArr;
        }
        // Si son iguales o local tiene más, hacer merge normal
        var seen = {}, merged = [];
        var all = remoteArr.concat(localArr);
        for(var i = 0; i < all.length; i++) {
            var id = getItemId(all[i]);
            if(!id || !seen[id]) {
                if(id) seen[id] = true;
                merged.push(all[i]);
            }
        }
        return merged;
    }
    
    function mergeValues(key, localStr, remoteStr) {
        var type = getKeyType(key);
        if(type === 'value') return remoteStr;
        try {
            var local = JSON.parse(localStr);
            var remote = JSON.parse(remoteStr);
            // Si el array local es más corto, hubo un borrado - respetar borrado
            if(type === 'array') {
                if(local.length < remote.length) {
                    return localStr; // Borrado - usar local
                }
                return JSON.stringify(mergeArrays(local, remote));
            }
            if(type === 'set') {
                var s = {}; var arr = (local||[]).concat(remote||[]);
                for(var i=0;i<arr.length;i++) s[arr[i]]=true;
                return JSON.stringify(Object.keys(s));
            }
            if(type === 'object') return JSON.stringify(Object.assign({}, remote, local));
        } catch(e) {}
        return remoteStr;
    }
    
    function updateUI(status, count) {
        var el = document.getElementById('sync-status-indicator');
        if(!el) return;
        var styles = {
            'syncing': { bg:'#fef3c7', color:'#92400e', text:'🔄 Sincronizando...' },
            'online':  { bg:'#d1fae5', color:'#065f46', text:'✅ Sync' + (count ? ' ('+count+')' : ' OK') },
            'error':   { bg:'#fee2e2', color:'#991b1b', text:'❌ Error sync' },
            'rules':   { bg:'#fee2e2', color:'#991b1b', text:'🔒 Rules!' }
        };
        var s = styles[status] || styles['error'];
        el.style.background = s.bg; el.style.color = s.color; el.innerHTML = s.text;
    }
    
    // Interceptar localStorage para auto-sync
    localStorage.setItem = function(key, value) {
        _origSet(key, value);
        if(_isReceiving) return;
        if(!isSharedKey(key)) return;
        if(_db && _initDone) {
            _db.collection(COLLECTION).doc(key).set({
                v: value, ts: firebase.firestore.FieldValue.serverTimestamp()
            }).then(function() { log('⬆️ ' + key + ' → Firebase OK'); })
              .catch(function(e) { log('❌ Error subiendo ' + key + ': ' + e.message); });
        } else {
            _pendingWrites[key] = value;
        }
    };
    localStorage.removeItem = function(key) {
        _origRemove(key);
        if(!_isReceiving && _db && isSharedKey(key)) {
            _db.collection(COLLECTION).doc(key).delete().catch(function(){});
        }
    };
    
    function startListening() {
        if(_unsubscribe) { _unsubscribe(); _unsubscribe = null; }
        var isFirst = true;
        
        // DESACTIVAR listener de tiempo real - causa más problemas que beneficios
        // Los datos se sincronizan cuando el usuario hace acciones (guardar/borrar)
        // Esto PREVIENE que datos borrados se restauren desde otros PCs
        log('🔒 Listener desactivado - sincronización solo por acción del usuario');
        updateUI('online');
        return; // NO iniciar listener
        
        /* CÓDIGO DESACTIVADO - causaba restauración de datos borrados
        _unsubscribe = _db.collection(COLLECTION).onSnapshot(function(snapshot) {
            if(isFirst) { isFirst = false; return; }
            var changed = [];
            snapshot.docChanges().forEach(function(change) {
                var key = change.doc.id;
                if(!isSharedKey(key)) return;
                
                // CRÍTICO: Si hay CUALQUIER dato local, IGNORAR el remoto
                // Esto previene que datos borrados localmente se restauren
                var localData = _origGet(key);
                if(localData !== null && localData !== undefined) {
                    // Hay datos locales - NO sobrescribir con remotos
                    // Solo subir nuestros datos locales a Firebase para sincronizar
                    log('🛡️ Manteniendo datos locales de ' + key + ' (ignorando remoto)');
                    return;
                }
                
                // Solo aceptar datos remotos si NO hay datos locales (primera carga)
                if(change.type === 'added' || change.type === 'modified') {
                    var remote = change.doc.data().v;
                    if(remote === undefined || remote === null) return;
                    _isReceiving = true; 
                    _origSet(key, remote); 
                    _isReceiving = false;
                    changed.push(key);
                } else if(change.type === 'removed') {
                    _isReceiving = true; _origRemove(key); _isReceiving = false;
                    changed.push(key);
                }
            });
            if(changed.length > 0) {
                log('🔄 Cambios recibidos: ' + changed.join(', '));
                if(typeof refrescarDatosEnMemoria === 'function') refrescarDatosEnMemoria();
                updateUI('online');
            }
        }, function(err) {
            log('⚠️ Listener error: ' + err.message);
            updateUI('error');
            setTimeout(function() { if(_db) startListening(); }, 5000);
        });
        log('👁️ Escuchando cambios en tiempo real');
        LISTENER DESACTIVADO */
    }
    
    async function init(dbInstance) {
        _db = dbInstance;
        if(!_db) { updateUI('error'); return false; }
        updateUI('syncing');
        try {
            // PASO 1: Descargar
            var snapshot;
            try { snapshot = await _db.collection(COLLECTION).get(); }
            catch(e) {
                log('⚠️ No se pudo leer plataformaAdmin: ' + e.message);
                updateUI('rules');
                _initDone = true;
                try {
                    var alertDiv = document.createElement('div');
                    alertDiv.id = 'sync-fail-alert';
                    alertDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#dc2626,#991b1b);color:#fff;padding:12px 20px;z-index:99999;font-size:13px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 20px rgba(0,0,0,0.4)';
                    alertDiv.innerHTML = '<div><strong>🔒 SINCRONIZACIÓN BLOQUEADA</strong> — Los datos entre PCs NO se sincronizan. Firestore Rules no permite "plataformaAdmin".<br><span style="font-size:11px;opacity:0.9">Firebase Console → Firestore → Rules → <code style="background:rgba(255,255,255,0.2);padding:2px 6px;border-radius:3px">match /{document=**} { allow read, write: if true; }</code></span></div><button onclick="this.parentElement.remove()" style="background:#fff;color:#dc2626;border:none;padding:6px 12px;border-radius:6px;font-weight:700;cursor:pointer;margin-left:12px">✕</button>';
                    document.body.appendChild(alertDiv);
                } catch(x){}
                return false;
            }
            var firebaseData = {};
            snapshot.forEach(function(doc) {
                var d = doc.data();
                if(d.v !== undefined && d.v !== null) firebaseData[doc.id] = d.v;
            });
            log('📥 ' + Object.keys(firebaseData).length + ' claves descargadas');
            
            // PASO 2: LOCAL ES LA FUENTE DE VERDAD
            // Si hay datos locales, los subimos a Firebase
            // Si NO hay datos locales, descargamos de Firebase
            var batch = _db.batch(), batchCount = 0, processed = {};
            for(var fbKey in firebaseData) {
                if(!isSharedKey(fbKey)) continue;
                processed[fbKey] = true;
                var local = _origGet(fbKey), remote = firebaseData[fbKey];
                
                // Si hay datos locales válidos, MANTENERLOS y subir a Firebase
                if(local && local !== '[]' && local !== '{}' && local !== 'null' && local !== '') {
                    // LOCAL GANA - subir local a Firebase
                    if(local !== remote) {
                        batch.set(_db.collection(COLLECTION).doc(fbKey), { v: local, ts: firebase.firestore.FieldValue.serverTimestamp() });
                        batchCount++;
                        log('⬆️ ' + fbKey + ' local → Firebase (local gana)');
                    }
                } else {
                    // No hay datos locales - descargar de Firebase
                    _isReceiving = true; _origSet(fbKey, remote); _isReceiving = false;
                    log('⬇️ ' + fbKey + ' Firebase → local (sin datos locales)');
                }
            }
            // Upload local-only keys
            for(var i = 0; i < localStorage.length; i++) {
                var lsKey = localStorage.key(i);
                if(!isSharedKey(lsKey) || processed[lsKey]) continue;
                var lsVal = _origGet(lsKey);
                if(lsVal && lsVal !== '[]' && lsVal !== '{}' && lsVal !== 'null' && lsVal !== '') {
                    batch.set(_db.collection(COLLECTION).doc(lsKey), { v: lsVal, ts: firebase.firestore.FieldValue.serverTimestamp() });
                    batchCount++;
                }
            }
            if(batchCount > 0) {
                try { await batch.commit(); log('⬆️ ' + batchCount + ' claves subidas'); }
                catch(e) { log('⚠️ Error batch: ' + e.message); }
            }
            
            // PASO 3: Pending writes
            var pk = Object.keys(_pendingWrites);
            if(pk.length > 0) {
                try {
                    var pb = _db.batch();
                    pk.forEach(function(k) { pb.set(_db.collection(COLLECTION).doc(k), { v: _pendingWrites[k], ts: firebase.firestore.FieldValue.serverTimestamp() }); });
                    await pb.commit(); _pendingWrites = {};
                } catch(e) { log('⚠️ Error pending: ' + e.message); }
            }
            
            // PASO 4: Listener
            _initDone = true;
            startListening();
            
            // PASO 5: Refrescar UI
            if(typeof refrescarDatosEnMemoria === 'function') refrescarDatosEnMemoria();
            
            updateUI('online', Object.keys(firebaseData).length);
            log('✅ SYNC COMPLETA');
            return true;
        } catch(e) {
            log('❌ Error init: ' + e.message);
            updateUI('error'); _isReceiving = false; _initDone = true;
            return false;
        }
    }
    
    async function forceSync() {
        if(!_db) return false;
        updateUI('syncing');
        try {
            var snapshot = await _db.collection(COLLECTION).get();
            var fd = {};
            snapshot.forEach(function(doc) { var d=doc.data(); if(d.v!==undefined) fd[doc.id]=d.v; });
            var batch = _db.batch(), bc = 0, pr = {};
            for(var k in fd) {
                if(!isSharedKey(k)) continue; pr[k]=true;
                var l = _origGet(k), r = fd[k];
                if(l && l!=='[]' && l!=='{}' && l!=='null') {
                    var m = mergeValues(k, l, r);
                    _isReceiving=true; _origSet(k, m); _isReceiving=false;
                    if(m!==r) { batch.set(_db.collection(COLLECTION).doc(k),{v:m,ts:firebase.firestore.FieldValue.serverTimestamp()}); bc++; }
                } else { _isReceiving=true; _origSet(k, r); _isReceiving=false; }
            }
            for(var i=0;i<localStorage.length;i++) {
                var lk=localStorage.key(i);
                if(isSharedKey(lk)&&!pr[lk]) { var v=_origGet(lk); if(v&&v!=='[]'&&v!=='{}'&&v!=='') { batch.set(_db.collection(COLLECTION).doc(lk),{v:v,ts:firebase.firestore.FieldValue.serverTimestamp()}); bc++; } }
            }
            if(bc>0) await batch.commit();
            updateUI('online', Object.keys(fd).length);
            return true;
        } catch(e) { updateUI('error'); return false; }
    }
    
    return { init:init, forceSync:forceSync, updateUI:updateUI, isSharedKey:isSharedKey, lockKeyForDelete:lockKeyForDelete, getLog:function(){return _syncLog.slice();} };
})();

// ═══════════════════════════════════════════════════════════════════════════════
// REFRESCAR VARIABLES GLOBALES DESDE LOCALSTORAGE (después de sync)
// ═══════════════════════════════════════════════════════════════════════════════
function refrescarDatosEnMemoria() {
    try { visitasAgendadas = JSON.parse(localStorage.getItem('visitasAgendadas') || '[]'); } catch(e) { visitasAgendadas = []; }
    try { preinformes = JSON.parse(localStorage.getItem('preinformes') || '[]'); } catch(e) { preinformes = []; }
    try { informesBorrador = JSON.parse(localStorage.getItem('informesBorrador') || '[]'); } catch(e) { informesBorrador = []; }
    try { informesFinalizados = JSON.parse(localStorage.getItem('informesFinalizados') || '[]'); } catch(e) { informesFinalizados = []; }
    try { if(typeof centrosFlop !== 'undefined') centrosFlop = JSON.parse(localStorage.getItem('centrosFlop') || '[]'); } catch(e) {}
    try { if(typeof accionesCentros !== 'undefined') accionesCentros = JSON.parse(localStorage.getItem('accionesCentros') || '{}'); } catch(e) {}
    try { if(typeof paquetesCentros !== 'undefined') paquetesCentros = JSON.parse(localStorage.getItem('paquetesCentros') || '{}'); } catch(e) {}
    
    // Actualizar contadores de evaluaciones
    try {
        var statEvals = document.getElementById('stat-evals');
        if(statEvals) statEvals.textContent = preinformes.length;
        var statProm = document.getElementById('stat-prom');
        if(statProm && preinformes.length > 0) {
            statProm.textContent = Math.round(preinformes.reduce(function(a,b){ return a + (b.resultado||0); }, 0) / preinformes.length) + '%';
        }
    } catch(e) {}
    
    try { if(typeof actualizarContadoresResponsable === 'function') actualizarContadoresResponsable(); } catch(e) {}
    try { if(typeof renderCentrosVisitas === 'function') renderCentrosVisitas(); } catch(e) {}
    try { if(typeof renderInformesFinalizados === 'function') renderInformesFinalizados(); } catch(e) {}
    try { if(typeof renderPreinformes === 'function') renderPreinformes(); } catch(e) {}
    try { if(typeof cargarListasBorradoresFinalizados === 'function') cargarListasBorradoresFinalizados(); } catch(e) {}
    try { if(typeof cargarAARGuardado === 'function') cargarAARGuardado(); } catch(e) {}
    try { if(typeof actualizarDashboardMedia === 'function') actualizarDashboardMedia(); } catch(e) {}
    
    console.log('[Sync] ✅ Datos refrescados - Preinformes:', preinformes.length, 'Finalizados:', informesFinalizados.length, 'Borradores:', informesBorrador.length);
}

// ═══════════════════════════════════════════════════════════════════════════════
// SAFETY NET: Verificar que informes se restauraron correctamente desde Firebase
// Si localStorage está vacío pero Firebase tiene datos, los restaura
// ═══════════════════════════════════════════════════════════════════════════════
// ═══════════════════════════════════════════════════════════════════════════════
// SAFETY NET: Verificar que informes se restauraron correctamente desde Firebase
// Si localStorage está vacío pero Firebase tiene datos, los restaura
// Se ejecuta automáticamente al arrancar y al entrar en Gestión de Informes
// ═══════════════════════════════════════════════════════════════════════════════
var _safetyRestoreRunning = false;
var _safetyRestoreDone = false;

async function verificarYRestaurarInformes() {
    // Evitar ejecuciones simultáneas
    if(_safetyRestoreRunning) return;
    _safetyRestoreRunning = true;
    
    if(!db) {
        try { await inicializarFirebase(); } catch(e) {}
        if(!db) { _safetyRestoreRunning = false; return; }
    }
    
    var keysToCheck = [
        'informesFinalizados', 'informesBorrador', 'borradoresInforme', 
        'preinformes', 'visitasAgendadas', 'evaluaciones',
        'accionesCentros', 'paquetesCentros', 'centrosFlop',
        'accionesExclusivosFunnel', 'accionesFlopFunnel'
    ];
    var restored = 0;
    var details = [];
    
    for(var i = 0; i < keysToCheck.length; i++) {
        var key = keysToCheck[i];
        var localRaw = null;
        try { localRaw = localStorage.getItem(key); } catch(e) {}
        
        // Check if local has valid data
        var localHasData = false;
        if(localRaw && localRaw !== '[]' && localRaw !== '{}' && localRaw !== 'null' && localRaw !== '') {
            try {
                var parsed = JSON.parse(localRaw);
                if(Array.isArray(parsed)) localHasData = parsed.length > 0;
                else if(typeof parsed === 'object') localHasData = Object.keys(parsed).length > 0;
                else localHasData = true;
            } catch(e) {}
        }
        
        // Si hay datos locales válidos, skip
        if(localHasData) continue;
        
        // localStorage vacío para esta key → intentar restaurar desde Firebase
        try {
            var doc = await db.collection('plataformaAdmin').doc(key).get();
            if(doc.exists) {
                var remoteValue = doc.data().v;
                if(remoteValue && remoteValue !== '[]' && remoteValue !== '{}' && remoteValue !== 'null' && remoteValue !== '') {
                    // Verificar que el remoto tiene datos reales
                    var remoteValid = false;
                    try {
                        var rp = JSON.parse(remoteValue);
                        if(Array.isArray(rp)) remoteValid = rp.length > 0;
                        else if(typeof rp === 'object') remoteValid = Object.keys(rp).length > 0;
                        else remoteValid = true;
                    } catch(e) {}
                    
                    if(remoteValid) {
                        // Escribir directo a localStorage sin triggear SharedSync re-upload
                        try { localStorage.setItem(key, remoteValue); } catch(e) {}
                        restored++;
                        var count = 0;
                        try { count = JSON.parse(remoteValue).length || Object.keys(JSON.parse(remoteValue)).length; } catch(e) {}
                        details.push(key + ':' + count);
                        console.log('[Safety] ✅ Restaurado ' + key + ' desde Firebase: ' + count + ' elementos');
                    }
                }
            }
        } catch(e) {
            console.warn('[Safety] Error verificando ' + key + ':', e.message);
        }
    }
    
    if(restored > 0) {
        console.log('[Safety] 🔄 ' + restored + ' keys restauradas: ' + details.join(', '));
        // Actualizar variables globales desde localStorage
        refrescarDatosEnMemoria();
        
        // Notificar al usuario
        try {
            var toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#065f46;color:#fff;padding:10px 20px;border-radius:8px;z-index:99999;font-size:12px;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,0.2);transition:opacity 0.5s';
            toast.textContent = '☁️ ' + restored + ' conjunto(s) de datos restaurados desde Firebase';
            document.body.appendChild(toast);
            setTimeout(function() { toast.style.opacity = '0'; setTimeout(function() { toast.remove(); }, 600); }, 4000);
        } catch(e) {}
    } else {
        console.log('[Safety] ✅ Todos los datos locales verificados OK');
    }
    
    _safetyRestoreDone = true;
    _safetyRestoreRunning = false;
}

// ═══════════════════════════════════════════════════════════════════════════════
// RESTAURAR INFORMES DESDE FIREBASE - Función manual de emergencia
// Descarga TODOS los datos de Firebase y los carga en localStorage (FUERZA)
// ═══════════════════════════════════════════════════════════════════════════════
async function restaurarDesdeFirebase() {
    if(!db) { 
        await inicializarFirebase();
        if(!db) { alert('❌ No se pudo conectar con Firebase'); return; }
    }
    
    if(!confirm('⚠️ Esto descargará TODOS los datos desde Firebase.\nLos datos de Firebase reemplazarán los datos locales.\n\n¿Continuar?')) return;
    
    try {
        var snapshot = await db.collection('plataformaAdmin').get();
        var count = 0;
        var details = [];
        snapshot.forEach(function(doc) {
            var d = doc.data();
            if(d.v !== undefined && d.v !== null) {
                try { 
                    localStorage.setItem(doc.id, d.v); 
                    count++; 
                    var n = 0;
                    try { var p = JSON.parse(d.v); n = Array.isArray(p) ? p.length : Object.keys(p).length; } catch(e) {}
                    if(n > 0) details.push(doc.id + ': ' + n);
                } catch(e) {}
            }
        });
        
        refrescarDatosEnMemoria();
        
        var msg = '✅ Restauración completada\n\n' + count + ' conjuntos de datos descargados.\n\n';
        msg += 'Informes finalizados: ' + informesFinalizados.length + '\n';
        msg += 'Borradores: ' + informesBorrador.length + '\n';
        msg += 'Preinformes: ' + preinformes.length + '\n';
        msg += 'Visitas agendadas: ' + visitasAgendadas.length;
        alert(msg);
        
        // Recargar para asegurar consistencia total
        setTimeout(function() { location.reload(); }, 500);
    } catch(e) {
        alert('❌ Error restaurando: ' + e.message);
    }
}

function forzarSincronizacion() {
    if(!db) { alert('⚠️ Firebase no conectado.'); return; }
    SharedSync.forceSync().then(function(ok) {
        if(ok) { refrescarDatosEnMemoria(); alert('✅ Sincronización completada.'); }
        else alert('⚠️ Error en sincronización.');
    });
}

var firebaseRetryCount = 0;
var maxFirebaseRetries = 10;

async function inicializarFirebase() {
    // Si ya está inicializado, retornar
    if(db) return true;
    
    // Verificar si firebase existe
    if(typeof firebase === 'undefined') {
        firebaseRetryCount++;
        if(firebaseRetryCount < maxFirebaseRetries) {
            console.log('[Firebase] SDK cargando... reintento ' + firebaseRetryCount + '/' + maxFirebaseRetries);
            setTimeout(inicializarFirebase, 500);
            return false;
        } else {
            console.error('[Firebase] SDK no disponible después de ' + maxFirebaseRetries + ' intentos - recargando página puede ayudar');
            return false;
        }
    }
    
    try {
        if(!firebase.apps.length) {
            firebase.initializeApp({
                apiKey: "AIzaSyB9E6GZf-RJbX6Gn0eThg7fpayu4lcwyYs",
                authDomain: "funnel-d0a2e.firebaseapp.com",
                projectId: "funnel-d0a2e",
                storageBucket: "funnel-d0a2e.appspot.com",
                messagingSenderId: "720417248895",
                appId: "1:720417248895:web:89c039a277bbe675fcd14a"
            });
        }
        db = firebase.firestore();
        console.log('[Firebase] ✅ Conectado correctamente');
        firebaseRetryCount = 0;
        
        // SharedSync en paralelo (NO bloquea nada)
        SharedSync.init(db).then(function(ok) {
            if(ok) {
                console.log('[SharedSync] ✅ Listo');
                setTimeout(function() {
                    try { sincronizarTodoAFirebase(); } catch(e) {}
                    try { refrescarDatosEnMemoria(); } catch(e) {}
                    // Safety net #1: Verify & restore after SharedSync
                    try { verificarYRestaurarInformes(); } catch(e) { console.warn('[Safety] Error:', e); }
                }, 1000);
                // Safety net #2: Re-check at 3s (catches race conditions)
                setTimeout(function() {
                    if(!_safetyRestoreDone) {
                        console.log('[Safety] ⏰ Check #2 at 3s...');
                        try { verificarYRestaurarInformes(); } catch(e) {}
                    }
                }, 3000);
                // Safety net #3: Final guarantee at 6s
                setTimeout(function() {
                    try { refrescarDatosEnMemoria(); } catch(e) {}
                    console.log('[Safety] 📊 Final state - Finalizados:', informesFinalizados.length, 'Borradores:', informesBorrador.length);
                }, 6000);
            }
            else {
                console.warn('[SharedSync] ⚠️ Con errores - intentando restore directo...');
                // SharedSync failed - try direct Firebase restore
                setTimeout(function() {
                    try { verificarYRestaurarInformes(); } catch(e) {}
                }, 2000);
            }
        }).catch(function(e) { 
            console.warn('[SharedSync] Error:', e.message);
            // SharedSync crashed - try direct Firebase restore
            setTimeout(function() {
                try { verificarYRestaurarInformes(); } catch(e2) {}
            }, 2000);
        });
        
        return true;
    } catch(e) { 
        console.error('Firebase error:', e); 
        return false;
    }
}

function initFunnel() {
    cargarDatosCVN();
    sincronizarScroll();
    dibujarGraficoVentas('chartVentas', 'chartTooltip');
}

function dibujarGraficoVentas(canvasId, tooltipId) {
    var canvas = document.getElementById(canvasId);
    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    var w = canvas.width = canvas.offsetWidth || 180;
    var h = canvas.height = canvas.offsetHeight || 75;
    
    var data = {
        labels: ['AGO', 'SEP', 'OCT', 'NOV', 'DIC'],
        real: [750113, 1008222, 1511971, 1572319, 1180829],
        prev: [800389, 1023241, 1376852, 1624933, 1358290],
        n1: [605193, 861607, 1165100, 1210910, 962906]
    };
    
    var maxVal = Math.max(...data.real, ...data.prev, ...data.n1) * 1.1;
    var pad = {t:4,r:3,b:10,l:3};
    var cW = w - pad.l - pad.r;
    var cH = h - pad.t - pad.b;
    
    ctx.clearRect(0, 0, w, h);
    
    ctx.strokeStyle = '#f0f0f0'; ctx.lineWidth = 0.5;
    for (var i = 0; i <= 3; i++) {
        var y = pad.t + (cH / 3) * i;
        ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(w - pad.r, y); ctx.stroke();
    }
    
    function gX(i) { return pad.l + (cW / (data.labels.length - 1)) * i; }
    function gY(v) { return pad.t + cH - (v / maxVal) * cH; }
    
    ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1;
    ctx.beginPath();
    data.n1.forEach((v, i) => { i === 0 ? ctx.moveTo(gX(i), gY(v)) : ctx.lineTo(gX(i), gY(v)); });
    ctx.stroke();
    
    ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 1; ctx.setLineDash([2, 2]);
    ctx.beginPath();
    data.prev.forEach((v, i) => { i === 0 ? ctx.moveTo(gX(i), gY(v)) : ctx.lineTo(gX(i), gY(v)); });
    ctx.stroke(); ctx.setLineDash([]);
    
    ctx.strokeStyle = '#C9A227'; ctx.lineWidth = 1.5;
    ctx.beginPath();
    data.real.forEach((v, i) => { i === 0 ? ctx.moveTo(gX(i), gY(v)) : ctx.lineTo(gX(i), gY(v)); });
    ctx.stroke();
    
    data.real.forEach((v, i) => {
        ctx.fillStyle = '#C9A227'; ctx.beginPath(); ctx.arc(gX(i), gY(v), 2.5, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(gX(i), gY(v), 1, 0, Math.PI * 2); ctx.fill();
    });
    
    ctx.fillStyle = '#888'; ctx.font = '6px sans-serif'; ctx.textAlign = 'center';
    data.labels.forEach((l, i) => { ctx.fillText(l, gX(i), h - 2); });
    
    canvas.onmousemove = function(e) {
        var rect = canvas.getBoundingClientRect();
        var x = e.clientX - rect.left;
        var tooltip = document.getElementById(tooltipId);
        if (!tooltip) return;
        for (var i = 0; i < data.labels.length; i++) {
            if (Math.abs(x - gX(i)) < 12) {
                tooltip.innerHTML = '<b>' + data.labels[i] + '</b><br>Real: ' + data.real[i].toLocaleString('es-ES') + '€<br>Obj: ' + data.prev[i].toLocaleString('es-ES') + '€';
                tooltip.style.display = 'block';
                tooltip.style.left = (gX(i) - 25) + 'px';
                tooltip.style.top = (gY(data.real[i]) - 35) + 'px';
                return;
            }
        }
        tooltip.style.display = 'none';
    };
    canvas.onmouseleave = function() { var t = document.getElementById(tooltipId); if(t) t.style.display = 'none'; };
}

function dibujarGraficoDashboard() {
    dibujarGraficoVentas('chartVentasDash', 'chartTooltipDash');
}

function sincronizarScroll() {
    var scrollArea = document.getElementById('scrollArea');
    var fixedBody = document.getElementById('tblFijo');
    if(scrollArea && fixedBody) {
        scrollArea.addEventListener('scroll', function() {
            fixedBody.parentElement.parentElement.scrollTop = scrollArea.scrollTop;
        });
    }
}

function filtrarTablaCVN() {
    var buscar = document.getElementById('funnelBuscar').value.toLowerCase();
    var filasFijo = document.querySelectorAll('#tblFijo tr');
    var filasScroll = document.querySelectorAll('#tblCVN tbody tr');
    filasFijo.forEach(function(fila, i) {
        var texto = fila.textContent.toLowerCase();
        var visible = texto.includes(buscar);
        fila.style.display = visible ? '' : 'none';
        if(filasScroll[i]) filasScroll[i].style.display = visible ? '' : 'none';
    });
}

function guardarDatosCVN() {
    var datos = {};
    document.querySelectorAll('#tblCVN tbody tr').forEach(function(fila) {
        var cod = fila.getAttribute('data-cod');
        if(cod) {
            var inputs = fila.querySelectorAll('input');
            datos[cod] = { mesActual: parseFloat(inputs[0].value) || 0, prevMes: parseFloat(inputs[1].value) || 0 };
        }
    });
    localStorage.setItem('datosCVNMes', JSON.stringify(datos));
    calcularTotalesMes();
    alert('✅ Guardado');
}

function cargarDatosCVN() {
    var saved = localStorage.getItem('datosCVNMes');
    if(saved) {
        var datos = JSON.parse(saved);
        document.querySelectorAll('#tblCVN tbody tr').forEach(function(fila) {
            var cod = fila.getAttribute('data-cod');
            if(cod && datos[cod]) {
                var inputs = fila.querySelectorAll('input');
                if(inputs[0] && datos[cod].mesActual) inputs[0].value = datos[cod].mesActual;
                if(inputs[1] && datos[cod].prevMes) inputs[1].value = datos[cod].prevMes;
            }
        });
        calcularTotalesMes();
    }
}

function calcularTotalesMes() {
    var tA = 0, tP = 0;
    document.querySelectorAll('#tblCVN tbody tr').forEach(function(f) {
        var inp = f.querySelectorAll('input');
        tA += parseFloat(inp[0].value) || 0;
        tP += parseFloat(inp[1].value) || 0;
    });
    var eA = document.getElementById('totalMesAct'), eP = document.getElementById('totalPrevMes');
    if(eA) eA.textContent = tA > 0 ? tA.toLocaleString('es-ES') + '€' : '-';
    if(eP) eP.textContent = tP > 0 ? tP.toLocaleString('es-ES') + '€' : '-';
}

function cargarAARExcel(input) {
    var file = input.files[0];
    if(!file) return;
    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, {type: 'array'});
            var sheet = workbook.Sheets[workbook.SheetNames[0]];
            var json = XLSX.utils.sheet_to_json(sheet);
            
            var cert = 0, form = 0, pend = 0;
            json.forEach(function(row) {
                var estado = (row.estado || row.Estado || row.ESTADO || '').toString().toLowerCase();
                if(estado.includes('cert')) cert++;
                else if(estado.includes('form')) form++;
                else if(estado.includes('pend')) pend++;
            });
            
            if(cert === 0 && form === 0 && pend === 0 && json.length > 0) {
                var r = json[0];
                cert = parseInt(r.certificados || r.Certificados || r.cert || 0) || 0;
                form = parseInt(r.formacion || r.Formacion || r.form || 0) || 0;
                pend = parseInt(r.pendientes || r.Pendientes || r.pend || 0) || 0;
            }
            
            actualizarAARDashboard(cert, form, pend);
            alert('✅ AAR actualizado: ' + cert + ' cert, ' + form + ' form, ' + pend + ' pend');
        } catch(err) {
            alert('❌ Error: ' + err.message);
        }
    };
    reader.readAsArrayBuffer(file);
    input.value = '';
}

function actualizarAARDashboard(cert, form, pend) {
    var total = cert + form + pend;
    if(total === 0) total = 1;
    
    var pctCert = (cert / total * 100);
    var pctForm = (form / total * 100);
    var pctPend = (pend / total * 100);
    
    var elCert = document.getElementById('dash-aar-cert');
    var elForm = document.getElementById('dash-aar-form');
    var elPend = document.getElementById('dash-aar-pend');
    if(elCert) elCert.textContent = cert;
    if(elForm) elForm.textContent = form;
    if(elPend) elPend.textContent = pend;
    
    var elPct = document.getElementById('aarPctCenter');
    if(elPct) elPct.textContent = Math.round((cert + form) / total * 100) + '%';
    
    var elTotal = document.getElementById('aarTotalCentros');
    if(elTotal) elTotal.textContent = total + ' centros';
    
    var semaforo = document.getElementById('aarSemaforo');
    if(semaforo) {
        semaforo.innerHTML = '<div style="flex:' + pctCert + ';background:#10b981;border-radius:2px 0 0 2px"></div>' +
            '<div style="flex:' + pctForm + ';background:#f59e0b"></div>' +
            '<div style="flex:' + pctPend + ';background:#ef4444;border-radius:0 2px 2px 0"></div>';
    }
    
    localStorage.setItem('aarData', JSON.stringify({cert: cert, form: form, pend: pend}));
}

function cargarTiendasExcel(input) {
    var file = input.files[0];
    if(!file) return;
    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, {type: 'array'});
            var sheet = workbook.Sheets[workbook.SheetNames[0]];
            var json = XLSX.utils.sheet_to_json(sheet);
            
            var actualizados = 0;
            json.forEach(function(row) {
                var cod = row.cod || row.COD || row.codigo || row.Codigo || '';
                if(!cod) return;
                
                var fila = document.querySelector('#tblCVN tbody tr[data-cod="' + cod + '"]');
                if(fila) {
                    var inputs = fila.querySelectorAll('input');
                    var mesAct = parseFloat(row.mesActual || row.actual || row.MES || 0);
                    var prevMes = parseFloat(row.prevMes || row.previsto || row.PREV || 0);
                    if(inputs[0] && mesAct) inputs[0].value = mesAct;
                    if(inputs[1] && prevMes) inputs[1].value = prevMes;
                    actualizados++;
                }
            });
            
            calcularTotalesMes();
            guardarDatosCVN();
            alert('✅ ' + actualizados + ' tiendas actualizadas');
        } catch(err) {
            alert('❌ Error: ' + err.message);
        }
    };
    reader.readAsArrayBuffer(file);
    input.value = '';
}

function cargarAARGuardado() {
    var saved = localStorage.getItem('aarData');
    if(saved) {
        var d = JSON.parse(saved);
        actualizarAARDashboard(d.cert || 14, d.form || 22, d.pend || 29);
    } else {
        actualizarAARDashboard(14, 22, 29);
    }
}

function filtrarFunnel() {
    var buscar = document.getElementById('funnelBuscar').value.toLowerCase();
    var delegado = document.getElementById('funnelDelegado').value;
    var filtrados = centrosData.filter(c => {
        if(buscar && !c.n.toLowerCase().includes(buscar) && !c.c.toLowerCase().includes(buscar)) return false;
        if(delegado && c.d !== delegado) return false;
        return true;
    });
    renderFunnelCentros(filtrados);
    actualizarFunnelDashboard(filtrados);
}

function renderFunnelCentros(centros) {
    var container = document.getElementById('funnelCentrosList');
    document.getElementById('funnelCentrosCount').textContent = centros.filter(c => c.t !== 'PRUEBAS' && c.c !== '5DEM').length;
    if(centros.length === 0) { container.innerHTML = '<div style="text-align:center;padding:20px;color:#888">Sin centros</div>'; return; }
    var html = '';
    centros.forEach(c => {
        var tieneData = funnelDataCache[c.c] ? true : false;
        var esDemo = c.t === 'DEMO';
        html += '<div onclick="seleccionarCentroFunnel(\'' + c.c + '\')" style="padding:8px 10px;border:1px solid ' + (esDemo ? '#8b5cf6' : '#eee') + ';border-radius:6px;margin-bottom:4px;cursor:pointer;background:' + (esDemo ? '#f5f3ff' : '#fff') + '">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:11px;font-weight:600">' + c.n + (esDemo ? ' <span style="background:#8b5cf6;color:#fff;padding:1px 4px;border-radius:3px;font-size:7px">🧪 DEMO</span>' : '') + '</div>';
        html += '<div style="font-size:9px;color:#888">' + c.c + ' · ' + c.d + '</div></div><div style="width:8px;height:8px;border-radius:50%;background:' + (tieneData ? '#10b981' : '#ddd') + '"></div></div></div>';
    });
    container.innerHTML = html;
}

function actualizarFunnelDashboard(centros) {
    var t = { audio: 0, perdida: 0, prueban: 0, ventas: 0, renove: 0, renove42: 0, mgm: 0, infinity: 0, devoluciones: 0, noPrueban: 0 };
    centros.forEach(c => {
        var d = funnelDataCache[c.c];
        if(d && d.kpis) {
            var k = d.kpis;
            t.audio += k.total || 0; t.perdida += k.conPerdida || 0; t.prueban += k.prueban || 0; t.ventas += k.ventas || 0;
            t.renove += k.renove36 || k.renove || 0; t.renove42 += k.renove42 || 0; t.mgm += k.mgm || 0; t.infinity += k.infinity || 0;
            t.devoluciones += k.devoluciones || 0; t.noPrueban += k.noPrueban || k.fugas || 0;
        }
    });
    document.getElementById('funnelTotalAudio').textContent = t.audio;
    document.getElementById('funnelConPerdida').textContent = t.perdida;
    document.getElementById('funnelPrueban').textContent = t.prueban;
    document.getElementById('funnelVentas').textContent = t.ventas;
    document.getElementById('funnelRenove').textContent = t.renove;
    document.getElementById('funnelRenove42').textContent = t.renove42;
    document.getElementById('funnelMGM').textContent = t.mgm;
    document.getElementById('funnelInfinity').textContent = t.infinity;
    document.getElementById('funnelFuga').textContent = t.devoluciones + t.noPrueban;
    var c1 = t.perdida > 0 ? Math.round((t.prueban / t.perdida) * 100) : 0;
    var c2 = t.prueban > 0 ? Math.round((t.ventas / t.prueban) * 100) : 0;
    document.getElementById('funnelConv1').textContent = c1 + '%';
    document.getElementById('funnelConv2').textContent = c2 + '%';
    if(document.getElementById('dash-renove')) document.getElementById('dash-renove').textContent = t.renove;
    if(document.getElementById('dash-renove42')) document.getElementById('dash-renove42').textContent = t.renove42;
    if(document.getElementById('dash-mgm')) document.getElementById('dash-mgm').textContent = t.mgm;
    if(document.getElementById('dash-infinity')) document.getElementById('dash-infinity').textContent = t.infinity;
    if(document.getElementById('dash-fuga')) document.getElementById('dash-fuga').textContent = t.devoluciones + t.noPrueban;
}

function seleccionarCentroFunnel(codigo) {
    var centro = centrosData.find(c => c.c === codigo);
    if(!centro) return;
    
    // Actualizar variable global y buscador
    centroSeleccionadoFunnel = codigo;
    var buscador = document.getElementById('funnel-buscar-centro');
    if(buscador) buscador.value = codigo + ' - ' + centro.n;
    ocultarResultadosBusqueda();
    
    // Mostrar detalle
    var esDemo = centro.t === 'DEMO';
    var tituloEl = document.getElementById('funnelDetalleTitulo');
    if(tituloEl) tituloEl.textContent = centro.n + (esDemo ? ' [🧪 DEMO]' : '');
    
    var content = document.getElementById('funnelDetalleContent');
    var data = funnelDataCache[codigo];
    if(content) {
        if(!data) { 
            content.innerHTML = '<div style="text-align:center;padding:30px;color:#888"><div style="font-size:30px;margin-bottom:10px">📭</div><div>Sin datos en Firebase</div><div style="font-size:10px;margin-top:5px">Pulsa ACTUALIZAR para cargar</div></div>'; 
        } else {
            var k = data.kpis || {};
            var html = '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px">';
            html += '<div style="background:#3b82f6;color:#fff;padding:8px;border-radius:6px;text-align:center"><div style="font-size:6px">AUDIO</div><div style="font-size:16px;font-weight:800">' + (k.total || 0) + '</div></div>';
            html += '<div style="background:#f59e0b;color:#fff;padding:8px;border-radius:6px;text-align:center"><div style="font-size:6px">PÉRDIDA</div><div style="font-size:16px;font-weight:800">' + (k.conPerdida || 0) + '</div></div>';
            html += '<div style="background:#8b5cf6;color:#fff;padding:8px;border-radius:6px;text-align:center"><div style="font-size:6px">PRUEBAN</div><div style="font-size:16px;font-weight:800">' + (k.prueban || 0) + '</div></div>';
            html += '<div style="background:#10b981;color:#fff;padding:8px;border-radius:6px;text-align:center"><div style="font-size:6px">Ventas</div><div style="font-size:16px;font-weight:800">' + (k.ventas || 0) + '</div></div></div>';
            content.innerHTML = html;
        }
    }
    
    // Cargar datos del funnel
    cargarDatosFunnel();
}

async function actualizarFunnelData() {
    if(!db) { 
        var initialized = await inicializarFirebase(); 
        if(!initialized || !db) { 
            var statusEl = document.getElementById('funnelStatus');
            if(statusEl) statusEl.innerHTML = '❌'; 
            cargarDemoData(); 
            return; 
        } 
    }
    
    var statusEl = document.getElementById('funnelStatus');
    if(statusEl) statusEl.innerHTML = '⏳';
    
    db.collection('audiometrias').get().then(function(snapshot) {
        funnelDataCache = {};
        snapshot.forEach(function(doc) { 
            funnelDataCache[doc.id] = doc.data(); 
        });
        if(Object.keys(funnelDataCache).length === 0) {
            cargarDemoData();
            return;
        }
        if(statusEl) {
            statusEl.innerHTML = '☁️ ' + Object.keys(funnelDataCache).length;
            statusEl.style.background = '#dcfce7';
        }
        filtrarFunnel();
    }).catch(function(e) { 
        console.error('Error Firebase:', e);
        if(statusEl) statusEl.innerHTML = '❌'; 
        cargarDemoData(); 
    });
}

function cargarDemoData() {
    funnelDataCache['DEMO1'] = { kpis: { total: 45, conPerdida: 38, prueban: 32, ventas: 28, noPrueban: 6, devoluciones: 2, renove: 8, renove42: 3, mgm: 5, infinity: 12 }};
    funnelDataCache['DEMO2'] = { kpis: { total: 32, conPerdida: 28, prueban: 24, ventas: 20, noPrueban: 4, devoluciones: 1, renove: 6, renove42: 2, mgm: 3, infinity: 8 }};
    funnelDataCache['DEMO3'] = { kpis: { total: 28, conPerdida: 22, prueban: 18, ventas: 15, noPrueban: 3, devoluciones: 1, renove: 4, renove42: 2, mgm: 2, infinity: 6 }};
    var statusEl = document.getElementById('funnelStatus');
    if(statusEl) {
        statusEl.innerHTML = '🎭 DEMO';
        statusEl.style.background = '#fef3c7';
    }
    filtrarFunnel();
}

function eliminarDemo() {
    if(confirm('¿Eliminar datos demo (4ARY, 4DAV, 4SON)?')) {
        ['4ARY', '4DAV', '4SON', '3ARY', '2ARY'].forEach(k => delete funnelDataCache[k]);
        document.getElementById('funnelStatus').innerHTML = '✅';
        filtrarFunnel();
    }
}

// Inicialización diferida para asegurar carga de scripts externos
if(document.readyState === 'complete') {
    setTimeout(inicializarFirebase, 100);
} else {
    window.addEventListener('load', function() {
        setTimeout(inicializarFirebase, 100);
    });
}
setTimeout(dibujarGraficoDashboard, 600);
setTimeout(cargarAARGuardado, 700);

// ============ CALENDARIO V2 — Lun-Vie, 4 franjas, editable ============
(function(){
    var MESES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    var DIAS_HDR=['Lun','Mar','Mié','Jue','Vie'];
    var SLOT_NAMES=['☀ Mañana','📋 ½ Mañana','🌙 Tarde','📌 + Tarde'];

    window.calState={ARY:{year:2026,month:0},SGUASQUE:{year:2026,month:0}};

    // --- Storage ---
    function sKey(w,d,s){return 'calV2_'+w+'_'+d+'_'+s}
    function getSlot(w,d,s){try{return JSON.parse(localStorage.getItem(sKey(w,d,s)))}catch(e){return null}}
    function setSlotData(w,d,s,data){localStorage.setItem(sKey(w,d,s),JSON.stringify(data))}

    // Backward compat: turno string -> slots array
    function turnoToSlots(t){
        if(t==='tarde')return[2,3];if(t==='tododia')return[0,1,2,3];return[0];
    }
    window.turnoToSlots=turnoToSlots;

    // --- Agendados auto-fill ---
    function getAgendadoSlots(who){
        var result={};
        try{
            var va=(typeof visitasAgendadas!=='undefined'?visitasAgendadas:JSON.parse(localStorage.getItem('visitasAgendadas')||'[]'))||[];
            var cd=(typeof centrosData!=='undefined'?centrosData:[]);
            va.forEach(function(v){
                if(v.finalizado||!v.fecha)return;
                var c=cd.find(function(x){return x.c===v.codigo});
                if(!c||c.r!==who)return;
                var txt=v.codigo+' '+c.n.substring(0,18);
                if(!result[v.fecha])result[v.fecha]={};
                var sl=v.slots||turnoToSlots(v.turno);
                sl.forEach(function(si){
                    result[v.fecha][si]={type:'ocupado',text:txt,auto:true};
                });
            });
        }catch(e){}
        return result;
    }

    // --- Build weeks Mon-Fri ---
    function buildWeeks(y,m){
        var weeks=[],cw=null,last=new Date(y,m+1,0).getDate();
        for(var d=1;d<=last;d++){
            var dow=new Date(y,m,d).getDay();
            if(dow===0||dow===6)continue;
            var col=dow-1;
            if(!cw||col===0){if(cw)weeks.push(cw);cw=[null,null,null,null,null]}
            cw[col]=d;
        }
        if(cw)weeks.push(cw);
        return weeks;
    }

    function pad2(n){return n<10?'0'+n:''+n}
    function mkDate(y,m,d){return y+'-'+pad2(m+1)+'-'+pad2(d)}

    // --- Toggle ---
    window.toggleCalendario=function(who,btn){
        var c=document.getElementById('calContainer-'+who);
        var ar=btn.querySelector('.cal-arrow');
        if(c.classList.contains('open')){c.classList.remove('open');ar.classList.remove('open')}
        else{c.classList.add('open');ar.classList.add('open');renderCalendario(who)}
    };

    // --- Navigate ---
    window.cambiarMesCal=function(who,delta){
        var s=calState[who];s.month+=delta;
        if(s.month>11){s.month=0;s.year++}
        if(s.month<0){s.month=11;s.year--}
        renderCalendario(who);
    };

    // --- Main Render ---
    window.renderCalendario=function(who){
        var s=calState[who],isSonia=who==='SGUASQUE';
        document.getElementById('calTitle-'+who).textContent=MESES[s.month]+' '+s.year;
        var weeks=buildWeeks(s.year,s.month);
        var agSlots=getAgendadoSlots(who);
        var now=new Date();
        var todayStr=mkDate(now.getFullYear(),now.getMonth(),now.getDate());
        var html='';

        weeks.forEach(function(week){
            html+='<table class="cal-wk"><thead><tr><th class="cal-lbl"></th>';
            for(var c=0;c<5;c++){
                if(week[c]){
                    var ds=mkDate(s.year,s.month,week[c]);
                    var it=ds===todayStr;
                    html+='<th class="cal-dh'+(isSonia?' sonia':'')+(it?' today':'')+'">'+DIAS_HDR[c]+' '+week[c]+'</th>';
                }else{html+='<th class="cal-dh empty"></th>'}
            }
            html+='</tr></thead><tbody>';

            for(var sl=0;sl<4;sl++){
                html+='<tr><td class="cal-slot-label" style="background:#f3f4f6;font-size:7.5px;font-weight:700;color:#6b7280;text-align:right;padding:2px 4px;width:65px;border:1px solid #d1d5db">'+SLOT_NAMES[sl]+'</td>';
                for(var c=0;c<5;c++){
                    if(!week[c]){html+='<td class="cal-slot empty"></td>';continue}
                    var ds=mkDate(s.year,s.month,week[c]);
                    var it=ds===todayStr;
                    var data=getSlot(who,ds,sl);
                    var autoD=agSlots[ds]&&agSlots[ds][sl];
                    if(!data&&autoD)data=autoD;
                    if(!data)data={type:'disponible',text:''};
                    var label=data.text||(data.type==='disponible'?'':'');
                    html+='<td class="cal-slot st-'+data.type+(it?' today':'')+'" ';
                    html+='data-w="'+who+'" data-d="'+ds+'" data-s="'+sl+'" ';
                    html+='onclick="abrirEditSlot(this)" title="'+SLOT_NAMES[sl]+': '+(data.text||data.type)+'">';
                    if(label)html+='<span style="display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:7px">'+label+'</span>';
                    html+='</td>';
                }
                html+='</tr>';
            }
            html+='</tbody></table>';
        });
        document.getElementById('calGrid-'+who).innerHTML=html;
    };

    // --- Edit Popup ---
    window.abrirEditSlot=function(td){
        var old=document.getElementById('calEditPopup');if(old)old.remove();
        var who=td.getAttribute('data-w'),ds=td.getAttribute('data-d'),sl=parseInt(td.getAttribute('data-s'));
        var data=getSlot(who,ds,sl)||{type:'disponible',text:''};
        var rect=td.getBoundingClientRect();
        var popup=document.createElement('div');
        popup.id='calEditPopup';popup.className='cal-edit-popup';
        popup.innerHTML='<div class="cal-edit-header">'+SLOT_NAMES[sl]+' — '+ds+'</div>'+
            '<div class="cal-edit-body">'+
            '<div class="cal-edit-states">'+
            '<button class="cal-st-btn st-disponible'+(data.type==='disponible'?' active':'')+'" onclick="setCalSlotType(\'disponible\')">🟢 Libre</button>'+
            '<button class="cal-st-btn st-ocupado'+(data.type==='ocupado'?' active':'')+'" onclick="setCalSlotType(\'ocupado\')">🔴 Tienda</button>'+
            '<button class="cal-st-btn st-oficina'+(data.type==='oficina'?' active':'')+'" onclick="setCalSlotType(\'oficina\')">🟡 Oficina</button>'+
            '<button class="cal-st-btn st-vacaciones'+(data.type==='vacaciones'?' active':'')+'" onclick="setCalSlotType(\'vacaciones\')">🔵 Vacaciones</button>'+
            '</div>'+
            '<input type="text" id="calEditText" class="cal-edit-input" placeholder="Tienda, reunión o nota..." value="'+(data.text||'').replace(/"/g,'&quot;')+'">'+
            '<div class="cal-edit-actions">'+
            '<button onclick="guardarCalSlot()" class="cal-edit-save">✓ Guardar</button>'+
            '<button onclick="limpiarCalSlot()" style="padding:7px 10px;background:#ef4444;color:#fff;border:none;border-radius:6px;font-weight:700;font-size:10px;cursor:pointer">🗑</button>'+
            '<button onclick="cerrarCalEdit()" class="cal-edit-cancel">✕</button>'+
            '</div></div>';
        document.body.appendChild(popup);
        var pw=270,left=rect.left+rect.width/2-pw/2,top=rect.bottom+4;
        if(left<10)left=10;if(left+pw>window.innerWidth-10)left=window.innerWidth-pw-10;
        if(top+220>window.innerHeight)top=rect.top-220;
        popup.style.left=left+'px';popup.style.top=top+'px';
        popup._w=who;popup._d=ds;popup._s=sl;popup._t=data.type;

        // Stop click from propagating to document listener immediately
        setTimeout(function(){},0);
    };

    window.setCalSlotType=function(t){
        var p=document.getElementById('calEditPopup');if(!p)return;p._t=t;
        p.querySelectorAll('.cal-st-btn').forEach(function(b){b.classList.remove('active')});
        p.querySelector('.st-'+t).classList.add('active');
    };

    window.guardarCalSlot=function(){
        var p=document.getElementById('calEditPopup');if(!p)return;
        var txt=document.getElementById('calEditText').value.trim();
        setSlotData(p._w,p._d,p._s,{type:p._t,text:txt});
        var w=p._w;cerrarCalEdit();renderCalendario(w);
    };

    window.limpiarCalSlot=function(){
        var p=document.getElementById('calEditPopup');if(!p)return;
        localStorage.removeItem(sKey(p._w,p._d,p._s));
        var w=p._w;cerrarCalEdit();renderCalendario(w);
    };

    window.cerrarCalEdit=function(){var p=document.getElementById('calEditPopup');if(p)p.remove()};

    document.addEventListener('mousedown',function(e){
        var p=document.getElementById('calEditPopup');
        if(p&&!p.contains(e.target)&&!e.target.closest('.cal-slot')){p.remove()}
    });

    // --- Cuadrante toggle ---
    window.toggleCuadrante=function(q){
        var el=document.getElementById('turnoQ'+q);
        if(el)el.classList.toggle('active');
    };
    window.selPreset=function(p){
        for(var i=1;i<=4;i++){var e=document.getElementById('turnoQ'+i);if(e)e.classList.remove('active')}
        if(p==='manana'){document.getElementById('turnoQ1').classList.add('active');document.getElementById('turnoQ2').classList.add('active')}
        else if(p==='tarde'){document.getElementById('turnoQ3').classList.add('active');document.getElementById('turnoQ4').classList.add('active')}
        else if(p==='todo'){for(var i=1;i<=4;i++)document.getElementById('turnoQ'+i).classList.add('active')}
    };
    window.getSelectedSlots=function(){
        var slots=[];
        for(var i=1;i<=4;i++){if(document.getElementById('turnoQ'+i)?.classList.contains('active'))slots.push(i-1)}
        return slots;
    }

    // --- Availability preview in agendar modal ---
    window.mostrarDisponibilidadAgendar=function(){
        var cont=document.getElementById('agendarDisponibilidad');
        if(!cont)return;
        var fecha=document.getElementById('agendarFecha').value;
        if(!fecha||!centroAgendar){cont.innerHTML='';return}
        var who=centroAgendar.r;
        var otherWho=who==='ARY'?'SGUASQUE':'ARY';
        var whoLabel=who==='ARY'?'Ariannys':'Sonia';
        var otherLabel=otherWho==='ARY'?'Ariannys':'Sonia';

        // Find week containing this date
        var dt=new Date(fecha+'T12:00:00');
        var y=dt.getFullYear(),m=dt.getMonth(),d=dt.getDate();
        var dow=dt.getDay();
        if(dow===0||dow===6){cont.innerHTML='<div style="font-size:10px;color:#dc2626;font-weight:600;padding:6px">⚠️ Es fin de semana — elige un día laborable</div>';return}

        // Build the week around this date
        var monday=new Date(dt);monday.setDate(d-(dow-1));
        var weekDates=[];
        for(var i=0;i<5;i++){
            var wd=new Date(monday);wd.setDate(monday.getDate()+i);
            weekDates.push({d:wd.getDate(),m:wd.getMonth(),y:wd.getFullYear(),
                str:mkDate(wd.getFullYear(),wd.getMonth(),wd.getDate())});
        }

        var agW=getAgendadoSlots(who),agO=getAgendadoSlots(otherWho);
        var SLBL=['☀1','📋2','🌙3','📌4'];

        var html='<div style="font-size:9px;font-weight:700;color:#666;margin-bottom:4px">📊 Disponibilidad semana (ambas delegadas):</div>';
        html+='<div class="cal-mini-avail"><table><thead><tr><th style="width:70px"></th>';
        for(var i=0;i<5;i++){
            var sel=weekDates[i].str===fecha;
            html+='<th style="'+(sel?'background:#C9A227;color:#fff':'')+'">'+DIAS_HDR[i]+' '+weekDates[i].d+'</th>';
        }
        html+='</tr></thead><tbody>';

        [who,otherWho].forEach(function(w,idx){
            var lb=idx===0?whoLabel:otherLabel;
            var ag=idx===0?agW:agO;
            for(var si=0;si<4;si++){
                html+='<tr><td style="font-weight:700;font-size:6.5px;background:#f9fafb;white-space:nowrap">'+lb+' '+SLBL[si]+'</td>';
                for(var i=0;i<5;i++){
                    var ds=weekDates[i].str;
                    var sl=getSlot(w,ds,si);var au=ag[ds]&&ag[ds][si];
                    if(!sl&&au)sl=au;
                    var cls=sl?'mini-'+(sl.type==='disponible'?'libre':(sl.type==='ocupado'?'ocupado':'otro')):'mini-libre';
                    html+='<td class="'+cls+'" style="font-size:6.5px">'+(sl&&sl.text?sl.text.substring(0,10):(sl&&sl.type!=='disponible'?sl.type:'—'))+'</td>';
                }
                html+='</tr>';
            }
        });

        html+='</tbody></table></div>';
        cont.innerHTML=html;
    };

    // --- Sync calendars ---
    window.actualizarCalendariosDesdeAgenda=function(){
        ['ARY','SGUASQUE'].forEach(function(w){
            var c=document.getElementById('calContainer-'+w);
            if(c&&c.classList.contains('open'))renderCalendario(w);
        });
    };

    // Init current month
    var now=new Date();
    calState.ARY={year:now.getFullYear(),month:now.getMonth()};
    calState.SGUASQUE={year:now.getFullYear(),month:now.getMonth()};
})();

</script>


</body></html>